<html><head></head><body><div id="book-content"><div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 6. Real-Time Communication &#10;with Generative Models" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch06">
<h1><span class="label">Capitolo 6. </span>Comunicazione in tempo reale<span class="keep-together">con i modelli generativi</span></h1><div data-type="note"><p>Questo lavoro è stato tradotto utilizzando l'AI. Siamo lieti di ricevere il tuo feedback e i tuoi commenti: <a href="mailto:translation-feedback@oreilly.com">translation-feedback@oreilly.com</a></p></div>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id873">
<h1>Obiettivi del capitolo</h1>
<p><a data-primary="real-time communication with generative models" data-type="indexterm" id="ix_ch06-asciidoc0"/>In questo capitolo imparerai a conoscere:</p>
<ul>
<li>
<p>Quando implementare la comunicazione in tempo reale nei flussi di lavoro dell'intelligenza artificiale</p>
</li>
<li>
<p>Meccanismi di comunicazione web, confrontando le loro caratteristiche, differenze e somiglianze.</p>
</li>
<li>
<p>Meccanismi di comunicazione in tempo reale, tra cui eventi inviati dal server (SSE) e WebSocket (WS).</p>
</li>
<li>
<p>Scegliere la tecnologia di streaming corretta per il tuo caso d'uso</p>
</li>
<li>
<p>Implementare da zero gli endpoint di streaming simulato per i test e la prototipazione</p>
</li>
<li>
<p>Implementare endpoint API in tempo reale con i<span class="keep-together">meccanismi</span> SSE e WebSocket</p>
</li>
<li>
<p>Come gestire con grazia le eccezioni e chiudere le<span class="keep-together">connessioni</span> di streaming</p>
</li>
<li>
<p>Modelli di progettazione API per semplificare gli endpoint di streaming</p>
</li>
</ul>
</div></aside>
<p>Questo capitolo esplorerà i carichi di lavoro di AI in streaming come i chatbot, illustrando l'uso di tecnologie di comunicazione in tempo reale come SSE e WebSocket. Imparerai la differenza tra queste tecnologie e come implementare lo streaming di modelli costruendo endpoint per interazioni testo-testo in tempo reale.</p>
<section data-pdf-bookmark="Web Communication Mechanisms" data-type="sect1"><div class="sect1" id="id90">
<h1>Meccanismi di comunicazione web</h1>
<p><a data-primary="real-time communication with generative models" data-secondary="web communication mechanisms" data-type="indexterm" id="ix_ch06-asciidoc1"/>Nel capitolo precedente hai imparato a implementare la concorrenza nei flussi di lavoro dell'intelligenza artificiale sfruttando la programmazione asincrona, i task in background e il batching continuo. Con la concorrenza, i tuoi servizi diventano più resistenti per far fronte all'aumento della domanda quando più utenti accedono all'applicazione simultaneamente. La concorrenza risolve il problema di consentire agli utenti simultanei di accedere al tuo servizio e aiuta a diminuire i tempi di attesa, ma la generazione dei dati dell'intelligenza artificiale rimane un'attività che richiede molte risorse e molto tempo.</p>
<p>Fino a questo punto, hai costruito gli endpoint utilizzando la comunicazione HTTP convenzionale in cui il client invia una richiesta al server. Il server web elabora le richieste in arrivo e risponde tramite messaggi HTTP.</p>
<p>La<a data-type="xref" href="#client_server_architecture">Figura 6-1</a> mostra l'architettura client-server.</p>
<figure><div class="figure" id="client_server_architecture">
<img alt="bgai 0601" src="assets/bgai_0601.png" width="727" height="732"/>
<h6><span class="label">Figura 6-1. </span>L'architettura client-server (Fonte: <a class="orm:hideurl" href="https://scaleyourapp.com">scaleyourapp.com</a>)</h6>
</div></figure>
<p>Poiché il protocollo HTTP è stateless, il server tratta ogni richiesta in arrivo in modo completamente indipendente e non correlato alle altre richieste. Ciò significa che più richieste in arrivo da client diversi non influenzano il modo in cui il server risponde a ciascuna di esse. Ad esempio, in un servizio di intelligenza artificiale conversazionale che non utilizza un database, ogni richiesta può fornire l'intera cronologia della conversazione e ricevere la risposta corretta dal server.</p>
<p><a data-primary="HTTP request-response model" data-type="indexterm" id="id874"/>Il modello <em>HTTP richiesta-risposta</em> è un modello di progettazione delle API ampiamente adottato in tutto il web grazie alla sua semplicità. Tuttavia, questo approccio diventa inadeguato non appena il client o il server necessitano di aggiornamenti in tempo reale.</p>
<p>Nel modello standard HTTP richiesta-risposta, i tuoi servizi rispondono alla richiesta dell'utente una volta che questa è stata interamente elaborata. Tuttavia, se il processo di generazione dei dati è lungo e lento, i tuoi utenti aspetteranno a lungo e successivamente saranno inondati da molte informazioni in una volta sola. Immagina di chattare con un bot che impiega diversi minuti per rispondere e, una volta risposto, ti vengono mostrati blocchi di testo sovrabbondanti.</p>
<p>In alternativa, se fornisci i dati al cliente mentre vengono generati, invece di aspettare che l'intero processo di generazione sia completato, puoi ridurre i lunghi ritardi e fornire le informazioni in pezzi digeribili. Questo approccio non solo migliora l'esperienza dell'utente, ma mantiene anche il suo coinvolgimento durante l'elaborazione della sua richiesta.</p>
<p>Ci sono casi in cui l'implementazione di funzioni in tempo reale può essere eccessiva e aumentare il carico di sviluppo. Ad esempio, alcuni modelli o API open source non hanno la capacità di generare in tempo reale. Inoltre, l'aggiunta di endpoint per lo streaming dei dati può aumentare la complessità del sistema su entrambi i lati, il server e il client.
Significa dover gestire le eccezioni in modo diverso e gestire le connessioni simultanee agli endpoint di streaming per evitare perdite di memoria. Se il client si disconnette durante uno streaming, potrebbe verificarsi una perdita di dati o una deriva di stato tra il server e il client. Inoltre, potrebbe essere necessario implementare una complessa logica di riconnessione e gestione dello stato per gestire i casi in cui la connessione cade.</p>
<p>Mantenere molte connessioni aperte contemporanee può anche gravare sui tuoi server e comportare un aumento dei costi di hosting e di infrastruttura.</p>
<p>Altrettanto importante è considerare la scalabilità della gestione di un gran numero di flussi contemporanei, i requisiti di latenza della tua applicazione e la compatibilità del browser con il protocollo di streaming scelto.</p>
<div data-type="note" epub:type="note"><h6>Nota</h6>
<p>Rispetto alle applicazioni web tradizionali che hanno una qualche forma di latenza di I/O o di elaborazione dei dati, le applicazioni di AI hanno anche una latenza di inferenza del modello di AI, a seconda del modello utilizzato.</p>
<p>Poiché questa latenza può essere significativa, i tuoi servizi di intelligenza artificiale devono essere in grado di gestire tempi di attesa più lunghi sia dal lato del server che da quello del client, compresa la gestione dell'esperienza dell'utente.</p>
</div>
<p>Se il tuo caso d'uso beneficia di funzionalità in tempo reale, allora hai a disposizione alcuni modelli di progettazione architettonica che puoi implementare:</p>
<ul>
<li>
<p>Sondaggio regolare/breve</p>
</li>
<li>
<p>Sondaggio lungo</p>
</li>
<li>
<p>SSE</p>
</li>
<li>
<p>WS</p>
</li>
</ul>
<p>La scelta dipende dai tuoi requisiti di esperienza utente, scalabilità, latenza, costi di sviluppo e manutenibilità.</p>
<p>Analizziamo ogni opzione in modo più dettagliato.</p>
<section data-pdf-bookmark="Regular/Short Polling" data-type="sect2"><div class="sect2" id="id91">
<h2>Sondaggio regolare/breve</h2>
<p><a data-primary="real-time communication with generative models" data-secondary="web communication mechanisms" data-tertiary="regular/short polling" data-type="indexterm" id="ix_ch06-asciidoc2"/><a data-primary="regular/short polling" data-type="indexterm" id="ix_ch06-asciidoc3"/><a data-primary="web communication mechanisms" data-secondary="regular/short polling" data-type="indexterm" id="ix_ch06-asciidoc4"/>Un metodo per beneficiare degli aggiornamenti in semi-tempo reale è quello di utilizzare il <em>polling regolare/breve</em>, come mostrato nella <a data-type="xref" href="#short_polling">Figura 6-2</a>. In questo meccanismo di polling, il client invia periodicamente richieste HTTP al server per verificare la presenza di aggiornamenti a intervalli preconfigurati. Più brevi sono gli intervalli, più ci si avvicina agli aggiornamenti in tempo reale ma anche più alto sarà il traffico da gestire.</p>
<figure><div class="figure" id="short_polling">
<img alt="bgai 0602" src="assets/bgai_0602.png" width="937" height="1083"/>
<h6><span class="label">Figura 6-2. </span>Polling regolare/breve</h6>
</div></figure>
<p>Puoi utilizzare questa tecnica se stai costruendo un servizio per generare dati come le immagini in batch. Il client invia semplicemente una richiesta per avviare il lavoro in batch e gli viene assegnato un identificativo univoco per il lavoro/la richiesta. Poi controlla periodicamente il server per confermare lo stato e i risultati del lavoro richiesto. Il server risponde con nuovi dati o fornisce una risposta vuota (e forse un aggiornamento dello stato) se i risultati devono ancora essere calcolati.</p>
<p>Come puoi immaginare con un polling breve, ti ritroverai con un numero eccessivo di richieste in entrata a cui il server deve rispondere, anche quando non ci sono nuove informazioni. Se hai più utenti contemporanei, questo approccio può rapidamente sovraccaricare il server, limitando la scalabilità della tua applicazione. Tuttavia, puoi ridurre il carico del server utilizzando le risposte nella cache (cioè eseguendo controlli di stato sul backend con una frequenza tollerabile) e implementando il rate limiting, che imparerai a conoscere meglio nei Capitoli <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch09.html#ch09">9</a> e <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch10.html#ch10">10</a>.</p>
<p>Un potenziale caso d'uso del polling breve nei servizi di intelligenza artificiale è quando hai dei lavori batch o di inferenza in corso. Puoi esporre degli endpoint che permettano ai tuoi clienti di utilizzare il polling breve per tenersi aggiornati sullo stato di questi lavori e recuperare i risultati quando sono stati completati.</p>
<p>Un'alternativa è quella di sfruttare i sondaggi lunghi.<a data-startref="ix_ch06-asciidoc4" data-type="indexterm" id="id875"/><a data-startref="ix_ch06-asciidoc3" data-type="indexterm" id="id876"/><a data-startref="ix_ch06-asciidoc2" data-type="indexterm" id="id877"/></p>
</div></section>
<section data-pdf-bookmark="Long Polling" data-type="sect2"><div class="sect2" id="id92">
<h2>Sondaggio lungo</h2>
<p><a data-primary="long polling" data-type="indexterm" id="ix_ch06-asciidoc5"/><a data-primary="real-time communication with generative models" data-secondary="web communication mechanisms" data-tertiary="long polling" data-type="indexterm" id="ix_ch06-asciidoc6"/><a data-primary="web communication mechanisms" data-secondary="long polling" data-type="indexterm" id="ix_ch06-asciidoc7"/>Se vuoi ridurre il carico sul server continuando a sfruttare un meccanismo di polling in tempo reale, puoi implementare il <em>polling lungo</em> (vedi <a data-type="xref" href="#long_polling">Figura 6-3</a>), una versione migliorata del polling regolare/breve.</p>
<figure><div class="figure" id="long_polling">
<img alt="bgai 0603" src="assets/bgai_0603.png" width="937" height="916"/>
<h6><span class="label">Figura 6-3. </span>Polling lungo</h6>
</div></figure>
<p>Con il polling lungo, sia il server che il client sono configurati per evitare i<em>timeout</em> (se possibile) che si verificano quando il client o il server rinunciano alla richiesta prolungata.</p>
<div data-type="tip"><h6>Suggerimento</h6>
<p>I timeout vengono osservati più spesso in un tipico ciclo di richiesta-risposta HTTP quando una richiesta richiede un tempo prolungato per essere risolta o quando ci sono problemi di rete.</p>
</div>
<p>Per implementare il polling lungo, il server mantiene aperte le richieste in arrivo (cioè sospese) fino a quando non ci sono dati disponibili da inviare. Ad esempio, questo può essere utile quando si dispone di un LLM con tempi di elaborazione imprevedibili. Il client viene istruito ad aspettare per un periodo di tempo prolungato ed evita di interrompere e ripetere le richieste<span class="keep-together">prematuramente</span>.</p>
<p>Puoi utilizzare il polling lungo se hai bisogno di un design semplice dell'API e di un'architettura dell'applicazione per l'elaborazione di lavori prolungati, come ad esempio le inferenze multiple dell'intelligenza artificiale. Questa tecnica ti permette di evitare l'implementazione di un gestore di lavori batch per tenere traccia dei lavori per la generazione di dati in blocco. Invece, le richieste del client rimangono aperte fino a quando non vengono elaborate, evitando il ciclo costante di richiesta-risposta con polling breve che può sovraccaricare il server.</p>
<p>Sebbene il polling lungo sembri simile al tipico modello di richiesta-risposta HTTP, si differenzia per il modo in cui il client gestisce le richieste. Nel polling lungo, il client riceve tipicamente un singolo messaggio per ogni richiesta. Una volta che il server invia una risposta, la connessione viene chiusa. Il client apre quindi immediatamente una nuova connessione per attendere il messaggio successivo. Questo processo si ripete, consentendo al client di ricevere più messaggi nel tempo, ma ogni ciclo di richiesta-risposta HTTP gestisce un solo messaggio.</p>
<p>Poiché il polling lungo mantiene una connessione aperta fino a quando non è disponibile un messaggio, riduce la frequenza delle richieste rispetto al polling breve e implementa un meccanismo di comunicazione quasi in tempo reale. Tuttavia, il server deve comunque mantenere le richieste non soddisfatte, che consumano le risorse del server. Inoltre, se ci sono più richieste aperte da parte dello stesso client, l'ordinamento dei messaggi può essere difficile da gestire, portando potenzialmente a messaggi fuori ordine.</p>
<p>Se non hai un requisito specifico per l'utilizzo dei meccanismi di polling, un'alternativa più moderna ai meccanismi di polling per la comunicazione in tempo reale è SSE tramite l'interfaccia Event Source.<a data-startref="ix_ch06-asciidoc7" data-type="indexterm" id="id878"/><a data-startref="ix_ch06-asciidoc6" data-type="indexterm" id="id879"/><a data-startref="ix_ch06-asciidoc5" data-type="indexterm" id="id880"/></p>
</div></section>
<section data-pdf-bookmark="Server-Sent Events" data-type="sect2"><div class="sect2" id="id93">
<h2>Eventi inviati dal server</h2>
<p><a data-primary="real-time communication with generative models" data-secondary="web communication mechanisms" data-tertiary="Server Sent Events" data-type="indexterm" id="ix_ch06-asciidoc8"/><a data-primary="Server Sent Events (SSE)" data-type="indexterm" id="ix_ch06-asciidoc9"/><a data-primary="web communication mechanisms" data-secondary="Server Sent Events" data-type="indexterm" id="ix_ch06-asciidoc10"/>Gli<em>eventi inviati dal server</em> (SSE) sono un meccanismo basato su HTTP per stabilire una connessione persistente e unidirezionale tra il server e il client. Mentre la connessione è aperta, il server può inviare continuamente aggiornamenti al client quando i dati diventano<span class="keep-together">disponibili.</span></p>
<p>Una volta che il client stabilisce la connessione persistente SSE con il server, non avrà più bisogno di ristabilirla, a differenza del lungo meccanismo di polling in cui il client invia ripetutamente richieste al server per mantenere una connessione aperta.</p>
<p>Se stai servendo modelli GenAI, SSE è un meccanismo di comunicazione in tempo reale più adatto rispetto al long polling. SSE è stato progettato specificamente per gestire gli eventi in tempo reale ed è più efficiente del polling lungo. A causa dell'apertura e della chiusura ripetuta delle connessioni, il polling lungo richiede molte risorse e comporta un aumento della latenza e dell'overhead. SSE, invece, supporta la riconnessione automatica e gli ID evento per riprendere i flussi interrotti, cosa che il polling lungo non ha.</p>
<p>In SSE, il client effettua una richiesta HTTP standard <code translate="no">GET</code> con un'intestazione <code translate="no">Accept:text/event-stream</code> e il server risponde con un codice di stato <code translate="no">200</code> e un'intestazione <code translate="no">Content-Type: text/event-stream</code>. Dopo questo scambio, il server può inviare eventi al client sulla stessa connessione.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id881">
<h1>Interfaccia SSE e EventSource</h1>
<p><a data-primary="EventSource interface" data-type="indexterm" id="id882"/><a data-primary="Server Sent Events (SSE)" data-secondary="EventSource interface" data-type="indexterm" id="id883"/>La specifica SSE descrive un'interfaccia integrata <code translate="no">EventSource</code>che apre una connessione persistente con il server per inviare eventi dal server. Analogamente a WebSocket, la connessione è persistente.</p>
<p><code translate="no">EventSource</code> è un modo meno potente di comunicare con il server rispetto a<span class="keep-together">WebSocket.</span></p>
<p>Perché si dovrebbe usare? Il motivo principale è che è più semplice. In molte applicazioni, la potenza di WebSocket è un po' eccessiva. Parleremo di WebSocket a breve.</p>
<p>Abbiamo bisogno di ricevere un flusso di dati da un server, magari messaggi di chat o prezzi di mercato, o altro. Questo è ciò che <code translate="no">EventSource</code> è in grado di fare. Inoltre, supporta la riconnessione automatica, cosa che dobbiamo implementare manualmente con WebSocket. Inoltre, è un semplice vecchio HTTP, non un nuovo protocollo.</p>
<p>Al momento della creazione, un nuovo <code translate="no">EventSource</code> si connette al server e se la connessione si interrompe, si riconnette. Questo è molto comodo, perché non dobbiamo preoccuparci di questo. C'è un piccolo ritardo tra le riconnessioni, di pochi secondi per impostazione predefinita. Il server può impostare il ritardo consigliato utilizzando <code translate="no">retry</code>: in response to (millisecondi).</p>
</div></aside>
<p>Anche se SSE dovrebbe essere la prima scelta per le applicazioni in tempo reale, puoi comunque optare per un meccanismo più semplice di polling lungo quando gli aggiornamenti sono poco frequenti o se il tuo ambiente non supporta le connessioni persistenti.</p>
<p>Un ultimo dettaglio importante da notare è che le connessioni SSE sono <em>unidirezionali</em>, cioè invii una normale richiesta HTTP al server e ricevi la risposta tramite SSE. Pertanto, sono adatte solo ad applicazioni che non hanno bisogno di inviare dati al server. Potresti aver visto SSE in azione all'interno di feed di notizie, notifiche e dashboard in tempo reale come i grafici dei dati azionari.</p>
<p>Non sorprende che l'SSE sia particolarmente indicato nelle applicazioni di chat, quando è necessario trasmettere le risposte dell'LLM durante una conversazione. In questo caso, il client può stabilire una connessione persistente separata fino a quando il server non trasmette completamente la risposta dell'LLM all'utente.</p>
<div data-type="note" epub:type="note"><h6>Nota</h6>
<p>ChatGPT sfrutta SSE sotto il cofano per consentire risposte in tempo reale alle query degli utenti.</p>
</div>
<p><a data-type="xref" href="#server_sent_events">La Figura 6-4</a> mostra il funzionamento del meccanismo di comunicazione SSE.</p>
<figure><div class="figure" id="server_sent_events">
<img alt="bgai 0604" src="assets/bgai_0604.png" width="937" height="499"/>
<h6><span class="label">Figura 6-4. </span>SSE</h6>
</div></figure>
<p>Per approfondire la tua comprensione, in questo capitolo realizzeremo due mini-progetti con SSE: uno per lo streaming di dati da un generatore di dati simulato e l'altro per lo streaming di risposte LLM.</p>
<p>Scoprirai maggiori dettagli sul meccanismo SSE durante i progetti sopra citati.</p>
<p>In sintesi, SSE è eccellente per stabilire connessioni persistenti unidirezionali, ma cosa succede se hai bisogno di inviare e ricevere messaggi durante una connessione persistente? In questo caso WebSocket può essere utile.<a data-startref="ix_ch06-asciidoc10" data-type="indexterm" id="id884"/><a data-startref="ix_ch06-asciidoc9" data-type="indexterm" id="id885"/><a data-startref="ix_ch06-asciidoc8" data-type="indexterm" id="id886"/></p>
</div></section>
<section data-pdf-bookmark="WebSocket" data-type="sect2"><div class="sect2" id="id94">
<h2>WebSocket</h2>
<p><a data-primary="real-time communication with generative models" data-secondary="web communication mechanisms" data-tertiary="WebSocket" data-type="indexterm" id="ix_ch06-asciidoc11"/><a data-primary="web communication mechanisms" data-secondary="WebSocket" data-type="indexterm" id="ix_ch06-asciidoc12"/><a data-primary="WebSocket (WS)" data-type="indexterm" id="ix_ch06-asciidoc13"/>L'ultimo meccanismo di comunicazione in tempo reale da trattare è WebSocket.</p>
<p><a data-primary="bidirectional connection" data-type="indexterm" id="id887"/>WebSocket è un eccellente meccanismo di comunicazione in tempo reale per stabilire <em>connessioni bidirezionali</em> persistenti tra il client e il server per le chat in tempo reale, nonché per le applicazioni vocali e video con un modello di intelligenza artificiale. Una connessione bidirezionale significa che entrambe le parti possono inviare e ricevere dati in tempo reale in qualsiasi ordine, purché sia aperta una connessione persistente tra il client e il server. È stato progettato per funzionare su porte HTTP standard per garantire la compatibilità con le misure di sicurezza esistenti. Le applicazioni web che richiedono una comunicazione bidirezionale con i server traggono il massimo vantaggio da questo meccanismo in quanto possono evitare l'overhead e la complessità del<span class="keep-together">polling</span> HTTP.</p>
<p>Puoi utilizzare WebSocket in una varietà di applicazioni, tra cui feed sociali, giochi multiplayer, feed finanziari, aggiornamenti basati sulla posizione, chat multimediali, ecc.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id888">
<h1>Webhook contro WebSocket</h1>
<p><a data-primary="Webhook, WebSocket versus" data-type="indexterm" id="id889"/><a data-primary="WebSocket (WS)" data-secondary="Webhook versus" data-type="indexterm" id="id890"/>Non confondere WebSocket con Webhook: questi termini vengono usati in modo intercambiabile ma si riferiscono a meccanismi di comunicazione web in tempo reale diversi.</p>
<p>I webhook sono utilizzati per la comunicazione in tempo reale da server a server per supportare le architetture applicative event-driven. Pertanto, quando un server espone un endpoint webhook, sta dicendo agli altri server di inviare immediatamente i dati a quell'endpoint webhook quando si verifica un evento.</p>
<p>Puoi pensare ai webhook come a un meccanismo di comunicazione unidirezionale non persistente ma in tempo reale, in cui un server invia messaggi a un altro nel momento in cui vengono generati. In realtà, non ci sono handshake o connessioni aperte tra i server.</p>
</div></aside>
<p>A differenza di tutti gli altri meccanismi di comunicazione discussi finora, il protocollo WebSocket non trasferisce i dati su HTTP dopo l'handshake iniziale, ma implementa un meccanismo di messaggistica bidirezionale (full-duplex) su una singola connessione TCP. Di conseguenza, WebSocket è più veloce nella trasmissione dei dati rispetto a HTTP perché ha meno overhead di protocollo e opera a un livello inferiore nello stack di protocolli di rete. Questo perché HTTP si trova in cima a TCP, quindi il ritorno a TCP sarà più veloce.</p>
<div data-type="tip"><h6>Suggerimento</h6>
<p>WebSocket mantiene un socket aperto sia sul client che sul server per tutta la durata della connessione. Si noti che questo rende anche i server statici, il che rende più complicato il ridimensionamento.</p>
</div>
<p>A questo punto ti starai chiedendo come funziona il protocollo WebSocket.</p>
<p>Secondo l'RFC 6455, per stabilire una connessione WebSocket, il client invia una richiesta HTTP di "aggiornamento" al server, chiedendo di aprire una connessione WebSocket.<a data-primary="opening handshake" data-type="indexterm" id="id891"/>Questo viene definito l'<em>handshake di apertura</em>, che dà inizio al ciclo di vita della connessione WebSocket nello stato<em>CONNECTING</em>.</p>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>I tuoi servizi di AI devono essere in grado di gestire più handshake simultanei e di autenticarli prima di aprire una connessione. Le nuove connessioni possono consumare le risorse del server, quindi devono essere gestite correttamente dal tuo server.</p>
</div>
<p>La richiesta di aggiornamento HTTP deve contenere una serie di intestazioni necessarie, come mostrato nell'<a data-type="xref" href="#websocket_handshake">Esempio 6-1</a>.</p>
<div data-type="example" id="websocket_handshake">
<h5><span class="label">Esempio 6-1. </span>Apertura di WebSocket tramite HTTP</h5>
<pre data-code-language="text" data-type="programlisting" translate="no"><code translate="no">GET ws://localhost:8000/generate/text/stream HTTP/1.1 </code><a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO1-1" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO1-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
Origin: http://localhost:3000
Connection: Upgrade </code><a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO1-2" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO1-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
Host: http://localhost:8000
Upgrade: websocket </code><a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO1-2" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO1-3"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
Sec-WebSocket-Key: 8WnhvZTK66EVvhDG++RD0w== </code><a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO1-3" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO1-4"><img alt="3" src="assets/3.png" width="12" height="12"/></a><code translate="no">
Sec-WebSocket-Protocol: html-chat, text-chat </code><a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO1-4" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO1-5"><img alt="4" src="assets/4.png" width="12" height="12"/></a><code translate="no">
Sec-WebSocket-Version: 13</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO1-1" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO1-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Effettua una richiesta di aggiornamento HTTP all'endpoint WebSocket. Gli endpoint WebSocket iniziano con <code translate="no">ws://</code> invece del tipico <code translate="no">http://</code>.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO1-2" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO1-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Richiesta di aggiornamento e apertura di una connessione WebSocket.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO1-4" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO1-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Utilizza una stringa casuale di 16 byte codificata in Base64 per assicurarti che il server supporti il protocollo WebSocket.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO1-5" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO1-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Usa il sottoprotocollo <code translate="no">html-chat</code> o <code translate="no">text-chat</code> se <code translate="no">html-chat</code> non è disponibile. I sottoprotocolli regolano i dati da scambiare.</p></dd>
</dl></div>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>In produzione, utilizza sempre endpoint WebSocket <code translate="no">wss://</code> sicuri.</p>
<p>Il protocollo <code translate="no">wss://</code>, simile a <code translate="no">https://</code>, non solo è criptato ma anche più affidabile. Questo perché i dati di <code translate="no">ws://</code> non sono criptati e sono visibili a qualsiasi intermediario. I vecchi server proxy non conoscono WebSocket e potrebbero vedere intestazioni "strane" e interrompere la connessione.</p>
<p>D'altra parte, <code translate="no">wss://</code> è la versione sicura di WebSocket, che funziona su Transport Layer Security (TLS), che cripta i dati al mittente e li decripta al destinatario. Quindi i pacchetti di dati passano criptati attraverso i proxy, che non possono vedere cosa contengono e lasciarli passare.</p>
</div>
<p>Una volta stabilita la connessione WebSocket, i messaggi testuali o binari possono essere trasmessi in entrambe le direzioni sotto forma di <em>frame di messaggi</em>. Il ciclo di vita della connessione è ora nello stato <em>OPEN</em>.</p>
<p>Puoi vedere il meccanismo di comunicazione WebSocket nella <a data-type="xref" href="#websockets">Figura 6-5</a>.</p>
<figure><div class="figure" id="websockets">
<img alt="bgai 0605" src="assets/bgai_0605.png" width="1014" height="499"/>
<h6><span class="label">Figura 6-5. </span>Comunicazione WS</h6>
</div></figure>
<p><a data-primary="message frames" data-type="indexterm" id="id892"/>I<em>message frame</em> sono un modo per impacchettare e trasmettere i dati tra il client e il server. Non sono un'esclusiva di WebSocket, poiché si applicano a tutte le connessioni tramite il protocollo TCP che costituisce la base di HTTP. Tuttavia, un message frame di WebSocket è costituito da diversi componenti:</p>
<dl>
<dt>Intestazione fissa</dt>
<dd>
<p>Descrive le informazioni di base del messaggio</p>
</dd>
<dt>Lunghezza del carico utile estesa (opzionale)</dt>
<dd>
<p>Fornisce la lunghezza effettiva del payload quando la lunghezza supera i 125 byte.</p>
</dd>
<dt>Chiave di mascheramento</dt>
<dd>
<p>Maschera i dati del payload nei frame inviati dal client al server, prevenendo alcuni tipi di vulnerabilità di sicurezza, in particolare l'<em>avvelenamento della cache</em><sup><a data-type="noteref" href="ch06.html#id893" id="id893-marker" translate="no">1</a></sup> e gli attacchi <em>cross-protocollo</em><sup><a data-type="noteref" href="ch06.html#id894" id="id894-marker" translate="no">2</a></sup> attacchi</p>
</dd>
<dt>Carico utile</dt>
<dd>
<p>Contiene il contenuto effettivo del messaggio</p>
</dd>
</dl>
<p class="less_space pagebreak-before">A differenza delle intestazioni verbose delle richieste HTTP, i frame WebSocket hanno intestazioni minime che includono quanto segue:</p>
<dl>
<dt>Cornici di testo</dt>
<dd>
<p>Utilizzato per i dati di testo codificati UTF-8</p>
</dd>
<dt>Cornici binarie</dt>
<dd>
<p>Utilizzato per i dati binari</p>
</dd>
<dt>Frammentazione</dt>
<dd>
<p>Utilizzato per frammentare i messaggi in più frame, che vengono riassemblati dal destinatario.</p>
</dd>
</dl>
<p>Il bello del protocollo WebSocket è anche la sua capacità di mantenere una connessione persistente attraverso i <em>frame di controllo</em>.</p>
<p><a data-primary="control frames" data-type="indexterm" id="id895"/>I<em>frame di controllo</em> sono frame speciali utilizzati per gestire la connessione:</p>
<dl>
<dt>Telai per ping/pong</dt>
<dd>
<p>Utilizzato per controllare lo stato della connessione</p>
</dd>
<dt>Chiudi la cornice</dt>
<dd>
<p>Utilizzato per terminare la connessione con grazia</p>
</dd>
</dl>
<p>Quando è il momento di chiudere la connessione WebSocket, il client o il server inviano un frame di chiusura. Il frame di chiusura può specificare facoltativamente un codice di stato e/o un motivo per la chiusura della connessione. A questo punto, la connessione WebSocket entra nello stato di <em>CHIUSURA</em>.</p>
<p>Lo stato <em>CLOSING</em> termina quando l'altra parte risponde con un altro frame di chiusura, concludendo così l'intero ciclo di vita della connessione WebSocket nello stato <em>CLOSED</em>, come mostrato nella<a data-type="xref" href="#websocket_connection_lifecycle">Figura 6-6</a>.</p>
<figure><div class="figure" id="websocket_connection_lifecycle">
<img alt="bgai 0606" src="assets/bgai_0606.png" width="1275" height="995"/>
<h6><span class="label">Figura 6-6. </span>Ciclo di vita della connessione WebSocket</h6>
</div></figure>
<p>Come puoi vedere, l'utilizzo del meccanismo di comunicazione WebSocket può essere un po' eccessivo per le applicazioni semplici che non richiedono l'overhead. Per la maggior parte delle applicazioni GenAI, le connessioni SSE possono essere sufficienti.</p>
<p>Tuttavia, ci sono casi d'uso GenAI in cui WebSocket può brillare, come le applicazioni di chat multimediale e voice-to-voice, le applicazioni GenAI collaborative e i servizi di trascrizione in tempo reale basati sulla comunicazione bidirezionale. Per fare un po' di esperienza pratica, più avanti in questo capitolo realizzerai un'applicazione speech-to-text.<a data-startref="ix_ch06-asciidoc13" data-type="indexterm" id="id896"/><a data-startref="ix_ch06-asciidoc12" data-type="indexterm" id="id897"/><a data-startref="ix_ch06-asciidoc11" data-type="indexterm" id="id898"/></p>
<p>Ora che hai imparato a conoscere diversi meccanismi di comunicazione web unici per le applicazioni in tempo reale, riassumiamo rapidamente il loro confronto.</p>
</div></section>
<section class="less_space pagebreak-before" data-pdf-bookmark="Comparing Communication Mechanisms" data-type="sect2"><div class="sect2" id="id95">
<h2>Meccanismi di comunicazione a confronto</h2>
<p><a data-primary="real-time communication with generative models" data-secondary="web communication mechanisms" data-tertiary="comparing communication mechanisms" data-type="indexterm" id="ix_ch06-asciidoc14"/><a data-primary="web communication mechanisms" data-secondary="comparing communication mechanisms" data-type="indexterm" id="ix_ch06-asciidoc15"/>La<a data-type="xref" href="#communication_mechanims_figure">Figura 6-7</a>illustra i cinque meccanismi di comunicazione utilizzati nello sviluppo web.</p>
<figure><div class="figure" id="communication_mechanims_figure">
<img alt="bgai 0607" src="assets/bgai_0607.png" width="1437" height="892"/>
<h6><span class="label">Figura 6-7. </span>Confronto tra i meccanismi di comunicazione web</h6>
</div></figure>
<p>Come puoi vedere dalla <a data-type="xref" href="#communication_mechanims_figure">Figura 6-7</a>, i modelli di messaggistica differiscono in ogni approccio.</p>
<p>La<em>richiesta-risposta HTTP</em> è il modello più comune supportato da tutti i client e i server web, adatto alle API RESTful e ai servizi che non richiedono aggiornamenti in tempo reale.</p>
<p><a data-primary="regular/short polling" data-type="indexterm" id="id899"/>Il<em>polling breve/regolare</em> prevede che i client verifichino la presenza di dati a intervalli prestabiliti, il che è semplice ma può essere dispendioso in termini di risorse quando si scalano i servizi. Di solito viene utilizzato nelle applicazioni per eseguire aggiornamenti poco frequenti, come ad esempio nei cruscotti analitici.</p>
<p><a data-primary="long polling" data-type="indexterm" id="id900"/>Il<em>polling lungo</em> è più efficiente per gli aggiornamenti in tempo reale, in quanto mantiene aperte le connessioni fino a quando i dati non sono disponibili sul server. Tuttavia, può comunque esaurire le risorse del server, il che lo rende ideale per le funzioni quasi in tempo reale come le notifiche.</p>
<p><a data-primary="Server Sent Events (SSE)" data-secondary="messaging patterns" data-type="indexterm" id="id901"/><em>SSE</em> mantiene una singola connessione persistente solo da server a client, utilizzando il protocollo HTTP. È semplice da configurare, sfrutta l'API <code translate="no">EventSource</code> del browser e viene fornito con funzioni integrate come la riconnessione. Questi fattori rendono SSE adatto alle applicazioni che richiedono feed live, funzioni di chat e dashboard in tempo reale.</p>
<p><a data-primary="WebSocket (WS)" data-secondary="messaging patterns" data-type="indexterm" id="id902"/><em>WebSocket</em> offre una comunicazione full-duplex (a doppia faccia) con bassa latenza e supporto per i dati binari, ma è complesso da implementare. È ampiamente utilizzato nelle applicazioni che richiedono un'elevata interattività e lo scambio di dati in tempo reale, come i giochi multiplayer, le applicazioni di chat, gli strumenti collaborativi e i servizi di trascrizione in tempo reale.</p>
<p>Con l'invenzione di SSE e WebSocket e la loro crescente popolarità, il polling breve/regolare e il polling lungo stanno diventando meccanismi in tempo reale meno comuni nelle applicazioni web.</p>
<p>La<a data-type="xref" href="#communication_mechanisms_table">Tabella 6-1</a> mette a confronto le caratteristiche, le sfide e le applicazioni di ciascun meccanismo.</p>
<table class="striped" id="communication_mechanisms_table">
<caption><span class="label">Tabella 6-1. </span>Confronto tra i meccanismi di comunicazione web</caption>
<thead>
<tr>
<th>Meccanismo di comunicazione</th>
<th>Caratteristiche</th>
<th>Sfide</th>
<th>Applicazioni</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>Richiesta-risposta HTTP</p></td>
<td><p>Modello semplice di richiesta e risposta, protocollo stateless, supportato da tutti i client e i server web.</p></td>
<td><p>Alta latenza per gli aggiornamenti in tempo reale, inefficiente per il trasferimento frequente di dati da server a client</p></td>
<td><p>API RESTful, servizi web in cui gli aggiornamenti in tempo reale non sono critici</p></td>
</tr>
<tr>
<td><p>Sondaggi brevi/regolari</p></td>
<td><p>Il cliente richiede regolarmente i dati a intervalli, facile da implementare</p></td>
<td><p>Spreco di risorse quando non ci sono nuovi dati, la latenza dipende dagli intervalli di sondaggio</p></td>
<td><p>Applicazioni con aggiornamenti poco frequenti, semplici dashboard quasi in tempo reale, aggiornamenti sullo stato dei lavori inviati</p></td>
</tr>
<tr>
<td><p>Sondaggio lungo</p></td>
<td><p>Più efficiente del polling breve per gli aggiornamenti in tempo reale, mantiene la connessione aperta fino a quando i dati sono disponibili</p></td>
<td><p>Può richiedere molte risorse al server, è complesso gestire più connessioni.</p></td>
<td><p>Notifiche in tempo reale, vecchie applicazioni di chat</p></td>
</tr>
<tr>
<td><p>Eventi inviati dal server</p></td>
<td><p>Singola connessione persistente per gli aggiornamenti, riconnessione integrata e supporto dell'ID evento</p></td>
<td><p>Comunicazione unidirezionale solo dal server al client</p></td>
<td><p>Feed in diretta, applicazione di chat, dashboard di analisi in tempo reale</p></td>
</tr>
<tr>
<td><p>WebSocket</p></td>
<td><p>Comunicazione full-duplex, bassa latenza, supporto dei dati binari</p></td>
<td><p>Più complesso da implementare e gestire, richiede il supporto di WebSocket sul server.</p></td>
<td><p>Giochi multiplayer, applicazioni di chat, strumenti di editing collaborativo, applicazioni per videoconferenze e webinar, applicazioni per la trascrizione e la traduzione in tempo reale.</p></td>
</tr>
</tbody>
</table>
<p>Dopo aver esaminato in dettaglio i meccanismi di comunicazione in tempo reale, approfondiamo l'argomento SSE e WebSocket implementando i nostri endpoint di streaming utilizzando questi due meccanismi.<a data-startref="ix_ch06-asciidoc15" data-type="indexterm" id="id903"/><a data-startref="ix_ch06-asciidoc14" data-type="indexterm" id="id904"/>Nella prossima sezione scoprirai come implementare gli endpoint di streaming con entrambe le tecnologie.<a data-startref="ix_ch06-asciidoc1" data-type="indexterm" id="id905"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Implementing SSE Endpoints" data-type="sect1"><div class="sect1" id="id248">
<h1>Implementare gli endpoint SSE</h1>
<p><a data-primary="real-time communication with generative models" data-secondary="implementing SSE endpoints" data-type="indexterm" id="ix_ch06-asciidoc16"/><a data-primary="Server Sent Events (SSE)" data-secondary="implementing SSE endpoints" data-type="indexterm" id="ix_ch06-asciidoc17"/>Nel <a data-type="xref" href="ch03.html#ch03">Capitolo 3</a> hai imparato a conoscere gli LLMs, che sono modelli <em>autoregressivi</em> che prevedono il token successivo in base agli input precedenti. Dopo ogni fase di generazione, il token di uscita viene aggiunto agli input e passato nuovamente attraverso il modello fino a quando non viene generato un token <code translate="no">&lt;stop&gt;</code> per interrompere il ciclo. Invece di aspettare che il ciclo finisca, puoi inoltrare all'utente i token di uscita mentre vengono generati come flusso di dati.</p>
<p>I provider di modelli normalmente espongono un'opzione che ti permette di impostare la modalità di uscita come flusso di dati utilizzando <code translate="no">stream=True</code>. Con questa opzione, il provider di modelli può restituirti un generatore di dati invece dell'output finale, che puoi passare direttamente al tuo server FastAPI per lo streaming.</p>
<p>Per dimostrarlo in azione, fai riferimento all'<a data-type="xref" href="#async_azure_openai_client">Esempio 6-2</a>, che implementa un generatore di dati asincrono utilizzando la libreria <code translate="no">openai</code>.</p>
<div data-type="tip"><h6>Suggerimento</h6>
<p>Per eseguire l'<a data-type="xref" href="#async_azure_openai_client">Esempio 6-2</a>, dovrai creare un'istanza di Azure OpenAI sul portale di Azure e creare un modello di distribuzione. Prendi nota dell'endpoint API, della chiave e del nome del modello di distribuzione. Per l'<a data-type="xref" href="#async_azure_openai_client">Esempio 6-2</a>, puoi utilizzare la versione <code translate="no">2023-05-15</code> api.</p>
</div>
<div data-type="example" id="async_azure_openai_client">
<h5><span class="label">Esempio 6-2. </span>Implementazione del client di chat asincrono di Azure OpenAI per lo streaming delle risposte</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># stream.py</code>

<code class="kn" translate="no">import</code> <code class="nn" translate="no">asyncio</code>
<code class="kn" translate="no">import</code> <code class="nn" translate="no">os</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">typing</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">AsyncGenerator</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">openai</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">AsyncAzureOpenAI</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">AzureOpenAIChatClient</code><code class="p" translate="no">:</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO2-1" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO2-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
    <code class="k" translate="no">def</code> <code class="fm" translate="no">__init__</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
        <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">aclient</code> <code class="o" translate="no">=</code> <code class="n" translate="no">AsyncAzureOpenAI</code><code class="p" translate="no">(</code>
            <code class="n" translate="no">api_key</code><code class="o" translate="no">=</code><code class="n" translate="no">os</code><code class="o" translate="no">.</code><code class="n" translate="no">environ</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">OPENAI_API_KEY</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code>
            <code class="n" translate="no">api_version</code><code class="o" translate="no">=</code><code class="n" translate="no">os</code><code class="o" translate="no">.</code><code class="n" translate="no">environ</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">OPENAI_API_VERSION</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code>
            <code class="n" translate="no">azure_endpoint</code><code class="o" translate="no">=</code><code class="n" translate="no">os</code><code class="o" translate="no">.</code><code class="n" translate="no">environ</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">OPENAI_API_ENDPOINT</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code>
            <code class="n" translate="no">azure_deployment</code><code class="o" translate="no">=</code><code class="n" translate="no">os</code><code class="o" translate="no">.</code><code class="n" translate="no">environ</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">OPENAI_API_DEPLOYMENT</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code>
        <code class="p" translate="no">)</code>

    <code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">chat_stream</code><code class="p" translate="no">(</code>
        <code class="bp" translate="no">self</code><code class="p" translate="no">,</code> <code class="n" translate="no">prompt</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code><code class="p" translate="no">,</code> <code class="n" translate="no">model</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">gpt-3.5-turbo</code><code class="s2" translate="no">"</code>
    <code class="p" translate="no">)</code> <code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code> <code class="n" translate="no">AsyncGenerator</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code> <code class="kc" translate="no">None</code><code class="p" translate="no">]</code><code class="p" translate="no">:</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO2-2" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO2-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
        <code class="n" translate="no">stream</code> <code class="o" translate="no">=</code> <code class="k" translate="no">await</code> <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">aclient</code><code class="o" translate="no">.</code><code class="n" translate="no">chat</code><code class="o" translate="no">.</code><code class="n" translate="no">completions</code><code class="o" translate="no">.</code><code class="n" translate="no">create</code><code class="p" translate="no">(</code>
            <code class="n" translate="no">messages</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code>
                <code class="p" translate="no">{</code>
                    <code class="s2" translate="no">"</code><code class="s2" translate="no">role</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">user</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code>
                    <code class="s2" translate="no">"</code><code class="s2" translate="no">content</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="n" translate="no">prompt</code><code class="p" translate="no">,</code>
                <code class="p" translate="no">}</code>
            <code class="p" translate="no">]</code><code class="p" translate="no">,</code>
            <code class="n" translate="no">model</code><code class="o" translate="no">=</code><code class="n" translate="no">model</code><code class="p" translate="no">,</code>
            <code class="n" translate="no">stream</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">,</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO2-3" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO2-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a>
        <code class="p" translate="no">)</code>

        <code class="k" translate="no">async</code> <code class="k" translate="no">for</code> <code class="n" translate="no">chunk</code> <code class="ow" translate="no">in</code> <code class="n" translate="no">stream</code><code class="p" translate="no">:</code>
            <code class="k" translate="no">yield</code> <code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">data: </code><code class="si" translate="no">{</code><code class="n" translate="no">chunk</code><code class="o" translate="no">.</code><code class="n" translate="no">choices</code><code class="p" translate="no">[</code><code class="mi" translate="no">0</code><code class="p" translate="no">]</code><code class="o" translate="no">.</code><code class="n" translate="no">delta</code><code class="o" translate="no">.</code><code class="n" translate="no">content</code> <code class="ow" translate="no">or</code> <code class="s1" translate="no">'</code><code class="s1" translate="no">'</code><code class="si" translate="no">}</code><code class="se" translate="no">\n</code><code class="se" translate="no">\n</code><code class="s2" translate="no">"</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO2-4" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO2-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a>
            <code class="k" translate="no">await</code> <code class="n" translate="no">asyncio</code><code class="o" translate="no">.</code><code class="n" translate="no">sleep</code><code class="p" translate="no">(</code><code class="mf" translate="no">0.05</code><code class="p" translate="no">)</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO2-5" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO2-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a>

        <code class="k" translate="no">yield</code> <code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">data: [DONE]</code><code class="se" translate="no">\n</code><code class="se" translate="no">\n</code><code class="s2" translate="no">"</code>


<code class="n" translate="no">azure_chat_client</code> <code class="o" translate="no">=</code> <code class="n" translate="no">AzureOpenAIChatClient</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO2-1" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO2-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Crea un client asincrono <code translate="no">AzureOpenAIChatClient</code> per interagire con l'API OpenAI di Azure. Il client di chat richiede un endpoint API, un nome di distribuzione, una chiave e una versione per funzionare.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO2-2" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO2-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Definisce un metodo generatore asincrono <code translate="no">chat_stream</code> che produce ogni token di uscita dall'API.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO2-3" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO2-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Imposta <code translate="no">stream=True</code> per ricevere un flusso di output dall'API invece della risposta completa in una volta sola.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO2-4" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO2-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Esegue un loop sullo stream e restituisce ogni token di output o restituisce una stringa vuota se <code translate="no">delta.content</code> è vuoto. La sottostringa <code translate="no">data:</code> deve essere anteposta a ogni token in modo che i browser possano analizzare correttamente il contenuto utilizzando l'API <code translate="no">EventSource</code>.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO2-5" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO2-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a></dt>
<dd><p>Rallenta la velocità di streaming per ridurre la contropressione sui clienti.</p></dd>
</dl></div>
<p>Nell'<a data-type="xref" href="#async_azure_openai_client">Esempio 6-2</a>, crei un'istanza di<code translate="no">AsyncAzureOpenAI</code>, che ti permette di chattare con i modelli Azure OpenAI tramite un'API nel tuo ambiente Azure privato.</p>
<p>Impostando il prefisso <code translate="no">stream=True</code>, <code translate="no">AsyncAzureOpenAI</code> restituisce un flusso di dati (una funzione generatrice asincrona) invece della risposta completa del modello. Puoi eseguire un loop sul flusso di dati e sui token <code translate="no">yield</code> con il prefisso <code translate="no">data:</code> per conformarti alle specifiche SSE. In questo modo i browser potranno analizzare automaticamente il contenuto del flusso utilizzando l'API web <code translate="no">EventSource</code>, ampiamente disponibile.<sup><a data-type="noteref" href="ch06.html#id906" id="id906-marker" translate="no">3</a></sup></p>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>Quando esponi endpoint di streaming, dovrai considerare la velocità con cui i client possono consumare i dati che gli stai inviando. Una buona pratica è quella di ridurre la velocità di streaming come hai visto nell'<a data-type="xref" href="#async_azure_openai_client">Esempio 6-2</a> per ridurre la pressione sui client. Puoi regolare il throttling testando i tuoi servizi con diversi client su vari dispositivi.</p>
</div>
<section data-pdf-bookmark="SSE with GET Request" data-type="sect2"><div class="sect2" id="id443">
<h2>SSE con richiesta GET</h2>
<p>Ora puoi implementare l'endpoint SSE passando il flusso di chat al sito <code translate="no">StreamingResponse</code> di FastAPI come endpoint <code translate="no">GET</code>, come mostrato nell'<a data-type="xref" href="#sse_endpoint">Esempio 6-3</a>.</p>
<div data-type="example" id="sse_endpoint">
<h5><span class="label">Esempio 6-3. </span>Implementazione di un endpoint SSE utilizzando la FastAPI <code translate="no">StreamingResponse</code></h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># main.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">fastapi</code><code class="nn" translate="no">.</code><code class="nn" translate="no">responses</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">StreamingResponse</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">stream</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">azure_chat_client</code>

<code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code>

<code class="nd" translate="no">@app</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/generate/text/stream</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO3-1" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO3-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
<code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">serve_text_to_text_stream_controller</code><code class="p" translate="no">(</code>
    <code class="n" translate="no">prompt</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code><code class="p" translate="no">,</code>
<code class="p" translate="no">)</code> <code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code> <code class="n" translate="no">StreamingResponse</code><code class="p" translate="no">:</code>
    <code class="k" translate="no">return</code> <code class="n" translate="no">StreamingResponse</code><code class="p" translate="no">(</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO3-2" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO3-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
        <code class="n" translate="no">azure_chat_client</code><code class="o" translate="no">.</code><code class="n" translate="no">chat_stream</code><code class="p" translate="no">(</code><code class="n" translate="no">prompt</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code> <code class="n" translate="no">media_type</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">text/event-stream</code><code class="s2" translate="no">"</code>
    <code class="p" translate="no">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO3-1" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO3-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Implementa un endpoint SSE con il metodo <code translate="no">GET</code> da utilizzare con l'API <code translate="no">EventSource</code> sul browser.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO3-2" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO3-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Passa il generatore di flussi di chat a <code translate="no">StreamingResponse</code> per inoltrare il flusso di output che viene generato al client. Imposta <code translate="no">media_type=text/event-stream</code> come da specifiche SSE in modo che i browser possano gestire correttamente la risposta.</p></dd>
</dl></div>
<p>Con l'endpoint <code translate="no">GET</code> configurato sul server, puoi creare un semplice modulo HTML sul client per consumare il flusso SSE tramite l'interfaccia <code translate="no">EventSource</code>, come mostrato nell'<a data-type="xref" href="#sse_client">Esempio 6-4</a>.</p>
<div data-type="tip"><h6>Suggerimento</h6>
<p>L<a data-type="xref" href="#sse_client">'esempio 6-4</a> non utilizza alcuna libreria JavaScript o framework web, ma esistono librerie che ti aiuteranno a implementare la connessione<code translate="no">EventSource</code> in qualsiasi framework di tua scelta come React, Vue o SvelteKit.</p>
</div>
<div data-type="example" id="sse_client">
<h5><span class="label">Esempio 6-4. </span>Implementazione di SSE sul client utilizzando l'API del browser <code translate="no">EventSource</code> </h5>
<pre data-code-language="html" data-type="programlisting" translate="no"><code translate="no">{# pages/client-sse.html #}

</code><code class="cp" translate="no">&lt;!DOCTYPE html&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">html</code> <code class="na" translate="no">lang</code><code class="o" translate="no">=</code><code class="s" translate="no">"en"</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">head</code><code class="p" translate="no">&gt;</code>
    <code class="p" translate="no">&lt;</code><code class="nt" translate="no">title</code><code class="p" translate="no">&gt;</code><code translate="no">SSE with EventSource API</code><code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">title</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">head</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">body</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">button</code> <code class="na" translate="no">id</code><code class="o" translate="no">=</code><code class="s" translate="no">"streambtn"</code><code class="p" translate="no">&gt;</code><code translate="no">Start Streaming</code><code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">button</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">label</code> <code class="na" translate="no">for</code><code class="o" translate="no">=</code><code class="s" translate="no">"messageInput"</code><code class="p" translate="no">&gt;</code><code translate="no">Enter your prompt:</code><code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">label</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">input</code> <code class="na" translate="no">type</code><code class="o" translate="no">=</code><code class="s" translate="no">"text"</code> <code class="na" translate="no">id</code><code class="o" translate="no">=</code><code class="s" translate="no">"messageInput"</code> <code class="na" translate="no">placeholder</code><code class="o" translate="no">=</code><code class="s" translate="no">"Enter your prompt"</code><code class="p" translate="no">&gt;</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-1" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">div</code> <code class="na" translate="no">style</code><code class="o" translate="no">=</code><code class="s" translate="no">"padding-top: 10px"</code> <code class="na" translate="no">id</code><code class="o" translate="no">=</code><code class="s" translate="no">"responseContainer"</code><code class="p" translate="no">&gt;</code><code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">div</code><code class="p" translate="no">&gt;</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-2" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>

<code class="p" translate="no">&lt;</code><code class="nt" translate="no">script</code><code class="p" translate="no">&gt;</code>
    <code class="kd" translate="no">let</code> <code class="nx" translate="no">source</code><code class="p" translate="no">;</code>
    <code class="kd" translate="no">const</code> <code class="nx" translate="no">button</code> <code class="o" translate="no">=</code> <code class="nb" translate="no">document</code><code class="p" translate="no">.</code><code class="nx" translate="no">getElementById</code><code class="p" translate="no">(</code><code class="s1" translate="no">'streambtn'</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
    <code class="kd" translate="no">const</code> <code class="nx" translate="no">container</code> <code class="o" translate="no">=</code> <code class="nb" translate="no">document</code><code class="p" translate="no">.</code><code class="nx" translate="no">getElementById</code><code class="p" translate="no">(</code><code class="s1" translate="no">'container'</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
    <code class="kd" translate="no">const</code> <code class="nx" translate="no">input</code> <code class="o" translate="no">=</code> <code class="nb" translate="no">document</code><code class="p" translate="no">.</code><code class="nx" translate="no">getElementById</code><code class="p" translate="no">(</code><code class="s1" translate="no">'messageInput'</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>

    <code class="kd" translate="no">function</code> <code class="nx" translate="no">resetForm</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">{</code>
        <code class="nx" translate="no">input</code><code class="p" translate="no">.</code><code class="nx" translate="no">value</code> <code class="o" translate="no">=</code> <code class="s1" translate="no">''</code><code class="p" translate="no">;</code>
        <code class="nx" translate="no">container</code><code class="p" translate="no">.</code><code class="nx" translate="no">textContent</code> <code class="o" translate="no">=</code> <code class="s1" translate="no">''</code><code class="p" translate="no">;</code>
    <code class="p" translate="no">}</code>

    <code class="kd" translate="no">function</code> <code class="nx" translate="no">handleOpen</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code> <code class="p" translate="no">{</code>
        <code class="nx" translate="no">console</code><code class="p" translate="no">.</code><code class="nx" translate="no">log</code><code class="p" translate="no">(</code><code class="s1" translate="no">'Connection was opened'</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
    <code class="p" translate="no">}</code>
    <code class="kd" translate="no">function</code> <code class="nx" translate="no">handleMessage</code><code class="p" translate="no">(</code><code class="nx" translate="no">e</code><code class="p" translate="no">)</code><code class="p" translate="no">{</code>
        <code class="k" translate="no">if</code> <code class="p" translate="no">(</code><code class="nx" translate="no">e</code><code class="p" translate="no">.</code><code class="nx" translate="no">data</code> <code class="o" translate="no">===</code> <code class="s1" translate="no">'[DONE]'</code><code class="p" translate="no">)</code> <code class="p" translate="no">{</code>
            <code class="nx" translate="no">source</code><code class="p" translate="no">.</code><code class="nx" translate="no">close</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
            <code class="nx" translate="no">console</code><code class="p" translate="no">.</code><code class="nx" translate="no">log</code><code class="p" translate="no">(</code><code class="s1" translate="no">'Connection was closed'</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
            <code class="k" translate="no">return</code><code class="p" translate="no">;</code>
        <code class="p" translate="no">}</code>

        <code class="nx" translate="no">container</code><code class="p" translate="no">.</code><code class="nx" translate="no">textContent</code> <code class="o" translate="no">+=</code> <code class="nx" translate="no">e</code><code class="p" translate="no">.</code><code class="nx" translate="no">data</code><code class="p" translate="no">;</code>
    <code class="p" translate="no">}</code>
    <code class="kd" translate="no">function</code> <code class="nx" translate="no">handleClose</code><code class="p" translate="no">(</code><code class="nx" translate="no">e</code><code class="p" translate="no">)</code><code class="p" translate="no">{</code>
        <code class="nx" translate="no">console</code><code class="p" translate="no">.</code><code class="nx" translate="no">error</code><code class="p" translate="no">(</code><code class="nx" translate="no">e</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
        <code class="nx" translate="no">source</code><code class="p" translate="no">.</code><code class="nx" translate="no">close</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code>
    <code class="p" translate="no">}</code>

    <code class="nx" translate="no">button</code><code class="p" translate="no">.</code><code class="nx" translate="no">addEventListener</code><code class="p" translate="no">(</code><code class="s1" translate="no">'click'</code><code class="p" translate="no">,</code> <code class="kd" translate="no">function</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code> <code class="p" translate="no">{</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-3" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a>
        <code class="kd" translate="no">const</code> <code class="nx" translate="no">message</code> <code class="o" translate="no">=</code> <code class="nx" translate="no">input</code><code class="p" translate="no">.</code><code class="nx" translate="no">value</code><code class="p" translate="no">;</code>
        <code class="kd" translate="no">const</code> <code class="nx" translate="no">url</code> <code class="o" translate="no">=</code> <code class="s1" translate="no">'http://localhost:8000/generate/text/stream?prompt='</code> <code class="o" translate="no">+</code>
            <code class="nb" translate="no">encodeURIComponent</code><code class="p" translate="no">(</code><code class="nx" translate="no">message</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
        <code class="nx" translate="no">resetForm</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-4" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a>

        <code class="nx" translate="no">source</code> <code class="o" translate="no">=</code> <code class="ow" translate="no">new</code> <code class="nx" translate="no">EventSource</code><code class="p" translate="no">(</code><code class="nx" translate="no">url</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-5" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a>
        <code class="nx" translate="no">source</code><code class="p" translate="no">.</code><code class="nx" translate="no">addEventListener</code><code class="p" translate="no">(</code><code class="s1" translate="no">'open'</code><code class="p" translate="no">,</code> <code class="nx" translate="no">handleOpen</code><code class="p" translate="no">,</code> <code class="kc" translate="no">false</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
        <code class="nx" translate="no">source</code><code class="p" translate="no">.</code><code class="nx" translate="no">addEventListener</code><code class="p" translate="no">(</code><code class="s1" translate="no">'message'</code><code class="p" translate="no">,</code> <code class="nx" translate="no">handleMessage</code><code class="p" translate="no">,</code> <code class="kc" translate="no">false</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
        <code class="nx" translate="no">source</code><code class="p" translate="no">.</code><code class="nx" translate="no">addEventListener</code><code class="p" translate="no">(</code><code class="s1" translate="no">'error'</code><code class="p" translate="no">,</code> <code class="nx" translate="no">handleClose</code><code class="p" translate="no">,</code> <code class="kc" translate="no">false</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-6" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a>
    <code class="p" translate="no">}</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>

<code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">script</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">body</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">html</code><code class="p" translate="no">&gt;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-1" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Crea un semplice input e un pulsante HTML per avviare le richieste SSE.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-2" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Crea un contenitore vuoto da utilizzare come lavandino per il contenuto dello stream.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-3" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Ascolta il pulsante <code translate="no">clicks</code> ed esegue il callback SSE.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-4" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Ripristina il modulo del contenuto e il contenitore di risposta del contenuto precedente.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-5" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a></dt>
<dd><p>Crea un nuovo oggetto <code translate="no">EventSource</code> e ascolta i cambiamenti di stato della connessione per gestire gli eventi.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-6" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO4-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a></dt>
<dd><p>Registra nella console quando viene aperta una connessione SSE. Gestisce ogni messaggio renderizzando il contenuto del messaggio nel contenitore delle risposte fino a quando non viene ricevuto il messaggio <code translate="no">[DONE]</code>, che segnala che la connessione deve essere chiusa. Inoltre, chiude la connessione se si verificano errori e registra l'errore nella<span class="keep-together">console</span> del browser.</p></dd>
</dl></div>
<p>Con il client SSE implementato nell'<a data-type="xref" href="#sse_client">Esempio 6-4</a>, puoi ora utilizzarlo per testare il tuo endpoint SSE. Tuttavia, devi prima servire l'HTML.</p>
<p>Crea una directory <code translate="no">pages</code> e inserisci il file HTML al suo interno. Poi <em>monta</em> la directory sul tuo server FastAPI per servire il suo contenuto come file statico, come mostrato nell'<a data-type="xref" href="#mounting_static_files">Esempio 6-5</a>. Tramite il montaggio, FastAPI si occupa di mappare i percorsi API di ogni file in modo che tu possa accedervi con un browser dalla stessa origine del tuo server.</p>
<div data-type="example" id="mounting_static_files">
<h5><span class="label">Esempio 6-5. </span>Montare i file HTML sul server come risorse statiche</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># main.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">fastapi</code><code class="nn" translate="no">.</code><code class="nn" translate="no">staticfiles</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">StaticFiles</code>

<code class="n" translate="no">app</code><code class="o" translate="no">.</code><code class="n" translate="no">mount</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/pages</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="n" translate="no">StaticFiles</code><code class="p" translate="no">(</code><code class="n" translate="no">directory</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">pages</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code> <code class="n" translate="no">name</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">pages</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO5-1" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO5-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO5-1" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO5-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Monta la cartella <code translate="no">pages</code> su <code translate="no">/pages</code> per servire i suoi contenuti come risorse statiche. Una volta montata, puoi accedere a ogni file visitando<code translate="no"><em>&lt;origin&gt;</em>/pages/<em>&lt;filename&gt;</em></code>.</p></dd>
</dl></div>
<p>Implementando l'<a data-type="xref" href="#mounting_static_files">Esempio 6-5</a>, servirai l'HTML dalla stessa origine del tuo server API, evitando così di attivare il meccanismo di sicurezza CORS del browser, che può bloccare le richieste in uscita che raggiungono il tuo server.</p>
<p>Ora puoi accedere alla pagina HTML visitando il sito<code translate="no">http://localhost:8000/pages/sse-client.html</code>.</p>
<section data-pdf-bookmark="Cross-origin resource sharing" data-type="sect3"><div class="sect3" id="id96">
<h3>Condivisione di risorse tra origini diverse</h3>
<p><a data-primary="cross-origin resource sharing (CORS)" data-type="indexterm" id="ix_ch06-asciidoc18"/><a data-primary="CORS (cross-origin resource sharing)" data-type="indexterm" id="ix_ch06-asciidoc18a"/>Se provi ad aprire direttamente il file HTML dell'<a data-type="xref" href="#sse_client">Esempio 6-4</a> nel tuo browser e clicchi sul pulsante Avvia streaming, noterai che non succede nulla. Puoi controllare la scheda di rete del browser per vedere cosa è successo alle richieste in uscita.</p>
<p>Dopo alcune indagini, dovresti notare che il tuo browser ha bloccato le richieste in uscita verso il tuo server perché i suoi controlli preliminari di<em>condivisione delle risorse in origine</em> (CORS) con il tuo server sono falliti.</p>
<p>CORS è un meccanismo di sicurezza implementato nei browser per controllare il modo in cui le risorse di una pagina web possono essere richieste da un altro dominio ed è rilevante solo quando si inviano richieste direttamente dal browser invece che da un server. I browser utilizzano CORS per verificare se sono autorizzati a inviare richieste al server da un'origine (cioè un dominio) diversa da quella del server.</p>
<p>Ad esempio, se il tuo client è ospitato su <code translate="no">https://example.com</code> e deve recuperare dati da un'API ospitata su <code translate="no">https://api.example.com</code>, il browser bloccherà la richiesta a meno che il server API non abbia abilitato CORS.</p>
<p>Per il momento, puoi aggirare questi errori CORS aggiungendo un middleware CORS sul tuo server, come puoi vedere nell'<a data-type="xref" href="#cors">Esempio 6-6</a>, per consentire qualsiasi richiesta in arrivo dai browser.</p>
<div data-type="example" id="cors">
<h5><span class="label">Esempio 6-6. </span>Applicare le impostazioni CORS</h5>
<pre data-type="programlisting" translate="no"># main.py

from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"], <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO6-1" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO6-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
)</pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO6-1" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO6-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Consente le richieste in arrivo da qualsiasi origine, metodo (<code translate="no">GET</code>, <code translate="no">POST</code>, ecc.) e<span class="keep-together">intestazione.</span></p></dd>
</dl></div>
<p>Streamlit evita di attivare il meccanismo CORS inviando le richieste sul suo server interno anche se l'interfaccia utente generata viene eseguita sul browser.</p>
<p>D'altra parte, la pagina di documentazione di FastAPI effettua le richieste dalla stessa origine del server (cioè <code translate="no">http://localhost:8000</code>), quindi le richieste per impostazione predefinita non attivano il<span class="keep-together">meccanismo di</span> sicurezza CORS.</p>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>Nell'<a data-type="xref" href="#cors">Esempio 6-6</a>, configuri il middleware CORS per elaborare qualsiasi richiesta in arrivo, aggirando di fatto il meccanismo di sicurezza CORS per facilitare lo sviluppo. In produzione, dovresti consentire al tuo server di elaborare solo una manciata di origini, metodi e intestazioni.<a data-startref="ix_ch06-asciidoc18" data-type="indexterm" id="id907"/><a data-startref="ix_ch06-asciidoc18a" data-type="indexterm" id="id908"/></p>
</div>
<p>Se hai seguito l'esempio <a data-type="xref" data-xrefstyle="select:labelnumber" href="#mounting_static_files">6-5</a> o <a data-type="xref" data-xrefstyle="select:labelnumber" href="#cors">6-6</a>, ora dovresti essere in grado di visualizzare il flusso in arrivo dal tuo endpoint SSE (vedi <a data-type="xref" href="#sse_results">Figura 6-8</a>).</p>
<figure><div class="figure" id="sse_results">
<img alt="bgai 0608" src="assets/bgai_0608.png" width="3012" height="1632"/>
<h6><span class="label">Figura 6-8. </span>Flusso in entrata dall'endpoint SSE</h6>
</div></figure>
<p>Congratulazioni! Ora hai una soluzione perfettamente funzionante in cui le risposte del modello vengono trasmesse direttamente al tuo cliente non appena i dati generati sono disponibili. Grazie all'implementazione di questa funzione, i tuoi utenti avranno un'esperienza più piacevole nell'interazione con il tuo chatbot, poiché riceveranno le risposte alle loro query in tempo reale.</p>
<p>La tua soluzione ha anche implementato la concurrency utilizzando un client asincrono per interagire con l'API OpenAI di Azure per trasmettere risposte più veloci ai tuoi utenti. Puoi provare a utilizzare un client sincrono per confrontare le differenze nella velocità di generazione. Con un client asincrono, la velocità di generazione può essere così elevata che riceverai un blocco di testo in una sola volta anche se in realtà viene trasmesso al browser.</p>
</div></section>
<section data-pdf-bookmark="Streaming LLM outputs from Hugging Face models" data-type="sect3"><div class="sect3" id="id97">
<h3>Streaming dei risultati LLM dei modelli Hugging Face</h3>
<p><a data-primary="Hugging Face models, streaming LLM outputs from" data-type="indexterm" id="ix_ch06-asciidoc19"/><a data-primary="large language models (LLMs)" data-secondary="streaming LLM outputs from Hugging Face models" data-type="indexterm" id="ix_ch06-asciidoc20"/>Ora che hai imparato a implementare gli endpoint SSE con i provider di modelli come Azure OpenAI, ti starai chiedendo se puoi trasmettere gli output dei modelli open source che hai precedentemente scaricato da Hugging Face.</p>
<p>Sebbene la libreria <code translate="no">transformers</code> di Hugging Face implementi un componente <code translate="no">TextStreamer</code>che puoi passare alla tua pipeline di modelli, la soluzione più semplice è quella di eseguire un server di inferenza separato come HF Inference Server per implementare lo streaming dei modelli.</p>
<p>L<a data-type="xref" href="#hf_llm_inference_server">'esempio 6-7</a> mostra come configurare un semplice server di inferenza di modelli utilizzando Docker, fornendo un sito <code translate="no">model-id</code>.</p>
<div data-type="example" id="hf_llm_inference_server">
<h5><span class="label">Esempio 6-7. </span>Servire i modelli HF LLM tramite il server di inferenza HF</h5>
<pre data-code-language="bash" data-type="programlisting" translate="no"><code translate="no">$</code> <code translate="no">docker</code> <code translate="no">run</code> <code translate="no">--runtime</code> <code translate="no">nvidia</code> <code translate="no">--gpus</code> <code translate="no">all</code> <code class="se" translate="no">\ </code><a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-1" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
    <code translate="no">-v</code> <code translate="no">~/.cache/huggingface:/root/.cache/huggingface</code> <code class="se" translate="no">\ </code><a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-2" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
    <code translate="no">--env</code> <code class="s2" translate="no">"HUGGING_FACE_HUB_TOKEN=&lt;secret&gt;"</code> <code class="se" translate="no">\ </code><a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-3" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a>
    <code translate="no">-p</code> <code class="m" translate="no">8080</code><code translate="no">:8000</code> <code class="se" translate="no">\ </code><a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-4" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a>
    <code translate="no">--ipc</code><code class="o" translate="no">=</code><code translate="no">host</code> <code class="se" translate="no">\ </code><a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-5" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a>
    <code translate="no">vllm/vllm-openai:latest</code> <code class="se" translate="no">\ </code><a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-1" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-6"><img alt="1" src="assets/1.png" width="12" height="12"/></a> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-6" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-7"><img alt="6" src="assets/6.png" width="12" height="12"/></a>
    <code translate="no">--model</code> <code translate="no">mistralai/Mistral-7B-v0.1</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-7" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-8"><img alt="7" src="assets/7.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-1" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Usa Docker per scaricare ed eseguire il container <code translate="no">vllm/vllm-openai</code> più recente su tutte le GPU NVIDIA disponibili.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-2" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Condividi un volume con il contenitore Docker per evitare di scaricare pesi a ogni esecuzione.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-3" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Imposta la variabile d'ambiente secret per accedere a modelli con accesso limitato come <code translate="no">mistralai/Mistral-7B-v0.1</code>.<sup><a data-type="noteref" href="ch06.html#id909" id="id909-marker" translate="no">4</a></sup></p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-4" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Esegui il server di inferenza sulla porta localhost <code translate="no">8080</code> mappando la porta dell'host <code translate="no">8080</code> sulla porta esposta del contenitore Docker <code translate="no">8000</code>.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-5" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a></dt>
<dd><p>Abilita la comunicazione inter-processo (IPC) tra il contenitore e l'host per consentire al contenitore di accedere alla memoria condivisa dell'host.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-7" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a></dt>
<dd><p>Il server di inferenza vLLM utilizza le specifiche API OpenAI per il servizio LLM.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-8" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO7-7"><img alt="7" src="assets/7.png" width="12" height="12"/></a></dt>
<dd><p>Scarica e utilizza il sito <code translate="no">mistralai/Mistral-7B-v0.1</code> di Hugging Face Hub.</p></dd>
</dl></div>
<p>Con il server del modello in esecuzione, puoi ora utilizzare un sito <code translate="no">AsyncInferenceClient</code> per generare output in formato streaming, come mostrato nell'<a data-type="xref" href="#hf_llm_streaming">Esempio 6-8</a>.</p>
<div data-type="example" id="hf_llm_streaming">
<h5><span class="label">Esempio 6-8. </span>Consumo del flusso di output LLM dal flusso di inferenza HF</h5>
<pre data-type="programlisting" translate="no">import asyncio
from typing import AsyncGenerator
from huggingface_hub import AsyncInferenceClient

client = AsyncInferenceClient("http://localhost:8080")

async def chat_stream(prompt: str) -&gt; AsyncGenerator[str, None]:
    stream = await client.text_generation(prompt, stream=True)
    async for token in stream:
        yield token
        await asyncio.sleep(0.05)</pre></div>
<p>Sebbene <a data-type="xref" href="#hf_llm_streaming">l'Esempio 6-8</a> mostri come utilizzare il server di inferenza Hugging Face, puoi comunque utilizzare altri framework di model-serving come <a href="https://oreil.ly/LQAzF">vLLM</a> che supportano lo streaming delle risposte del modello.<a data-startref="ix_ch06-asciidoc20" data-type="indexterm" id="id910"/><a data-startref="ix_ch06-asciidoc19" data-type="indexterm" id="id911"/></p>
<p>Prima di passare a parlare di WebSocket, vediamo come consumare un'altra variante di endpoint SSE utilizzando il metodo <code translate="no">POST</code>.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="SSE with POST Request" data-type="sect2"><div class="sect2" id="id98">
<h2>SSE con richiesta POST</h2>
<p><a data-primary="POST request, SSE with" data-type="indexterm" id="ix_ch06-asciidoc21"/><a data-primary="Server Sent Events (SSE)" data-secondary="with POST request" data-type="indexterm" id="ix_ch06-asciidoc22"/>La <a href="https://oreil.ly/61ovi">specifica<code translate="no">EventSource</code> </a> prevede che gli endpoint di <code translate="no">GET</code> sul server consumino correttamente il flusso SSE in entrata. Questo rende semplice l'implementazione di applicazioni in tempo reale con SSE, poiché l'interfaccia<code translate="no">EventSource</code> è in grado di gestire problemi come la caduta della connessione e la riconnessione automatica.</p>
<p>Tuttavia, l'utilizzo delle richieste HTTP <code translate="no">GET</code> comporta delle limitazioni: le richieste<code translate="no">GET</code> sono normalmente meno sicure rispetto agli altri metodi di richiesta e più vulnerabili agli attacchi <em>XSS</em>.<sup><a data-type="noteref" href="ch06.html#id912" id="id912-marker" translate="no">5</a></sup>
Inoltre, poiché le richieste <code translate="no">GET</code> non possono avere un corpo della richiesta, puoi trasferire i dati solo come parte dei parametri di query dell'URL al server. Il problema è che c'è un limite di lunghezza dell'URL che devi considerare e tutti i parametri di query devono essere codificati correttamente nell'URL della richiesta. Pertanto, non puoi semplicemente aggiungere l'intera cronologia della conversazione all'URL come parametro. Il tuo server deve gestire la cronologia della conversazione e tenere traccia del contesto della conversazione con gli<span class="keep-together">endpoint</span> SSE di <code translate="no">GET</code> <span class="keep-together">.</span></p>
<p>Una soluzione comune a questa limitazione consiste nell'implementare un endpoint SSE <code translate="no">POST</code> anche se la specifica SSE non lo supporta. Di conseguenza, l'implementazione sarà più complessa.</p>
<p>Per prima cosa, implementiamo l'endpoint <code translate="no">POST</code> sul server nell'<a data-type="xref" href="#sse_server_post">Esempio 6-9</a>.</p>
<div data-type="example" id="sse_server_post">
<h5><span class="label">Esempio 6-9. </span>Implementazione dell'endpoint SSE sul server</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># main.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">typing</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Annotated</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">fastapi</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Body</code><code class="p" translate="no">,</code> <code class="n" translate="no">FastAPI</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">fastapi.responses</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">StreamingResponse</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">stream</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">azure_chat_client</code>

<code class="nd" translate="no">@app</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code><code class="s2" translate="no">"/generate/text/stream"</code><code class="p" translate="no">)</code>
<code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">serve_text_to_text_stream_controller</code><code class="p" translate="no">(</code>
    <code class="n" translate="no">prompt</code><code class="p" translate="no">:</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code> <code class="n" translate="no">Body</code><code class="p" translate="no">()]</code>
<code class="p" translate="no">)</code> <code class="o" translate="no">-&gt;</code> <code class="n" translate="no">StreamingResponse</code><code class="p" translate="no">:</code>
    <code class="k" translate="no">return</code> <code class="n" translate="no">StreamingResponse</code><code class="p" translate="no">(</code>
        <code class="n" translate="no">azure_chat_client</code><code class="o" translate="no">.</code><code class="n" translate="no">chat_stream</code><code class="p" translate="no">(</code><code class="n" translate="no">prompt</code><code class="p" translate="no">),</code> <code class="n" translate="no">media_type</code><code class="o" translate="no">=</code><code class="s2" translate="no">"text/event-stream"</code>
    <code class="p" translate="no">)</code></pre></div>
<p>Con l'implementazione dell'endpoint <code translate="no">POST</code> per lo streaming degli output della chat, puoi ora sviluppare la logica del client per elaborare lo stream SSE.</p>
<p>Dovrai elaborare manualmente lo streaming in arrivo utilizzando l'interfaccia web <code translate="no">fetch</code> del browser, come mostrato nell'<a data-type="xref" href="#sse_client_post">Esempio 6-10</a>.</p>
<div data-type="example" id="sse_client_post">
<h5><span class="label">Esempio 6-10. </span>Implementazione di SSE sul client utilizzando l'API del browser <code translate="no">EventSource</code> </h5>
<pre data-code-language="html" data-type="programlisting" translate="no"><code translate="no">{# pages/client-sse-post.html #}

</code><code class="cp" translate="no">&lt;!DOCTYPE html&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">html</code> <code class="na" translate="no">lang</code><code class="o" translate="no">=</code><code class="s" translate="no">"en"</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">head</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">title</code><code class="p" translate="no">&gt;</code><code translate="no">SSE With Post Request</code><code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">title</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">head</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">body</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">button</code> <code class="na" translate="no">id</code><code class="o" translate="no">=</code><code class="s" translate="no">"streambtn"</code><code class="p" translate="no">&gt;</code><code translate="no">Start Streaming</code><code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">button</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">label</code> <code class="na" translate="no">for</code><code class="o" translate="no">=</code><code class="s" translate="no">"messageInput"</code><code class="p" translate="no">&gt;</code><code translate="no">Enter your prompt:</code><code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">label</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">input</code> <code class="na" translate="no">type</code><code class="o" translate="no">=</code><code class="s" translate="no">"text"</code> <code class="na" translate="no">id</code><code class="o" translate="no">=</code><code class="s" translate="no">"messageInput"</code> <code class="na" translate="no">placeholder</code><code class="o" translate="no">=</code><code class="s" translate="no">"Enter message"</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">div</code> <code class="na" translate="no">style</code><code class="o" translate="no">=</code><code class="s" translate="no">"padding-top: 10px"</code> <code class="na" translate="no">id</code><code class="o" translate="no">=</code><code class="s" translate="no">"container"</code><code class="p" translate="no">&gt;</code><code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">div</code><code class="p" translate="no">&gt;</code>

<code class="p" translate="no">&lt;</code><code class="nt" translate="no">script</code><code class="p" translate="no">&gt;</code>
    <code class="kd" translate="no">const</code> <code class="nx" translate="no">button</code> <code class="o" translate="no">=</code> <code class="nb" translate="no">document</code><code class="p" translate="no">.</code><code class="nx" translate="no">getElementById</code><code class="p" translate="no">(</code><code class="s1" translate="no">'streambtn'</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
    <code class="kd" translate="no">const</code> <code class="nx" translate="no">container</code> <code class="o" translate="no">=</code> <code class="nb" translate="no">document</code><code class="p" translate="no">.</code><code class="nx" translate="no">getElementById</code><code class="p" translate="no">(</code><code class="s1" translate="no">'container'</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
    <code class="kd" translate="no">const</code> <code class="nx" translate="no">input</code> <code class="o" translate="no">=</code> <code class="nb" translate="no">document</code><code class="p" translate="no">.</code><code class="nx" translate="no">getElementById</code><code class="p" translate="no">(</code><code class="s1" translate="no">'messageInput'</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>

    <code class="kd" translate="no">function</code> <code class="nx" translate="no">resetForm</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">{</code>
        <code class="nx" translate="no">input</code><code class="p" translate="no">.</code><code class="nx" translate="no">value</code> <code class="o" translate="no">=</code> <code class="s1" translate="no">''</code><code class="p" translate="no">;</code>
        <code class="nx" translate="no">container</code><code class="p" translate="no">.</code><code class="nx" translate="no">textContent</code> <code class="o" translate="no">=</code> <code class="s1" translate="no">''</code><code class="p" translate="no">;</code>
    <code class="p" translate="no">}</code>

    <code class="k" translate="no">async</code> <code class="kd" translate="no">function</code> <code class="nx" translate="no">stream</code><code class="p" translate="no">(</code><code class="nx" translate="no">message</code><code class="p" translate="no">)</code><code class="p" translate="no">{</code>
        <code class="kd" translate="no">const</code> <code class="nx" translate="no">response</code> <code class="o" translate="no">=</code> <code class="k" translate="no">await</code> <code class="nx" translate="no">fetch</code><code class="p" translate="no">(</code><code class="s1" translate="no">'http://localhost:8000/generate/text/stream'</code><code class="p" translate="no">,</code> <code class="p" translate="no">{</code>
            <code class="nx" translate="no">method</code><code class="o" translate="no">:</code> <code class="s2" translate="no">"POST"</code><code class="p" translate="no">,</code>
            <code class="nx" translate="no">cache</code><code class="o" translate="no">:</code> <code class="s2" translate="no">"no-cache"</code><code class="p" translate="no">,</code>
            <code class="nx" translate="no">keepalive</code><code class="o" translate="no">:</code> <code class="kc" translate="no">true</code><code class="p" translate="no">,</code>
            <code class="nx" translate="no">headers</code><code class="o" translate="no">:</code> <code class="p" translate="no">{</code>
                <code class="s2" translate="no">"Content-Type"</code><code class="o" translate="no">:</code> <code class="s2" translate="no">"application/json"</code><code class="p" translate="no">,</code>
                <code class="s2" translate="no">"Accept"</code><code class="o" translate="no">:</code> <code class="s2" translate="no">"text/event-stream"</code><code class="p" translate="no">,</code>
            <code class="p" translate="no">}</code><code class="p" translate="no">,</code>
            <code class="nx" translate="no">body</code><code class="o" translate="no">:</code> <code class="nb" translate="no">JSON</code><code class="p" translate="no">.</code><code class="nx" translate="no">stringify</code><code class="p" translate="no">(</code><code class="p" translate="no">{</code>
                <code class="nx" translate="no">prompt</code><code class="o" translate="no">:</code> <code class="nx" translate="no">message</code><code class="p" translate="no">,</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO8-1" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO8-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
            <code class="p" translate="no">}</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code>
        <code class="p" translate="no">}</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>

        <code class="kd" translate="no">const</code> <code class="nx" translate="no">reader</code> <code class="o" translate="no">=</code> <code class="nx" translate="no">response</code><code class="p" translate="no">.</code><code class="nx" translate="no">body</code><code class="p" translate="no">.</code><code class="nx" translate="no">getReader</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO8-2" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO8-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
        <code class="kd" translate="no">const</code> <code class="nx" translate="no">decoder</code> <code class="o" translate="no">=</code> <code class="ow" translate="no">new</code> <code class="nx" translate="no">TextDecoder</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO8-3" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO8-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a>

        <code class="k" translate="no">while</code> <code class="p" translate="no">(</code><code class="kc" translate="no">true</code><code class="p" translate="no">)</code> <code class="p" translate="no">{</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO8-4" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO8-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a>
            <code class="kd" translate="no">const</code> <code class="p" translate="no">{</code><code class="nx" translate="no">value</code><code class="p" translate="no">,</code> <code class="nx" translate="no">done</code><code class="p" translate="no">}</code> <code class="o" translate="no">=</code> <code class="k" translate="no">await</code> <code class="nx" translate="no">reader</code><code class="p" translate="no">.</code><code class="nx" translate="no">read</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
            <code class="k" translate="no">if</code> <code class="p" translate="no">(</code><code class="nx" translate="no">done</code><code class="p" translate="no">)</code> <code class="k" translate="no">break</code><code class="p" translate="no">;</code>
            <code class="nx" translate="no">container</code><code class="p" translate="no">.</code><code class="nx" translate="no">textContent</code> <code class="o" translate="no">+=</code> <code class="nx" translate="no">decoder</code><code class="p" translate="no">.</code><code class="nx" translate="no">decode</code><code class="p" translate="no">(</code><code class="nx" translate="no">value</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
        <code class="p" translate="no">}</code>
    <code class="p" translate="no">}</code>

    <code class="nx" translate="no">button</code><code class="p" translate="no">.</code><code class="nx" translate="no">addEventListener</code><code class="p" translate="no">(</code><code class="s1" translate="no">'click'</code><code class="p" translate="no">,</code> <code class="k" translate="no">async</code> <code class="kd" translate="no">function</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code> <code class="p" translate="no">{</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO8-5" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO8-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a>
        <code class="nx" translate="no">resetForm</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code>
        <code class="k" translate="no">await</code> <code class="nx" translate="no">stream</code><code class="p" translate="no">(</code><code class="nx" translate="no">input</code><code class="p" translate="no">.</code><code class="nx" translate="no">value</code><code class="p" translate="no">)</code>

    <code class="p" translate="no">}</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>

<code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">script</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">body</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">html</code><code class="p" translate="no">&gt;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO8-1" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO8-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Invia una richiesta <code translate="no">POST</code> al backend utilizzando l'interfaccia <code translate="no">fetch</code> del browser. Prepara il corpo come stringa JSON come parte della richiesta. Aggiungi le intestazioni per specificare il corpo della richiesta inviata e la risposta attesa dal server.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO8-2" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO8-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Accede a <code translate="no">reader</code> del flusso dal flusso del corpo della risposta.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO8-3" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO8-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Crea un'istanza di decodificatore di testo per elaborare ogni messaggio.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO8-4" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO8-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Esegue un ciclo infinito e legge il messaggio successivo nel flusso utilizzando<code translate="no">reader</code>. Se il flusso è terminato, <code translate="no">done=true</code>, quindi interrompe il ciclo; altrimenti, decodifica il messaggio con il decodificatore di testo e lo aggiunge al contenitore delle risposte<code translate="no">textContent</code> per eseguire il rendering.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO8-5" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO8-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a></dt>
<dd><p>Ascolta gli eventi del pulsante <code translate="no">click</code> per eseguire un callback che ripristina lo stato del modulo ed effettua la connessione SSE con l'endpoint del backend con un prompt.</p></dd>
</dl></div>
<p>Come si può vedere dall'<a data-type="xref" href="#sse_client_post">Esempio 6-10</a>, consumare il flusso SSE senza il parametro<span class="keep-together"><code translate="no">EventSource</code></span> può diventare complesso.</p>
<div data-type="tip"><h6>Suggerimento</h6>
<p>Un'alternativa all'<a data-type="xref" href="#sse_client_post">Esempio 6-10</a> è quella di utilizzare gli endpoint SSE di <code translate="no">GET</code> ma di inviare preventivamente il payload di grandi dimensioni al server tramite una richiesta <code translate="no">POST</code>. Il server memorizza i dati e li utilizza quando viene stabilita la connessione SSE.</p>
<p>SSE supporta anche i cookie, quindi puoi affidarti ai cookie per scambiare payload di grandi dimensioni negli endpoint di <code translate="no">GET</code> SSE.</p>
</div>
<p>Se vuoi utilizzare l'endpoint SSE in produzione, la tua soluzione deve supportare anche la funzionalità di retry, la gestione degli errori o addirittura la possibilità di interrompere le connessioni.</p>
<p><a data-primary="exponential backoff" data-type="indexterm" id="id913"/>L<a data-type="xref" href="#sse_retry">'esempio 6-11</a> mostra come implementare in JavaScript una funzionalità di ritentativo lato client con un <em>ritardo di backoff esponenziale</em>.<sup><a data-type="noteref" href="ch06.html#id914" id="id914-marker" translate="no">6</a></sup></p>
<div data-type="example" id="sse_retry">
<h5><span class="label">Esempio 6-11. </span>Implementazione della funzionalità di retry lato client con backoff esponenziale</h5>
<pre data-code-language="javascript" data-type="programlisting" translate="no"><code class="c1" translate="no">// pages/client-sse-post.html within &lt;script&gt; tag
</code>
<code class="kd" translate="no">function</code> <code class="nx" translate="no">sleep</code><code class="p" translate="no">(</code><code class="nx" translate="no">ms</code><code class="p" translate="no">)</code> <code class="p" translate="no">{</code>
    <code class="k" translate="no">return</code> <code class="k" translate="no">new</code> <code class="nb" translate="no">Promise</code><code class="p" translate="no">(</code><code class="nx" translate="no">resolve</code> <code class="o" translate="no">=&gt;</code> <code class="nx" translate="no">setTimeout</code><code class="p" translate="no">(</code><code class="nx" translate="no">resolve</code><code class="p" translate="no">,</code> <code class="nx" translate="no">ms</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
<code class="p" translate="no">}</code>

<code class="nx" translate="no">async</code> <code class="kd" translate="no">function</code> <code class="nx" translate="no">stream</code><code class="p" translate="no">(</code>
    <code class="nx" translate="no">message</code><code class="p" translate="no">,</code>
    <code class="nx" translate="no">maxRetries</code> <code class="o" translate="no">=</code> <code class="mi" translate="no">3</code><code class="p" translate="no">,</code>
    <code class="nx" translate="no">initialDelay</code> <code class="o" translate="no">=</code> <code class="mi" translate="no">1000</code><code class="p" translate="no">,</code>
    <code class="nx" translate="no">backoffFactor</code> <code class="o" translate="no">=</code> <code class="mi" translate="no">2</code><code class="p" translate="no">,</code>
<code class="p" translate="no">)</code> <code class="p" translate="no">{</code>
    <code class="kd" translate="no">let</code> <code class="nx" translate="no">delay</code> <code class="o" translate="no">=</code> <code class="nx" translate="no">initialDelay</code><code class="p" translate="no">;</code>
    <code class="k" translate="no">for</code> <code class="p" translate="no">(</code><code class="kd" translate="no">let</code> <code class="nx" translate="no">attempt</code> <code class="o" translate="no">=</code> <code class="mi" translate="no">0</code><code class="p" translate="no">;</code> <code class="nx" translate="no">attempt</code> <code class="o" translate="no">&lt;</code> <code class="nx" translate="no">maxRetries</code><code class="p" translate="no">;</code> <code class="nx" translate="no">attempt</code><code class="o" translate="no">++</code><code class="p" translate="no">)</code> <code class="p" translate="no">{</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-1" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
        <code class="k" translate="no">try</code> <code class="p" translate="no">{</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-2" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
            <code class="p" translate="no">...</code> <code class="c1" translate="no">// Establish SSE connection here
</code>            <code class="k" translate="no">return</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-3" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a>
        <code class="p" translate="no">}</code> <code class="k" translate="no">catch</code> <code class="p" translate="no">(</code><code class="nx" translate="no">error</code><code class="p" translate="no">)</code> <code class="p" translate="no">{</code>
            <code class="nx" translate="no">console</code><code class="p" translate="no">.</code><code class="nx" translate="no">warn</code><code class="p" translate="no">(</code><code class="sb" translate="no">`</code><code class="sb" translate="no">Failed to establish SSE connection: </code><code class="si" translate="no">${</code><code class="nx" translate="no">error</code><code class="si" translate="no">}</code><code class="sb" translate="no">`</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
            <code class="nx" translate="no">console</code><code class="p" translate="no">.</code><code class="nx" translate="no">log</code><code class="p" translate="no">(</code>
                <code class="sb" translate="no">`</code><code class="sb" translate="no">Re-establishing connection - attempt number </code><code class="si" translate="no">${</code><code class="nx" translate="no">attempt</code> <code class="o" translate="no">+</code> <code class="mi" translate="no">1</code><code class="si" translate="no">}</code><code class="sb" translate="no">`</code><code class="p" translate="no">,</code>
            <code class="p" translate="no">)</code><code class="p" translate="no">;</code>
            <code class="k" translate="no">if</code> <code class="p" translate="no">(</code><code class="nx" translate="no">attempt</code> <code class="o" translate="no">&lt;</code> <code class="nx" translate="no">maxRetries</code> <code class="o" translate="no">-</code> <code class="mi" translate="no">1</code><code class="p" translate="no">)</code> <code class="p" translate="no">{</code>
                <code class="nx" translate="no">await</code> <code class="nx" translate="no">sleep</code><code class="p" translate="no">(</code><code class="nx" translate="no">delay</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-4" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a>
                <code class="nx" translate="no">delay</code> <code class="o" translate="no">*=</code> <code class="nx" translate="no">backoffFactor</code><code class="p" translate="no">;</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-5" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a>
            <code class="p" translate="no">}</code> <code class="k" translate="no">else</code> <code class="p" translate="no">{</code>
                <code class="k" translate="no">throw</code> <code class="nx" translate="no">error</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-6" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a>
            <code class="p" translate="no">}</code>
        <code class="p" translate="no">}</code>
    <code class="p" translate="no">}</code>
<code class="p" translate="no">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-1" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Finché <code translate="no">maxRetries</code> non viene raggiunto, prova a stabilire la connessione SSE. Conta ogni tentativo.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-2" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Utilizza <code translate="no">try</code> e <code translate="no">catch</code> per gestire gli errori di connessione.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-3" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Esce dalla funzione in caso di successo.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-4" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Pausa in <code translate="no">delay</code> millisecondi prima di riprovare.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-5" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a></dt>
<dd><p>Implementa il backoff esponenziale moltiplicando un fattore di backoff al valore del ritardo in ogni iterazione.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-6" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO9-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a></dt>
<dd><p>Lancia <code translate="no">error</code> se viene raggiunto <code translate="no">maxRetries</code>.</p></dd>
</dl></div>
<p>Ora dovresti sentirti più a tuo agio nell'implementare i tuoi endpoint SSE per lo streaming delle risposte del modello. SSE è il meccanismo di comunicazione che applicazioni come ChatGPT utilizzano per le conversazioni in tempo reale con il modello. Poiché SSE supporta prevalentemente flussi basati sul testo, è ideale per gli scenari di streaming dell'output di LLM.<a data-startref="ix_ch06-asciidoc22" data-type="indexterm" id="id915"/><a data-startref="ix_ch06-asciidoc21" data-type="indexterm" id="id916"/></p>
<p>Nella prossima sezione, implementeremo la stessa soluzione utilizzando il meccanismo WebSocket, in modo da poter confrontare le differenze nei dettagli dell'implementazione. Inoltre, imparerai cosa rende WebSocket ideale per gli scenari che richiedono una comunicazione duplex in tempo reale, come nei servizi di trascrizione dal vivo.<a data-startref="ix_ch06-asciidoc17" data-type="indexterm" id="id917"/><a data-startref="ix_ch06-asciidoc16" data-type="indexterm" id="id918"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Implementing WS Endpoints" data-type="sect1"><div class="sect1" id="id249">
<h1>Implementare gli endpoint WS</h1>
<p><a data-primary="real-time communication with generative models" data-secondary="implementing WS endpoints" data-type="indexterm" id="ix_ch06-asciidoc23"/><a data-primary="WebSocket (WS)" data-secondary="implementing endpoints with WS protocol" data-type="indexterm" id="ix_ch06-asciidoc24"/>In questa sezione, implementerai un endpoint utilizzando il protocollo WebSocket. Con questo endpoint, trasmetterai gli output di LLM al client utilizzando WebSocket per confrontarli con la connessione SSE. Alla fine, imparerai le differenze e le somiglianze tra SSE e WebSocket nello streaming degli output di LLM in tempo reale.</p>
<section data-pdf-bookmark="Streaming LLM Outputs with WebSocket" data-type="sect2"><div class="sect2" id="id99">
<h2>Streaming degli output di LLM con WebSocket</h2>
<p><a data-primary="real-time communication with generative models" data-secondary="implementing WS endpoints" data-tertiary="streaming LLM outputs with WS" data-type="indexterm" id="ix_ch06-asciidoc25"/><a data-primary="WebSocket (WS)" data-secondary="implementing endpoints with WS protocol" data-tertiary="streaming LLM outputs with WS" data-type="indexterm" id="ix_ch06-asciidoc26"/>FastAPI supporta WebSocket attraverso l'uso dell'interfaccia <code translate="no">WebSocket</code> del framework web Starlette. Poiché le connessioni WebSocket devono essere gestite, iniziamo con l'implementazione di un gestore di connessioni per tenere traccia delle connessioni attive e gestire i loro stati.</p>
<p><a data-primary="WebSocket (WS)" data-secondary="connection manager" data-type="indexterm" id="id919"/>Puoi implementare un gestore di connessioni WebSocket seguendo l'<a data-type="xref" href="#websockets_manager">Esempio 6-12</a>.</p>
<div data-type="example" id="websockets_manager">
<h5><span class="label">Esempio 6-12. </span>Implementazione di un gestore di connessioni WebSocket</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># stream.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">fastapi</code><code class="nn" translate="no">.</code><code class="nn" translate="no">websockets</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">WebSocket</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">WSConnectionManager</code><code class="p" translate="no">:</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-1" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
    <code class="k" translate="no">def</code> <code class="fm" translate="no">__init__</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">)</code> <code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code> <code class="kc" translate="no">None</code><code class="p" translate="no">:</code>
        <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">active_connections</code><code class="p" translate="no">:</code> <code class="nb" translate="no">list</code><code class="p" translate="no">[</code><code class="n" translate="no">WebSocket</code><code class="p" translate="no">]</code> <code class="o" translate="no">=</code> <code class="p" translate="no">[</code><code class="p" translate="no">]</code>

    <code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">connect</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code> <code class="n" translate="no">websocket</code><code class="p" translate="no">:</code> <code class="n" translate="no">WebSocket</code><code class="p" translate="no">)</code> <code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code> <code class="kc" translate="no">None</code><code class="p" translate="no">:</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-2" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
        <code class="k" translate="no">await</code> <code class="n" translate="no">websocket</code><code class="o" translate="no">.</code><code class="n" translate="no">accept</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code>
        <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">active_connections</code><code class="o" translate="no">.</code><code class="n" translate="no">append</code><code class="p" translate="no">(</code><code class="n" translate="no">websocket</code><code class="p" translate="no">)</code>

    <code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">disconnect</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code> <code class="n" translate="no">websocket</code><code class="p" translate="no">:</code> <code class="n" translate="no">WebSocket</code><code class="p" translate="no">)</code> <code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code> <code class="kc" translate="no">None</code><code class="p" translate="no">:</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-3" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a>
        <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">active_connections</code><code class="o" translate="no">.</code><code class="n" translate="no">remove</code><code class="p" translate="no">(</code><code class="n" translate="no">websocket</code><code class="p" translate="no">)</code>
        <code class="k" translate="no">await</code> <code class="n" translate="no">websocket</code><code class="o" translate="no">.</code><code class="n" translate="no">close</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code>

    <code class="nd" translate="no">@staticmethod</code>
    <code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">receive</code><code class="p" translate="no">(</code><code class="n" translate="no">websocket</code><code class="p" translate="no">:</code> <code class="n" translate="no">WebSocket</code><code class="p" translate="no">)</code> <code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code> <code class="nb" translate="no">str</code><code class="p" translate="no">:</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-4" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a>
        <code class="k" translate="no">return</code> <code class="k" translate="no">await</code> <code class="n" translate="no">websocket</code><code class="o" translate="no">.</code><code class="n" translate="no">receive_text</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code>

    <code class="nd" translate="no">@staticmethod</code>
    <code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">send</code><code class="p" translate="no">(</code>
        <code class="n" translate="no">message</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code> <code class="o" translate="no">|</code> <code class="nb" translate="no">bytes</code> <code class="o" translate="no">|</code> <code class="nb" translate="no">list</code> <code class="o" translate="no">|</code> <code class="nb" translate="no">dict</code><code class="p" translate="no">,</code> <code class="n" translate="no">websocket</code><code class="p" translate="no">:</code> <code class="n" translate="no">WebSocket</code>
    <code class="p" translate="no">)</code> <code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code> <code class="kc" translate="no">None</code><code class="p" translate="no">:</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-5" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a>
        <code class="k" translate="no">if</code> <code class="nb" translate="no">isinstance</code><code class="p" translate="no">(</code><code class="n" translate="no">message</code><code class="p" translate="no">,</code> <code class="nb" translate="no">str</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
            <code class="k" translate="no">await</code> <code class="n" translate="no">websocket</code><code class="o" translate="no">.</code><code class="n" translate="no">send_text</code><code class="p" translate="no">(</code><code class="n" translate="no">message</code><code class="p" translate="no">)</code>
        <code class="k" translate="no">elif</code> <code class="nb" translate="no">isinstance</code><code class="p" translate="no">(</code><code class="n" translate="no">message</code><code class="p" translate="no">,</code> <code class="nb" translate="no">bytes</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
            <code class="k" translate="no">await</code> <code class="n" translate="no">websocket</code><code class="o" translate="no">.</code><code class="n" translate="no">send_bytes</code><code class="p" translate="no">(</code><code class="n" translate="no">message</code><code class="p" translate="no">)</code>
        <code class="k" translate="no">else</code><code class="p" translate="no">:</code>
            <code class="k" translate="no">await</code> <code class="n" translate="no">websocket</code><code class="o" translate="no">.</code><code class="n" translate="no">send_json</code><code class="p" translate="no">(</code><code class="n" translate="no">message</code><code class="p" translate="no">)</code>


<code class="n" translate="no">ws_manager</code> <code class="o" translate="no">=</code> <code class="n" translate="no">WSConnectionManager</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-6" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-1" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Crea un <code translate="no">WSConnectionManager</code> per tenere traccia e gestire le connessioni WS attive.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-2" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Apri una connessione WebSocket utilizzando il metodo <code translate="no">accept()</code>. Aggiungi la nuova connessione all'elenco delle connessioni attive.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-3" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Quando ti disconnetti, chiudi la connessione e rimuovi l'istanza di <code translate="no">websocket</code>dall'elenco delle connessioni attive.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-4" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Ricevi i messaggi in arrivo come testo durante una connessione aperta.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-5" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a></dt>
<dd><p>Invia i messaggi al client utilizzando il metodo di invio pertinente.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-6" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO10-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a></dt>
<dd><p>Crea una singola istanza di <code translate="no">WSConnectionManager</code> da riutilizzare in tutta l'applicazione.</p></dd>
</dl></div>
<p>Puoi anche estendere il gestore delle connessioni dell'<a data-type="xref" href="#websockets_manager">Esempio 6-12</a> per <em>trasmettere</em> messaggi (ad esempio, avvisi, notifiche o aggiornamenti del sistema in tempo reale) a tutti i client connessi. Questo è utile in applicazioni come le chat di gruppo o gli strumenti di editing collaborativo di lavagne e documenti.</p>
<p>Poiché il gestore delle connessioni mantiene un puntatore a ogni client tramite l'elenco <code translate="no">active_​con⁠nec⁠tions</code>, puoi trasmettere messaggi a ogni client, come mostrato nell'<a data-type="xref" href="#websockets_broadcast">Esempio 6-13</a>.</p>
<div data-type="example" id="websockets_broadcast">
<h5><span class="label">Esempio 6-13. </span>Trasmissione di messaggi ai client connessi utilizzando il gestore WebSocket</h5>
<pre data-type="programlisting" translate="no"># stream.py

from fastapi.websockets import WebSocket

class WSConnectionManager:
    ...
    async def broadcast(self, message: str | bytes | list | dict) -&gt; None:
        for connection in self.active_connections:
            await self.send(message, connection)</pre></div>
<p>Con l'implementazione del gestore WebSocket, ora puoi sviluppare un endpoint WebSocket per trasmettere le risposte ai client. Tuttavia, prima di implementare l'endpoint, segui l'<a data-type="xref" href="#chat_stream_ws">Esempio 6-14</a> per aggiornare il metodo<code translate="no">chat_stream</code>in modo che produca il contenuto dello stream in un formato adatto alle connessioni WebSocket.</p>
<div data-type="example" id="chat_stream_ws">
<h5><span class="label">Esempio 6-14. </span>Aggiornare il metodo di streaming del client di chat per produrre contenuti adatti alle connessioni WebSocket</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># stream.py</code>

<code class="kn" translate="no">import</code> <code class="nn" translate="no">asyncio</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">typing</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">AsyncGenerator</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">AzureOpenAIChatClient</code><code class="p" translate="no">:</code>
    <code class="k" translate="no">def</code> <code class="fm" translate="no">__init__</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
        <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">aclient</code> <code class="o" translate="no">=</code> <code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code>

    <code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">chat_stream</code><code class="p" translate="no">(</code>
        <code class="bp" translate="no">self</code><code class="p" translate="no">,</code> <code class="n" translate="no">prompt</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code><code class="p" translate="no">,</code> <code class="n" translate="no">mode</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">sse</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="n" translate="no">model</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">gpt-4o</code><code class="s2" translate="no">"</code>
    <code class="p" translate="no">)</code> <code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code> <code class="n" translate="no">AsyncGenerator</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code> <code class="kc" translate="no">None</code><code class="p" translate="no">]</code><code class="p" translate="no">:</code>
        <code class="n" translate="no">stream</code> <code class="o" translate="no">=</code> <code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code>  <code class="c1" translate="no"># OpenAI chat completion stream</code>

        <code class="k" translate="no">async</code> <code class="k" translate="no">for</code> <code class="n" translate="no">chunk</code> <code class="ow" translate="no">in</code> <code class="n" translate="no">stream</code><code class="p" translate="no">:</code>
            <code class="k" translate="no">if</code> <code class="n" translate="no">chunk</code><code class="o" translate="no">.</code><code class="n" translate="no">choices</code><code class="p" translate="no">[</code><code class="mi" translate="no">0</code><code class="p" translate="no">]</code><code class="o" translate="no">.</code><code class="n" translate="no">delta</code><code class="o" translate="no">.</code><code class="n" translate="no">content</code> <code class="ow" translate="no">is</code> <code class="ow" translate="no">not</code> <code class="kc" translate="no">None</code><code class="p" translate="no">:</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO11-1" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO11-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
                <code class="k" translate="no">yield</code> <code class="p" translate="no">(</code>
                    <code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">data: </code><code class="si" translate="no">{</code><code class="n" translate="no">chunk</code><code class="o" translate="no">.</code><code class="n" translate="no">choices</code><code class="p" translate="no">[</code><code class="mi" translate="no">0</code><code class="p" translate="no">]</code><code class="o" translate="no">.</code><code class="n" translate="no">delta</code><code class="o" translate="no">.</code><code class="n" translate="no">content</code><code class="si" translate="no">}</code><code class="se" translate="no">\n</code><code class="se" translate="no">\n</code><code class="s2" translate="no">"</code>
                    <code class="k" translate="no">if</code> <code class="n" translate="no">mode</code> <code class="o" translate="no">==</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">sse</code><code class="s2" translate="no">"</code>
                    <code class="k" translate="no">else</code> <code class="n" translate="no">chunk</code><code class="o" translate="no">.</code><code class="n" translate="no">choices</code><code class="p" translate="no">[</code><code class="mi" translate="no">0</code><code class="p" translate="no">]</code><code class="o" translate="no">.</code><code class="n" translate="no">delta</code><code class="o" translate="no">.</code><code class="n" translate="no">content</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO11-2" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO11-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
                <code class="p" translate="no">)</code>
                <code class="k" translate="no">await</code> <code class="n" translate="no">asyncio</code><code class="o" translate="no">.</code><code class="n" translate="no">sleep</code><code class="p" translate="no">(</code><code class="mf" translate="no">0.05</code><code class="p" translate="no">)</code>
        <code class="k" translate="no">if</code> <code class="n" translate="no">mode</code> <code class="o" translate="no">==</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">sse</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO11-2" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO11-3"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
            <code class="k" translate="no">yield</code> <code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">data: [DONE]</code><code class="se" translate="no">\n</code><code class="se" translate="no">\n</code><code class="s2" translate="no">"</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO11-1" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO11-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Restituisce solo contenuti non vuoti.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO11-2" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO11-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Restituisce il contenuto del flusso in base al tipo di connessione (SSE o WS).</p></dd>
</dl></div>
<p>Dopo aver aggiornato il metodo <code translate="no">stream_chat</code>, puoi concentrarti sull'aggiunta di un endpoint WebSocket. Utilizza il metodo <code translate="no">@app.websocket</code> per decorare una funzione del controller che utilizza la classe <code translate="no">WebSocket</code> <span class="keep-together">di FastAPI</span>, come mostrato nell'<a data-type="xref" href="#websocket_endpoint">esempio 6-15</a>.</p>
<div data-type="example" id="websocket_endpoint">
<h5><span class="label">Esempio 6-15. </span>Implementazione di un endpoint WS</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># main.py</code>

<code class="kn" translate="no">import</code> <code class="nn" translate="no">asyncio</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">loguru</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">logger</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">fastapi</code><code class="nn" translate="no">.</code><code class="nn" translate="no">websockets</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">WebSocket</code><code class="p" translate="no">,</code> <code class="n" translate="no">WebSocketDisconnect</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">stream</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">ws_manager</code><code class="p" translate="no">,</code> <code class="n" translate="no">azure_chat_client</code>

<code class="nd" translate="no">@app</code><code class="o" translate="no">.</code><code class="n" translate="no">websocket</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/generate/text/streams</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-1" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
<code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">websocket_endpoint</code><code class="p" translate="no">(</code><code class="n" translate="no">websocket</code><code class="p" translate="no">:</code> <code class="n" translate="no">WebSocket</code><code class="p" translate="no">)</code> <code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code> <code class="kc" translate="no">None</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">logger</code><code class="o" translate="no">.</code><code class="n" translate="no">info</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Connecting to client....</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">await</code> <code class="n" translate="no">ws_manager</code><code class="o" translate="no">.</code><code class="n" translate="no">connect</code><code class="p" translate="no">(</code><code class="n" translate="no">websocket</code><code class="p" translate="no">)</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-2" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
    <code class="k" translate="no">try</code><code class="p" translate="no">:</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-3" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a>
        <code class="k" translate="no">while</code> <code class="kc" translate="no">True</code><code class="p" translate="no">:</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-4" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a>
            <code class="n" translate="no">prompt</code> <code class="o" translate="no">=</code> <code class="k" translate="no">await</code> <code class="n" translate="no">ws_manager</code><code class="o" translate="no">.</code><code class="n" translate="no">receive</code><code class="p" translate="no">(</code><code class="n" translate="no">websocket</code><code class="p" translate="no">)</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-5" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a>
            <code class="k" translate="no">async</code> <code class="k" translate="no">for</code> <code class="n" translate="no">chunk</code> <code class="ow" translate="no">in</code> <code class="n" translate="no">azure_chat_client</code><code class="o" translate="no">.</code><code class="n" translate="no">chat_stream</code><code class="p" translate="no">(</code><code class="n" translate="no">prompt</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">ws</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
                <code class="k" translate="no">await</code> <code class="n" translate="no">ws_manager</code><code class="o" translate="no">.</code><code class="n" translate="no">send</code><code class="p" translate="no">(</code><code class="n" translate="no">chunk</code><code class="p" translate="no">,</code> <code class="n" translate="no">websocket</code><code class="p" translate="no">)</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-6" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a>
                <code class="k" translate="no">await</code> <code class="n" translate="no">asyncio</code><code class="o" translate="no">.</code><code class="n" translate="no">sleep</code><code class="p" translate="no">(</code><code class="mf" translate="no">0.05</code><code class="p" translate="no">)</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-7" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-7"><img alt="7" src="assets/7.png" width="12" height="12"/></a>
    <code class="k" translate="no">except</code> <code class="n" translate="no">WebSocketDisconnect</code><code class="p" translate="no">:</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-8" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-8"><img alt="8" src="assets/8.png" width="12" height="12"/></a>
        <code class="n" translate="no">logger</code><code class="o" translate="no">.</code><code class="n" translate="no">info</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Client disconnected</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">except</code> <code class="ne" translate="no">Exception</code> <code class="k" translate="no">as</code> <code class="n" translate="no">e</code><code class="p" translate="no">:</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-9" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-9"><img alt="9" src="assets/9.png" width="12" height="12"/></a>
        <code class="n" translate="no">logger</code><code class="o" translate="no">.</code><code class="n" translate="no">error</code><code class="p" translate="no">(</code><code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Error with the WebSocket connection: </code><code class="si" translate="no">{</code><code class="n" translate="no">e</code><code class="si" translate="no">}</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code>
        <code class="k" translate="no">await</code> <code class="n" translate="no">ws_manager</code><code class="o" translate="no">.</code><code class="n" translate="no">send</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">An internal server error has occurred</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">finally</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">await</code> <code class="n" translate="no">ws_manager</code><code class="o" translate="no">.</code><code class="n" translate="no">disconnect</code><code class="p" translate="no">(</code><code class="n" translate="no">websocket</code><code class="p" translate="no">)</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-10" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-10"><img alt="10" src="assets/10.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-1" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Crea un endpoint WebSocket accessibile all'indirizzo<code translate="no">ws://localhost:8000/generate/text/stream</code>.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-2" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Apri la connessione WebSocket tra il client e il server.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-3" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Finché la connessione è aperta, continua a inviare o ricevere messaggi.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-4" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Gestire gli errori e registrare gli eventi importanti all'interno di <code translate="no">websocket_controller</code> per identificare le cause degli errori e gestire le situazioni inaspettate con grazia. Interrompere il ciclo infinito quando la connessione viene chiusa dal server o dal client.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-5" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a></dt>
<dd><p>Quando viene ricevuto il primo messaggio, passalo come prompt all'API OpenAI.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-6" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a></dt>
<dd><p>iterare in modo asincrono sul flusso di chat generato e inviare ogni pezzo al client.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-7" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-7"><img alt="7" src="assets/7.png" width="12" height="12"/></a></dt>
<dd><p>Attendere un piccolo lasso di tempo prima di inviare il messaggio successivo per ridurre i problemi di race condition e consentire al client di avere tempo sufficiente per l'elaborazione del flusso.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-8" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-8"><img alt="8" src="assets/8.png" width="12" height="12"/></a></dt>
<dd><p>Quando il client chiude la connessione WebSocket, viene sollevata l'eccezione <code translate="no">WebSocketDisconnect</code>.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-9" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-9"><img alt="9" src="assets/9.png" width="12" height="12"/></a></dt>
<dd><p>Se si verifica un errore sul lato server durante una connessione aperta, registra l'errore e identifica il cliente.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-10" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO12-10"><img alt="10" src="assets/10.png" width="12" height="12"/></a></dt>
<dd><p>Interrompe il ciclo infinito e chiude con grazia la connessione WebSocket se lo stream è terminato, se c'è un errore interno o se il client ha chiuso la connessione. Rimuove la connessione dall'elenco delle connessioni WebSocket attive.</p></dd>
</dl></div>
<p>Ora che hai un endpoint WebSocket, sviluppiamo l'HTML del client per testare l'endpoint (vedi <a data-type="xref" href="#ws_client">Esempio 6-16</a>).</p>
<div data-type="example" id="ws_client">
<h5><span class="label">Esempio 6-16. </span>Implementazione di connessioni WebSocket lato client con gestione degli errori e funzionalità di backoff retry esponenziale</h5>
<pre data-code-language="html" data-type="programlisting" translate="no"><code translate="no">{# pages/client-ws.html #}

</code><code class="cp" translate="no">&lt;!DOCTYPE html&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">html</code> <code class="na" translate="no">lang</code><code class="o" translate="no">=</code><code class="s" translate="no">"en"</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">head</code><code class="p" translate="no">&gt;</code>
    <code class="p" translate="no">&lt;</code><code class="nt" translate="no">title</code><code class="p" translate="no">&gt;</code><code translate="no">Stream with WebSocket</code><code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">title</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">head</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">body</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">button</code> <code class="na" translate="no">id</code><code class="o" translate="no">=</code><code class="s" translate="no">"streambtn"</code><code class="p" translate="no">&gt;</code><code translate="no">Start Streaming</code><code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">button</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">button</code> <code class="na" translate="no">id</code><code class="o" translate="no">=</code><code class="s" translate="no">"closebtn"</code><code class="p" translate="no">&gt;</code><code translate="no">Close Connection</code><code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">button</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">label</code> <code class="na" translate="no">for</code><code class="o" translate="no">=</code><code class="s" translate="no">"messageInput"</code><code class="p" translate="no">&gt;</code><code translate="no">Enter your prompt:</code><code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">label</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">input</code> <code class="na" translate="no">type</code><code class="o" translate="no">=</code><code class="s" translate="no">"text"</code> <code class="na" translate="no">id</code><code class="o" translate="no">=</code><code class="s" translate="no">"messageInput"</code> <code class="na" translate="no">placeholder</code><code class="o" translate="no">=</code><code class="s" translate="no">"Enter message"</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="nt" translate="no">div</code> <code class="na" translate="no">style</code><code class="o" translate="no">=</code><code class="s" translate="no">"padding-top: 10px"</code> <code class="na" translate="no">id</code><code class="o" translate="no">=</code><code class="s" translate="no">"container"</code><code class="p" translate="no">&gt;</code><code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">div</code><code class="p" translate="no">&gt;</code>

<code class="p" translate="no">&lt;</code><code class="nt" translate="no">script</code><code class="p" translate="no">&gt;</code>
    <code class="kd" translate="no">const</code> <code class="nx" translate="no">streamButton</code> <code class="o" translate="no">=</code> <code class="nb" translate="no">document</code><code class="p" translate="no">.</code><code class="nx" translate="no">getElementById</code><code class="p" translate="no">(</code><code class="s1" translate="no">'streambtn'</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
    <code class="kd" translate="no">const</code> <code class="nx" translate="no">closeButton</code> <code class="o" translate="no">=</code> <code class="nb" translate="no">document</code><code class="p" translate="no">.</code><code class="nx" translate="no">getElementById</code><code class="p" translate="no">(</code><code class="s1" translate="no">'closebtn'</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
    <code class="kd" translate="no">const</code> <code class="nx" translate="no">container</code> <code class="o" translate="no">=</code> <code class="nb" translate="no">document</code><code class="p" translate="no">.</code><code class="nx" translate="no">getElementById</code><code class="p" translate="no">(</code><code class="s1" translate="no">'container'</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
    <code class="kd" translate="no">const</code> <code class="nx" translate="no">input</code> <code class="o" translate="no">=</code> <code class="nb" translate="no">document</code><code class="p" translate="no">.</code><code class="nx" translate="no">getElementById</code><code class="p" translate="no">(</code><code class="s1" translate="no">'messageInput'</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>

    <code class="kd" translate="no">let</code> <code class="nx" translate="no">ws</code><code class="p" translate="no">;</code>
    <code class="kd" translate="no">let</code> <code class="nx" translate="no">retryCount</code> <code class="o" translate="no">=</code> <code class="mf" translate="no">0</code><code class="p" translate="no">;</code>
    <code class="kd" translate="no">const</code> <code class="nx" translate="no">maxRetries</code> <code class="o" translate="no">=</code> <code class="mf" translate="no">5</code><code class="p" translate="no">;</code>
    <code class="kd" translate="no">let</code> <code class="nx" translate="no">isError</code> <code class="o" translate="no">=</code> <code class="kc" translate="no">false</code><code class="p" translate="no">;</code>

    <code class="kd" translate="no">function</code> <code class="nx" translate="no">sleep</code><code class="p" translate="no">(</code><code class="nx" translate="no">ms</code><code class="p" translate="no">)</code> <code class="p" translate="no">{</code>
        <code class="k" translate="no">return</code> <code class="ow" translate="no">new</code> <code class="nb" translate="no">Promise</code><code class="p" translate="no">(</code><code class="nx" translate="no">resolve</code> <code class="p" translate="no">=&gt;</code> <code class="nx" translate="no">setTimeout</code><code class="p" translate="no">(</code><code class="nx" translate="no">resolve</code><code class="p" translate="no">,</code> <code class="nx" translate="no">ms</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
    <code class="p" translate="no">}</code>

    <code class="kd" translate="no">function</code> <code class="nx" translate="no">connectWebSocket</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code> <code class="p" translate="no">{</code>
        <code class="nx" translate="no">ws</code> <code class="o" translate="no">=</code> <code class="ow" translate="no">new</code> <code class="nx" translate="no">WebSocket</code><code class="p" translate="no">(</code><code class="s2" translate="no">"ws://localhost:8000/generate/text/streams"</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-1" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>

        <code class="nx" translate="no">ws</code><code class="p" translate="no">.</code><code class="nx" translate="no">onopen</code> <code class="o" translate="no">=</code> <code class="nx" translate="no">handleOpen</code><code class="p" translate="no">;</code>
        <code class="nx" translate="no">ws</code><code class="p" translate="no">.</code><code class="nx" translate="no">onmessage</code> <code class="o" translate="no">=</code> <code class="nx" translate="no">handleMessage</code><code class="p" translate="no">;</code>
        <code class="nx" translate="no">ws</code><code class="p" translate="no">.</code><code class="nx" translate="no">onclose</code> <code class="o" translate="no">=</code> <code class="nx" translate="no">handleClose</code><code class="p" translate="no">;</code>
        <code class="nx" translate="no">ws</code><code class="p" translate="no">.</code><code class="nx" translate="no">onerror</code> <code class="o" translate="no">=</code> <code class="nx" translate="no">handleError</code><code class="p" translate="no">;</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-2" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
    <code class="p" translate="no">}</code>

    <code class="kd" translate="no">function</code> <code class="nx" translate="no">handleOpen</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">{</code>
        <code class="nx" translate="no">console</code><code class="p" translate="no">.</code><code class="nx" translate="no">log</code><code class="p" translate="no">(</code><code class="s2" translate="no">"WebSocket connection opened"</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
        <code class="nx" translate="no">retryCount</code> <code class="o" translate="no">=</code> <code class="mf" translate="no">0</code><code class="p" translate="no">;</code>
        <code class="nx" translate="no">isError</code> <code class="o" translate="no">=</code> <code class="kc" translate="no">false</code><code class="p" translate="no">;</code>
    <code class="p" translate="no">}</code>

    <code class="kd" translate="no">function</code> <code class="nx" translate="no">handleMessage</code><code class="p" translate="no">(</code><code class="nx" translate="no">event</code><code class="p" translate="no">)</code> <code class="p" translate="no">{</code>
        <code class="nx" translate="no">container</code><code class="p" translate="no">.</code><code class="nx" translate="no">textContent</code> <code class="o" translate="no">+=</code> <code class="nx" translate="no">event</code><code class="p" translate="no">.</code><code class="nx" translate="no">data</code><code class="p" translate="no">;</code>
    <code class="p" translate="no">}</code>

    <code class="k" translate="no">async</code> <code class="kd" translate="no">function</code> <code class="nx" translate="no">handleClose</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">{</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-3" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a>
        <code class="nx" translate="no">console</code><code class="p" translate="no">.</code><code class="nx" translate="no">log</code><code class="p" translate="no">(</code><code class="s2" translate="no">"WebSocket connection closed"</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
        <code class="k" translate="no">if</code> <code class="p" translate="no">(</code><code class="nx" translate="no">isError</code> <code class="o" translate="no">&amp;&amp;</code> <code class="nx" translate="no">retryCount</code> <code class="o" translate="no">&lt;</code> <code class="nx" translate="no">maxRetries</code><code class="p" translate="no">)</code> <code class="p" translate="no">{</code>
            <code class="nx" translate="no">console</code><code class="p" translate="no">.</code><code class="nx" translate="no">warn</code><code class="p" translate="no">(</code><code class="s2" translate="no">"Retrying connection..."</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
            <code class="k" translate="no">await</code> <code class="nx" translate="no">sleep</code><code class="p" translate="no">(</code><code class="nb" translate="no">Math</code><code class="p" translate="no">.</code><code class="nx" translate="no">pow</code><code class="p" translate="no">(</code><code class="mf" translate="no">2</code><code class="p" translate="no">,</code> <code class="nx" translate="no">retryCount</code><code class="p" translate="no">)</code> <code class="o" translate="no">*</code> <code class="mf" translate="no">1000</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
            <code class="nx" translate="no">retryCount</code><code class="o" translate="no">++</code><code class="p" translate="no">;</code>
            <code class="nx" translate="no">connectWebSocket</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
        <code class="p" translate="no">}</code>
        <code class="k" translate="no">else</code> <code class="k" translate="no">if</code> <code class="p" translate="no">(</code><code class="nx" translate="no">isError</code><code class="p" translate="no">)</code> <code class="p" translate="no">{</code>
            <code class="nx" translate="no">console</code><code class="p" translate="no">.</code><code class="nx" translate="no">error</code><code class="p" translate="no">(</code><code class="s2" translate="no">"Max retries reached. Could not reconnect."</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
        <code class="p" translate="no">}</code>
    <code class="p" translate="no">}</code>

    <code class="kd" translate="no">function</code> <code class="nx" translate="no">handleError</code><code class="p" translate="no">(</code><code class="nx" translate="no">error</code><code class="p" translate="no">)</code> <code class="p" translate="no">{</code>
        <code class="nx" translate="no">console</code><code class="p" translate="no">.</code><code class="nx" translate="no">error</code><code class="p" translate="no">(</code><code class="s2" translate="no">"WebSocket error:"</code><code class="p" translate="no">,</code> <code class="nx" translate="no">error</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
        <code class="nx" translate="no">isError</code> <code class="o" translate="no">=</code> <code class="kc" translate="no">true</code><code class="p" translate="no">;</code>
        <code class="nx" translate="no">ws</code><code class="p" translate="no">.</code><code class="nx" translate="no">close</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
    <code class="p" translate="no">}</code>

    <code class="kd" translate="no">function</code> <code class="nx" translate="no">resetForm</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">{</code>
        <code class="nx" translate="no">input</code><code class="p" translate="no">.</code><code class="nx" translate="no">value</code> <code class="o" translate="no">=</code> <code class="s1" translate="no">''</code><code class="p" translate="no">;</code>
        <code class="nx" translate="no">container</code><code class="p" translate="no">.</code><code class="nx" translate="no">textContent</code> <code class="o" translate="no">=</code> <code class="s1" translate="no">''</code><code class="p" translate="no">;</code>
    <code class="p" translate="no">}</code>

    <code class="nx" translate="no">streamButton</code><code class="p" translate="no">.</code><code class="nx" translate="no">addEventListener</code><code class="p" translate="no">(</code><code class="s1" translate="no">'click'</code><code class="p" translate="no">,</code> <code class="kd" translate="no">function</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code> <code class="p" translate="no">{</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-4" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a>
        <code class="kd" translate="no">const</code> <code class="nx" translate="no">prompt</code> <code class="o" translate="no">=</code> <code class="nb" translate="no">document</code><code class="p" translate="no">.</code><code class="nx" translate="no">getElementById</code><code class="p" translate="no">(</code><code class="s2" translate="no">"messageInput"</code><code class="p" translate="no">)</code><code class="p" translate="no">.</code><code class="nx" translate="no">value</code><code class="p" translate="no">;</code>
        <code class="k" translate="no">if</code> <code class="p" translate="no">(</code><code class="nx" translate="no">prompt</code> <code class="o" translate="no">&amp;&amp;</code> <code class="nx" translate="no">ws</code> <code class="o" translate="no">&amp;&amp;</code> <code class="nx" translate="no">ws</code><code class="p" translate="no">.</code><code class="nx" translate="no">readyState</code> <code class="o" translate="no">===</code> <code class="nx" translate="no">WebSocket</code><code class="p" translate="no">.</code><code class="nx" translate="no">OPEN</code><code class="p" translate="no">)</code> <code class="p" translate="no">{</code>
            <code class="nx" translate="no">ws</code><code class="p" translate="no">.</code><code class="nx" translate="no">send</code><code class="p" translate="no">(</code><code class="nx" translate="no">prompt</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-5" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a>
        <code class="p" translate="no">}</code>
        <code class="nx" translate="no">resetForm</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-6" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a>
    <code class="p" translate="no">}</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>

    <code class="nx" translate="no">closeButton</code><code class="p" translate="no">.</code><code class="nx" translate="no">addEventListener</code><code class="p" translate="no">(</code><code class="s1" translate="no">'click'</code><code class="p" translate="no">,</code> <code class="kd" translate="no">function</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code> <code class="p" translate="no">{</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-7" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-7"><img alt="7" src="assets/7.png" width="12" height="12"/></a>
        <code class="nx" translate="no">isError</code> <code class="o" translate="no">=</code> <code class="kc" translate="no">false</code><code class="p" translate="no">;</code>
        <code class="k" translate="no">if</code> <code class="p" translate="no">(</code><code class="nx" translate="no">ws</code><code class="p" translate="no">)</code> <code class="p" translate="no">{</code>
            <code class="nx" translate="no">ws</code><code class="p" translate="no">.</code><code class="nx" translate="no">close</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>
        <code class="p" translate="no">}</code>
    <code class="p" translate="no">}</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code>

    <code class="nx" translate="no">connectWebSocket</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">;</code> <a class="co" href="#callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-1" id="co_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-8"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
<code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">script</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">body</code><code class="p" translate="no">&gt;</code>
<code class="p" translate="no">&lt;</code><code class="p" translate="no">/</code><code class="nt" translate="no">html</code><code class="p" translate="no">&gt;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-1" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Stabilisci una connessione WebSocket con il server FastAPI.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-2" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Aggiungi dei gestori di callback all'istanza di connessione WebSocket per gestire gli eventi di apertura, chiusura, messaggio ed errore.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-3" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Gestisce con grazia gli errori di connessione e ristabilisce la connessione con una funzionalità di backoff retry esponenziale utilizzando un flag <code translate="no">isError</code>.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-4" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Aggiungi un ascoltatore di eventi al pulsante di streaming per inviare il primo messaggio al server.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-5" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a></dt>
<dd><p>Una volta stabilita la connessione, invia il prompt iniziale non vuoto come primo messaggio al server.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-6" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a></dt>
<dd><p>Reimposta il modulo prima di stabilire la connessione WebSocket da avviare.</p></dd>
<dt><a class="co" href="#co_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-7" id="callout_real_time_communication___span_class__keep_together__with_generative_models__span__CO13-7"><img alt="7" src="assets/7.png" width="12" height="12"/></a></dt>
<dd><p>Aggiungi un ascoltatore di eventi al pulsante di chiusura della connessione per chiudere la connessione quando il pulsante viene cliccato.</p></dd>
</dl></div>
<p>Ora puoi visitare <a class="bare" href="http://localhost:8000/pages/client-ws.html"><em class="hyperlink">http://localhost:8000/pages/client-ws.html</em></a> per testare il tuo endpoint di streaming WebSocket (vedi <a data-type="xref" href="#ws_results">Figura 6-9</a>).</p>
<figure><div class="figure" id="ws_results">
<img alt="bgai 0609" src="assets/bgai_0609.png" width="1920" height="646"/>
<h6><span class="label">Figura 6-9. </span>Flusso in entrata dall'endpoint WebSocket</h6>
</div></figure>
<p>Ora dovresti avere un'applicazione di streaming LLM completamente funzionante con WebSocket. Ben fatto!</p>
<p>A questo punto ti starai chiedendo quale sia la soluzione migliore: lo streaming con SSE o le connessioni WS. La risposta dipende dai requisiti della tua applicazione. SSE è semplice da implementare ed è nativo del protocollo HTTP, quindi la maggior parte dei client lo supporta. Se hai bisogno solo di uno streaming unidirezionale verso il client, allora ti consiglio di implementare le connessioni SSE per lo streaming degli output di LLM.</p>
<p>Le connessioni WebSocket forniscono un maggiore controllo al meccanismo di streaming e consentono una comunicazione duplex all'interno della stessa connessione, ad esempio nelle applicazioni di chat in tempo reale con più utenti e nei servizi LLM, speech-to-text, text-to-speech e speech-to-speech. Tuttavia, l'utilizzo di WebSocket richiede l'aggiornamento della connessione da HTTP al protocollo WebSocket, che i client legacy e i browser più vecchi potrebbero non supportare. Inoltre, dovrai gestire le eccezioni in modo leggermente diverso con gli endpoint WebSocket.<a data-startref="ix_ch06-asciidoc26" data-type="indexterm" id="id920"/><a data-startref="ix_ch06-asciidoc25" data-type="indexterm" id="id921"/></p>
</div></section>
<section data-pdf-bookmark="Handling WebSocket Exceptions" data-type="sect2"><div class="sect2" id="id100">
<h2>Gestire le eccezioni WebSocket</h2>
<p><a data-primary="exception handling, for WS" data-type="indexterm" id="id922"/><a data-primary="real-time communication with generative models" data-secondary="implementing WS endpoints" data-tertiary="handling WS exceptions" data-type="indexterm" id="id923"/><a data-primary="WebSocket (WS)" data-secondary="implementing endpoints with WS protocol" data-tertiary="handling WS exceptions" data-type="indexterm" id="id924"/>La gestione delle eccezioni WebSocket è diversa da quella delle connessioni HTTP tradizionali. Se fai riferimento all'<a data-type="xref" href="#websocket_endpoint">Esempio 6-15</a>, noterai che non stai più restituendo al cliente una risposta con codici di stato, o <code translate="no">HTTPExceptions</code>, ma piuttosto stai mantenendo una connessione aperta dopo l'accettazione della connessione.</p>
<p>Finché la connessione è aperta, puoi inviare e ricevere messaggi. Tuttavia, non appena si verifica un'eccezione, devi gestirla chiudendo con grazia la connessione e/o inviando un messaggio di errore al client in sostituzione della risposta <code translate="no">HTTPException</code>.</p>
<p>Poiché il protocollo WebSocket non supporta i consueti codici di stato HTTP (<code translate="no">4xx</code> o <code translate="no">5xx</code>), non puoi usare i codici di stato per notificare ai client i problemi del lato server. Al contrario, dovresti inviare messaggi WebSocket ai client per notificare loro i problemi prima di chiudere qualsiasi connessione attiva dal server.</p>
<p>Durante la chiusura della connessione, puoi utilizzare diversi codici di stato relativi a WebSocket per specificare il motivo della chiusura. Utilizzando questi motivi di chiusura, puoi implementare qualsiasi comportamento di chiusura personalizzato sul server o sui client.</p>
<p>La<a data-type="xref" href="#ws_status_codes">Tabella 6-2</a> mostra alcuni codici di stato comuni che possono essere inviati con un frame <code translate="no">CLOSE</code>.</p>
<table class="striped" id="ws_status_codes">
<caption><span class="label">Tabella 6-2. </span>Codici di stato comuni del protocollo WebSocket</caption>
<thead>
<tr>
<th>Codice di stato</th>
<th>Descrizione</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>1000</p></td>
<td><p>Chiusura normale</p></td>
</tr>
<tr>
<td><p>1001</p></td>
<td><p>Il cliente si è allontanato o il server è andato giù</p></td>
</tr>
<tr>
<td><p>1002</p></td>
<td><p>Un endpoint (ad esempio, client o server) ha ricevuto dati che violano il protocollo WS (ad esempio, pacchetti non mascherati, lunghezza del payload non valida).</p></td>
</tr>
<tr>
<td><p>1003</p></td>
<td><p>Un endpoint ha ricevuto dati non supportati (ad esempio, si aspettava un testo e ha ricevuto un file binario).</p></td>
</tr>
<tr>
<td><p>1007</p></td>
<td><p>Un endpoint ha ricevuto dati codificati in modo incoerente (ad esempio, dati non UTF-8 all'interno di un messaggio di testo).</p></td>
</tr>
<tr>
<td><p>1008</p></td>
<td><p>Un endpoint ha ricevuto un messaggio che viola la sua politica; può essere utilizzato per nascondere i dettagli della chiusura per motivi di sicurezza.</p></td>
</tr>
<tr>
<td><p>1011</p></td>
<td><p>Errore interno del server</p></td>
</tr>
</tbody>
</table>
<p>Puoi trovare maggiori informazioni sugli altri codici di stato WebSocket nella<a href="https://oreil.ly/1L_HH">sezione 7.4</a> del protocollo WebSocket<a href="https://oreil.ly/1L_HH">RFC 6455.</a></p>
</div></section>
<section data-pdf-bookmark="Designing APIs for Streaming" data-type="sect2"><div class="sect2" id="id101">
<h2>Progettare API per lo streaming</h2>
<p><a data-primary="real-time communication with generative models" data-secondary="designing APIs for streaming" data-type="indexterm" id="id925"/><a data-primary="streaming, API design patterns for" data-type="indexterm" id="id926"/>Ora che hai acquisito una maggiore familiarità con le implementazioni degli endpoint SSE e WebSocket, desidero soffermarmi su un ultimo importante dettaglio relativo al loro design architettonico.</p>
<p>Un'insidia comune nella progettazione di API di streaming è l'esposizione di un numero eccessivo di endpoint di streaming. Ad esempio, se stai realizzando un'applicazione di chatbot, potresti esporre diversi endpoint di streaming, ognuno preconfigurato per gestire diversi messaggi in arrivo in una singola conversazione.
Utilizzando questo particolare modello di progettazione dell'API, chiedi al cliente di passare da un endpoint all'altro, fornendo le informazioni necessarie in ogni passaggio e navigando tra le connessioni in streaming durante una singola conversazione. Questo modello di progettazione aumenta la complessità delle applicazioni sia di backend che di frontend, poiché gli stati della conversazione devono essere gestiti da entrambi i lati, evitando condizioni di gara e problemi di rete tra i componenti.</p>
<p>Un modello di progettazione dell'API più semplice consiste nel fornire un unico punto di ingresso al client per avviare un flusso con i tuoi modelli GenAI e utilizzare le intestazioni, il corpo della richiesta o i parametri della query per attivare la logica pertinente nel backend. Con questo design, la logica del backend è astratta dal client, il che semplifica la gestione dello stato sul frontend, mentre tutte le rotte e la logica aziendale sono implementate nel backend.
Poiché il backend ha accesso ai database, ad altri servizi e a prompt personalizzati, può facilmente<span class="keep-together">eseguire</span> operazioni CRUD e passare da un prompt all'altro o da un modello all'altro per calcolare una risposta. Pertanto, un endpoint può fungere da unico punto di ingresso per la logica di commutazione, gestire gli stati dell'applicazione e generare risposte personalizzate.<a data-startref="ix_ch06-asciidoc24" data-type="indexterm" id="id927"/><a data-startref="ix_ch06-asciidoc23" data-type="indexterm" id="id928"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="id102">
<h1>Riassunto</h1>
<p>Questo capitolo ha trattato diverse strategie per implementare la comunicazione in tempo reale tramite lo streaming dei dati nei tuoi servizi GenAI.</p>
<p>Hai imparato a conoscere diversi meccanismi di comunicazione web, tra cui il tradizionale modello HTTP richiesta-risposta, il polling breve/regolare, il polling lungo, SSE e WebSocket. Hai poi confrontato questi meccanismi in dettaglio per comprenderne le caratteristiche, i vantaggi, gli svantaggi e i casi d'uso, in particolare per i flussi di lavoro dell'intelligenza artificiale. Infine, hai implementato due endpoint di streaming LLM utilizzando il client asincrono Azure OpenAI per imparare a sfruttare i<span class="keep-together">meccanismi di</span> comunicazione in tempo reale SSE e WebSocket<a data-startref="ix_ch06-asciidoc0" data-type="indexterm" id="id929"/>.</p>
<p>Nel prossimo capitolo imparerai a conoscere meglio i flussi di lavoro per lo sviluppo delle API durante l'integrazione dei database per i servizi di intelligenza artificiale, tra cui come impostare, migrare e interagire con i database. Imparerai anche a gestire le operazioni di archiviazione e recupero dei dati all'interno degli endpoint di streaming utilizzando i task in background di FastAPI.</p>
<p>Gli argomenti trattati nel prossimo capitolo comprenderanno l'impostazione dei database e la progettazione degli schemi, il lavoro con SQLAlchemy, le migrazioni di database e la gestione delle operazioni di database durante lo streaming degli output dei modelli.</p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="id893"><sup><a href="ch06.html#id893-marker">1</a></sup> Gli aggressori possono utilizzare il cache poisoning per iniettare dati dannosi nei sistemi di caching, che poi servono dati errati agli utenti o ai sistemi. Per proteggersi da questo attacco, il client e il server mascherano i payload per farli apparire come dati casuali prima di inviarli.</p><p data-type="footnote" id="id894"><sup><a href="ch06.html#id894-marker">2</a></sup> Questi attacchi consistono nell'ingannare un server per far trapelare informazioni sensibili inviando una risposta HTTP a un frame WebSocket.</p><p data-type="footnote" id="id906"><sup><a href="ch06.html#id906-marker">3</a></sup> Per maggiori dettagli sull'<a href="https://oreil.ly/0yuKA">interfaccia<code translate="no">EventSource</code> </a>, consulta le risorse MDN.</p><p data-type="footnote" id="id909"><sup><a href="ch06.html#id909-marker">4</a></sup> Segui la <a href="https://oreil.ly/a7KeV">guida "Accesso ai modelli privati/garantiti"</a> per generare un token di accesso per l'utente di Hugging Face.</p><p data-type="footnote" id="id912"><sup><a href="ch06.html#id912-marker">5</a></sup> Gli aggressori utilizzano la vulnerabilità XSS per inserire script dannosi nelle pagine web, che vengono poi eseguiti dai browser degli altri utenti.</p><p data-type="footnote" id="id914"><sup><a href="ch06.html#id914-marker">6</a></sup> Il backoff esponenziale riduce le possibilità di errori di limitazione del tasso API aumentando il ritardo dopo ogni tentativo.</p></div></div></section></div></div></body></html>
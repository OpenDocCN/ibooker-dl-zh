["```py\ndef chunk_text(text, chunk_size, overlap, split_on_whitespace_only=True):   #1\n    chunks = []\n    index = 0\n\n    while index < len(text):\n        if split_on_whitespace_only:\n            prev_whitespace = 0\n            left_index = index - overlap\n            while left_index >= 0:\n                if text[left_index] == \" \":\n                    prev_whitespace = left_index\n                    break\n                left_index -= 1\n            next_whitespace = text.find(\" \", index + chunk_size)\n            if next_whitespace == -1:\n                next_whitespace = len(text)\n            chunk = text[prev_whitespace:next_whitespace].strip()\n            chunks.append(chunk)\n            index = next_whitespace + 1\n        else:\n            start = max(0, index - overlap + 1)\n            end = min(index + chunk_size + overlap, len(text))\n            chunk = text[start:end].strip()\n            chunks.append(chunk)\n            index += chunk_size\n\n    return chunks\n\nchunks = chunk_text(text, 500, 40)   #2\n\nprint(len(chunks)) # 89 chunks in total    #3\n```", "```py\ndef embed(texts):    #1\n    response = open_ai_client.embeddings.create(\n        input=texts,\n        model=\"text-embedding-3-small\",\n    )\n    return list(map(lambda n: n.embedding, response.data))\n\nembeddings = embed(chunks)       #2\n\nprint(len(embeddings)) # 89, matching the number of chunks    #3\nprint(len(embeddings[0])) # 1536 dimensions    #4\n```", "```py\ndriver.execute_query(\"\"\"CREATE VECTOR INDEX pdf IF NOT EXISTS\nFOR (c:Chunk)\nON c.embedding\"\"\")\n```", "```py\ncypher_query = '''\nWITH $chunks as chunks, range(0, size($chunks)) AS index\nUNWIND index AS i\nWITH i, chunks[i] AS chunk, $embeddings[i] AS embedding\nMERGE (c:Chunk {index: i})\nSET c.text = chunk, c.embedding = embedding\n'''\n\ndriver.execute_query(cypher_query, chunks=chunks, embeddings=embeddings)\n```", "```py\nrecords, _, _ = driver.execute_query(\n↪ \"MATCH (c:Chunk) WHERE c.index = 0 RETURN c.embedding, c.text\")\n\nprint(records[0][\"c.text\"][0:30])\nprint(records[0][\"c.embedding\"][0:3])\n```", "```py\nquestion = \"At what time was Einstein really interested↪\n↪ in experimental works?\"\nquestion_embedding = embed([question])[0]\n```", "```py\nquery = '''\nCALL db.index.vector.queryNodes('pdf', 2, $question_embedding) YIELD node↪\n↪ AS hits, score\nRETURN hits.text AS text, score, hits.index AS index\n'''\nsimilar_records, _, _ = driver.execute_query(query, question_embedding=question_embedding)\n```", "```py\nfor record in similar_records:\n    print(record[\"text\"])\n    print(record[\"score\"], record[\"index\"])\n    print(\"======\")\n\nupbringing, his interest in inventions and patents was not unusual.\nBeing a manufacturer’s son, Einstein grew upon in an environment of↪\n↪ machines and instruments.\nWhen his father’s company obtained the contract to illuminate Munich city↪\n↪ during beer festival, he\nwas actively engaged in execution of the contract. In his ETH days↪\n↪ Einstein was genuinely interested\nin experimental works. He wrote to his friend, “most of the time I worked↪\n↪ in the physical laboratory,\nfascinated by the direct contact with observation.” Einstein's\n0.8185358047485352 42\n======\ninstruments. However, it must also be\nemphasized that his main occupation was theoretical physics. The↪\n↪ inventions he worked upon were\nhis diversions. In his unproductive times he used to work upon on solving↪\n↪ mathematical problems (not\nrelated to his ongoing theoretical investigations) or took upon some↪\n↪ practical problem. As shown in\nTable. 2, Einstein was involved in three major inventions; (i)↪\n↪ refrigeration system with Leo Szilard, (ii)\nSound reproduction system with Rudolf Goldschmidt and (iii) automatic↪\n↪ camera\n0.7906564474105835 44\n======\n```", "```py\nsystem_message = \"You're an Einstein expert, but can only use the provided\n↪ documents to respond to the questions.\"\n\nuser_message = f\"\"\"\nUse the following documents to answer the question that will follow:\n{[doc[\"text\"] for doc in similar_records]}\n\n---\n\nThe question to answer using information only from the above documents:\n↪ {question}\n\"\"\"\n```", "```py\nprint(\"Question:\", question)\n\nstream = open_ai_client.chat.completions.create(\n    model=\"gpt-4\",\n    messages=[\n        {\"role\": \"system\", \"content\": system_message},\n        {\"role\": \"user\", \"content\": user_message}\n    ],\n    stream=True,\n)\nfor chunk in stream:\n    print(chunk.choices[0].delta.content or \"\", end=\"\")\n```", "```py\nQuestion: At what time was Einstein really interested in experimental works?\nDuring his ETH days, Einstein was genuinely interested in experimental works.\n```", "```py\ndriver.execute_query(\"CREATE FULLTEXT INDEX PdfChunkFulltext FOR (c:Chunk)\n↪ ON EACH [c.text]\")\n```", "```py\nhybrid_query = '''\nCALL {\n    // vector index\n    CALL db.index.vector.queryNodes('pdf', $k, $question_embedding)↪\n↪ YIELD node, score\n    WITH collect({node:node, score:score}) AS nodes, max(score) AS max\n    UNWIND nodes AS n\n    // Normalize scores\n    RETURN n.node AS node, (n.score / max) AS score\n    UNION\n    // keyword index\n    CALL db.index.fulltext.queryNodes('ftPdfChunk', $question, {limit: $k})\n    YIELD node, score\n    WITH collect({node:node, score:score}) AS nodes, max(score) AS max\n    UNWIND nodes AS n\n    // Normalize scores\n    RETURN n.node AS node, (n.score / max) AS score\n}\n// deduplicate nodes\nWITH node, max(score) AS score ORDER BY score DESC LIMIT $k\nRETURN node, score\n'''\n```", "```py\nsimilar_hybrid_records, _, _ = driver.execute_query(hybrid_query,\n↪ question_embedding=question_embedding, question=question, k=4)\n\nfor record in similar_hybrid_records:\n    print(record[\"node\"][\"text\"])\n    print(record[\"score\"], record[\"node\"][\"index\"])\n    print(\"======\")\n```", "```py\nCH-Switzerland\nConsidering Einstein’s upbringing, his interest in inventions and patents↪\n↪ was not unusual.\nBeing a manufacturer’s son, Einstein grew upon in an environment of↪\n↪ machines and instruments.\nWhen his father’s company obtained the contract to illuminate Munich city↪\n↪ during beer festival, he\nwas actively engaged in execution of the contract. In his ETH days↪\n↪ Einstein was genuinely interested\nin experimental works. He wrote to his friend, “most of the time I worked↪\n↪ in the physical laboratory,\nfascinated by the direct contact with observation.” Einstein's\n1.0 42\n======\nEinstein\nleft his job at the Patent office and joined the University of Zurich on↪\n↪ October 15, 1909\\. Thereafter, he\ncontinued to rise in ladder. In 1911, he moved to Prague University as a↪\n↪ full professor, a year later, he\nwas appointed as full professor at ETH, Zurich, his alma-mater. In 1914,↪\n↪ he was appointed Director of\nthe Kaiser Wilhelm Institute for Physics (1914–1932) and a professor at↪\n↪ the Humboldt University of\nBerlin, with a special clause in his contract that freed him from↪\n↪ teaching obligations. In the meantime,\nhe was working for\n0.9835733295862473 31\n======\n```"]
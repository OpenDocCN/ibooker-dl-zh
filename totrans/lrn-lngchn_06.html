<html><head></head><body><section data-pdf-bookmark="Chapter 6. Agent Architecture" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch06_agent_architecture_1736545671750341">
<h1><span class="label">Chapter 6. </span>Agent Architecture</h1>

<p>Building on the architectures described in <a data-type="xref" href="ch05.html#ch05_cognitive_architectures_with_langgraph_1736545670030774">Chapter 5</a>, this chapter will cover what is perhaps the most important of all current LLM architectures, the agent architecture. First, we introduce what makes LLM agents unique, then we show how to build them and how to extend them for common use cases.</p>

<p>In<a contenteditable="false" data-primary="agent architecture" data-secondary="unique aspects of" data-type="indexterm" id="id719"/> the artificial intelligence field, there is a long history of creating (intelligent) agents, which can be most simply defined as “something that acts,” in the words<a contenteditable="false" data-primary="Norvig, Peter" data-type="indexterm" id="id720"/><a contenteditable="false" data-primary="Russell, Stuart" data-type="indexterm" id="id721"/> of Stuart Russell and Peter Norvig in their <em>Artificial Intelligence</em> (Pearson, 2020) textbook. The word <em>acts</em> actually carries a little more meaning than meets the eye:</p>

<ul>
	<li>
	<p>Acting requires some capacity for deciding what to do.</p>
	</li>
	<li>
	<p>Deciding what to do implies having access to more than one possible course of action. After all, a decision without options is no decision at all.</p>
	</li>
	<li>
	<p>In order to decide, the agent also needs access to information about the external environment (anything outside of the agent itself).</p>
	</li>
</ul>

<p>So an<a contenteditable="false" data-primary="LLM applications" data-secondary="agentic" data-type="indexterm" id="id722"/> <em>agentic</em> LLM application must be one that uses an LLM to pick from one or more possible courses of action, given some context about the current state of the world or some desired next state. These attributes are usually implemented by mixing two prompting techniques we first met in the <a data-type="xref" href="preface01.html#pr01_preface_1736545679069216">Preface</a>:</p>

<dl>
	<dt>Tool calling</dt>
	<dd>
	<p>Include<a contenteditable="false" data-primary="tool-calling technique" data-secondary="agentic LLM applications and" data-type="indexterm" id="id723"/> a list of external functions that the LLM can make use of in your prompt (that is, the actions it can decide to take) and provide instructions on how to format its choice in the output it generates. You’ll see in a moment what this looks like in the prompt.</p>
	</dd>
	<dt>Chain-of-thought</dt>
	<dd>
	<p>Researchers<a contenteditable="false" data-primary="chain-of-thought (CoT) prompting" data-type="indexterm" id="id724"/> have found that LLMs “make better decisions” when given instructions to reason about complex problems by breaking them down into granular steps to be taken in sequence. This is usually done either by adding instructions along the lines of “think step by step” or including examples of questions and their decomposition into several steps/actions.</p>
	</dd>
</dl>

<p>Here’s an example prompt using both tool calling and chain-of-thought:</p>

<pre data-type="programlisting">
Tools:
search: this tool accepts a web search query and returns the top results.
calculator: this tool accepts math expressions and returns their result.

If you want to use tools to arrive at the answer, output the list of tools and
inputs in CSV format, with the header row: tool,input.

Think step by step; if you need to make multiple tool calls to arrive at the
answer, return only the first one.

How old was the 30th president of the United States when he died?

tool,input</pre>

<p>And the output, when run against <code>gpt-3.5-turbo</code> at temperature 0 (to ensure the LLM follows the desired output format, CSV) and newline as the stop sequence (which instructs the LLM to stop producing output when it reaches this character). This makes the LLM produce a single action (as expected, given the prompt asked for this):</p>

<pre data-type="programlisting">
search,30th president of the United States</pre>

<p>The most recent LLMs and chat models have been fine-tuned to improve their performance for tool-calling and chain-of-thought applications, removing the need for adding specific instructions to the prompt:</p>

<pre data-type="programlisting">
add example prompt and output for tool-calling model</pre>

<section data-pdf-bookmark="The Plan-Do Loop" data-type="sect1"><div class="sect1" id="ch06_the_plan_do_loop_1736545671750497">
<h1>The Plan-Do Loop</h1>

<p>What makes the<a contenteditable="false" data-primary="agent architecture" data-secondary="plan-do loop" data-type="indexterm" id="AAplando06"/><a contenteditable="false" data-primary="plan-do loop" data-type="indexterm" id="plando06"/> agent architecture different from the architectures discussed in <a data-type="xref" href="ch05.html#ch05_cognitive_architectures_with_langgraph_1736545670030774">Chapter 5</a> is a concept we haven’t covered yet: the<a contenteditable="false" data-primary="LLM-driven loop" data-type="indexterm" id="id725"/> LLM-driven loop.</p>

<p>Every programmer has encountered loops in their code before. By<a contenteditable="false" data-primary="loops" data-type="indexterm" id="id726"/> <em>loop</em>, we mean running the same code multiple times until a stop condition is hit. The key to the agent architecture is to have an LLM control the stop condition—that is, decide when to stop looping.</p>

<p class="pagebreak-before less_space">What we’ll run in this loop will be some variation of the following:</p>

<ul>
	<li>
	<p>Planning an action or actions</p>
	</li>
	<li>
	<p>Executing said action(s)</p>
	</li>
</ul>

<p>Picking up on the example in the previous section, we’ll next run the <code>search</code> tool with the input <code>30th president of the United States</code>, which produces this output:</p>

<pre data-type="programlisting">
Calvin Coolidge (born John Calvin Coolidge Jr.; /ˈkuːlɪdʒ/; July 4, 1872 – January 
5, 1933) was an American attorney and politician who served as the 30th president 
of the United States from 1923 to 1929. John Calvin Coolidge Jr.</pre>

<p>And then we’ll rerun the prompt, with a small addition:</p>

<pre data-type="programlisting">
Tools:
search: this tool accepts a web search query and returns the top results.
calculator: this tool accepts math expressions and returns their result.
output: this tool ends the interaction. Use it when you have the final answer.

If you want to use tools to arrive at the answer, output the list of tools and 
inputs in CSV format, with this header row: tool,input

Think step by step; if you need to make multiple tool calls to arrive at 
the answer, return only the first one.

How old was the 30th president of the United States when he died?

tool,input

search,30th president of the United States

search: Calvin Coolidge (born John Calvin Coolidge Jr.; /ˈkuːlɪdʒ/; July 4, 1872 – 
January 5, 1933) was an American attorney and politician who served as the 30th 
president of the United States from 1923 to 1929. John Calvin Coolidge Jr.

tool,input</pre>

<p>And the output:</p>

<pre data-type="programlisting">
calculator,1933 - 1872</pre>

<p>Notice we added two things:</p>

<ul>
	<li>
	<p>An “output” tool—which the LLM should use when it has found the final answer, and which we’d use as the signal to stop the loop.</p>
	</li>
	<li>
	<p>The result of the tool call from the preceding iteration, simply with the name of the tool and its (text) output. This is included in order to allow the LLM to move on to the next step in the interaction. In other words, we’re telling the LLM, “Hey, we got the results you asked for, what do you want to do next?”</p>
	</li>
</ul>

<p class="pagebreak-before less_space">Let’s continue with a third iteration:</p>

<pre data-type="programlisting">
Tools:
search: this tool accepts a web search query and returns the top results.
calculator: this tool accepts math expressions and returns their result.

If you want to use tools to arrive at the answer, output the list of tools and 
inputs in CSV format, with this header row: tool,input.
output: this tool ends the interaction. Use it when you have the final answer.

Think step by step; if you need to make multiple tool calls to arrive at 
the answer, return only the first one.

How old was the 30th president of the United States when he died?

tool,input

search,30th president of the United States

search: Calvin Coolidge (born John Calvin Coolidge Jr.; /ˈkuːlɪdʒ/; July 4, 1872 – 
January 5, 1933) was an American attorney and politician who served as the 30th 
president of the United States from 1923 to 1929. John Calvin Coolidge Jr.
tool,input

calculator,1933-1872

calculator: 61

tool, input</pre>

<p>And the output:</p>

<pre data-type="programlisting">
output, 61</pre>

<p>With the result from the <code>calculator</code> tool, the LLM now has enough information to provide the final answer, so it picked the <code>output</code> tool and chose “61” as the final answer.</p>

<p>This is what makes the agent architecture so useful—the LLM is given the<a contenteditable="false" data-primary="agency" data-type="indexterm" id="id727"/> agency to decide. The next step is to arrive at an answer and decide how many steps to take—that is, when to stop.</p>

<p>This architecture, called<a contenteditable="false" data-primary="architecture" data-secondary="ReAct architecture" data-type="indexterm" id="id728"/><a contenteditable="false" data-primary="ReAct architecture" data-type="indexterm" id="id729"/> <a href="https://oreil.ly/M7hF-">ReAct</a>, was first proposed by<a contenteditable="false" data-primary="Yao, Shunyu" data-type="indexterm" id="id730"/> Shunyu Yao et al. The rest of this chapter explores how to improve the performance of the agent architecture, motivated by the email assistant example from <a data-type="xref" href="ch05.html#ch05_cognitive_architectures_with_langgraph_1736545670030774">Chapter 5</a>.</p>

<p>But first, let’s see what it looks like to implement the basic agent architecture using a chat model and LangGraph.<a contenteditable="false" data-primary="" data-startref="AAplando06" data-type="indexterm" id="id731"/><a contenteditable="false" data-primary="" data-startref="plando06" data-type="indexterm" id="id732"/></p>
</div></section>

<section data-pdf-bookmark="Building a LangGraph Agent" data-type="sect1"><div class="sect1" id="ch06_building_a_langgraph_agent_1736545671750572">
<h1>Building a LangGraph Agent</h1>

<p>For<a contenteditable="false" data-primary="agent architecture" data-secondary="LangGraph agent creation" data-type="indexterm" id="AAlang06"/><a contenteditable="false" data-primary="LangGraph" data-secondary="building LangGraph agents" data-type="indexterm" id="LGlgagent06"/> this example, we need to install additional dependencies for the search tool we chose to<a contenteditable="false" data-primary="DuckDuckGo" data-type="indexterm" id="id733"/> use, DuckDuckGo. To install it for Python:</p>

<p><em>Python</em></p>

<pre data-code-language="python" data-type="programlisting">
<code class="n">pip</code> <code class="n">install</code> <code class="n">duckduckgo</code><code class="o">-</code><code class="n">search</code></pre>

<p>And for JS, we also need to install a dependency for the calculator tool:</p>

<p><em>JavaScript</em></p>

<pre data-code-language="javascript" data-type="programlisting">
<code class="nx">npm</code> <code class="nx">i</code> <code class="nx">duck</code><code class="o">-</code><code class="nx">duck</code><code class="o">-</code><code class="nx">scrape</code> <code class="nx">expr</code><code class="o">-</code><code class="nb">eval</code></pre>

<p class="fix_tracking">With that complete, let’s get into the actual code to implement the agent architecture:</p>

<p><em>Python<a contenteditable="false" data-primary="Python" data-secondary="agent architecture" data-tertiary="implementing" data-type="indexterm" id="id734"/></em></p>

<pre data-code-language="python" data-type="programlisting">
<code class="kn">import</code> <code class="nn">ast</code>
<code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Annotated</code><code class="p">,</code> <code class="n">TypedDict</code>

<code class="kn">from</code> <code class="nn">langchain_community.tools</code> <code class="kn">import</code> <code class="n">DuckDuckGoSearchRun</code>
<code class="kn">from</code> <code class="nn">langchain_core.tools</code> <code class="kn">import</code> <code class="n">tool</code>
<code class="kn">from</code> <code class="nn">langchain_openai</code> <code class="kn">import</code> <code class="n">ChatOpenAI</code>

<code class="kn">from</code> <code class="nn">langgraph.graph</code> <code class="kn">import</code> <code class="n">START</code><code class="p">,</code> <code class="n">StateGraph</code>
<code class="kn">from</code> <code class="nn">langgraph.graph.message</code> <code class="kn">import</code> <code class="n">add_messages</code>
<code class="kn">from</code> <code class="nn">langgraph.prebuilt</code> <code class="kn">import</code> <code class="n">ToolNode</code><code class="p">,</code> <code class="n">tools_condition</code>

<code class="nd">@tool</code>
<code class="k">def</code> <code class="nf">calculator</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">str</code><code class="p">:</code>
    <code class="sd">"""A simple calculator tool. Input should be a mathematical expression."""</code>
    <code class="k">return</code> <code class="n">ast</code><code class="o">.</code><code class="n">literal_eval</code><code class="p">(</code><code class="n">query</code><code class="p">)</code>

<code class="n">search</code> <code class="o">=</code> <code class="n">DuckDuckGoSearchRun</code><code class="p">()</code>
<code class="n">tools</code> <code class="o">=</code> <code class="p">[</code><code class="n">search</code><code class="p">,</code> <code class="n">calculator</code><code class="p">]</code>
<code class="n">model</code> <code class="o">=</code> <code class="n">ChatOpenAI</code><code class="p">(</code><code class="n">temperature</code><code class="o">=</code><code class="mf">0.1</code><code class="p">)</code><code class="o">.</code><code class="n">bind_tools</code><code class="p">(</code><code class="n">tools</code><code class="p">)</code>

<code class="k">class</code> <code class="nc">State</code><code class="p">(</code><code class="n">TypedDict</code><code class="p">):</code>
    <code class="n">messages</code><code class="p">:</code> <code class="n">Annotated</code><code class="p">[</code><code class="nb">list</code><code class="p">,</code> <code class="n">add_messages</code><code class="p">]</code>

<code class="k">def</code> <code class="nf">model_node</code><code class="p">(</code><code class="n">state</code><code class="p">:</code> <code class="n">State</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">State</code><code class="p">:</code>
    <code class="n">res</code> <code class="o">=</code> <code class="n">model</code><code class="o">.</code><code class="n">invoke</code><code class="p">(</code><code class="n">state</code><code class="p">[</code><code class="s2">"messages"</code><code class="p">])</code>
    <code class="k">return</code> <code class="p">{</code><code class="s2">"messages"</code><code class="p">:</code> <code class="n">res</code><code class="p">}</code>

<code class="n">builder</code> <code class="o">=</code> <code class="n">StateGraph</code><code class="p">(</code><code class="n">State</code><code class="p">)</code>
<code class="n">builder</code><code class="o">.</code><code class="n">add_node</code><code class="p">(</code><code class="s2">"model"</code><code class="p">,</code> <code class="n">model_node</code><code class="p">)</code>
<code class="n">builder</code><code class="o">.</code><code class="n">add_node</code><code class="p">(</code><code class="s2">"tools"</code><code class="p">,</code> <code class="n">ToolNode</code><code class="p">(</code><code class="n">tools</code><code class="p">))</code>
<code class="n">builder</code><code class="o">.</code><code class="n">add_edge</code><code class="p">(</code><code class="n">START</code><code class="p">,</code> <code class="s2">"model"</code><code class="p">)</code>
<code class="n">builder</code><code class="o">.</code><code class="n">add_conditional_edges</code><code class="p">(</code><code class="s2">"model"</code><code class="p">,</code> <code class="n">tools_condition</code><code class="p">)</code>
<code class="n">builder</code><code class="o">.</code><code class="n">add_edge</code><code class="p">(</code><code class="s2">"tools"</code><code class="p">,</code> <code class="s2">"model"</code><code class="p">)</code>

<code class="n">graph</code> <code class="o">=</code> <code class="n">builder</code><code class="o">.</code><code class="n">compile</code><code class="p">()</code></pre>

<p><em>JavaScript<a contenteditable="false" data-primary="JavaScript" data-secondary="agent architecture" data-tertiary="implementing" data-type="indexterm" id="id735"/></em></p>

<pre data-code-language="javascript" data-type="programlisting">
<code class="kr">import</code> <code class="p">{</code>
  <code class="nx">DuckDuckGoSearch</code>
<code class="p">}</code> <code class="nx">from</code> <code class="s2">"@langchain/community/tools/duckduckgo_search"</code><code class="p">;</code>
<code class="kr">import</code> <code class="p">{</code>
  <code class="nx">Calculator</code>
<code class="p">}</code> <code class="nx">from</code> <code class="s2">"@langchain/community/tools/calculator"</code><code class="p">;</code>
<code class="kr">import</code> <code class="p">{</code>
  <code class="nx">StateGraph</code><code class="p">,</code>
  <code class="nx">Annotation</code><code class="p">,</code>
  <code class="nx">messagesStateReducer</code><code class="p">,</code>
  <code class="nx">START</code><code class="p">,</code>
<code class="p">}</code> <code class="nx">from</code> <code class="s2">"@langchain/langgraph"</code><code class="p">;</code>
<code class="kr">import</code> <code class="p">{</code>
  <code class="nx">ToolNode</code><code class="p">,</code>
  <code class="nx">toolsCondition</code>
<code class="p">}</code> <code class="nx">from</code> <code class="s2">"@langchain/langgraph/prebuilt"</code><code class="p">;</code>

<code class="kr">const</code> <code class="nx">search</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">DuckDuckGoSearch</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">calculator</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Calculator</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">tools</code> <code class="o">=</code> <code class="p">[</code><code class="nx">search</code><code class="p">,</code> <code class="nx">calculator</code><code class="p">];</code>
<code class="kr">const</code> <code class="nx">model</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">ChatOpenAI</code><code class="p">({</code>
  <code class="nx">temperature</code><code class="o">:</code> <code class="mf">0.1</code>
<code class="p">}).</code><code class="nx">bindTools</code><code class="p">(</code><code class="nx">tools</code><code class="p">);</code>

<code class="kr">const</code> <code class="nx">annotation</code> <code class="o">=</code> <code class="nx">Annotation</code><code class="p">.</code><code class="nx">Root</code><code class="p">({</code>
  <code class="nx">messages</code><code class="o">:</code> <code class="nx">Annotation</code><code class="p">({</code>
    <code class="nx">reducer</code><code class="o">:</code> <code class="nx">messagesStateReducer</code><code class="p">,</code>
    <code class="k">default</code><code class="o">:</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">[]</code>
  <code class="p">}),</code>
<code class="p">});</code>

<code class="nx">async</code> <code class="kd">function</code> <code class="nx">modelNode</code><code class="p">(</code><code class="nx">state</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">res</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">model</code><code class="p">.</code><code class="nx">invoke</code><code class="p">(</code><code class="nx">state</code><code class="p">.</code><code class="nx">messages</code><code class="p">);</code>
  <code class="k">return</code> <code class="p">{</code> <code class="nx">messages</code><code class="o">:</code> <code class="nx">res</code> <code class="p">};</code>
<code class="p">}</code>

<code class="kr">const</code> <code class="nx">builder</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">StateGraph</code><code class="p">(</code><code class="nx">annotation</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">addNode</code><code class="p">(</code><code class="s2">"model"</code><code class="p">,</code> <code class="nx">modelNode</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">addNode</code><code class="p">(</code><code class="s2">"tools"</code><code class="p">,</code> <code class="k">new</code> <code class="nx">ToolNode</code><code class="p">(</code><code class="nx">tools</code><code class="p">))</code>
  <code class="p">.</code><code class="nx">addEdge</code><code class="p">(</code><code class="nx">START</code><code class="p">,</code> <code class="s2">"model"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">addConditionalEdges</code><code class="p">(</code><code class="s2">"model"</code><code class="p">,</code> <code class="nx">toolsCondition</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">addEdge</code><code class="p">(</code><code class="s2">"tools"</code><code class="p">,</code> <code class="s2">"model"</code><code class="p">);</code>

<code class="kr">const</code> <code class="nx">graph</code> <code class="o">=</code> <code class="nx">builder</code><code class="p">.</code><code class="nx">compile</code><code class="p">();</code></pre>

<p>The visual representation is shown in <a data-type="xref" href="#ch06_figure_1_1736545671744632">Figure 6-1</a>.</p>

<figure><div class="figure" id="ch06_figure_1_1736545671744632"><img alt="A diagram of a model  Description automatically generated" src="assets/lelc_0601.png"/>
<h6><span class="label">Figure 6-1. </span>The agent architecture</h6>
</div></figure>

<p>A few things to notice here:</p>

<ul>
	<li>
	<p>We’re using two tools in this example: a search tool and a calculator tool, but you could easily add more or replace the ones we used. In the Python example, you also see an example of creating a custom tool.</p>
	</li>
	<li>
	<p>We’ve used two convenience functions that ship with LangGraph. <code>ToolNode</code> serves as a node in our graph; it executes the tool calls requested in the latest AI message found in the state and returns a <code>ToolMessage</code> with the results of each. <code>ToolNode</code> also handles exceptions raised by tools—using the error message to build a <code>ToolMessage</code> that is then passed to the LLM—which may decide what to do with the error.</p>
	</li>
	<li>
	<p><code>tools_condition</code> serves as a conditional edge function that looks at the latest AI message in the state and routes to the <code>tools</code> node if there are any tools to execute. Otherwise, it ends the graph.</p>
	</li>
	<li>
	<p>Finally, notice that this graph loops between the model and tools nodes. That is, the model itself is in charge of deciding when to end the computation, which is a key attribute of the agent architecture. Whenever we code a loop in LangGraph, we’ll likely want to use a conditional edge, as that allows you to define the <em>stop condition</em> when the graph should exit the loop and stop executing.</p>
	</li>
</ul>

<p>Now let’s see how it does in the previous example:</p>

<p><em>Python</em></p>

<pre data-code-language="python" data-type="programlisting">
<code class="nb">input</code> <code class="o">=</code> <code class="p">{</code>
    <code class="s2">"messages"</code><code class="p">:</code> <code class="p">[</code>
        <code class="n">HumanMessage</code><code class="p">(</code><code class="s2">"""How old was the 30th president of the United States </code>
<code class="s2">            when he died?"""</code><code class="p">)</code>
    <code class="p">]</code>
<code class="p">}</code>
<code class="k">for</code> <code class="n">c</code> <code class="ow">in</code> <code class="n">graph</code><code class="o">.</code><code class="n">stream</code><code class="p">(</code><code class="nb">input</code><code class="p">):</code>
    <code class="nb">print</code><code class="p">(</code><code class="n">c</code><code class="p">)</code></pre>

<p><em>JavaScript</em></p>

<pre data-code-language="javascript" data-type="programlisting">
<code class="kr">const</code> <code class="nx">input</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">messages</code><code class="o">:</code> <code class="p">[</code>
    <code class="nx">HumanMessage</code><code class="p">(</code><code class="sb">`How old was the 30th president of the United States when he </code>
<code class="sb">      died?`</code><code class="p">)</code>
  <code class="p">]</code>
<code class="p">}</code>
<code class="k">for</code> <code class="nx">await</code> <code class="p">(</code><code class="kr">const</code> <code class="nx">c</code> <code class="k">of</code> <code class="nx">await</code> <code class="nx">graph</code><code class="p">.</code><code class="nx">stream</code><code class="p">(</code><code class="nx">input</code><code class="p">))</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">c</code><code class="p">)</code>
<code class="p">}</code></pre>

<p><em>The output:</em></p>

<pre data-type="programlisting">
{
    "model": {
        "messages": AIMessage(
            content="",
            tool_calls=[
                {
                    "name": "duckduckgo_search",
                    "args": {
                        "query": "30th president of the United States age at 
                            death"
                    },
                    "id": "call_ZWRbPmjvo0fYkwyo4HCYUsar",
                    "type": "tool_call",
                }
            ],
        )
    }
}
{
    "tools": {
        "messages": [
            ToolMessage(
                content="Calvin Coolidge (born July 4, 1872, Plymouth, Vermont, 
                    U.S.—died January 5, 1933, Northampton, Massachusetts) was 
                    the 30th president of the United States (1923-29). Coolidge 
                    acceded to the presidency after the death in office of 
                    Warren G. Harding, just as the Harding scandals were coming 
                    to light....",
                name="duckduckgo_search",
                tool_call_id="call_ZWRbPmjvo0fYkwyo4HCYUsar",
            )
        ]
    }
}
{
    "model": {
        "messages": AIMessage(
            content="Calvin Coolidge, the 30th president of the United States, 
                died on January 5, 1933, at the age of 60.",
        )
    }
}</pre>

<p>Walking through this output:</p>

<ol>
	<li>
	<p>First the <code>model</code> node executed and decided to call the <code>duckduckgo_search</code> tool, which led the conditional edge to route us to the <code>tools</code> node after.</p>
	</li>
	<li>
	<p>The <code>ToolNode</code> executed the search tool and got the search results printed above, which actually contain the answer “Age and Year of Death . January 5, 1933 (aged 60)”.</p>
	</li>
	<li>
	<p>The <code>model</code> tool was called again, this time with the search results as the latest message, and produced the final answer (with no more tool calls); therefore, the conditional edge ended the graph.</p>
	</li>
</ol>

<p>Next, let’s look at a few useful extensions to this basic agent architecture, customizing both planning and tool calling.<a contenteditable="false" data-primary="" data-startref="AAlang06" data-type="indexterm" id="id736"/><a contenteditable="false" data-primary="" data-startref="LGlgagent06" data-type="indexterm" id="id737"/></p>
</div></section>

<section data-pdf-bookmark="Always Calling a Tool First" data-type="sect1"><div class="sect1" id="ch06_always_calling_a_tool_first_1736545671750641">
<h1>Always Calling a Tool First</h1>

<p>In<a contenteditable="false" data-primary="agent architecture" data-secondary="always calling tools first" data-type="indexterm" id="AAalways06"/><a contenteditable="false" data-primary="tool-calling technique" data-secondary="always calling tools first" data-type="indexterm" id="TCTalways06"/> the standard agent architecture, the LLM is always called upon to decide what tool to call next. This arrangement has a clear advantage: it gives the LLM ultimate flexibility to adapt the behavior of the application to each user query that comes in. But this flexibility comes at a cost: unpredictability. If, for instance, you, the developer of the application, know that the search tool should always be called first, that can actually be beneficial to your application:</p>

<ol>
	<li>
	<p>It will reduce overall latency, as it will skip the first LLM call that would generate that request to call the search tool.</p>
	</li>
	<li>
	<p>It will prevent the LLM from erroneously deciding it doesn’t need to call the search tool for some user queries.</p>
	</li>
</ol>

<p>On the other hand, if your application doesn’t have a clear rule of the kind “you should always call this tool first,” introducing such a constraint would actually make your application worse.</p>

<p>Let’s see what it looks like to do this:</p>

<p><em>Python<a contenteditable="false" data-primary="Python" data-secondary="tools" data-tertiary="always calling first" data-type="indexterm" id="id738"/></em></p>

<pre data-code-language="python" data-type="programlisting">
<code class="kn">import</code> <code class="nn">ast</code>
<code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Annotated</code><code class="p">,</code> <code class="n">TypedDict</code>
<code class="kn">from</code> <code class="nn">uuid</code> <code class="kn">import</code> <code class="n">uuid4</code>

<code class="kn">from</code> <code class="nn">langchain_community.tools</code> <code class="kn">import</code> <code class="n">DuckDuckGoSearchRun</code>
<code class="kn">from</code> <code class="nn">langchain_core.messages</code> <code class="kn">import</code> <code class="n">AIMessage</code><code class="p">,</code> <code class="n">HumanMessage</code><code class="p">,</code> <code class="n">ToolCall</code>
<code class="kn">from</code> <code class="nn">langchain_core.tools</code> <code class="kn">import</code> <code class="n">tool</code>
<code class="kn">from</code> <code class="nn">langchain_openai</code> <code class="kn">import</code> <code class="n">ChatOpenAI</code>

<code class="kn">from</code> <code class="nn">langgraph.graph</code> <code class="kn">import</code> <code class="n">START</code><code class="p">,</code> <code class="n">StateGraph</code>
<code class="kn">from</code> <code class="nn">langgraph.graph.message</code> <code class="kn">import</code> <code class="n">add_messages</code>
<code class="kn">from</code> <code class="nn">langgraph.prebuilt</code> <code class="kn">import</code> <code class="n">ToolNode</code><code class="p">,</code> <code class="n">tools_condition</code>

<code class="nd">@tool</code>
<code class="k">def</code> <code class="nf">calculator</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">str</code><code class="p">:</code>
    <code class="sd">"""A simple calculator tool. Input should be a mathematical expression."""</code>
    <code class="k">return</code> <code class="n">ast</code><code class="o">.</code><code class="n">literal_eval</code><code class="p">(</code><code class="n">query</code><code class="p">)</code>

<code class="n">search</code> <code class="o">=</code> <code class="n">DuckDuckGoSearchRun</code><code class="p">()</code>
<code class="n">tools</code> <code class="o">=</code> <code class="p">[</code><code class="n">search</code><code class="p">,</code> <code class="n">calculator</code><code class="p">]</code>
<code class="n">model</code> <code class="o">=</code> <code class="n">ChatOpenAI</code><code class="p">(</code><code class="n">temperature</code><code class="o">=</code><code class="mf">0.1</code><code class="p">)</code><code class="o">.</code><code class="n">bind_tools</code><code class="p">(</code><code class="n">tools</code><code class="p">)</code>

<code class="k">class</code> <code class="nc">State</code><code class="p">(</code><code class="n">TypedDict</code><code class="p">):</code>
    <code class="n">messages</code><code class="p">:</code> <code class="n">Annotated</code><code class="p">[</code><code class="nb">list</code><code class="p">,</code> <code class="n">add_messages</code><code class="p">]</code>

<code class="k">def</code> <code class="nf">model_node</code><code class="p">(</code><code class="n">state</code><code class="p">:</code> <code class="n">State</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">State</code><code class="p">:</code>
    <code class="n">res</code> <code class="o">=</code> <code class="n">model</code><code class="o">.</code><code class="n">invoke</code><code class="p">(</code><code class="n">state</code><code class="p">[</code><code class="s2">"messages"</code><code class="p">])</code>
    <code class="k">return</code> <code class="p">{</code><code class="s2">"messages"</code><code class="p">:</code> <code class="n">res</code><code class="p">}</code>

<code class="k">def</code> <code class="nf">first_model</code><code class="p">(</code><code class="n">state</code><code class="p">:</code> <code class="n">State</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">State</code><code class="p">:</code>
    <code class="n">query</code> <code class="o">=</code> <code class="n">state</code><code class="p">[</code><code class="s2">"messages"</code><code class="p">][</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code class="o">.</code><code class="n">content</code>
    <code class="n">search_tool_call</code> <code class="o">=</code> <code class="n">ToolCall</code><code class="p">(</code>
        <code class="n">name</code><code class="o">=</code><code class="s2">"duckduckgo_search"</code><code class="p">,</code> <code class="n">args</code><code class="o">=</code><code class="p">{</code><code class="s2">"query"</code><code class="p">:</code> <code class="n">query</code><code class="p">},</code> <code class="nb">id</code><code class="o">=</code><code class="n">uuid4</code><code class="p">()</code><code class="o">.</code><code class="n">hex</code>
    <code class="p">)</code>
    <code class="k">return</code> <code class="p">{</code><code class="s2">"messages"</code><code class="p">:</code> <code class="n">AIMessage</code><code class="p">(</code><code class="n">content</code><code class="o">=</code><code class="s2">""</code><code class="p">,</code> <code class="n">tool_calls</code><code class="o">=</code><code class="p">[</code><code class="n">search_tool_call</code><code class="p">])}</code>

<code class="n">builder</code> <code class="o">=</code> <code class="n">StateGraph</code><code class="p">(</code><code class="n">State</code><code class="p">)</code>
<code class="n">builder</code><code class="o">.</code><code class="n">add_node</code><code class="p">(</code><code class="s2">"first_model"</code><code class="p">,</code> <code class="n">first_model</code><code class="p">)</code>
<code class="n">builder</code><code class="o">.</code><code class="n">add_node</code><code class="p">(</code><code class="s2">"model"</code><code class="p">,</code> <code class="n">model_node</code><code class="p">)</code>
<code class="n">builder</code><code class="o">.</code><code class="n">add_node</code><code class="p">(</code><code class="s2">"tools"</code><code class="p">,</code> <code class="n">ToolNode</code><code class="p">(</code><code class="n">tools</code><code class="p">))</code>
<code class="n">builder</code><code class="o">.</code><code class="n">add_edge</code><code class="p">(</code><code class="n">START</code><code class="p">,</code> <code class="s2">"first_model"</code><code class="p">)</code>
<code class="n">builder</code><code class="o">.</code><code class="n">add_edge</code><code class="p">(</code><code class="s2">"first_model"</code><code class="p">,</code> <code class="s2">"tools"</code><code class="p">)</code>
<code class="n">builder</code><code class="o">.</code><code class="n">add_conditional_edges</code><code class="p">(</code><code class="s2">"model"</code><code class="p">,</code> <code class="n">tools_condition</code><code class="p">)</code>
<code class="n">builder</code><code class="o">.</code><code class="n">add_edge</code><code class="p">(</code><code class="s2">"tools"</code><code class="p">,</code> <code class="s2">"model"</code><code class="p">)</code>

<code class="n">graph</code> <code class="o">=</code> <code class="n">builder</code><code class="o">.</code><code class="n">compile</code><code class="p">()</code></pre>

<p><em>JavaScript<a contenteditable="false" data-primary="JavaScript" data-secondary="tools" data-tertiary="always calling first" data-type="indexterm" id="id739"/></em></p>

<pre data-code-language="javascript" data-type="programlisting">
<code class="kr">import</code> <code class="p">{</code>
  <code class="nx">DuckDuckGoSearch</code>
<code class="p">}</code> <code class="nx">from</code> <code class="s2">"@langchain/community/tools/duckduckgo_search"</code><code class="p">;</code>
<code class="kr">import</code> <code class="p">{</code>
  <code class="nx">Calculator</code>
<code class="p">}</code> <code class="nx">from</code> <code class="s2">"@langchain/community/tools/calculator"</code><code class="p">;</code>
<code class="kr">import</code> <code class="p">{</code>
  <code class="nx">AIMessage</code><code class="p">,</code>
<code class="p">}</code> <code class="nx">from</code> <code class="s2">"@langchain/core/messages"</code><code class="p">;</code>
<code class="kr">import</code> <code class="p">{</code>
  <code class="nx">StateGraph</code><code class="p">,</code>
  <code class="nx">Annotation</code><code class="p">,</code>
  <code class="nx">messagesStateReducer</code><code class="p">,</code>
  <code class="nx">START</code><code class="p">,</code>
<code class="p">}</code> <code class="nx">from</code> <code class="s2">"@langchain/langgraph"</code><code class="p">;</code>
<code class="kr">import</code> <code class="p">{</code>
  <code class="nx">ToolNode</code><code class="p">,</code>
  <code class="nx">toolsCondition</code>
<code class="p">}</code> <code class="nx">from</code> <code class="s2">"@langchain/langgraph/prebuilt"</code><code class="p">;</code>

<code class="kr">const</code> <code class="nx">search</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">DuckDuckGoSearch</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">calculator</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Calculator</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">tools</code> <code class="o">=</code> <code class="p">[</code><code class="nx">search</code><code class="p">,</code> <code class="nx">calculator</code><code class="p">];</code>
<code class="kr">const</code> <code class="nx">model</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">ChatOpenAI</code><code class="p">({</code> <code class="nx">temperature</code><code class="o">:</code> <code class="mf">0.1</code> <code class="p">}).</code><code class="nx">bindTools</code><code class="p">(</code><code class="nx">tools</code><code class="p">);</code>

<code class="kr">const</code> <code class="nx">annotation</code> <code class="o">=</code> <code class="nx">Annotation</code><code class="p">.</code><code class="nx">Root</code><code class="p">({</code>
  <code class="nx">messages</code><code class="o">:</code> <code class="nx">Annotation</code><code class="p">({</code> <code class="nx">reducer</code><code class="o">:</code> <code class="nx">messagesStateReducer</code><code class="p">,</code> <code class="k">default</code><code class="o">:</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">[]</code> <code class="p">}),</code>
<code class="p">});</code>

<code class="nx">async</code> <code class="kd">function</code> <code class="nx">firstModelNode</code><code class="p">(</code><code class="nx">state</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">query</code> <code class="o">=</code> <code class="nx">state</code><code class="p">.</code><code class="nx">messages</code><code class="p">[</code><code class="nx">state</code><code class="p">.</code><code class="nx">messages</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="mi">1</code><code class="p">].</code><code class="nx">content</code><code class="p">;</code>
  <code class="kr">const</code> <code class="nx">searchToolCall</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">name</code><code class="o">:</code> <code class="s2">"duckduckgo_search"</code><code class="p">,</code>
    <code class="nx">args</code><code class="o">:</code> <code class="p">{</code> <code class="nx">query</code> <code class="p">},</code>
    <code class="nx">id</code><code class="o">:</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">().</code><code class="nx">toString</code><code class="p">(),</code>
  <code class="p">};</code>
  <code class="k">return</code> <code class="p">{</code>
    <code class="nx">messages</code><code class="o">:</code> <code class="p">[</code><code class="k">new</code> <code class="nx">AIMessage</code><code class="p">({</code> <code class="nx">content</code><code class="o">:</code> <code class="s2">""</code><code class="p">,</code> <code class="nx">tool_calls</code><code class="o">:</code> <code class="p">[</code><code class="nx">searchToolCall</code><code class="p">]</code> <code class="p">})],</code>
  <code class="p">};</code>
<code class="p">}</code>

<code class="nx">async</code> <code class="kd">function</code> <code class="nx">modelNode</code><code class="p">(</code><code class="nx">state</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">res</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">model</code><code class="p">.</code><code class="nx">invoke</code><code class="p">(</code><code class="nx">state</code><code class="p">.</code><code class="nx">messages</code><code class="p">);</code>
  <code class="k">return</code> <code class="p">{</code> <code class="nx">messages</code><code class="o">:</code> <code class="nx">res</code> <code class="p">};</code>
<code class="p">}</code>

<code class="kr">const</code> <code class="nx">builder</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">StateGraph</code><code class="p">(</code><code class="nx">annotation</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">addNode</code><code class="p">(</code><code class="s2">"first_model"</code><code class="p">,</code> <code class="nx">firstModelNode</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">addNode</code><code class="p">(</code><code class="s2">"model"</code><code class="p">,</code> <code class="nx">modelNode</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">addNode</code><code class="p">(</code><code class="s2">"tools"</code><code class="p">,</code> <code class="k">new</code> <code class="nx">ToolNode</code><code class="p">(</code><code class="nx">tools</code><code class="p">))</code>
  <code class="p">.</code><code class="nx">addEdge</code><code class="p">(</code><code class="nx">START</code><code class="p">,</code> <code class="s2">"first_model"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">addEdge</code><code class="p">(</code><code class="s2">"first_model"</code><code class="p">,</code> <code class="s2">"tools"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">addEdge</code><code class="p">(</code><code class="s2">"tools"</code><code class="p">,</code> <code class="s2">"model"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">addConditionalEdges</code><code class="p">(</code><code class="s2">"model"</code><code class="p">,</code> <code class="nx">toolsCondition</code><code class="p">);</code>

<code class="kr">const</code> <code class="nx">graph</code> <code class="o">=</code> <code class="nx">builder</code><code class="p">.</code><code class="nx">compile</code><code class="p">();</code></pre>

<p>The visual representation is shown in <a data-type="xref" href="#ch06_figure_2_1736545671744669">Figure 6-2</a>.</p>

<figure><div class="figure" id="ch06_figure_2_1736545671744669"><img alt="A diagram of a model  Description automatically generated" src="assets/lelc_0602.png"/>
<h6><span class="label">Figure 6-2. </span>Modifying the agent architecture to always call a specific tool first</h6>
</div></figure>

<p>Notice the differences compared to the previous section:</p>

<ul>
	<li>
	<p>Now, we start all invocations by calling <code>first_model</code>, which doesn’t call an LLM at all. It just creates a tool call for the search tool, using the user’s message verbatim as the search query. The previous architecture would have the LLM generate this tool call (or some other response it deemed better).</p>
	</li>
	<li>
	<p>After that, we proceed to <code>tools</code>, which is identical to the previous example, and from there we proceed to the <code>agent</code> node as before.</p>
	</li>
</ul>

<p>Now let’s see some example output, for the same query as before:</p>

<p><em>Python</em></p>

<pre data-code-language="python" data-type="programlisting">
<code class="nb">input</code> <code class="o">=</code> <code class="p">{</code>
    <code class="s2">"messages"</code><code class="p">:</code> <code class="p">[</code>
        <code class="n">HumanMessage</code><code class="p">(</code><code class="s2">"""How old was the 30th president of the United States </code>
<code class="s2">            when he died?"""</code><code class="p">)</code>
    <code class="p">]</code>
<code class="p">}</code>
<code class="k">for</code> <code class="n">c</code> <code class="ow">in</code> <code class="n">graph</code><code class="o">.</code><code class="n">stream</code><code class="p">(</code><code class="nb">input</code><code class="p">):</code>
<code class="nb">print</code><code class="p">(</code><code class="n">c</code><code class="p">)</code></pre>

<p><em>JavaScript</em></p>

<pre data-code-language="javascript" data-type="programlisting">
<code class="kr">const</code> <code class="nx">input</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">messages</code><code class="o">:</code> <code class="p">[</code>
    <code class="nx">HumanMessage</code><code class="p">(</code><code class="sb">`How old was the 30th president of the United States when he </code>
<code class="sb">        died?`</code><code class="p">)</code>
  <code class="p">]</code>
<code class="p">}</code>
<code class="k">for</code> <code class="nx">await</code> <code class="p">(</code><code class="kr">const</code> <code class="nx">c</code> <code class="k">of</code> <code class="nx">await</code> <code class="nx">graph</code><code class="p">.</code><code class="nx">stream</code><code class="p">(</code><code class="nx">input</code><code class="p">))</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">c</code><code class="p">)</code>
<code class="p">}</code></pre>

<p><em>The output:</em></p>

<pre data-type="programlisting">
{
    "first_model": {
        "messages": AIMessage(
            content="",
            tool_calls=[
                {
                    "name": "duckduckgo_search",
                    "args": {
                        "query": "How old was the 30th president of the United 
                            States when he died?"
                    },
                    "id": "9ed4328dcdea4904b1b54487e343a373",
                    "type": "tool_call",
                }
            ],
        )
    }
}
{
    "tools": {
        "messages": [
            ToolMessage(
                content="Calvin Coolidge (born July 4, 1872, Plymouth, Vermont, 
                    U.S.—died January 5, 1933, Northampton, Massachusetts) was 
                    the 30th president of the United States (1923-29). Coolidge 
                    acceded to the presidency after the death in office of 
                    Warren G. Harding, just as the Harding scandals were coming 
                    to light....",
                name="duckduckgo_search",
                tool_call_id="9ed4328dcdea4904b1b54487e343a373",
            )
        ]
    }
}
{
    "model": {
        "messages": AIMessage(
            content="Calvin Coolidge, the 30th president of the United States, 
                was born on July 4, 1872, and died on January 5, 1933. To 
                calculate his age at the time of his death, we can subtract his 
                birth year from his death year. \n\nAge at death = Death year - 
                Birth year\nAge at death = 1933 - 1872\nAge at death = 61 
                years\n\nCalvin Coolidge was 61 years old when he died.",
        )
    }
}</pre>

<p>This time, we skipped the initial LLM call. We first went to <code>first_model</code> node, which directly returned a tool call for the search tool. From there we went to the previous flow—that is, we executed the search tool and finally went back to the <code>model</code> node to generate the final answer.</p>

<p>Next let’s go over what you can do when you have many tools you want to make available to the LLM.<a contenteditable="false" data-primary="" data-startref="AAalways06" data-type="indexterm" id="id740"/><a contenteditable="false" data-primary="" data-startref="TCTalways06" data-type="indexterm" id="id741"/></p>
</div></section>

<section data-pdf-bookmark="Dealing with Many Tools" data-type="sect1"><div class="sect1" id="ch06_dealing_with_many_tools_1736545671750712">
<h1>Dealing with Many Tools</h1>

<p>LLMs are<a contenteditable="false" data-primary="agent architecture" data-secondary="dealing with many tools" data-type="indexterm" id="AAmanytools06"/><a contenteditable="false" data-primary="tool-calling technique" data-secondary="dealing with many tools" data-type="indexterm" id="TCTmany06"/> far from perfect, and they currently struggle more when given multiple choices or excessive information in a prompt. These limitations also extend to the planning of the next action to take. When given many tools (say, more than 10) the planning performance (that is, the LLM’s ability to choose the right tool) starts to suffer. The solution to this problem is to reduce the number of tools the LLM can choose from. But what if you do have many tools you want to see used for different user queries?</p>

<p>One elegant solution is to use a RAG step to preselect the most relevant tools for the current query and then feed the LLM only that subset of tools instead of the entire arsenal. This can also help to reduce the cost of calling the LLM (commercial LLMs usually charge based on the length of the prompt and outputs). On the other hand, this RAG step introduces additional latency to your application, so should only be taken when you see performance decreasing after adding more tools.</p>

<p>Let’s see how to do this:</p>

<p><em>Python<a contenteditable="false" data-primary="Python" data-secondary="tools" data-tertiary="dealing with many" data-type="indexterm" id="id742"/></em></p>

<pre data-code-language="python" data-type="programlisting">
<code class="kn">import</code> <code class="nn">ast</code>
<code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Annotated</code><code class="p">,</code> <code class="n">TypedDict</code>

<code class="kn">from</code> <code class="nn">langchain_community.tools</code> <code class="kn">import</code> <code class="n">DuckDuckGoSearchRun</code>
<code class="kn">from</code> <code class="nn">langchain_core.documents</code> <code class="kn">import</code> <code class="n">Document</code>
<code class="kn">from</code> <code class="nn">langchain_core.messages</code> <code class="kn">import</code> <code class="n">HumanMessage</code>
<code class="kn">from</code> <code class="nn">langchain_core.tools</code> <code class="kn">import</code> <code class="n">tool</code>
<code class="kn">from</code> <code class="nn">langchain_core.vectorstores.in_memory</code> <code class="kn">import</code> <code class="n">InMemoryVectorStore</code>
<code class="kn">from</code> <code class="nn">langchain_openai</code> <code class="kn">import</code> <code class="n">ChatOpenAI</code><code class="p">,</code> <code class="n">OpenAIEmbeddings</code>

<code class="kn">from</code> <code class="nn">langgraph.graph</code> <code class="kn">import</code> <code class="n">START</code><code class="p">,</code> <code class="n">StateGraph</code>
<code class="kn">from</code> <code class="nn">langgraph.graph.message</code> <code class="kn">import</code> <code class="n">add_messages</code>
<code class="kn">from</code> <code class="nn">langgraph.prebuilt</code> <code class="kn">import</code> <code class="n">ToolNode</code><code class="p">,</code> <code class="n">tools_condition</code>

<code class="nd">@tool</code>
<code class="k">def</code> <code class="nf">calculator</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">str</code><code class="p">:</code>
    <code class="sd">"""A simple calculator tool. Input should be a mathematical expression."""</code>
    <code class="k">return</code> <code class="n">ast</code><code class="o">.</code><code class="n">literal_eval</code><code class="p">(</code><code class="n">query</code><code class="p">)</code>

<code class="n">search</code> <code class="o">=</code> <code class="n">DuckDuckGoSearchRun</code><code class="p">()</code>
<code class="n">tools</code> <code class="o">=</code> <code class="p">[</code><code class="n">search</code><code class="p">,</code> <code class="n">calculator</code><code class="p">]</code>

<code class="n">embeddings</code> <code class="o">=</code> <code class="n">OpenAIEmbeddings</code><code class="p">()</code>
<code class="n">model</code> <code class="o">=</code> <code class="n">ChatOpenAI</code><code class="p">(</code><code class="n">temperature</code><code class="o">=</code><code class="mf">0.1</code><code class="p">)</code>

<code class="n">tools_retriever</code> <code class="o">=</code> <code class="n">InMemoryVectorStore</code><code class="o">.</code><code class="n">from_documents</code><code class="p">(</code>
    <code class="p">[</code><code class="n">Document</code><code class="p">(</code><code class="n">tool</code><code class="o">.</code><code class="n">description</code><code class="p">,</code> <code class="n">metadata</code><code class="o">=</code><code class="p">{</code><code class="s2">"name"</code><code class="p">:</code> <code class="n">tool</code><code class="o">.</code><code class="n">name</code><code class="p">})</code> <code class="k">for</code> <code class="n">tool</code> <code class="ow">in</code> <code class="n">tools</code><code class="p">],</code>
    <code class="n">embeddings</code><code class="p">,</code>
<code class="p">)</code><code class="o">.</code><code class="n">as_retriever</code><code class="p">()</code>

<code class="k">class</code> <code class="nc">State</code><code class="p">(</code><code class="n">TypedDict</code><code class="p">):</code>
    <code class="n">messages</code><code class="p">:</code> <code class="n">Annotated</code><code class="p">[</code><code class="nb">list</code><code class="p">,</code> <code class="n">add_messages</code><code class="p">]</code>
    <code class="n">selected_tools</code><code class="p">:</code> <code class="nb">list</code><code class="p">[</code><code class="nb">str</code><code class="p">]</code>

<code class="k">def</code> <code class="nf">model_node</code><code class="p">(</code><code class="n">state</code><code class="p">:</code> <code class="n">State</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">State</code><code class="p">:</code>
    <code class="n">selected_tools</code> <code class="o">=</code> <code class="p">[</code>
        <code class="n">tool</code> <code class="k">for</code> <code class="n">tool</code> <code class="ow">in</code> <code class="n">tools</code> <code class="k">if</code> <code class="n">tool</code><code class="o">.</code><code class="n">name</code> <code class="ow">in</code> <code class="n">state</code><code class="p">[</code><code class="s2">"selected_tools"</code><code class="p">]</code>
    <code class="p">]</code>
    <code class="n">res</code> <code class="o">=</code> <code class="n">model</code><code class="o">.</code><code class="n">bind_tools</code><code class="p">(</code><code class="n">selected_tools</code><code class="p">)</code><code class="o">.</code><code class="n">invoke</code><code class="p">(</code><code class="n">state</code><code class="p">[</code><code class="s2">"messages"</code><code class="p">])</code>
    <code class="k">return</code> <code class="p">{</code><code class="s2">"messages"</code><code class="p">:</code> <code class="n">res</code><code class="p">}</code>

<code class="k">def</code> <code class="nf">select_tools</code><code class="p">(</code><code class="n">state</code><code class="p">:</code> <code class="n">State</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">State</code><code class="p">:</code>
    <code class="n">query</code> <code class="o">=</code> <code class="n">state</code><code class="p">[</code><code class="s2">"messages"</code><code class="p">][</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code class="o">.</code><code class="n">content</code>
    <code class="n">tool_docs</code> <code class="o">=</code> <code class="n">tools_retriever</code><code class="o">.</code><code class="n">invoke</code><code class="p">(</code><code class="n">query</code><code class="p">)</code>
    <code class="k">return</code> <code class="p">{</code><code class="s2">"selected_tools"</code><code class="p">:</code> <code class="p">[</code><code class="n">doc</code><code class="o">.</code><code class="n">metadata</code><code class="p">[</code><code class="s2">"name"</code><code class="p">]</code> <code class="k">for</code> <code class="n">doc</code> <code class="ow">in</code> <code class="n">tool_docs</code><code class="p">]}</code>

<code class="n">builder</code> <code class="o">=</code> <code class="n">StateGraph</code><code class="p">(</code><code class="n">State</code><code class="p">)</code>
<code class="n">builder</code><code class="o">.</code><code class="n">add_node</code><code class="p">(</code><code class="s2">"select_tools"</code><code class="p">,</code> <code class="n">select_tools</code><code class="p">)</code>
<code class="n">builder</code><code class="o">.</code><code class="n">add_node</code><code class="p">(</code><code class="s2">"model"</code><code class="p">,</code> <code class="n">model_node</code><code class="p">)</code>
<code class="n">builder</code><code class="o">.</code><code class="n">add_node</code><code class="p">(</code><code class="s2">"tools"</code><code class="p">,</code> <code class="n">ToolNode</code><code class="p">(</code><code class="n">tools</code><code class="p">))</code>
<code class="n">builder</code><code class="o">.</code><code class="n">add_edge</code><code class="p">(</code><code class="n">START</code><code class="p">,</code> <code class="s2">"select_tools"</code><code class="p">)</code>
<code class="n">builder</code><code class="o">.</code><code class="n">add_edge</code><code class="p">(</code><code class="s2">"select_tools"</code><code class="p">,</code> <code class="s2">"model"</code><code class="p">)</code>
<code class="n">builder</code><code class="o">.</code><code class="n">add_conditional_edges</code><code class="p">(</code><code class="s2">"model"</code><code class="p">,</code> <code class="n">tools_condition</code><code class="p">)</code>
<code class="n">builder</code><code class="o">.</code><code class="n">add_edge</code><code class="p">(</code><code class="s2">"tools"</code><code class="p">,</code> <code class="s2">"model"</code><code class="p">)</code>

<code class="n">graph</code> <code class="o">=</code> <code class="n">builder</code><code class="o">.</code><code class="n">compile</code><code class="p">()</code></pre>

<p><em>JavaScript<a contenteditable="false" data-primary="JavaScript" data-secondary="tools" data-tertiary="dealing with many" data-type="indexterm" id="id743"/></em></p>

<pre data-code-language="javascript" data-type="programlisting">
<code class="kr">import</code> <code class="p">{</code> <code class="nx">DuckDuckGoSearch</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"@langchain/community/tools/duckduckgo_search"</code><code class="p">;</code>
<code class="kr">import</code> <code class="p">{</code> <code class="nx">Calculator</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"@langchain/community/tools/calculator"</code><code class="p">;</code>
<code class="kr">import</code> <code class="p">{</code> <code class="nx">ChatOpenAI</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"@langchain/openai"</code><code class="p">;</code>
<code class="kr">import</code> <code class="p">{</code> <code class="nx">OpenAIEmbeddings</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"@langchain/openai"</code><code class="p">;</code>
<code class="kr">import</code> <code class="p">{</code> <code class="nx">Document</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"@langchain/core/documents"</code><code class="p">;</code>
<code class="kr">import</code> <code class="p">{</code> <code class="nx">MemoryVectorStore</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"langchain/vectorstores/memory"</code><code class="p">;</code>
<code class="kr">import</code> <code class="p">{</code>
  <code class="nx">StateGraph</code><code class="p">,</code>
  <code class="nx">Annotation</code><code class="p">,</code>
  <code class="nx">messagesStateReducer</code><code class="p">,</code>
  <code class="nx">START</code><code class="p">,</code>
<code class="p">}</code> <code class="nx">from</code> <code class="s2">"@langchain/langgraph"</code><code class="p">;</code>
<code class="kr">import</code> <code class="p">{</code> <code class="nx">ToolNode</code><code class="p">,</code> <code class="nx">toolsCondition</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"@langchain/langgraph/prebuilt"</code><code class="p">;</code>
<code class="kr">import</code> <code class="p">{</code> <code class="nx">HumanMessage</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"@langchain/core/messages"</code><code class="p">;</code>
  
<code class="kr">const</code> <code class="nx">search</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">DuckDuckGoSearch</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">calculator</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Calculator</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">tools</code> <code class="o">=</code> <code class="p">[</code><code class="nx">search</code><code class="p">,</code> <code class="nx">calculator</code><code class="p">];</code>

<code class="kr">const</code> <code class="nx">embeddings</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">OpenAIEmbeddings</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">model</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">ChatOpenAI</code><code class="p">({</code> <code class="nx">temperature</code><code class="o">:</code> <code class="mf">0.1</code> <code class="p">});</code>

<code class="kr">const</code> <code class="nx">toolsStore</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">MemoryVectorStore</code><code class="p">.</code><code class="nx">fromDocuments</code><code class="p">(</code>
  <code class="nx">tools</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code>
    <code class="p">(</code><code class="nx">tool</code><code class="p">)</code> <code class="o">=&gt;</code>
      <code class="k">new</code> <code class="nx">Document</code><code class="p">({</code>
        <code class="nx">pageContent</code><code class="o">:</code> <code class="nx">tool</code><code class="p">.</code><code class="nx">description</code><code class="p">,</code>
        <code class="nx">metadata</code><code class="o">:</code> <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="nx">tool</code><code class="p">.</code><code class="nx">constructor</code><code class="p">.</code><code class="nx">name</code> <code class="p">},</code>
      <code class="p">})</code>
  <code class="p">),</code>
  <code class="nx">embeddings</code>
<code class="p">);</code>
<code class="kr">const</code> <code class="nx">toolsRetriever</code> <code class="o">=</code> <code class="nx">toolsStore</code><code class="p">.</code><code class="nx">asRetriever</code><code class="p">();</code>

<code class="kr">const</code> <code class="nx">annotation</code> <code class="o">=</code> <code class="nx">Annotation</code><code class="p">.</code><code class="nx">Root</code><code class="p">({</code>
  <code class="nx">messages</code><code class="o">:</code> <code class="nx">Annotation</code><code class="p">({</code> <code class="nx">reducer</code><code class="o">:</code> <code class="nx">messagesStateReducer</code><code class="p">,</code> <code class="k">default</code><code class="o">:</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">[]</code> <code class="p">}),</code>
  <code class="nx">selected_tools</code><code class="o">:</code> <code class="nx">Annotation</code><code class="p">(),</code>
<code class="p">});</code>

<code class="nx">async</code> <code class="kd">function</code> <code class="nx">modelNode</code><code class="p">(</code><code class="nx">state</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">selectedTools</code> <code class="o">=</code> <code class="nx">tools</code><code class="p">.</code><code class="nx">filter</code><code class="p">((</code><code class="nx">tool</code><code class="p">)</code> <code class="o">=&gt;</code>
    <code class="nx">state</code><code class="p">.</code><code class="nx">selected_tools</code><code class="p">.</code><code class="nx">includes</code><code class="p">(</code><code class="nx">tool</code><code class="p">.</code><code class="nx">constructor</code><code class="p">.</code><code class="nx">name</code><code class="p">)</code>
  <code class="p">);</code>
  <code class="kr">const</code> <code class="nx">res</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">model</code><code class="p">.</code><code class="nx">bindTools</code><code class="p">(</code><code class="nx">selectedTools</code><code class="p">).</code><code class="nx">invoke</code><code class="p">(</code><code class="nx">state</code><code class="p">.</code><code class="nx">messages</code><code class="p">);</code>
  <code class="k">return</code> <code class="p">{</code> <code class="nx">messages</code><code class="o">:</code> <code class="nx">res</code> <code class="p">};</code>
<code class="p">}</code>

<code class="nx">async</code> <code class="kd">function</code> <code class="nx">selectTools</code><code class="p">(</code><code class="nx">state</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">query</code> <code class="o">=</code> <code class="nx">state</code><code class="p">.</code><code class="nx">messages</code><code class="p">[</code><code class="nx">state</code><code class="p">.</code><code class="nx">messages</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="mi">1</code><code class="p">].</code><code class="nx">content</code><code class="p">;</code>
  <code class="kr">const</code> <code class="nx">toolDocs</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">toolsRetriever</code><code class="p">.</code><code class="nx">invoke</code><code class="p">(</code><code class="nx">query</code> <code class="nx">as</code> <code class="nx">string</code><code class="p">);</code>
  <code class="k">return</code> <code class="p">{</code>
    <code class="nx">selected_tools</code><code class="o">:</code> <code class="nx">toolDocs</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">doc</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">doc</code><code class="p">.</code><code class="nx">metadata</code><code class="p">.</code><code class="nx">name</code><code class="p">),</code>
  <code class="p">};</code>
<code class="p">}</code>

<code class="kr">const</code> <code class="nx">builder</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">StateGraph</code><code class="p">(</code><code class="nx">annotation</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">addNode</code><code class="p">(</code><code class="s2">"select_tools"</code><code class="p">,</code> <code class="nx">selectTools</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">addNode</code><code class="p">(</code><code class="s2">"model"</code><code class="p">,</code> <code class="nx">modelNode</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">addNode</code><code class="p">(</code><code class="s2">"tools"</code><code class="p">,</code> <code class="k">new</code> <code class="nx">ToolNode</code><code class="p">(</code><code class="nx">tools</code><code class="p">))</code>
  <code class="p">.</code><code class="nx">addEdge</code><code class="p">(</code><code class="nx">START</code><code class="p">,</code> <code class="s2">"select_tools"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">addEdge</code><code class="p">(</code><code class="s2">"select_tools"</code><code class="p">,</code> <code class="s2">"model"</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">addConditionalEdges</code><code class="p">(</code><code class="s2">"model"</code><code class="p">,</code> <code class="nx">toolsCondition</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">addEdge</code><code class="p">(</code><code class="s2">"tools"</code><code class="p">,</code> <code class="s2">"model"</code><code class="p">);</code></pre>

<p>You can see the visual representation in <a data-type="xref" href="#ch06_figure_3_1736545671744693">Figure 6-3</a>.</p>

<figure><div class="figure" id="ch06_figure_3_1736545671744693"><img alt="A diagram of a software development process  Description automatically generated" src="assets/lelc_0603.png"/>
<h6><span class="label">Figure 6-3. </span>Modifying the agent architecture to deal with many tools</h6>
</div></figure>

<div data-type="note" epub:type="note"><h6>Note</h6>
<p>This is very similar to the regular agent architecture. The only difference is that we stop by the <code>select_tools</code> node before entering the actual agent loop. After that, it works just as the regular agent architecture we’ve seen before.</p>
</div>

<p>Now let’s see some example output for the same query as before:</p>

<p><em>Python</em></p>

<pre data-code-language="python" data-type="programlisting">
<code class="nb">input</code> <code class="o">=</code> <code class="p">{</code>
  <code class="s2">"messages"</code><code class="p">:</code> <code class="p">[</code>
    <code class="n">HumanMessage</code><code class="p">(</code><code class="s2">"""How old was the 30th president of the United States when </code>
<code class="s2">        he died?"""</code><code class="p">)</code>
  <code class="p">]</code>
<code class="p">}</code>
<code class="k">for</code> <code class="n">c</code> <code class="ow">in</code> <code class="n">graph</code><code class="o">.</code><code class="n">stream</code><code class="p">(</code><code class="nb">input</code><code class="p">):</code>
<code class="nb">print</code><code class="p">(</code><code class="n">c</code><code class="p">)</code></pre>

<p><em>JavaScript</em></p>

<pre data-code-language="javascript" data-type="programlisting">
<code class="kr">const</code> <code class="nx">input</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">messages</code><code class="o">:</code> <code class="p">[</code>
    <code class="nx">HumanMessage</code><code class="p">(</code><code class="sb">`How old was the 30th president of the United States when he </code>
<code class="sb">      died?`</code><code class="p">)</code>
  <code class="p">]</code>
<code class="p">}</code>
<code class="k">for</code> <code class="nx">await</code> <code class="p">(</code><code class="kr">const</code> <code class="nx">c</code> <code class="k">of</code> <code class="nx">await</code> <code class="nx">graph</code><code class="p">.</code><code class="nx">stream</code><code class="p">(</code><code class="nx">input</code><code class="p">))</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">c</code><code class="p">)</code>
<code class="p">}</code></pre>

<p class="pagebreak-before less_space"><em>The output:</em></p>

<pre data-type="programlisting">
{
    "select_tools": {
        "selected_tools': ['duckduckgo_search', 'calculator']
    }
}
{
    "model": {
        "messages": AIMessage(
            content="",
            tool_calls=[
                {
                    "name": "duckduckgo_search",
                    "args": {
                        "query": "30th president of the United States"
                    },
                    "id": "9ed4328dcdea4904b1b54487e343a373",
                    "type": "tool_call",
                }
            ],
        )
    }
}
{
    "tools": {
        "messages": [
            ToolMessage(
                content="Calvin Coolidge (born July 4, 1872, Plymouth, Vermont, 
                    U.S.—died January 5, 1933, Northampton, Massachusetts) was 
                    the 30th president of the United States (1923-29). Coolidge 
                    acceded to the presidency after the death in office of 
                    Warren G. Harding, just as the Harding scandals were coming 
                    to light....",
                name="duckduckgo_search",
                tool_call_id="9ed4328dcdea4904b1b54487e343a373",
            )
        ]
    }
}
{
    "model": {
        "messages": AIMessage(
            content="Calvin Coolidge, the 30th president of the United States, 
                was born on July 4, 1872, and died on January 5, 1933. To 
                calculate his age at the time of his death, we can subtract his 
                birth year from his death year. \n\nAge at death = Death year - 
                Birth year\nAge at death = 1933 - 1872\nAge at death = 61 
                years\n\nCalvin Coolidge was 61 years old when he died.",
        )
    }
}</pre>

<p>Notice how the first thing we did was query the retriever to get the most relevant tools for the current user query. Then, we proceeded to the regular agent architecture.<a contenteditable="false" data-primary="" data-startref="AAmanytools06" data-type="indexterm" id="id744"/><a contenteditable="false" data-primary="" data-startref="TCTmany06" data-type="indexterm" id="id745"/></p>
</div></section>

<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="ch06_summary_1736545671750772">
<h1>Summary</h1>

<p>This chapter introduced the concept of <em>agency</em> and discussed what it takes to make an LLM application <em>agentic</em>: giving the LLM the ability to decide between multiple options by using external information.</p>

<p>We walked through the standard agent architecture built with LangGraph and looked at two useful extensions: how to always call a specific tool first and how to deal with many tools.</p>

<p><a data-type="xref" href="ch07.html#ch07_agents_ii_1736545673023633">Chapter 7</a> looks at additional extensions to the agent architecture.</p>
</div></section>
</div></section></body></html>
["```py\n.../portfolio-project (main) $ cd chapter4\n.../chapter4 (main) $ cp ../chapter3/*.py .\n.../chapter4 (main) $ cp ../chapter3/fantasy_data.db .\n.../chapter4 (main) $ cp ../chapter3/requirements.txt .\n.../chapter4 (main) $ ls *.*\ncrud.py  database.py  fantasy_data.db  models.py  readme.md  requirements.txt\ntest_crud.py\n```", "```py\n#Chapter 4 pip requirements\nSQLAlchemy>=2.0.0\npydantic>=2.4.0\nfastapi[standard]>=0.115.0\nuvicorn>=0.23.0\nPytest>=8.1.0\nhttpx>=0.27.0\n```", "```py\npip3 install -r requirements.txt\n```", "```py\nInstalling collected packages: uvicorn, pydantic, httpx, fastapi\nSuccessfully installed fastapi-0.115.4 httpx-0.26.0 pydantic-2.4.2 uvicorn-0.23.2\n```", "```py\n\"\"\"Pydantic schemas\"\"\"\nfrom pydantic import BaseModel, ConfigDict\nfrom typing import List\nfrom datetime import date\n\nclass Performance(BaseModel):\n    model_config = ConfigDict(from_attributes = True)\n    performance_id : int\n    player_id : int\n    week_number : str\n    fantasy_points : float\n    last_changed_date : date\n\nclass PlayerBase(BaseModel):\n    model_config = ConfigDict(from_attributes = True)    \n    player_id : int\n    gsis_id: str\n    first_name : str\n    last_name : str\n    position : str\n    last_changed_date : date\n\nclass Player(PlayerBase):\n    model_config = ConfigDict(from_attributes = True)\n    performances: List[Performance] = []\n\nclass TeamBase(BaseModel):\n    model_config = ConfigDict(from_attributes = True)\n    league_id : int\n    team_id : int\n    team_name : str\n    last_changed_date : date\n\nclass Team(TeamBase):\n    model_config = ConfigDict(from_attributes = True)\n    players: List[PlayerBase] = []\n\nclass League(BaseModel):\n    model_config = ConfigDict(from_attributes = True)\n    league_id : int\n    league_name : str\n    scoring_type : str\n    last_changed_date : date\n    teams: List[TeamBase] = []\n\nclass Counts(BaseModel):\n    league_count : int\n    team_count : int\n    player_count : int\n```", "```py\nclass Performance(BaseModel):\n    model_config = ConfigDict(from_attributes = True)\n    performance_id : int\n    player_id : int\n    week_number : str\n    fantasy_points : float\n    last_changed_date : date\n```", "```py\nclass PlayerBase(BaseModel):\n    model_config = ConfigDict(from_attributes = True)\n    player_id : int\n    gsis_id: str\n    first_name : str\n    last_name : str\n    position : str\n    last_changed_date : date\n\nclass Player(PlayerBase):\n    model_config = ConfigDict(from_attributes = True)\n    performances: List[Performance] = []\n```", "```py\nclass TeamBase(BaseModel):\n    model_config = ConfigDict(from_attributes = True)\n    league_id : int\n    team_id : int\n    team_name : str\n    last_changed_date : date\n\nclass Team(TeamBase):\n    model_config = ConfigDict(from_attributes = True)\n    players: List[PlayerBase] = []\n```", "```py\nclass League(BaseModel):\n    model_config = ConfigDict(from_attributes = True)\n    league_id : int\n    league_name : str\n    scoring_type : str\n    last_changed_date : date\n    teams: List[TeamBase] = []\n```", "```py\nclass Counts(BaseModel):\n    league_count : int\n    team_count : int\n    player_count : int\n```", "```py\n\"\"\"FastAPI program - Chapter 4\"\"\"\nfrom fastapi import Depends, FastAPI, HTTPException\nfrom sqlalchemy.orm import Session\nfrom datetime import date\n\nimport crud, schemas\nfrom database import SessionLocal\n\napp = FastAPI()\n\n# Dependency\ndef get_db():\n    db = SessionLocal()\n    try:\n        yield db\n    finally:\n        db.close()\n\n@app.get(\"/\")\nasync def root():\n    return {\"message\": \"API health check successful\"}\n\n@app.get(\"/v0/players/\", response_model=list[schemas.Player])\ndef read_players(skip: int = 0, \n                 limit: int = 100, \n                 minimum_last_changed_date: date = None, \n                 first_name: str = None, \n                 last_name: str = None,\n                 db: Session = Depends(get_db)\n                 ):\n    players = crud.get_players(db, \n                skip=skip, \n                limit=limit, \n                min_last_changed_date=minimum_last_changed_date, \n                first_name=first_name, \n                last_name=last_name)\n    return players\n\n@app.get(\"/v0/players/{player_id}\", response_model=schemas.Player)\ndef read_player(player_id: int, \n                db: Session = Depends(get_db)):\n    player = crud.get_player(db, \n                             player_id=player_id)\n    if player is None:\n        raise HTTPException(status_code=404, \n                            detail=\"Player not found\")\n    return player\n\n@app.get(\"/v0/performances/\", \n         response_model=list[schemas.Performance])\ndef read_performances(skip: int = 0, \n                limit: int = 100, \n                minimum_last_changed_date: date = None, \n                db: Session = Depends(get_db)):\n    performances = crud.get_performances(db, \n                skip=skip, \n                limit=limit, \n                min_last_changed_date=minimum_last_changed_date)\n    return performances\n\n@app.get(\"/v0/leagues/{league_id}\", response_model=schemas.League)\ndef read_league(league_id: int,db: Session = Depends(get_db)):\n    league = crud.get_league(db, league_id = league_id)\n    if league is None:\n        raise HTTPException(status_code=404, detail=\"League not found\")\n    return league\n\n@app.get(\"/v0/leagues/\", response_model=list[schemas.League])\ndef read_leagues(skip: int = 0, \n                limit: int = 100, \n                minimum_last_changed_date: date = None, \n                league_name: str = None,\n                db: Session = Depends(get_db)):\n    leagues = crud.get_leagues(db, \n                skip=skip, \n                limit=limit, \n                min_last_changed_date=minimum_last_changed_date, \n                league_name=league_name)\n    return leagues\n\n@app.get(\"/v0/teams/\", response_model=list[schemas.Team])\ndef read_teams(skip: int = 0, \n               limit: int = 100, \n               minimum_last_changed_date: date = None, \n               team_name: str = None, \n               league_id: int = None, \n               db: Session = Depends(get_db)):\n    teams = crud.get_teams(db, \n                skip=skip, \n                limit=limit, \n                min_last_changed_date=minimum_last_changed_date, \n                team_name=team_name,\n                league_id=league_id)\n    return teams\n\n@app.get(\"/v0/counts/\", response_model=schemas.Counts)\ndef get_count(db: Session = Depends(get_db)):\n    counts = schemas.Counts(\n        league_count = crud.get_league_count(db),\n        team_count = crud.get_team_count(db),\n        player_count = crud.get_player_count(db))\n    return counts\n```", "```py\nfrom fastapi import Depends, FastAPI, HTTPException ![1](assets/1.png)\nfrom sqlalchemy.orm import Session ![2](assets/2.png)\nfrom datetime import date ![3](assets/3.png)\n\nimport crud, schemas ![4](assets/4.png)\nfrom database import SessionLocal ![5](assets/5.png)\n```", "```py\napp = FastAPI()\n\n# Dependency\ndef get_db():\n    db = SessionLocal()\n    try:\n        yield db\n    finally:\n        db.close()\n```", "```py\n@app.get(\"/\")\nasync def root():\n    return {\"message\": \"API health check successful\"}\n```", "```py\n@app.get(\"/v0/players/\", response_model=list[schemas.Player])\ndef read_players(skip: int = 0,\n                limit: int = 100,\n                minimum_last_changed_date: date = None,\n                first_name: str = None,\n                last_name: str = None,\n                db: Session = Depends(get_db)\n                ):\n   players = crud.get_players(db,\n               skip=skip,\n               limit=limit,\n               min_last_changed_date=minimum_last_changed_date,\n               first_name=first_name,\n               last_name=last_name)\n   return players\n```", "```py\ndef read_players(skip: int = 0,\n                 limit: int = 100,\n                 minimum_last_changed_date: date = None,\n                 first_name: str = None,\n                 last_name: str = None,\n                 db: Session = Depends(get_db)\n                 ):\n```", "```py\n@app.get(\"/v0/players/{player_id}\", response_model=schemas.Player)\ndef read_player(player_id: int,\n                db: Session = Depends(get_db)):\n    player = crud.get_player(db,\n                             player_id=player_id)\n    if player is None:\n        raise HTTPException(status_code=404,\n                            detail=\"Player not found\")\n    return player\n```", "```py\n@app.get(\"/v0/performances/\",\n         response_model=list[schemas.Performance])\ndef read_performances(skip: int = 0,\n                limit: int = 100,\n                minimum_last_changed_date: date = None,\n                db: Session = Depends(get_db)):\n    performances = crud.get_performances(db,\n                skip=skip,\n                limit=limit,\n                min_last_changed_date=minimum_last_changed_date)\n    return performances\n\n@app.get(\"/v0/leagues/{league_id}\", response_model=schemas.League)\ndef read_league(league_id: int,db: Session = Depends(get_db)):\n    league = crud.get_league(db, league_id = league_id)\n    if league is None:\n        raise HTTPException(status_code=404, detail=\"League not found\")\n    return league\n\n@app.get(\"/v0/leagues/\", response_model=list[schemas.League])\ndef read_leagues(skip: int = 0,\n                limit: int = 100,\n                minimum_last_changed_date: date = None,\n                league_name: str = None,\n                db: Session = Depends(get_db)):\n    leagues = crud.get_leagues(db,\n                skip=skip,\n                limit=limit,\n                min_last_changed_date=minimum_last_changed_date,\n                league_name=league_name)\n    return leagues\n\n@app.get(\"/v0/teams/\", response_model=list[schemas.Team])\ndef read_teams(skip: int = 0,\n               limit: int = 100,\n               minimum_last_changed_date: date = None,\n               team_name: str = None,\n               league_id: int = None,\n               db: Session = Depends(get_db)):\n    teams = crud.get_teams(db,\n                skip=skip,\n                limit=limit,\n                min_last_changed_date=minimum_last_changed_date,\n                team_name=team_name,\n                league_id=league_id)\n    return teams\n```", "```py\n@app.get(\"/v0/counts/\", response_model=schemas.Counts)\ndef get_count(db: Session = Depends(get_db)):\n   counts = schemas.Counts(\n       league_count = crud.get_league_count(db),\n       team_count = crud.get_team_count(db),\n       player_count = crud.get_player_count(db))\n   return counts\n```", "```py\nfrom fastapi.testclient import TestClient\nfrom main import app\n\nclient = TestClient(app)\n\n# test the health check endpoint\ndef test_read_main():\n    response = client.get(\"/\")\n    assert response.status_code == 200\n    assert response.json() == {\"message\": \"API health check successful\"}\n\n# test /v0/players/\ndef test_read_players():\n    response = client.get(\"/v0/players/?skip=0&limit=10000\")\n    assert response.status_code == 200\n    assert len(response.json()) == 1018\n\ndef test_read_players_by_name():\n    response = client.get(\"/v0/players/?first_name=Bryce&last_name=Young\")\n    assert response.status_code == 200\n    assert len(response.json()) == 1\n    assert response.json()[0].get(\"player_id\") == 2009\n\n# test /v0/players/{player_id}/\ndef test_read_players_with_id():\n    response = client.get(\"/v0/players/1001/\")\n    assert response.status_code == 200\n    assert response.json().get(\"player_id\") == 1001\n\n# test /v0/performances/\ndef test_read_performances():\n    response = client.get(\"/v0/performances/?skip=0&limit=20000\")\n    assert response.status_code == 200\n    assert len(response.json()) == 17306\n\n# test /v0/performances/ with changed date\ndef test_read_performances_by_date():\n    response = client.get(\n        \"/v0/performances/?skip=0&limit=20000&minimum_last_changed_date=\n        2024-04-01\"\n    )\n    assert response.status_code == 200\n    assert len(response.json()) == 2711\n\n# test /v0/leagues/{league_id}/\ndef test_read_leagues_with_id():\n    response = client.get(\"/v0/leagues/5002/\")\n    assert response.status_code == 200\n    assert len(response.json()[\"teams\"]) == 8\n\n# test /v0/leagues/\ndef test_read_leagues():\n    response = client.get(\"/v0/leagues/?skip=0&limit=500\")\n    assert response.status_code == 200\n    assert len(response.json()) == 5\n\n# test /v0/teams/\ndef test_read_teams():\n    response = client.get(\"/v0/teams/?skip=0&limit=500\")\n    assert response.status_code == 200\n    assert len(response.json()) == 20\n\n# test /v0/teams/\ndef test_read_teams_for_one_league():\n    response = client.get(\"/v0/teams/?skip=0&limit=500&league_id=5001\")\n    assert response.status_code == 200\n    assert len(response.json()) == 12\n\n# test the count functions\ndef test_counts():\n    response = client.get(\"/v0/counts/\")\n    response_data = response.json()\n    assert response.status_code == 200\n    assert response_data[\"league_count\"] == 5\n    assert response_data[\"team_count\"] == 20\n    assert response_data[\"player_count\"] == 1018\n```", "```py\nfrom fastapi.testclient import TestClient ![1](assets/1.png)\nfrom main import app ![2](assets/2.png)\n\nclient = TestClient(app) ![3](assets/3.png)\n```", "```py\n#test the health check endpoint\ndef test_read_main():\n    response = client.get(\"/\")\n    assert response.status_code == 200\n    assert response.json() == {\"message\": \"API health check successful\"}\n```", "```py\n#test /v0/players/\ndef test_read_players():\n    response = client.get(\"/v0/players/?skip=0&limit=10000\")\n    assert response.status_code == 200\n    assert len(response.json()) == 1018\n```", "```py\ndef test_read_players_by_name():\n    response = client.get(\"/v0/players/?first_name=Bryce&last_name=Young\")\n    assert response.status_code == 200\n    assert len(response.json()) == 1\n    assert response.json()[0].get(\"player_id\") == 2009\n```", "```py\n.../chapter4 (main) $ pytest test_main.py\n================== test session starts ===========================\nplatform linux -- Python 3.10.14, pytest-8.1.2, pluggy-1.4.0\nrootdir: /workspaces/portfolio-project/chapter4\nplugins: anyio-3.4.4.0\n\ncollected 11 items\n\ntest_main.py                                              [100%]\n\n=================== 11 passed in 1.01s ============================\n```", "```py\n.../chapter4 (main) $ fastapi run main.py\n```", "```py\n{\"message\":\"API health check successful\"}\n```", "```py\n[{\"performance_id\":2501,\"player_id\":1001,\"week_number\":\"202301\",\n\"fantasy_points\":20.0,\"last_changed_date\":\"2024-03-01\"}]\n```"]
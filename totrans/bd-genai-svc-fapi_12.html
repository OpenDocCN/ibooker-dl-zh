<html><head></head><body><div id="book-content"><div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 8. Authentication and Authorization" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch08">
<h1><span class="label">Capitolo 8. </span>Autenticazione e autorizzazione</h1><div data-type="note"><p>Questo lavoro è stato tradotto utilizzando l'AI. Siamo lieti di ricevere il tuo feedback e i tuoi commenti: <a href="mailto:translation-feedback@oreilly.com">translation-feedback@oreilly.com</a></p></div>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id967">
<h1>Obiettivi del capitolo</h1>
<p>In questo capitolo imparerai a conoscere:</p>
<ul>
<li>
<p>Strategie di autenticazione rilevanti per proteggere i tuoi servizi GenAI</p>
</li>
<li>
<p>Come implementare le credenziali di base e l'autenticazione JSON Web Token (JWT) da zero</p>
</li>
<li>
<p>Vari rischi di autenticazione e vettori di attacco</p>
</li>
<li>
<p>Come creare un'autenticazione single sign-on (SSO) con un provider di identità come GitHub seguendo lo standard OAuth2</p>
</li>
<li>
<p>Modelli di autorizzazione come il controllo degli accessi basato sui ruoli, sugli attributi e sulle relazioni.</p>
</li>
<li>
<p>Meccanismi di autorizzazione per salvaguardare le risorse da utenti non privilegiati</p>
</li>
<li>
<p>Come limitare l'accesso alle risorse e limitare i risultati della generazione di AI in base ai privilegi degli utenti</p>
</li>
</ul>
</div></aside>
<p>Finora hai costruito servizi GenAI in grado di interagire con i database, di trasmettere le risposte dei modelli e di gestire utenti simultanei.</p>
<p>I tuoi servizi sono ora attivi e funzionanti, ma poiché non sono protetti da aggressori o utenti malintenzionati, la loro distribuzione in produzione potrebbe rivelarsi problematica.</p>
<p>In questo capitolo imparerai a proteggere i tuoi servizi con un livello di autenticazione e a implementare le protezioni di autorizzazione per proteggere le risorse sensibili dagli utenti non privilegiati.</p>
<p>Per raggiungere questo obiettivo, Go esplorerà vari modelli di autenticazione e autorizzazione e implementerà JWT e l'autenticazione basata sull'identità con il controllo degli accessi basato sui ruoli.</p>
<section data-pdf-bookmark="Authentication and Authorization" data-type="sect1"><div class="sect1" id="id250">
<h1>Autenticazione e autorizzazione</h1>
<p><a data-primary="authentication" data-secondary="authorization versus" data-type="indexterm" id="id968"/><a data-primary="authorization" data-secondary="authentication versus" data-type="indexterm" id="id969"/>Prima di parlare dei metodi di autenticazione, chiariamo brevemente che l'autenticazione e l'autorizzazione sono due concetti distinti che spesso vengono usati per errore in modo intercambiabile.</p>
<p>Secondo la definizione di OWASP:<sup><a data-type="noteref" href="ch08.html#id970" id="id970-marker" translate="no">1</a></sup></p>
<blockquote>
<p>L<em>'autenticazione</em> è il processo di verifica che un individuo, un'entità o un sito web sia chi o cosa dichiara di essere, determinando la validità di uno o più autenticatori (come password, impronte digitali o token di sicurezza) che vengono utilizzati a sostegno di questa dichiarazione.</p></blockquote>
<p>D'altra parte, il National Institute of Standards and Technology (NIST) definisce l'autorizzazione come:</p>
<blockquote>
<p>Un processo per verificare che un'azione o un servizio richiesto sia approvato per un'entità specifica.</p></blockquote>
<p>Mentre l'autenticazione riguarda la verifica dell'identità, l'autorizzazione si concentra sulla verifica dei permessi di un'identità per accedere o modificare le risorse.</p>
<div data-type="tip"><h6>Suggerimento</h6>
<p>L'autenticazione è come presentare il passaporto all'immigrazione, mentre l'autorizzazione è come avere il visto giusto per entrare in un paese, specificando la durata del soggiorno e le attività consentite una volta entrati.</p>
</div>
<p>Parliamo dei metodi di autenticazione in modo più dettagliato, prima di affrontare il tema dell'autorizzazione più avanti nel capitolo.</p>
</div></section>
<section class="less_space pagebreak-before" data-pdf-bookmark="Authentication Methods" data-type="sect1"><div class="sect1" id="id251">
<h1>Metodi di autenticazione</h1>
<p><a data-primary="authentication" data-secondary="methods" data-type="indexterm" id="ix_ch08-asciidoc0"/>Esistono diversi meccanismi di autenticazione che puoi implementare nei tuoi servizi GenAI per renderli sicuri attraverso la verifica dell'identità.</p>
<p>A seconda dei requisiti di sicurezza, dell'ambiente applicativo, del budget e delle tempistiche del progetto, puoi decidere di adottare uno o più dei seguenti meccanismi di autenticazione:</p>
<dl>
<dt>Di base</dt>
<dd>
<p>Richiedere l'uso di credenziali come nome utente e password per verificare l'<span class="keep-together">identità.</span></p>
</dd>
<dt>Gettoni web JSON (JWT)</dt>
<dd>
<p>I token di <em>accesso</em> possono essere considerati come i biglietti del cinema che stabiliscono se puoi accedere agli schermi, quale schermo stai visitando e dove sei seduto.</p>
</dd>
<dt>OAuth</dt>
<dd>
<p>Verifica di un'identità tramite un provider di identità utilizzando lo standard <em>OAuth2</em>.</p>
</dd>
<dt>Basato sui tasti</dt>
<dd>
<p>Utilizza una coppia di chiavi private e pubbliche per autenticare un'identità. Invece dei token, il server di autorizzazione rilascia una chiave pubblica al cliente e memorizza una copia di una chiave privata collegata che può utilizzare in seguito per la verifica.<sup><a data-type="noteref" href="ch08.html#id971" id="id971-marker" translate="no">2</a></sup></p>
</dd>
</dl>
<p>La<a data-type="xref" href="#authentication_methods">Figura 8-1</a> mostra il flusso di dati dei metodi di autenticazione sopra citati in modo più dettagliato.</p>
<figure><div class="figure" id="authentication_methods">
<img alt="bgai 0801" src="assets/bgai_0801.png" width="1424" height="1601"/>
<h6><span class="label">Figura 8-1. </span>Metodi di autenticazione</h6>
</div></figure>
<p>Conoscendo i meccanismi di autenticazione, può essere difficile decidere quale metodo adottare per soddisfare i tuoi requisiti di sicurezza. Per aiutarti nella scelta, la<a data-type="xref" href="#authentication_methods_comparison">Tabella 8-1</a> mette a confronto i suddetti metodi di autenticazione.</p>
<table class="striped" id="authentication_methods_comparison">
<caption><span class="label">Tabella 8-1. </span>Confronto tra i metodi di autenticazione</caption>
<thead>
<tr>
<th>Tipo</th>
<th>Vantaggi</th>
<th>Limitazioni</th>
<th>Casi d'uso</th>
</tr>
</thead>
<tbody>
<tr>
<td>Di base</td>
<td><ul><li><p>Semplicità</p></li>
<li><p>Veloce da implementare</p></li>
<li><p>Facile da capire</p></li></ul></td>
<td><p>Invia le credenziali in testo normale</p></td>
<td><ul><li><p>Prototipi</p></li>
<li><p>Ambienti interni o non di produzione</p></li></ul></td>
</tr>
<tr>
<td><p>Gettone</p></td>
<td><ul><li><p>Scalabilità</p></li>
<li><p>Il disaccoppiamento facilita l'implementazione di architetture a microservizi</p></li>
<li><p>I token possono essere firmati e crittografati per una maggiore sicurezza.</p></li>
<li><p>Altamente personalizzabile</p></li>
<li><p>Autosufficiente per ridurre i viaggi del database</p></li>
<li><p>Può essere passato nelle intestazioni HTTP</p></li></ul></td>
<td><ul>
<li><p>Necessità costante di rigenerare gettoni di breve durata</p></li>
<li><p>Complessità della memorizzazione dei token sul lato client</p></li>
<li><p>I token possono diventare grandi e consumare una larghezza di banda eccessiva.</p></li>
<li><p>I token stateless possono rendere difficile l'implementazione di applicazioni multi-step</p></li>
<li><p>Le configurazioni errate sul lato client possono compromettere i token</p></li></ul></td>
<td><ul><li><p>Applicazioni a pagina singola e per dispositivi mobili</p></li>
<li><p>Applicazioni che richiedono flussi di autenticazione personalizzati</p></li>
<li><p>API REST</p></li></ul></td>
</tr>
<tr>
<td><p>OAuth</p></td>
<td><ul><li><p>Delega l'autenticazione a provider esterni</p></li>
<li><p>Basato su uno standard (OAuth2) e testato per gli scenari aziendali</p></li>
<li><p>Accesso a risorse esterne per conto dell'utente</p></li></ul></td>
<td><ul><li><p>Complesso da capire e da implementare</p></li>
<li><p>Ogni fornitore di identità può implementare il flusso OAuth in modo leggermente diverso.</p></li></ul></td>
<td><ul><li><p>Applicazioni che richiedono i dati degli utenti da fornitori di identità esterni come GitHub, Google o Microsoft.</p></li>
<li><p>Applicazioni aziendali che richiedono l'SSO con i propri identity provider</p></li></ul></td>
</tr>
<tr>
<td><p>Basato sui tasti</p></td>
<td><ul><li><p>Meccanismo di autenticazione simile all'accesso Secure Shell (SSH)</p></li></ul></td>
<td><ul><li><p>Gestire e mantenere sicure le chiavi private può essere complesso</p></li>
<li><p>Le chiavi compromesse possono creare rischi per la sicurezza</p></li>
<li><p>Problemi di scalabilità</p></li></ul></td>
<td><ul><li><p>Piccole applicazioni</p></li>
<li><p>Applicazioni in ambienti interni</p></li></ul></td>
</tr>
</tbody>
</table>
<p>Nella prossima sezione, implementerai l'autenticazione di base, JWT e OAuth per il tuo GenAI per comprendere appieno i componenti sottostanti e le loro interazioni.</p>
<section data-pdf-bookmark="Basic Authentication" data-type="sect2"><div class="sect2" id="id114">
<h2>Autenticazione di base</h2>
<p><a data-primary="authentication" data-secondary="methods" data-tertiary="basic authentication" data-type="indexterm" id="ix_ch08-asciidoc1"/><a data-primary="basic authentication" data-type="indexterm" id="ix_ch08-asciidoc2"/>Nell'autenticazione di base, il client fornisce un nome utente e una password quando effettua una richiesta di accesso alle risorse dal server. È la tecnica più semplice perché non richiede l'implementazione di cookie, identificatori di sessione o moduli di login. Grazie alla sua semplicità, l'autenticazione di base è ideale per gli ambienti sandbox e per la prototipazione. Tuttavia, evita di usarla in ambienti di produzione perché trasmette nomi utente e password in chiaro a ogni richiesta, rendendola altamente vulnerabile agli attacchi di intercettazione.</p>
<p class="less_space pagebreak-before">Per eseguire una richiesta autenticata tramite l'autenticazione di base, devi aggiungere un'intestazione <code translate="no">Authorization</code> con un valore di <code translate="no">Basic &lt;credentials&gt;</code> affinché il server riesca ad autenticarla. Il valore <code translate="no">&lt;credentials&gt;</code> deve essere una codifica <em>Base64</em> del nome utente e della password uniti da un singolo punto (ad esempio, <code translate="no">base64.encode(ali:secretpassword)</code>.</p>
<p>In FastAPI, puoi proteggere un endpoint con l'autenticazione di base, come mostrato nell'<a data-type="xref" href="#basic_authentication_endpoint">Esempio 8-1</a>.</p>
<div data-type="example" id="basic_authentication_endpoint">
<h5><span class="label">Esempio 8-1. </span>Implementazione dell'autenticazione di base in FastAPI</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="kn" translate="no">import</code><code translate="no"> </code><code class="nn" translate="no">secrets</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">typing</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">FastAPI</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">HTTPException</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">status</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code class="nn" translate="no">.</code><code class="nn" translate="no">security</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">HTTPBasic</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">HTTPBasicCredentials</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">app</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">FastAPI</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="n" translate="no">security</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">HTTPBasic</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO1-1" id="co_authentication_and_authorization_CO1-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code class="n" translate="no">username_bytes</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="sa" translate="no">b</code><code class="s2" translate="no">"</code><code class="s2" translate="no">ali</code><code class="s2" translate="no">"</code><code translate="no">
</code><code class="n" translate="no">password_bytes</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="sa" translate="no">b</code><code class="s2" translate="no">"</code><code class="s2" translate="no">secretpassword</code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">authenticate_user</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">credentials</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="n" translate="no">HTTPBasicCredentials</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">security</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">is_correct_username</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">secrets</code><code class="o" translate="no">.</code><code class="n" translate="no">compare_digest</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">credentials</code><code class="o" translate="no">.</code><code class="n" translate="no">username</code><code class="o" translate="no">.</code><code class="n" translate="no">encode</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">UTF-8</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">username_bytes</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO1-2" id="co_authentication_and_authorization_CO1-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">is_correct_password</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">secrets</code><code class="o" translate="no">.</code><code class="n" translate="no">compare_digest</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">credentials</code><code class="o" translate="no">.</code><code class="n" translate="no">password</code><code class="o" translate="no">.</code><code class="n" translate="no">encode</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">UTF-8</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">password_bytes</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO1-2" id="co_authentication_and_authorization_CO1-3"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="ow" translate="no">not</code><code translate="no"> </code><code class="p" translate="no">(</code><code class="n" translate="no">is_correct_username</code><code translate="no"> </code><code class="ow" translate="no">and</code><code translate="no"> </code><code class="n" translate="no">is_correct_password</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">raise</code><code translate="no"> </code><code class="n" translate="no">HTTPException</code><code class="p" translate="no">(</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO1-3" id="co_authentication_and_authorization_CO1-4"><img alt="3" src="assets/3.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="n" translate="no">status</code><code class="o" translate="no">.</code><code class="n" translate="no">HTTP_401_UNAUTHORIZED</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">detail</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Incorrect credentials</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">headers</code><code class="o" translate="no">=</code><code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">WWW-Authenticate</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">Basic</code><code class="s2" translate="no">"</code><code class="p" translate="no">}</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">credentials</code><code class="o" translate="no">.</code><code class="n" translate="no">username</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">AuthenticatedUserDep</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">authenticate_user</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO1-4" id="co_authentication_and_authorization_CO1-5"><img alt="4" src="assets/4.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@app</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/users/me</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">get_current_user_controller</code><code class="p" translate="no">(</code><code class="n" translate="no">username</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">AuthenticatedUserDep</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO1-4" id="co_authentication_and_authorization_CO1-6"><img alt="4" src="assets/4.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">message</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Current user is </code><code class="si" translate="no">{</code><code class="n" translate="no">username</code><code class="si" translate="no">}</code><code class="s2" translate="no">"</code><code class="p" translate="no">}</code></pre>
<dl class="calloutlist less_space pagebreak-before">
<dt><a class="co" href="#co_authentication_and_authorization_CO1-1" id="callout_authentication_and_authorization_CO1-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>FastAPI ha implementato diversi meccanismi di sicurezza HTTP, tra cui <code translate="no">HTTP​Ba⁠sic</code> che può sfruttare il sistema di dependency injection di FastAPI.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO1-2" id="callout_authentication_and_authorization_CO1-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Utilizza la libreria integrata <code translate="no">secrets</code> per confrontare il nome utente e la password forniti con i valori del server. L'uso di <code translate="no">secrets.compare_digest()</code> garantisce che la durata delle operazioni di verifica rimanga costante indipendentemente dagli input, per evitare <em>attacchi di temporizzazione</em>.<sup><a data-type="noteref" href="ch08.html#id972" id="id972-marker" translate="no">3</a></sup></p>
<p>Nota che <code translate="no">secrets.compare_digest()</code> può accettare solo input di tipo byte o stringa contenenti caratteri ASCII (cioè solo caratteri inglesi). Per gestire altri caratteri, dovrai prima codificare gli input con <code translate="no">UTF-8</code> in byte prima di eseguire i controlli delle credenziali.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO1-4" id="callout_authentication_and_authorization_CO1-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Restituisce un'autorizzazione standardizzata <code translate="no">HTTPException</code> conforme agli standard di sicurezza che i browser comprendono in modo da mostrare nuovamente il prompt di accesso all'utente. Il messaggio di eccezione deve essere generico per evitare di far trapelare informazioni sensibili, come l'esistenza di un account utente, agli aggressori.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO1-5" id="callout_authentication_and_authorization_CO1-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>L'utilizzo di <code translate="no">HTTPBasic</code> con <code translate="no">Depends()</code> restituisce l'oggetto <code translate="no">HTTPBasicCredentials</code> che contiene il nome utente fornito.</p></dd>
</dl></div>
<p>Iniettare una dipendenza di sicurezza in qualsiasi endpoint FastAPI lo proteggerà con l'autenticazione implementata. Puoi sperimentarlo tu stesso visitando la pagina<span class="keep-together"><code translate="no">/docs</code></span> e inviando una richiesta all'endpoint <code translate="no">/users/me</code>.</p>
<p>L'endpoint mostrerà un'icona <em>a forma di lucchetto</em> e, al momento della richiesta, dovrebbe comparire un avviso di accesso che ti chiederà di fornire le credenziali, come puoi vedere nella <a data-type="xref" href="#basic_authentication">Figura 8-2</a>.</p>
<figure><div class="figure" id="basic_authentication">
<img alt="bgai 0802" src="assets/bgai_0802.png" width="1105" height="907"/>
<h6><span class="label">Figura 8-2. </span>Autenticazione di base in FastAPI</h6>
</div></figure>
<p>Con 25 righe di codice sei riuscito a implementare una forma di autenticazione di base per proteggere un endpoint. Ora puoi utilizzare l'autenticazione di base nei tuoi prototipi e nei server di sviluppo.</p>
<p>Tieni presente che dovresti evitare di adottare il meccanismo di autenticazione di base nei servizi GenAI di livello produttivo. Un'alternativa migliore e più sicura per i servizi rivolti al pubblico è l'<em>autenticazione JWT</em>, che elimina la necessità di sessioni lato server memorizzando tutti i dettagli dell'autenticazione all'interno di un token. Inoltre, mantiene l'integrità dei dati e funziona in diversi domini con uno standard ampiamente accettato.<a data-startref="ix_ch08-asciidoc2" data-type="indexterm" id="id973"/><a data-startref="ix_ch08-asciidoc1" data-type="indexterm" id="id974"/></p>
</div></section>
<section class="less_space pagebreak-before" data-pdf-bookmark="JSON Web Tokens (JWT) Authentication" data-type="sect2"><div class="sect2" id="id115">
<h2>Autenticazione con token web JSON (JWT)</h2>
<p><a data-primary="authentication" data-secondary="methods" data-tertiary="JWT authentication" data-type="indexterm" id="ix_ch08-asciidoc3"/><a data-primary="JSON Web Tokens (JWT) authentication" data-type="indexterm" id="ix_ch08-asciidoc4"/>Ora che hai acquisito una maggiore familiarità con i concetti di base dell'autenticazione, implementiamo un livello di autenticazione JWT più complesso ma sicuro per il tuo servizio FastAPI. Come parte di questo processo, dovrai anche rifattorizzare gli endpoint esistenti per combinarli sotto un router API separato per le risorse, in modo da raggruppare, nominare, etichettare e proteggere più endpoint contemporaneamente.</p>
<section data-pdf-bookmark="What is JWT?" data-type="sect3"><div class="sect3" id="id116">
<h3>Che cos'è il JWT?</h3>
<p><a data-primary="JSON Web Tokens (JWT) authentication" data-secondary="JWT defined" data-type="indexterm" id="ix_ch08-asciidoc5"/>I JWT sono un modo sicuro e compatto di asserire le rivendicazioni tra le applicazioni tramite token.</p>
<p>Questi gettoni sono composti da tre parti:</p>
<dl>
<dt>Intestazioni</dt>
<dd>
<p>Specifica il tipo di token e l'algoritmo di firma oltre alla data e all'autorità emittente.</p>
</dd>
<dt>Carico utile</dt>
<dd>
<p>Specifica il corpo del token che rappresenta le rivendicazioni sulla risorsa insieme a metadati aggiuntivi.</p>
</dd>
<dt>Firma</dt>
<dd>
<p>La funzione che crea il token lo firma utilizzando il <em>payload codificato</em>, le <em>intestazioni codificate</em>, un <em>segreto</em> e l'algoritmo di firma.</p>
</dd>
</dl>
<div data-type="tip"><h6>Suggerimento</h6>
<p>L'algoritmo di codifica <code translate="no">base64</code> viene spesso utilizzato per codificare e decodificare i dati per garantire la compattezza e la sicurezza degli URL.</p>
</div>
<p><a data-type="xref" href="#jwt">La Figura 8-3</a> mostra l'aspetto di un tipico JWT.</p>
<figure><div class="figure" id="jwt">
<img alt="bgai 0803" src="assets/bgai_0803.png" width="1992" height="1511"/>
<h6><span class="label">Figura 8-3. </span>Componenti JWT (Fonte: <a class="orm:hideurl" href="https://jwt.io">jwt.io</a>)</h6>
</div></figure>
<p>I JWT sono sicuri, compatti e convenienti perché possono contenere tutte le informazioni necessarie per eseguire l'autenticazione dell'utente, evitando la necessità di effettuare più viaggi nel database. Inoltre, grazie alla loro compattezza, puoi trasferirli attraverso la rete utilizzando il corpo HTTP <code translate="no">POST</code>, le intestazioni o i parametri URL.<a data-startref="ix_ch08-asciidoc5" data-type="indexterm" id="id975"/></p>
</div></section>
<section data-pdf-bookmark="Getting started with JWT authentication" data-type="sect3"><div class="sect3" id="id117">
<h3>Come iniziare con l'autenticazione JWT</h3>
<p><a data-primary="JSON Web Tokens (JWT) authentication" data-secondary="getting started with implementation" data-type="indexterm" id="ix_ch08-asciidoc6"/>Per iniziare a implementare il meccanismo di autenticazione JWT in FastAPI, devi installare le dipendenze <code translate="no">passlib</code> e <code translate="no">python-jose</code>:</p>
<pre data-code-language="bash" data-type="programlisting" translate="no">$<code class="w" translate="no"> </code>pip<code class="w" translate="no"> </code>install<code class="w" translate="no"> </code>passlib<code class="w" translate="no"> </code>python-jose<code class="w" translate="no"/></pre>
<p>Una volta installate le dipendenze, avrai bisogno di tabelle nel database per memorizzare gli utenti generati e i dati dei token associati. Per la persistenza dei dati, migriamo il database per creare le tabelle <code translate="no">users</code> e <code translate="no">tokens</code>, come mostrato nella <a data-type="xref" href="#erd">Figura 8-4</a>.</p>
<figure><div class="figure" id="erd">
<img alt="bgai 0804" src="assets/bgai_0804.png" width="2176" height="1120"/>
<h6><span class="label">Figura 8-4. </span>Diagramma delle relazioni tra entità delle tabelle <code translate="no">users</code> e <code translate="no">tokens</code> </h6>
</div></figure>
<p>Se guardi la <a data-type="xref" href="#erd">Figura 8-4</a>, noterai che la tabella <code translate="no">tokens</code> ha una relazione uno-a-molti con la tabella <code translate="no">users</code>. Puoi usare i record dei token per tenere traccia dei tentativi di accesso riusciti per ogni utente e per revocare l'accesso se necessario.</p>
<p><a data-primary="Pydantic" data-secondary="defining schemas for database queries/data validation" data-type="indexterm" id="ix_ch08-asciidoc7"/><a data-primary="SQLAlchemy package" data-secondary="defining schemas for database queries/data validation" data-type="indexterm" id="ix_ch08-asciidoc8"/>Definiamo quindi i modelli SQLAlchemy e gli schemi Pydantic necessari per le query al database e la validazione dei dati, come mostrato negli Esempi <a data-type="xref" data-xrefstyle="select:labelnumber" href="#user_models">8-2</a> e <a data-type="xref" data-xrefstyle="select:labelnumber" href="#users_schema">8-3</a>.</p>
<div data-type="example" id="user_models">
<h5><span class="label">Esempio 8-2. </span>Dichiarare i modelli ORM SQLAlchemy dell'utente</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># entities.py</code>

<code class="kn" translate="no">import</code> <code class="nn" translate="no">uuid</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">datetime</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">UTC</code><code class="p" translate="no">,</code> <code class="n" translate="no">datetime</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">sqlalchemy</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Index</code><code class="p" translate="no">,</code> <code class="n" translate="no">String</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">sqlalchemy.orm</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">DeclarativeBase</code><code class="p" translate="no">,</code> <code class="n" translate="no">Mapped</code><code class="p" translate="no">,</code> <code class="n" translate="no">mapped_column</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">Base</code><code class="p" translate="no">(</code><code class="n" translate="no">DeclarativeBase</code><code class="p" translate="no">):</code>
    <code class="k" translate="no">pass</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">User</code><code class="p" translate="no">(</code><code class="n" translate="no">Base</code><code class="p" translate="no">):</code>
    <code class="n" translate="no">__tablename__</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"users"</code>

    <code class="nb" translate="no">id</code><code class="p" translate="no">:</code> <code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="n" translate="no">uuid</code><code class="o" translate="no">.</code><code class="n" translate="no">UUID</code><code class="p" translate="no">]</code> <code class="o" translate="no">=</code> <code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="n" translate="no">primary_key</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">,</code> <code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="n" translate="no">uuid</code><code class="o" translate="no">.</code><code class="n" translate="no">uuid4</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">email</code><code class="p" translate="no">:</code> <code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code><code class="p" translate="no">]</code> <code class="o" translate="no">=</code> <code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="n" translate="no">String</code><code class="p" translate="no">(</code><code class="n" translate="no">length</code><code class="o" translate="no">=</code><code class="mi" translate="no">255</code><code class="p" translate="no">),</code> <code class="n" translate="no">unique</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">hashed_password</code><code class="p" translate="no">:</code> <code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code><code class="p" translate="no">]</code> <code class="o" translate="no">=</code> <code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="n" translate="no">String</code><code class="p" translate="no">(</code><code class="n" translate="no">length</code><code class="o" translate="no">=</code><code class="mi" translate="no">255</code><code class="p" translate="no">))</code>
    <code class="n" translate="no">is_active</code><code class="p" translate="no">:</code> <code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="nb" translate="no">bool</code><code class="p" translate="no">]</code> <code class="o" translate="no">=</code> <code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">role</code><code class="p" translate="no">:</code> <code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code><code class="p" translate="no">]</code> <code class="o" translate="no">=</code> <code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="s2" translate="no">"USER"</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">created_at</code><code class="p" translate="no">:</code> <code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="n" translate="no">datetime</code><code class="p" translate="no">]</code> <code class="o" translate="no">=</code> <code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">))</code>
    <code class="n" translate="no">updated_at</code><code class="p" translate="no">:</code> <code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="n" translate="no">datetime</code><code class="p" translate="no">]</code> <code class="o" translate="no">=</code> <code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code>
        <code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">),</code> <code class="n" translate="no">onupdate</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">)</code>
    <code class="p" translate="no">)</code>

    <code class="n" translate="no">__table_args__</code> <code class="o" translate="no">=</code> <code class="p" translate="no">(</code><code class="n" translate="no">Index</code><code class="p" translate="no">(</code><code class="s2" translate="no">"ix_users_email"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"email"</code><code class="p" translate="no">),)</code></pre></div>
<p>Utilizzerai i modelli ORM nel livello di accesso ai dati, mentre gli schemi Pydantic convalideranno i dati di autenticazione in entrata e in uscita nel livello endpoint.</p>
<div data-type="example" id="users_schema">
<h5><span class="label">Esempio 8-3. </span>Dichiarare gli schemi Pydantic degli utenti con i validatori dei campi username e password</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># schemas.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">datetime</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">datetime</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">typing</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">pydantic</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="p" translate="no">(</code><code class="n" translate="no">UUID4</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">AfterValidator</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">BaseModel</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">ConfigDict</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Field</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">                      </code><code class="n" translate="no">validate_call</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@validate_call</code><code translate="no">
</code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">validate_username</code><code class="p" translate="no">(</code><code class="n" translate="no">value</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO2-1" id="co_authentication_and_authorization_CO2-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="ow" translate="no">not</code><code translate="no"> </code><code class="n" translate="no">value</code><code class="o" translate="no">.</code><code class="n" translate="no">isalnum</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">raise</code><code translate="no"> </code><code class="ne" translate="no">ValueError</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Username must be alphanumeric</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">value</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@validate_call</code><code translate="no">
</code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">validate_password</code><code class="p" translate="no">(</code><code class="n" translate="no">value</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO2-1" id="co_authentication_and_authorization_CO2-2"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">validations</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="p" translate="no">[</code><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">lambda</code><code translate="no"> </code><code class="n" translate="no">v</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">any</code><code class="p" translate="no">(</code><code class="n" translate="no">char</code><code class="o" translate="no">.</code><code class="n" translate="no">isdigit</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="k" translate="no">for</code><code translate="no"> </code><code class="n" translate="no">char</code><code translate="no"> </code><code class="ow" translate="no">in</code><code translate="no"> </code><code class="n" translate="no">v</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">            </code><code class="s2" translate="no">"</code><code class="s2" translate="no">Password must contain at least one digit</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">lambda</code><code translate="no"> </code><code class="n" translate="no">v</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">any</code><code class="p" translate="no">(</code><code class="n" translate="no">char</code><code class="o" translate="no">.</code><code class="n" translate="no">isupper</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="k" translate="no">for</code><code translate="no"> </code><code class="n" translate="no">char</code><code translate="no"> </code><code class="ow" translate="no">in</code><code translate="no"> </code><code class="n" translate="no">v</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">            </code><code class="s2" translate="no">"</code><code class="s2" translate="no">Password must contain at least one uppercase letter</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">lambda</code><code translate="no"> </code><code class="n" translate="no">v</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">any</code><code class="p" translate="no">(</code><code class="n" translate="no">char</code><code class="o" translate="no">.</code><code class="n" translate="no">islower</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="k" translate="no">for</code><code translate="no"> </code><code class="n" translate="no">char</code><code translate="no"> </code><code class="ow" translate="no">in</code><code translate="no"> </code><code class="n" translate="no">v</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">            </code><code class="s2" translate="no">"</code><code class="s2" translate="no">Password must contain at least one lowercase letter</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">]</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">for</code><code translate="no"> </code><code class="n" translate="no">condition</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">error_message</code><code translate="no"> </code><code class="ow" translate="no">in</code><code translate="no"> </code><code class="n" translate="no">validations</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="ow" translate="no">not</code><code translate="no"> </code><code class="n" translate="no">condition</code><code class="p" translate="no">(</code><code class="n" translate="no">value</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">raise</code><code translate="no"> </code><code class="ne" translate="no">ValueError</code><code class="p" translate="no">(</code><code class="n" translate="no">error_message</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">value</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">ValidUsername</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code translate="no">
</code><code translate="no">    </code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Field</code><code class="p" translate="no">(</code><code class="n" translate="no">min_length</code><code class="o" translate="no">=</code><code class="mi" translate="no">3</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">max_length</code><code class="o" translate="no">=</code><code class="mi" translate="no">20</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">AfterValidator</code><code class="p" translate="no">(</code><code class="n" translate="no">validate_username</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="p" translate="no">]</code><code translate="no">
</code><code class="n" translate="no">ValidPassword</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code translate="no">
</code><code translate="no">    </code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Field</code><code class="p" translate="no">(</code><code class="n" translate="no">min_length</code><code class="o" translate="no">=</code><code class="mi" translate="no">8</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">max_length</code><code class="o" translate="no">=</code><code class="mi" translate="no">64</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">AfterValidator</code><code class="p" translate="no">(</code><code class="n" translate="no">validate_password</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="p" translate="no">]</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">class</code><code translate="no"> </code><code class="nc" translate="no">UserBase</code><code class="p" translate="no">(</code><code class="n" translate="no">BaseModel</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">model_config</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">ConfigDict</code><code class="p" translate="no">(</code><code class="n" translate="no">from_attributes</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO2-2" id="co_authentication_and_authorization_CO2-3"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">username</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">ValidUsername</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">is_active</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">bool</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="kc" translate="no">True</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">role</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">USER</code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">class</code><code translate="no"> </code><code class="nc" translate="no">UserCreate</code><code class="p" translate="no">(</code><code class="n" translate="no">UserBase</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO2-3" id="co_authentication_and_authorization_CO2-4"><img alt="3" src="assets/3.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">password</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">ValidPassword</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">class</code><code translate="no"> </code><code class="nc" translate="no">UserInDB</code><code class="p" translate="no">(</code><code class="n" translate="no">UserBase</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO2-4" id="co_authentication_and_authorization_CO2-5"><img alt="4" src="assets/4.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">hashed_password</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">class</code><code translate="no"> </code><code class="nc" translate="no">UserOut</code><code class="p" translate="no">(</code><code class="n" translate="no">UserBase</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="nb" translate="no">id</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">UUID4</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">created_at</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">datetime</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">updated_at</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">datetime</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_authentication_and_authorization_CO2-1" id="callout_authentication_and_authorization_CO2-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Convalida sia il nome utente che la password per applicare requisiti di sicurezza più elevati.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO2-3" id="callout_authentication_and_authorization_CO2-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Permettere a Pydantic di leggere gli attributi dei modelli ORM di SQLAlchemy invece di dover popolare manualmente gli schemi di Pydantic dai modelli di SQLAlchemy.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO2-4" id="callout_authentication_and_authorization_CO2-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Usa l'ereditarietà per dichiarare diversi schemi Pydantic basati su un modello di base dell'utente.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO2-5" id="callout_authentication_and_authorization_CO2-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Crea uno schema separato che accetti il campo <code translate="no">hashed_password</code> da utilizzare solo per la creazione di nuovi record utente durante il processo di registrazione. Tutti gli altri schemi devono evitare di memorizzare questo campo per eliminare il rischio di fuga della password.</p></dd>
</dl></div>
<p>La creazione dei modelli e degli schemi dei token è abbastanza simile, come puoi vedere nell'<a data-type="xref" href="#token_models">Esempio 8-4</a>.</p>
<div data-type="example" id="token_models">
<h5><span class="label">Esempio 8-4. </span>Dichiarare i modelli ORM a token e gli schemi Pydantic</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># entities.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">datetime</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">UTC</code><code class="p" translate="no">,</code> <code class="n" translate="no">datetime</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">sqlalchemy</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">ForeignKey</code><code class="p" translate="no">,</code> <code class="n" translate="no">Index</code><code class="p" translate="no">,</code> <code class="n" translate="no">String</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">sqlalchemy.orm</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">DeclarativeBase</code><code class="p" translate="no">,</code> <code class="n" translate="no">Mapped</code><code class="p" translate="no">,</code> <code class="n" translate="no">mapped_column</code><code class="p" translate="no">,</code> <code class="n" translate="no">relationship</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">Base</code><code class="p" translate="no">(</code><code class="n" translate="no">DeclarativeBase</code><code class="p" translate="no">):</code>
    <code class="k" translate="no">pass</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">Token</code><code class="p" translate="no">(</code><code class="n" translate="no">Base</code><code class="p" translate="no">):</code>
    <code class="n" translate="no">__tablename__</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"tokens"</code>

    <code class="nb" translate="no">id</code><code class="p" translate="no">:</code> <code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="nb" translate="no">int</code><code class="p" translate="no">]</code> <code class="o" translate="no">=</code> <code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="n" translate="no">primary_key</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">user_id</code><code class="p" translate="no">:</code> <code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="nb" translate="no">int</code><code class="p" translate="no">]</code> <code class="o" translate="no">=</code> <code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="n" translate="no">ForeignKey</code><code class="p" translate="no">(</code><code class="s2" translate="no">"users.id"</code><code class="p" translate="no">))</code>
    <code class="n" translate="no">expires_at</code><code class="p" translate="no">:</code> <code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="n" translate="no">datetime</code><code class="p" translate="no">]</code> <code class="o" translate="no">=</code> <code class="n" translate="no">mapped_column</code><code class="p" translate="no">()</code>
    <code class="n" translate="no">is_active</code><code class="p" translate="no">:</code> <code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="nb" translate="no">bool</code><code class="p" translate="no">]</code> <code class="o" translate="no">=</code> <code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">ip_address</code><code class="p" translate="no">:</code> <code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code> <code class="o" translate="no">|</code> <code class="kc" translate="no">None</code><code class="p" translate="no">]</code> <code class="o" translate="no">=</code> <code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="n" translate="no">String</code><code class="p" translate="no">(</code><code class="n" translate="no">length</code><code class="o" translate="no">=</code><code class="mi" translate="no">255</code><code class="p" translate="no">))</code>
    <code class="n" translate="no">created_at</code><code class="p" translate="no">:</code> <code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="n" translate="no">datetime</code><code class="p" translate="no">]</code> <code class="o" translate="no">=</code> <code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">))</code>
    <code class="n" translate="no">updated_at</code><code class="p" translate="no">:</code> <code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="n" translate="no">datetime</code><code class="p" translate="no">]</code> <code class="o" translate="no">=</code> <code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code>
        <code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">),</code> <code class="n" translate="no">onupdate</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">)</code>
    <code class="p" translate="no">)</code>

    <code class="n" translate="no">user</code> <code class="o" translate="no">=</code> <code class="n" translate="no">relationship</code><code class="p" translate="no">(</code><code class="s2" translate="no">"User"</code><code class="p" translate="no">,</code> <code class="n" translate="no">back_populates</code><code class="o" translate="no">=</code><code class="s2" translate="no">"tokens"</code><code class="p" translate="no">)</code>

    <code class="n" translate="no">__table_args__</code> <code class="o" translate="no">=</code> <code class="p" translate="no">(</code>
        <code class="n" translate="no">Index</code><code class="p" translate="no">(</code><code class="s2" translate="no">"ix_tokens_user_id"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"user_id"</code><code class="p" translate="no">),</code>
        <code class="n" translate="no">Index</code><code class="p" translate="no">(</code><code class="s2" translate="no">"ix_tokens_ip_address"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"ip_address"</code><code class="p" translate="no">),</code>
    <code class="p" translate="no">)</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">User</code><code class="p" translate="no">(</code><code class="n" translate="no">Base</code><code class="p" translate="no">):</code>
    <code class="n" translate="no">__tablename__</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"users"</code>
    <code class="c1" translate="no"># other columns...</code>

    <code class="n" translate="no">tokens</code> <code class="o" translate="no">=</code> <code class="n" translate="no">relationship</code><code class="p" translate="no">(</code>
        <code class="s2" translate="no">"Token"</code><code class="p" translate="no">,</code> <code class="n" translate="no">back_populates</code><code class="o" translate="no">=</code><code class="s2" translate="no">"user"</code><code class="p" translate="no">,</code> <code class="n" translate="no">cascade</code><code class="o" translate="no">=</code><code class="s2" translate="no">"all, delete-orphan"</code>
    <code class="p" translate="no">)</code>

<code class="c1" translate="no"># schemas.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">datetime</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">datetime</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">pydantic</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">BaseModel</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">TokenBase</code><code class="p" translate="no">(</code><code class="n" translate="no">BaseModel</code><code class="p" translate="no">):</code>
    <code class="n" translate="no">user_id</code><code class="p" translate="no">:</code> <code class="nb" translate="no">int</code>
    <code class="n" translate="no">expires_at</code><code class="p" translate="no">:</code> <code class="n" translate="no">datetime</code>
    <code class="n" translate="no">is_active</code><code class="p" translate="no">:</code> <code class="nb" translate="no">bool</code> <code class="o" translate="no">=</code> <code class="kc" translate="no">True</code>
    <code class="n" translate="no">ip_address</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code> <code class="o" translate="no">|</code> <code class="kc" translate="no">None</code> <code class="o" translate="no">=</code> <code class="kc" translate="no">None</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">TokenCreate</code><code class="p" translate="no">(</code><code class="n" translate="no">TokenBase</code><code class="p" translate="no">):</code>
    <code class="k" translate="no">pass</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">TokenOut</code><code class="p" translate="no">(</code><code class="n" translate="no">BaseModel</code><code class="p" translate="no">):</code>
    <code class="n" translate="no">access_token</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code>
    <code class="n" translate="no">token_type</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"Bearer"</code></pre></div>
<p>Il prossimo<a data-startref="ix_ch08-asciidoc8" data-type="indexterm" id="id976"/><a data-startref="ix_ch08-asciidoc7" data-type="indexterm" id="id977"/>, generiamo automaticamente un file di migrazione usando il comando <code translate="no">alembic revision --autogenerate -m "create users and tokens tables</code> in modo da poter specificare i dettagli di entrambe le tabelle seguendo l'<a data-type="xref" href="#users_migration">Esempio 8-5</a>.</p>
<div data-type="example" id="users_migration">
<h5><span class="label">Esempio 8-5. </span>Migrazione del database per creare le tabelle <code translate="no">users</code> e <code translate="no">tokens</code> </h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="sd" translate="no">"""create users and tokens tables

Revision ID: 1234567890ab
Revises:
Create Date: 2025-01-28 12:34:56.789012

"""</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">datetime</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">UTC</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">datetime</code><code translate="no">
</code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="nn" translate="no">sqlalchemy</code><code translate="no"> </code><code class="k" translate="no">as</code><code translate="no"> </code><code class="nn" translate="no">sa</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">alembic</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">op</code><code translate="no">
</code><code translate="no">
</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">upgrade</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">op</code><code class="o" translate="no">.</code><code class="n" translate="no">create_table</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">        </code><code class="s2" translate="no">"</code><code class="s2" translate="no">users</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">id</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">UUID</code><code class="p" translate="no">(</code><code class="n" translate="no">as_uuid</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO3-1" id="co_authentication_and_authorization_CO3-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">email</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">String</code><code class="p" translate="no">(</code><code class="n" translate="no">length</code><code class="o" translate="no">=</code><code class="mi" translate="no">255</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">hashed_password</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">String</code><code class="p" translate="no">(</code><code class="n" translate="no">length</code><code class="o" translate="no">=</code><code class="mi" translate="no">255</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO3-2" id="co_authentication_and_authorization_CO3-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">            </code><code class="s2" translate="no">"</code><code class="s2" translate="no">is_active</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Boolean</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">server_default</code><code class="o" translate="no">=</code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">sql</code><code class="o" translate="no">.</code><code class="n" translate="no">expression</code><code class="o" translate="no">.</code><code class="n" translate="no">true</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO3-3" id="co_authentication_and_authorization_CO3-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">role</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">String</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">server_default</code><code class="o" translate="no">=</code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">text</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">USER</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO3-4" id="co_authentication_and_authorization_CO3-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">created_at</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">DateTime</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">            </code><code class="s2" translate="no">"</code><code class="s2" translate="no">updated_at</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">DateTime</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">onupdate</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO3-5" id="co_authentication_and_authorization_CO3-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">PrimaryKeyConstraint</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">id</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">UniqueConstraint</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">email</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Index</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">ix_users_email</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">email</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO3-6" id="co_authentication_and_authorization_CO3-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">op</code><code class="o" translate="no">.</code><code class="n" translate="no">create_table</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">        </code><code class="s2" translate="no">"</code><code class="s2" translate="no">tokens</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">id</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">UUID</code><code class="p" translate="no">(</code><code class="n" translate="no">as_uuid</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO3-1" id="co_authentication_and_authorization_CO3-7"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">user_id</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Integer</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">expires_at</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">DateTime</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO3-7" id="co_authentication_and_authorization_CO3-8"><img alt="7" src="assets/7.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">is_active</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Boolean</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO3-8" id="co_authentication_and_authorization_CO3-9"><img alt="8" src="assets/8.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">ip_address</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">String</code><code class="p" translate="no">(</code><code class="n" translate="no">length</code><code class="o" translate="no">=</code><code class="mi" translate="no">255</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">nullable</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">created_at</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">DateTime</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">            </code><code class="s2" translate="no">"</code><code class="s2" translate="no">updated_at</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">DateTime</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">onupdate</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO3-9" id="co_authentication_and_authorization_CO3-10"><img alt="9" src="assets/9.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">ForeignKeyConstraint</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">            </code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">user_id</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">            </code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">users.id</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">PrimaryKeyConstraint</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">id</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Index</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">ix_tokens_user_id</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">user_id</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Index</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">ix_tokens_ip_address</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">ip_address</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO3-10" id="co_authentication_and_authorization_CO3-11"><img alt="10" src="assets/10.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">downgrade</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">op</code><code class="o" translate="no">.</code><code class="n" translate="no">drop_table</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">tokens</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">op</code><code class="o" translate="no">.</code><code class="n" translate="no">drop_table</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">users</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_authentication_and_authorization_CO3-1" id="callout_authentication_and_authorization_CO3-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Generare automaticamente identificatori universalmente univoci (UUID) nel livello del database per i record degli utenti e dei token per impedire agli aggressori di indovinare gli identificatori delle risorse sensibili (ad esempio, i record degli utenti o dei token).</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO3-2" id="callout_authentication_and_authorization_CO3-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Evita di memorizzare stringhe di password grezze nel database per ridurre<span class="keep-together">le vulnerabilità</span> della sicurezza.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO3-3" id="callout_authentication_and_authorization_CO3-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Aggiungi la possibilità di abilitare o disabilitare l'accesso all'account.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO3-4" id="callout_authentication_and_authorization_CO3-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Aggiungi la possibilità di specificare ruoli utente come <code translate="no">USER</code> e <code translate="no">ADMIN</code> per gestire i livelli di accesso di un account. I controlli di autorizzazione utilizzeranno il campo <code translate="no">role</code> per gestire l'accesso alle risorse privilegiate.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO3-5" id="callout_authentication_and_authorization_CO3-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a></dt>
<dd><p>Stampa automaticamente la creazione e gli aggiornamenti degli utenti per scopi di monitoraggio e sicurezza.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO3-6" id="callout_authentication_and_authorization_CO3-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a></dt>
<dd><p>Aggiungi un vincolo univoco e un indice secondario sul campo email per ottimizzare le query degli utenti per email ed eliminare la possibilità di creare account email duplicati.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO3-8" id="callout_authentication_and_authorization_CO3-7"><img alt="7" src="assets/7.png" width="12" height="12"/></a></dt>
<dd><p>I token devono scadere dopo un breve periodo di tempo per ridurre la finestra temporale in cui i token esposti possono essere utilizzati impropriamente dagli aggressori.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO3-9" id="callout_authentication_and_authorization_CO3-8"><img alt="8" src="assets/8.png" width="12" height="12"/></a></dt>
<dd><p>Aggiungi la possibilità di disabilitare i token che non devono più essere validi perché esposti o se un utente si è disconnesso.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO3-10" id="callout_authentication_and_authorization_CO3-9"><img alt="9" src="assets/9.png" width="12" height="12"/></a></dt>
<dd><p>Traccia i tempi di creazione e aggiornamento dei token per il monitoraggio e la sicurezza.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO3-11" id="callout_authentication_and_authorization_CO3-10"><img alt="10" src="assets/10.png" width="12" height="12"/></a></dt>
<dd><p>Crea indici secondari sui campi <code translate="no">user_id</code> e <code translate="no">ip_address</code> per ottimizzare le query sui token in base a questi campi.</p></dd>
</dl></div>
<p>Ora esegui il comando <code translate="no">alembic upgrade head</code> per eseguire la migrazione dell'<a data-type="xref" href="#users_migration">Esempio 8-5</a> nel tuo database e creare le tabelle <code translate="no">users</code> e <code translate="no">tokens</code>.</p>
<p class="less_space pagebreak-before">Una volta dichiarati i modelli ORM e gli schemi Pydantic, puoi concentrarti sulla logica del meccanismo di autenticazione.</p>
<p>La<a data-type="xref" href="#jwt_architecture">Figura 8-5</a> mostra l'architettura del sistema di autenticazione JWT che implementerai nel tuo servizio FastAPI GenAI.</p>
<figure><div class="figure" id="jwt_architecture">
<img alt="bgai 0805" src="assets/bgai_0805.png" width="1442" height="818"/>
<h6><span class="label">Figura 8-5. </span>Architettura del sistema di autenticazione JWT</h6>
</div></figure>
<p>Nei seguenti esempi di codice, vedrai come implementare i flussi di autenticazione principali, a partire dalla registrazione dell'utente e dalla generazione di JWT.<a data-startref="ix_ch08-asciidoc6" data-type="indexterm" id="id978"/></p>
</div></section>
<section data-pdf-bookmark="Hashing and salting" data-type="sect3"><div class="sect3" id="id118">
<h3>Hashing e salatura</h3>
<p><a data-primary="hashing" data-type="indexterm" id="ix_ch08-asciidoc9"/><a data-primary="JSON Web Tokens (JWT) authentication" data-secondary="hashing and salting" data-type="indexterm" id="ix_ch08-asciidoc10"/>Il primo passo da fare dopo aver creato le tabelle <code translate="no">users</code> e <code translate="no">tokens</code> nel database è quello di memorizzare i nuovi utenti nel database al momento della registrazione. Tuttavia, dovresti evitare di memorizzare le password in chiaro, perché se il database viene compromesso, i malintenzionati avranno le credenziali di ogni utente.</p>
<p>Invece, il meccanismo di autenticazione sfrutterà un <em>algoritmo di hashing</em> che converte le password semplici in una stringa codificata che non può essere decodificata nella sua forma originale. Poiché il processo di decodifica non è reversibile, gli algoritmi di hashing crittografici differiscono dalle funzioni di codifica/decodifica standard come Base64.</p>
<p class="less_space pagebreak-before">Sebbene la memorizzazione di password con hash sia più sicura rispetto alla memorizzazione di password semplici, non fornisce una protezione sufficiente.<a data-primary="rainbow tables" data-type="indexterm" id="id979"/>Se un database di password con hash cade nelle mani degli aggressori, questi possono utilizzare tabelle di hash precompilate, comunemente chiamate <em>tabelle arcobaleno</em>. Gli aggressori possono utilizzare le tabelle arcobaleno per entrare nel tuo sistema con la forza bruta recuperando le password in chiaro.<a data-primary="salting" data-type="indexterm" id="ix_ch08-asciidoc11"/>Per proteggerti da questi attacchi con forza bruta, devi anche introdurre un elemento di casualità nel processo di hashing utilizzando una tecnica chiamata <em>salatura</em>.</p>
<p>Con i sali, l'algoritmo di hashing crittografico produce password diverse, anche se gli utenti possono registrarsi con password comuni, compromesse o duplicate.</p>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>L'hashing delle password con un sale casuale protegge dagli attacchi brute-force che utilizzano le tabelle arcobaleno.<a data-primary="credential stuffing" data-type="indexterm" id="id980"/><a data-primary="password spraying" data-type="indexterm" id="id981"/>Tuttavia, non protegge dal <em>password spraying</em>, in cui gli aggressori utilizzano un database di password comuni, o dal <em>credential stuffing</em>, in cui gli aggressori enumerano un elenco di password compromesse.</p>
</div>
<p>Durante la salatura, la funzione di hashing genera un sale casuale da aggiungere alla password semplice prima dell'hashing e quindi genera una password con hash.<sup><a data-type="noteref" href="ch08.html#id982" id="id982-marker" translate="no">4</a></sup>
Prima di memorizzare la password con hash nel database, il sale viene aggiunto alla password con hash per poterla recuperare successivamente durante la verifica.</p>
<p>Quando gli utenti registrati tentano di accedere, devono fornire la stessa password che hanno usato per creare il loro account. Durante il processo di verifica della password, la password fornita dall'utente viene sottoposta a hashish utilizzando lo stesso sale usato durante la registrazione, che viene recuperato dal database. Se la password hash generata è esattamente identica a quella presente nel database, allora l'utente viene autenticato. In caso contrario, si può tranquillamente supporre che siano state fornite credenziali sbagliate.</p>
<p>La salatura e l'hashing sono tecniche potenti che impediscono agli aggressori di penetrare brutalmente nel tuo sistema con le tabelle arcobaleno. Puoi vedere l'intero processo di hashing e salatura nella <a data-type="xref" href="#password_hashing">Figura 8-6</a>.</p>
<figure><div class="figure" id="password_hashing">
<img alt="bgai 0806" src="assets/bgai_0806.png" width="1441" height="1363"/>
<h6><span class="label">Figura 8-6. </span>Meccanismo di salatura dell'hash della password</h6>
</div></figure>
<p>Il servizio password mostrato nella <a data-type="xref" href="#password_hashing">Figura 8-6</a> è implementato come <code translate="no">PasswordService</code> nell'<a data-type="xref" href="#password_service">Esempio 8-6</a>.</p>
<div data-type="example" id="password_service">
<h5><span class="label">Esempio 8-6. </span>Implementare un servizio di password</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># services/auth.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code class="nn" translate="no">.</code><code class="nn" translate="no">security</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">HTTPBearer</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">passlib</code><code class="nn" translate="no">.</code><code class="nn" translate="no">context</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">CryptContext</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">class</code><code translate="no"> </code><code class="nc" translate="no">PasswordService</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">security</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">HTTPBearer</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">pwd_context</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">CryptContext</code><code class="p" translate="no">(</code><code class="n" translate="no">schemes</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">bcrypt</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO4-1" id="co_authentication_and_authorization_CO4-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">verify_password</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">        </code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">password</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">hashed_password</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="nb" translate="no">bool</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">pwd_context</code><code class="o" translate="no">.</code><code class="n" translate="no">verify</code><code class="p" translate="no">(</code><code class="n" translate="no">password</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">hashed_password</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO4-2" id="co_authentication_and_authorization_CO4-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">get_password_hash</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">password</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">pwd_context</code><code class="o" translate="no">.</code><code class="n" translate="no">hash</code><code class="p" translate="no">(</code><code class="n" translate="no">password</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO4-2" id="co_authentication_and_authorization_CO4-3"><img alt="2" src="assets/2.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_authentication_and_authorization_CO4-1" id="callout_authentication_and_authorization_CO4-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Crea un <code translate="no">AuthService</code> con un contesto di segreti e password gestito dalla libreria <code translate="no">bcrypt</code> che gestirà l'hashing e la verifica delle password degli utenti.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO4-2" id="callout_authentication_and_authorization_CO4-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Utilizza l'algoritmo di crittografia di <code translate="no">bcrypt</code>e il segreto dell'applicazione per eseguire l'hash e verificare le password.</p></dd>
</dl></div>
<p>La libreria crittografica <code translate="no">bcrypt</code> fornisce le funzionalità principali di <code translate="no">Password​Ser⁠vice</code> per l'hashing e la verifica delle password. Utilizzando questo servizio, le richieste possono essere autenticate.</p>
<p>Se una richiesta non può essere autenticata, dovrai anche sollevare delle eccezioni legate all'autorizzazione, come mostrato nell'<a data-type="xref" href="#auth_exceptions">Esempio 8-7</a>.</p>
<div data-type="example" id="auth_exceptions">
<h5><span class="label">Esempio 8-7. </span>Creare eccezioni di autenticazione</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># exceptions.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">fastapi</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">HTTPException</code><code class="p" translate="no">,</code> <code class="n" translate="no">status</code>

<code class="n" translate="no">UnauthorizedException</code> <code class="o" translate="no">=</code> <code class="n" translate="no">HTTPException</code><code class="p" translate="no">(</code>
    <code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="n" translate="no">status</code><code class="o" translate="no">.</code><code class="n" translate="no">HTTP_401_UNAUTHORIZED</code><code class="p" translate="no">,</code>
    <code class="n" translate="no">detail</code><code class="o" translate="no">=</code><code class="s2" translate="no">"Not authenticated"</code><code class="p" translate="no">,</code>
    <code class="n" translate="no">headers</code><code class="o" translate="no">=</code><code class="p" translate="no">{</code><code class="s2" translate="no">"WWW-Authenticate"</code><code class="p" translate="no">:</code> <code class="s2" translate="no">"Bearer"</code><code class="p" translate="no">},</code>
<code class="p" translate="no">)</code>

<code class="n" translate="no">AlreadyRegisteredException</code> <code class="o" translate="no">=</code> <code class="n" translate="no">HTTPException</code><code class="p" translate="no">(</code>
    <code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="n" translate="no">status</code><code class="o" translate="no">.</code><code class="n" translate="no">HTTP_400_BAD_REQUEST</code><code class="p" translate="no">,</code>
    <code class="n" translate="no">detail</code><code class="o" translate="no">=</code><code class="s2" translate="no">"Username already registered"</code><code class="p" translate="no">,</code>
<code class="p" translate="no">)</code></pre></div>
<p>Le due eccezioni HTTP di autorizzazione più comuni sono legate ad accessi non autorizzati o a richieste errate dovute all'utilizzo di nomi utente già usati.</p>
<p>Una volta verificata l'identità di un utente tramite le sue credenziali, dovrai rilasciargli un <em>token di accesso</em>. Questi token dovrebbero avere una vita breve per ridurre l'intervallo di tempo in cui un malintenzionato può utilizzare il token per accedere alle risorse se il token viene rubato.</p>
<p>Per ridurre le dimensioni dei token e proteggerli da eventuali <em>falsificazioni</em>, il servizio token firmerà (utilizzando un segreto) e codificherà i payload dei token con una codifica come Base64. Il payload conterrà normalmente i dati dell'utente come l'ID, il ruolo, il sistema di emissione e le date di scadenza.</p>
<p>Il servizio token può anche decodificare il payload dei token ricevuti e verificarne la validità durante il processo di autenticazione.</p>
<p>Infine, anche il servizio token avrà bisogno di accedere al database per memorizzare e recuperare i token per svolgere le sue funzioni. Pertanto, dovrà ereditare un <code translate="no">TokenRepository</code>, come mostrato nell'<a data-type="xref" href="#token_repository">Esempio 8-8</a>.</p>
<div data-type="example" id="token_repository">
<h5><span class="label">Esempio 8-8. </span>Implementazione del repository di token</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># repositories.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">entities</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Token</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">repositories.interfaces</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Repository</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">schemas</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">TokenCreate</code><code class="p" translate="no">,</code> <code class="n" translate="no">TokenUpdate</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">sqlalchemy</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">select</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">sqlalchemy.ext.asyncio</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">AsyncSession</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">TokenRepository</code><code class="p" translate="no">(</code><code class="n" translate="no">Repository</code><code class="p" translate="no">):</code>
    <code class="k" translate="no">def</code> <code class="fm" translate="no">__init__</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code> <code class="n" translate="no">session</code><code class="p" translate="no">:</code> <code class="n" translate="no">AsyncSession</code><code class="p" translate="no">)</code> <code class="o" translate="no">-&gt;</code> <code class="kc" translate="no">None</code><code class="p" translate="no">:</code>
        <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code> <code class="o" translate="no">=</code> <code class="n" translate="no">session</code>

    <code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">list</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code> <code class="n" translate="no">skip</code><code class="p" translate="no">:</code> <code class="nb" translate="no">int</code><code class="p" translate="no">,</code> <code class="n" translate="no">take</code><code class="p" translate="no">:</code> <code class="nb" translate="no">int</code><code class="p" translate="no">)</code> <code class="o" translate="no">-&gt;</code> <code class="nb" translate="no">list</code><code class="p" translate="no">[</code><code class="n" translate="no">Token</code><code class="p" translate="no">]:</code>
        <code class="k" translate="no">async</code> <code class="k" translate="no">with</code> <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">begin</code><code class="p" translate="no">():</code>
            <code class="n" translate="no">result</code> <code class="o" translate="no">=</code> <code class="k" translate="no">await</code> <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">execute</code><code class="p" translate="no">(</code>
                <code class="n" translate="no">select</code><code class="p" translate="no">(</code><code class="n" translate="no">Token</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">offset</code><code class="p" translate="no">(</code><code class="n" translate="no">skip</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">limit</code><code class="p" translate="no">(</code><code class="n" translate="no">take</code><code class="p" translate="no">)</code>
            <code class="p" translate="no">)</code>
        <code class="k" translate="no">return</code> <code class="p" translate="no">[</code><code class="n" translate="no">r</code> <code class="k" translate="no">for</code> <code class="n" translate="no">r</code> <code class="ow" translate="no">in</code> <code class="n" translate="no">result</code><code class="o" translate="no">.</code><code class="n" translate="no">scalars</code><code class="p" translate="no">()</code><code class="o" translate="no">.</code><code class="n" translate="no">all</code><code class="p" translate="no">()]</code>

    <code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">get</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code> <code class="n" translate="no">token_id</code><code class="p" translate="no">:</code> <code class="nb" translate="no">int</code><code class="p" translate="no">)</code> <code class="o" translate="no">-&gt;</code> <code class="n" translate="no">Token</code> <code class="o" translate="no">|</code> <code class="kc" translate="no">None</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">async</code> <code class="k" translate="no">with</code> <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">begin</code><code class="p" translate="no">():</code>
            <code class="n" translate="no">result</code> <code class="o" translate="no">=</code> <code class="k" translate="no">await</code> <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">execute</code><code class="p" translate="no">(</code>
                <code class="n" translate="no">select</code><code class="p" translate="no">(</code><code class="n" translate="no">Token</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">where</code><code class="p" translate="no">(</code><code class="n" translate="no">Token</code><code class="o" translate="no">.</code><code class="n" translate="no">id</code> <code class="o" translate="no">==</code> <code class="n" translate="no">token_id</code><code class="p" translate="no">)</code>
            <code class="p" translate="no">)</code>
        <code class="k" translate="no">return</code> <code class="n" translate="no">result</code><code class="o" translate="no">.</code><code class="n" translate="no">scalars</code><code class="p" translate="no">()</code><code class="o" translate="no">.</code><code class="n" translate="no">first</code><code class="p" translate="no">()</code>

    <code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">create</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code> <code class="n" translate="no">token</code><code class="p" translate="no">:</code> <code class="n" translate="no">TokenCreate</code><code class="p" translate="no">)</code> <code class="o" translate="no">-&gt;</code> <code class="n" translate="no">Token</code><code class="p" translate="no">:</code>
        <code class="n" translate="no">new_token</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Token</code><code class="p" translate="no">(</code><code class="o" translate="no">**</code><code class="n" translate="no">token</code><code class="o" translate="no">.</code><code class="n" translate="no">dict</code><code class="p" translate="no">())</code>
        <code class="k" translate="no">async</code> <code class="k" translate="no">with</code> <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">begin</code><code class="p" translate="no">():</code>
            <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">add</code><code class="p" translate="no">(</code><code class="n" translate="no">new_token</code><code class="p" translate="no">)</code>
            <code class="k" translate="no">await</code> <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">commit</code><code class="p" translate="no">()</code>
            <code class="k" translate="no">await</code> <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">refresh</code><code class="p" translate="no">(</code><code class="n" translate="no">new_token</code><code class="p" translate="no">)</code>
        <code class="k" translate="no">return</code> <code class="n" translate="no">new_token</code>

    <code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">update</code><code class="p" translate="no">(</code>
        <code class="bp" translate="no">self</code><code class="p" translate="no">,</code> <code class="n" translate="no">token_id</code><code class="p" translate="no">:</code> <code class="nb" translate="no">int</code><code class="p" translate="no">,</code> <code class="n" translate="no">updated_token</code><code class="p" translate="no">:</code> <code class="n" translate="no">TokenUpdate</code>
    <code class="p" translate="no">)</code> <code class="o" translate="no">-&gt;</code> <code class="n" translate="no">Token</code> <code class="o" translate="no">|</code> <code class="kc" translate="no">None</code><code class="p" translate="no">:</code>
        <code class="n" translate="no">token</code> <code class="o" translate="no">=</code> <code class="k" translate="no">await</code> <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="n" translate="no">token_id</code><code class="p" translate="no">)</code>
        <code class="k" translate="no">if</code> <code class="ow" translate="no">not</code> <code class="n" translate="no">token</code><code class="p" translate="no">:</code>
            <code class="k" translate="no">return</code> <code class="kc" translate="no">None</code>
        <code class="k" translate="no">for</code> <code class="n" translate="no">key</code><code class="p" translate="no">,</code> <code class="n" translate="no">value</code> <code class="ow" translate="no">in</code> <code class="n" translate="no">updated_token</code><code class="o" translate="no">.</code><code class="n" translate="no">dict</code><code class="p" translate="no">(</code><code class="n" translate="no">exclude_unset</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">items</code><code class="p" translate="no">():</code>
            <code class="nb" translate="no">setattr</code><code class="p" translate="no">(</code><code class="n" translate="no">token</code><code class="p" translate="no">,</code> <code class="n" translate="no">key</code><code class="p" translate="no">,</code> <code class="n" translate="no">value</code><code class="p" translate="no">)</code>
        <code class="k" translate="no">async</code> <code class="k" translate="no">with</code> <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">begin</code><code class="p" translate="no">():</code>
            <code class="k" translate="no">await</code> <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">commit</code><code class="p" translate="no">()</code>
            <code class="k" translate="no">await</code> <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">refresh</code><code class="p" translate="no">(</code><code class="n" translate="no">token</code><code class="p" translate="no">)</code>
        <code class="k" translate="no">return</code> <code class="n" translate="no">token</code>

    <code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">delete</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code> <code class="n" translate="no">token_id</code><code class="p" translate="no">:</code> <code class="nb" translate="no">int</code><code class="p" translate="no">)</code> <code class="o" translate="no">-&gt;</code> <code class="kc" translate="no">None</code><code class="p" translate="no">:</code>
        <code class="n" translate="no">token</code> <code class="o" translate="no">=</code> <code class="k" translate="no">await</code> <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="n" translate="no">token_id</code><code class="p" translate="no">)</code>
        <code class="k" translate="no">if</code> <code class="ow" translate="no">not</code> <code class="n" translate="no">token</code><code class="p" translate="no">:</code>
            <code class="k" translate="no">return</code>
        <code class="k" translate="no">async</code> <code class="k" translate="no">with</code> <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">begin</code><code class="p" translate="no">():</code>
            <code class="k" translate="no">await</code> <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">delete</code><code class="p" translate="no">(</code><code class="n" translate="no">token</code><code class="p" translate="no">)</code>
            <code class="k" translate="no">await</code> <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">commit</code><code class="p" translate="no">()</code></pre></div>
<p>Con l'implementazione di <code translate="no">TokenRepository</code>, puoi ora sviluppare <code translate="no">TokenService</code>, come mostrato nell'<a data-type="xref" href="#token_service">Esempio 8-9</a>.</p>
<div data-type="example" id="token_service">
<h5><span class="label">Esempio 8-9. </span>Implementare un servizio di token ereditando il repository dei token</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># services/auth.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">datetime</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">UTC</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">datetime</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">timedelta</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">exceptions</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">UnauthorizedException</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">jose</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">JWTError</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">jwt</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">pydantic</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">UUID4</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">repositories</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">TokenRepository</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">schemas</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">TokenCreate</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">TokenUpdate</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">class</code><code translate="no"> </code><code class="nc" translate="no">TokenService</code><code class="p" translate="no">(</code><code class="n" translate="no">TokenRepository</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">secret_key</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">your_secret_key</code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">algorithm</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">HS256</code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">expires_in_minutes</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="mi" translate="no">60</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO5-1" id="co_authentication_and_authorization_CO5-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">create_access_token</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">data</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">dict</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">expires_delta</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">timedelta</code><code translate="no"> </code><code class="o" translate="no">|</code><code translate="no"> </code><code class="kc" translate="no">None</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="kc" translate="no">None</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO5-2" id="co_authentication_and_authorization_CO5-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">to_encode</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">data</code><code class="o" translate="no">.</code><code class="n" translate="no">copy</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="n" translate="no">expires_delta</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">expire</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">+</code><code translate="no"> </code><code class="n" translate="no">expires_delta</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">else</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">expire</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">+</code><code translate="no"> </code><code class="n" translate="no">timedelta</code><code class="p" translate="no">(</code><code class="n" translate="no">minutes</code><code class="o" translate="no">=</code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">expires_in_minutes</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">token_id</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">create</code><code class="p" translate="no">(</code><code class="n" translate="no">TokenCreate</code><code class="p" translate="no">(</code><code class="n" translate="no">expires_at</code><code class="o" translate="no">=</code><code class="n" translate="no">expire</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO5-3" id="co_authentication_and_authorization_CO5-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">to_encode</code><code class="o" translate="no">.</code><code class="n" translate="no">update</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">exp</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">expire</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">iss</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">your_service_name</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">sub</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">token_id</code><code class="p" translate="no">}</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO5-4" id="co_authentication_and_authorization_CO5-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">encoded_jwt</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">jwt</code><code class="o" translate="no">.</code><code class="n" translate="no">encode</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">to_encode</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">secret_key</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">algorithm</code><code class="o" translate="no">=</code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">algorithm</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO5-5" id="co_authentication_and_authorization_CO5-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">encoded_jwt</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">deactivate</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">token_id</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">UUID4</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="kc" translate="no">None</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">update</code><code class="p" translate="no">(</code><code class="n" translate="no">TokenUpdate</code><code class="p" translate="no">(</code><code class="nb" translate="no">id</code><code class="o" translate="no">=</code><code class="n" translate="no">token_id</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">is_active</code><code class="o" translate="no">=</code><code class="kc" translate="no">False</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">decode</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">encoded_token</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="nb" translate="no">dict</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">try</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">jwt</code><code class="o" translate="no">.</code><code class="n" translate="no">decode</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">encoded_token</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">secret_key</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">algorithms</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">algorithm</code><code class="p" translate="no">]</code><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">except</code><code translate="no"> </code><code class="n" translate="no">JWTError</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">raise</code><code translate="no"> </code><code class="n" translate="no">UnauthorizedException</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">validate</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">token_id</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">UUID4</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="nb" translate="no">bool</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="p" translate="no">(</code><code class="n" translate="no">token</code><code translate="no"> </code><code class="o" translate="no">:=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="n" translate="no">token_id</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="ow" translate="no">is</code><code translate="no"> </code><code class="ow" translate="no">not</code><code translate="no"> </code><code class="kc" translate="no">None</code><code translate="no"> </code><code class="ow" translate="no">and</code><code translate="no"> </code><code class="n" translate="no">token</code><code class="o" translate="no">.</code><code class="n" translate="no">is_active</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_authentication_and_authorization_CO5-1" id="callout_authentication_and_authorization_CO5-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Implementa un <code translate="no">TokenService</code> per l'emissione e la verifica dei token di autenticazione. Le configurazioni sono condivise da tutte le istanze del servizio.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO5-2" id="callout_authentication_and_authorization_CO5-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Genera token di accesso basati sui dati forniti al servizio token con date di scadenza.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO5-3" id="callout_authentication_and_authorization_CO5-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Crea un record di token nel database e ottiene un identificatore unico.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO5-4" id="callout_authentication_and_authorization_CO5-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Il token di accesso deve scadere entro un'ora, quindi il campo calcolato <code translate="no">exp</code> verrà utilizzato per verificare la validità del token.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO5-5" id="callout_authentication_and_authorization_CO5-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a></dt>
<dd><p>Codifica il token generato in una stringa codificata utilizzando l'algoritmo <code translate="no">base64</code>.</p></dd>
</dl></div>
<p>Ora che hai un <code translate="no">PasswordService</code> e un <code translate="no">TokenService</code>, puoi completare il meccanismo di autenticazione JWT di base con un <code translate="no">AuthService</code> dedicato di livello superiore.</p>
<p>L<a data-type="xref" href="#auth_service">'esempio 8-10</a> mostra l'implementazione della classe <code translate="no">AuthService</code> che contiene diverse funzioni di dipendenza per la registrazione degli utenti, l'emissione di token di accesso e la protezione dei percorsi API.</p>
<div data-type="example" id="auth_service">
<h5><span class="label">Esempio 8-10. </span>Implementare un servizio auth per gestire la logica di autenticazione di livello superiore</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># services/auth.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">typing</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">databases</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">DBSessionDep</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">entities</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Token</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">User</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">UserCreate</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">UserInDB</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">exceptions</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">AlreadyRegisteredException</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">UnauthorizedException</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code class="nn" translate="no">.</code><code class="nn" translate="no">security</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="p" translate="no">(</code><code class="n" translate="no">HTTPAuthorizationCredentials</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">HTTPBearer</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">                              </code><code class="n" translate="no">OAuth2PasswordRequestForm</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">services</code><code class="nn" translate="no">.</code><code class="nn" translate="no">auth</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">PasswordService</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">TokenService</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">services</code><code class="nn" translate="no">.</code><code class="nn" translate="no">users</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">UserService</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">security</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">HTTPBearer</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="n" translate="no">LoginFormDep</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="n" translate="no">OAuth2PasswordRequestForm</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code><code translate="no">
</code><code class="n" translate="no">AuthHeaderDep</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="n" translate="no">HTTPAuthorizationCredentials</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">security</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">class</code><code translate="no"> </code><code class="nc" translate="no">AuthService</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="fm" translate="no">__init__</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">DBSessionDep</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">password_service</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">PasswordService</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">token_service</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">TokenService</code><code class="p" translate="no">(</code><code class="n" translate="no">session</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">user_service</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">UserService</code><code class="p" translate="no">(</code><code class="n" translate="no">session</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">register_user</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">user</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">UserCreate</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">User</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">user_service</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="n" translate="no">user</code><code class="o" translate="no">.</code><code class="n" translate="no">username</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">raise</code><code translate="no"> </code><code class="n" translate="no">AlreadyRegisteredException</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">hashed_password</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">password_service</code><code class="o" translate="no">.</code><code class="n" translate="no">get_password_hash</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">user</code><code class="o" translate="no">.</code><code class="n" translate="no">password</code><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">user_service</code><code class="o" translate="no">.</code><code class="n" translate="no">create</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">UserInDB</code><code class="p" translate="no">(</code><code class="n" translate="no">username</code><code class="o" translate="no">=</code><code class="n" translate="no">user</code><code class="o" translate="no">.</code><code class="n" translate="no">username</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">hashed_password</code><code class="o" translate="no">=</code><code class="n" translate="no">hashed_password</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">authenticate_user</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">form_data</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">LoginFormDep</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">Token</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO6-1" id="co_authentication_and_authorization_CO6-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="ow" translate="no">not</code><code translate="no"> </code><code class="p" translate="no">(</code><code class="n" translate="no">user</code><code translate="no"> </code><code class="o" translate="no">:=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">user_service</code><code class="o" translate="no">.</code><code class="n" translate="no">get_user</code><code class="p" translate="no">(</code><code class="n" translate="no">form_data</code><code class="o" translate="no">.</code><code class="n" translate="no">username</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">raise</code><code translate="no"> </code><code class="n" translate="no">UnauthorizedException</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="ow" translate="no">not</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">password_service</code><code class="o" translate="no">.</code><code class="n" translate="no">verify_password</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">form_data</code><code class="o" translate="no">.</code><code class="n" translate="no">password</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">user</code><code class="o" translate="no">.</code><code class="n" translate="no">hashed_password</code><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">raise</code><code translate="no"> </code><code class="n" translate="no">UnauthorizedException</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">token_service</code><code class="o" translate="no">.</code><code class="n" translate="no">create_access_token</code><code class="p" translate="no">(</code><code class="n" translate="no">user</code><code class="o" translate="no">.</code><code class="n" translate="no">_asdict</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">get_current_user</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">credentials</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">AuthHeaderDep</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">User</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="n" translate="no">credentials</code><code class="o" translate="no">.</code><code class="n" translate="no">scheme</code><code translate="no"> </code><code class="o" translate="no">!=</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">Bearer</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">raise</code><code translate="no"> </code><code class="n" translate="no">UnauthorizedException</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="ow" translate="no">not</code><code translate="no"> </code><code class="p" translate="no">(</code><code class="n" translate="no">token</code><code translate="no"> </code><code class="o" translate="no">:=</code><code translate="no"> </code><code class="n" translate="no">credentials</code><code class="o" translate="no">.</code><code class="n" translate="no">credentials</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">raise</code><code translate="no"> </code><code class="n" translate="no">UnauthorizedException</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">payload</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">token_service</code><code class="o" translate="no">.</code><code class="n" translate="no">decode</code><code class="p" translate="no">(</code><code class="n" translate="no">token</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="ow" translate="no">not</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">token_service</code><code class="o" translate="no">.</code><code class="n" translate="no">validate</code><code class="p" translate="no">(</code><code class="n" translate="no">payload</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">sub</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">raise</code><code translate="no"> </code><code class="n" translate="no">UnauthorizedException</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="ow" translate="no">not</code><code translate="no"> </code><code class="p" translate="no">(</code><code class="n" translate="no">username</code><code translate="no"> </code><code class="o" translate="no">:=</code><code translate="no"> </code><code class="n" translate="no">payload</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">username</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">raise</code><code translate="no"> </code><code class="n" translate="no">UnauthorizedException</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="ow" translate="no">not</code><code translate="no"> </code><code class="p" translate="no">(</code><code class="n" translate="no">user</code><code translate="no"> </code><code class="o" translate="no">:=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">user_service</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="n" translate="no">username</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">raise</code><code translate="no"> </code><code class="n" translate="no">UnauthorizedException</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">user</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">logout</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">credentials</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">AuthHeaderDep</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="kc" translate="no">None</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">payload</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">token_service</code><code class="o" translate="no">.</code><code class="n" translate="no">decode</code><code class="p" translate="no">(</code><code class="n" translate="no">credentials</code><code class="o" translate="no">.</code><code class="n" translate="no">credentials</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">token_service</code><code class="o" translate="no">.</code><code class="n" translate="no">deactivate</code><code class="p" translate="no">(</code><code class="n" translate="no">payload</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">sub</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="c1" translate="no"># Add Password Reset Method</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">reset_password</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_authentication_and_authorization_CO6-1" id="callout_authentication_and_authorization_CO6-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>La logica di autenticazione principale dell'applicazione che verifica l'esistenza di un utente e le credenziali della sua password. Restituisce <code translate="no">False</code> se i controlli falliscono.</p></dd>
</dl></div>
<p>Ora puoi utilizzare <code translate="no">AuthService</code> per registrare e autenticare gli utenti utilizzando le loro credenziali. Fai riferimento all'<a data-type="xref" href="#auth_controllers">Esempio 8-11</a> per vedere come <code translate="no">AuthService</code> viene utilizzato per creare le dipendenze necessarie per un router di autenticazione dedicato.</p>
<div data-type="example" id="auth_controllers">
<h5><span class="label">Esempio 8-11. </span>Implementare i controllori di autenticazione per abilitare le funzionalità di login e registrazione</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># routes/auth.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">typing</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">entities</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">User</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">APIRouter</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">models</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">TokenOut</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">UserOut</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">services</code><code class="nn" translate="no">.</code><code class="nn" translate="no">auth</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">AuthService</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">auth_service</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">AuthService</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="n" translate="no">RegisterUserDep</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="n" translate="no">User</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">auth_service</code><code class="o" translate="no">.</code><code class="n" translate="no">register_user</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code><code translate="no">
</code><code class="n" translate="no">AuthenticateUserCredDep</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code translate="no">
</code><code translate="no">    </code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">auth_service</code><code class="o" translate="no">.</code><code class="n" translate="no">authenticate_user_with_credentials</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="p" translate="no">]</code><code translate="no">
</code><code class="n" translate="no">AuthenticateUserTokenDep</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="n" translate="no">User</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">auth_service</code><code class="o" translate="no">.</code><code class="n" translate="no">register_user</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code><code translate="no">
</code><code class="n" translate="no">PasswordResetDep</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="kc" translate="no">None</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">auth_service</code><code class="o" translate="no">.</code><code class="n" translate="no">reset_password</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO7-1" id="co_authentication_and_authorization_CO7-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">router</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">APIRouter</code><code class="p" translate="no">(</code><code class="n" translate="no">prefix</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/auth</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">tags</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Authentication</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO7-2" id="co_authentication_and_authorization_CO7-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/register</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">register_user_controller</code><code class="p" translate="no">(</code><code class="n" translate="no">new_user</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">RegisterUserDep</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">UserOut</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">new_user</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/token</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO7-3" id="co_authentication_and_authorization_CO7-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">login_for_access_token_controller</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">access_token</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">AuthenticateUserCredDep</code><code class="p" translate="no">,</code><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">TokenOut</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">access_token</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">access_token</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">token_type</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">bearer</code><code class="s2" translate="no">"</code><code class="p" translate="no">}</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/logout</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">dependencies</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">auth_service</code><code class="o" translate="no">.</code><code class="n" translate="no">logout</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO7-3" id="co_authentication_and_authorization_CO7-4"><img alt="3" src="assets/3.png" width="12" height="12"/></a><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO7-4" id="co_authentication_and_authorization_CO7-5"><img alt="4" src="assets/4.png" width="12" height="12"/></a><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">logout_access_token_controller</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="nb" translate="no">dict</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">message</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">Logged out</code><code class="s2" translate="no">"</code><code class="p" translate="no">}</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">reset-password</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO7-3" id="co_authentication_and_authorization_CO7-6"><img alt="3" src="assets/3.png" width="12" height="12"/></a><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">reset_password_controller</code><code class="p" translate="no">(</code><code class="n" translate="no">credentials</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="nb" translate="no">dict</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="p" translate="no">{</code><code translate="no">
</code><code translate="no">        </code><code class="s2" translate="no">"</code><code class="s2" translate="no">message</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">If an account exists, </code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">        </code><code class="s2" translate="no">"</code><code class="s2" translate="no">a password reset link will be sent to the provided email</code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_authentication_and_authorization_CO7-1" id="callout_authentication_and_authorization_CO7-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Crea un'istanza di <code translate="no">AuthService</code> e dichiara le<span class="keep-together">dipendenze</span> annotate riutilizzabili.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO7-2" id="callout_authentication_and_authorization_CO7-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Crea un router API separato per gli endpoint di autenticazione.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO7-3" id="callout_authentication_and_authorization_CO7-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Implementa gli endpoint per la registrazione degli utenti, il login degli utenti (emissione del token), il logout degli utenti (revoca del token) e la reimpostazione della password.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO7-5" id="callout_authentication_and_authorization_CO7-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Poiché la dipendenza di <code translate="no">LogoutUserDep</code> non restituirà nulla, iniettala nell'array delle dipendenze del router.</p></dd>
</dl></div>
<p>Una volta che hai un router di autenticazione dedicato, crea un router di risorse separato per raggruppare tutti i tuoi endpoint di risorse. Con entrambi i router, puoi ora aggiungerli alla tua applicazione FastAPI, come mostrato nell'<a data-type="xref" href="#routers">Esempio 8-12</a>, per completare il lavoro di autenticazione JWT.</p>
<div data-type="example" id="routers">
<h5><span class="label">Esempio 8-12. </span>Riformulare l'applicazione FastAPI per utilizzare i router</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># routes/resource.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">APIRouter</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">router</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">APIRouter</code><code class="p" translate="no">(</code><code class="n" translate="no">prefix</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/generate</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">tags</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Resource</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO8-1" id="co_authentication_and_authorization_CO8-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/generate/text</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">serve_language_model_controller</code><code class="p" translate="no">(</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/generate/audio</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">serve_text_to_audio_model_controller</code><code class="p" translate="no">(</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">
</code><code translate="no">
</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no"> </code><code class="c1" translate="no"># Add other controllers to the resource router here</code><code translate="no">
</code><code translate="no">
</code><code class="c1" translate="no"># main.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">typing</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code translate="no">
</code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="nn" translate="no">routes</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">entities</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">User</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">FastAPI</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">services</code><code class="nn" translate="no">.</code><code class="nn" translate="no">auth</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">AuthService</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">auth_service</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">AuthService</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="n" translate="no">AuthenticateUserDep</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="n" translate="no">User</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">auth_service</code><code class="o" translate="no">.</code><code class="n" translate="no">get_current_user</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code><code translate="no">
</code><code translate="no">
</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">app</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">FastAPI</code><code class="p" translate="no">(</code><code class="n" translate="no">lifespan</code><code class="o" translate="no">=</code><code class="n" translate="no">lifespan</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">app</code><code class="o" translate="no">.</code><code class="n" translate="no">include_router</code><code class="p" translate="no">(</code><code class="n" translate="no">routes</code><code class="o" translate="no">.</code><code class="n" translate="no">auth</code><code class="o" translate="no">.</code><code class="n" translate="no">router</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">prefix</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/auth</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">tags</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Auth</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO8-2" id="co_authentication_and_authorization_CO8-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code class="n" translate="no">app</code><code class="o" translate="no">.</code><code class="n" translate="no">include_router</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">routes</code><code class="o" translate="no">.</code><code class="n" translate="no">resource</code><code class="o" translate="no">.</code><code class="n" translate="no">router</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">dependencies</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="n" translate="no">AuthenticateUserDep</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">prefix</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/generate</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">tags</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Generate</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO8-3" id="co_authentication_and_authorization_CO8-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a><code translate="no">
</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">  </code><code class="c1" translate="no"># Add other routes to the app here</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_authentication_and_authorization_CO8-1" id="callout_authentication_and_authorization_CO8-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Riformulare gli endpoint esistenti per raggrupparli in un router API separato chiamato router delle risorse.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO8-2" id="callout_authentication_and_authorization_CO8-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Aggiungi i router auth e resource al router FastAPI <code translate="no">app</code>.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO8-3" id="callout_authentication_and_authorization_CO8-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Proteggi gli endpoint delle risorse iniettando la dipendenza da <code translate="no">AuthenticateUserDep</code> a livello di router. Le richieste devono ora includere un'intestazione <code translate="no">Authorization</code> con un token del portatore per essere autenticate con il router delle risorse.</p></dd>
</dl></div>
<p>Congratulazioni vivissime: ora hai un servizio GenAI perfettamente funzionante e protetto dall'autenticazione JWT, che può essere messo in produzione con un po' di lavoro in più.<a data-startref="ix_ch08-asciidoc11" data-type="indexterm" id="id983"/></p>
<p>Nella prossima sezione scoprirai alcune idee su ulteriori miglioramenti che puoi apportare al sistema per rafforzare la sicurezza del tuo sistema di autenticazione JWT.<a data-startref="ix_ch08-asciidoc10" data-type="indexterm" id="id984"/><a data-startref="ix_ch08-asciidoc9" data-type="indexterm" id="id985"/></p>
</div></section>
<section data-pdf-bookmark="Authentication flows" data-type="sect3"><div class="sect3" id="id119">
<h3>Flussi di autenticazione</h3>
<p><a data-primary="JSON Web Tokens (JWT) authentication" data-secondary="authentication flows" data-type="indexterm" id="ix_ch08-asciidoc12"/>Dovrai gestire diversi flussi di autenticazione per implementare completamente un sistema di autenticazione JWT utilizzabile.</p>
<p>I flussi di autenticazione <em>principali</em> sono i seguenti:</p>
<dl>
<dt>Registrazione utente</dt>
<dd>
<p>I nuovi utenti dovranno registrare un nuovo account fornendo la propria email e una password sicura. La tua logica di autenticazione può verificare la forza della password, l'assenza di utenti esistenti con la stessa email e che l'utente riconfermi la password e l'email. Dovresti anche evitare di memorizzare la password grezza dell'utente nel database.</p>
</dd>
<dt>Accesso utente</dt>
<dd>
<p>Ad ogni accesso dell'utente, il tuo sistema può generare, memorizzare e fornire un token di accesso temporaneo unico (cioè un JWT) se l'utente fornisce le sue credenziali corrette. I router del tuo server di risorse protette dovrebbero rifiutare qualsiasi richiesta in entrata che non contenga un JWT valido. I JWT validi possono essere verificati attraverso la loro firma e confrontati con i token validi specificati nel database.</p>
</dd>
<dt>Logout dell'utente</dt>
<dd>
<p>Quando l'utente si disconnette, il tuo sistema può revocare il token attualmente rilasciato e impedire futuri tentativi di accesso malevoli con il token attuale.</p>
</dd>
</dl>
<p class="less_space pagebreak-before">Oltre ai flussi principali, dovresti considerare anche i flussi <em>secondari</em> per implementare un sistema di autenticazione pronto per la produzione. Questi flussi possono essere utilizzati per:</p>
<dl>
<dt>Verifica dell'identità</dt>
<dd>
<p>Per evitare che gli spambot registrino account attivi nel tuo sistema e consumino le risorse del server, dovrai predisporre una qualche forma di meccanismo di verifica degli utenti. Ad esempio, puoi aggiungere la verifica via e-mail integrando un server di posta elettronica al tuo sistema di autenticazione.</p>
</dd>
<dt>Ripristino delle password</dt>
<dd>
<p>Gli utenti possono dimenticare la propria password in qualsiasi momento. Dovrai implementare un flusso che permetta agli utenti di reimpostare la propria password. Se un utente reimposta la propria password, tutti i token attivi nel database relativi al suo account utente devono essere revocati.</p>
</dd>
<dt>Forzare il logout</dt>
<dd>
<p>Revoca tutti i token di accesso generati in precedenza da un utente su tutti i client per evitare che i token rubati vengano utilizzati per accedere al sistema.</p>
</dd>
<dt>Disabilitare gli account utente</dt>
<dd>
<p>Gli amministratori o gli utenti potrebbero voler disabilitare i loro account per evitare futuri tentativi di accesso.</p>
</dd>
<dt>Eliminazione degli account utente</dt>
<dd>
<p>Questo è necessario se gli utenti desiderano rimuovere i loro account dai tuoi sistemi. A seconda delle tue esigenze di archiviazione dei dati, potresti voler eliminare le informazioni di identificazione personale mantenendo gli altri dati associati.</p>
</dd>
<dt>Blocco dei tentativi di accesso successivi</dt>
<dd>
<p>Disabilita temporaneamente un account che ha avuto più tentativi di accesso falliti in un breve lasso di tempo.</p>
</dd>
<dt>Fornire token di aggiornamento</dt>
<dd>
<p>Generare sia token <em>di accesso</em> di breve durata che token di <em>aggiornamento</em> di lunga durata. Poiché i token di accesso possono scadere frequentemente per ridurre la finestra di opportunità per gli aggressori di utilizzare un token rubato, i clienti possono riutilizzare il loro token di aggiornamento per richiedere nuovi token di accesso. In questo modo si elimina la necessità di effettuare login frequenti, mantenendo la sicurezza del sistema contro gli aggressori.</p>
</dd>
<dt>Autenticazione a due fattori (2FA) o autenticazione a più fattori (MFA)</dt>
<dd>
<p>Puoi proteggere il tuo sistema dagli account protetti da password esposte richiedendo 2FA o MFA come ulteriore livello di protezione. Esempi di 2FA/MFA sono la verifica via SMS/email, le password monouso (OTP) o le sequenze di numeri generati casualmente da un'app di autenticazione abbinata come secondo passaggio di login prima che possa essere generato un token di accesso.</p>
</dd>
</dl>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>L'elenco di cui sopra non è esaustivo. Puoi consultare la <a href="https://oreil.ly/xAGfn">"OWASP Top 10 Web Applications Security Risks"</a> e <a href="https://oreil.ly/oSyuz">"OWASP Authentication Cheat Sheet"</a> per un elenco completo di considerazioni da fare per implementare la tua autenticazione JWT da zero.</p>
<p>Oltre a seguire le linee guida della top 10 di OWASP, dovresti utilizzare meccanismi di sicurezza come la <em>limitazione del tasso</em>, il <em>tracciamento geo/IP</em> e il <em>blocco dell'account</em> per difenderti da vari attacchi.</p>
<p>Puoi anche prendere in considerazione l'utilizzo di fornitori di autenticazione di terze parti (come Okta/Auth0, Firebase Auth, KeyCloak, Amazon Cognito, ecc.) che includono queste funzioni di sicurezza nei loro servizi.</p>
</div>
<p>Sebbene l'autenticazione basata sulle credenziali che utilizza i JWT possa essere considerata un sistema di autenticazione pronto per la produzione e possa essere ulteriormente migliorata con i sistemi MFA in uso, il meccanismo ha i suoi limiti. Ad esempio, come già accennato in precedenza, richiedere le credenziali e memorizzare le password con hash in un database può comportare rischi per la sicurezza se gli aggressori sfruttano gli attacchi brute-force di password spraying o credential stuffing.</p>
<p>Inoltre, se hai bisogno di accedere a risorse utente esterne al tuo sistema, dovrai implementare meccanismi aggiuntivi per verificare l'identità della tua applicazione con fornitori di identità esterni.<a data-primary="OAuth2 standard" data-type="indexterm" id="id986"/>Poiché questa rimane un'esigenza comune a molte applicazioni e servizi, è stato sviluppato un protocollo chiamato OAuth per facilitare l'intero<span class="keep-together">processo.</span></p>
<p>Vediamo come utilizzare l'autenticazione OAuth per aggiungere altre opzioni di login per gli utenti e per accedere a risorse esterne. Questo può migliorare le prestazioni dei tuoi servizi GenAI e generare output di qualità superiore<a data-startref="ix_ch08-asciidoc12" data-type="indexterm" id="id987"/><a data-startref="ix_ch08-asciidoc4" data-type="indexterm" id="id988"/><a data-startref="ix_ch08-asciidoc3" data-type="indexterm" id="id989"/> .<a data-startref="ix_ch08-asciidoc0" data-type="indexterm" id="id990"/></p>
</div></section>
</div></section>
</div></section>
<section data-pdf-bookmark="Implementing OAuth Authentication" data-type="sect1"><div class="sect1" id="id120">
<h1>Implementare l'autenticazione OAuth</h1>
<p><a data-primary="authentication" data-secondary="methods" data-tertiary="OAuth authentication" data-type="indexterm" id="ix_ch08-asciidoc13"/><a data-primary="OAuth authentication" data-secondary="implementing" data-type="indexterm" id="ix_ch08-asciidoc14"/>In questo capitolo abbiamo accennato al concetto di autenticazione OAuth tramite identity provider.</p>
<p>OAuth è uno standard aperto per la delega degli accessi, spesso utilizzato per concedere a siti web o applicazioni un accesso limitato alle informazioni degli utenti senza esporre le password. Permette di autenticare gli utenti utilizzando identity provider come Google, Facebook, ecc. e concede alla tua applicazione l'accesso alle risorse dell'utente come calendari, file, social feed, ecc. su servizi esterni.</p>
<p>Utilizzando OAuth, puoi semplificare l'implementazione dell'autenticazione nella tua applicazione sfruttando i fornitori di identità esistenti invece di creare meccanismi di autenticazione propri come JWT.</p>
<p class="less_space pagebreak-before"><a data-primary="identity providers (IDPs)" data-type="indexterm" id="id991"/>Gli<em>Identity Provider</em> (IDP) sono piattaforme che consentono ad altre applicazioni, come il tuo servizio GenAI, di integrarsi con i loro sistemi di identità e autenticazione e di affidarsi ad essi per accedere alle risorse per conto degli utenti attraverso un processo standardizzato. L'IDP autentica gli utenti ed emette token di sicurezza che attestano l'identità dell'utente e altri attributi. GitHub, Google, Microsoft 365, Apple, Meta e LinkedIn sono solo alcune delle centinaia di identity provider.</p>
<p>Il protocollo che alimenta l'intero flusso è <em>OAuth 2.0</em>, un framework di autorizzazione che consente alle applicazioni di accedere in modo limitato a un altro servizio per conto di un utente.</p>
<p>Utilizzando questo approccio, la tua applicazione può reindirizzare gli utenti verso piattaforme di identity provider in modo che gli utenti possano concedere un accesso limitato nel tempo ai loro account su tali piattaforme. Dopo che l'utente ha dato il suo consenso, la tua applicazione può eseguire operazioni a suo nome sulle sue risorse, come i calendari, o leggere le informazioni del suo profilo, comprese le informazioni di identificazione personale come le e-mail o le immagini.</p>
<p>Di conseguenza, l'autenticazione OAuth viene spesso utilizzata per verificare l'identità degli utenti, in quanto ci si fida del processo di autenticazione della piattaforma esterna/del fornitore di identità. Pertanto, questo approccio riduce l'onere di memorizzare e proteggere le credenziali degli utenti nel tuo sistema, che può essere soggetto ad attacchi di forza bruta su password deboli o compromesse.</p>
<p>In questa sezione, implementerai una variante di OAuth basata sul <em>flusso di codice di autorizzazione</em> comunemente utilizzato nelle applicazioni moderne. Il processo passo dopo passo è il seguente:</p>
<ol>
<li>
<p>L'utente clicca sul pulsante di login della tua applicazione per avviare il flusso di autenticazione.</p>
</li>
<li>
<p>L'utente viene reindirizzato alla pagina di login del fornitore di identità e la tua applicazione fornisce un ID cliente e un segreto al fornitore di identità per identificarsi.</p>
</li>
<li>
<p>L'utente accede al proprio account e viene presentato con una schermata di consenso come quella mostrata nella <a data-type="xref" href="#oauth2_consent_screen">Figura 8-7</a> che presenta gli ambiti (cioè i permessi) che la tua applicazione sta richiedendo per suo conto.</p>
<figure><div class="figure" id="oauth2_consent_screen">
<img alt="bgai 0807" src="assets/bgai_0807.png" width="3467" height="2305"/>
<h6><span class="label">Figura 8-7. </span>Esempio di schermata di consenso</h6>
</div></figure>
</li>
<li>
<p>L'utente concede tutti, alcuni o nessuno degli ambiti richiesti.</p>
</li>
<li>
<p>Se il consenso non viene rifiutato dall'utente (cioè dal proprietario della risorsa), il server di autorizzazione dell'identity provider rilascia alla tua applicazione un <em>codice di concessione</em> verso un endpoint da te fornito, chiamato <em>URI di reindirizzamento</em>. Se l'URI di reindirizzamento non è stato precedentemente approvato dall'identity provider, quest'ultimo rifiuterà di rilasciare un codice di concessione.</p>
</li>
<li>
<p>Dopo aver ricevuto un codice di concessione associato alla sessione utente, agli ambiti consentiti e all'ID client dell'applicazione, l'applicazione può scambiare questo codice di concessione con il server di autorizzazione per un <em>token di accesso di breve durata</em> e un <em>token di aggiornamento di durata maggiore</em>. Puoi usare il token di aggiornamento per richiedere nuovi token di accesso senza dover riavviare l'intero processo di autenticazione.</p>
</li>
<li>
<p>La tua applicazione può ora utilizzare questo token di accesso per accedere al server di risorse del provider ed eseguire operazioni per conto dell'utente sulle sue risorse. Di conseguenza, puoi autenticare l'utente tramite l'identity provider alle risorse del tuo<span class="keep-together">sistema.</span></p>
</li>
</ol>
<div data-type="tip"><h6>Suggerimento</h6>
<p><a data-primary="CSRF (cross-site request forgery) token" data-type="indexterm" id="id992"/><a data-primary="state parameter" data-type="indexterm" id="id993"/>Attraverso il processo OAuth, il server di autorizzazione può anche rilasciare un parametro di <em>stato</em> o un <em>token CSRF</em>, che la tua applicazione deve fornire quando comunica con i server del fornitore di identità. Lo scopo del parametro di stato o del token CSRF è quello di proteggere dagli attacchi CSRF (cross-site request forgery).</p>
<p>Con il CSRF, gli aggressori possono rubare una sessione autenticata per falsificare le richieste autenticate ai server delle risorse all'insaputa dell'utente.</p>
</div>
<p><a data-type="xref" href="#oauth2">La Figura 8-8</a> mostra il flusso di autenticazione OAuth completo.</p>
<figure><div class="figure" id="oauth2">
<img alt="bgai 0808" src="assets/bgai_0808.png" width="1424" height="586"/>
<h6><span class="label">Figura 8-8. </span>Flusso di autenticazione OAuth</h6>
</div></figure>
<p>Ora che hai una panoramica di alto livello del flusso di autenticazione OAuth, implementiamolo all'interno di FastAPI con un provider di identità come GitHub per comprendere appieno i meccanismi sottostanti.</p>
<section data-pdf-bookmark="OAuth Authentication with GitHub" data-type="sect2"><div class="sect2" id="id121">
<h2>Autenticazione OAuth con GitHub</h2>
<p><a data-primary="OAuth authentication" data-secondary="GitHub and" data-type="indexterm" id="ix_ch08-asciidoc16"/>Il primo passo per impostare l'autenticazione OAuth è quello di creare un set di ID cliente e credenziali segrete all'interno di GitHub in modo che i loro sistemi possano identificare la tua applicazione.</p>
<p>Puoi generare un ID e un segreto del cliente da GitHub visitando le impostazioni dello sviluppatore sotto il tuo profilo GitHub e creando un'applicazione OAuth.<sup><a data-type="noteref" href="ch08.html#id994" id="id994-marker" translate="no">5</a></sup></p>
<p>Con il nuovo ID e segreto del client dell'applicazione, puoi ora reindirizzare gli utenti al server di autorizzazione di GitHub dalla tua applicazione seguendo l'<a data-type="xref" href="#oauth_redirect">Esempio 8-13</a>.</p>
<div data-type="example" id="oauth_redirect">
<h5><span class="label">Esempio 8-13. </span>Reindirizzare gli utenti al server di autorizzazione di GitHub per avviare il processo OAuth</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># routes/auth.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="nn" translate="no">secrets</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">APIRouter</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Request</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">status</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code class="nn" translate="no">.</code><code class="nn" translate="no">responses</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">RedirectResponse</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">client_id</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">your_client_id</code><code class="s2" translate="no">"</code><code translate="no">
</code><code class="n" translate="no">client_secret</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">your_client_secret</code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">router</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">APIRouter</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/oauth/github/login</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="n" translate="no">status</code><code class="o" translate="no">.</code><code class="n" translate="no">HTTP_301_REDIRECT</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">oauth_github_login_controller</code><code class="p" translate="no">(</code><code class="n" translate="no">request</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Request</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">RedirectResponse</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">state</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">secrets</code><code class="o" translate="no">.</code><code class="n" translate="no">token_urlsafe</code><code class="p" translate="no">(</code><code class="mi" translate="no">16</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">redirect_uri</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">request</code><code class="o" translate="no">.</code><code class="n" translate="no">url_for</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">oauth_github_callback_controller</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">response</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">RedirectResponse</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">url</code><code class="o" translate="no">=</code><code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">https://github.com/login/oauth/authorize</code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">        </code><code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">?client_id=</code><code class="si" translate="no">{</code><code class="n" translate="no">client_id</code><code class="si" translate="no">}</code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">        </code><code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">&amp;scope=user</code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">        </code><code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">&amp;state=</code><code class="si" translate="no">{</code><code class="n" translate="no">state</code><code class="si" translate="no">}</code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">        </code><code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">&amp;redirect_uri=</code><code class="si" translate="no">{</code><code class="n" translate="no">redirect_uri</code><code class="si" translate="no">}</code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO9-1" id="co_authentication_and_authorization_CO9-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">csrf_token</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">secrets</code><code class="o" translate="no">.</code><code class="n" translate="no">token_urlsafe</code><code class="p" translate="no">(</code><code class="mi" translate="no">16</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">request</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">x-csrf-state-token</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">csrf_token</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">response</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_authentication_and_authorization_CO9-1" id="callout_authentication_and_authorization_CO9-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Reindirizza l'utente al server di autorizzazione di GitHub per accedere al suo account fornendo le credenziali dell'applicazione, un ambito richiesto e un valore di stato CSRF per prevenire gli attacchi CSRF.</p></dd>
</dl></div>
<p>Come puoi vedere nell'<a data-type="xref" href="#oauth_redirect">Esempio 8-13</a>, l'ambito della richiesta è l'utente, il che significa che una volta che l'utente accede al suo account GitHub, gli verrà presentata una schermata di consenso per l'accesso della tua applicazione al suo profilo utente.</p>
<p>Ora che hai un endpoint di backend che reindirizza le richieste al server di autorizzazione di GitHub, puoi inserire un pulsante nella tua applicazione lato client per colpire questo endpoint e avviare il processo di OAuth con GitHub (vedi <a data-type="xref" href="#oauth_client">Esempio 8-14</a>).</p>
<div data-type="example" id="oauth_client">
<h5><span class="label">Esempio 8-14. </span>Aggiunta di un pulsante di accesso a GitHub all'applicazione Streamlit lato client</h5>
<pre data-type="programlisting" translate="no"># client.py

import requests
import streamlit as st

if st.button("Login with GitHub"):
    response = requests.get("http://localhost:8000/auth/oauth/github/login")
    if not response.ok:
        st.error("Failed to login with GitHub. Please try again later")
        response.raise_for_status()</pre></div>
<p>Ora hai implementato il flusso di reindirizzamento che avvia il processo di autenticazione OAuth con GitHub come fornitore di identità.</p>
<p>Quando gli utenti accedono al loro account GitHub, GitHub mostrerà loro una schermata di consenso simile a quella della <a data-type="xref" href="#oauth2_consent_screen">Figura 8-7</a>.</p>
<p>Se l'utente accetta il consenso, GitHub lo reindirizzerà alla tua applicazione con un codice di concessione e uno stato. Dovresti controllare se lo stato corrisponde a quello generato in precedenza.</p>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>Se gli stati non corrispondono, significa che la richiesta è stata fatta da una terza persona e devi interrompere il processo.</p>
</div>
<p>Una volta ottenuto il codice di sovvenzione, puoi inviarlo all'autorizzazione di GitHub per scambiarlo con un token di accesso, come mostrato nell'<a data-type="xref" href="#oauth_exchange">Esempio 8-15</a>.</p>
<div data-type="example" id="oauth_exchange">
<h5><span class="label">Esempio 8-15. </span>Scambio del codice di concessione con un token di accesso e protezione dagli attacchi CSRF</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># dependencies/auth.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">typing</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Annotated</code>
<code class="kn" translate="no">import</code> <code class="nn" translate="no">aiohttp</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">fastapi</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Depends</code><code class="p" translate="no">,</code> <code class="n" translate="no">HTTPException</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">loguru</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">logger</code>

<code class="n" translate="no">client_id</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"your_client_id"</code>
<code class="n" translate="no">client_secret</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"your_client_secret"</code>

<code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">exchange_grant_with_access_token</code><code class="p" translate="no">(</code><code class="n" translate="no">code</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code><code class="p" translate="no">)</code> <code class="o" translate="no">-&gt;</code> <code class="nb" translate="no">str</code><code class="p" translate="no">:</code>
    <code class="k" translate="no">try</code><code class="p" translate="no">:</code>
        <code class="n" translate="no">body</code> <code class="o" translate="no">=</code> <code class="p" translate="no">{</code>
            <code class="s2" translate="no">"client_id"</code><code class="p" translate="no">:</code> <code class="n" translate="no">client_id</code><code class="p" translate="no">,</code>
            <code class="s2" translate="no">"client_secret"</code><code class="p" translate="no">:</code> <code class="n" translate="no">client_secret</code><code class="p" translate="no">,</code>
            <code class="s2" translate="no">"code"</code><code class="p" translate="no">:</code> <code class="n" translate="no">code</code><code class="p" translate="no">,</code>
        <code class="p" translate="no">}</code>
        <code class="n" translate="no">headers</code> <code class="o" translate="no">=</code> <code class="p" translate="no">{</code>
            <code class="s2" translate="no">"Accept"</code><code class="p" translate="no">:</code> <code class="s2" translate="no">"application/json"</code><code class="p" translate="no">,</code>
            <code class="s2" translate="no">"Content-Type"</code><code class="p" translate="no">:</code> <code class="s2" translate="no">"application/json"</code><code class="p" translate="no">,</code>
        <code class="p" translate="no">}</code>
        <code class="k" translate="no">async</code> <code class="k" translate="no">with</code> <code class="n" translate="no">aiohttp</code><code class="o" translate="no">.</code><code class="n" translate="no">ClientSession</code><code class="p" translate="no">()</code> <code class="k" translate="no">as</code> <code class="n" translate="no">session</code><code class="p" translate="no">:</code>
            <code class="k" translate="no">async</code> <code class="k" translate="no">with</code> <code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code>
                <code class="s2" translate="no">"https://github.com/login/oauth/access_token"</code><code class="p" translate="no">,</code>
                <code class="n" translate="no">json</code><code class="o" translate="no">=</code><code class="n" translate="no">body</code><code class="p" translate="no">,</code>
                <code class="n" translate="no">headers</code><code class="o" translate="no">=</code><code class="n" translate="no">headers</code><code class="p" translate="no">,</code>
            <code class="p" translate="no">)</code> <code class="k" translate="no">as</code> <code class="n" translate="no">resp</code><code class="p" translate="no">:</code>
                <code class="n" translate="no">access_token_data</code> <code class="o" translate="no">=</code> <code class="k" translate="no">await</code> <code class="n" translate="no">resp</code><code class="o" translate="no">.</code><code class="n" translate="no">json</code><code class="p" translate="no">()</code>
    <code class="k" translate="no">except</code> <code class="ne" translate="no">Exception</code> <code class="k" translate="no">as</code> <code class="n" translate="no">e</code><code class="p" translate="no">:</code>
        <code class="n" translate="no">logger</code><code class="o" translate="no">.</code><code class="n" translate="no">warning</code><code class="p" translate="no">(</code><code class="sa" translate="no">f</code><code class="s2" translate="no">"Failed to fetch the access token. Error: </code><code class="si" translate="no">{</code><code class="n" translate="no">e</code><code class="si" translate="no">}</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code>
        <code class="k" translate="no">raise</code> <code class="n" translate="no">HTTPException</code><code class="p" translate="no">(</code>
            <code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="mi" translate="no">503</code><code class="p" translate="no">,</code> <code class="n" translate="no">detail</code><code class="o" translate="no">=</code><code class="s2" translate="no">"Failed to fetch access token"</code>
        <code class="p" translate="no">)</code>

    <code class="k" translate="no">if</code> <code class="ow" translate="no">not</code> <code class="n" translate="no">access_token_data</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">raise</code> <code class="n" translate="no">HTTPException</code><code class="p" translate="no">(</code>
            <code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="mi" translate="no">503</code><code class="p" translate="no">,</code> <code class="n" translate="no">detail</code><code class="o" translate="no">=</code><code class="s2" translate="no">"Failed to obtain access token"</code>
        <code class="p" translate="no">)</code>

    <code class="k" translate="no">return</code> <code class="n" translate="no">access_token_data</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"access_token"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">""</code><code class="p" translate="no">)</code>

<code class="n" translate="no">ExchangeCodeTokenDep</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code> <code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">exchange_grant_with_access_token</code><code class="p" translate="no">)]</code></pre></div>
<p>Ora puoi aggiungere un nuovo endpoint che accetta le richieste dal server di autorizzazione di GitHub. Questo endpoint di callback deve avere una protezione CSRF per evitare che terze parti impersonino il server di autorizzazione. Se la richiesta da GitHub è contraffatta, il parametro di stato fornito e quello memorizzato nella sessione della richiesta non corrisponderanno.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id995">
<h1>Cross-Site Request Forgery</h1>
<p><a data-primary="cross-site request forgery (CSRF)" data-type="indexterm" id="ix_ch08-asciidoc17"/><a data-primary="OAuth authentication" data-secondary="CSRF and" data-type="indexterm" id="ix_ch08-asciidoc18"/>Il CSRF è un tipo di vulnerabilità di sicurezza che permette a un aggressore di ingannare un utente per fargli eseguire delle azioni su un'applicazione web in cui è autenticato. Questo può portare all'esecuzione di azioni non autorizzate senza il consenso dell'utente.</p>
<p>Nel CSRF, l'aggressore crea una richiesta dannosa che sfrutta la sessione autenticata dell'utente con un sito web di destinazione. Questi attacchi possono portare a transazioni non autorizzate, al furto di dati o alla modifica delle impostazioni dell'utente senza il suo consenso e la sua conoscenza.</p>
<p>Nel contesto di OAuth2, un aggressore può sfruttare vulnerabilità come l'<em>open redirect</em> per intercettare le richieste di autorizzazione iniziali e modificarle per reindirizzare al proprio sito dannoso dopo l'autenticazione.</p>
<p>Gli aggressori possono anche creare una replica del frontend della tua applicazione e indurre gli utenti ad accedere ai loro account. Se l'utente accede al suo account GitHub tramite il sito di phishing, l'aggressore può fornire un URL di reindirizzamento che punta ai suoi server per ottenere un codice di autorizzazione. Può quindi scambiare il codice di autorizzazione con un token di accesso.</p>
<p><a data-type="xref" href="#oauth2_csrf_attack">La Figura 8-9</a> mostra un esempio di attacco CSRF OAuth2 che utilizza una<span class="keep-together">vulnerabilità di</span> reindirizzamento aperto<span class="keep-together">.</span></p>
<figure><div class="figure" id="oauth2_csrf_attack">
<img alt="bgai 0809" src="assets/bgai_0809.png" width="1154" height="818"/>
<h6><span class="label">Figura 8-9. </span>Attacco CSRF OAuth2 con una vulnerabilità di reindirizzamento aperto</h6>
</div></figure>
<p>Un parametro <code translate="no">state</code> o <code translate="no">csrf_token</code> scambiato durante le richieste tra il client e i server di autorizzazione può prevenire gli attacchi CSRF mantenendo lo stato della sessione tra le richieste, le risposte e i reindirizzamenti.</p>
<p>Inoltre, per proteggerti dalle vulnerabilità dei reindirizzamenti aperti, dovresti anche pre-registrare e convalidare rigorosamente gli URL di reindirizzamento con l'identity provider, educare i tuoi utenti sui tentativi di phishing e implementare meccanismi di registrazione e monitoraggio per rilevare le richieste sospette.<a data-startref="ix_ch08-asciidoc18" data-type="indexterm" id="id996"/><a data-startref="ix_ch08-asciidoc17" data-type="indexterm" id="id997"/></p>
</div></aside>
<p>L<a data-type="xref" href="#oauth_callback">'esempio 8-16</a> mostra l'implementazione dell'endpoint di callback.</p>
<div data-type="example" id="oauth_callback">
<h5><span class="label">Esempio 8-16. </span>Implementare un endpoint di callback per ottenere il token di accesso proteggendosi dagli attacchi CSRF</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># routes/auth.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">dependencies.auth</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">ExchangeCodeTokenDep</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">fastapi</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Depends</code><code class="p" translate="no">,</code> <code class="n" translate="no">HTTPException</code><code class="p" translate="no">,</code> <code class="n" translate="no">Request</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">fastapi.responses</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">RedirectResponse</code>

<code class="o" translate="no">...</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">check_csrf_state</code><code class="p" translate="no">(</code><code class="n" translate="no">request</code><code class="p" translate="no">:</code> <code class="n" translate="no">Request</code><code class="p" translate="no">,</code> <code class="n" translate="no">state</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code><code class="p" translate="no">)</code> <code class="o" translate="no">-&gt;</code> <code class="kc" translate="no">None</code><code class="p" translate="no">:</code>
    <code class="k" translate="no">if</code> <code class="n" translate="no">state</code> <code class="o" translate="no">!=</code> <code class="n" translate="no">request</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"x-csrf-token"</code><code class="p" translate="no">):</code>
        <code class="k" translate="no">raise</code> <code class="n" translate="no">HTTPException</code><code class="p" translate="no">(</code><code class="n" translate="no">detail</code><code class="o" translate="no">=</code><code class="s2" translate="no">"Bad request"</code><code class="p" translate="no">,</code> <code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="mi" translate="no">401</code><code class="p" translate="no">)</code>

<code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"/oauth/github/callback"</code><code class="p" translate="no">,</code> <code class="n" translate="no">dependencies</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">check_csrf_state</code><code class="p" translate="no">)])</code>
<code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">oauth_github_callback_controller</code><code class="p" translate="no">(</code>
    <code class="n" translate="no">access_token</code><code class="p" translate="no">:</code> <code class="n" translate="no">ExchangeCodeTokenDep</code><code class="p" translate="no">,</code>
<code class="p" translate="no">)</code> <code class="o" translate="no">-&gt;</code> <code class="n" translate="no">RedirectResponse</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">response</code> <code class="o" translate="no">=</code> <code class="n" translate="no">RedirectResponse</code><code class="p" translate="no">(</code><code class="n" translate="no">url</code><code class="o" translate="no">=</code><code class="sa" translate="no">f</code><code class="s2" translate="no">"http://localhost:8501"</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">response</code><code class="o" translate="no">.</code><code class="n" translate="no">set_cookie</code><code class="p" translate="no">(</code><code class="n" translate="no">key</code><code class="o" translate="no">=</code><code class="s2" translate="no">"access_token"</code><code class="p" translate="no">,</code> <code class="n" translate="no">value</code><code class="o" translate="no">=</code><code class="n" translate="no">access_token</code><code class="p" translate="no">,</code> <code class="n" translate="no">httponly</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">return</code> <code class="n" translate="no">response</code></pre></div>
<p>Nell'<a data-type="xref" href="#oauth_callback">esempio 8-16</a>, si utilizza la sessione di richiesta per la protezione CSRF, ma questo non funzionerà se non si aggiunge prima il sito <code translate="no">SessionMiddlware</code> di Starlette per mantenere una sessione utente sicura e mutabile solo sul lato server, come mostrato nell'<a data-type="xref" href="#oauth_session">esempio 8-17</a>.</p>
<div data-type="example" id="oauth_session">
<h5><span class="label">Esempio 8-17. </span>Aggiungere un middleware di sessione per gestire lo stato della sessione per proteggere dagli attacchi CSRF</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># main.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">fastapi</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">FastAPI</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">starlette.middleware.sessions</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">SessionMiddleware</code>

<code class="o" translate="no">...</code>

<code class="n" translate="no">app</code> <code class="o" translate="no">=</code> <code class="n" translate="no">FastAPI</code><code class="p" translate="no">(</code><code class="n" translate="no">lifespan</code><code class="o" translate="no">=</code><code class="n" translate="no">lifespan</code><code class="p" translate="no">)</code>
<code class="n" translate="no">app</code><code class="o" translate="no">.</code><code class="n" translate="no">add_middleware</code><code class="p" translate="no">(</code><code class="n" translate="no">SessionMiddleware</code><code class="p" translate="no">,</code> <code class="n" translate="no">secret_key</code><code class="o" translate="no">=</code><code class="s2" translate="no">"your_secret_key"</code><code class="p" translate="no">)</code></pre></div>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>Evita di affidarti ai <em>cookie</em> HTTP per memorizzare e leggere il sito <code translate="no">state</code> tra le sessioni di richiesta, poiché i cookie possono essere letti e manipolati da terzi. Non fidarti mai dei dati provenienti dal client.</p>
</div>
<p>Scrivendo il codice univoco <code translate="no">state</code> nella sessione nell'<a data-type="xref" href="#oauth_redirect">Esempio 8-13</a> e confrontandolo con il valore <code translate="no">state</code> nei parametri della query della richiesta in arrivo, puoi confermare l'identità della richiesta.</p>
<p>In questo caso, il richiedente è il server di autorizzazione di GitHub che ti invia un grant <code translate="no">code</code>. Una volta ricevuta la concessione <code translate="no">code</code>, la scambi con il server di autorizzazione di GitHub per un token di accesso.</p>
<div data-type="tip"><h6>Suggerimento</h6>
<p>Il processo mostrato negli esempi di codice relativi a OAuth può essere implementato anche con il pacchetto open source <code translate="no">authlib</code> per un'implementazione più semplice, in quanto il pacchetto gestisce la maggior parte del lavoro per te.</p>
</div>
<p>Infine, puoi utilizzare il token di accesso ricevuto dal server di autorizzazione per recuperare le informazioni dell'utente, come il nome, l'email e l'immagine del profilo, per registrare la sua identità nella tua applicazione.</p>
<p>L<a data-type="xref" href="#oauth_user_info">'esempio 8-18</a> mostra come implementare un endpoint che restituisce le informazioni sull'utente da GitHub se la richiesta fornisce un token di accesso come parte dell'intestazione di autorizzazione della richiesta.</p>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>Idealmente, dovresti evitare di condividere il token di accesso a GitHub con il browser dell'utente: se il token viene rubato, la tua applicazione è responsabile della compromissione dell'account GitHub dell'utente.</p>
<p>Invece, crea e condividi un tuo token di accesso di breve durata legato al token di accesso di GitHub per autenticare l'utente con la tua applicazione. Se il token dell'applicazione viene rubato, eviti di compromettere gli account utente al di fuori dell'ambito della tua applicazione.</p>
</div>
<div data-type="example" id="oauth_user_info">
<h5><span class="label">Esempio 8-18. </span>Utilizzare il token di accesso per ottenere le informazioni sull'utente dai server delle risorse di GitHub</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># routes/auth.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">typing</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Annotated</code>
<code class="kn" translate="no">import</code> <code class="nn" translate="no">aiohttp</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">fastapi</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Depends</code><code class="p" translate="no">,</code> <code class="n" translate="no">HTTPException</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">fastapi.security</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">HTTPAuthorizationCredentials</code><code class="p" translate="no">,</code> <code class="n" translate="no">HTTPBearer</code>

<code class="n" translate="no">security</code> <code class="o" translate="no">=</code> <code class="n" translate="no">HTTPBearer</code><code class="p" translate="no">()</code>
<code class="n" translate="no">HTTPBearerDep</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="n" translate="no">HTTPAuthorizationCredentials</code><code class="p" translate="no">,</code> <code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">security</code><code class="p" translate="no">)]</code>

<code class="o" translate="no">...</code>

<code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">get_user_info</code><code class="p" translate="no">(</code><code class="n" translate="no">credentials</code><code class="p" translate="no">:</code> <code class="n" translate="no">HTTPBearerDep</code><code class="p" translate="no">)</code> <code class="o" translate="no">-&gt;</code> <code class="nb" translate="no">dict</code><code class="p" translate="no">:</code>
    <code class="k" translate="no">try</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">async</code> <code class="k" translate="no">with</code> <code class="n" translate="no">aiohttp</code><code class="o" translate="no">.</code><code class="n" translate="no">ClientSession</code><code class="p" translate="no">()</code> <code class="k" translate="no">as</code> <code class="n" translate="no">session</code><code class="p" translate="no">:</code>
            <code class="n" translate="no">headers</code> <code class="o" translate="no">=</code> <code class="p" translate="no">{</code><code class="s2" translate="no">"Authorization"</code><code class="p" translate="no">:</code> <code class="sa" translate="no">f</code><code class="s2" translate="no">"Bearer </code><code class="si" translate="no">{</code><code class="n" translate="no">credentials</code><code class="o" translate="no">.</code><code class="n" translate="no">credentials</code><code class="si" translate="no">}</code><code class="s2" translate="no">"</code><code class="p" translate="no">}</code>
            <code class="k" translate="no">async</code> <code class="k" translate="no">with</code> <code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code>
                <code class="s2" translate="no">"https://api.github.com/user"</code><code class="p" translate="no">,</code> <code class="n" translate="no">headers</code><code class="o" translate="no">=</code><code class="n" translate="no">headers</code>
            <code class="p" translate="no">)</code> <code class="k" translate="no">as</code> <code class="n" translate="no">resp</code><code class="p" translate="no">:</code>
                <code class="k" translate="no">return</code> <code class="k" translate="no">await</code> <code class="n" translate="no">resp</code><code class="o" translate="no">.</code><code class="n" translate="no">json</code><code class="p" translate="no">()</code>
    <code class="k" translate="no">except</code> <code class="ne" translate="no">Exception</code> <code class="k" translate="no">as</code> <code class="n" translate="no">e</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">raise</code> <code class="n" translate="no">HTTPException</code><code class="p" translate="no">(</code>
            <code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="mi" translate="no">503</code><code class="p" translate="no">,</code> <code class="n" translate="no">detail</code><code class="o" translate="no">=</code><code class="sa" translate="no">f</code><code class="s2" translate="no">"Failed to obtain user info - Error: </code><code class="si" translate="no">{</code><code class="n" translate="no">e</code><code class="si" translate="no">}</code><code class="s2" translate="no">"</code>
        <code class="p" translate="no">)</code>

<code class="n" translate="no">GetUserInfoDep</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="nb" translate="no">dict</code><code class="p" translate="no">,</code> <code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">get_user_info</code><code class="p" translate="no">)]</code>

<code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"/oauth/github/callback"</code><code class="p" translate="no">)</code>
<code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">get_current_user_controller</code><code class="p" translate="no">(</code><code class="n" translate="no">user_info</code><code class="p" translate="no">:</code> <code class="n" translate="no">GetUserInfoDep</code><code class="p" translate="no">)</code> <code class="o" translate="no">-&gt;</code> <code class="nb" translate="no">dict</code><code class="p" translate="no">:</code>
    <code class="k" translate="no">return</code> <code class="n" translate="no">user_info</code></pre></div>
<p>Congratulazioni! Ora dovresti avere un sistema di autenticazione funzionante che sfrutta OAuth2 per autenticare gli utenti.<a data-startref="ix_ch08-asciidoc16" data-type="indexterm" id="id998"/></p>
</div></section>
<section data-pdf-bookmark="OAuth2 Flow Types" data-type="sect2"><div class="sect2" id="id122">
<h2>Tipi di flusso OAuth2</h2>
<p><a data-primary="OAuth2 standard" data-type="indexterm" id="ix_ch08-asciidoc19a"/><a data-primary="OAuth authentication" data-secondary="authorization flows" data-type="indexterm" id="ix_ch08-asciidoc19"/>Il flusso OAuth2 che hai appena implementato è il <em>flusso del codice di autorizzazione</em> (ACF). Tuttavia, ci sono altri flussi che puoi scegliere a seconda del caso d'uso. La documentazione del fornitore di identità può presentarti soluzioni per vari flussi, che possono sembrare schiaccianti se non sei a conoscenza di questi casi d'uso.</p>
<section data-pdf-bookmark="Authorization code flow" data-type="sect3"><div class="sect3" id="id123">
<h3>Flusso del codice di autorizzazione</h3>
<p><a data-primary="OAuth authentication" data-secondary="authorization flows" data-tertiary="authorization code flow" data-type="indexterm" id="id999"/>Il flusso di codice di autorizzazione è l'approccio comune per le applicazioni che sfruttano i server e le API di backend come FastAPI, utilizzando le concessioni di codice per emettere i token di accesso.</p>
<p><a data-primary="proof key for exchange (PKCE)" data-type="indexterm" id="id1000"/><a data-primary="PKCE (proof key for exchange)" data-type="indexterm" id="id1001"/>Una variante più sicura di ACF sfrutta la <em>chiave di prova per lo scambio</em> (PKCE, pronunciato "pixie"). Puoi usare il flusso ACF-PKCE quando non puoi proteggere il codice di autorizzazione dal furto, ad esempio sui dispositivi mobili.</p>
<p class="fix_tracking">Durante il flusso ACF-PKCE, quando invii la richiesta iniziale al fornitore di identità, aggiungi un segreto con hashhed chiamato <code translate="no">code_challenge</code>. Poi ripresenterai il segreto non hashhed <code translate="no">code_verifier</code> per scambiare il codice di autorizzazione con un token di accesso.</p>
<p>In sostanza, il PKCE protegge dagli attacchi di <em>intercettazione del codice di autorizzazione</em>, come mostrato nella <a data-type="xref" href="#oauth_interception_attack">Figura 8-10,</a>aggiungendo un livello di verifica durante il processo di scambio dei token.</p>
<figure><div class="figure" id="oauth_interception_attack">
<img alt="bgai 0810" src="assets/bgai_0810.png" width="1429" height="599"/>
<h6><span class="label">Figura 8-10. </span>Attacco di intercettazione del codice di autorizzazione OAuth2 su un dispositivo mobile</h6>
</div></figure>
</div></section>
<section data-pdf-bookmark="Implicit flow" data-type="sect3"><div class="sect3" id="id124">
<h3>Flusso implicito</h3>
<p>Per le applicazioni a pagina singola (SPA) di<a data-primary="implicit flow" data-type="indexterm" id="id1002"/><a data-primary="OAuth authentication" data-secondary="authorization flows" data-tertiary="implicit flow" data-type="indexterm" id="id1003"/> in cui non c'è un backend separato, puoi<span class="keep-together">anche usare</span> il <em>flusso implicito</em>, che salta il codice di autorizzazione per ottenere direttamente un token di accesso. Il flusso implicito è meno sicuro del flusso precedente ma migliora l'<span class="keep-together">esperienza</span> dell'utente.</p>
</div></section>
<section data-pdf-bookmark="Client credentials flow" data-type="sect3"><div class="sect3" id="id125">
<h3>Flusso di credenziali del cliente</h3>
<p><a data-primary="client credentials flow" data-type="indexterm" id="id1004"/><a data-primary="OAuth authentication" data-secondary="authorization flows" data-tertiary="client credentials flow" data-type="indexterm" id="id1005"/>Se stai costruendo un servizio backend per la comunicazione machine-to-machine e non è previsto il coinvolgimento di alcun browser, allora puoi utilizzare il <em>flusso delle credenziali del cliente</em>. Qui puoi scambiare l'ID e il segreto del tuo cliente con un token di accesso per accedere alle tue risorse sui server dell'identity provider (cioè non avrai accesso per conto di altri utenti).</p>
</div></section>
<section data-pdf-bookmark="Resource owner password credentials flow" data-type="sect3"><div class="sect3" id="id126">
<h3>Flusso di credenziali del proprietario della risorsa</h3>
<p><a data-primary="OAuth authentication" data-secondary="authorization flows" data-tertiary="resource owner password credentials flow" data-type="indexterm" id="id1006"/><a data-primary="resource owner password credentials flow" data-type="indexterm" id="id1007"/>Il<em>flusso di credenziali con password del proprietario della risorsa</em> è simile al flusso di credenziali del cliente, ma utilizza un nome utente e una password dell'utente per ottenere un token di accesso. Poiché le credenziali vengono scambiate direttamente con il server di autorizzazione, dovresti evitare il più possibile di utilizzare questo flusso.</p>
</div></section>
<section data-pdf-bookmark="Device authorization flow" data-type="sect3"><div class="sect3" id="id127">
<h3>Flusso di autorizzazione del dispositivo</h3>
<p><a data-primary="device authorization flow" data-type="indexterm" id="id1008"/><a data-primary="OAuth authentication" data-secondary="authorization flows" data-tertiary="device authorization flow" data-type="indexterm" id="id1009"/>Infine, c'è il <em>flusso di autorizzazione del dispositivo</em> che viene utilizzato soprattutto per i dispositivi con capacità di input limitate, come quando accedi al tuo account Apple TV sulla tua smart TV scansionando un codice QR e utilizzando un browser web dal tuo telefono.</p>
<p>La<a data-type="xref" href="#oauth_flows_comparison">Tabella 8-2</a> mette a confronto i vari flussi per aiutarti a selezionare l'opzione giusta per il tuo caso d'uso, in base ai tuoi requisiti e vincoli specifici.</p>
<table class="striped" id="oauth_flows_comparison">
<caption><span class="label">Tabella 8-2. </span>Confronto tra i flussi di autorizzazione di OAuth2</caption>
<thead>
<tr>
<th>Flusso</th>
<th>Descrizione</th>
<th>Considerazioni</th>
<th>Casi d'uso</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>Flusso del codice di autorizzazione (incluso PKCE)</p></td>
<td><p>Ottieni il codice di autorizzazione tramite un login utente e scambialo con un token di accesso.</p></td>
<td>
<ul><li><p>Il token di accesso del fornitore deve essere memorizzato in modo sicuro e non deve mai essere esposto al browser.</p></li>
<li><p>Usa il flusso ACF-PKCE se possibile per una maggiore sicurezza.</p></li></ul></td>
<td><ul><li><p>Applicazioni lato server e applicazioni web con un server backend in grado di gestire in modo sicuro il segreto del cliente e i token di accesso.</p></li>
<li><p>Se le applicazioni mobili utilizzano un token PKCE, le credenziali del cliente non possono essere archiviate in modo sicuro.</p></li></ul></td>
</tr>
<tr>
<td><p>Flusso implicito</p></td>
<td><p>Ottieni un token di accesso senza codice di autorizzazione.</p></td>
<td><ul><li><p>Meno sicuro perché il token di accesso è esposto al browser.</p></li>
<li><p>Da utilizzare quando non è possibile utilizzare il flusso del codice di autorizzazione.</p></li></ul></td>
<td><p>Applicazioni a pagina singola (SPA) in cui l'esperienza dell'utente è prioritaria rispetto alla sicurezza, durante la prototipazione o quando il flusso di codice di autorizzazione non è possibile.</p></td>
</tr>
<tr>
<td><p>Flusso di credenziali del cliente</p></td>
<td><p>Il cliente scambia direttamente le sue credenziali (ID e segreto del cliente) con un token di accesso.</p></td>
<td><p>Non prevede l'interazione con l'utente, è pensato per scenari in cui il cliente agisce per conto proprio. Garantisce l'archiviazione sicura delle credenziali del cliente.</p></td>
<td><p>Applicazioni da server a server.</p></td>
</tr>
<tr>
<td><p>Flusso di credenziali del proprietario della risorsa</p></td>
<td><p>Scambia il nome utente e la password dell'utente direttamente con un token di accesso.</p></td>
<td><ul>
<li><p>Alto rischio di sicurezza perché le credenziali dell'utente vengono gestite direttamente.</p></li>
<li><p>Da utilizzare solo nei sistemi legacy dove gli altri flussi non sono supportati.</p></li></ul></td>
<td><p>Applicazioni legacy o ambienti altamente affidabili.</p></td>
</tr>
<tr>
<td><p>Flusso di autorizzazione del dispositivo</p></td>
<td><p>Visita un URL su un altro dispositivo per inserire un codice per un token di accesso.</p></td>
<td><p>Richiede un secondo dispositivo con un browser web per l'autenticazione dell'utente.</p></td>
<td><p>Dispositivi con capacità di input limitate, come smart TV, console di gioco o dispositivi IoT.</p></td>
</tr>
</tbody>
</table>
<p>Ora dovresti sentirti più sicuro nel proteggere la tua applicazione con una serie di meccanismi commerciali di verifica dell'identità, compresi i vari flussi OAuth2 che sfruttano IDP esterni.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1010">
<h1>Risoluzione dei problemi di implementazione di OAuth</h1>
<p><a data-primary="OAuth authentication" data-secondary="troubleshooting OAuth implementation issues" data-type="indexterm" id="id1011"/>Ci sono spesso diversi problemi comuni che puoi incontrare quando implementi l'autenticazione OAuth nei tuoi servizi. <a data-type="xref" href="#oauth_troubleshooting">La Tabella 8-3</a> elenca questi problemi con le relative soluzioni che puoi usare come riferimento.</p>
<table class="striped" id="oauth_troubleshooting">
<caption><span class="label">Tabella 8-3. </span>Problemi di OAuth e soluzioni</caption>
<thead>
<tr>
<th>Problema</th>
<th>Soluzione</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>URI di reindirizzamento non valido</p></td>
<td><p>Registra (cioè autorizza) l'URI di reindirizzamento con il fornitore di identità.</p></td>
</tr>
<tr>
<td><p>ID o segreto del cliente non valido</p></td>
<td><p>Genera e copia l'ID cliente e il segreto corretti dal fornitore di identità quando registri la tua applicazione presso di loro.</p></td>
</tr>
<tr>
<td><p>Gettone scaduto</p></td>
<td><p>Il fornitore di identità può rilasciare dei token di aggiornamento che puoi utilizzare per ottenere nuovi token di accesso senza ripetere l'intero flusso di autorizzazione OAuth.</p></td>
</tr>
<tr>
<td><p>Scopi mancanti</p></td>
<td><p>Aggiungi degli ambiti validi nella richiesta di autorizzazione al provider. Anche l'utente dei tuoi servizi deve acconsentire a questi ambiti.</p></td>
</tr>
<tr>
<td><p>Endpoint del token non corretto</p></td>
<td><p>Invia una richiesta all'URL dell'endpoint del token giusto fornito dal fornitore di identità per ottenere un token di accesso.</p></td>
</tr>
<tr>
<td><p>Errori CORS</p></td>
<td><p>Configura le impostazioni del provider di identità per consentire CORS per il tuo dominio o utilizza un proxy lato server per gestire le richieste OAuth.</p></td>
</tr>
<tr>
<td><p>Tipo di sovvenzione non valido</p></td>
<td><p>Fornisci il tipo di sovvenzione corretto nella richiesta al fornitore di identità.</p></td>
</tr>
</tbody>
</table>
<p>Come puoi vedere, la maggior parte dei problemi elencati riguarda l'implementazione o la configurazione non corretta dei flussi OAuth con il provider di identità OAuth. Per evitare alcuni di questi problemi, puoi prendere in considerazione l'utilizzo di librerie OAuth come <code translate="no">authlib</code> che gestiscono gran parte della complessità per te, a patto che tu utilizzi i segreti del provider corretto.</p>
</div></aside>
<p>L'autenticazione è il primo passo per rendere sicuri i tuoi servizi, identificando chi sono gli utenti del tuo sistema.</p>
<p>Rimane una domanda: cosa dovrebbe accadere quando un utente accede ai tuoi servizi? Può recuperare dati, interagire con i modelli e mutare le risorse a suo piacimento o preferisci controllare le sue interazioni nei tuoi servizi?<a data-startref="ix_ch08-asciidoc19" data-type="indexterm" id="id1012"/><a data-startref="ix_ch08-asciidoc19a" data-type="indexterm" id="id1013"/></p>
<p>Si tratta di problemi che verranno affrontati da un sistema di autorizzazione, di cui parleremo in seguito.<a data-startref="ix_ch08-asciidoc14" data-type="indexterm" id="id1014"/><a data-startref="ix_ch08-asciidoc13" data-type="indexterm" id="id1015"/></p>
</div></section>
</div></section>
</div></section>
<section data-pdf-bookmark="Authorization" data-type="sect1"><div class="sect1" id="id128">
<h1>Autorizzazione</h1>
<p><a data-primary="authorization" data-type="indexterm" id="ix_ch08-asciidoc20"/>Finora abbiamo trattato diversi meccanismi di autenticazione, tra cui quelli di base, quelli basati su token (JWT) e OAuth2, per proteggere le tue applicazioni.</p>
<p><a data-primary="permissions, authorization and" data-type="indexterm" id="id1016"/>Come già accennato, i sistemi di autenticazione identificano e verificano gli attori, mentre i sistemi di autorizzazione impongono i <em>permessi</em> in un'applicazione (cioè chi può fare cosa su quale risorsa).</p>
<p><a data-primary="authorization model (actor, action, resource)" data-type="indexterm" id="id1017"/>In questa sezione imparerai a conoscere il sistema di autorizzazione che tiene conto di quanto segue:</p>
<ul>
<li>
<p>L'<em>attore</em> (cioè l'utente o un servizio di terze parti che agisce per conto dell'utente)</p>
</li>
<li>
<p>L'<em>azione</em> intrapresa</p>
</li>
<li>
<p>L'impatto dell'azione sulle <em>risorse</em></p>
</li>
</ul>
<p>In sostanza, un sistema di autorizzazione può essere paragonato a una funzione che accetta tre input (<em>attore</em>, <em>azione</em>, <em>risorsa) e</em>restituisce una <em>decisione booleana</em> per <em>consentire</em> o <em>negare</em> una richiesta. Per implementare la funzione di autorizzazione, avrai bisogno di <em>dati di autorizzazione</em> come gli attributi dell'utente, le relazioni (come l'appartenenza a team/gruppi/org), la proprietà delle risorse, i ruoli e i permessi passati attraverso un insieme di <em>regole astratte</em> per determinare le decisioni booleane di autorizzazione/negazione.</p>
<p>Una volta presa la decisione, puoi <em>far rispettare</em> l'autorizzazione consentendo le azioni (come recuperare o modificare le risorse) o negando le richieste (come inviare risposte 403 Forbidden, reindirizzare gli utenti, nascondere le risorse, bloccare gli account e così via).</p>
<p>A livello superficiale, l'implementazione dell'autorizzazione può essere semplice. Utilizzando alcune dichiarazioni condizionali, puoi verificare se un utente ha i permessi per eseguire un'azione. Tuttavia, questo approccio ingenuo può diventare complesso da gestire man mano che aumenta il numero di punti in cui devi implementare i passaggi di autorizzazione. Questo problema si aggrava man mano che apporti modifiche alla logica dell'applicazione, rendendo il sistema complesso e aggiungendo controlli più fini. Potresti finire per duplicare la logica o rendere più difficili le modifiche future; inoltre, le regole di autorizzazione potrebbero essere profondamente intrecciate alla logica dell'applicazione, rendendo più difficile la separazione dal resto dell'applicazione.</p>
<p>In questi casi, i modelli di autorizzazione possono essere utili per aiutarti a gestire la complessità delle decisioni e dell'applicazione delle autorizzazioni nelle tue applicazioni.</p>
<section data-pdf-bookmark="Authorization Models" data-type="sect2"><div class="sect2" id="id129">
<h2>Modelli di autorizzazione</h2>
<p><a data-primary="authorization" data-secondary="authorization models" data-type="indexterm" id="ix_ch08-asciidoc21"/>Ci sono alcuni <em>modelli di autorizzazione</em> comuni che puoi imparare per rendere più semplice la strutturazione e l'implementazione di un sistema di autorizzazione:</p>
<dl>
<dt>Controllo dell'accesso basato sui ruoli (RBAC)</dt>
<dd>
<p>L'autorizzazione si basa sui ruoli assegnati agli utenti, dove ogni ruolo ha permessi specifici. Ad esempio, gli amministratori possono accedere a tutti i modelli GenAI disponibili, aggirando le regole di autorizzazione applicate agli utenti.</p>
</dd>
<dt>Controllo dell'accesso basato sulle relazioni (ReBAC)</dt>
<dd>
<p>L'autorizzazione è determinata dalle relazioni tra le entità, come le relazioni tra utenti (ad esempio, follower, amici, connessioni) o tra utenti e risorse (ad esempio, gruppi, team, organizzazioni). Ad esempio, questo potrebbe autorizzare un utente che è membro di un team ad accedere ai modelli premium acquistati da quel team.</p>
</dd>
<dt>Controllo dell'accesso basato sugli attributi (ABAC)</dt>
<dd>
<p>Le decisioni di autorizzazione vengono prese in base agli attributi degli utenti, delle risorse e dell'ambiente, consentendo un controllo degli accessi a grana fine. Ad esempio, una conversazione con un attributo <em>pubblico</em> è visibile a tutti, mentre un utente con un attributo <em>a pagamento</em> può accedere ai modelli GenAI premium.</p>
</dd>
</dl>
<p>RBAC è il modello di autorizzazione più semplice, ma non offre i controlli granulari e la flessibilità di altri modelli di autorizzazione. I controlli ABAC forniscono un controllo degli accessi più fine e possono sovrascrivere le regole di ReBAC e RBAC. Inoltre, ReBAC può anche sovrascrivere o estendere i controlli RBAC.</p>
<p>La<a data-type="xref" href="#authorization_methods_comparison">Tabella 8-4</a> mette a confronto i tre modelli di autorizzazione.</p>
<table class="striped" id="authorization_methods_comparison">
<caption><span class="label">Tabella 8-4. </span>Confronto tra i metodi di autorizzazione</caption>
<thead>
<tr>
<th>Tipo</th>
<th>Vantaggi</th>
<th>Limitazioni</th>
<th>Casi d'uso</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>Basato sui ruoli (RBAC)</p></td>
<td><p>Semplifica la gestione</p></td>
<td><p>Flessibilità limitata</p></td>
<td><p>Ambienti aziendali, controllo degli accessi, sistemi finanziari, sistemi sanitari</p></td>
</tr>
<tr>
<td><p>Basato sulla relazione (ReBAC)</p></td>
<td><p>Controllo a grana fine</p></td>
<td><p>Necessita di dati relazionali provenienti da varie fonti con valutazioni complesse dei permessi.</p></td>
<td><p>Social network, piattaforme collaborative, applicazioni di condivisione dei contenuti, strumenti di gestione dei progetti</p></td>
</tr>
<tr>
<td><p>Basato sugli attributi (ABAC)</p></td>
<td><p>Altamente flessibile</p></td>
<td><p>Ha bisogno di dati sugli attributi provenienti da varie fonti con complesse valutazioni dei permessi.</p></td>
<td><p>Ambienti dinamici, servizi Cloud, sistemi IoT, conformità normativa, esperienze utente personalizzate</p></td>
</tr>
</tbody>
</table>
<p>Questi tre modelli di autorizzazione hanno anche una relazione gerarchica, come dimostra la <a data-type="xref" href="#authorization_models">Figura 8-11</a>.</p>
<figure><div class="figure" id="authorization_models">
<img alt="bgai 0811" src="assets/bgai_0811.png" width="1392" height="660"/>
<h6><span class="label">Figura 8-11. </span>Modelli di autorizzazione</h6>
</div></figure>
<p>Vediamo ora nel dettaglio ogni modello di autorizzazione, iniziando dal modello RBAC.<a data-startref="ix_ch08-asciidoc21" data-type="indexterm" id="id1018"/></p>
</div></section>
<section data-pdf-bookmark="Role-Based Access Control" data-type="sect2"><div class="sect2" id="id130">
<h2>Controllo degli accessi basato sui ruoli</h2>
<p><a data-primary="authorization" data-secondary="authorization models" data-tertiary="role-based access control (RBAC)" data-type="indexterm" id="ix_ch08-asciidoc22"/><a data-primary="role-based access control (RBAC)" data-type="indexterm" id="ix_ch08-asciidoc23"/><a data-primary="RBAC (role-based access control)" data-type="indexterm" id="ix_ch08-asciidoc23a"/>L'uso dei <em>ruoli</em> è un modello ampiamente adottato per implementare l'autorizzazione nelle applicazioni grazie alla loro semplicità.</p>
<p>I ruoli sono semplici da capire: di solito corrispondono a chi è l'utente e a cosa vuole fare nell'applicazione. A volte i ruoli di autorizzazione possono corrispondere direttamente ai ruoli nella gerarchia della tua organizzazione.</p>
<p>Puoi raggruppare le autorizzazioni sotto un ruolo che può essere <em>assegnato</em> agli utenti per concedere loro tali autorizzazioni. Un'<em>autorizzazione</em> specifica l'azione che un utente può compiere sulle risorse, ad esempio se l'utente può interagire con il modello LLM a pagamento fornito dal tuo servizio.</p>
<p>Per migliorare l'esperienza amministrativa e degli utenti, puoi creare ruoli multipli con permessi preimpostati per ridurre la fatica di decidere quando si impostano i permessi degli utenti. Invece di dover impostare un gran numero di permessi, puoi assegnare alcuni ruoli predefiniti.</p>
<p>Un punto di partenza comune a molti servizi commerciali è rappresentato dai ruoli di utente e di amministratore. Sebbene un utente possa accedere alle funzionalità principali dell'applicazione, come interagire con i modelli GenAI e leggere e scrivere le risorse, non potrà visualizzare i dati di altri utenti o gestire i ruoli. D'altro canto, gli amministratori possono assegnare e rimuovere i ruoli, visualizzare e modificare ogni risorsa o disabilitare e abilitare gli account. Gli amministratori possono anche avere accesso alle prime funzionalità, come i modelli GenAI, a cui gli utenti normali non possono ancora accedere, come mostrato nella <a data-type="xref" href="#rbac_example">Figura 8-12</a>.</p>
<figure><div class="figure" id="rbac_example">
<img alt="bgai 0812" src="assets/bgai_0812.png" width="502" height="299"/>
<h6><span class="label">Figura 8-12. </span>Esempio di RBAC in cui solo gli amministratori hanno accesso ai modelli GenAI basati sulle immagini</h6>
</div></figure>
<p>Puoi implementare un semplice modello di autorizzazione RBAC per controllare i servizi GenAI a cui gli utenti possono accedere, come mostrato nell'<a data-type="xref" href="#rbac">Esempio 8-19</a>.</p>
<div data-type="example" id="rbac">
<h5><span class="label">Esempio 8-19. </span>Implementazione di RBAC utilizzando le dipendenze di FastAPI</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># dependencies/auth.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">entities</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">User</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">HTTPException</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">status</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">services</code><code class="nn" translate="no">.</code><code class="nn" translate="no">auth</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">AuthService</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">is_admin</code><code class="p" translate="no">(</code><code class="n" translate="no">user</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">User</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">AuthService</code><code class="o" translate="no">.</code><code class="n" translate="no">get_current_user</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">User</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO10-1" id="co_authentication_and_authorization_CO10-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="n" translate="no">user</code><code class="o" translate="no">.</code><code class="n" translate="no">role</code><code translate="no"> </code><code class="o" translate="no">!=</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">ADMIN</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">raise</code><code translate="no"> </code><code class="n" translate="no">HTTPException</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="n" translate="no">status</code><code class="o" translate="no">.</code><code class="n" translate="no">HTTP_403_FORBIDDEN</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">detail</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Not allowed to perform this action</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">user</code><code translate="no">
</code><code translate="no">
</code><code class="c1" translate="no"># routers/resource.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">dependencies</code><code class="nn" translate="no">.</code><code class="nn" translate="no">auth</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">is_admin</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">APIRouter</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">services</code><code class="nn" translate="no">.</code><code class="nn" translate="no">auth</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">AuthService</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">router</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">APIRouter</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">dependencies</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">AuthService</code><code class="o" translate="no">.</code><code class="n" translate="no">get_current_user</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO10-3" id="co_authentication_and_authorization_CO10-2"><img alt="3" src="assets/3.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">prefix</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/generate</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">tags</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Resource</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/image</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">dependencies</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">is_admin</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">generate_image_controller</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO10-2" id="co_authentication_and_authorization_CO10-3"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/text</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_authentication_and_authorization_CO10-3" id="co_authentication_and_authorization_CO10-4"><img alt="3" src="assets/3.png" width="12" height="12"/></a><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">generate_text_controller</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_authentication_and_authorization_CO10-1" id="callout_authentication_and_authorization_CO10-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Implementa la protezione della dipendenza di autorizzazione <code translate="no">is_admin</code> sopra la dipendenza <code translate="no">Auth​Ser⁠vice.get_current_user</code>. Contrassegna la funzione come <code translate="no">async</code> poiché la dipendenza figlia esegue un'operazione asincrona contro il database.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO10-3" id="callout_authentication_and_authorization_CO10-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Utilizza la dipendenza authorization guard per negare l'accesso al servizio di generazione delle immagini agli utenti non autenticati dall'amministratore.</p></dd>
<dt><a class="co" href="#co_authentication_and_authorization_CO10-2" id="callout_authentication_and_authorization_CO10-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Gli utenti non autenticati possono comunque accedere ad altri controllori di risorse poiché il router è protetto da una dipendenza di autenticazione.</p></dd>
</dl></div>
<p>Utilizzando la stessa logica mostrata nell'<a data-type="xref" href="#rbac">Esempio 8-19</a>, puoi costruire diversi modelli di prompt di sistema o utilizzare diverse varianti di modello adattate a ciascun ruolo.</p>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>Tieni presente che implementare l'autorizzazione a livello applicativo è più sicuro che delegarla al modello GenAI. Gli LLMs e altri modelli GenAI possono essere vulnerabili agli attacchi <em>prompt injection</em>, in cui un attaccante manipola l'input del modello per aggirare le istruzioni del sistema e produrre output non autorizzati e dannosi.</p>
<p>Le versioni future di LLMs e di altri modelli GenAI potrebbero mitigare i rischi di prompt injection applicando regole di autorizzazione personalizzate internamente, utilizzando estensioni come la <em>rete neurale di controllo (ControlNet)</em> nei modelli Stable Diffusion.</p>
</div>
<p>Per creare una logica di autorizzazione RBAC più complessa di quella mostrata nell'<a data-type="xref" href="#rbac">Esempio 8-19</a>, puoi implementare delle <em>sottodipendenze</em> o una <em>dipendenza astratta</em>. Entrambi gli approcci sfrutteranno i potenti <em>grafi di dipendenza gerarchici</em> di FastAPI come guardie di autorizzazione per far rispettare i permessi nel tuo servizio GenAI.</p>
<p>Ad esempio, se in futuro aggiungerai nuovi ruoli che erediteranno un sottoinsieme di permessi di un altro ruolo (ad esempio, moderatori e amministratori), potrai seguire uno dei due approcci mostrati nella <a data-type="xref" href="#complex_rbac_approaches">Figura 8-13</a>.</p>
<figure><div class="figure" id="complex_rbac_approaches">
<img alt="bgai 0813" src="assets/bgai_0813.png" width="1315" height="1134"/>
<h6><span class="label">Figura 8-13. </span>Approcci per l'implementazione di modelli RBAC complessi</h6>
</div></figure>
<p><a data-primary="abstract dependencies" data-type="indexterm" id="id1019"/>Puoi implementare una logica di autorizzazione RBAC complessa utilizzando delle dipendenze astratte, come mostrato nell'<a data-type="xref" href="#complex_rbac_abstract">Esempio 8-20</a>.</p>
<div data-type="example" id="complex_rbac_abstract">
<h5><span class="label">Esempio 8-20. </span>Implementare un'autorizzazione RBAC complessa utilizzando le dipendenze astratte</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># dependencies/auth.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">typing</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Annotated</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">entities</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">User</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">fastapi</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">APIRouter</code><code class="p" translate="no">,</code> <code class="n" translate="no">Depends</code><code class="p" translate="no">,</code> <code class="n" translate="no">HTTPException</code><code class="p" translate="no">,</code> <code class="n" translate="no">status</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">services.auth</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">AuthService</code>

<code class="n" translate="no">CurrentUserDep</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="n" translate="no">User</code><code class="p" translate="no">,</code> <code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">AuthService</code><code class="o" translate="no">.</code><code class="n" translate="no">get_current_user</code><code class="p" translate="no">)]</code>

<code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">has_role</code><code class="p" translate="no">(</code><code class="n" translate="no">user</code><code class="p" translate="no">:</code> <code class="n" translate="no">CurrentUserDep</code><code class="p" translate="no">,</code> <code class="n" translate="no">roles</code><code class="p" translate="no">:</code> <code class="nb" translate="no">list</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code><code class="p" translate="no">])</code> <code class="o" translate="no">-&gt;</code> <code class="n" translate="no">User</code><code class="p" translate="no">:</code>
    <code class="k" translate="no">if</code> <code class="n" translate="no">user</code><code class="o" translate="no">.</code><code class="n" translate="no">role</code> <code class="ow" translate="no">not</code> <code class="ow" translate="no">in</code> <code class="n" translate="no">roles</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">raise</code> <code class="n" translate="no">HTTPException</code><code class="p" translate="no">(</code>
            <code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="n" translate="no">status</code><code class="o" translate="no">.</code><code class="n" translate="no">HTTP_403_FORBIDDEN</code><code class="p" translate="no">,</code>
            <code class="n" translate="no">detail</code><code class="o" translate="no">=</code><code class="s2" translate="no">"Not allowed to perform this action"</code><code class="p" translate="no">,</code>
        <code class="p" translate="no">)</code>
    <code class="k" translate="no">return</code> <code class="n" translate="no">user</code>


<code class="c1" translate="no"># routes/resource.py</code>

<code class="o" translate="no">...</code>

<code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code>
    <code class="s2" translate="no">"/image"</code><code class="p" translate="no">,</code>
    <code class="n" translate="no">dependencies</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="k" translate="no">lambda</code> <code class="n" translate="no">user</code><code class="p" translate="no">:</code> <code class="n" translate="no">has_role</code><code class="p" translate="no">(</code><code class="n" translate="no">user</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="s2" translate="no">"ADMIN"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"MODERATOR"</code><code class="p" translate="no">]))],</code>
<code class="p" translate="no">)</code>
<code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">generate_image_controller</code><code class="p" translate="no">():</code>
    <code class="o" translate="no">...</code>

<code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code>
    <code class="s2" translate="no">"/text"</code><code class="p" translate="no">,</code> <code class="n" translate="no">dependencies</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="k" translate="no">lambda</code> <code class="n" translate="no">user</code><code class="p" translate="no">:</code> <code class="n" translate="no">has_role</code><code class="p" translate="no">(</code><code class="n" translate="no">user</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="s2" translate="no">"EDITOR"</code><code class="p" translate="no">]))]</code>
<code class="p" translate="no">)</code>
<code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">generate_text_controller</code><code class="p" translate="no">():</code>
    <code class="o" translate="no">...</code></pre></div>
<p>In sintesi, il RBAC semplifica la gestione dei permessi assegnando le autorizzazioni ai ruoli piuttosto che agli individui, rendendo più facile la gestione e la verifica. È scalabile ed efficiente per le organizzazioni con ruoli e responsabilità ben definiti.</p>
<p>Tuttavia, RBAC può portare all'esplosione dei ruoli quando sono necessari molti ruoli granulari, rendendone difficile la gestione. Inoltre, non ha la flessibilità necessaria per gestire relazioni gerarchiche complesse come team e gruppi e per impostare permessi dinamici basati su attributi come le preferenze dell'utente, il tempo e le impostazioni di privacy, il che limita la sua granularità rispetto a ReBAC o ABAC.<a data-startref="ix_ch08-asciidoc23" data-type="indexterm" id="id1020"/><a data-startref="ix_ch08-asciidoc23a" data-type="indexterm" id="id1021"/><a data-startref="ix_ch08-asciidoc22" data-type="indexterm" id="id1022"/></p>
</div></section>
<section data-pdf-bookmark="Relationship-Based Access Control" data-type="sect2"><div class="sect2" id="id131">
<h2>Controllo degli accessi basato sulle relazioni</h2>
<p><a data-primary="authorization" data-secondary="authorization models" data-tertiary="relationship-based access control" data-type="indexterm" id="ix_ch08-asciidoc24"/><a data-primary="relationship-based access control (ReBAC)" data-type="indexterm" id="ix_ch08-asciidoc25"/>Il<em>controllo degli accessi basato sulle relazioni</em> è un'estensione del RBAC che si concentra sulle relazioni tra risorse e utenti.</p>
<p>Con questa modalità, invece di impostare i ruoli a livello di utente per l'intera applicazione, dovrai impostare i ruoli e i permessi a livello di risorsa. Ciò significa che dovrai confermare le azioni che ogni ruolo può compiere su ogni tipo di risorsa. Ad esempio, invece di assegnare un ruolo "moderatore" a un utente che garantisce l'accesso a tutte le risorse (conversazioni, team, utenti, ecc.), dovrai assegnare permessi specifici al ruolo di moderatore per ogni risorsa. Un moderatore potrebbe avere i permessi di lettura e di cancellazione sulla risorsa conversazione ma solo di lettura sulla risorsa team.</p>
<p>Questo modello ti permette di creare politiche di autorizzazione basate su strutture gerarchiche e annidate all'interno dei tuoi dati e di visualizzarle come grafici in cui i nodi possono essere rappresentati come risorse/identità e i bordi come relazioni.</p>
<p>Dato che puoi creare regole di autorizzazione basate sulle relazioni, puoi risparmiare molto tempo nell'impostazione delle autorizzazioni a livello di istanza. Ad esempio, invece di condividere una per una tutte le conversazioni private di LLM nella tua applicazione, puoi raggrupparle in un team o in una cartella e condividere la cartella o aggiungere membri al team. In ReBAC, le istanze figlio possono ereditare le autorizzazioni del genitore, come mostrato nella <a data-type="xref" href="#rebac_example">Figura 8-14</a>. Lo stesso vale per le istanze correlate, se necessario.</p>
<figure><div class="figure" id="rebac_example">
<img alt="bgai 0814" src="assets/bgai_0814.png" width="1111" height="392"/>
<h6><span class="label">Figura 8-14. </span>Esempio di ReBAC in cui un utente può vedere le conversazioni e le discussioni private del team</h6>
</div></figure>
<p>L'esempio mostrato nella <a data-type="xref" href="#rebac_example">Figura 8-14</a> mostra sia l'organizzazione che le relazioni gerarchiche tra gli utenti (cioè i team e i membri) e le risorse (conversazioni e discussioni).</p>
<div data-type="tip"><h6>Suggerimento</h6>
<p>Se decidi di adottare il modello ReBAC, ti consiglio di tracciare visivamente le relazioni tra risorse e identità nella tua applicazione.</p>
<p>Questo lavoro comprende la mappatura delle <em>politiche</em> (cioè delle regole), delle <em>risorse</em> e delle <em>azioni</em> disponibili su di esse, dei <em>ruoli a livello di risorse</em> e delle <em>relazioni</em> tra le entità.</p>
</div>
<p>Un grosso problema che ReBAC risolve estendendo RBAC è l'esplosione dei ruoli all'interno del modello RBAC, combinando le relazioni con i ruoli. È ideale per gestire i permessi in strutture gerarchiche complesse e permette di effettuare query inverse, consentendo di definire in modo efficiente i permessi utilizzando team e gruppi. Tuttavia, ReBAC può essere complesso da implementare e mantenere, richiede molte risorse, è difficile da verificare e non ha la stessa precisione di ABAC per i permessi dinamici basati su attributi come l'orario o la<span class="keep-together">posizione</span> di<a data-startref="ix_ch08-asciidoc25" data-type="indexterm" id="id1023"/><a data-startref="ix_ch08-asciidoc24" data-type="indexterm" id="id1024"/>.</p>
</div></section>
<section data-pdf-bookmark="Attribute-Based Access Control" data-type="sect2"><div class="sect2" id="id132">
<h2>Controllo dell'accesso basato sugli attributi</h2>
<p><a data-primary="attribute-based access control (ABAC)" data-type="indexterm" id="id1025"/><a data-primary="ABAC (attribute-based access control)" data-type="indexterm" id="id1026"/><a data-primary="authorization" data-secondary="authorization models" data-tertiary="attribute-based access control" data-type="indexterm" id="id1027"/>Il modello di autorizzazione<em>del controllo degli accessi basato sugli attributi</em> espande i ruoli RBAC di base impostando regole di controllo degli accessi basate su <em>condizioni applicate agli attributi</em> per implementare politiche più granulari. Ad esempio, ABAC può impedire agli utenti di caricare documenti sensibili nei tuoi servizi abilitati al RAG se il documento contiene <em>informazioni di identificazione personale (PII)</em> (ad esempio, <code translate="no">upload.has_pii=true</code>).</p>
<p>Un altro esempio di ABAC può essere visto nelle applicazioni SaaS come ChatGPT, dove solo gli utenti a pagamento hanno accesso ai modelli GenAI premium del servizio (vedi <a data-type="xref" href="#abac_example">Figura 8-15</a>).</p>
<figure><div class="figure" id="abac_example">
<img alt="bgai 0815" src="assets/bgai_0815.png" width="547" height="323"/>
<h6><span class="label">Figura 8-15. </span>Esempio di ABAC in cui solo gli utenti a pagamento hanno accesso ai<span class="keep-together">modelli</span> GenAI premium</h6>
</div></figure>
<p>Poiché la libertà di definire criteri basati sugli attributi è infinita, il modello ABAC permette di definire politiche di autorizzazione molto precise. Tuttavia, ABAC può essere complicato per la gestione di strutture gerarchiche, rendendo difficile determinare quali utenti hanno accesso a una risorsa specifica. Ad esempio, se hai un criterio che concede l'accesso in base ad attributi come il ruolo dell'utente, il livello di sensibilità dei dati e l'appartenenza a un progetto, determinare tutti gli utenti che possono accedere a un set di dati specifico richiede la valutazione di questi attributi per ogni utente.</p>
<p>Sebbene sia meno complicato di ReBAC, ABAC può essere comunque impegnativo da implementare, in particolare in applicazioni grandi e complesse che supportano un gran numero di ruoli, utenti e attributi.</p>
</div></section>
<section data-pdf-bookmark="Hybrid Authorization Models" data-type="sect2"><div class="sect2" id="id133">
<h2>Modelli di autorizzazione ibridi</h2>
<p><a data-primary="authorization" data-secondary="authorization models" data-tertiary="hybrid models" data-type="indexterm" id="ix_ch08-asciidoc26"/>Se in passato hai lavorato con applicazioni di grandi dimensioni, noterai che esse combinano le caratteristiche dei modelli di autorizzazione RBAC, ReBAC e ABAC. Ad esempio, gli amministratori possono avere accesso a qualsiasi risorsa e alle funzioni di gestione/autenticazione degli utenti (RBAC), mentre gli utenti possono condividere le loro risorse private impostando l'attributo di visibilità su <code translate="no">public</code> (ABAC) e possono aggiungere membri al loro team per collaborare alle risorse private.</p>
<p>Un approccio ibrido che combina i modelli RBAC, ReBAC e ABAC può offrire i punti di forza di tutti i modelli di autorizzazione:</p>
<ul>
<li>
<p>RBAC semplifica la gestione dei permessi assegnando ruoli agli utenti, rendendoli più facili da gestire e verificare.</p>
</li>
<li>
<p>ReBAC è perfetto per gestire le relazioni gerarchiche e le query inverse, rendendolo adatto a strutture gerarchiche complesse.</p>
</li>
<li>
<p>ABAC fornisce un controllo a grana fine basato sugli attributi dell'utente e della risorsa, consentendo di ottenere permessi dinamici e consapevoli del contesto.</p>
</li>
</ul>
<p><a data-type="xref" href="#authorization_hybrid">La Figura 8-16</a> mostra il modello di autorizzazione ibrido.</p>
<figure><div class="figure" id="authorization_hybrid">
<img alt="bgai 0816" src="assets/bgai_0816.png" width="1439" height="837"/>
<h6><span class="label">Figura 8-16. </span>Modello di autorizzazione ibrido basato su ruoli, relazioni e attributi</h6>
</div></figure>
<p>Per implementare l'autorizzazione ibrida che combina i modelli RBAC, ReBAC e ABAC, puoi seguire l'<a data-type="xref" href="#rbac_rebac_abac">Esempio 8-21</a>.</p>
<div data-type="example" id="rbac_rebac_abac">
<h5><span class="label">Esempio 8-21. </span>Implementazione del modello di autorizzazione ibrido che combina RBAC, ReBAC e ABAC</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># dependencies/auth.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">typing</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Annotated</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">fastapi</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Depends</code><code class="p" translate="no">,</code> <code class="n" translate="no">HTTPException</code><code class="p" translate="no">,</code> <code class="n" translate="no">status</code>
<code class="o" translate="no">...</code>  <code class="c1" translate="no"># import services and entities here</code>

<code class="n" translate="no">CurrentUserDep</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="n" translate="no">User</code><code class="p" translate="no">,</code> <code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">AuthService</code><code class="o" translate="no">.</code><code class="n" translate="no">get_current_user</code><code class="p" translate="no">)]</code>
<code class="n" translate="no">TeamMembershipRep</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="n" translate="no">Team</code><code class="p" translate="no">,</code> <code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">TeamService</code><code class="o" translate="no">.</code><code class="n" translate="no">get_current_team</code><code class="p" translate="no">)]</code>
<code class="n" translate="no">ResourceDep</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="n" translate="no">Resource</code><code class="p" translate="no">,</code> <code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">ResourceService</code><code class="o" translate="no">.</code><code class="n" translate="no">get_resource</code><code class="p" translate="no">)]</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">authorize</code><code class="p" translate="no">(</code>
    <code class="n" translate="no">user</code><code class="p" translate="no">:</code> <code class="n" translate="no">CurrentUserDep</code><code class="p" translate="no">,</code> <code class="n" translate="no">resource</code><code class="p" translate="no">:</code> <code class="n" translate="no">ResourceDep</code><code class="p" translate="no">,</code> <code class="n" translate="no">team</code><code class="p" translate="no">:</code> <code class="n" translate="no">TeamMembershipRep</code>
<code class="p" translate="no">)</code> <code class="o" translate="no">-&gt;</code> <code class="nb" translate="no">bool</code><code class="p" translate="no">:</code>
    <code class="k" translate="no">if</code> <code class="n" translate="no">user</code><code class="o" translate="no">.</code><code class="n" translate="no">role</code> <code class="o" translate="no">==</code> <code class="s2" translate="no">"ADMIN"</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">return</code> <code class="kc" translate="no">True</code>
    <code class="k" translate="no">if</code> <code class="n" translate="no">user</code><code class="o" translate="no">.</code><code class="n" translate="no">id</code> <code class="ow" translate="no">in</code> <code class="n" translate="no">team</code><code class="o" translate="no">.</code><code class="n" translate="no">members</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">return</code> <code class="kc" translate="no">True</code>
    <code class="k" translate="no">if</code> <code class="n" translate="no">resource</code><code class="o" translate="no">.</code><code class="n" translate="no">is_public</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">return</code> <code class="kc" translate="no">True</code>
    <code class="k" translate="no">raise</code> <code class="n" translate="no">HTTPException</code><code class="p" translate="no">(</code>
        <code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="n" translate="no">status</code><code class="o" translate="no">.</code><code class="n" translate="no">HTTP_403_FORBIDDEN</code><code class="p" translate="no">,</code> <code class="n" translate="no">detail</code><code class="o" translate="no">=</code><code class="s2" translate="no">"Access Denied"</code>
    <code class="p" translate="no">)</code>

<code class="c1" translate="no"># routes/resource.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">dependencies.auth</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">authorize</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">fastapi</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">APIRouter</code><code class="p" translate="no">,</code> <code class="n" translate="no">Depends</code>

<code class="n" translate="no">router</code> <code class="o" translate="no">=</code> <code class="n" translate="no">APIRouter</code><code class="p" translate="no">(</code>
    <code class="n" translate="no">dependencies</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">authorize</code><code class="p" translate="no">)],</code> <code class="n" translate="no">prefix</code><code class="o" translate="no">=</code><code class="s2" translate="no">"/generate"</code><code class="p" translate="no">,</code> <code class="n" translate="no">tags</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="s2" translate="no">"Resource"</code><code class="p" translate="no">]</code>
<code class="p" translate="no">)</code>

<code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code><code class="s2" translate="no">"/image"</code><code class="p" translate="no">)</code>
<code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">generate_image_controller</code><code class="p" translate="no">():</code> <code class="o" translate="no">...</code>

<code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code><code class="s2" translate="no">"/text"</code><code class="p" translate="no">)</code>
<code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">generate_text_controller</code><code class="p" translate="no">():</code> <code class="o" translate="no">...</code></pre></div>
<p>Quando definisci le regole e i permessi in base a ciascun modello di autorizzazione, puoi anche decidere di bypassare le regole se si verificano determinate condizioni, il che può portare a una logica complessa e creare un onere di manutenzione per il codice dell'applicazione.</p>
<p>Poiché l'implementazione di un modello ibrido può essere complessa, potresti considerare di sviluppare un servizio di autorizzazione separato per eliminare la necessità di apportare modifiche significative al codice con autorizzazioni volatili che cambiano frequentemente.</p>
<p><a data-primary="external authorization service" data-type="indexterm" id="ix_ch08-asciidoc27"/>L'utilizzo di un sistema esterno per le decisioni sull'autorizzazione permette alla logica di autorizzazione della tua applicazione di rimanere coerente, come mostra la <a data-type="xref" href="#authz_separate">Figura 8-17</a>.</p>
<figure><div class="figure" id="authz_separate">
<img alt="bgai 0817" src="assets/bgai_0817.png" width="1438" height="428"/>
<h6><span class="label">Figura 8-17. </span>Separazione del servizio di autorizzazione dal servizio GenAI</h6>
</div></figure>
<p>L<a data-type="xref" href="#authorization_separate_example">'esempio 8-22</a> mostra come sviluppare un sistema di autorizzazione separato.</p>
<div data-type="example" id="authorization_separate_example">
<h5><span class="label">Esempio 8-22. </span>Utilizzo di un servizio di autorizzazione con il servizio GenAI</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># authorization_api.py (Authorization Service)</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">typing</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">,</code> <code class="n" translate="no">Literal</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">fastapi</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Depends</code><code class="p" translate="no">,</code> <code class="n" translate="no">FastAPI</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">pydantic</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">BaseModel</code>

<code class="o" translate="no">...</code>  <code class="c1" translate="no"># import services and entities here</code>

<code class="n" translate="no">CurrentUserDep</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="n" translate="no">User</code><code class="p" translate="no">,</code> <code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">AuthService</code><code class="o" translate="no">.</code><code class="n" translate="no">get_current_user</code><code class="p" translate="no">)]</code>
<code class="n" translate="no">ActionRep</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="n" translate="no">Literal</code><code class="p" translate="no">[</code><code class="s2" translate="no">"READ"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"CREATE"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"UPDATE"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"DELETE"</code><code class="p" translate="no">],</code> <code class="nb" translate="no">str</code><code class="p" translate="no">]</code>
<code class="n" translate="no">ResourceDep</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="n" translate="no">Resource</code><code class="p" translate="no">,</code> <code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">ResourceService</code><code class="o" translate="no">.</code><code class="n" translate="no">get_resource</code><code class="p" translate="no">)]</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">AuthorizationResponse</code><code class="p" translate="no">(</code><code class="n" translate="no">BaseModel</code><code class="p" translate="no">):</code>
    <code class="n" translate="no">allowed</code><code class="p" translate="no">:</code> <code class="nb" translate="no">bool</code>

<code class="n" translate="no">app</code> <code class="o" translate="no">=</code> <code class="n" translate="no">FastAPI</code><code class="p" translate="no">()</code>

<code class="n" translate="no">app</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"/authorize"</code><code class="p" translate="no">)</code>
<code class="k" translate="no">def</code> <code class="nf" translate="no">authorization_controller</code><code class="p" translate="no">(</code>
    <code class="n" translate="no">user</code><code class="p" translate="no">:</code> <code class="n" translate="no">CurrentUserDep</code><code class="p" translate="no">,</code> <code class="n" translate="no">resource</code><code class="p" translate="no">:</code> <code class="n" translate="no">ResourceDep</code><code class="p" translate="no">,</code> <code class="n" translate="no">action</code><code class="p" translate="no">:</code> <code class="n" translate="no">ActionRep</code>
<code class="p" translate="no">)</code> <code class="o" translate="no">-&gt;</code> <code class="n" translate="no">AuthorizationResponse</code><code class="p" translate="no">:</code>
    <code class="k" translate="no">if</code> <code class="n" translate="no">user</code><code class="o" translate="no">.</code><code class="n" translate="no">role</code> <code class="o" translate="no">==</code> <code class="s2" translate="no">"ADMIN"</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">return</code> <code class="n" translate="no">AuthorizationResponse</code><code class="p" translate="no">(</code><code class="n" translate="no">allowed</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">if</code> <code class="n" translate="no">action</code> <code class="ow" translate="no">in</code> <code class="n" translate="no">user</code><code class="o" translate="no">.</code><code class="n" translate="no">permissions</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="n" translate="no">resource</code><code class="o" translate="no">.</code><code class="n" translate="no">id</code><code class="p" translate="no">,</code> <code class="p" translate="no">[]):</code>
        <code class="k" translate="no">return</code> <code class="n" translate="no">AuthorizationResponse</code><code class="p" translate="no">(</code><code class="n" translate="no">allowed</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">)</code>
    <code class="o" translate="no">...</code>  <code class="c1" translate="no"># Other permission checks</code>
    <code class="k" translate="no">return</code> <code class="n" translate="no">AuthorizationResponse</code><code class="p" translate="no">(</code><code class="n" translate="no">allowed</code><code class="o" translate="no">=</code><code class="kc" translate="no">False</code><code class="p" translate="no">)</code>

<code class="c1" translate="no"># genai_api.py (GenAI Service)</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">fastapi</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">APIRouter</code><code class="p" translate="no">,</code> <code class="n" translate="no">HTTPException</code><code class="p" translate="no">,</code> <code class="n" translate="no">status</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">pydantic</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">BaseModel</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">AuthorizationData</code><code class="p" translate="no">(</code><code class="n" translate="no">BaseModel</code><code class="p" translate="no">):</code>
    <code class="n" translate="no">user_id</code><code class="p" translate="no">:</code> <code class="nb" translate="no">int</code>
    <code class="n" translate="no">resource_id</code><code class="p" translate="no">:</code> <code class="nb" translate="no">int</code>
    <code class="n" translate="no">action</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code>

<code class="n" translate="no">authorization_client</code> <code class="o" translate="no">=</code> <code class="o" translate="no">...</code>  <code class="c1" translate="no"># Create authorization client</code>

<code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">enforce</code><code class="p" translate="no">(</code><code class="n" translate="no">data</code><code class="p" translate="no">:</code> <code class="n" translate="no">AuthorizationData</code><code class="p" translate="no">)</code> <code class="o" translate="no">-&gt;</code> <code class="nb" translate="no">bool</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">response</code> <code class="o" translate="no">=</code> <code class="k" translate="no">await</code> <code class="n" translate="no">authorization_client</code><code class="o" translate="no">.</code><code class="n" translate="no">decide</code><code class="p" translate="no">(</code><code class="n" translate="no">data</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">if</code> <code class="n" translate="no">response</code><code class="o" translate="no">.</code><code class="n" translate="no">allowed</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">return</code> <code class="kc" translate="no">True</code>
    <code class="k" translate="no">raise</code> <code class="n" translate="no">HTTPException</code><code class="p" translate="no">(</code>
        <code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="n" translate="no">status</code><code class="o" translate="no">.</code><code class="n" translate="no">HTTP_403_FORBIDDEN</code><code class="p" translate="no">,</code> <code class="n" translate="no">detail</code><code class="o" translate="no">=</code><code class="s2" translate="no">"Access Denied"</code>
    <code class="p" translate="no">)</code>

<code class="n" translate="no">router</code> <code class="o" translate="no">=</code> <code class="n" translate="no">APIRouter</code><code class="p" translate="no">(</code>
    <code class="n" translate="no">dependencies</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">enforce</code><code class="p" translate="no">)],</code> <code class="n" translate="no">prefix</code><code class="o" translate="no">=</code><code class="s2" translate="no">"/generate"</code><code class="p" translate="no">,</code> <code class="n" translate="no">tags</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="s2" translate="no">"Resource"</code><code class="p" translate="no">]</code>
<code class="p" translate="no">)</code>

<code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code><code class="s2" translate="no">"/text"</code><code class="p" translate="no">)</code>
<code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">generate_text_controller</code><code class="p" translate="no">():</code>
    <code class="o" translate="no">...</code></pre></div>
<p>Come puoi vedere nell'<a data-type="xref" href="#authorization_separate_example">Esempio 8-22</a>, l'utilizzo di un sistema esterno per autorizzare le azioni degli utenti sulle risorse aiuta te e il tuo team a modulare la logica di autorizzazione con requisiti più complessi e volatili.<a data-startref="ix_ch08-asciidoc27" data-type="indexterm" id="id1028"/></p>
<p>Tuttavia, poiché lo sviluppo di un complesso servizio di autorizzazione esterno da zero può richiedere molto tempo, potresti prendere in considerazione l'utilizzo di provider di autorizzazione (come Oso, Permify, Okta/Auth0, ecc.) con la tua autenticazione<a data-startref="ix_ch08-asciidoc26" data-type="indexterm" id="id1029"/>.<a data-startref="ix_ch08-asciidoc20" data-type="indexterm" id="id1030"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="id444">
<h1>Riassunto</h1>
<p>In questo capitolo hai imparato a conoscere i meccanismi di autenticazione e autorizzazione per proteggere i tuoi servizi GenAI.</p>
<p>All'inizio del capitolo ti sono stati presentati diversi metodi di autenticazione, tra cui l'autenticazione di base, quella basata su token, quella OAuth e quella basata su chiavi. Per fare esperienza pratica, hai implementato diversi sistemi di autenticazione da zero nel tuo servizio FastAPI, il che ti ha aiutato a comprendere i meccanismi sottostanti, tra cui la gestione delle password degli utenti, la creazione e l'utilizzo di token di accesso JWT e l'implementazione di flussi di autenticazione per la verifica degli utenti. Inoltre, hai imparato a integrare i tuoi servizi con identity provider come GitHub utilizzando lo standard OAuth2 per autenticare gli utenti e accedere a risorse esterne nella tua applicazione.</p>
<p>Mentre costruivi il sistema di autenticazione, hai imparato a conoscere i vettori di attacco come credential stuffing, password spraying, cross-site request forgery, open redirect e attacchi di phishing.</p>
<p>Inoltre, hai esplorato i sistemi di autorizzazione che determinano e applicano i livelli di accesso in base ai dati e alla logica di autorizzazione. Hai imparato come i sistemi di autorizzazione possono diventare complessi e come diversi modelli, tra cui RBAC, ReBAC e ABAC, possono aiutare a gestire i permessi nelle tue applicazioni.</p>
<p>Nel prossimo capitolo ti concentrerai sui test, compresa la scrittura di test unitari, di integrazione, end-to-end e di regressione. Verranno introdotti concetti come i confini dei test, la copertura, il mocking, il patching, la parametrizzazione, l'isolamento e l'idempotenza, che ti aiuteranno a scrivere test manutenibili ed efficaci man mano che le tue applicazioni crescono di complessità. In particolare, imparerai a testare i servizi GenAI che utilizzano modelli probabilistici e si interfacciano con sistemi asincroni.</p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="id970"><sup><a href="ch08.html#id970-marker">1</a></sup> Open Worldwide Application Security Project è una comunità online che produce risorse sulla sicurezza del software di sistema e delle applicazioni web.</p><p data-type="footnote" id="id971"><sup><a href="ch08.html#id971-marker">2</a></sup> L'autenticazione basata su chiavi non verrà discussa ulteriormente perché coinvolge principi crittografici complessi che esulano dallo scopo di questo capitolo.</p><p data-type="footnote" id="id972"><sup><a href="ch08.html#id972-marker">3</a></sup> In un <em>attacco di temporizzazione</em>, gli aggressori cercano di indovinare le password confrontando e analizzando i tempi di valutazione della password con la lunghezza della stessa. Pertanto, per prevenire gli attacchi temporali, gli algoritmi crittografici devono verificare le password in un arco di tempo costante.</p><p data-type="footnote" id="id982"><sup><a href="ch08.html#id982-marker">4</a></sup> Le lunghezze tipiche dei sali sono 16 byte (128 bit) per bilanciare prestazioni e sicurezza, oppure 32 byte (256 bit) per proteggere i sistemi sensibili. Puoi utilizzare librerie crittografiche come <code translate="no">passlib</code> per generare <span class="keep-together">correttamente</span> questi sali <span class="keep-together">.</span></p><p data-type="footnote" id="id994"><sup><a href="ch08.html#id994-marker">5</a></sup> Per istruzioni aggiornate, visita <a href="https://oreil.ly/tWg6w">la documentazione di GitHub</a>.</p></div></div></section></div></div></body></html>
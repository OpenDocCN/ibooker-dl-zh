<html><head></head><body><section data-pdf-bookmark="Chapter 8. Authentication and Authorization" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch08">&#13;
<h1><span class="label">Chapter 8. </span>Authentication and Authorization</h1>&#13;
&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id967">&#13;
<h1>Chapter Goals</h1>&#13;
<p>In this chapter, you will learn about:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Relevant authentication strategies for securing your GenAI services</p>&#13;
</li>&#13;
<li>&#13;
<p>How to implement basic credentials and JSON Web Token (JWT) authentication from scratch</p>&#13;
</li>&#13;
<li>&#13;
<p>Various authentication risks and attack vectors</p>&#13;
</li>&#13;
<li>&#13;
<p>How to build single sign-on (SSO) authentication with an identity provider such as GitHub following the OAuth2 standard</p>&#13;
</li>&#13;
<li>&#13;
<p>Authorization patterns such as role-based, attribute-based, and relationship-based access control</p>&#13;
</li>&#13;
<li>&#13;
<p>Authorization mechanisms to safeguard resources from nonprivileged users</p>&#13;
</li>&#13;
<li>&#13;
<p>How to restrict access to resources and limit AI generation outputs based on user privileges</p>&#13;
</li>&#13;
</ul>&#13;
</div></aside>&#13;
&#13;
<p>So far, you’ve built GenAI services that can interact with databases, stream model responses, and handle concurrent users.</p>&#13;
&#13;
<p>Your services are now up and running, but since they’re not protected from attackers or malicious users, deploying them to production may prove problematic.</p>&#13;
&#13;
<p>In this chapter, you’ll learn how to secure your services with an authentication layer and implement authorization guards to protect sensitive resources from nonprivileged users.</p>&#13;
&#13;
<p>To achieve this, we’re going to explore various authentication and authorization patterns then implement JWT and identity-based authentication with role-based access control.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Authentication and Authorization" data-type="sect1"><div class="sect1" id="id250">&#13;
<h1>Authentication and Authorization</h1>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="authorization versus" data-type="indexterm" id="id968"/><a data-primary="authorization" data-secondary="authentication versus" data-type="indexterm" id="id969"/>Before talking about authentication methods, let’s briefly clarify that authentication and authorization are two separate concepts that are often interchangeably used by mistake.</p>&#13;
&#13;
<p>According to the OWASP definition:<sup><a data-type="noteref" href="ch08.html#id970" id="id970-marker">1</a></sup></p>&#13;
<blockquote>&#13;
<p><em>Authentication</em> is the process of verifying that an individual, entity, or website is who or what it claims to be by determining the validity of one or more authenticators (like passwords, fingerprints, or security tokens) that are used to back up this claim.</p></blockquote>&#13;
&#13;
<p>On the other hand, the National Institute of Standards and Technology (NIST) defines authorization as:</p>&#13;
<blockquote>&#13;
<p>A process for verifying that a requested action or service is approved for a specific entity.</p></blockquote>&#13;
&#13;
<p>While authentication is about verifying the identity, authorization focuses on verifying permissions of an identity to access or mutate resources.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>An analogy that might clarify this distinction is passing through passport control at an airport.&#13;
Authentication is like presenting your passport at immigration, while authorization is like having the right visa to enter a country, specifying the duration of your stay and permitted activities once you enter.</p>&#13;
</div>&#13;
&#13;
<p>Let’s discuss authentication methods in more detail before diving into authorization later in the chapter.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="less_space pagebreak-before" data-pdf-bookmark="Authentication Methods" data-type="sect1"><div class="sect1" id="id251">&#13;
<h1>Authentication Methods</h1>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="methods" data-type="indexterm" id="ix_ch08-asciidoc0"/>There are several authentication mechanisms that you can implement in your GenAI services to secure them by identity verification.</p>&#13;
&#13;
<p>Depending on your security requirements, application environment, budget, and project timelines, you may decide to adopt one or more of the following authentication mechanisms:</p>&#13;
<dl>&#13;
<dt>Basic</dt>&#13;
<dd>&#13;
<p>Requiring the use of credentials such as username and password to verify &#13;
<span class="keep-together">identity.</span></p>&#13;
</dd>&#13;
<dt>JSON Web Tokens (JWT)</dt>&#13;
<dd>&#13;
<p>Requiring the use of <em>access tokens</em> to verify identity.&#13;
You can think of access tokens like cinema tickets that dictate whether you can access the screens and which screen you’re visiting and where you’re sitting.</p>&#13;
</dd>&#13;
<dt>OAuth</dt>&#13;
<dd>&#13;
<p>Verifying an identity via an identity provider using the <em>OAuth2</em> standard.</p>&#13;
</dd>&#13;
<dt>Key-based</dt>&#13;
<dd>&#13;
<p>Using a private and public key pair to authenticate an identity.&#13;
Instead of tokens, the authorization server issues a public key to the client and stores a copy of a linked private key that it can use later for verification.<sup><a data-type="noteref" href="ch08.html#id971" id="id971-marker">2</a></sup></p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p><a data-type="xref" href="#authentication_methods">Figure 8-1</a> shows the data flow of the aforementioned authentication methods in more detail.</p>&#13;
&#13;
<figure><div class="figure" id="authentication_methods">&#13;
<img alt="bgai 0801" src="assets/bgai_0801.png"/>&#13;
<h6><span class="label">Figure 8-1. </span>Authentication methods</h6>&#13;
</div></figure>&#13;
&#13;
<p>Being aware of authentication mechanisms, it can still be challenging to decide on the method to adopt when addressing your security requirements.&#13;
To assist with the selection task,&#13;
<a data-type="xref" href="#authentication_methods_comparison">Table 8-1</a> compares the aforementioned authentication methods.</p>&#13;
<table class="striped" id="authentication_methods_comparison">&#13;
<caption><span class="label">Table 8-1. </span>Comparison of authentication methods</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Type</th>&#13;
<th>Benefits</th>&#13;
<th>Limitations</th>&#13;
<th>Use cases</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td>Basic</td>&#13;
<td><ul><li><p>Simplicity</p></li>&#13;
<li><p>Fast to implement</p></li>&#13;
<li><p>Easy to understand</p></li></ul></td>&#13;
<td><p>Sends credentials in plain text</p></td>&#13;
<td><ul><li><p>Prototypes</p></li>&#13;
<li><p>Internal or nonproduction environments</p></li></ul></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Token</p></td>&#13;
<td><ul><li><p>Scalability</p></li>&#13;
<li><p>Decoupling facilitates implementation of microservice architectures</p></li>&#13;
<li><p>Tokens can be signed and encrypted for higher security</p></li>&#13;
<li><p>Highly customizable</p></li>&#13;
<li><p>Self-contained reducing database round-trips</p></li>&#13;
<li><p>Can be passed in HTTP headers</p></li></ul></td>&#13;
<td><ul>&#13;
<li><p>Constant need to regenerate short-lived tokens</p></li>&#13;
<li><p>Complexity of client-side token storage</p></li>&#13;
<li><p>Tokens can get large, consuming excess bandwidth</p></li>&#13;
<li><p>Stateless tokens can make multi-step applications hard to implement</p></li>&#13;
<li><p>Client-side misconfigurations can compromise tokens</p></li></ul></td>&#13;
<td><ul><li><p>Single-page and mobile applications</p></li>&#13;
<li><p>Applications requiring custom authentication flows</p></li>&#13;
<li><p>REST APIs</p></li></ul></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>OAuth</p></td>&#13;
<td><ul><li><p>Delegates authentication to external providers</p></li>&#13;
<li><p>Based on a standard (OAuth2) and battle-tested for enterprise scenarios</p></li>&#13;
<li><p>Access to external resources on behalf of the user</p></li></ul></td>&#13;
<td><ul><li><p>Complex to understand and implement</p></li>&#13;
<li><p>Each identity provider may implement the OAuth flow slightly differently</p></li></ul></td>&#13;
<td><ul><li><p>Applications requiring user data from external identity providers such as GitHub, Google, or Microsoft</p></li>&#13;
<li><p>Enterprise applications that require SSO with their own identity provider(s)</p></li></ul></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Key-based</p></td>&#13;
<td><ul><li><p>Similar authentication mechanism to Secure Shell (SSH) access</p></li></ul></td>&#13;
<td><ul><li><p>Managing and keeping private keys secure can be complex</p></li>&#13;
<li><p>Compromised keys can create security risks</p></li>&#13;
<li><p>Scalability issues</p></li></ul></td>&#13;
<td><ul><li><p>Small applications</p></li>&#13;
<li><p>Applications within internal environments</p></li></ul></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>You should now feel confident in deciding the appropriate authentication mechanism to adopt.&#13;
In the next section, you’re going to implement basic, JWT, and OAuth authentication for your GenAI to fully understand the underlying components and their interactions.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Basic Authentication" data-type="sect2"><div class="sect2" id="id114">&#13;
<h2>Basic Authentication</h2>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="methods" data-tertiary="basic authentication" data-type="indexterm" id="ix_ch08-asciidoc1"/><a data-primary="basic authentication" data-type="indexterm" id="ix_ch08-asciidoc2"/>In basic authentication, the client provides a username and password when making a request to access resources from the server.&#13;
It is the simplest technique as it won’t require cookies, session identifiers, or any login forms to be implemented.&#13;
Because of its simplicity, basic authentication is ideal for sandbox environments and when prototyping. However, avoid using it in production environments as it transmits usernames and passwords in plain text on every request, making it highly vulnerable to interception attacks.</p>&#13;
&#13;
<p class="less_space pagebreak-before">To perform an authenticated request via basic authentication, you must add an <code>Authorization</code> header with a value of <code>Basic &lt;credentials&gt;</code> for the server to successfully authenticate it.&#13;
The <code>&lt;credentials&gt;</code> value must be a <em>Base64</em> encoding of the username and password joined by a single colon (i.e., <code>base64.encode(ali:secretpassword)</code>.</p>&#13;
&#13;
<p>In FastAPI, you can protect an endpoint with basic authentication, as shown in <a data-type="xref" href="#basic_authentication_endpoint">Example 8-1</a>.</p>&#13;
<div data-type="example" id="basic_authentication_endpoint">&#13;
<h5><span class="label">Example 8-1. </span>Implementing basic authentication in FastAPI</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code><code> </code><code class="nn">secrets</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">typing</code><code> </code><code class="kn">import</code><code> </code><code class="n">Annotated</code><code>&#13;
</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">fastapi</code><code> </code><code class="kn">import</code><code> </code><code class="n">Depends</code><code class="p">,</code><code> </code><code class="n">FastAPI</code><code class="p">,</code><code> </code><code class="n">HTTPException</code><code class="p">,</code><code> </code><code class="n">status</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">fastapi</code><code class="nn">.</code><code class="nn">security</code><code> </code><code class="kn">import</code><code> </code><code class="n">HTTPBasic</code><code class="p">,</code><code> </code><code class="n">HTTPBasicCredentials</code><code>&#13;
</code><code>&#13;
</code><code class="n">app</code><code> </code><code class="o">=</code><code> </code><code class="n">FastAPI</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code class="n">security</code><code> </code><code class="o">=</code><code> </code><code class="n">HTTPBasic</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO1-1" id="co_authentication_and_authorization_CO1-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="n">username_bytes</code><code> </code><code class="o">=</code><code> </code><code class="sa">b</code><code class="s2">"</code><code class="s2">ali</code><code class="s2">"</code><code>&#13;
</code><code class="n">password_bytes</code><code> </code><code class="o">=</code><code> </code><code class="sa">b</code><code class="s2">"</code><code class="s2">secretpassword</code><code class="s2">"</code><code>&#13;
</code><code>&#13;
</code><code class="k">def</code><code> </code><code class="nf">authenticate_user</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="n">credentials</code><code class="p">:</code><code> </code><code class="n">Annotated</code><code class="p">[</code><code class="n">HTTPBasicCredentials</code><code class="p">,</code><code> </code><code class="n">Depends</code><code class="p">(</code><code class="n">security</code><code class="p">)</code><code class="p">]</code><code>&#13;
</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="nb">str</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="n">is_correct_username</code><code> </code><code class="o">=</code><code> </code><code class="n">secrets</code><code class="o">.</code><code class="n">compare_digest</code><code class="p">(</code><code>&#13;
</code><code>        </code><code class="n">credentials</code><code class="o">.</code><code class="n">username</code><code class="o">.</code><code class="n">encode</code><code class="p">(</code><code class="s2">"</code><code class="s2">UTF-8</code><code class="s2">"</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">username_bytes</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO1-2" id="co_authentication_and_authorization_CO1-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>    </code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="n">is_correct_password</code><code> </code><code class="o">=</code><code> </code><code class="n">secrets</code><code class="o">.</code><code class="n">compare_digest</code><code class="p">(</code><code>&#13;
</code><code>        </code><code class="n">credentials</code><code class="o">.</code><code class="n">password</code><code class="o">.</code><code class="n">encode</code><code class="p">(</code><code class="s2">"</code><code class="s2">UTF-8</code><code class="s2">"</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">password_bytes</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO1-2" id="co_authentication_and_authorization_CO1-3"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>    </code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="k">if</code><code> </code><code class="ow">not</code><code> </code><code class="p">(</code><code class="n">is_correct_username</code><code> </code><code class="ow">and</code><code> </code><code class="n">is_correct_password</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="k">raise</code><code> </code><code class="n">HTTPException</code><code class="p">(</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO1-3" id="co_authentication_and_authorization_CO1-4"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>            </code><code class="n">status_code</code><code class="o">=</code><code class="n">status</code><code class="o">.</code><code class="n">HTTP_401_UNAUTHORIZED</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="n">detail</code><code class="o">=</code><code class="s2">"</code><code class="s2">Incorrect credentials</code><code class="s2">"</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="n">headers</code><code class="o">=</code><code class="p">{</code><code class="s2">"</code><code class="s2">WWW-Authenticate</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="s2">"</code><code class="s2">Basic</code><code class="s2">"</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="n">credentials</code><code class="o">.</code><code class="n">username</code><code>&#13;
</code><code>&#13;
</code><code class="n">AuthenticatedUserDep</code><code> </code><code class="o">=</code><code> </code><code class="n">Annotated</code><code class="p">[</code><code class="nb">str</code><code class="p">,</code><code> </code><code class="n">Depends</code><code class="p">(</code><code class="n">authenticate_user</code><code class="p">)</code><code class="p">]</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO1-4" id="co_authentication_and_authorization_CO1-5"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">/users/me</code><code class="s2">"</code><code class="p">)</code><code>&#13;
</code><code class="k">def</code><code> </code><code class="nf">get_current_user_controller</code><code class="p">(</code><code class="n">username</code><code class="p">:</code><code> </code><code class="n">AuthenticatedUserDep</code><code class="p">)</code><code class="p">:</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO1-4" id="co_authentication_and_authorization_CO1-6"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="p">{</code><code class="s2">"</code><code class="s2">message</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="sa">f</code><code class="s2">"</code><code class="s2">Current user is </code><code class="si">{</code><code class="n">username</code><code class="si">}</code><code class="s2">"</code><code class="p">}</code></pre>&#13;
<dl class="calloutlist less_space pagebreak-before">&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO1-1" id="callout_authentication_and_authorization_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>FastAPI has implemented several HTTP security mechanisms including <code>HTTP​Ba⁠sic</code> that can leverage the FastAPI’s dependency injection system.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO1-2" id="callout_authentication_and_authorization_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Use the <code>secrets</code> built-in library to compare the provided username and password with the server’s values.&#13;
Using <code>secrets.compare_digest()</code> ensures the duration of checking operations remain consistent no matter what the inputs are to avoid <em>timing attacks</em>.<sup><a data-type="noteref" href="ch08.html#id972" id="id972-marker">3</a></sup></p>&#13;
&#13;
<p>Note that <code>secrets.compare_digest()</code> can only accept byte or string inputs containing ASCII characters (i.e., English-only characters).&#13;
To handle other characters, you will need to encode the inputs with <code>UTF-8</code> to bytes first before performing the credential checks.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO1-4" id="callout_authentication_and_authorization_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Return a standardized authorization <code>HTTPException</code> compliant with security standards that browsers understand so that they show the login prompt again to the user.&#13;
The exception message must be generic to avoid leaking any sensitive information, such as the existence of a user account, to attackers.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO1-5" id="callout_authentication_and_authorization_CO1-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Using the <code>HTTPBasic</code> with <code>Depends()</code> returns the <code>HTTPBasicCredentials</code> object that contains the provided username.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Injecting a security dependency to any FastAPI endpoint will protect it with the implemented authentication.&#13;
You can experience this yourself now by visiting the &#13;
<span class="keep-together"><code>/docs</code></span> page and sending a request to the <code>/users/me</code> endpoint.</p>&#13;
&#13;
<p>The endpoint will show a <em>lock</em> icon in front of it, and you should see a sign-in alert when making a request, asking you to provide credentials, as you can see in <a data-type="xref" href="#basic_authentication">Figure 8-2</a>.</p>&#13;
&#13;
<figure><div class="figure" id="basic_authentication">&#13;
<img alt="bgai 0802" src="assets/bgai_0802.png"/>&#13;
<h6><span class="label">Figure 8-2. </span>Basic authentication in FastAPI</h6>&#13;
</div></figure>&#13;
&#13;
<p>Well done!&#13;
In 25 lines of code, you managed to implement a basic form of authentication to protect an endpoint.&#13;
You can now use basic authentication in your own prototypes and development servers.</p>&#13;
&#13;
<p>Bear in mind, you should avoid adopting the basic authentication mechanism in production-grade GenAI services.&#13;
A better and more secure alternative for public-facing services is <em>JWT authentication</em>.&#13;
It eliminates the need for server-side sessions by storing all authentication details within a token.&#13;
It also maintains data integrity and works across different domains with a widely accepted standard.<a data-startref="ix_ch08-asciidoc2" data-type="indexterm" id="id973"/><a data-startref="ix_ch08-asciidoc1" data-type="indexterm" id="id974"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="less_space pagebreak-before" data-pdf-bookmark="JSON Web Tokens (JWT) Authentication" data-type="sect2"><div class="sect2" id="id115">&#13;
<h2>JSON Web Tokens (JWT) Authentication</h2>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="methods" data-tertiary="JWT authentication" data-type="indexterm" id="ix_ch08-asciidoc3"/><a data-primary="JSON Web Tokens (JWT) authentication" data-type="indexterm" id="ix_ch08-asciidoc4"/>Now that you’re more familiar with basic concepts of authentication, let’s implement a more complex but secure JWT authentication layer to your FastAPI service.&#13;
As part of this, you’ll also refactor your existing endpoints to combine them under a separate resource API router to group, name, tag, and protect multiple endpoints at once.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="What is JWT?" data-type="sect3"><div class="sect3" id="id116">&#13;
<h3>What is JWT?</h3>&#13;
&#13;
<p><a data-primary="JSON Web Tokens (JWT) authentication" data-secondary="JWT defined" data-type="indexterm" id="ix_ch08-asciidoc5"/>JWTs are a URL-safe and compact way of asserting claims between applications via tokens.</p>&#13;
&#13;
<p>These tokens consist of three parts:</p>&#13;
<dl>&#13;
<dt>Headers</dt>&#13;
<dd>&#13;
<p>Specify the token type and signing algorithm in addition to the datetime and the issuing authority.</p>&#13;
</dd>&#13;
<dt>Payload</dt>&#13;
<dd>&#13;
<p>Specify the body of the token representing the claims on the resource alongside additional metadata.</p>&#13;
</dd>&#13;
<dt>Signature</dt>&#13;
<dd>&#13;
<p>The function that creates the token will also sign it using the <em>encoded payload</em>, <em>encoded headers</em>, a <em>secret</em>, and the signing algorithm.</p>&#13;
</dd>&#13;
</dl>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>The <code>base64</code> encoding algorithm is often used to encode and decode data for compactness and URL safety.</p>&#13;
</div>&#13;
&#13;
<p><a data-type="xref" href="#jwt">Figure 8-3</a> shows what a typical JWT looks like.</p>&#13;
&#13;
<figure><div class="figure" id="jwt">&#13;
<img alt="bgai 0803" src="assets/bgai_0803.png"/>&#13;
<h6><span class="label">Figure 8-3. </span>JWT components (Source: <a class="orm:hideurl" href="https://jwt.io">jwt.io</a>)</h6>&#13;
</div></figure>&#13;
&#13;
<p>JWTs are secure, compact, and convenient since they can hold all the information needed to perform user authentication, avoiding the need for multiple database round-trips.&#13;
In addition, due to their compactness, you can transfer them across the network using the HTTP <code>POST</code> body, headers, or URL parameters.<a data-startref="ix_ch08-asciidoc5" data-type="indexterm" id="id975"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Getting started with JWT authentication" data-type="sect3"><div class="sect3" id="id117">&#13;
<h3>Getting started with JWT authentication</h3>&#13;
&#13;
<p><a data-primary="JSON Web Tokens (JWT) authentication" data-secondary="getting started with implementation" data-type="indexterm" id="ix_ch08-asciidoc6"/>To get started with implementing the JWT authentication mechanism in FastAPI, you need to install the <code>passlib</code> and <code>python-jose</code> dependencies:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">$<code class="w"> </code>pip<code class="w"> </code>install<code class="w"> </code>passlib<code class="w"> </code>python-jose<code class="w"/></pre>&#13;
&#13;
<p>With the dependencies installed, you will then need tables in the database to store the generated users and associated token data.&#13;
For data persistence, let’s migrate the database to create the <code>users</code> and <code>tokens</code> tables, as shown in <a data-type="xref" href="#erd">Figure 8-4</a>.</p>&#13;
&#13;
<figure><div class="figure" id="erd">&#13;
<img alt="bgai 0804" src="assets/bgai_0804.png"/>&#13;
<h6><span class="label">Figure 8-4. </span>Entity relationship diagram of <code>users</code> and <code>tokens</code> tables</h6>&#13;
</div></figure>&#13;
&#13;
<p>If you look at <a data-type="xref" href="#erd">Figure 8-4</a>, you will spot that the <code>tokens</code> table has a one-to-many relationship with the <code>users</code> table.&#13;
You can use the token records to track successful login attempts for each user and to revoke access if needed.</p>&#13;
&#13;
<p><a data-primary="Pydantic" data-secondary="defining schemas for database queries/data validation" data-type="indexterm" id="ix_ch08-asciidoc7"/><a data-primary="SQLAlchemy package" data-secondary="defining schemas for database queries/data validation" data-type="indexterm" id="ix_ch08-asciidoc8"/>Next, let’s define the required SQLAlchemy models and Pydantic schemas for database queries and data validation, as shown in Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#user_models">8-2</a>  and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#users_schema">8-3</a>.</p>&#13;
<div data-type="example" id="user_models">&#13;
<h5><span class="label">Example 8-2. </span>Declare user SQLAlchemy ORM models</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># entities.py</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">uuid</code>&#13;
<code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">UTC</code><code class="p">,</code> <code class="n">datetime</code>&#13;
<code class="kn">from</code> <code class="nn">sqlalchemy</code> <code class="kn">import</code> <code class="n">Index</code><code class="p">,</code> <code class="n">String</code>&#13;
<code class="kn">from</code> <code class="nn">sqlalchemy.orm</code> <code class="kn">import</code> <code class="n">DeclarativeBase</code><code class="p">,</code> <code class="n">Mapped</code><code class="p">,</code> <code class="n">mapped_column</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Base</code><code class="p">(</code><code class="n">DeclarativeBase</code><code class="p">):</code>&#13;
    <code class="k">pass</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">User</code><code class="p">(</code><code class="n">Base</code><code class="p">):</code>&#13;
    <code class="n">__tablename__</code> <code class="o">=</code> <code class="s2">"users"</code>&#13;
&#13;
    <code class="nb">id</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="n">uuid</code><code class="o">.</code><code class="n">UUID</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="n">primary_key</code><code class="o">=</code><code class="kc">True</code><code class="p">,</code> <code class="n">default</code><code class="o">=</code><code class="n">uuid</code><code class="o">.</code><code class="n">uuid4</code><code class="p">)</code>&#13;
    <code class="n">email</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="nb">str</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="n">String</code><code class="p">(</code><code class="n">length</code><code class="o">=</code><code class="mi">255</code><code class="p">),</code> <code class="n">unique</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>&#13;
    <code class="n">hashed_password</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="nb">str</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="n">String</code><code class="p">(</code><code class="n">length</code><code class="o">=</code><code class="mi">255</code><code class="p">))</code>&#13;
    <code class="n">is_active</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="nb">bool</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="n">default</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>&#13;
    <code class="n">role</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="nb">str</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="n">default</code><code class="o">=</code><code class="s2">"USER"</code><code class="p">)</code>&#13;
    <code class="n">created_at</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="n">datetime</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="n">default</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">))</code>&#13;
    <code class="n">updated_at</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="n">datetime</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code>&#13;
        <code class="n">default</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">),</code> <code class="n">onupdate</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">)</code>&#13;
    <code class="p">)</code>&#13;
&#13;
    <code class="n">__table_args__</code> <code class="o">=</code> <code class="p">(</code><code class="n">Index</code><code class="p">(</code><code class="s2">"ix_users_email"</code><code class="p">,</code> <code class="s2">"email"</code><code class="p">),)</code></pre></div>&#13;
&#13;
<p>You will be using the ORM models at the data access layer while the Pydantic schemas will validate incoming and outgoing authentication data at the endpoint layer.</p>&#13;
<div data-type="example" id="users_schema">&#13;
<h5><span class="label">Example 8-3. </span>Declare user Pydantic schemas with username and password field validators</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># schemas.py</code><code>&#13;
</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">datetime</code><code> </code><code class="kn">import</code><code> </code><code class="n">datetime</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">typing</code><code> </code><code class="kn">import</code><code> </code><code class="n">Annotated</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">pydantic</code><code> </code><code class="kn">import</code><code> </code><code class="p">(</code><code class="n">UUID4</code><code class="p">,</code><code> </code><code class="n">AfterValidator</code><code class="p">,</code><code> </code><code class="n">BaseModel</code><code class="p">,</code><code> </code><code class="n">ConfigDict</code><code class="p">,</code><code> </code><code class="n">Field</code><code class="p">,</code><code>&#13;
</code><code>                      </code><code class="n">validate_call</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="nd">@validate_call</code><code>&#13;
</code><code class="k">def</code><code> </code><code class="nf">validate_username</code><code class="p">(</code><code class="n">value</code><code class="p">:</code><code> </code><code class="nb">str</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="nb">str</code><code class="p">:</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO2-1" id="co_authentication_and_authorization_CO2-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>    </code><code class="k">if</code><code> </code><code class="ow">not</code><code> </code><code class="n">value</code><code class="o">.</code><code class="n">isalnum</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="k">raise</code><code> </code><code class="ne">ValueError</code><code class="p">(</code><code class="s2">"</code><code class="s2">Username must be alphanumeric</code><code class="s2">"</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="n">value</code><code>&#13;
</code><code>&#13;
</code><code class="nd">@validate_call</code><code>&#13;
</code><code class="k">def</code><code> </code><code class="nf">validate_password</code><code class="p">(</code><code class="n">value</code><code class="p">:</code><code> </code><code class="nb">str</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="nb">str</code><code class="p">:</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO2-1" id="co_authentication_and_authorization_CO2-2"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>    </code><code class="n">validations</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code>&#13;
</code><code>        </code><code class="p">(</code><code>&#13;
</code><code>            </code><code class="k">lambda</code><code> </code><code class="n">v</code><code class="p">:</code><code> </code><code class="nb">any</code><code class="p">(</code><code class="n">char</code><code class="o">.</code><code class="n">isdigit</code><code class="p">(</code><code class="p">)</code><code> </code><code class="k">for</code><code> </code><code class="n">char</code><code> </code><code class="ow">in</code><code> </code><code class="n">v</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="s2">"</code><code class="s2">Password must contain at least one digit</code><code class="s2">"</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="p">(</code><code>&#13;
</code><code>            </code><code class="k">lambda</code><code> </code><code class="n">v</code><code class="p">:</code><code> </code><code class="nb">any</code><code class="p">(</code><code class="n">char</code><code class="o">.</code><code class="n">isupper</code><code class="p">(</code><code class="p">)</code><code> </code><code class="k">for</code><code> </code><code class="n">char</code><code> </code><code class="ow">in</code><code> </code><code class="n">v</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="s2">"</code><code class="s2">Password must contain at least one uppercase letter</code><code class="s2">"</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="p">(</code><code>&#13;
</code><code>            </code><code class="k">lambda</code><code> </code><code class="n">v</code><code class="p">:</code><code> </code><code class="nb">any</code><code class="p">(</code><code class="n">char</code><code class="o">.</code><code class="n">islower</code><code class="p">(</code><code class="p">)</code><code> </code><code class="k">for</code><code> </code><code class="n">char</code><code> </code><code class="ow">in</code><code> </code><code class="n">v</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="s2">"</code><code class="s2">Password must contain at least one lowercase letter</code><code class="s2">"</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="p">]</code><code>&#13;
</code><code>    </code><code class="k">for</code><code> </code><code class="n">condition</code><code class="p">,</code><code> </code><code class="n">error_message</code><code> </code><code class="ow">in</code><code> </code><code class="n">validations</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="ow">not</code><code> </code><code class="n">condition</code><code class="p">(</code><code class="n">value</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="k">raise</code><code> </code><code class="ne">ValueError</code><code class="p">(</code><code class="n">error_message</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="n">value</code><code>&#13;
</code><code>&#13;
</code><code class="n">ValidUsername</code><code> </code><code class="o">=</code><code> </code><code class="n">Annotated</code><code class="p">[</code><code>&#13;
</code><code>    </code><code class="nb">str</code><code class="p">,</code><code> </code><code class="n">Field</code><code class="p">(</code><code class="n">min_length</code><code class="o">=</code><code class="mi">3</code><code class="p">,</code><code> </code><code class="n">max_length</code><code class="o">=</code><code class="mi">20</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">AfterValidator</code><code class="p">(</code><code class="n">validate_username</code><code class="p">)</code><code>&#13;
</code><code class="p">]</code><code>&#13;
</code><code class="n">ValidPassword</code><code> </code><code class="o">=</code><code> </code><code class="n">Annotated</code><code class="p">[</code><code>&#13;
</code><code>    </code><code class="nb">str</code><code class="p">,</code><code> </code><code class="n">Field</code><code class="p">(</code><code class="n">min_length</code><code class="o">=</code><code class="mi">8</code><code class="p">,</code><code> </code><code class="n">max_length</code><code class="o">=</code><code class="mi">64</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">AfterValidator</code><code class="p">(</code><code class="n">validate_password</code><code class="p">)</code><code>&#13;
</code><code class="p">]</code><code>&#13;
</code><code>&#13;
</code><code class="k">class</code><code> </code><code class="nc">UserBase</code><code class="p">(</code><code class="n">BaseModel</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="n">model_config</code><code> </code><code class="o">=</code><code> </code><code class="n">ConfigDict</code><code class="p">(</code><code class="n">from_attributes</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO2-2" id="co_authentication_and_authorization_CO2-3"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="n">username</code><code class="p">:</code><code> </code><code class="n">ValidUsername</code><code>&#13;
</code><code>    </code><code class="n">is_active</code><code class="p">:</code><code> </code><code class="nb">bool</code><code> </code><code class="o">=</code><code> </code><code class="kc">True</code><code>&#13;
</code><code>    </code><code class="n">role</code><code class="p">:</code><code> </code><code class="nb">str</code><code> </code><code class="o">=</code><code> </code><code class="s2">"</code><code class="s2">USER</code><code class="s2">"</code><code>&#13;
</code><code>&#13;
</code><code class="k">class</code><code> </code><code class="nc">UserCreate</code><code class="p">(</code><code class="n">UserBase</code><code class="p">)</code><code class="p">:</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO2-3" id="co_authentication_and_authorization_CO2-4"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>    </code><code class="n">password</code><code class="p">:</code><code> </code><code class="n">ValidPassword</code><code>&#13;
</code><code>&#13;
</code><code class="k">class</code><code> </code><code class="nc">UserInDB</code><code class="p">(</code><code class="n">UserBase</code><code class="p">)</code><code class="p">:</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO2-4" id="co_authentication_and_authorization_CO2-5"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>    </code><code class="n">hashed_password</code><code class="p">:</code><code> </code><code class="nb">str</code><code>&#13;
</code><code>&#13;
</code><code class="k">class</code><code> </code><code class="nc">UserOut</code><code class="p">(</code><code class="n">UserBase</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nb">id</code><code class="p">:</code><code> </code><code class="n">UUID4</code><code>&#13;
</code><code>    </code><code class="n">created_at</code><code class="p">:</code><code> </code><code class="n">datetime</code><code>&#13;
</code><code>    </code><code class="n">updated_at</code><code class="p">:</code><code> </code><code class="n">datetime</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO2-1" id="callout_authentication_and_authorization_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Validate both username and password to enforce higher security requirements.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO2-3" id="callout_authentication_and_authorization_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Allow Pydantic to read SQLAlchemy ORM model attributes instead of having to manually populate Pydantic schemas from SQLAlchemy models.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO2-4" id="callout_authentication_and_authorization_CO2-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Use inheritance to declare several Pydantic schemas based on a user base model.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO2-5" id="callout_authentication_and_authorization_CO2-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Create a separate schema that accepts the <code>hashed_password</code> field to be used only for creating new user records during the registration process.&#13;
All other schemas must skip storing this field to eliminate the risk of password leakage.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Creating the token models and schemas is fairly similar, as you can see in <a data-type="xref" href="#token_models">Example 8-4</a>.</p>&#13;
<div data-type="example" id="token_models">&#13;
<h5><span class="label">Example 8-4. </span>Declare token ORM models and Pydantic schemas</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># entities.py</code>&#13;
&#13;
<code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">UTC</code><code class="p">,</code> <code class="n">datetime</code>&#13;
<code class="kn">from</code> <code class="nn">sqlalchemy</code> <code class="kn">import</code> <code class="n">ForeignKey</code><code class="p">,</code> <code class="n">Index</code><code class="p">,</code> <code class="n">String</code>&#13;
<code class="kn">from</code> <code class="nn">sqlalchemy.orm</code> <code class="kn">import</code> <code class="n">DeclarativeBase</code><code class="p">,</code> <code class="n">Mapped</code><code class="p">,</code> <code class="n">mapped_column</code><code class="p">,</code> <code class="n">relationship</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Base</code><code class="p">(</code><code class="n">DeclarativeBase</code><code class="p">):</code>&#13;
    <code class="k">pass</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Token</code><code class="p">(</code><code class="n">Base</code><code class="p">):</code>&#13;
    <code class="n">__tablename__</code> <code class="o">=</code> <code class="s2">"tokens"</code>&#13;
&#13;
    <code class="nb">id</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="nb">int</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="n">primary_key</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>&#13;
    <code class="n">user_id</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="nb">int</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="n">ForeignKey</code><code class="p">(</code><code class="s2">"users.id"</code><code class="p">))</code>&#13;
    <code class="n">expires_at</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="n">datetime</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">()</code>&#13;
    <code class="n">is_active</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="nb">bool</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="n">default</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>&#13;
    <code class="n">ip_address</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="nb">str</code> <code class="o">|</code> <code class="kc">None</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="n">String</code><code class="p">(</code><code class="n">length</code><code class="o">=</code><code class="mi">255</code><code class="p">))</code>&#13;
    <code class="n">created_at</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="n">datetime</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="n">default</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">))</code>&#13;
    <code class="n">updated_at</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="n">datetime</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code>&#13;
        <code class="n">default</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">),</code> <code class="n">onupdate</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">)</code>&#13;
    <code class="p">)</code>&#13;
&#13;
    <code class="n">user</code> <code class="o">=</code> <code class="n">relationship</code><code class="p">(</code><code class="s2">"User"</code><code class="p">,</code> <code class="n">back_populates</code><code class="o">=</code><code class="s2">"tokens"</code><code class="p">)</code>&#13;
&#13;
    <code class="n">__table_args__</code> <code class="o">=</code> <code class="p">(</code>&#13;
        <code class="n">Index</code><code class="p">(</code><code class="s2">"ix_tokens_user_id"</code><code class="p">,</code> <code class="s2">"user_id"</code><code class="p">),</code>&#13;
        <code class="n">Index</code><code class="p">(</code><code class="s2">"ix_tokens_ip_address"</code><code class="p">,</code> <code class="s2">"ip_address"</code><code class="p">),</code>&#13;
    <code class="p">)</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">User</code><code class="p">(</code><code class="n">Base</code><code class="p">):</code>&#13;
    <code class="n">__tablename__</code> <code class="o">=</code> <code class="s2">"users"</code>&#13;
    <code class="c1"># other columns...</code>&#13;
&#13;
    <code class="n">tokens</code> <code class="o">=</code> <code class="n">relationship</code><code class="p">(</code>&#13;
        <code class="s2">"Token"</code><code class="p">,</code> <code class="n">back_populates</code><code class="o">=</code><code class="s2">"user"</code><code class="p">,</code> <code class="n">cascade</code><code class="o">=</code><code class="s2">"all, delete-orphan"</code>&#13;
    <code class="p">)</code>&#13;
&#13;
<code class="c1"># schemas.py</code>&#13;
&#13;
<code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">datetime</code>&#13;
<code class="kn">from</code> <code class="nn">pydantic</code> <code class="kn">import</code> <code class="n">BaseModel</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">TokenBase</code><code class="p">(</code><code class="n">BaseModel</code><code class="p">):</code>&#13;
    <code class="n">user_id</code><code class="p">:</code> <code class="nb">int</code>&#13;
    <code class="n">expires_at</code><code class="p">:</code> <code class="n">datetime</code>&#13;
    <code class="n">is_active</code><code class="p">:</code> <code class="nb">bool</code> <code class="o">=</code> <code class="kc">True</code>&#13;
    <code class="n">ip_address</code><code class="p">:</code> <code class="nb">str</code> <code class="o">|</code> <code class="kc">None</code> <code class="o">=</code> <code class="kc">None</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">TokenCreate</code><code class="p">(</code><code class="n">TokenBase</code><code class="p">):</code>&#13;
    <code class="k">pass</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">TokenOut</code><code class="p">(</code><code class="n">BaseModel</code><code class="p">):</code>&#13;
    <code class="n">access_token</code><code class="p">:</code> <code class="nb">str</code>&#13;
    <code class="n">token_type</code><code class="p">:</code> <code class="nb">str</code> <code class="o">=</code> <code class="s2">"Bearer"</code></pre></div>&#13;
&#13;
<p>Next<a data-startref="ix_ch08-asciidoc8" data-type="indexterm" id="id976"/><a data-startref="ix_ch08-asciidoc7" data-type="indexterm" id="id977"/>, let’s auto-generate a migration file using the <code>alembic revision --autogenerate -m "create users and tokens tables</code> command so that you can specify the details of both tables by following <a data-type="xref" href="#users_migration">Example 8-5</a>.</p>&#13;
<div data-type="example" id="users_migration">&#13;
<h5><span class="label">Example 8-5. </span>Database migration to create the <code>users</code> and <code>tokens</code> tables</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="sd">"""create users and tokens tables&#13;
&#13;
Revision ID: 1234567890ab&#13;
Revises:&#13;
Create Date: 2025-01-28 12:34:56.789012&#13;
&#13;
"""</code><code>&#13;
</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">datetime</code><code> </code><code class="kn">import</code><code> </code><code class="n">UTC</code><code class="p">,</code><code> </code><code class="n">datetime</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="nn">sqlalchemy</code><code> </code><code class="k">as</code><code> </code><code class="nn">sa</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">alembic</code><code> </code><code class="kn">import</code><code> </code><code class="n">op</code><code>&#13;
</code><code>&#13;
</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>&#13;
</code><code>&#13;
</code><code class="k">def</code><code> </code><code class="nf">upgrade</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="n">op</code><code class="o">.</code><code class="n">create_table</code><code class="p">(</code><code>&#13;
</code><code>        </code><code class="s2">"</code><code class="s2">users</code><code class="s2">"</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"</code><code class="s2">id</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">sa</code><code class="o">.</code><code class="n">UUID</code><code class="p">(</code><code class="n">as_uuid</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO3-1" id="co_authentication_and_authorization_CO3-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"</code><code class="s2">email</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">sa</code><code class="o">.</code><code class="n">String</code><code class="p">(</code><code class="n">length</code><code class="o">=</code><code class="mi">255</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"</code><code class="s2">hashed_password</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">sa</code><code class="o">.</code><code class="n">String</code><code class="p">(</code><code class="n">length</code><code class="o">=</code><code class="mi">255</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO3-2" id="co_authentication_and_authorization_CO3-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>        </code><code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code>&#13;
</code><code>            </code><code class="s2">"</code><code class="s2">is_active</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">sa</code><code class="o">.</code><code class="n">Boolean</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">server_default</code><code class="o">=</code><code class="n">sa</code><code class="o">.</code><code class="n">sql</code><code class="o">.</code><code class="n">expression</code><code class="o">.</code><code class="n">true</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO3-3" id="co_authentication_and_authorization_CO3-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>        </code><code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"</code><code class="s2">role</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">sa</code><code class="o">.</code><code class="n">String</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">server_default</code><code class="o">=</code><code class="n">sa</code><code class="o">.</code><code class="n">text</code><code class="p">(</code><code class="s2">"</code><code class="s2">USER</code><code class="s2">"</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO3-4" id="co_authentication_and_authorization_CO3-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>        </code><code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"</code><code class="s2">created_at</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">sa</code><code class="o">.</code><code class="n">DateTime</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">default</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code>&#13;
</code><code>            </code><code class="s2">"</code><code class="s2">updated_at</code><code class="s2">"</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="n">sa</code><code class="o">.</code><code class="n">DateTime</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="n">default</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="n">onupdate</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO3-5" id="co_authentication_and_authorization_CO3-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>        </code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="n">sa</code><code class="o">.</code><code class="n">PrimaryKeyConstraint</code><code class="p">(</code><code class="s2">"</code><code class="s2">id</code><code class="s2">"</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="n">sa</code><code class="o">.</code><code class="n">UniqueConstraint</code><code class="p">(</code><code class="s2">"</code><code class="s2">email</code><code class="s2">"</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="n">sa</code><code class="o">.</code><code class="n">Index</code><code class="p">(</code><code class="s2">"</code><code class="s2">ix_users_email</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">email</code><code class="s2">"</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO3-6" id="co_authentication_and_authorization_CO3-6"><img alt="6" src="assets/6.png"/></a><code>&#13;
</code><code>    </code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="n">op</code><code class="o">.</code><code class="n">create_table</code><code class="p">(</code><code>&#13;
</code><code>        </code><code class="s2">"</code><code class="s2">tokens</code><code class="s2">"</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"</code><code class="s2">id</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">sa</code><code class="o">.</code><code class="n">UUID</code><code class="p">(</code><code class="n">as_uuid</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO3-1" id="co_authentication_and_authorization_CO3-7"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"</code><code class="s2">user_id</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">sa</code><code class="o">.</code><code class="n">Integer</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"</code><code class="s2">expires_at</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">sa</code><code class="o">.</code><code class="n">DateTime</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO3-7" id="co_authentication_and_authorization_CO3-8"><img alt="7" src="assets/7.png"/></a><code>&#13;
</code><code>        </code><code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"</code><code class="s2">is_active</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">sa</code><code class="o">.</code><code class="n">Boolean</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">default</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO3-8" id="co_authentication_and_authorization_CO3-9"><img alt="8" src="assets/8.png"/></a><code>&#13;
</code><code>        </code><code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"</code><code class="s2">ip_address</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">sa</code><code class="o">.</code><code class="n">String</code><code class="p">(</code><code class="n">length</code><code class="o">=</code><code class="mi">255</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">nullable</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"</code><code class="s2">created_at</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">sa</code><code class="o">.</code><code class="n">DateTime</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">default</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code>&#13;
</code><code>            </code><code class="s2">"</code><code class="s2">updated_at</code><code class="s2">"</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="n">sa</code><code class="o">.</code><code class="n">DateTime</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="n">default</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="n">onupdate</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO3-9" id="co_authentication_and_authorization_CO3-10"><img alt="9" src="assets/9.png"/></a><code>&#13;
</code><code>        </code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="n">sa</code><code class="o">.</code><code class="n">ForeignKeyConstraint</code><code class="p">(</code><code>&#13;
</code><code>            </code><code class="p">[</code><code class="s2">"</code><code class="s2">user_id</code><code class="s2">"</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="p">[</code><code class="s2">"</code><code class="s2">users.id</code><code class="s2">"</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="n">sa</code><code class="o">.</code><code class="n">PrimaryKeyConstraint</code><code class="p">(</code><code class="s2">"</code><code class="s2">id</code><code class="s2">"</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="n">sa</code><code class="o">.</code><code class="n">Index</code><code class="p">(</code><code class="s2">"</code><code class="s2">ix_tokens_user_id</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">user_id</code><code class="s2">"</code><code class="p">)</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="n">sa</code><code class="o">.</code><code class="n">Index</code><code class="p">(</code><code class="s2">"</code><code class="s2">ix_tokens_ip_address</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">ip_address</code><code class="s2">"</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO3-10" id="co_authentication_and_authorization_CO3-11"><img alt="10" src="assets/10.png"/></a><code>&#13;
</code><code>    </code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>&#13;
</code><code class="k">def</code><code> </code><code class="nf">downgrade</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="n">op</code><code class="o">.</code><code class="n">drop_table</code><code class="p">(</code><code class="s2">"</code><code class="s2">tokens</code><code class="s2">"</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="n">op</code><code class="o">.</code><code class="n">drop_table</code><code class="p">(</code><code class="s2">"</code><code class="s2">users</code><code class="s2">"</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO3-1" id="callout_authentication_and_authorization_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Automatically generate universally unique identifiers (UUIDs) in the database layer for user and token records to prevent attackers from guessing identifiers of sensitive resources (i.e., user or token records).</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO3-2" id="callout_authentication_and_authorization_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Avoid storing raw password strings in the database to reduce security &#13;
<span class="keep-together">vulnerabilities.</span></p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO3-3" id="callout_authentication_and_authorization_CO3-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Add the ability to enable or disable account access.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO3-4" id="callout_authentication_and_authorization_CO3-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Add the ability to specify user roles such as <code>USER</code> and <code>ADMIN</code> for managing access levels of an account. Authorization checks will use the <code>role</code> field to manage access of privileged resources.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO3-5" id="callout_authentication_and_authorization_CO3-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Auto-timestamp user creation and updates for monitoring and security purposes.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO3-6" id="callout_authentication_and_authorization_CO3-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Add a unique constraint and a secondary index on the email field to optimize user queries by email and eliminate the possibility of creating duplicate email accounts.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO3-8" id="callout_authentication_and_authorization_CO3-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Tokens must expire after a short period of time to reduce the time window that exposed tokens may be misused by attackers.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO3-9" id="callout_authentication_and_authorization_CO3-8"><img alt="8" src="assets/8.png"/></a></dt>&#13;
<dd><p>Add the ability to disable tokens that should no longer be valid for either being exposed or if a user has logged out.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO3-10" id="callout_authentication_and_authorization_CO3-9"><img alt="9" src="assets/9.png"/></a></dt>&#13;
<dd><p>Track the token creation and update times for monitoring and security.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO3-11" id="callout_authentication_and_authorization_CO3-10"><img alt="10" src="assets/10.png"/></a></dt>&#13;
<dd><p>Create secondary indexes on <code>user_id</code> and <code>ip_address</code> fields to optimize token queries by these fields.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Now, run the <code>alembic upgrade head</code> command to execute the migration in <a data-type="xref" href="#users_migration">Example 8-5</a> against your database and create both <code>users</code> and <code>tokens</code> tables.</p>&#13;
&#13;
<p class="less_space pagebreak-before">With the ORM models and Pydantic schemas declared, you can focus on the core authentication mechanism logic.</p>&#13;
&#13;
<p><a data-type="xref" href="#jwt_architecture">Figure 8-5</a> shows the architecture of the JWT authentication system you’re going to implement in your FastAPI GenAI service.</p>&#13;
&#13;
<figure><div class="figure" id="jwt_architecture">&#13;
<img alt="bgai 0805" src="assets/bgai_0805.png"/>&#13;
<h6><span class="label">Figure 8-5. </span>JWT authentication system architecture</h6>&#13;
</div></figure>&#13;
&#13;
<p>In the following code examples, you will see how to implement the core authentication flows starting with user registration and JWT generation.<a data-startref="ix_ch08-asciidoc6" data-type="indexterm" id="id978"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Hashing and salting" data-type="sect3"><div class="sect3" id="id118">&#13;
<h3>Hashing and salting</h3>&#13;
&#13;
<p><a data-primary="hashing" data-type="indexterm" id="ix_ch08-asciidoc9"/><a data-primary="JSON Web Tokens (JWT) authentication" data-secondary="hashing and salting" data-type="indexterm" id="ix_ch08-asciidoc10"/>The first step after creating the <code>users</code> and <code>tokens</code> tables in the database is to store new users in the database upon registration.&#13;
However, you should avoid storing passwords in plain form, because if the database is compromised, the attackers will have every user’s credential.</p>&#13;
&#13;
<p>Instead, the authentication mechanism will leverage a <em>hashing algorithm</em> that converts plain passwords into an encoded string that can’t be decoded back into its original form.&#13;
Since the decoding process isn’t reversible, cryptographic hashing algorithms differ from standard encoding/decoding functions such as Base64.</p>&#13;
&#13;
<p class="less_space pagebreak-before">While storing hashed passwords is more secure than storing plain passwords, it doesn’t provide enough protection.&#13;
<a data-primary="rainbow tables" data-type="indexterm" id="id979"/>If such a database of hashed passwords falls into the hands of attackers, they can use a precomputed hash tables—​commonly referred to as <em>rainbow tables</em>.&#13;
Attackers can use rainbow tables to brute-force their way into your system by recovering plaintext passwords.&#13;
<a data-primary="salting" data-type="indexterm" id="ix_ch08-asciidoc11"/>To protect against these brute-force attacks, you also need to introduce an element of randomness to your hashing process using a technique termed <em>salting</em>.</p>&#13;
&#13;
<p>With salts, the cryptographic hashing algorithm produces different hashed passwords, even though the users may register with common, compromised, or duplicate passwords.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>Password hashing with a random salt protects against brute-force attacks using rainbow tables.&#13;
<a data-primary="credential stuffing" data-type="indexterm" id="id980"/><a data-primary="password spraying" data-type="indexterm" id="id981"/>However, it doesn’t protect against <em>password spraying</em>, where attackers use a database of common passwords, or <em>credential stuffing</em>, where attackers enumerate on a list of compromised passwords.</p>&#13;
</div>&#13;
&#13;
<p>During salting, the hashing function generates a random salt that appends to the plain password prior to hashing and then generates a hashed password.<sup><a data-type="noteref" href="ch08.html#id982" id="id982-marker">4</a></sup>&#13;
Before storing the hashed password in the database, the salt is prefixed to the hashed password for later retrieval during verification.</p>&#13;
&#13;
<p>When registered users try to log in, they have to supply the same password they used to create their account.&#13;
During the password verification process, the password that the user provides is hashed using the same salt that was used during registration which is retrieved from the database.&#13;
If the generated hashed password is exactly identical to the hashed password in the database, then the user is authenticated.&#13;
Otherwise, you can safely assume that wrong credentials have been supplied.</p>&#13;
&#13;
<p>The salting and hashing are powerful techniques that prevent attackers from brute-forcing their way into your system with rainbow tables.&#13;
You can see the full hashing and salting process in <a data-type="xref" href="#password_hashing">Figure 8-6</a>.</p>&#13;
&#13;
<figure><div class="figure" id="password_hashing">&#13;
<img alt="bgai 0806" src="assets/bgai_0806.png"/>&#13;
<h6><span class="label">Figure 8-6. </span>Password hash salting mechanism</h6>&#13;
</div></figure>&#13;
&#13;
<p>The password service shown in <a data-type="xref" href="#password_hashing">Figure 8-6</a> is implemented as <code>PasswordService</code> in <a data-type="xref" href="#password_service">Example 8-6</a>.</p>&#13;
<div data-type="example" id="password_service">&#13;
<h5><span class="label">Example 8-6. </span>Implement a password service</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># services/auth.py</code><code>&#13;
</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">fastapi</code><code class="nn">.</code><code class="nn">security</code><code> </code><code class="kn">import</code><code> </code><code class="n">HTTPBearer</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">passlib</code><code class="nn">.</code><code class="nn">context</code><code> </code><code class="kn">import</code><code> </code><code class="n">CryptContext</code><code>&#13;
</code><code>&#13;
</code><code class="k">class</code><code> </code><code class="nc">PasswordService</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="n">security</code><code> </code><code class="o">=</code><code> </code><code class="n">HTTPBearer</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="n">pwd_context</code><code> </code><code class="o">=</code><code> </code><code class="n">CryptContext</code><code class="p">(</code><code class="n">schemes</code><code class="o">=</code><code class="p">[</code><code class="s2">"</code><code class="s2">bcrypt</code><code class="s2">"</code><code class="p">]</code><code class="p">)</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO4-1" id="co_authentication_and_authorization_CO4-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">verify_password</code><code class="p">(</code><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">password</code><code class="p">:</code><code> </code><code class="nb">str</code><code class="p">,</code><code> </code><code class="n">hashed_password</code><code class="p">:</code><code> </code><code class="nb">str</code><code>&#13;
</code><code>    </code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="nb">bool</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">pwd_context</code><code class="o">.</code><code class="n">verify</code><code class="p">(</code><code class="n">password</code><code class="p">,</code><code> </code><code class="n">hashed_password</code><code class="p">)</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO4-2" id="co_authentication_and_authorization_CO4-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">get_password_hash</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">password</code><code class="p">:</code><code> </code><code class="nb">str</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="nb">str</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">pwd_context</code><code class="o">.</code><code class="n">hash</code><code class="p">(</code><code class="n">password</code><code class="p">)</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO4-2" id="co_authentication_and_authorization_CO4-3"><img alt="2" src="assets/2.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO4-1" id="callout_authentication_and_authorization_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Create an <code>AuthService</code> with a secret and password context managed by the <code>bcrypt</code> library that will handle all the user password hashing and verification.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO4-2" id="callout_authentication_and_authorization_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Use <code>bcrypt</code>’s cryptography algorithm and application secret to hash and verify passwords.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>The <code>bcrypt</code> cryptographic library provides the core functionality of the <code>Password​Ser⁠vice</code> for hashing and verifying passwords.&#13;
Using this service, requests can now be authenticated.</p>&#13;
&#13;
<p>If a request can’t be authenticated, you will also need to raise authorization-related exceptions, as shown in <a data-type="xref" href="#auth_exceptions">Example 8-7</a>.</p>&#13;
<div data-type="example" id="auth_exceptions">&#13;
<h5><span class="label">Example 8-7. </span>Create authentication exceptions</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># exceptions.py</code>&#13;
&#13;
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">HTTPException</code><code class="p">,</code> <code class="n">status</code>&#13;
&#13;
<code class="n">UnauthorizedException</code> <code class="o">=</code> <code class="n">HTTPException</code><code class="p">(</code>&#13;
    <code class="n">status_code</code><code class="o">=</code><code class="n">status</code><code class="o">.</code><code class="n">HTTP_401_UNAUTHORIZED</code><code class="p">,</code>&#13;
    <code class="n">detail</code><code class="o">=</code><code class="s2">"Not authenticated"</code><code class="p">,</code>&#13;
    <code class="n">headers</code><code class="o">=</code><code class="p">{</code><code class="s2">"WWW-Authenticate"</code><code class="p">:</code> <code class="s2">"Bearer"</code><code class="p">},</code>&#13;
<code class="p">)</code>&#13;
&#13;
<code class="n">AlreadyRegisteredException</code> <code class="o">=</code> <code class="n">HTTPException</code><code class="p">(</code>&#13;
    <code class="n">status_code</code><code class="o">=</code><code class="n">status</code><code class="o">.</code><code class="n">HTTP_400_BAD_REQUEST</code><code class="p">,</code>&#13;
    <code class="n">detail</code><code class="o">=</code><code class="s2">"Username already registered"</code><code class="p">,</code>&#13;
<code class="p">)</code></pre></div>&#13;
&#13;
<p>The two most common authorization HTTP exceptions you will raise are related to unauthorized access or bad requests due to using already used usernames.</p>&#13;
&#13;
<p>Once you have checked a user’s identity via their credentials, you will need to issue them an <em>access token</em>.&#13;
These tokens should be short-lived to reduce the time-window that an attacker can use the token to access resources if the token is stolen.</p>&#13;
&#13;
<p>To reduce the size footprints of the tokens and protect against <em>token forgery</em>, the token service will sign (using a secret) and encode the token payloads with an encoding such as Base64.&#13;
The payload will normally contain the user’s details such as their ID, role, issuance system, and expiry dates.</p>&#13;
&#13;
<p>The token service can also decode the payload of received tokens and check their validity during the authentication process.</p>&#13;
&#13;
<p>Finally, the token service will also require database access to store and retrieve tokens to perform its functions.&#13;
Therefore, it should inherit a <code>TokenRepository</code>, as shown in <a data-type="xref" href="#token_repository">Example 8-8</a>.</p>&#13;
<div data-type="example" id="token_repository">&#13;
<h5><span class="label">Example 8-8. </span>Implementing token repository</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># repositories.py</code>&#13;
&#13;
<code class="kn">from</code> <code class="nn">entities</code> <code class="kn">import</code> <code class="n">Token</code>&#13;
<code class="kn">from</code> <code class="nn">repositories.interfaces</code> <code class="kn">import</code> <code class="n">Repository</code>&#13;
<code class="kn">from</code> <code class="nn">schemas</code> <code class="kn">import</code> <code class="n">TokenCreate</code><code class="p">,</code> <code class="n">TokenUpdate</code>&#13;
<code class="kn">from</code> <code class="nn">sqlalchemy</code> <code class="kn">import</code> <code class="n">select</code>&#13;
<code class="kn">from</code> <code class="nn">sqlalchemy.ext.asyncio</code> <code class="kn">import</code> <code class="n">AsyncSession</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">TokenRepository</code><code class="p">(</code><code class="n">Repository</code><code class="p">):</code>&#13;
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">session</code><code class="p">:</code> <code class="n">AsyncSession</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="kc">None</code><code class="p">:</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">session</code> <code class="o">=</code> <code class="n">session</code>&#13;
&#13;
    <code class="k">async</code> <code class="k">def</code> <code class="nf">list</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">skip</code><code class="p">:</code> <code class="nb">int</code><code class="p">,</code> <code class="n">take</code><code class="p">:</code> <code class="nb">int</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">Token</code><code class="p">]:</code>&#13;
        <code class="k">async</code> <code class="k">with</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">begin</code><code class="p">():</code>&#13;
            <code class="n">result</code> <code class="o">=</code> <code class="k">await</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code>&#13;
                <code class="n">select</code><code class="p">(</code><code class="n">Token</code><code class="p">)</code><code class="o">.</code><code class="n">offset</code><code class="p">(</code><code class="n">skip</code><code class="p">)</code><code class="o">.</code><code class="n">limit</code><code class="p">(</code><code class="n">take</code><code class="p">)</code>&#13;
            <code class="p">)</code>&#13;
        <code class="k">return</code> <code class="p">[</code><code class="n">r</code> <code class="k">for</code> <code class="n">r</code> <code class="ow">in</code> <code class="n">result</code><code class="o">.</code><code class="n">scalars</code><code class="p">()</code><code class="o">.</code><code class="n">all</code><code class="p">()]</code>&#13;
&#13;
    <code class="k">async</code> <code class="k">def</code> <code class="nf">get</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">token_id</code><code class="p">:</code> <code class="nb">int</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Token</code> <code class="o">|</code> <code class="kc">None</code><code class="p">:</code>&#13;
        <code class="k">async</code> <code class="k">with</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">begin</code><code class="p">():</code>&#13;
            <code class="n">result</code> <code class="o">=</code> <code class="k">await</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code>&#13;
                <code class="n">select</code><code class="p">(</code><code class="n">Token</code><code class="p">)</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">Token</code><code class="o">.</code><code class="n">id</code> <code class="o">==</code> <code class="n">token_id</code><code class="p">)</code>&#13;
            <code class="p">)</code>&#13;
        <code class="k">return</code> <code class="n">result</code><code class="o">.</code><code class="n">scalars</code><code class="p">()</code><code class="o">.</code><code class="n">first</code><code class="p">()</code>&#13;
&#13;
    <code class="k">async</code> <code class="k">def</code> <code class="nf">create</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">token</code><code class="p">:</code> <code class="n">TokenCreate</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Token</code><code class="p">:</code>&#13;
        <code class="n">new_token</code> <code class="o">=</code> <code class="n">Token</code><code class="p">(</code><code class="o">**</code><code class="n">token</code><code class="o">.</code><code class="n">dict</code><code class="p">())</code>&#13;
        <code class="k">async</code> <code class="k">with</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">begin</code><code class="p">():</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">new_token</code><code class="p">)</code>&#13;
            <code class="k">await</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">commit</code><code class="p">()</code>&#13;
            <code class="k">await</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">refresh</code><code class="p">(</code><code class="n">new_token</code><code class="p">)</code>&#13;
        <code class="k">return</code> <code class="n">new_token</code>&#13;
&#13;
    <code class="k">async</code> <code class="k">def</code> <code class="nf">update</code><code class="p">(</code>&#13;
        <code class="bp">self</code><code class="p">,</code> <code class="n">token_id</code><code class="p">:</code> <code class="nb">int</code><code class="p">,</code> <code class="n">updated_token</code><code class="p">:</code> <code class="n">TokenUpdate</code>&#13;
    <code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Token</code> <code class="o">|</code> <code class="kc">None</code><code class="p">:</code>&#13;
        <code class="n">token</code> <code class="o">=</code> <code class="k">await</code> <code class="bp">self</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">token_id</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="ow">not</code> <code class="n">token</code><code class="p">:</code>&#13;
            <code class="k">return</code> <code class="kc">None</code>&#13;
        <code class="k">for</code> <code class="n">key</code><code class="p">,</code> <code class="n">value</code> <code class="ow">in</code> <code class="n">updated_token</code><code class="o">.</code><code class="n">dict</code><code class="p">(</code><code class="n">exclude_unset</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code><code class="o">.</code><code class="n">items</code><code class="p">():</code>&#13;
            <code class="nb">setattr</code><code class="p">(</code><code class="n">token</code><code class="p">,</code> <code class="n">key</code><code class="p">,</code> <code class="n">value</code><code class="p">)</code>&#13;
        <code class="k">async</code> <code class="k">with</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">begin</code><code class="p">():</code>&#13;
            <code class="k">await</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">commit</code><code class="p">()</code>&#13;
            <code class="k">await</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">refresh</code><code class="p">(</code><code class="n">token</code><code class="p">)</code>&#13;
        <code class="k">return</code> <code class="n">token</code>&#13;
&#13;
    <code class="k">async</code> <code class="k">def</code> <code class="nf">delete</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">token_id</code><code class="p">:</code> <code class="nb">int</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="kc">None</code><code class="p">:</code>&#13;
        <code class="n">token</code> <code class="o">=</code> <code class="k">await</code> <code class="bp">self</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">token_id</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="ow">not</code> <code class="n">token</code><code class="p">:</code>&#13;
            <code class="k">return</code>&#13;
        <code class="k">async</code> <code class="k">with</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">begin</code><code class="p">():</code>&#13;
            <code class="k">await</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="n">token</code><code class="p">)</code>&#13;
            <code class="k">await</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">commit</code><code class="p">()</code></pre></div>&#13;
&#13;
<p>With the <code>TokenRepository</code> implemented, you can now develop the <code>TokenService</code>, as shown in <a data-type="xref" href="#token_service">Example 8-9</a>.</p>&#13;
<div data-type="example" id="token_service">&#13;
<h5><span class="label">Example 8-9. </span>Implement a token service by inheriting the token repository</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># services/auth.py</code><code>&#13;
</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">datetime</code><code> </code><code class="kn">import</code><code> </code><code class="n">UTC</code><code class="p">,</code><code> </code><code class="n">datetime</code><code class="p">,</code><code> </code><code class="n">timedelta</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">exceptions</code><code> </code><code class="kn">import</code><code> </code><code class="n">UnauthorizedException</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">jose</code><code> </code><code class="kn">import</code><code> </code><code class="n">JWTError</code><code class="p">,</code><code> </code><code class="n">jwt</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">pydantic</code><code> </code><code class="kn">import</code><code> </code><code class="n">UUID4</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">repositories</code><code> </code><code class="kn">import</code><code> </code><code class="n">TokenRepository</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">schemas</code><code> </code><code class="kn">import</code><code> </code><code class="n">TokenCreate</code><code class="p">,</code><code> </code><code class="n">TokenUpdate</code><code>&#13;
</code><code>&#13;
</code><code class="k">class</code><code> </code><code class="nc">TokenService</code><code class="p">(</code><code class="n">TokenRepository</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="n">secret_key</code><code> </code><code class="o">=</code><code> </code><code class="s2">"</code><code class="s2">your_secret_key</code><code class="s2">"</code><code>&#13;
</code><code>    </code><code class="n">algorithm</code><code> </code><code class="o">=</code><code> </code><code class="s2">"</code><code class="s2">HS256</code><code class="s2">"</code><code>&#13;
</code><code>    </code><code class="n">expires_in_minutes</code><code> </code><code class="o">=</code><code> </code><code class="mi">60</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO5-1" id="co_authentication_and_authorization_CO5-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">create_access_token</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">:</code><code> </code><code class="nb">dict</code><code class="p">,</code><code> </code><code class="n">expires_delta</code><code class="p">:</code><code> </code><code class="n">timedelta</code><code> </code><code class="o">|</code><code> </code><code class="kc">None</code><code> </code><code class="o">=</code><code> </code><code class="kc">None</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO5-2" id="co_authentication_and_authorization_CO5-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="nb">str</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="n">to_encode</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">copy</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="k">if</code><code> </code><code class="n">expires_delta</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="n">expire</code><code> </code><code class="o">=</code><code> </code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">)</code><code> </code><code class="o">+</code><code> </code><code class="n">expires_delta</code><code>&#13;
</code><code>    </code><code class="k">else</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="n">expire</code><code> </code><code class="o">=</code><code> </code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">)</code><code> </code><code class="o">+</code><code> </code><code class="n">timedelta</code><code class="p">(</code><code class="n">minutes</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">expires_in_minutes</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="n">token_id</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">TokenCreate</code><code class="p">(</code><code class="n">expires_at</code><code class="o">=</code><code class="n">expire</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO5-3" id="co_authentication_and_authorization_CO5-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>    </code><code class="n">to_encode</code><code class="o">.</code><code class="n">update</code><code class="p">(</code><code>&#13;
</code><code>        </code><code class="p">{</code><code class="s2">"</code><code class="s2">exp</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="n">expire</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">iss</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="s2">"</code><code class="s2">your_service_name</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">sub</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="n">token_id</code><code class="p">}</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO5-4" id="co_authentication_and_authorization_CO5-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>    </code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="n">encoded_jwt</code><code> </code><code class="o">=</code><code> </code><code class="n">jwt</code><code class="o">.</code><code class="n">encode</code><code class="p">(</code><code>&#13;
</code><code>        </code><code class="n">to_encode</code><code class="p">,</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">secret_key</code><code class="p">,</code><code> </code><code class="n">algorithm</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">algorithm</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO5-5" id="co_authentication_and_authorization_CO5-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>    </code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="n">encoded_jwt</code><code>&#13;
</code><code>&#13;
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">deactivate</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">token_id</code><code class="p">:</code><code> </code><code class="n">UUID4</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="kc">None</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="k">await</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">update</code><code class="p">(</code><code class="n">TokenUpdate</code><code class="p">(</code><code class="nb">id</code><code class="o">=</code><code class="n">token_id</code><code class="p">,</code><code> </code><code class="n">is_active</code><code class="o">=</code><code class="kc">False</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="k">def</code><code> </code><code class="nf">decode</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">encoded_token</code><code class="p">:</code><code> </code><code class="nb">str</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="nb">dict</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="k">try</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="n">jwt</code><code class="o">.</code><code class="n">decode</code><code class="p">(</code><code>&#13;
</code><code>            </code><code class="n">encoded_token</code><code class="p">,</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">secret_key</code><code class="p">,</code><code> </code><code class="n">algorithms</code><code class="o">=</code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">algorithm</code><code class="p">]</code><code>&#13;
</code><code>        </code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="k">except</code><code> </code><code class="n">JWTError</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="k">raise</code><code> </code><code class="n">UnauthorizedException</code><code>&#13;
</code><code>&#13;
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">validate</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">token_id</code><code class="p">:</code><code> </code><code class="n">UUID4</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="nb">bool</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="p">(</code><code class="n">token</code><code> </code><code class="o">:=</code><code> </code><code class="k">await</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">token_id</code><code class="p">)</code><code class="p">)</code><code> </code><code class="ow">is</code><code> </code><code class="ow">not</code><code> </code><code class="kc">None</code><code> </code><code class="ow">and</code><code> </code><code class="n">token</code><code class="o">.</code><code class="n">is_active</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO5-1" id="callout_authentication_and_authorization_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Implement a <code>TokenService</code> for issuing and checking authentication tokens.&#13;
Configurations are shared across all instances of the service.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO5-2" id="callout_authentication_and_authorization_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Generate access tokens based on data provided to the token service with expiry dates.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO5-3" id="callout_authentication_and_authorization_CO5-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Create a token record in the database and get a unique identifier.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO5-4" id="callout_authentication_and_authorization_CO5-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The access token must expire within an hour, so the <code>exp</code> calculated field will be used to check token validity.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO5-5" id="callout_authentication_and_authorization_CO5-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Encode the generated token into an encoded string using the <code>base64</code> algorithm.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Now that you have a <code>PasswordService</code> and a <code>TokenService</code>, you can complete the core JWT authentication mechanism with a dedicated higher-level <code>AuthService</code>.</p>&#13;
&#13;
<p><a data-type="xref" href="#auth_service">Example 8-10</a> shows the implementation of the <code>AuthService</code> class that contains several dependency functions for registering users, issuing access tokens, and protecting your API routes.</p>&#13;
<div data-type="example" id="auth_service">&#13;
<h5><span class="label">Example 8-10. </span>Implement an auth service to handle higher-level authentication logic</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># services/auth.py</code><code>&#13;
</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">typing</code><code> </code><code class="kn">import</code><code> </code><code class="n">Annotated</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">databases</code><code> </code><code class="kn">import</code><code> </code><code class="n">DBSessionDep</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">entities</code><code> </code><code class="kn">import</code><code> </code><code class="n">Token</code><code class="p">,</code><code> </code><code class="n">User</code><code class="p">,</code><code> </code><code class="n">UserCreate</code><code class="p">,</code><code> </code><code class="n">UserInDB</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">exceptions</code><code> </code><code class="kn">import</code><code> </code><code class="n">AlreadyRegisteredException</code><code class="p">,</code><code> </code><code class="n">UnauthorizedException</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">fastapi</code><code> </code><code class="kn">import</code><code> </code><code class="n">Depends</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">fastapi</code><code class="nn">.</code><code class="nn">security</code><code> </code><code class="kn">import</code><code> </code><code class="p">(</code><code class="n">HTTPAuthorizationCredentials</code><code class="p">,</code><code> </code><code class="n">HTTPBearer</code><code class="p">,</code><code>&#13;
</code><code>                              </code><code class="n">OAuth2PasswordRequestForm</code><code class="p">)</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">services</code><code class="nn">.</code><code class="nn">auth</code><code> </code><code class="kn">import</code><code> </code><code class="n">PasswordService</code><code class="p">,</code><code> </code><code class="n">TokenService</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">services</code><code class="nn">.</code><code class="nn">users</code><code> </code><code class="kn">import</code><code> </code><code class="n">UserService</code><code>&#13;
</code><code>&#13;
</code><code class="n">security</code><code> </code><code class="o">=</code><code> </code><code class="n">HTTPBearer</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code class="n">LoginFormDep</code><code> </code><code class="o">=</code><code> </code><code class="n">Annotated</code><code class="p">[</code><code class="n">OAuth2PasswordRequestForm</code><code class="p">,</code><code> </code><code class="n">Depends</code><code class="p">(</code><code class="p">)</code><code class="p">]</code><code>&#13;
</code><code class="n">AuthHeaderDep</code><code> </code><code class="o">=</code><code> </code><code class="n">Annotated</code><code class="p">[</code><code class="n">HTTPAuthorizationCredentials</code><code class="p">,</code><code> </code><code class="n">Depends</code><code class="p">(</code><code class="n">security</code><code class="p">)</code><code class="p">]</code><code>&#13;
</code><code>&#13;
</code><code class="k">class</code><code> </code><code class="nc">AuthService</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="k">def</code><code> </code><code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">session</code><code class="p">:</code><code> </code><code class="n">DBSessionDep</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">password_service</code><code> </code><code class="o">=</code><code> </code><code class="n">PasswordService</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">token_service</code><code> </code><code class="o">=</code><code> </code><code class="n">TokenService</code><code class="p">(</code><code class="n">session</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">user_service</code><code> </code><code class="o">=</code><code> </code><code class="n">UserService</code><code class="p">(</code><code class="n">session</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">register_user</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">user</code><code class="p">:</code><code> </code><code class="n">UserCreate</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">User</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="k">await</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">user_service</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">user</code><code class="o">.</code><code class="n">username</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="k">raise</code><code> </code><code class="n">AlreadyRegisteredException</code><code>&#13;
</code><code>        </code><code class="n">hashed_password</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">password_service</code><code class="o">.</code><code class="n">get_password_hash</code><code class="p">(</code><code>&#13;
</code><code>            </code><code class="n">user</code><code class="o">.</code><code class="n">password</code><code>&#13;
</code><code>        </code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="k">await</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">user_service</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code>&#13;
</code><code>            </code><code class="n">UserInDB</code><code class="p">(</code><code class="n">username</code><code class="o">=</code><code class="n">user</code><code class="o">.</code><code class="n">username</code><code class="p">,</code><code> </code><code class="n">hashed_password</code><code class="o">=</code><code class="n">hashed_password</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">authenticate_user</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">form_data</code><code class="p">:</code><code> </code><code class="n">LoginFormDep</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">Token</code><code class="p">:</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO6-1" id="co_authentication_and_authorization_CO6-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="ow">not</code><code> </code><code class="p">(</code><code class="n">user</code><code> </code><code class="o">:=</code><code> </code><code class="k">await</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">user_service</code><code class="o">.</code><code class="n">get_user</code><code class="p">(</code><code class="n">form_data</code><code class="o">.</code><code class="n">username</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="k">raise</code><code> </code><code class="n">UnauthorizedException</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="ow">not</code><code> </code><code class="k">await</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">password_service</code><code class="o">.</code><code class="n">verify_password</code><code class="p">(</code><code>&#13;
</code><code>            </code><code class="n">form_data</code><code class="o">.</code><code class="n">password</code><code class="p">,</code><code> </code><code class="n">user</code><code class="o">.</code><code class="n">hashed_password</code><code>&#13;
</code><code>        </code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="k">raise</code><code> </code><code class="n">UnauthorizedException</code><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="k">await</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">token_service</code><code class="o">.</code><code class="n">create_access_token</code><code class="p">(</code><code class="n">user</code><code class="o">.</code><code class="n">_asdict</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">get_current_user</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">credentials</code><code class="p">:</code><code> </code><code class="n">AuthHeaderDep</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">User</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="n">credentials</code><code class="o">.</code><code class="n">scheme</code><code> </code><code class="o">!=</code><code> </code><code class="s2">"</code><code class="s2">Bearer</code><code class="s2">"</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="k">raise</code><code> </code><code class="n">UnauthorizedException</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="ow">not</code><code> </code><code class="p">(</code><code class="n">token</code><code> </code><code class="o">:=</code><code> </code><code class="n">credentials</code><code class="o">.</code><code class="n">credentials</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="k">raise</code><code> </code><code class="n">UnauthorizedException</code><code>&#13;
</code><code>        </code><code class="n">payload</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">token_service</code><code class="o">.</code><code class="n">decode</code><code class="p">(</code><code class="n">token</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="ow">not</code><code> </code><code class="k">await</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">token_service</code><code class="o">.</code><code class="n">validate</code><code class="p">(</code><code class="n">payload</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">sub</code><code class="s2">"</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="k">raise</code><code> </code><code class="n">UnauthorizedException</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="ow">not</code><code> </code><code class="p">(</code><code class="n">username</code><code> </code><code class="o">:=</code><code> </code><code class="n">payload</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">username</code><code class="s2">"</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="k">raise</code><code> </code><code class="n">UnauthorizedException</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="ow">not</code><code> </code><code class="p">(</code><code class="n">user</code><code> </code><code class="o">:=</code><code> </code><code class="k">await</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">user_service</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">username</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="k">raise</code><code> </code><code class="n">UnauthorizedException</code><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="n">user</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">logout</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">credentials</code><code class="p">:</code><code> </code><code class="n">AuthHeaderDep</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="kc">None</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="n">payload</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">token_service</code><code class="o">.</code><code class="n">decode</code><code class="p">(</code><code class="n">credentials</code><code class="o">.</code><code class="n">credentials</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="k">await</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">token_service</code><code class="o">.</code><code class="n">deactivate</code><code class="p">(</code><code class="n">payload</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">sub</code><code class="s2">"</code><code class="p">)</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="c1"># Add Password Reset Method</code><code>&#13;
</code><code>    </code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">reset_password</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code> </code><code class="o">.</code><code class="o">.</code><code class="o">.</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO6-1" id="callout_authentication_and_authorization_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The core authentication logic of the application that verifies whether a user exists and their password credentials.&#13;
Returns <code>False</code> if any checks fail.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>You can now use the <code>AuthService</code> to register and authenticate users using their credentials.&#13;
Refer to <a data-type="xref" href="#auth_controllers">Example 8-11</a> to see how the <code>AuthService</code> is used to create the required dependencies for a dedicated authentication router.</p>&#13;
<div data-type="example" id="auth_controllers">&#13;
<h5><span class="label">Example 8-11. </span>Implement authentication controllers to enable login and registration functionality</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># routes/auth.py</code><code>&#13;
</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">typing</code><code> </code><code class="kn">import</code><code> </code><code class="n">Annotated</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">entities</code><code> </code><code class="kn">import</code><code> </code><code class="n">User</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">fastapi</code><code> </code><code class="kn">import</code><code> </code><code class="n">APIRouter</code><code class="p">,</code><code> </code><code class="n">Depends</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">models</code><code> </code><code class="kn">import</code><code> </code><code class="n">TokenOut</code><code class="p">,</code><code> </code><code class="n">UserOut</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">services</code><code class="nn">.</code><code class="nn">auth</code><code> </code><code class="kn">import</code><code> </code><code class="n">AuthService</code><code>&#13;
</code><code>&#13;
</code><code class="n">auth_service</code><code> </code><code class="o">=</code><code> </code><code class="n">AuthService</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code class="n">RegisterUserDep</code><code> </code><code class="o">=</code><code> </code><code class="n">Annotated</code><code class="p">[</code><code class="n">User</code><code class="p">,</code><code> </code><code class="n">Depends</code><code class="p">(</code><code class="n">auth_service</code><code class="o">.</code><code class="n">register_user</code><code class="p">)</code><code class="p">]</code><code>&#13;
</code><code class="n">AuthenticateUserCredDep</code><code> </code><code class="o">=</code><code> </code><code class="n">Annotated</code><code class="p">[</code><code>&#13;
</code><code>    </code><code class="nb">str</code><code class="p">,</code><code> </code><code class="n">Depends</code><code class="p">(</code><code class="n">auth_service</code><code class="o">.</code><code class="n">authenticate_user_with_credentials</code><code class="p">)</code><code>&#13;
</code><code class="p">]</code><code>&#13;
</code><code class="n">AuthenticateUserTokenDep</code><code> </code><code class="o">=</code><code> </code><code class="n">Annotated</code><code class="p">[</code><code class="n">User</code><code class="p">,</code><code> </code><code class="n">Depends</code><code class="p">(</code><code class="n">auth_service</code><code class="o">.</code><code class="n">register_user</code><code class="p">)</code><code class="p">]</code><code>&#13;
</code><code class="n">PasswordResetDep</code><code> </code><code class="o">=</code><code> </code><code class="n">Annotated</code><code class="p">[</code><code class="kc">None</code><code class="p">,</code><code> </code><code class="n">Depends</code><code class="p">(</code><code class="n">auth_service</code><code class="o">.</code><code class="n">reset_password</code><code class="p">)</code><code class="p">]</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO7-1" id="co_authentication_and_authorization_CO7-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">router</code><code> </code><code class="o">=</code><code> </code><code class="n">APIRouter</code><code class="p">(</code><code class="n">prefix</code><code class="o">=</code><code class="s2">"</code><code class="s2">/auth</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">tags</code><code class="o">=</code><code class="p">[</code><code class="s2">"</code><code class="s2">Authentication</code><code class="s2">"</code><code class="p">]</code><code class="p">)</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO7-2" id="co_authentication_and_authorization_CO7-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="nd">@router</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"</code><code class="s2">/register</code><code class="s2">"</code><code class="p">)</code><code>&#13;
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">register_user_controller</code><code class="p">(</code><code class="n">new_user</code><code class="p">:</code><code> </code><code class="n">RegisterUserDep</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">UserOut</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="n">new_user</code><code>&#13;
</code><code>&#13;
</code><code class="nd">@router</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"</code><code class="s2">/token</code><code class="s2">"</code><code class="p">)</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO7-3" id="co_authentication_and_authorization_CO7-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">login_for_access_token_controller</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="n">access_token</code><code class="p">:</code><code> </code><code class="n">AuthenticateUserCredDep</code><code class="p">,</code><code>&#13;
</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">TokenOut</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="p">{</code><code class="s2">"</code><code class="s2">access_token</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="n">access_token</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">token_type</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="s2">"</code><code class="s2">bearer</code><code class="s2">"</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="nd">@router</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"</code><code class="s2">/logout</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">dependencies</code><code class="o">=</code><code class="p">[</code><code class="n">Depends</code><code class="p">(</code><code class="n">auth_service</code><code class="o">.</code><code class="n">logout</code><code class="p">)</code><code class="p">]</code><code class="p">)</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO7-3" id="co_authentication_and_authorization_CO7-4"><img alt="3" src="assets/3.png"/></a><code> </code><a class="co" href="#callout_authentication_and_authorization_CO7-4" id="co_authentication_and_authorization_CO7-5"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">logout_access_token_controller</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="nb">dict</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="p">{</code><code class="s2">"</code><code class="s2">message</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="s2">"</code><code class="s2">Logged out</code><code class="s2">"</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="nd">@router</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"</code><code class="s2">reset-password</code><code class="s2">"</code><code class="p">)</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO7-3" id="co_authentication_and_authorization_CO7-6"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">reset_password_controller</code><code class="p">(</code><code class="n">credentials</code><code class="p">:</code><code> </code><code class="nb">str</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="nb">dict</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="p">{</code><code>&#13;
</code><code>        </code><code class="s2">"</code><code class="s2">message</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="s2">"</code><code class="s2">If an account exists, </code><code class="s2">"</code><code>&#13;
</code><code>        </code><code class="s2">"</code><code class="s2">a password reset link will be sent to the provided email</code><code class="s2">"</code><code>&#13;
</code><code>    </code><code class="p">}</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO7-1" id="callout_authentication_and_authorization_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Create an instance of the <code>AuthService</code> and declare reusable annotated &#13;
<span class="keep-together">dependencies.</span></p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO7-2" id="callout_authentication_and_authorization_CO7-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Create a separate API router for authentication endpoints.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO7-3" id="callout_authentication_and_authorization_CO7-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Implement endpoints for registering users, user login (token issuance), user logout (token revocation), and password reset.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO7-5" id="callout_authentication_and_authorization_CO7-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Since the <code>LogoutUserDep</code> dependency won’t return anything, inject it within the dependency array of the router.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Once you have a dedicated authentication router, create a separate resource router to group all your resource endpoints within.&#13;
With both routers, you can now add them to your FastAPI app, as shown in <a data-type="xref" href="#routers">Example 8-12</a>, to complete the JWT authentication work.</p>&#13;
<div data-type="example" id="routers">&#13;
<h5><span class="label">Example 8-12. </span>Refactor FastAPI application to use routers</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># routes/resource.py</code><code>&#13;
</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">fastapi</code><code> </code><code class="kn">import</code><code> </code><code class="n">APIRouter</code><code>&#13;
</code><code>&#13;
</code><code class="n">router</code><code> </code><code class="o">=</code><code> </code><code class="n">APIRouter</code><code class="p">(</code><code class="n">prefix</code><code class="o">=</code><code class="s2">"</code><code class="s2">/generate</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">tags</code><code class="o">=</code><code class="p">[</code><code class="s2">"</code><code class="s2">Resource</code><code class="s2">"</code><code class="p">]</code><code class="p">)</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO8-1" id="co_authentication_and_authorization_CO8-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">/generate/text</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">)</code><code>&#13;
</code><code class="k">def</code><code> </code><code class="nf">serve_language_model_controller</code><code class="p">(</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>&#13;
</code><code>&#13;
</code><code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">/generate/audio</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">)</code><code>&#13;
</code><code class="k">def</code><code> </code><code class="nf">serve_text_to_audio_model_controller</code><code class="p">(</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>&#13;
</code><code>&#13;
</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code> </code><code class="c1"># Add other controllers to the resource router here</code><code>&#13;
</code><code>&#13;
</code><code class="c1"># main.py</code><code>&#13;
</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">typing</code><code> </code><code class="kn">import</code><code> </code><code class="n">Annotated</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="nn">routes</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">entities</code><code> </code><code class="kn">import</code><code> </code><code class="n">User</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">fastapi</code><code> </code><code class="kn">import</code><code> </code><code class="n">Depends</code><code class="p">,</code><code> </code><code class="n">FastAPI</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">services</code><code class="nn">.</code><code class="nn">auth</code><code> </code><code class="kn">import</code><code> </code><code class="n">AuthService</code><code>&#13;
</code><code>&#13;
</code><code class="n">auth_service</code><code> </code><code class="o">=</code><code> </code><code class="n">AuthService</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code class="n">AuthenticateUserDep</code><code> </code><code class="o">=</code><code> </code><code class="n">Annotated</code><code class="p">[</code><code class="n">User</code><code class="p">,</code><code> </code><code class="n">Depends</code><code class="p">(</code><code class="n">auth_service</code><code class="o">.</code><code class="n">get_current_user</code><code class="p">)</code><code class="p">]</code><code>&#13;
</code><code>&#13;
</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>&#13;
</code><code>&#13;
</code><code class="n">app</code><code> </code><code class="o">=</code><code> </code><code class="n">FastAPI</code><code class="p">(</code><code class="n">lifespan</code><code class="o">=</code><code class="n">lifespan</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="n">app</code><code class="o">.</code><code class="n">include_router</code><code class="p">(</code><code class="n">routes</code><code class="o">.</code><code class="n">auth</code><code class="o">.</code><code class="n">router</code><code class="p">,</code><code> </code><code class="n">prefix</code><code class="o">=</code><code class="s2">"</code><code class="s2">/auth</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">tags</code><code class="o">=</code><code class="p">[</code><code class="s2">"</code><code class="s2">Auth</code><code class="s2">"</code><code class="p">]</code><code class="p">)</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO8-2" id="co_authentication_and_authorization_CO8-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="n">app</code><code class="o">.</code><code class="n">include_router</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="n">routes</code><code class="o">.</code><code class="n">resource</code><code class="o">.</code><code class="n">router</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="n">dependencies</code><code class="o">=</code><code class="p">[</code><code class="n">AuthenticateUserDep</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="n">prefix</code><code class="o">=</code><code class="s2">"</code><code class="s2">/generate</code><code class="s2">"</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="n">tags</code><code class="o">=</code><code class="p">[</code><code class="s2">"</code><code class="s2">Generate</code><code class="s2">"</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code class="p">)</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO8-3" id="co_authentication_and_authorization_CO8-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>  </code><code class="c1"># Add other routes to the app here</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO8-1" id="callout_authentication_and_authorization_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Refactor existing endpoints to be grouped under a separate API router named the resource router.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO8-2" id="callout_authentication_and_authorization_CO8-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Add both auth and resource routers to the FastAPI <code>app</code> router.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO8-3" id="callout_authentication_and_authorization_CO8-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Protect the resource endpoints by injecting the <code>AuthenticateUserDep</code> dependency at the router level.&#13;
Requests must now include an <code>Authorization</code> header with a bearer token to be authenticated with the resource router.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Massive congratulations!&#13;
You now have a fully working GenAI service protected by JWT authentication, which can be deployed to production with some additional work.<a data-startref="ix_ch08-asciidoc11" data-type="indexterm" id="id983"/></p>&#13;
&#13;
<p>In the next section, you’ll learn a few ideas on additional enhancements you can make to the system to tighten the security of your JWT authentication system.<a data-startref="ix_ch08-asciidoc10" data-type="indexterm" id="id984"/><a data-startref="ix_ch08-asciidoc9" data-type="indexterm" id="id985"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Authentication flows" data-type="sect3"><div class="sect3" id="id119">&#13;
<h3>Authentication flows</h3>&#13;
&#13;
<p><a data-primary="JSON Web Tokens (JWT) authentication" data-secondary="authentication flows" data-type="indexterm" id="ix_ch08-asciidoc12"/>You will need to handle several authentication flows to fully implement a usable JWT authentication system.</p>&#13;
&#13;
<p>The <em>core</em> authentication flows include the following:</p>&#13;
<dl>&#13;
<dt>User registration</dt>&#13;
<dd>&#13;
<p>New users will want to register a new account by providing their emails and a secure password. Your authentication logic may check for password strength, no existing users with the same email, and that the user reconfirms the password and email. You should also avoid storing the user’s raw password in the database.</p>&#13;
</dd>&#13;
<dt>User login</dt>&#13;
<dd>&#13;
<p>On each user login, your system can generate, store, and provide a unique temporary access token (i.e., JWT) if a user supplies their correct credentials. Your protected resource server routers should reject any incoming requests that don’t contain a valid JWT. Valid JWTs can be verified through their signature and checked against the valid tokens specified in the database.</p>&#13;
</dd>&#13;
<dt>User logout</dt>&#13;
<dd>&#13;
<p>When the user logs out, your system can revoke the currently issued token and prevent future malicious login attempts with the current token.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p class="less_space pagebreak-before">In addition to the core flows, you should also consider <em>secondary</em> flows to implement a production-ready authentication system. These flows could be used for:</p>&#13;
<dl>&#13;
<dt>Verifying identity</dt>&#13;
<dd>&#13;
<p>To prevent spambots from registering active accounts in your system and consuming server resources, you will want some form of user verification mechanism in place. For instance, add email verification by integrating an emailing server to your authentication system.</p>&#13;
</dd>&#13;
<dt>Resetting passwords</dt>&#13;
<dd>&#13;
<p>Users can forget their passwords at any time. You will want to implement a flow for users to reset their passwords. If a user resets their password, all active tokens in the database against their user account must be revoked.</p>&#13;
</dd>&#13;
<dt>Forcing logout</dt>&#13;
<dd>&#13;
<p>Revoke all previously generated access tokens of a user on all clients to prevent stolen tokens from being used to access the system.</p>&#13;
</dd>&#13;
<dt>Disabling user accounts</dt>&#13;
<dd>&#13;
<p>Administrators or users may want to disable their accounts to prevent future login attempts.</p>&#13;
</dd>&#13;
<dt>Deleting user accounts</dt>&#13;
<dd>&#13;
<p>This is required if users would like to remove their accounts from your systems. Depending on your data storage requirements, you may want to delete personally identifiable information while keeping other associated data.</p>&#13;
</dd>&#13;
<dt>Blocking successive login attempts</dt>&#13;
<dd>&#13;
<p>Temporarily disable an account that has had multiple failed login attempts within a short time span.</p>&#13;
</dd>&#13;
<dt>Providing refresh tokens</dt>&#13;
<dd>&#13;
<p>Generate both short-lived <em>access</em> tokens and long-lived <em>refresh</em> tokens. Since access tokens can expire frequently to reduce the window of opportunity for attackers to use a stolen token, clients can reuse their refresh token to request new access tokens. This removes the need for frequent logins while maintaining security of the system against attackers.</p>&#13;
</dd>&#13;
<dt>Two-factor authentication (2FA) or multifactor authentication (MFA)</dt>&#13;
<dd>&#13;
<p>You can secure your system against exposed password-protected accounts by requiring 2FA or MFA as an additional protection layer. 2FA/MFA examples include SMS/email verification, one-time passwords (OTPs), or randomly generated number sequences from a paired authentication app as a second login step before an access token can be generated.</p>&#13;
</dd>&#13;
</dl>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>The aforementioned list is not exhaustive. You may want to check out <a href="https://oreil.ly/xAGfn">“OWASP Top 10 Web Applications Security Risks”</a> and <a href="https://oreil.ly/oSyuz">“OWASP Authentication Cheat Sheet”</a> for the full list of considerations when implementing your own JWT authentication from scratch.</p>&#13;
&#13;
<p>In addition to following the OWASP top 10 guidelines, you should use security mechanisms such as <em>rate limiting</em>, <em>geo/IP-tracking</em>, and <em>account lockouts</em> to defend against various attacks.</p>&#13;
&#13;
<p>You can also consider using third-party authentication providers (such as Okta/Auth0, Firebase Auth, KeyCloak, Amazon Cognito, etc.) that include these security features in their services.</p>&#13;
</div>&#13;
&#13;
<p>While credentials-based authentication using JWTs can be considered a production-ready authentication system and be further enhanced with MFA systems in place, the mechanism has its own limitations.&#13;
For instance, as previously mentioned, requiring credentials and storing hashed passwords in a database can retain security risks if attackers leverage password spraying or credential stuffing brute-force attacks.</p>&#13;
&#13;
<p>In addition, if you require access to user resources external to your system, you will need to implement additional mechanisms to verify your application’s identity to external identity providers.&#13;
<a data-primary="OAuth2 standard" data-type="indexterm" id="id986"/>Since this remains a common need in many applications and services, a protocol called OAuth has been developed to facilitate the whole &#13;
<span class="keep-together">process.</span></p>&#13;
&#13;
<p>Let’s explore how you can use OAuth authentication to add more login options for users and access external user resources.&#13;
This can enhance the performance of your GenAI services and generate higher-quality<a data-startref="ix_ch08-asciidoc12" data-type="indexterm" id="id987"/> outputs<a data-startref="ix_ch08-asciidoc4" data-type="indexterm" id="id988"/><a data-startref="ix_ch08-asciidoc3" data-type="indexterm" id="id989"/>.<a data-startref="ix_ch08-asciidoc0" data-type="indexterm" id="id990"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Implementing OAuth Authentication" data-type="sect1"><div class="sect1" id="id120">&#13;
<h1>Implementing OAuth Authentication</h1>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="methods" data-tertiary="OAuth authentication" data-type="indexterm" id="ix_ch08-asciidoc13"/><a data-primary="OAuth authentication" data-secondary="implementing" data-type="indexterm" id="ix_ch08-asciidoc14"/>We touched upon the concept of OAuth authentication via identity providers earlier in this chapter.</p>&#13;
&#13;
<p>OAuth is an open standard for access delegation, often used to grant websites or applications limited access to user information without exposing passwords.&#13;
It allows you to authenticate users using identity providers such as Google, Facebook, etc., and grants your application access to user resources like calendars, files, social feeds, etc., on external services.</p>&#13;
&#13;
<p>By using OAuth, you can simplify the implementation of authentication in your app by leveraging existing identity providers instead of creating your own authentication mechanisms such as JWT.</p>&#13;
&#13;
<p class="less_space pagebreak-before"><a data-primary="identity providers (IDPs)" data-type="indexterm" id="id991"/><em>Identity providers</em> (IDPs) are platforms that enable other applications, such as your GenAI service, to integrate with and rely on their identity and authentication systems to access resources on behalf of users via a standardized process.&#13;
The IDP authenticates users and issues security tokens that assert the user’s identity and other attributes.&#13;
GitHub, Google, Microsoft 365, Apple, Meta, and LinkedIn are only a handful of hundreds of identity providers.</p>&#13;
&#13;
<p>The protocol powering this entire flow under the hood is <em>OAuth 2.0</em>, an authorization framework giving applications limited access to another service on behalf of a user.</p>&#13;
&#13;
<p>Using this approach, your application can redirect users to identity provider platforms so that users can grant limited timed access to their accounts on those platforms.&#13;
After the user gives consent, your application can perform operations on their behalf on their resources like calendars or read their profile information including personally identifiable information such as emails or images.</p>&#13;
&#13;
<p>As a result, OAuth authentication is often used to verify the identity of users as you trust the external platform/identity provider’s authentication process.&#13;
Therefore, this approach reduces the burden of storing and securing user credentials in your system, which can be prone to brute-force attacks on weak or compromised passwords.</p>&#13;
&#13;
<p>In this section, you’re going to implement a variant of OAuth based on the <em>authorization code flow</em> that’s commonly used in modern applications.&#13;
The step-by-step process is as follows:</p>&#13;
<ol>&#13;
<li>&#13;
<p>The user clicks the login button in your application to start the authentication flow.</p>&#13;
</li>&#13;
<li>&#13;
<p>The user is redirected to the identity provider’s login page, and your application supplies a client ID and secret to the identity provider to identify itself.</p>&#13;
</li>&#13;
<li>&#13;
<p>The user logs into their account and is presented with a consent screen like the one shown in <a data-type="xref" href="#oauth2_consent_screen">Figure 8-7</a> presenting them the scopes (i.e., permissions) that your application is requesting on their behalf.</p>&#13;
&#13;
<figure><div class="figure" id="oauth2_consent_screen">&#13;
<img alt="bgai 0807" src="assets/bgai_0807.png"/>&#13;
<h6><span class="label">Figure 8-7. </span>Example consent screen</h6>&#13;
</div></figure>&#13;
</li>&#13;
<li>&#13;
<p>The user grants all, some, or none of the requested scopes.</p>&#13;
</li>&#13;
<li>&#13;
<p>If consent is not rejected by the user (i.e., the resource owner), the identity provider’s authorization server issues your application a <em>grant code</em> to an endpoint that you provide called the <em>redirect URI</em>.&#13;
If your redirect URI is not previously approved with the identity provider, the identity provider will reject to issue a grant code here.</p>&#13;
</li>&#13;
<li>&#13;
<p>After your application receives a grant code associated with the user session, permitted scopes, and your application’s client ID, it can exchange this grant code with the authorization server for a <em>short-lived access token</em> and a <em>longer-lived refresh token</em>.&#13;
You can use the refresh token to request new access tokens without having to restart the whole authentication process.</p>&#13;
</li>&#13;
<li>&#13;
<p>Your application can now use this access token to access the provider’s resource server to perform operations on behalf of the user on their resources.&#13;
As a result, you can authenticate the user via the identity provider to resources on your &#13;
<span class="keep-together">system.</span></p>&#13;
</li>&#13;
&#13;
</ol>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p><a data-primary="CSRF (cross-site request forgery) token" data-type="indexterm" id="id992"/><a data-primary="state parameter" data-type="indexterm" id="id993"/>Through the OAuth process, the authorization server may also issue a <em>state</em> parameter or <em>CSRF token</em>, which your application must supply as it communicates with the identity provider’s servers.&#13;
The purpose of the state parameter or CSRF token is to protect against cross-site request forgery (CSRF) attacks.</p>&#13;
&#13;
<p>With CSRF, attackers may steal an authenticated session to forge authenticated requests to the resource servers without the user’s knowledge.</p>&#13;
</div>&#13;
&#13;
<p><a data-type="xref" href="#oauth2">Figure 8-8</a> shows the full OAuth authentication flow.</p>&#13;
&#13;
<figure><div class="figure" id="oauth2">&#13;
<img alt="bgai 0808" src="assets/bgai_0808.png"/>&#13;
<h6><span class="label">Figure 8-8. </span>OAuth authentication flow</h6>&#13;
</div></figure>&#13;
&#13;
<p>Now that you have a high-level overview of the OAuth authentication flow, let’s implement it inside FastAPI with an identity provider such as GitHub to fully understand the underlying mechanisms.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="OAuth Authentication with GitHub" data-type="sect2"><div class="sect2" id="id121">&#13;
<h2>OAuth Authentication with GitHub</h2>&#13;
&#13;
<p><a data-primary="OAuth authentication" data-secondary="GitHub and" data-type="indexterm" id="ix_ch08-asciidoc16"/>The first step to setting up the OAuth authentication is to create a set of client ID and secret credentials within GitHub so that their systems can identify your application.</p>&#13;
&#13;
<p>You can generate a client ID and secret from GitHub by visiting the developer settings under your GitHub profile and creating an OAuth application.<sup><a data-type="noteref" href="ch08.html#id994" id="id994-marker">5</a></sup></p>&#13;
&#13;
<p>With your new application client ID and secret, you can now redirect users to the GitHub authorization server from your application by following <a data-type="xref" href="#oauth_redirect">Example 8-13</a>.</p>&#13;
<div data-type="example" id="oauth_redirect">&#13;
<h5><span class="label">Example 8-13. </span>Redirect users to the GitHub authorization server to start the OAuth process</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># routes/auth.py</code><code>&#13;
</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="nn">secrets</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">fastapi</code><code> </code><code class="kn">import</code><code> </code><code class="n">APIRouter</code><code class="p">,</code><code> </code><code class="n">Request</code><code class="p">,</code><code> </code><code class="n">status</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">fastapi</code><code class="nn">.</code><code class="nn">responses</code><code> </code><code class="kn">import</code><code> </code><code class="n">RedirectResponse</code><code>&#13;
</code><code>&#13;
</code><code class="n">client_id</code><code> </code><code class="o">=</code><code> </code><code class="s2">"</code><code class="s2">your_client_id</code><code class="s2">"</code><code>&#13;
</code><code class="n">client_secret</code><code> </code><code class="o">=</code><code> </code><code class="s2">"</code><code class="s2">your_client_secret</code><code class="s2">"</code><code>&#13;
</code><code>&#13;
</code><code class="n">router</code><code> </code><code class="o">=</code><code> </code><code class="n">APIRouter</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>&#13;
</code><code>&#13;
</code><code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">/oauth/github/login</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">status_code</code><code class="o">=</code><code class="n">status</code><code class="o">.</code><code class="n">HTTP_301_REDIRECT</code><code class="p">)</code><code>&#13;
</code><code class="k">def</code><code> </code><code class="nf">oauth_github_login_controller</code><code class="p">(</code><code class="n">request</code><code class="p">:</code><code> </code><code class="n">Request</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">RedirectResponse</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="n">state</code><code> </code><code class="o">=</code><code> </code><code class="n">secrets</code><code class="o">.</code><code class="n">token_urlsafe</code><code class="p">(</code><code class="mi">16</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="n">redirect_uri</code><code> </code><code class="o">=</code><code> </code><code class="n">request</code><code class="o">.</code><code class="n">url_for</code><code class="p">(</code><code class="s2">"</code><code class="s2">oauth_github_callback_controller</code><code class="s2">"</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="n">response</code><code> </code><code class="o">=</code><code> </code><code class="n">RedirectResponse</code><code class="p">(</code><code>&#13;
</code><code>        </code><code class="n">url</code><code class="o">=</code><code class="sa">f</code><code class="s2">"</code><code class="s2">https://github.com/login/oauth/authorize</code><code class="s2">"</code><code>&#13;
</code><code>        </code><code class="sa">f</code><code class="s2">"</code><code class="s2">?client_id=</code><code class="si">{</code><code class="n">client_id</code><code class="si">}</code><code class="s2">"</code><code>&#13;
</code><code>        </code><code class="sa">f</code><code class="s2">"</code><code class="s2">&amp;scope=user</code><code class="s2">"</code><code>&#13;
</code><code>        </code><code class="sa">f</code><code class="s2">"</code><code class="s2">&amp;state=</code><code class="si">{</code><code class="n">state</code><code class="si">}</code><code class="s2">"</code><code>&#13;
</code><code>        </code><code class="sa">f</code><code class="s2">"</code><code class="s2">&amp;redirect_uri=</code><code class="si">{</code><code class="n">redirect_uri</code><code class="si">}</code><code class="s2">"</code><code>&#13;
</code><code>    </code><code class="p">)</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO9-1" id="co_authentication_and_authorization_CO9-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>    </code><code class="n">csrf_token</code><code> </code><code class="o">=</code><code> </code><code class="n">secrets</code><code class="o">.</code><code class="n">token_urlsafe</code><code class="p">(</code><code class="mi">16</code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="n">request</code><code class="o">.</code><code class="n">session</code><code class="p">[</code><code class="s2">"</code><code class="s2">x-csrf-state-token</code><code class="s2">"</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">csrf_token</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="n">response</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO9-1" id="callout_authentication_and_authorization_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Redirect user to the GitHub authorization server to log into their account while supplying your application credentials, a requested scope, and a CSRF state value to prevent against CSRF attacks.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>As you can see in <a data-type="xref" href="#oauth_redirect">Example 8-13</a>, the scope of the request is the user, meaning that once users log into their GitHub account, they will be presented with a consent screen for your application to be granted access to their user profile.</p>&#13;
&#13;
<p>Now that you have a backend endpoint redirecting requests to the GitHub authorization server, you can put a button in your client-side application to hit this endpoint and start the OAuth process with GitHub (see <a data-type="xref" href="#oauth_client">Example 8-14</a>).</p>&#13;
<div data-type="example" id="oauth_client">&#13;
<h5><span class="label">Example 8-14. </span>Adding a GitHub login button to the Streamlit client-side application</h5>&#13;
&#13;
<pre data-type="programlisting"># client.py&#13;
&#13;
import requests&#13;
import streamlit as st&#13;
&#13;
if st.button("Login with GitHub"):&#13;
    response = requests.get("http://localhost:8000/auth/oauth/github/login")&#13;
    if not response.ok:&#13;
        st.error("Failed to login with GitHub. Please try again later")&#13;
        response.raise_for_status()</pre></div>&#13;
&#13;
<p>You now have implemented the redirect flow that starts the OAuth authentication process with GitHub as the identity provider.</p>&#13;
&#13;
<p>When users log into their GitHub account, GitHub will show them a consent screen similar to <a data-type="xref" href="#oauth2_consent_screen">Figure 8-7</a>.</p>&#13;
&#13;
<p>If the user accepts the consent, GitHub will redirect the user back to your application with a grant code and a state.&#13;
You should check whether the state matches the previously generated state.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>If the states do not match, a third party has made the request, and you should stop the process.</p>&#13;
</div>&#13;
&#13;
<p>Once you have the grant code, you can send this to the GitHub authorization to exchange it for an access token, as shown in <a data-type="xref" href="#oauth_exchange">Example 8-15</a>.</p>&#13;
<div data-type="example" id="oauth_exchange">&#13;
<h5><span class="label">Example 8-15. </span>Exchanging grant code with an access token while protecting against CSRF attacks</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># dependencies/auth.py</code>&#13;
&#13;
<code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Annotated</code>&#13;
<code class="kn">import</code> <code class="nn">aiohttp</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">Depends</code><code class="p">,</code> <code class="n">HTTPException</code>&#13;
<code class="kn">from</code> <code class="nn">loguru</code> <code class="kn">import</code> <code class="n">logger</code>&#13;
&#13;
<code class="n">client_id</code> <code class="o">=</code> <code class="s2">"your_client_id"</code>&#13;
<code class="n">client_secret</code> <code class="o">=</code> <code class="s2">"your_client_secret"</code>&#13;
&#13;
<code class="k">async</code> <code class="k">def</code> <code class="nf">exchange_grant_with_access_token</code><code class="p">(</code><code class="n">code</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">str</code><code class="p">:</code>&#13;
    <code class="k">try</code><code class="p">:</code>&#13;
        <code class="n">body</code> <code class="o">=</code> <code class="p">{</code>&#13;
            <code class="s2">"client_id"</code><code class="p">:</code> <code class="n">client_id</code><code class="p">,</code>&#13;
            <code class="s2">"client_secret"</code><code class="p">:</code> <code class="n">client_secret</code><code class="p">,</code>&#13;
            <code class="s2">"code"</code><code class="p">:</code> <code class="n">code</code><code class="p">,</code>&#13;
        <code class="p">}</code>&#13;
        <code class="n">headers</code> <code class="o">=</code> <code class="p">{</code>&#13;
            <code class="s2">"Accept"</code><code class="p">:</code> <code class="s2">"application/json"</code><code class="p">,</code>&#13;
            <code class="s2">"Content-Type"</code><code class="p">:</code> <code class="s2">"application/json"</code><code class="p">,</code>&#13;
        <code class="p">}</code>&#13;
        <code class="k">async</code> <code class="k">with</code> <code class="n">aiohttp</code><code class="o">.</code><code class="n">ClientSession</code><code class="p">()</code> <code class="k">as</code> <code class="n">session</code><code class="p">:</code>&#13;
            <code class="k">async</code> <code class="k">with</code> <code class="n">session</code><code class="o">.</code><code class="n">post</code><code class="p">(</code>&#13;
                <code class="s2">"https://github.com/login/oauth/access_token"</code><code class="p">,</code>&#13;
                <code class="n">json</code><code class="o">=</code><code class="n">body</code><code class="p">,</code>&#13;
                <code class="n">headers</code><code class="o">=</code><code class="n">headers</code><code class="p">,</code>&#13;
            <code class="p">)</code> <code class="k">as</code> <code class="n">resp</code><code class="p">:</code>&#13;
                <code class="n">access_token_data</code> <code class="o">=</code> <code class="k">await</code> <code class="n">resp</code><code class="o">.</code><code class="n">json</code><code class="p">()</code>&#13;
    <code class="k">except</code> <code class="ne">Exception</code> <code class="k">as</code> <code class="n">e</code><code class="p">:</code>&#13;
        <code class="n">logger</code><code class="o">.</code><code class="n">warning</code><code class="p">(</code><code class="sa">f</code><code class="s2">"Failed to fetch the access token. Error: </code><code class="si">{</code><code class="n">e</code><code class="si">}</code><code class="s2">"</code><code class="p">)</code>&#13;
        <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code>&#13;
            <code class="n">status_code</code><code class="o">=</code><code class="mi">503</code><code class="p">,</code> <code class="n">detail</code><code class="o">=</code><code class="s2">"Failed to fetch access token"</code>&#13;
        <code class="p">)</code>&#13;
&#13;
    <code class="k">if</code> <code class="ow">not</code> <code class="n">access_token_data</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code>&#13;
            <code class="n">status_code</code><code class="o">=</code><code class="mi">503</code><code class="p">,</code> <code class="n">detail</code><code class="o">=</code><code class="s2">"Failed to obtain access token"</code>&#13;
        <code class="p">)</code>&#13;
&#13;
    <code class="k">return</code> <code class="n">access_token_data</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"access_token"</code><code class="p">,</code> <code class="s2">""</code><code class="p">)</code>&#13;
&#13;
<code class="n">ExchangeCodeTokenDep</code> <code class="o">=</code> <code class="n">Annotated</code><code class="p">[</code><code class="nb">str</code><code class="p">,</code> <code class="n">Depends</code><code class="p">(</code><code class="n">exchange_grant_with_access_token</code><code class="p">)]</code></pre></div>&#13;
&#13;
<p>You can now add a new endpoint that accepts requests from the GitHub authorization server.&#13;
This callback endpoint should have a CSRF protection to guard against third parties impersonating the authorization server.&#13;
If the request from GitHub is forged, the state parameter provided and the one stored in the request session won’t match.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id995">&#13;
<h1>Cross-Site Request Forgery</h1>&#13;
<p><a data-primary="cross-site request forgery (CSRF)" data-type="indexterm" id="ix_ch08-asciidoc17"/><a data-primary="OAuth authentication" data-secondary="CSRF and" data-type="indexterm" id="ix_ch08-asciidoc18"/>CSRF is a type of security vulnerability that allows an attacker to trick a user into performing actions on a web application where they are authenticated.&#13;
This can lead to unauthorized actions being executed without the user’s consent.</p>&#13;
&#13;
<p>In CSRF, the attacker creates a malicious request that exploits the user’s authenticated session with a target website.&#13;
These attacks can result in unauthorized transactions, data theft, or changes to user settings without their consent and knowledge.</p>&#13;
&#13;
<p>In the context of OAuth2, an attacker can exploit vulnerabilities such as <em>open redirect</em> to intercept the initial authorization requests and modify them to redirect to their own malicious site after authentication.</p>&#13;
&#13;
<p>Attackers can also create a replica of your application frontend and trick users into logging into their accounts.&#13;
If the user logs into their GitHub account via the phishing site, the attacker can provide a redirect URL pointing to their own servers to get an authorization grant code.&#13;
They can then exchange the authorization code for an access token.</p>&#13;
&#13;
<p><a data-type="xref" href="#oauth2_csrf_attack">Figure 8-9</a> shows an example of the OAuth2 CSRF attack using an open redirect &#13;
<span class="keep-together">vulnerability.</span></p>&#13;
&#13;
<figure><div class="figure" id="oauth2_csrf_attack">&#13;
<img alt="bgai 0809" src="assets/bgai_0809.png"/>&#13;
<h6><span class="label">Figure 8-9. </span>OAuth2 CSRF attack using an open redirect vulnerability</h6>&#13;
</div></figure>&#13;
&#13;
<p>A <code>state</code> or <code>csrf_token</code> parameter exchanged during requests between the client and authorization servers can prevent against CSRF attacks by maintaining session state between requests, responses, and redirections.</p>&#13;
&#13;
<p>In addition, to protect against open redirect vulnerabilities, you should also pre-register and strictly validate redirect URLs with the identity provider, educate your users on phishing attempts, and implement logging and monitoring mechanisms to detect suspicious requests.<a data-startref="ix_ch08-asciidoc18" data-type="indexterm" id="id996"/><a data-startref="ix_ch08-asciidoc17" data-type="indexterm" id="id997"/></p>&#13;
</div></aside>&#13;
&#13;
<p><a data-type="xref" href="#oauth_callback">Example 8-16</a> shows the callback endpoint implementation.</p>&#13;
<div data-type="example" id="oauth_callback">&#13;
<h5><span class="label">Example 8-16. </span>Implement callback endpoint to get access token while protecting against CSRF attacks</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># routes/auth.py</code>&#13;
&#13;
<code class="kn">from</code> <code class="nn">dependencies.auth</code> <code class="kn">import</code> <code class="n">ExchangeCodeTokenDep</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">Depends</code><code class="p">,</code> <code class="n">HTTPException</code><code class="p">,</code> <code class="n">Request</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi.responses</code> <code class="kn">import</code> <code class="n">RedirectResponse</code>&#13;
&#13;
<code class="o">...</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">check_csrf_state</code><code class="p">(</code><code class="n">request</code><code class="p">:</code> <code class="n">Request</code><code class="p">,</code> <code class="n">state</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="kc">None</code><code class="p">:</code>&#13;
    <code class="k">if</code> <code class="n">state</code> <code class="o">!=</code> <code class="n">request</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"x-csrf-token"</code><code class="p">):</code>&#13;
        <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code><code class="n">detail</code><code class="o">=</code><code class="s2">"Bad request"</code><code class="p">,</code> <code class="n">status_code</code><code class="o">=</code><code class="mi">401</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/oauth/github/callback"</code><code class="p">,</code> <code class="n">dependencies</code><code class="o">=</code><code class="p">[</code><code class="n">Depends</code><code class="p">(</code><code class="n">check_csrf_state</code><code class="p">)])</code>&#13;
<code class="k">async</code> <code class="k">def</code> <code class="nf">oauth_github_callback_controller</code><code class="p">(</code>&#13;
    <code class="n">access_token</code><code class="p">:</code> <code class="n">ExchangeCodeTokenDep</code><code class="p">,</code>&#13;
<code class="p">)</code> <code class="o">-&gt;</code> <code class="n">RedirectResponse</code><code class="p">:</code>&#13;
    <code class="n">response</code> <code class="o">=</code> <code class="n">RedirectResponse</code><code class="p">(</code><code class="n">url</code><code class="o">=</code><code class="sa">f</code><code class="s2">"http://localhost:8501"</code><code class="p">)</code>&#13;
    <code class="n">response</code><code class="o">.</code><code class="n">set_cookie</code><code class="p">(</code><code class="n">key</code><code class="o">=</code><code class="s2">"access_token"</code><code class="p">,</code> <code class="n">value</code><code class="o">=</code><code class="n">access_token</code><code class="p">,</code> <code class="n">httponly</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">response</code></pre></div>&#13;
&#13;
<p>In <a data-type="xref" href="#oauth_callback">Example 8-16</a>, you are using the request session for CSRF protection, but this won’t work without adding the Starlette’s <code>SessionMiddlware</code> first to maintain a secure user session that’s only mutable on the server side, as shown in <a data-type="xref" href="#oauth_session">Example 8-17</a>.</p>&#13;
<div data-type="example" id="oauth_session">&#13;
<h5><span class="label">Example 8-17. </span>Add a session middleware to manage session state for protecting against CSRF attacks</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># main.py</code>&#13;
&#13;
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code>&#13;
<code class="kn">from</code> <code class="nn">starlette.middleware.sessions</code> <code class="kn">import</code> <code class="n">SessionMiddleware</code>&#13;
&#13;
<code class="o">...</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">(</code><code class="n">lifespan</code><code class="o">=</code><code class="n">lifespan</code><code class="p">)</code>&#13;
<code class="n">app</code><code class="o">.</code><code class="n">add_middleware</code><code class="p">(</code><code class="n">SessionMiddleware</code><code class="p">,</code> <code class="n">secret_key</code><code class="o">=</code><code class="s2">"your_secret_key"</code><code class="p">)</code></pre></div>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>Avoid relying on HTTP <em>cookies</em> to store and read the <code>state</code> between request sessions as cookies can be read and manipulated by third parties.&#13;
Never trust any data that comes from the client.</p>&#13;
</div>&#13;
&#13;
<p>By writing the unique <code>state</code> to the session in <a data-type="xref" href="#oauth_redirect">Example 8-13</a> and comparing it with the <code>state</code> value in the incoming request query parameters, you can then confirm the identity of the request.</p>&#13;
&#13;
<p>In this case, the requester is the GitHub authorization server sending you a grant <code>code</code>. Once you receive the grant <code>code</code>, you then exchange it with the GitHub authorization server for an access token.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>The process shown in the OAuth-related code examples can also be implemented with the open source <code>authlib</code> package for simpler implementation, as the package handles most of the work for you.</p>&#13;
</div>&#13;
&#13;
<p>Finally, you can use the access token you received from the authorization server to fetch user information such as their name, email, and profile image to register their identity in your application.</p>&#13;
&#13;
<p><a data-type="xref" href="#oauth_user_info">Example 8-18</a> demonstrates how to implement an endpoint that returns the user info from GitHub if the request supplies an access token as part of the request’s authorization header.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>Ideally, you should avoid sharing the user’s GitHub access token with the user’s browser.&#13;
If the token is stolen, your application is responsible for compromising the user’s GitHub account.</p>&#13;
&#13;
<p>Instead, create and share your own short-lived access token tied to the GitHub access token to authenticate the user with your application.&#13;
If your application token is stolen, you avoid compromising user accounts beyond the scope of your application.</p>&#13;
</div>&#13;
<div data-type="example" id="oauth_user_info">&#13;
<h5><span class="label">Example 8-18. </span>Use access token to get user information from GitHub resource servers</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># routes/auth.py</code>&#13;
&#13;
<code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Annotated</code>&#13;
<code class="kn">import</code> <code class="nn">aiohttp</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">Depends</code><code class="p">,</code> <code class="n">HTTPException</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi.security</code> <code class="kn">import</code> <code class="n">HTTPAuthorizationCredentials</code><code class="p">,</code> <code class="n">HTTPBearer</code>&#13;
&#13;
<code class="n">security</code> <code class="o">=</code> <code class="n">HTTPBearer</code><code class="p">()</code>&#13;
<code class="n">HTTPBearerDep</code> <code class="o">=</code> <code class="n">Annotated</code><code class="p">[</code><code class="n">HTTPAuthorizationCredentials</code><code class="p">,</code> <code class="n">Depends</code><code class="p">(</code><code class="n">security</code><code class="p">)]</code>&#13;
&#13;
<code class="o">...</code>&#13;
&#13;
<code class="k">async</code> <code class="k">def</code> <code class="nf">get_user_info</code><code class="p">(</code><code class="n">credentials</code><code class="p">:</code> <code class="n">HTTPBearerDep</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">dict</code><code class="p">:</code>&#13;
    <code class="k">try</code><code class="p">:</code>&#13;
        <code class="k">async</code> <code class="k">with</code> <code class="n">aiohttp</code><code class="o">.</code><code class="n">ClientSession</code><code class="p">()</code> <code class="k">as</code> <code class="n">session</code><code class="p">:</code>&#13;
            <code class="n">headers</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"Authorization"</code><code class="p">:</code> <code class="sa">f</code><code class="s2">"Bearer </code><code class="si">{</code><code class="n">credentials</code><code class="o">.</code><code class="n">credentials</code><code class="si">}</code><code class="s2">"</code><code class="p">}</code>&#13;
            <code class="k">async</code> <code class="k">with</code> <code class="n">session</code><code class="o">.</code><code class="n">get</code><code class="p">(</code>&#13;
                <code class="s2">"https://api.github.com/user"</code><code class="p">,</code> <code class="n">headers</code><code class="o">=</code><code class="n">headers</code>&#13;
            <code class="p">)</code> <code class="k">as</code> <code class="n">resp</code><code class="p">:</code>&#13;
                <code class="k">return</code> <code class="k">await</code> <code class="n">resp</code><code class="o">.</code><code class="n">json</code><code class="p">()</code>&#13;
    <code class="k">except</code> <code class="ne">Exception</code> <code class="k">as</code> <code class="n">e</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code>&#13;
            <code class="n">status_code</code><code class="o">=</code><code class="mi">503</code><code class="p">,</code> <code class="n">detail</code><code class="o">=</code><code class="sa">f</code><code class="s2">"Failed to obtain user info - Error: </code><code class="si">{</code><code class="n">e</code><code class="si">}</code><code class="s2">"</code>&#13;
        <code class="p">)</code>&#13;
&#13;
<code class="n">GetUserInfoDep</code> <code class="o">=</code> <code class="n">Annotated</code><code class="p">[</code><code class="nb">dict</code><code class="p">,</code> <code class="n">Depends</code><code class="p">(</code><code class="n">get_user_info</code><code class="p">)]</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/oauth/github/callback"</code><code class="p">)</code>&#13;
<code class="k">async</code> <code class="k">def</code> <code class="nf">get_current_user_controller</code><code class="p">(</code><code class="n">user_info</code><code class="p">:</code> <code class="n">GetUserInfoDep</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">dict</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">user_info</code></pre></div>&#13;
&#13;
<p>Congratulations!&#13;
You should now have a working authentication system that leverages OAuth2 to authenticate users.<a data-startref="ix_ch08-asciidoc16" data-type="indexterm" id="id998"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="OAuth2 Flow Types" data-type="sect2"><div class="sect2" id="id122">&#13;
<h2>OAuth2 Flow Types</h2>&#13;
&#13;
<p><a data-primary="OAuth2 standard" data-type="indexterm" id="ix_ch08-asciidoc19a"/><a data-primary="OAuth authentication" data-secondary="authorization flows" data-type="indexterm" id="ix_ch08-asciidoc19"/>The OAuth2 flow that you just implemented was the <em>authorization code flow</em> (ACF).&#13;
However, there are other flows that you can choose depending on the use case.&#13;
The identity provider documentation may present you with solutions for various flows, which can feel overwhelming if you’re not aware of these use cases.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Authorization code flow" data-type="sect3"><div class="sect3" id="id123">&#13;
<h3>Authorization code flow</h3>&#13;
&#13;
<p><a data-primary="OAuth authentication" data-secondary="authorization flows" data-tertiary="authorization code flow" data-type="indexterm" id="id999"/>The authorization code flow is the common approach for applications that leverage servers and backend APIs such as FastAPI, using code grants to issue access tokens.</p>&#13;
&#13;
<p><a data-primary="proof key for exchange (PKCE)" data-type="indexterm" id="id1000"/><a data-primary="PKCE (proof key for exchange)" data-type="indexterm" id="id1001"/>A more secure variant of ACF leverages <em>proof key for exchange</em> (PKCE, pronounced “pixie”).&#13;
You can use the ACF-PKCE flow where you cannot protect the authorization code from being stolen—for instance, on mobile devices.</p>&#13;
<p class="fix_tracking">During the ACF-PKCE flow, you add a hashed secret called the <code>code_challenge</code> when sending the initial request to the identity provider. Then you present the unhashed secret <code>code_verifier</code> again  to exchange the authorization code for an access token.</p>&#13;
&#13;
<p>In essence, PKCE protects against <em>authorization code interception</em> attacks—shown in <a data-type="xref" href="#oauth_interception_attack">Figure 8-10</a>—by adding a layer of verification during the token exchange process.</p>&#13;
&#13;
<figure><div class="figure" id="oauth_interception_attack">&#13;
<img alt="bgai 0810" src="assets/bgai_0810.png"/>&#13;
<h6><span class="label">Figure 8-10. </span>OAuth2 authorization code interception attack on a mobile device</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Implicit flow" data-type="sect3"><div class="sect3" id="id124">&#13;
<h3>Implicit flow</h3>&#13;
&#13;
<p>For<a data-primary="implicit flow" data-type="indexterm" id="id1002"/><a data-primary="OAuth authentication" data-secondary="authorization flows" data-tertiary="implicit flow" data-type="indexterm" id="id1003"/> single-page applications (SPAs) where there is no separate backend, you can &#13;
<span class="keep-together">also use</span> the <em>implicit flow</em>, which skips the authorization grant code to directly get an access token.&#13;
Implicit flow is less secure than the previous flow but enhances the user &#13;
<span class="keep-together">experience.</span></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Client credentials flow" data-type="sect3"><div class="sect3" id="id125">&#13;
<h3>Client credentials flow</h3>&#13;
&#13;
<p><a data-primary="client credentials flow" data-type="indexterm" id="id1004"/><a data-primary="OAuth authentication" data-secondary="authorization flows" data-tertiary="client credentials flow" data-type="indexterm" id="id1005"/>If you’re building a backend service for machine-to-machine communication and where no browsers will be involved, then you can use the <em>client credentials flow</em>.&#13;
Here you can exchange your client ID and secret for an access token to access your own resources on the identity provider servers (i.e., you won’t have access on behalf of other users).</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Resource owner password credentials flow" data-type="sect3"><div class="sect3" id="id126">&#13;
<h3>Resource owner password credentials flow</h3>&#13;
&#13;
<p><a data-primary="OAuth authentication" data-secondary="authorization flows" data-tertiary="resource owner password credentials flow" data-type="indexterm" id="id1006"/><a data-primary="resource owner password credentials flow" data-type="indexterm" id="id1007"/><em>Resource owner password credentials flow</em> is like the client credentials flow but uses a username and password of the user to get an access token.&#13;
As the credentials are being exchanged directly with the authorization server, you should avoid using this flow as much as possible.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Device authorization flow" data-type="sect3"><div class="sect3" id="id127">&#13;
<h3>Device authorization flow</h3>&#13;
&#13;
<p><a data-primary="device authorization flow" data-type="indexterm" id="id1008"/><a data-primary="OAuth authentication" data-secondary="authorization flows" data-tertiary="device authorization flow" data-type="indexterm" id="id1009"/>Finally, there is the <em>device authorization flow</em> that’s mostly used for devices with limited input capabilities, such as when you log into your Apple TV account on your smart TV by scanning a QR code and using a web browser from your phone.</p>&#13;
&#13;
<p><a data-type="xref" href="#oauth_flows_comparison">Table 8-2</a> compares the various flows to help you select the right option for your own use case, based on your specific requirements and constraints.</p>&#13;
<table class="striped" id="oauth_flows_comparison">&#13;
<caption><span class="label">Table 8-2. </span>Comparison of OAuth2 authorization flows</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Flow</th>&#13;
<th>Description</th>&#13;
<th>Considerations</th>&#13;
<th>Use cases</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p>Authorization code flow (including PKCE)</p></td>&#13;
<td><p>Get the authorization code via a user login and exchange for an access token.</p></td>&#13;
<td>&#13;
<ul><li><p>Provider’s access token must be securely stored and never exposed to the browser.</p></li>&#13;
<li><p>Use ACF-PKCE flow if possible for enhanced security.</p></li></ul></td>&#13;
<td><ul><li><p>Server-side applications and web applications with a backend server that can securely handle the client secret and access tokens.</p></li>&#13;
<li><p>Mobile applications if using a PKCE token as client credentials can’t be securely stored.</p></li></ul></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Implicit flow</p></td>&#13;
<td><p>Get an access token without an authorization code.</p></td>&#13;
<td><ul><li><p>Less secure as the access token is exposed to the browser.</p></li>&#13;
<li><p>Use when using the authorization code flow is not possible.</p></li></ul></td>&#13;
<td><p>Single-page applications (SPAs) where user experience is prioritized over security, when prototyping, or where the authorization code flow is not possible.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Client credentials flow</p></td>&#13;
<td><p>The client directly exchanges its client credentials (client ID and client secret) for an access token.</p></td>&#13;
<td><p>No user interaction involved, meant for scenarios where the client is acting on its own behalf. Ensure secure storage of client credentials.</p></td>&#13;
<td><p>Server-to-server applications.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Resource owner password credentials flow</p></td>&#13;
<td><p>Exchange user’s username and password directly for an access token.</p></td>&#13;
<td><ul>&#13;
<li><p>High security risk as user’s credentials are handled directly.</p></li>&#13;
<li><p>Only use in legacy systems where other flows are not supported.</p></li></ul></td>&#13;
<td><p>Legacy applications or highly trusted environments.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Device authorization flow</p></td>&#13;
<td><p>Visit a URL on another device to enter a code for an access token.</p></td>&#13;
<td><p>Requires a second device with a web browser for the user to authenticate.</p></td>&#13;
<td><p>Devices with limited input capabilities, like smart TVs, gaming consoles, or IoT devices.</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>You should now feel more confident in securing your application with a variety of commercial identity verification mechanisms, including the various OAuth2 flows that leverage external IDPs.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1010">&#13;
<h1>Troubleshooting OAuth Implementation Issues</h1>&#13;
<p><a data-primary="OAuth authentication" data-secondary="troubleshooting OAuth implementation issues" data-type="indexterm" id="id1011"/>There are often several common issues that you may face when implementing OAuth authentication in your services. <a data-type="xref" href="#oauth_troubleshooting">Table 8-3</a> lists these issues with corresponding solutions that you can use as a reference.</p>&#13;
<table class="striped" id="oauth_troubleshooting">&#13;
<caption><span class="label">Table 8-3. </span>OAuth issues with solutions</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Issue</th>&#13;
<th>Solution</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p>Invalid redirect URI</p></td>&#13;
<td><p>Register (i.e., allowlist) the redirect URI with the identity provider.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Invalid client ID or secret</p></td>&#13;
<td><p>Generate and copy the correct client ID and secret from the identity provider when you register your application with them.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Expired token</p></td>&#13;
<td><p>The identity provider may issue you refresh tokens that you can use to get new access tokens without repeating the full OAuth authorization flow.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Missing scopes</p></td>&#13;
<td><p>Add valid scopes in the authorization request to the provider. The user of your services must also consent to these scopes.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Incorrect token endpoint</p></td>&#13;
<td><p>Send a request to the right token endpoint URL provided by the identity provider to get an access token.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>CORS errors</p></td>&#13;
<td><p>Configure the identity provider settings to allow CORS for your domain or use a server-side proxy to handle the OAuth requests.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Invalid grant type</p></td>&#13;
<td><p>Provide the correct grant type in the request to the identity provider.</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>As you can see, most issues listed relate to incorrect implementation or configuration of OAuth flows with the OAuth identity provider. To avoid some of these problems, you may consider using OAuth libraries such as <code>authlib</code> that handles much of the complexity for you as long as you’re using the correct provider secrets.</p>&#13;
</div></aside>&#13;
&#13;
<p>Authentication forms the first step to securing your services by identifying who the users of your system are.</p>&#13;
&#13;
<p>A question remains: what should happen when a user is logged into your services?&#13;
Can they fetch data, interact with models, and mutate resources as they please, or would you rather control their interactions in your services?<a data-startref="ix_ch08-asciidoc19" data-type="indexterm" id="id1012"/><a data-startref="ix_ch08-asciidoc19a" data-type="indexterm" id="id1013"/></p>&#13;
&#13;
<p>These are problems that an authorization system will tackle, which we will talk about next.<a data-startref="ix_ch08-asciidoc14" data-type="indexterm" id="id1014"/><a data-startref="ix_ch08-asciidoc13" data-type="indexterm" id="id1015"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Authorization" data-type="sect1"><div class="sect1" id="id128">&#13;
<h1>Authorization</h1>&#13;
&#13;
<p><a data-primary="authorization" data-type="indexterm" id="ix_ch08-asciidoc20"/>So far, we’ve been covering various authentication mechanisms including the basic, token-based (JWT), and OAuth2 for securing your applications.</p>&#13;
&#13;
<p><a data-primary="permissions, authorization and" data-type="indexterm" id="id1016"/>As mentioned earlier, authentication systems identify and verify actors, whereas the authorization systems enforce <em>permissions</em> in an application (i.e., who can do what on which resource).</p>&#13;
&#13;
<p><a data-primary="authorization model (actor, action, resource)" data-type="indexterm" id="id1017"/>In this section, you’re going to learn about the authorization system that takes into account the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The <em>actor</em> (i.e., the user or a third-party service acting on behalf of the user)</p>&#13;
</li>&#13;
<li>&#13;
<p>The <em>action</em> being undertaken</p>&#13;
</li>&#13;
<li>&#13;
<p>The impact of the action on <em>resources</em></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>In essence, an authorization system can be compared to a function that accepts three inputs—<em>actor</em>, <em>action</em>, <em>resource</em>—and returns a <em>Boolean decision</em> to <em>allow</em> or <em>deny</em> a request.&#13;
To implement the authorization function, you will require <em>authorization data</em> such as user attributes, relationships (like team/group/org memberships), resource ownership, roles, and permissions passed through a set of <em>abstract rules</em> to determine the Boolean allow/deny decisions.</p>&#13;
&#13;
<p>Once a decision is made, you can <em>enforce</em> the authorization by either allowing actions (such as fetching or mutating resources) or denying requests (such as sending 403 Forbidden responses, redirecting users, hiding resources, locking accounts, etc.).</p>&#13;
&#13;
<p>On the surface level, implementing authorization can be simple.&#13;
Using a few conditional statements, you can check whether a user has permissions to perform an action.&#13;
However, this naive approach can get complex to manage as the number of places you need to implement authorization steps increases.&#13;
This issue becomes worse as you make changes to the logic across the application, making the system complex and adding finer controls.&#13;
You may end up duplicating logic or making future changes more difficult, and the authorization rules may deeply be interwoven in your application logic, making separation from the rest of the application more challenging.</p>&#13;
&#13;
<p>In such cases, authorization models can be useful to help you navigate the complexity of managing authorization decisions and enforcements in your applications.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Authorization Models" data-type="sect2"><div class="sect2" id="id129">&#13;
<h2>Authorization Models</h2>&#13;
&#13;
<p><a data-primary="authorization" data-secondary="authorization models" data-type="indexterm" id="ix_ch08-asciidoc21"/>There are a few common <em>authorization models</em> that you can learn to make structuring and implementing an authorization system easier:</p>&#13;
<dl>&#13;
<dt>Role-based access control (RBAC)</dt>&#13;
<dd>&#13;
<p>Authorization is based on the roles assigned to users, where each role has specific permissions.&#13;
For instance, administrators can access every available GenAI model, bypassing authorization rules enforced on users.</p>&#13;
</dd>&#13;
<dt>Relationship-based access control (ReBAC)</dt>&#13;
<dd>&#13;
<p>Authorization is determined by the relationships between entities, such as user-to-user (i.e., follower, friend, connection) or user-to-resource (i.e., group, team, org) relationships.&#13;
For instance, this could authorize a user who is a member of a team to access premium models purchased by that team.</p>&#13;
</dd>&#13;
<dt>Attribute-based access control (ABAC)</dt>&#13;
<dd>&#13;
<p>Authorization decisions are made based on attributes of users, resources, and the environment, allowing for fine-grained access control.&#13;
For instance, a conversation with a <em>public</em> attribute is viewable by everyone, and a user with a <em>paid</em> attribute can access premium GenAI models.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>RBAC is the simplest authorization model but won’t provide the enhanced granular controls and flexibility of other authorization models.&#13;
ABAC controls provide more fine-grained access control and can override both ReBAC and RBAC rules.&#13;
Furthermore, ReBAC can also override or extend RBAC controls.</p>&#13;
&#13;
<p><a data-type="xref" href="#authorization_methods_comparison">Table 8-4</a> compares the three authorization models.</p>&#13;
<table class="striped" id="authorization_methods_comparison">&#13;
<caption><span class="label">Table 8-4. </span>Comparison of authorization methods</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Type</th>&#13;
<th>Benefits</th>&#13;
<th>Limitations</th>&#13;
<th>Use cases</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p>Role-based (RBAC)</p></td>&#13;
<td><p>Simplifies management</p></td>&#13;
<td><p>Limited flexibility</p></td>&#13;
<td><p>Enterprise environments, access control, financial systems, healthcare systems</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Relationship-based (ReBAC)</p></td>&#13;
<td><p>Fine-grained control</p></td>&#13;
<td><p>Needs relationship data from various sources with complex permission evaluations</p></td>&#13;
<td><p>Social networks, collaborative platforms, content-sharing applications, project management tools</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Attribute-based (ABAC)</p></td>&#13;
<td><p>Highly flexible</p></td>&#13;
<td><p>Needs attribute data from various sources with complex permission evaluations</p></td>&#13;
<td><p>Dynamic environments, cloud services, IoT systems, regulatory compliance, personalized user experiences</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>These three authorization models also have a hierarchical relationship, as demonstrated in <a data-type="xref" href="#authorization_models">Figure 8-11</a>.</p>&#13;
&#13;
<figure><div class="figure" id="authorization_models">&#13;
<img alt="bgai 0811" src="assets/bgai_0811.png"/>&#13;
<h6><span class="label">Figure 8-11. </span>Authorization models</h6>&#13;
</div></figure>&#13;
&#13;
<p>Let’s now discuss each authorization model in detail, starting with the RBAC model.<a data-startref="ix_ch08-asciidoc21" data-type="indexterm" id="id1018"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Role-Based Access Control" data-type="sect2"><div class="sect2" id="id130">&#13;
<h2>Role-Based Access Control</h2>&#13;
&#13;
<p><a data-primary="authorization" data-secondary="authorization models" data-tertiary="role-based access control (RBAC)" data-type="indexterm" id="ix_ch08-asciidoc22"/><a data-primary="role-based access control (RBAC)" data-type="indexterm" id="ix_ch08-asciidoc23"/><a data-primary="RBAC (role-based access control)" data-type="indexterm" id="ix_ch08-asciidoc23a"/>Using <em>roles</em> is a widely adopted model for implementing authorization in applications due to their simplicity.</p>&#13;
&#13;
<p>Roles are straightforward to understand.&#13;
They normally correspond to whom the user is and what they want to do in the application.&#13;
Sometimes authorization roles can directly map to roles in your organization’s hierarchy.</p>&#13;
&#13;
<p>You can group permissions under a role that can then be <em>assigned</em> to users to grant user those permissions.&#13;
A <em>permission</em> specifies the action that a user can take on resources, such as if the user can interact with the paid LLM model provided by your service.</p>&#13;
&#13;
<p>For better administrative and user experience, you can create multiple roles with preset permissions to reduce decision fatigue when setting user permissions.&#13;
Instead of having to set a vast number of permissions, you can assign a few predefined roles.</p>&#13;
&#13;
<p>A common starting point for many commercial services is user and administrator roles.&#13;
While a member can access the core functionality of the application such as interacting with GenAI models, and reading and writing resources, they won’t be able to view data of other users or manage roles.&#13;
On the other hand, administrators can assign and remove roles, view and mutate every resource, or disable and enable accounts.&#13;
Administrators may also have access to early features such as GenAI models that normal users can’t access yet, as shown in <a data-type="xref" href="#rbac_example">Figure 8-12</a>.</p>&#13;
&#13;
<figure><div class="figure" id="rbac_example">&#13;
<img alt="bgai 0812" src="assets/bgai_0812.png"/>&#13;
<h6><span class="label">Figure 8-12. </span>RBAC example where only administrators have access to image-based GenAI models</h6>&#13;
</div></figure>&#13;
&#13;
<p>You can implement a simple RBAC authorization model to control the GenAI services that your users can access, as shown in <a data-type="xref" href="#rbac">Example 8-19</a>.</p>&#13;
<div data-type="example" id="rbac">&#13;
<h5><span class="label">Example 8-19. </span>Implementing RBAC using FastAPI dependencies</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># dependencies/auth.py</code><code>&#13;
</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">entities</code><code> </code><code class="kn">import</code><code> </code><code class="n">User</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">fastapi</code><code> </code><code class="kn">import</code><code> </code><code class="n">Depends</code><code class="p">,</code><code> </code><code class="n">HTTPException</code><code class="p">,</code><code> </code><code class="n">status</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">services</code><code class="nn">.</code><code class="nn">auth</code><code> </code><code class="kn">import</code><code> </code><code class="n">AuthService</code><code>&#13;
</code><code>&#13;
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">is_admin</code><code class="p">(</code><code class="n">user</code><code class="p">:</code><code> </code><code class="n">User</code><code> </code><code class="o">=</code><code> </code><code class="n">Depends</code><code class="p">(</code><code class="n">AuthService</code><code class="o">.</code><code class="n">get_current_user</code><code class="p">)</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">User</code><code class="p">:</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO10-1" id="co_authentication_and_authorization_CO10-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>    </code><code class="k">if</code><code> </code><code class="n">user</code><code class="o">.</code><code class="n">role</code><code> </code><code class="o">!=</code><code> </code><code class="s2">"</code><code class="s2">ADMIN</code><code class="s2">"</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="k">raise</code><code> </code><code class="n">HTTPException</code><code class="p">(</code><code>&#13;
</code><code>            </code><code class="n">status_code</code><code class="o">=</code><code class="n">status</code><code class="o">.</code><code class="n">HTTP_403_FORBIDDEN</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="n">detail</code><code class="o">=</code><code class="s2">"</code><code class="s2">Not allowed to perform this action</code><code class="s2">"</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="n">user</code><code>&#13;
</code><code>&#13;
</code><code class="c1"># routers/resource.py</code><code>&#13;
</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">dependencies</code><code class="nn">.</code><code class="nn">auth</code><code> </code><code class="kn">import</code><code> </code><code class="n">is_admin</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">fastapi</code><code> </code><code class="kn">import</code><code> </code><code class="n">APIRouter</code><code class="p">,</code><code> </code><code class="n">Depends</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">services</code><code class="nn">.</code><code class="nn">auth</code><code> </code><code class="kn">import</code><code> </code><code class="n">AuthService</code><code>&#13;
</code><code>&#13;
</code><code class="n">router</code><code> </code><code class="o">=</code><code> </code><code class="n">APIRouter</code><code class="p">(</code><code>&#13;
</code><code>    </code><code class="n">dependencies</code><code class="o">=</code><code class="p">[</code><code class="n">Depends</code><code class="p">(</code><code class="n">AuthService</code><code class="o">.</code><code class="n">get_current_user</code><code class="p">)</code><code class="p">]</code><code class="p">,</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO10-3" id="co_authentication_and_authorization_CO10-2"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>    </code><code class="n">prefix</code><code class="o">=</code><code class="s2">"</code><code class="s2">/generate</code><code class="s2">"</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="n">tags</code><code class="o">=</code><code class="p">[</code><code class="s2">"</code><code class="s2">Resource</code><code class="s2">"</code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="nd">@router</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"</code><code class="s2">/image</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">dependencies</code><code class="o">=</code><code class="p">[</code><code class="n">Depends</code><code class="p">(</code><code class="n">is_admin</code><code class="p">)</code><code class="p">]</code><code class="p">)</code><code>&#13;
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">generate_image_controller</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO10-2" id="co_authentication_and_authorization_CO10-3"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>    </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>&#13;
</code><code>&#13;
</code><code class="nd">@router</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"</code><code class="s2">/text</code><code class="s2">"</code><code class="p">)</code><code> </code><a class="co" href="#callout_authentication_and_authorization_CO10-3" id="co_authentication_and_authorization_CO10-4"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">generate_text_controller</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="o">.</code><code class="o">.</code><code class="o">.</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO10-1" id="callout_authentication_and_authorization_CO10-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Implement the <code>is_admin</code> authorization dependency guard on top of the <code>Auth​Ser⁠vice.get_current_user</code> dependency.&#13;
Mark the function as <code>async</code> since the child dependency is performing an async operation against the database.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO10-3" id="callout_authentication_and_authorization_CO10-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Use the authorization guard dependency to deny access to the image generation service for nonadmin authenticated users.</p></dd>&#13;
<dt><a class="co" href="#co_authentication_and_authorization_CO10-2" id="callout_authentication_and_authorization_CO10-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Nonadmin authenticated users can still access other resource controllers since the router is secured by an authentication guard dependency.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Using the same logic shown in <a data-type="xref" href="#rbac">Example 8-19</a>, you can construct varying system prompt templates or use different model variants fine-tuned to each role.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>Bear in mind that implementing authorization at the application layer is more secure than delegating it to the GenAI model.&#13;
LLMs and other GenAI models can be vulnerable to <em>prompt injection</em> attacks where an attacker manipulates the input to the model to bypass system instructions to produce unauthorized and harmful outputs.</p>&#13;
&#13;
<p>Future versions of LLMs and other GenAI models may mitigate prompt injection risks by enforcing custom authorization rules internally using extensions like the <em>control neural network (ControlNet)</em> in Stable Diffusion models.</p>&#13;
</div>&#13;
&#13;
<p>To create more complex RBAC authorization logic than the one shown in <a data-type="xref" href="#rbac">Example 8-19</a>, you can implement <em>subdependencies</em> or an <em>abstract dependency</em>.&#13;
Both approaches will leverage FastAPI’s powerful <em>hierarchical dependency graphs</em> as authorization guards to enforce permissions in your GenAI service.</p>&#13;
&#13;
<p>As an example, if you add new roles in the future that inherit a subset of permissions of another role (i.e., moderators and admins), then you can follow either of the approaches shown in <a data-type="xref" href="#complex_rbac_approaches">Figure 8-13</a>.</p>&#13;
&#13;
<figure><div class="figure" id="complex_rbac_approaches">&#13;
<img alt="bgai 0813" src="assets/bgai_0813.png"/>&#13;
<h6><span class="label">Figure 8-13. </span>Approaches for implementing complex RBAC models</h6>&#13;
</div></figure>&#13;
&#13;
<p><a data-primary="abstract dependencies" data-type="indexterm" id="id1019"/>You can implement complex RBAC authorization logic using abstract dependencies, as shown in <a data-type="xref" href="#complex_rbac_abstract">Example 8-20</a>.</p>&#13;
<div data-type="example" id="complex_rbac_abstract">&#13;
<h5><span class="label">Example 8-20. </span>Implementing complex RBAC authorization using abstract dependencies</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># dependencies/auth.py</code>&#13;
&#13;
<code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Annotated</code>&#13;
&#13;
<code class="kn">from</code> <code class="nn">entities</code> <code class="kn">import</code> <code class="n">User</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">APIRouter</code><code class="p">,</code> <code class="n">Depends</code><code class="p">,</code> <code class="n">HTTPException</code><code class="p">,</code> <code class="n">status</code>&#13;
<code class="kn">from</code> <code class="nn">services.auth</code> <code class="kn">import</code> <code class="n">AuthService</code>&#13;
&#13;
<code class="n">CurrentUserDep</code> <code class="o">=</code> <code class="n">Annotated</code><code class="p">[</code><code class="n">User</code><code class="p">,</code> <code class="n">Depends</code><code class="p">(</code><code class="n">AuthService</code><code class="o">.</code><code class="n">get_current_user</code><code class="p">)]</code>&#13;
&#13;
<code class="k">async</code> <code class="k">def</code> <code class="nf">has_role</code><code class="p">(</code><code class="n">user</code><code class="p">:</code> <code class="n">CurrentUserDep</code><code class="p">,</code> <code class="n">roles</code><code class="p">:</code> <code class="nb">list</code><code class="p">[</code><code class="nb">str</code><code class="p">])</code> <code class="o">-&gt;</code> <code class="n">User</code><code class="p">:</code>&#13;
    <code class="k">if</code> <code class="n">user</code><code class="o">.</code><code class="n">role</code> <code class="ow">not</code> <code class="ow">in</code> <code class="n">roles</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code>&#13;
            <code class="n">status_code</code><code class="o">=</code><code class="n">status</code><code class="o">.</code><code class="n">HTTP_403_FORBIDDEN</code><code class="p">,</code>&#13;
            <code class="n">detail</code><code class="o">=</code><code class="s2">"Not allowed to perform this action"</code><code class="p">,</code>&#13;
        <code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">user</code>&#13;
&#13;
&#13;
<code class="c1"># routes/resource.py</code>&#13;
&#13;
<code class="o">...</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">post</code><code class="p">(</code>&#13;
    <code class="s2">"/image"</code><code class="p">,</code>&#13;
    <code class="n">dependencies</code><code class="o">=</code><code class="p">[</code><code class="n">Depends</code><code class="p">(</code><code class="k">lambda</code> <code class="n">user</code><code class="p">:</code> <code class="n">has_role</code><code class="p">(</code><code class="n">user</code><code class="p">,</code> <code class="p">[</code><code class="s2">"ADMIN"</code><code class="p">,</code> <code class="s2">"MODERATOR"</code><code class="p">]))],</code>&#13;
<code class="p">)</code>&#13;
<code class="k">async</code> <code class="k">def</code> <code class="nf">generate_image_controller</code><code class="p">():</code>&#13;
    <code class="o">...</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">post</code><code class="p">(</code>&#13;
    <code class="s2">"/text"</code><code class="p">,</code> <code class="n">dependencies</code><code class="o">=</code><code class="p">[</code><code class="n">Depends</code><code class="p">(</code><code class="k">lambda</code> <code class="n">user</code><code class="p">:</code> <code class="n">has_role</code><code class="p">(</code><code class="n">user</code><code class="p">,</code> <code class="p">[</code><code class="s2">"EDITOR"</code><code class="p">]))]</code>&#13;
<code class="p">)</code>&#13;
<code class="k">async</code> <code class="k">def</code> <code class="nf">generate_text_controller</code><code class="p">():</code>&#13;
    <code class="o">...</code></pre></div>&#13;
&#13;
<p>In summary, RBAC simplifies permission management by assigning permissions to roles rather than individuals, making it easier to manage and audit.&#13;
It is scalable and efficient for organizations with well-defined roles and responsibilities.</p>&#13;
&#13;
<p>However, RBAC can lead to role explosion when many granular roles are necessary, making it hard to manage.&#13;
It also lacks the flexibility to handle complex hierarchical relationships like teams and groups alongside setting dynamic permissions based on attributes like user preferences, time, and privacy settings, which limits its granularity compared to ReBAC or ABAC.<a data-startref="ix_ch08-asciidoc23" data-type="indexterm" id="id1020"/><a data-startref="ix_ch08-asciidoc23a" data-type="indexterm" id="id1021"/><a data-startref="ix_ch08-asciidoc22" data-type="indexterm" id="id1022"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Relationship-Based Access Control" data-type="sect2"><div class="sect2" id="id131">&#13;
<h2>Relationship-Based Access Control</h2>&#13;
&#13;
<p><a data-primary="authorization" data-secondary="authorization models" data-tertiary="relationship-based access control" data-type="indexterm" id="ix_ch08-asciidoc24"/><a data-primary="relationship-based access control (ReBAC)" data-type="indexterm" id="ix_ch08-asciidoc25"/><em>Relationship-based access control</em> is an extension of RBAC with a focus on relationships between resources and users.</p>&#13;
&#13;
<p>With this mode, instead of just setting roles at the user level across the entire application, you must set roles and permissions at the resource level.&#13;
This means you will have to confirm the actions each role can take on every resource type.&#13;
For example, instead of assigning a “moderator” role to a user that grants access to all resources (i.e., conversations, teams, users, etc.), you would assign specific permissions to the moderator role for each resource.&#13;
A moderator might have read and delete permissions on the conversation resource but only read permission on the team resource.</p>&#13;
&#13;
<p>This model allows you to create authorization policies based on hierarchical and nested structures within your data and be visualized as graphs where nodes can be represented as resources/identities and edges as relationships.</p>&#13;
&#13;
<p>Since you can create authorization rules based on relationships, this can save you lots of time setting permissions at an instance level.&#13;
As an example, instead of sharing every private LLM conversation in your app one by one, you can group them under a team or a folder and share the folder or add members to the team instead.&#13;
In ReBAC, children instances can inherit parent’s permissions, as shown in <a data-type="xref" href="#rebac_example">Figure 8-14</a>.&#13;
It’s the same for related instances if needed.</p>&#13;
&#13;
<figure><div class="figure" id="rebac_example">&#13;
<img alt="bgai 0814" src="assets/bgai_0814.png"/>&#13;
<h6><span class="label">Figure 8-14. </span>Example ReBAC where a user can see the team’s private conversations and threads</h6>&#13;
</div></figure>&#13;
&#13;
<p>The example shown in <a data-type="xref" href="#rebac_example">Figure 8-14</a> demonstrates both organization and hierarchical relationships between users (i.e., teams and members) and resources (conversations and threads).</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>If you decide to adopt the ReBAC model, I recommend visually mapping out the relationships between resources and identities in your application.</p>&#13;
&#13;
<p>This work includes mapping out <em>policies</em> (i.e., rules), <em>resources</em> and available <em>actions</em> on them, <em>resource-level roles</em>, and <em>relationships</em> between entities.</p>&#13;
</div>&#13;
&#13;
<p>A big problem that ReBAC solves by extending RBAC is the explosion of roles within the RBAC model by combining relationships with roles.&#13;
It is ideal for managing permissions in complex hierarchical structures and allows for reverse queries, enabling efficient permission definitions using teams and groups.&#13;
However, ReBAC can be complex to implement and maintain, resource-intensive, difficult to audit, and not as fine-grained as ABAC for dynamic permissions based on attributes like<a data-startref="ix_ch08-asciidoc25" data-type="indexterm" id="id1023"/><a data-startref="ix_ch08-asciidoc24" data-type="indexterm" id="id1024"/> time or &#13;
<span class="keep-together">location.</span></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Attribute-Based Access Control" data-type="sect2"><div class="sect2" id="id132">&#13;
<h2>Attribute-Based Access Control</h2>&#13;
&#13;
<p><a data-primary="attribute-based access control (ABAC)" data-type="indexterm" id="id1025"/><a data-primary="ABAC (attribute-based access control)" data-type="indexterm" id="id1026"/><a data-primary="authorization" data-secondary="authorization models" data-tertiary="attribute-based access control" data-type="indexterm" id="id1027"/><em>Attribute-based access control</em> authorization model expands basic RBAC roles by setting access control rules based on <em>conditions applied to attributes</em> to implement more granular policies.&#13;
As an example, ABAC can prevent users from uploading sensitive documents into your RAG-enabled services if the document contains <em>personally identifiable information (PII)</em> (i.e., <code>upload.has_pii=true</code>).</p>&#13;
&#13;
<p>Another example of ABAC can be seen in SaaS applications like ChatGPT where only paid users have access to the service’s premium GenAI models (see <a data-type="xref" href="#abac_example">Figure 8-15</a>).</p>&#13;
&#13;
<figure><div class="figure" id="abac_example">&#13;
<img alt="bgai 0815" src="assets/bgai_0815.png"/>&#13;
<h6><span class="label">Figure 8-15. </span>ABAC example where only paid users have access to premium GenAI &#13;
<span class="keep-together">models</span></h6>&#13;
</div></figure>&#13;
&#13;
<p>Since the freedom to set policies based on attributes is infinite, the ABAC model allows for significantly fine-grained authorization policies.&#13;
However, ABAC can be cumbersome for managing hierarchical structures, making it challenging to determine which users have access to a specific resource.&#13;
For example, if you have a policy that grants access based on attributes like user role, data sensitivity level, and project membership, determining all users who can access a specific dataset requires evaluating these attributes for every user.</p>&#13;
&#13;
<p>While less complicated than ReBAC, ABAC can still be challenging to implement, in particular in large and complex applications that support a large number of roles, users, and attributes.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Hybrid Authorization Models" data-type="sect2"><div class="sect2" id="id133">&#13;
<h2>Hybrid Authorization Models</h2>&#13;
&#13;
<p><a data-primary="authorization" data-secondary="authorization models" data-tertiary="hybrid models" data-type="indexterm" id="ix_ch08-asciidoc26"/>If you’ve worked with larger applications in the past, you will notice that they combine features of the RBAC, ReBAC, and ABAC authorization models.&#13;
For instance, administrators may have access to any resource and user management/authentication features (RBAC), and users can share their private resources by setting visibility attribute to <code>public</code> (ABAC) and can add members to their team for collaborating on private resources.</p>&#13;
&#13;
<p>A hybrid approach combining RBAC, ReBAC, and ABAC models may give you the strengths of all the authorization models:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>RBAC simplifies permission management by assigning roles to users, making it easy to manage and audit.</p>&#13;
</li>&#13;
<li>&#13;
<p>ReBAC is perfect for managing hierarchical relationships and reverse queries, making it suitable for complex hierarchical structures.</p>&#13;
</li>&#13;
<li>&#13;
<p>ABAC provides fine-grained control based on user and resource attributes, allowing for dynamic and context-aware permissions.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p><a data-type="xref" href="#authorization_hybrid">Figure 8-16</a> demonstrates the hybrid authorization model.</p>&#13;
&#13;
<figure><div class="figure" id="authorization_hybrid">&#13;
<img alt="bgai 0816" src="assets/bgai_0816.png"/>&#13;
<h6><span class="label">Figure 8-16. </span>Hybrid authorization model based on roles, relationships, and attributes</h6>&#13;
</div></figure>&#13;
&#13;
<p>To implement the hybrid authorization combining RBAC, ReBAC, and ABAC models, you can follow <a data-type="xref" href="#rbac_rebac_abac">Example 8-21</a>.</p>&#13;
<div data-type="example" id="rbac_rebac_abac">&#13;
<h5><span class="label">Example 8-21. </span>Implementing the hybrid authorization model combining RBAC, ReBAC, and ABAC</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># dependencies/auth.py</code>&#13;
&#13;
<code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Annotated</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">Depends</code><code class="p">,</code> <code class="n">HTTPException</code><code class="p">,</code> <code class="n">status</code>&#13;
<code class="o">...</code>  <code class="c1"># import services and entities here</code>&#13;
&#13;
<code class="n">CurrentUserDep</code> <code class="o">=</code> <code class="n">Annotated</code><code class="p">[</code><code class="n">User</code><code class="p">,</code> <code class="n">Depends</code><code class="p">(</code><code class="n">AuthService</code><code class="o">.</code><code class="n">get_current_user</code><code class="p">)]</code>&#13;
<code class="n">TeamMembershipRep</code> <code class="o">=</code> <code class="n">Annotated</code><code class="p">[</code><code class="n">Team</code><code class="p">,</code> <code class="n">Depends</code><code class="p">(</code><code class="n">TeamService</code><code class="o">.</code><code class="n">get_current_team</code><code class="p">)]</code>&#13;
<code class="n">ResourceDep</code> <code class="o">=</code> <code class="n">Annotated</code><code class="p">[</code><code class="n">Resource</code><code class="p">,</code> <code class="n">Depends</code><code class="p">(</code><code class="n">ResourceService</code><code class="o">.</code><code class="n">get_resource</code><code class="p">)]</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">authorize</code><code class="p">(</code>&#13;
    <code class="n">user</code><code class="p">:</code> <code class="n">CurrentUserDep</code><code class="p">,</code> <code class="n">resource</code><code class="p">:</code> <code class="n">ResourceDep</code><code class="p">,</code> <code class="n">team</code><code class="p">:</code> <code class="n">TeamMembershipRep</code>&#13;
<code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">bool</code><code class="p">:</code>&#13;
    <code class="k">if</code> <code class="n">user</code><code class="o">.</code><code class="n">role</code> <code class="o">==</code> <code class="s2">"ADMIN"</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="kc">True</code>&#13;
    <code class="k">if</code> <code class="n">user</code><code class="o">.</code><code class="n">id</code> <code class="ow">in</code> <code class="n">team</code><code class="o">.</code><code class="n">members</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="kc">True</code>&#13;
    <code class="k">if</code> <code class="n">resource</code><code class="o">.</code><code class="n">is_public</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="kc">True</code>&#13;
    <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code>&#13;
        <code class="n">status_code</code><code class="o">=</code><code class="n">status</code><code class="o">.</code><code class="n">HTTP_403_FORBIDDEN</code><code class="p">,</code> <code class="n">detail</code><code class="o">=</code><code class="s2">"Access Denied"</code>&#13;
    <code class="p">)</code>&#13;
&#13;
<code class="c1"># routes/resource.py</code>&#13;
&#13;
<code class="kn">from</code> <code class="nn">dependencies.auth</code> <code class="kn">import</code> <code class="n">authorize</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">APIRouter</code><code class="p">,</code> <code class="n">Depends</code>&#13;
&#13;
<code class="n">router</code> <code class="o">=</code> <code class="n">APIRouter</code><code class="p">(</code>&#13;
    <code class="n">dependencies</code><code class="o">=</code><code class="p">[</code><code class="n">Depends</code><code class="p">(</code><code class="n">authorize</code><code class="p">)],</code> <code class="n">prefix</code><code class="o">=</code><code class="s2">"/generate"</code><code class="p">,</code> <code class="n">tags</code><code class="o">=</code><code class="p">[</code><code class="s2">"Resource"</code><code class="p">]</code>&#13;
<code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/image"</code><code class="p">)</code>&#13;
<code class="k">async</code> <code class="k">def</code> <code class="nf">generate_image_controller</code><code class="p">():</code> <code class="o">...</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/text"</code><code class="p">)</code>&#13;
<code class="k">async</code> <code class="k">def</code> <code class="nf">generate_text_controller</code><code class="p">():</code> <code class="o">...</code></pre></div>&#13;
&#13;
<p>As you define rules and permissions based on each authorization model, you also may decide to bypass rules if certain conditions are met.&#13;
This can lead to complex logic and create a maintenance burden on your application code.</p>&#13;
&#13;
<p>Since implementing a hybrid model can be complex, you may consider developing a separate authorization service to eliminate the need for significant code changes with volatile permissions that change frequently.</p>&#13;
&#13;
<p><a data-primary="external authorization service" data-type="indexterm" id="ix_ch08-asciidoc27"/>Using an external system for authorization decisions allows your application’s authorization logic to remain consistent, as shown in <a data-type="xref" href="#authz_separate">Figure 8-17</a>.</p>&#13;
&#13;
<figure><div class="figure" id="authz_separate">&#13;
<img alt="bgai 0817" src="assets/bgai_0817.png"/>&#13;
<h6><span class="label">Figure 8-17. </span>Separating the authorization service from the GenAI service</h6>&#13;
</div></figure>&#13;
&#13;
<p><a data-type="xref" href="#authorization_separate_example">Example 8-22</a> shows how to develop a separate authorization system.</p>&#13;
<div data-type="example" id="authorization_separate_example">&#13;
<h5><span class="label">Example 8-22. </span>Using an authorization service with the GenAI service</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># authorization_api.py (Authorization Service)</code>&#13;
&#13;
<code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Annotated</code><code class="p">,</code> <code class="n">Literal</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">Depends</code><code class="p">,</code> <code class="n">FastAPI</code>&#13;
<code class="kn">from</code> <code class="nn">pydantic</code> <code class="kn">import</code> <code class="n">BaseModel</code>&#13;
&#13;
<code class="o">...</code>  <code class="c1"># import services and entities here</code>&#13;
&#13;
<code class="n">CurrentUserDep</code> <code class="o">=</code> <code class="n">Annotated</code><code class="p">[</code><code class="n">User</code><code class="p">,</code> <code class="n">Depends</code><code class="p">(</code><code class="n">AuthService</code><code class="o">.</code><code class="n">get_current_user</code><code class="p">)]</code>&#13;
<code class="n">ActionRep</code> <code class="o">=</code> <code class="n">Annotated</code><code class="p">[</code><code class="n">Literal</code><code class="p">[</code><code class="s2">"READ"</code><code class="p">,</code> <code class="s2">"CREATE"</code><code class="p">,</code> <code class="s2">"UPDATE"</code><code class="p">,</code> <code class="s2">"DELETE"</code><code class="p">],</code> <code class="nb">str</code><code class="p">]</code>&#13;
<code class="n">ResourceDep</code> <code class="o">=</code> <code class="n">Annotated</code><code class="p">[</code><code class="n">Resource</code><code class="p">,</code> <code class="n">Depends</code><code class="p">(</code><code class="n">ResourceService</code><code class="o">.</code><code class="n">get_resource</code><code class="p">)]</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">AuthorizationResponse</code><code class="p">(</code><code class="n">BaseModel</code><code class="p">):</code>&#13;
    <code class="n">allowed</code><code class="p">:</code> <code class="nb">bool</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="n">app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/authorize"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">authorization_controller</code><code class="p">(</code>&#13;
    <code class="n">user</code><code class="p">:</code> <code class="n">CurrentUserDep</code><code class="p">,</code> <code class="n">resource</code><code class="p">:</code> <code class="n">ResourceDep</code><code class="p">,</code> <code class="n">action</code><code class="p">:</code> <code class="n">ActionRep</code>&#13;
<code class="p">)</code> <code class="o">-&gt;</code> <code class="n">AuthorizationResponse</code><code class="p">:</code>&#13;
    <code class="k">if</code> <code class="n">user</code><code class="o">.</code><code class="n">role</code> <code class="o">==</code> <code class="s2">"ADMIN"</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="n">AuthorizationResponse</code><code class="p">(</code><code class="n">allowed</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="n">action</code> <code class="ow">in</code> <code class="n">user</code><code class="o">.</code><code class="n">permissions</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">resource</code><code class="o">.</code><code class="n">id</code><code class="p">,</code> <code class="p">[]):</code>&#13;
        <code class="k">return</code> <code class="n">AuthorizationResponse</code><code class="p">(</code><code class="n">allowed</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>&#13;
    <code class="o">...</code>  <code class="c1"># Other permission checks</code>&#13;
    <code class="k">return</code> <code class="n">AuthorizationResponse</code><code class="p">(</code><code class="n">allowed</code><code class="o">=</code><code class="kc">False</code><code class="p">)</code>&#13;
&#13;
<code class="c1"># genai_api.py (GenAI Service)</code>&#13;
&#13;
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">APIRouter</code><code class="p">,</code> <code class="n">HTTPException</code><code class="p">,</code> <code class="n">status</code>&#13;
<code class="kn">from</code> <code class="nn">pydantic</code> <code class="kn">import</code> <code class="n">BaseModel</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">AuthorizationData</code><code class="p">(</code><code class="n">BaseModel</code><code class="p">):</code>&#13;
    <code class="n">user_id</code><code class="p">:</code> <code class="nb">int</code>&#13;
    <code class="n">resource_id</code><code class="p">:</code> <code class="nb">int</code>&#13;
    <code class="n">action</code><code class="p">:</code> <code class="nb">str</code>&#13;
&#13;
<code class="n">authorization_client</code> <code class="o">=</code> <code class="o">...</code>  <code class="c1"># Create authorization client</code>&#13;
&#13;
<code class="k">async</code> <code class="k">def</code> <code class="nf">enforce</code><code class="p">(</code><code class="n">data</code><code class="p">:</code> <code class="n">AuthorizationData</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">bool</code><code class="p">:</code>&#13;
    <code class="n">response</code> <code class="o">=</code> <code class="k">await</code> <code class="n">authorization_client</code><code class="o">.</code><code class="n">decide</code><code class="p">(</code><code class="n">data</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="n">response</code><code class="o">.</code><code class="n">allowed</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="kc">True</code>&#13;
    <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code>&#13;
        <code class="n">status_code</code><code class="o">=</code><code class="n">status</code><code class="o">.</code><code class="n">HTTP_403_FORBIDDEN</code><code class="p">,</code> <code class="n">detail</code><code class="o">=</code><code class="s2">"Access Denied"</code>&#13;
    <code class="p">)</code>&#13;
&#13;
<code class="n">router</code> <code class="o">=</code> <code class="n">APIRouter</code><code class="p">(</code>&#13;
    <code class="n">dependencies</code><code class="o">=</code><code class="p">[</code><code class="n">Depends</code><code class="p">(</code><code class="n">enforce</code><code class="p">)],</code> <code class="n">prefix</code><code class="o">=</code><code class="s2">"/generate"</code><code class="p">,</code> <code class="n">tags</code><code class="o">=</code><code class="p">[</code><code class="s2">"Resource"</code><code class="p">]</code>&#13;
<code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/text"</code><code class="p">)</code>&#13;
<code class="k">async</code> <code class="k">def</code> <code class="nf">generate_text_controller</code><code class="p">():</code>&#13;
    <code class="o">...</code></pre></div>&#13;
&#13;
<p>As you can see in <a data-type="xref" href="#authorization_separate_example">Example 8-22</a>, using an external system to authorize user actions on resources helps you and your team to modularize authorization logic with more complex and volatile permission requirements.<a data-startref="ix_ch08-asciidoc27" data-type="indexterm" id="id1028"/></p>&#13;
&#13;
<p>However, since developing a complex external authorization service from scratch can take a lot of your time, you may want to consider using authorization providers (such as Oso, Permify, Okta/Auth0, etc.) with your authentication<a data-startref="ix_ch08-asciidoc26" data-type="indexterm" id="id1029"/>.<a data-startref="ix_ch08-asciidoc20" data-type="indexterm" id="id1030"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="id444">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>In this chapter, you learned about both authentication and authorization mechanisms to secure your GenAI services.</p>&#13;
&#13;
<p>Earlier in the chapter, you were introduced to several authentication methods, including basic, token-based, OAuth, and key-based authentication.&#13;
To gain hands-on experience, you implemented several authentication systems from scratch in your FastAPI service, which helped you understand the underlying mechanisms.&#13;
This included managing user passwords, creating and using JWT access tokens, and implementing authentication flows for user verification.&#13;
Additionally, you learned how to integrate your services with identity providers like GitHub using the OAuth2 standard to authenticate users and access external user resources in your application.</p>&#13;
&#13;
<p>While you were building the authentication system, you also learned about attack vectors such as credential stuffing, password spraying, cross-site request forgery, open redirect, and phishing attacks.</p>&#13;
&#13;
<p>Furthermore, you explored authorization systems that determine and enforce access levels based on authorization data and logic.&#13;
You learned how authorization systems can become complex and how different models, including RBAC, ReBAC, and ABAC, can assist in managing permissions in your applications.</p>&#13;
&#13;
<p>In the next chapter, you will focus on testing, including writing unit, integration, end-to-end, and regression tests.&#13;
You’ll be introduced to concepts like testing boundaries, coverage, mocking, patching, parameterization, isolation, and idempotency, which will help you write maintainable and effective tests as your applications grow in complexity.&#13;
Specifically, you’ll learn how to test GenAI services that use probabilistic models and interface with asynchronous systems.</p>&#13;
</div></section>&#13;
<div data-type="footnotes"><p data-type="footnote" id="id970"><sup><a href="ch08.html#id970-marker">1</a></sup> Open Worldwide Application Security Project is an online community that produces resources on system software and web application security.</p><p data-type="footnote" id="id971"><sup><a href="ch08.html#id971-marker">2</a></sup> Key-based authentication won’t be discussed further as it involves complex cryptographic principles that are beyond the scope of this chapter.</p><p data-type="footnote" id="id972"><sup><a href="ch08.html#id972-marker">3</a></sup> In a <em>timing attack</em>, attackers try to guess passwords by comparing and analyzing elapsed password evaluation times with the password length. Therefore, to prevent timing attacks, cryptographic algorithms must check passwords within a constant time span.</p><p data-type="footnote" id="id982"><sup><a href="ch08.html#id982-marker">4</a></sup> Typical salt lengths include 16 bytes (128 bits) for balancing performance and security, or 32 bytes (256 bits) for securing sensitive systems. You can use cryptographic libraries such as <code>passlib</code> to generate these salts  <span class="keep-together">correctly.</span></p><p data-type="footnote" id="id994"><sup><a href="ch08.html#id994-marker">5</a></sup> For up-to-date instructions, please visit <a href="https://oreil.ly/tWg6w">the GitHub documentation</a>.</p></div></div></section></body></html>
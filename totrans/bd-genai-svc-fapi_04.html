<html><head></head><body><section data-pdf-bookmark="Chapter 2. Getting Started with FastAPI" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch02">&#13;
<h1><span class="label">Chapter 2. </span>Getting Started with FastAPI</h1>&#13;
&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id505">&#13;
<h1>Chapter Goals</h1>&#13;
<p><a data-primary="FastAPI (basics)" data-type="indexterm" id="ix_ch02-asciidoc0"/>In this chapter, you will learn about:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>What FastAPI is</p>&#13;
</li>&#13;
<li>&#13;
<p>How to get started with creating your own FastAPI project</p>&#13;
</li>&#13;
<li>&#13;
<p>FastAPI features and advantages</p>&#13;
</li>&#13;
<li>&#13;
<p>How to structure FastAPI projects</p>&#13;
</li>&#13;
<li>&#13;
<p>The onion/layered software design pattern</p>&#13;
</li>&#13;
<li>&#13;
<p>Comparison of FastAPI to other frameworks</p>&#13;
</li>&#13;
<li>&#13;
<p>FastAPI limitations</p>&#13;
</li>&#13;
<li>&#13;
<p>Setting up a managed Python environment and tooling for your project</p>&#13;
</li>&#13;
</ul>&#13;
</div></aside>&#13;
&#13;
<p>By the end of this chapter, you should feel comfortable using the FastAPI web framework, setting up FastAPI projects, and articulating your tech stack decisions for building GenAI services.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Introduction to FastAPI" data-type="sect1"><div class="sect1" id="id236">&#13;
<h1>Introduction to FastAPI</h1>&#13;
&#13;
<p><a href="https://oreil.ly/2xcoR">FastAPI</a> is <a data-primary="Asynchronous Server Gateway Interface (ASGI)" data-secondary="FastAPI as" data-type="indexterm" id="id506"/>an asynchronous gateway interface (ASGI) web framework that enables you to build lean APIs and backend web servers.&#13;
Being &#13;
<span class="keep-together">an ASGI</span> framework means that it can leverage concurrency to process web requests.&#13;
It is <a href="https://oreil.ly/tgwEJ">fast comparable to modern frameworks</a> but also ships &#13;
<span class="keep-together">with strong</span> <a href="https://oreil.ly/WlwOC">Swagger/OpenAPI integrations for auto-documentation</a>, alongside built-in data validation and serialization features via <a href="https://oreil.ly/5-EmU">Pydantic</a>.<sup><a data-type="noteref" href="ch02.html#id507" id="id507-marker">1</a></sup> Effectively, FastAPI is a wrapper over the <a href="https://oreil.ly/tyKtQ">Starlette framework</a>, built by Encode, the same people who built the Django REST framework.&#13;
It is light-weight and has a similar development experience.</p>&#13;
&#13;
<p>Before we discuss FastAPI in more detail, let’s set up your development environment with a running FastAPI application.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Setting Up Your Development Environment" data-type="sect1"><div class="sect1" id="id14">&#13;
<h1>Setting Up Your Development Environment</h1>&#13;
&#13;
<p><a data-primary="development environment setup, FastAPI" data-type="indexterm" id="ix_ch02-asciidoc1"/><a data-primary="FastAPI (basics)" data-secondary="development environment setup" data-type="indexterm" id="ix_ch02-asciidoc2"/>Throughout the rest of this chapter, I will guide you through the installation process of FastAPI and its essential dependencies, enabling you to set up a basic web server.&#13;
We will also install a selection of formatters, loggers, and linters that you can set up to enhance your development workflow.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>Code examples in this book have been tested against Python 3.11. Running code examples with other Python versions may result in issues.&#13;
Furthermore, some deployment environments and package dependencies may not support the latest versions of Python.</p>&#13;
</div>&#13;
&#13;
<p>You can now get started with setting up your FastAPI project.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Installing Python, FastAPI, and Required Packages" data-type="sect2"><div class="sect2" id="id237">&#13;
<h2>Installing Python, FastAPI, and Required Packages</h2>&#13;
&#13;
<p><a data-primary="development environment setup, FastAPI" data-secondary="installing Python/Fast API/required packages" data-type="indexterm" id="id508"/><a data-primary="FastAPI (basics)" data-secondary="development environment setup" data-tertiary="installing Python/Fast API/required packages" data-type="indexterm" id="id509"/><a data-primary="Python" data-secondary="installing" data-type="indexterm" id="id510"/>If you’re on Windows, you can use <code>conda</code> to create a virtual Python environment:</p>&#13;
&#13;
<pre data-type="programlisting">conda create -n genaiservice python=3.11&#13;
conda activate genaiservice</pre>&#13;
&#13;
<p>If you’re on a macOS or a Linux system, you can create a virtual Python environment using <code>venv</code>:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">$<code class="w"> </code>python3<code class="w"> </code>-m<code class="w"> </code>venv<code class="w"> </code>.venv<code class="w"/></pre>&#13;
&#13;
<p><code>venv</code> creates your virtual environment in the <code>.venv</code> folder that you can activate by using this:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">$<code class="w"> </code><code class="nb">source</code><code class="w"> </code>.venv/bin/activate<code class="w"/></pre>&#13;
&#13;
<p>Once the environment is activated, you can install the core packages needed to run the FastAPI server and serve requests from the OpenAI API:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">$<code class="w"> </code>pip<code class="w"> </code>install<code class="w"> </code><code class="s2">"fastapi[standard]"</code><code class="w"> </code>uvicorn<code class="w"> </code>openai<code class="w"/></pre>&#13;
&#13;
<p>The <code>uvicorn</code> package is the bare-bones web server that FastAPI runs on.&#13;
<code>fastapi</code> will also install its dependency packages such as <code>starlette</code> and <code>pydantic</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating a Simple FastAPI Web Server" data-type="sect2"><div class="sect2" id="id15">&#13;
<h2>Creating a Simple FastAPI Web Server</h2>&#13;
&#13;
<p><a data-primary="development environment setup, FastAPI" data-secondary="creating a simple FastAPI web server" data-type="indexterm" id="ix_ch02-asciidoc3"/><a data-primary="FastAPI (basics)" data-secondary="development environment setup" data-tertiary="creating a simple FastAPI web server" data-type="indexterm" id="ix_ch02-asciidoc4"/><a data-primary="web server, creating simple" data-type="indexterm" id="ix_ch02-asciidoc5"/>Once FastAPI and its dependencies are installed, you are ready to start your own web server.&#13;
To create a simple web server that has one endpoint in FastAPI, all you have to write is 15 lines of code.&#13;
Create a <em>main.py</em> file in the root of your directory, as shown in <a data-type="xref" href="#simple_fastapi_web_server">Example 2-1</a>.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>For simplicity, <a data-type="xref" href="#simple_fastapi_web_server">Example 2-1</a> uses the OpenAI API.&#13;
To run the code, you can get an API key from <a href="https://oreil.ly/SZsuD">OpenAI</a>, which requires a credit card.&#13;
However, rest assured that other code examples in this book will use open source models as much as &#13;
<span class="keep-together">possible.</span></p>&#13;
</div>&#13;
<div data-type="example" id="simple_fastapi_web_server">&#13;
<h5><span class="label">Example 2-1. </span>Starter code for a simple FastAPI web server serving GPT-4o requests</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># main.py</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">fastapi</code><code> </code><code class="kn">import</code><code> </code><code class="n">FastAPI</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">openai</code><code> </code><code class="kn">import</code><code> </code><code class="n">OpenAI</code><code>&#13;
</code><code>&#13;
</code><code class="n">app</code><code> </code><code class="o">=</code><code> </code><code class="n">FastAPI</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_getting_started_with_fastapi_CO1-1" id="co_getting_started_with_fastapi_CO1-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="n">openai_client</code><code> </code><code class="o">=</code><code> </code><code class="n">OpenAI</code><code class="p">(</code><code class="n">api_key</code><code class="o">=</code><code class="s2">"</code><em><code class="s2">your_api_key</code></em><code class="s2">"</code><code class="p">)</code><code> </code><a class="co" href="#callout_getting_started_with_fastapi_CO1-2" id="co_getting_started_with_fastapi_CO1-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">/</code><code class="s2">"</code><code class="p">)</code><code>&#13;
</code><code class="k">def</code><code> </code><code class="nf">root_controller</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="p">{</code><code class="s2">"</code><code class="s2">status</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="s2">"</code><code class="s2">healthy</code><code class="s2">"</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">/chat</code><code class="s2">"</code><code class="p">)</code><code> </code><a class="co" href="#callout_getting_started_with_fastapi_CO1-3" id="co_getting_started_with_fastapi_CO1-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="k">def</code><code> </code><code class="nf">chat_controller</code><code class="p">(</code><code class="n">prompt</code><code class="p">:</code><code> </code><code class="nb">str</code><code> </code><code class="o">=</code><code> </code><code class="s2">"</code><code class="s2">Inspire me</code><code class="s2">"</code><code class="p">)</code><code class="p">:</code><code> </code><a class="co" href="#callout_getting_started_with_fastapi_CO1-3" id="co_getting_started_with_fastapi_CO1-4"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>    </code><code class="n">response</code><code> </code><code class="o">=</code><code> </code><code class="n">openai_client</code><code class="o">.</code><code class="n">chat</code><code class="o">.</code><code class="n">completions</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code> </code><a class="co" href="#callout_getting_started_with_fastapi_CO1-4" id="co_getting_started_with_fastapi_CO1-5"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>        </code><code class="n">model</code><code class="o">=</code><code class="s2">"</code><code class="s2">gpt-4o</code><code class="s2">"</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="n">messages</code><code class="o">=</code><code class="p">[</code><code>&#13;
</code><code>            </code><code class="p">{</code><code class="s2">"</code><code class="s2">role</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="s2">"</code><code class="s2">system</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">content</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="s2">"</code><code class="s2">You are a helpful assistant.</code><code class="s2">"</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="p">{</code><code class="s2">"</code><code class="s2">role</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="s2">"</code><code class="s2">user</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">content</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="n">prompt</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="p">]</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="p">)</code><code>&#13;
</code><code>    </code><code class="n">statement</code><code> </code><code class="o">=</code><code> </code><code class="n">response</code><code class="o">.</code><code class="n">choices</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="o">.</code><code class="n">message</code><code class="o">.</code><code class="n">content</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="p">{</code><code class="s2">"</code><code class="s2">statement</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="n">statement</code><code class="p">}</code><code> </code><a class="co" href="#callout_getting_started_with_fastapi_CO1-5" id="co_getting_started_with_fastapi_CO1-6"><img alt="5" src="assets/5.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_getting_started_with_fastapi_CO1-1" id="callout_getting_started_with_fastapi_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Create a FastAPI application object.</p></dd>&#13;
<dt><a class="co" href="#co_getting_started_with_fastapi_CO1-2" id="callout_getting_started_with_fastapi_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>You will need an <a href="https://oreil.ly/PP0nN">API key</a> to use the OpenAI API.</p></dd>&#13;
<dt><a class="co" href="#co_getting_started_with_fastapi_CO1-3" id="callout_getting_started_with_fastapi_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Use the <code>@app.get</code> decorator to create a <code>GET</code> endpoint on the <code>/chat</code> path.</p></dd>&#13;
<dt><a class="co" href="#co_getting_started_with_fastapi_CO1-5" id="callout_getting_started_with_fastapi_CO1-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Make an API call to the OpenAI Completions API to generate a response from the <code>gpt-4o</code> model.</p></dd>&#13;
<dt><a class="co" href="#co_getting_started_with_fastapi_CO1-6" id="callout_getting_started_with_fastapi_CO1-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Any data returned by the decorated function will be returned when you hit the root endpoint.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>You can now start the server using the <code>fastapi dev</code> command, as shown here:<sup><a data-type="noteref" href="ch02.html#id511" id="id511-marker">2</a></sup></p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">$<code class="w"> </code>fastapi<code class="w"> </code>dev<code class="w"/>&#13;
&#13;
&gt;&gt;<code class="w"> </code>server<code class="w">   </code>Server<code class="w"> </code>started<code class="w"> </code>at<code class="w"> </code>http://127.0.0.1:8000<code class="w"/>&#13;
&gt;&gt;<code class="w"> </code>server<code class="w">   </code>Documentation<code class="w"> </code>at<code class="w"> </code>http://127.0.0.1:8000/docs<code class="w"/>&#13;
&#13;
&gt;&gt;<code class="w"> </code>INFO<code class="w">   </code>Uvicorn<code class="w"> </code>running<code class="w"> </code>on<code class="w"> </code>http://127.0.0.1:8000<code class="w"> </code><code class="o">(</code>Press<code class="w"> </code>CTRL+C<code class="w"> </code>to<code class="w"> </code>quit<code class="o">)</code><code class="w"/>&#13;
&gt;&gt;<code class="w"> </code>INFO<code class="w">   </code>Started<code class="w"> </code>reloader<code class="w"> </code>process<code class="w"> </code><code class="o">[</code><code class="m">4172</code><code class="o">]</code><code class="w"> </code>using<code class="w"> </code>WatchFiles<code class="w"/>&#13;
&gt;&gt;<code class="w"> </code>INFO<code class="w">   </code>Started<code class="w"> </code>server<code class="w"> </code>process<code class="w"> </code><code class="o">[</code><code class="m">11316</code><code class="o">]</code><code class="w"/>&#13;
&gt;&gt;<code class="w"> </code>INFO<code class="w">   </code>Waiting<code class="w"> </code><code class="k">for</code><code class="w"> </code>application<code class="w"> </code>startup.<code class="w"/>&#13;
&gt;&gt;<code class="w"> </code>INFO<code class="w">   </code>Application<code class="w"> </code>startup<code class="w"> </code>complete.<code class="w"/></pre>&#13;
&#13;
<p>Your web server is now accessible from <code>http://127.0.0.1:8000</code> with two exposed endpoints at the root <code>/</code> and <code>/chat</code> routes.</p>&#13;
&#13;
<p>If you visit <code>http://127.0.0.1:8000</code> in your browser, you should see the <code>{"status": "healthy"}</code> message.&#13;
Also, when you visit  <code>http://127.0.0.1:8000/chat</code>, you should see an inspirational message from OpenAI’s <code>gpt-4o</code> model.</p>&#13;
&#13;
<p>Congratulations.&#13;
You now have a fully working bare-bones generative AI service.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>As you started the server in a dev model using the <code>fastapi dev</code> command, a file watcher process is listening for changes in your project and auto-updates the service as you update the code.</p>&#13;
</div>&#13;
&#13;
<p>Feel free to change the default prompt and refresh the browser to see your changes reflected in real time.</p>&#13;
&#13;
<p>The <code>app</code> object—which is created from the <code>FastAPI</code> class—converts your Python function with a decorator into a Hypertext Transfer Protocol (HTTP) endpoint.&#13;
You can trigger both endpoints by sending an HTTP request.</p>&#13;
&#13;
<p>Under the hood, the <code>uvicorn</code> package takes the <code>app</code> object and starts a web server running your FastAPI service.</p>&#13;
&#13;
<p><a data-primary="auto-documentation" data-type="indexterm" id="id512"/><a data-primary="documentation, automatic generation of" data-type="indexterm" id="id513"/><a data-primary="FastAPI (basics)" data-secondary="automatic documentation" data-type="indexterm" id="id514"/><a data-primary="Swagger documentation" data-type="indexterm" id="id515"/>In addition to getting a simple web server out of the box, you also get API documentation automatically generated for you.&#13;
The documentation follows the OpenAPI standard and includes an <code>openapi.json</code> specification of your web service and a Swagger documentation page built from the same specification file.</p>&#13;
&#13;
<p>You can access the auto-generated docs page by going to the <code>/docs</code> route of your server via <code>http://localhost:8000/docs</code>; you’ll see a page similar to <a data-type="xref" href="#swagger_docs">Figure 2-1</a>.</p>&#13;
&#13;
<figure><div class="figure" id="swagger_docs">&#13;
<img alt="bgai 0201" src="assets/bgai_0201.png"/>&#13;
<h6><span class="label">Figure 2-1. </span>Auto-generated Swagger documentation of the API</h6>&#13;
</div></figure>&#13;
&#13;
<p>From the Swagger docs page, you can send requests to your API to quickly test an endpoint.&#13;
The docs page will also take care of sending the correct request headers, methods, and parameters.</p>&#13;
&#13;
<p>What I love about the Swagger docs page is that you can quickly iterate over various implementations using the user interface, which can be quicker than writing tests when iterating over the design of your APIs.&#13;
However, this does not replace the traditional testing that can check every endpoint when you make changes.&#13;
As your application grows, it is still worth writing tests.&#13;
Once your endpoint signatures are further established, you can write <code>pytest</code> tests to systematically test your web service from end to end.</p>&#13;
&#13;
<p><a data-primary="data serialization" data-type="indexterm" id="id516"/><a data-primary="data validation" data-type="indexterm" id="id517"/>In addition to auto-documentation, FastAPI ships with auto-serialization and validation of data.&#13;
In <a data-type="xref" href="#simple_fastapi_web_server">Example 2-1</a>, we returned a dictionary in the root controller as you visited <code>http://localhost:8000</code>.&#13;
There is a bit of magic that must happen for data to show up in your browser.&#13;
The data must first be serialized from a Python object such as a dictionary or a list into a JavaScript Object Notation (JSON) string first.&#13;
Afterward, it’s transferred over the web and deserialized back into a JavaScript object by your browser client once transmission is completed.&#13;
This is effectively how applications around the web “talk” to each other.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Serialization is required when using HTTP for data transmissions, as only text or binary data can be transferred via HTTP.<a data-startref="ix_ch02-asciidoc5" data-type="indexterm" id="id518"/><a data-startref="ix_ch02-asciidoc4" data-type="indexterm" id="id519"/><a data-startref="ix_ch02-asciidoc3" data-type="indexterm" id="id520"/></p>&#13;
</div>&#13;
&#13;
<p>Now that you have a working FastAPI server, let’s look at FastAPI’s features and benefits that you can use in your project.<a data-startref="ix_ch02-asciidoc2" data-type="indexterm" id="id521"/><a data-startref="ix_ch02-asciidoc1" data-type="indexterm" id="id522"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="FastAPI Features and Advantages" data-type="sect1"><div class="sect1" id="id238">&#13;
<h1>FastAPI Features and Advantages</h1>&#13;
&#13;
<p><a data-primary="FastAPI (basics)" data-secondary="features and advantages" data-type="indexterm" id="ix_ch02-asciidoc6"/>You want a suitable web framework that allows you to effortlessly create your generative AI services, without any unnecessary struggles.&#13;
This framework should include all the essential elements for security, authentication, and performance, while still granting you the flexibility to incorporate any additional features and integrations required as your application grows in complexity.</p>&#13;
&#13;
<p>FastAPI can meet most of these criteria, as it hosts several features and advantages out of the box.&#13;
However, as you’ll learn more about <a href="#fastapi_limitations">FastAPI limitations</a> later in this chapter, advanced use cases like resource-intensive AI workloads may require specialized web frameworks or solutions, as will be discussed in <a data-type="xref" href="ch03.html#ch03">Chapter 3</a>.</p>&#13;
&#13;
<p>For now, let’s review FastAPI’s features and benefits before discussing its limitations in the context of building generative AI services.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Inspired by Flask Routing Pattern" data-type="sect2"><div class="sect2" id="id439">&#13;
<h2>Inspired by Flask Routing Pattern</h2>&#13;
&#13;
<p>In both Flask and FastAPI, you can create any route by decorating a function with a specialized decorator.&#13;
You can then configure the routes to accept and validate headers, cookies, body, path, and query parameters to support your implementation.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Handling Asynchronous and Synchronous Operations" data-type="sect2"><div class="sect2" id="id16">&#13;
<h2>Handling Asynchronous and Synchronous Operations</h2>&#13;
&#13;
<p><a data-primary="asynchronous functions" data-type="indexterm" id="id523"/><a data-primary="concurrency" data-secondary="FastAPI and" data-type="indexterm" id="id524"/><a data-primary="FastAPI (basics)" data-secondary="handling asynchronous/synchronous operations" data-type="indexterm" id="id525"/>When building services, your service must be able to handle multiple requests by &#13;
<span class="keep-together">several</span> users to increase usage efficiency as demand scales.&#13;
FastAPI can seamlessly <a href="https://oreil.ly/gNYMg">handle both synchronous and asynchronous functions in your application</a> to enable concurrency from the get-go.</p>&#13;
&#13;
<p>As we will discuss in detail in <a data-type="xref" href="ch05.html#ch05">Chapter 5</a>, if you define an asynchronous route using <code>async def</code>, FastAPI will run it on the main thread on the main event loop.&#13;
<a data-primary="thread worker" data-type="indexterm" id="id526"/>On the other hand, if you define a synchronous route (not declared with the <code>async</code> keyword), FastAPI will run it on a <em>thread worker</em> for handling concurrent workloads.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>There is additional overhead to running threaded operations &#13;
<span class="keep-together">compared</span> to running them asynchronously.&#13;
Therefore, having many synchronous routes can still limit the scalability of your &#13;
<span class="keep-together">application.</span></p>&#13;
</div>&#13;
&#13;
<p>As a result, concurrent requests won’t block the main server thread.&#13;
This is particularly useful when dealing with input/output operations, such as querying databases, exchanging data with a graphical processing units (GPU),<sup><a data-type="noteref" href="ch02.html#id527" id="id527-marker">3</a></sup> or making HTTP requests.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Built-In Support for Background Tasks" data-type="sect2"><div class="sect2" id="id17">&#13;
<h2>Built-In Support for Background Tasks</h2>&#13;
&#13;
<p><a data-primary="background tasks (FastAPI mechanism)" data-type="indexterm" id="id528"/><a data-primary="FastAPI (basics)" data-secondary="background tasks" data-type="indexterm" id="id529"/>You can build routes capable of handling long-running tasks (e.g., sending emails) without the need of external libraries (e.g., <code>celery</code>).&#13;
FastAPI includes a <a href="https://oreil.ly/aO6ml">background tasks feature</a><sup><a data-type="noteref" href="ch02.html#id530" id="id530-marker">4</a></sup> for working with systems that need time to process data but you don’t want them to delay returning the responses to requests.</p>&#13;
&#13;
<p>Not all tasks can be responded to within the patience tolerance of your users.&#13;
You do not want to keep them waiting while the process is continuing to finish.&#13;
You can hand off the long-running operation to a background task running on a separate thread, after you respond to the client.&#13;
As a response, you can then let clients know that your service has accepted and queued their request to process it in the background.</p>&#13;
&#13;
<p>As an example, in GenAI services you can use background tasks to process large uploaded documents into a vector database without blocking the server.&#13;
This allows the server to handle other requests while the document processing happens in the background.</p>&#13;
&#13;
<p>You’ll learn how to build such a system in <a data-type="xref" href="ch05.html#ch05">Chapter 5</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Custom Middleware and CORS Support" data-type="sect2"><div class="sect2" id="id18">&#13;
<h2>Custom Middleware and CORS Support</h2>&#13;
&#13;
<p><a data-primary="CORS (cross-origin resource sharing)" data-type="indexterm" id="id531"/><a data-primary="cross-origin resource sharing (CORS)" data-type="indexterm" id="id532"/><a data-primary="FastAPI (basics)" data-secondary="custom middleware and CORS support" data-type="indexterm" id="id533"/><a data-primary="middleware" data-secondary="FastAPI and" data-type="indexterm" id="id534"/>FastAPI enables you to add <a href="https://oreil.ly/uvlLC">middleware components</a> to your app router to intercept the communication between your API endpoints and the clients.&#13;
Each middleware, sitting in front of your endpoints, allows you to access the request and response objects to modify them as needed.&#13;
You can add logic around how requests should be processed before they’re handed off to the route handlers.&#13;
Once the response is generated, you can then perform operations on the response—such as modifying headers, logging operations, and setting cookies—before sending it off to the client.</p>&#13;
&#13;
<p>A common pattern in backend development is to use middleware to <a href="https://oreil.ly/Yfsqg">add extra headers to a response</a>, perform basic checks on incoming requests, support <a href="https://oreil.ly/6u1dI">CORS requests</a>, <a href="ch03.html#middleware_monitoring">log and monitor communications</a>, and much more.&#13;
You can even take advantage of third-party and <a href="https://oreil.ly/AJKJt">custom middleware</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Freedom to Customize Any Service Layer" data-type="sect2"><div class="sect2" id="id19">&#13;
<h2>Freedom to Customize Any Service Layer</h2>&#13;
&#13;
<p><a data-primary="custom classes" data-type="indexterm" id="id535"/><a data-primary="FastAPI (basics)" data-secondary="service layer customization" data-type="indexterm" id="id536"/>There are times when you may want to break away from the limitations of your current web framework.&#13;
FastAPI provides a solution to this by allowing you to define custom classes that inherit base classes of Starlette—the underlying web framework.&#13;
For instance, you can <a href="https://oreil.ly/qgvgO">override default exception handlers</a>, add <a href="https://oreil.ly/1A8OD">custom ASGI middleware</a>, or even <a href="https://oreil.ly/jLXUf">create custom responses</a>.</p>&#13;
&#13;
<p>With the power of Pydantic or <a href="https://oreil.ly/MJmqJ">FastAPI’s encoders</a>, you can also effortlessly create your own <a href="https://oreil.ly/UnzRk">custom serializers</a> to adjust how datetime objects are handled.</p>&#13;
&#13;
<p>This enables you to implement features according to your preferences without having to struggle against FastAPI.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Data Validation and Serialization" data-type="sect2"><div class="sect2" id="id20">&#13;
<h2>Data Validation and Serialization</h2>&#13;
&#13;
<p><a data-primary="data serialization" data-type="indexterm" id="ix_ch02-asciidoc7"/><a data-primary="data validation" data-type="indexterm" id="ix_ch02-asciidoc8"/><a data-primary="FastAPI (basics)" data-secondary="data validation/serialization" data-type="indexterm" id="ix_ch02-asciidoc9"/><a data-primary="Pydantic" data-secondary="data validation/serialization" data-type="indexterm" id="ix_ch02-asciidoc10"/>For applications that handle large amounts of data, it is important that the data you are about to process is clean and in a known format.</p>&#13;
&#13;
<p>As the complexity of your service grows, you will want to perform data validation and serialization.&#13;
In FastAPI, you can use Pydantic to automatically serialize common data types (e.g., lists, dictionaries, primitives) when returning them in API routes.&#13;
You can also define your own Pydantic schemas for request and response data to perform stricter data validation.</p>&#13;
&#13;
<p>For instance, you can validate a user’s password on account creation to match your security policies, as shown in <a data-type="xref" href="#data_validation">Example 2-2</a>.</p>&#13;
<div class="less_space pagebreak-before" data-type="example" id="data_validation">&#13;
<h5><span class="label">Example 2-2. </span>Validating user passwords in FastAPI using a Pydantic schema</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># main.py</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">pydantic</code><code> </code><code class="kn">import</code><code> </code><code class="n">BaseModel</code><code class="p">,</code><code> </code><code class="n">Field</code><code class="p">,</code><code> </code><code class="n">EmailStr</code><code>&#13;
</code><code>&#13;
</code><code class="k">class</code><code> </code><code class="nc">UserCreate</code><code class="p">(</code><code class="n">BaseModel</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="n">username</code><code class="p">:</code><code> </code><code class="nb">str</code><code>&#13;
</code><code>    </code><code class="n">password</code><code class="p">:</code><code> </code><code class="nb">str</code><code>&#13;
</code><code>&#13;
</code><code>    </code><code class="nd">@validator</code><code class="p">(</code><code class="s1">'</code><code class="s1">password</code><code class="s1">'</code><code class="p">)</code><code> </code><a class="co" href="#callout_getting_started_with_fastapi_CO2-1" id="co_getting_started_with_fastapi_CO2-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">validate_password</code><code class="p">(</code><code class="bp">cls</code><code class="p">,</code><code> </code><code class="n">value</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="n">value</code><code class="p">)</code><code> </code><code class="o">&lt;</code><code> </code><code class="mi">8</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="k">raise</code><code> </code><code class="ne">ValueError</code><code class="p">(</code><code class="s1">'</code><code class="s1">Password must be at least 8 characters long</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="ow">not</code><code> </code><code class="nb">any</code><code class="p">(</code><code class="n">char</code><code class="o">.</code><code class="n">isdigit</code><code class="p">(</code><code class="p">)</code><code> </code><code class="k">for</code><code> </code><code class="n">char</code><code> </code><code class="ow">in</code><code> </code><code class="n">value</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="k">raise</code><code> </code><code class="ne">ValueError</code><code class="p">(</code><code class="s1">'</code><code class="s1">Password must contain at least one digit</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="ow">not</code><code> </code><code class="nb">any</code><code class="p">(</code><code class="n">char</code><code class="o">.</code><code class="n">isupper</code><code class="p">(</code><code class="p">)</code><code> </code><code class="k">for</code><code> </code><code class="n">char</code><code> </code><code class="ow">in</code><code> </code><code class="n">value</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="k">raise</code><code> </code><code class="ne">ValueError</code><code class="p">(</code><code class="s1">'</code><code class="s1">Password must contain at least one uppercase letter</code><code class="s1">'</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="n">value</code><code> </code><a class="co" href="#callout_getting_started_with_fastapi_CO2-2" id="co_getting_started_with_fastapi_CO2-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">app</code><code> </code><code class="o">=</code><code> </code><code class="n">FastAPI</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="nd">@app</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"</code><code class="s2">/users</code><code class="s2">"</code><code class="p">)</code><code>&#13;
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">create_user_controller</code><code class="p">(</code><code class="n">user</code><code class="p">:</code><code> </code><code class="n">UserCreate</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="p">{</code><code class="s2">"</code><code class="s2">name</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="n">user</code><code class="o">.</code><code class="n">name</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">message</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="s2">"</code><code class="s2">Account successfully created</code><code class="s2">"</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="o">.</code><code class="o">.</code><code class="o">.</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_getting_started_with_fastapi_CO2-1" id="callout_getting_started_with_fastapi_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Define a Pydantic model with custom data validation on the <code>password</code> field.</p></dd>&#13;
<dt><a class="co" href="#co_getting_started_with_fastapi_CO2-2" id="callout_getting_started_with_fastapi_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Raise a <code>ValueError</code> if any of the password policies are not met.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>This enables you to catch, handle, and protect your services from data issues that are not captured by static type checkers like <code>mypy</code>.</p>&#13;
&#13;
<p>Pydantic validators also allow you to validate more complex data types at runtime like emails, URLs, UUIDs, and more.&#13;
<a data-type="xref" href="ch04.html#ch04">Chapter 4</a> will go into more detail on how to perform data validation using Pydantic.<a data-startref="ix_ch02-asciidoc10" data-type="indexterm" id="id537"/><a data-startref="ix_ch02-asciidoc9" data-type="indexterm" id="id538"/><a data-startref="ix_ch02-asciidoc8" data-type="indexterm" id="id539"/><a data-startref="ix_ch02-asciidoc7" data-type="indexterm" id="id540"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Rich Ecosystem of Plug-Ins" data-type="sect2"><div class="sect2" id="id21">&#13;
<h2>Rich Ecosystem of Plug-Ins</h2>&#13;
&#13;
<p><a data-primary="FastAPI (basics)" data-secondary="plug-ins for" data-type="indexterm" id="id541"/><a data-primary="plug-ins" data-type="indexterm" id="id542"/>Plug-ins are Python packages that hook into FastAPI internals and existing features.&#13;
They are similar to any other Python package you install and import into your scripts, and they require minimal configurations after installation.&#13;
Integrating them means extending the functionalities of your service without having to deal with order of integrations or compatibility issues.&#13;
You can also remove them without breaking your app.</p>&#13;
&#13;
<p class="less_space pagebreak-before">Some  well-known plug-ins include FastAPI Filters, Auth Users, Rate Limiting and several others, which you can view at the <a href="https://oreil.ly/nKbvP">Awesome FastAPI GitHub repository</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Automatic Documentation" data-type="sect2"><div class="sect2" id="id22">&#13;
<h2>Automatic Documentation</h2>&#13;
&#13;
<p><a data-primary="auto-documentation" data-type="indexterm" id="id543"/><a data-primary="documentation, automatic generation of" data-type="indexterm" id="id544"/><a data-primary="FastAPI (basics)" data-secondary="automatic documentation" data-type="indexterm" id="id545"/><a data-primary="Swagger documentation" data-type="indexterm" id="id546"/>With FastAPI, Swagger UI documentation is auto-generated for you to view and test any routes you create, as you saw in <a data-type="xref" href="#swagger_docs">Figure 2-1</a>.&#13;
During development, having an interactive docs page allows for easier and faster debugging and prototyping of your routes until you build and maintain your own test suites.</p>&#13;
&#13;
<p>As you build new endpoints, you may often want to revisit the <code>/docs</code> page to test them.</p>&#13;
&#13;
<p>You can configure a redirect from the base URL <code>/</code> to the <code>/docs</code> endpoint to facilitate quicker access to the documentation page, as shown in <a data-type="xref" href="#setting_up_redirect">Example 2-3</a>.</p>&#13;
<div data-type="example" id="setting_up_redirect">&#13;
<h5><span class="label">Example 2-3. </span>Setting up redirect to the auto-generated docs page</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># main.py</code><code>&#13;
</code><code class="kn">from</code><code> </code><code class="nn">fastapi</code><code class="nn">.</code><code class="nn">responses</code><code> </code><code class="kn">import</code><code> </code><code class="n">RedirectResponse</code><code>&#13;
</code><code>&#13;
</code><code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">/</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">include_in_schema</code><code class="o">=</code><code class="kc">False</code><code class="p">)</code><code> </code><a class="co" href="#callout_getting_started_with_fastapi_CO3-1" id="co_getting_started_with_fastapi_CO3-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="k">def</code><code> </code><code class="nf">docs_redirect_controller</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="n">RedirectResponse</code><code class="p">(</code><code class="n">url</code><code class="o">=</code><code class="s2">"</code><code class="s2">/docs</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">status_code</code><code class="o">=</code><code class="n">status</code><code class="o">.</code><code class="n">HTTP_303_SEE_OTHER</code><code class="p">)</code><code> </code><a class="co" href="#callout_getting_started_with_fastapi_CO3-2" id="co_getting_started_with_fastapi_CO3-2"><img alt="2" src="assets/2.png"/></a></pre></div>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_getting_started_with_fastapi_CO3-1" id="callout_getting_started_with_fastapi_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Set up a handler for the base root handler, but don’t include it in OpenAPI specifications and the documentation page.</p></dd>&#13;
<dt><a class="co" href="#co_getting_started_with_fastapi_CO3-2" id="callout_getting_started_with_fastapi_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Return a redirect response to the <code>/docs</code> page with a redirection status code for the browsers to perform the redirect.</p></dd>&#13;
</dl>&#13;
&#13;
<p>With <a data-type="xref" href="#setting_up_redirect">Example 2-3</a> implemented, you can access the <code>/docs</code> page during local development whenever you visit the base URL <code>/</code> of the service.</p>&#13;
&#13;
<p>In production, unless your API is public, disable this redirection and hide the <code>/docs</code> routes by default for enhanced security.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>If your API is publicly accessible in production, you may expose unsecured endpoints and sensitive information about your API.&#13;
Therefore, it is <a href="https://oreil.ly/Dk45G">best practice to turn off the documentation page</a>.</p>&#13;
&#13;
<p>Instead, you can show the <code>/docs</code> page explicitly on selected environments only.</p>&#13;
</div>&#13;
&#13;
<p class="less_space pagebreak-before">For public APIs, you can set the root handler <code>/</code> to return your API version instead of redirecting to the <code>/docs</code> page.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Dependency Injection System" data-type="sect2"><div class="sect2" id="id23">&#13;
<h2>Dependency Injection System</h2>&#13;
&#13;
<p><a data-primary="dependency injection system" data-type="indexterm" id="ix_ch02-asciidoc15"/><a data-primary="FastAPI (basics)" data-secondary="dependency injection system" data-type="indexterm" id="ix_ch02-asciidoc16"/>Another <a data-primary="inversion of control" data-type="indexterm" id="id547"/>powerful component of FastAPI is its <a href="https://oreil.ly/eAIwR">dependency injection system</a> based on a development pattern called <em>inversion of control</em>.&#13;
Using this pattern, you break down a function into a series of functions that you inject into other functions as &#13;
<span class="keep-together"><em>dependencies</em>.</span></p>&#13;
&#13;
<p>In addition to helping structure your application logic, dependencies can help you reduce duplication.&#13;
They let you share and reuse logic across your API, reuse open database connections, enforce security such as authentication or authorization requirements, and much more.</p>&#13;
&#13;
<p>For example, you can specify common query parameters across API routes (e.g., for pagination and filtering), as shown in <a data-type="xref" href="#dependency_pagination">Example 2-4</a>.</p>&#13;
<div data-type="example" id="dependency_pagination">&#13;
<h5><span class="label">Example 2-4. </span>Reducing duplication using a pagination dependency</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code><code class="p">,</code> <code class="n">Depends</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">paginate</code><code class="p">(</code><code class="n">skip</code><code class="p">:</code> <code class="nb">int</code> <code class="o">=</code> <code class="mi">0</code><code class="p">,</code> <code class="n">limit</code><code class="p">:</code> <code class="nb">int</code> <code class="o">=</code> <code class="mi">10</code><code class="p">):</code>&#13;
    <code class="k">return</code> <code class="p">{</code><code class="s2">"skip"</code><code class="p">:</code> <code class="n">skip</code><code class="p">,</code> <code class="s2">"limit"</code><code class="p">:</code> <code class="n">limit</code><code class="p">}</code>&#13;
&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/messages"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">list_messages_controller</code><code class="p">(</code><code class="n">pagination</code><code class="p">:</code> <code class="nb">dict</code> <code class="o">=</code> <code class="n">Depends</code><code class="p">(</code><code class="n">paginate</code><code class="p">)):</code>&#13;
    <code class="k">return</code> <code class="o">...</code>  <code class="c1"># filter and paginate results using pagination params</code>&#13;
&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/conversations"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">list_conversations_controller</code><code class="p">(</code><code class="n">pagination</code><code class="p">:</code> <code class="nb">dict</code> <code class="o">=</code> <code class="n">Depends</code><code class="p">(</code><code class="n">paginate</code><code class="p">)):</code>&#13;
    <code class="k">return</code> <code class="o">...</code>  <code class="c1"># filter and paginate results using pagination params</code></pre></div>&#13;
&#13;
<p>In FastAPI, dependencies are also cached within <em>the context of a single request</em> to prevent duplicate computations.&#13;
This means a dependency function is executed only once per request, and its result is reused for the duration of that request if needed again.&#13;
However, in a new request, the dependency function is executed again.</p>&#13;
&#13;
<p>Having to manage database connections or checking user credentials in every route handler is tedious and violates the <em>Don’t Repeat Yourself</em> (DRY) principles of programming.&#13;
Another great use case of the dependency injection system is when you create a database connection and want to reuse that connection to perform multiple fetch requests while processing a single request.</p>&#13;
&#13;
<p class="less_space pagebreak-before">You can create dependencies for your route controller functions, as shown in <a data-type="xref" href="#fastapi_dependency">Example 2-5</a>.</p>&#13;
<div data-type="example" id="fastapi_dependency">&#13;
<h5><span class="label">Example 2-5. </span>Dependency injection in FastAPI</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code><code> </code><code class="nn">fastapi</code><code> </code><code class="kn">import</code><code> </code><code class="n">FastAPI</code><code class="p">,</code><code> </code><code class="n">Depends</code><code>&#13;
</code><code>&#13;
</code><code class="k">def</code><code> </code><code class="nf">get_db</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code> </code><a class="co" href="#callout_getting_started_with_fastapi_CO4-1" id="co_getting_started_with_fastapi_CO4-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>    </code><code class="n">db</code><code> </code><code class="o">=</code><code> </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code> </code><code class="c1"># create a database session</code><code>&#13;
</code><code>    </code><code class="k">try</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="k">yield</code><code> </code><code class="n">db</code><code> </code><a class="co" href="#callout_getting_started_with_fastapi_CO4-2" id="co_getting_started_with_fastapi_CO4-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>    </code><code class="k">finally</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="n">db</code><code class="o">.</code><code class="n">close</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_getting_started_with_fastapi_CO4-3" id="co_getting_started_with_fastapi_CO4-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>&#13;
</code><code class="n">app</code><code> </code><code class="o">=</code><code> </code><code class="n">FastAPI</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">users/</code><code class="si">{email}</code><code class="s2">/messages</code><code class="s2">"</code><code class="p">)</code><code>&#13;
</code><code class="k">def</code><code> </code><code class="nf">get_current_user_messages</code><code class="p">(</code><code class="n">email</code><code class="p">,</code><code> </code><code class="n">db</code><code> </code><code class="o">=</code><code> </code><code class="n">Depends</code><code class="p">(</code><code class="n">get_db</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code> </code><a class="co" href="#callout_getting_started_with_fastapi_CO4-4" id="co_getting_started_with_fastapi_CO4-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>    </code><code class="n">user</code><code> </code><code class="o">=</code><code> </code><code class="n">db</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">)</code><code> </code><code class="c1"># db is reused</code><code>&#13;
</code><code>    </code><code class="n">messages</code><code> </code><code class="o">=</code><code> </code><code class="n">db</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">)</code><code> </code><code class="c1"># db is reused</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="n">messages</code><code> </code><a class="co" href="#callout_getting_started_with_fastapi_CO4-5" id="co_getting_started_with_fastapi_CO4-5"><img alt="5" src="assets/5.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_getting_started_with_fastapi_CO4-1" id="callout_getting_started_with_fastapi_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Implement a function to create and manage a database session, which can be used as a dependency in route handlers.</p></dd>&#13;
<dt><a class="co" href="#co_getting_started_with_fastapi_CO4-2" id="callout_getting_started_with_fastapi_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Yield the open database session, making it available for any function that depends on <code>get_db</code>.</p></dd>&#13;
<dt><a class="co" href="#co_getting_started_with_fastapi_CO4-3" id="callout_getting_started_with_fastapi_CO4-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Close the database session after the request is processed, preventing resource leaks.</p></dd>&#13;
<dt><a class="co" href="#co_getting_started_with_fastapi_CO4-4" id="callout_getting_started_with_fastapi_CO4-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Inject the <code>get_db</code> dependency into the route handler to create and reuse the same database session during the request lifecycle.&#13;
FastAPI will also automatically expose parameters within dependencies on your endpoint.</p></dd>&#13;
<dt><a class="co" href="#co_getting_started_with_fastapi_CO4-5" id="callout_getting_started_with_fastapi_CO4-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Reuse the injected database session to perform multiple database operations within a single request to return a user’s messages.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>As shown in <a data-type="xref" href="#fastapi_dependency">Example 2-5</a>, you can inject these dependencies into other functions by passing them as parameters to <code>Depends()</code> for FastAPI to evaluate and cache your function outputs.</p>&#13;
&#13;
<p>Here you define a utility function for creating a database session and then use it as a dependency of the <code>get_current_user_messages</code> function to inject the created database session.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id548">&#13;
<h1>Hierarchical Dependency Graph</h1>&#13;
<p><a data-primary="hierarchical dependency graph" data-type="indexterm" id="id549"/>You can also have dependencies injected into other dependencies to create a <em>hierarchical dependency graph</em>, which is extremely useful for building <a href="https://oreil.ly/i_xHr">cached authentication and authorization flows</a>, nested data retrieval logic, or complex decision trees when implementing your application’s business logic.</p>&#13;
&#13;
<p>As an example, you can reuse the same database session creation or user fetching functions across different parts of your API, as shown in <a data-type="xref" href="#dependency_injection">Figure 2-2</a>.</p>&#13;
&#13;
<figure><div class="figure" id="dependency_injection">&#13;
<img alt="bgai 0202" src="assets/bgai_0202.png"/>&#13;
<h6><span class="label">Figure 2-2. </span>Dependency injection in FastAPI</h6>&#13;
</div></figure>&#13;
&#13;
<p>In a hierarchical dependency graph, as shown in <a data-type="xref" href="#dependency_injection">Figure 2-2</a>, each dependency (and their subdependencies) can provide (inject) its results to another function that depends on it.</p>&#13;
</div></aside>&#13;
&#13;
<p>This dependency system is just one of many other features that ship with FastAPI that speed up and ease the process of building backend services.<a data-startref="ix_ch02-asciidoc16" data-type="indexterm" id="id550"/><a data-startref="ix_ch02-asciidoc15" data-type="indexterm" id="id551"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Lifespan Events" data-type="sect2"><div class="sect2" id="id24">&#13;
<h2>Lifespan Events</h2>&#13;
&#13;
<p><a data-primary="FastAPI (basics)" data-secondary="lifespan events" data-type="indexterm" id="id552"/><a data-primary="lifespan events" data-type="indexterm" id="id553"/><a href="https://oreil.ly/Cn2DB">FastAPI’s lifespan events</a> are excellent for handling initialization and cleanup of your service when you need to set up resources that can be shared between requests.<sup><a data-type="noteref" href="ch02.html#id554" id="id554-marker">5</a></sup> During server startup, you can create database connection pools or load GenAI models into memory for reuse across requests. Afterward, before server shutdown, you can clean up by unloading AI models, closing connection pools, deleting temporary artifacts, and logging events.</p>&#13;
&#13;
<p>By using lifespan events, your FastAPI service performs long-running operations like model loading at the start, before serving requests, and keeps it loaded for reuse among requests.&#13;
During server shutdown, you can then gracefully finish all remaining and queued requests before running any cleanup operations.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Security and Authentication Components" data-type="sect2"><div class="sect2" id="id239">&#13;
<h2>Security and Authentication Components</h2>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="FastAPI components for" data-type="indexterm" id="id555"/><a data-primary="FastAPI (basics)" data-secondary="security/authentication components" data-type="indexterm" id="id556"/><a data-primary="securing AI services" data-secondary="FastAPI components for" data-type="indexterm" id="id557"/>As with any other framework, you will need security and authentication components to secure your service.&#13;
FastAPI doesn’t lock you in a specific implementation of the security and authentication layer.&#13;
It gives you a set of <a href="https://oreil.ly/zlAgl">security components</a> so you can protect your services based on your own needs.</p>&#13;
&#13;
<p>You’ll learn how to implement an authentication layer from scratch for your GenAI services in <a data-type="xref" href="ch08.html#ch08">Chapter 8</a>.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>If you don’t want to implement an authentication layer from scratch, then you can also reach out for third-party plug-ins like <a href="https://oreil.ly/eEtMe">FastAPI Users</a> that automatically take care of that for you.</p>&#13;
</div>&#13;
&#13;
<p>You can also integrate with third-party authentication providers for <a href="https://oreil.ly/vIqCd">single sign-on flows in FastAPI</a> in enterprise environments.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Bidirectional Web Socket, GraphQL, and Custom Response Support" data-type="sect2"><div class="sect2" id="id25">&#13;
<h2>Bidirectional Web Socket, GraphQL, and Custom Response Support</h2>&#13;
&#13;
<p><a data-primary="FastAPI (basics)" data-secondary="bidirectional WebSocket support" data-type="indexterm" id="ix_ch02-asciidoc17"/><a data-primary="WebSocket (WS)" data-secondary="FastAPI support for" data-type="indexterm" id="ix_ch02-asciidoc18"/>When building services, you will often need to move beyond the standard <em>REST</em> &#13;
<span class="keep-together"><em>endpoints</em>.</span></p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id558">&#13;
<h1>REST Endpoints</h1>&#13;
<p><a data-primary="REST (Representational State Transfer) endpoints" data-type="indexterm" id="id559"/><em>Representational State Transfer</em> (REST) is an architectural style for designing APIs where you use common HTTP methods like <code>GET</code>, <code>POST</code>, <code>PUT</code>, and <code>DELETE</code> to access and manipulate resources.</p>&#13;
&#13;
<p>The following are common REST endpoint examples:</p>&#13;
<dl>&#13;
<dt><code>GET endpoint /api/messages</code></dt>&#13;
<dd>&#13;
<p>Retrieve a list of messages.</p>&#13;
</dd>&#13;
<dt><code>POST endpoint /api/messages</code></dt>&#13;
<dd>&#13;
<p>Create a new message.</p>&#13;
</dd>&#13;
<dt><code>GET endpoint /api/messages/\{id}</code></dt>&#13;
<dd>&#13;
<p>Retrieve a specific message by ID.</p>&#13;
</dd>&#13;
<dt><code>PUT endpoint /api/messages/\{id}</code></dt>&#13;
<dd>&#13;
<p>Update a specific message by ID.</p>&#13;
</dd>&#13;
<dt><code>PATCH endpoint /api/messages/\{id}</code></dt>&#13;
<dd>&#13;
<p>Perform a partial update on a specific message by ID.</p>&#13;
</dd>&#13;
<dt><code>DELETE endpoint /api/messages/\{id}</code></dt>&#13;
<dd>&#13;
<p>Delete a specific message by ID.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Most external APIs across the web are based on the REST architectural pattern due to its scalability, simplicity, and stateless nature (i.e., responses to each request can be independent of another).</p>&#13;
</div></aside>&#13;
&#13;
<p>If you’re building a chat application, you may also need real-time client-server communication or longer-duration connections where data is streamed in a direction.&#13;
WebSocket (WS) and server-sent events (SSE) endpoints can help you stream generative model outputs to the clients, as you will see in <a data-type="xref" href="ch06.html#ch06">Chapter 6</a> on real-time communication with AI services.</p>&#13;
&#13;
<p><a data-primary="GraphQL, exposing endpoints with" data-type="indexterm" id="id560"/>In other cases, you may want to use <a href="https://oreil.ly/SL62a">GraphQL in FastAPI</a> to expose endpoints that can return dynamic schemas based on the request.&#13;
FastAPI can use the <a href="https://oreil.ly/wIzvi"><code>strawberry</code> package</a><sup><a data-type="noteref" href="ch02.html#id561" id="id561-marker">6</a></sup> to leverage GraphQL in using dynamic schemas for your API service so that clients can select fields they want from a resource to avoid over-fetching data from your service.&#13;
However, we won’t be covering GraphQL usage in this book.<a data-startref="ix_ch02-asciidoc18" data-type="indexterm" id="id562"/><a data-startref="ix_ch02-asciidoc17" data-type="indexterm" id="id563"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Modern Python and IDE Integration with Sensible Defaults" data-type="sect2"><div class="sect2" id="id26">&#13;
<h2>Modern Python and IDE Integration with Sensible Defaults</h2>&#13;
&#13;
<p><a data-primary="FastAPI (basics)" data-secondary="modern Python/IDE integration with sensible defaults" data-type="indexterm" id="id564"/><a data-primary="Python" data-secondary="modern Python/IDE integration with sensible defaults" data-type="indexterm" id="id565"/>Since the FastAPI tech stack is built on modern Python (e.g., with type annotations and doc-strings), all IDE linters and formatters can natively check and format your codebase.&#13;
The defaults are also sufficient to get you started by importing and instantiating the FastAPI class.&#13;
Because everything ties neatly with modern IDE and Python features, anyone can easily get started building, testing, debugging, and deploying their own FastAPI services.<a data-startref="ix_ch02-asciidoc6" data-type="indexterm" id="id566"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="FastAPI Project Structures" data-type="sect1"><div class="sect1" id="id240">&#13;
<h1>FastAPI Project Structures</h1>&#13;
&#13;
<p><a data-primary="FastAPI (basics)" data-secondary="project structures" data-type="indexterm" id="ix_ch02-asciidoc19"/>Often when you are working on a real-world project, you will end up building services that will span multiple modules, packages, and nested directories.&#13;
The decision on how to structure your project is going to be totally up to you.</p>&#13;
&#13;
<p class="less_space pagebreak-before">This is where most people will struggle and end up with a codebase too overwhelming to navigate.&#13;
You will end up frustrated, having to understand the codebase and project structure before you can contribute to it.&#13;
At some point, the complexity will grow so much that you will dread touching the project again.</p>&#13;
&#13;
<p>Some files will end up too large to read with bloated functions, or there will be too many files scattered all over the place.&#13;
You may also end up having millions of import errors or circular dependencies breaking your application.</p>&#13;
&#13;
<p>Learning to structure larger applications will be even more important when working with generative AI models.&#13;
These models often need dependencies and additional utility functions to support them.&#13;
Therefore, you will have to add a layer of complexity for your models on top of existing applications layers.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>Compared to opinionated frameworks such as Django, you need to follow good practices for having success with larger projects in nonopinionated frameworks such as FastAPI.</p>&#13;
</div>&#13;
&#13;
<p>Over the past few years working with FastAPI and data science applications, I have seen many developers come up with their own cookie-cutter templates for starting FastAPI projects.&#13;
Some even recommend following a structure popularized by the Netflix Dispatch FastAPI project for larger API applications that has inspired other templates.</p>&#13;
&#13;
<p>When it comes to building real-world applications, you must do everything you can to keep the codebase as structured as possible.&#13;
This is for your own benefit—to help you and others in your team in understanding the code in the future.</p>&#13;
&#13;
<p>You know you have a good project structure if you can find any function or component within your codebase.&#13;
If you start questioning the purpose of a directory or spending hours searching for a piece of code, then your project structure might be unclear and too complex to understand.</p>&#13;
&#13;
<p>In these instances, you can refer to a few common project structures that have recently become popular in the FastAPI community. There are a few project structures you can adopt: flat, nested, and modular.</p>&#13;
&#13;
<p>Let us take a detailed look at each one.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Flat Structure" data-type="sect2"><div class="sect2" id="id27">&#13;
<h2>Flat Structure</h2>&#13;
&#13;
<p><a data-primary="FastAPI (basics)" data-secondary="project structures" data-tertiary="flat structure" data-type="indexterm" id="id567"/><a data-primary="flat project structure" data-type="indexterm" id="id568"/>A flat structure is one in which the application files remain at the root of your project with no nested directories.&#13;
You may group all your files under a single directory for better organization.</p>&#13;
&#13;
<p>The main idea here is to keep all similar code in modules and placed together near the root of your project.&#13;
For instance, put all your database models in <em>models.py</em> or your endpoints in <em>routes.py</em>.</p>&#13;
&#13;
<p>By far, the most common project structure is flat due to its simplicity and ease of use. This structure is often great for building the first version of a service or a tiny microservices. <a data-type="xref" href="#flat_structure">Example 2-6</a> is what the structure could look like.</p>&#13;
<div data-type="example" id="flat_structure">&#13;
<h5><span class="label">Example 2-6. </span>A flat FastAPI project structure</h5>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">flat-project&#13;
├── app&#13;
│   ├── services.py&#13;
│   ├── database.py&#13;
│   ├── models.py&#13;
│   ├── routers.py&#13;
│   └── main.py&#13;
├── requirements.txt&#13;
├── .env&#13;
├── .gitignore</pre></div>&#13;
&#13;
<p>You can see in the structure shown in <a data-type="xref" href="#flat_structure">Example 2-6</a> that you have a few files that contain the core of your application logic.&#13;
If you are building a microservice with &#13;
<span class="keep-together">FastAPI,</span> by definition, you will want to maintain a flat structure for simplicity.</p>&#13;
&#13;
<p>The simplicity of the flat structure allows you to focus on the development rather than the structure.&#13;
There are few files to worry about.&#13;
You also don’t need to care about coupling, decomposition, or reuse as there are few lines of codes to deal with.</p>&#13;
&#13;
<p>On the other hand, the flat structure will be hard to maintain as your project grows in complexity.&#13;
At this point, it makes sense to break down the global Python modules into packages of their own using the nested structure.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Nested Structure" data-type="sect2"><div class="sect2" id="id28">&#13;
<h2>Nested Structure</h2>&#13;
&#13;
<p><a data-primary="FastAPI (basics)" data-secondary="project structures" data-tertiary="nested structure" data-type="indexterm" id="id569"/><a data-primary="nested project structure" data-type="indexterm" id="id570"/>The nested structure groups similar modules into packages—effectively creating a nested structure and hierarchy of modules.&#13;
You group all modules under a package that are similar in nature irrespective of the feature they support.&#13;
These are loosely coupled modules that contain similar logic for different entities in your project.&#13;
For instance, the <code>models</code> package may contain <code>users</code> and <code>profiles</code> database models.</p>&#13;
&#13;
<p>The nested structure is recommended for larger projects by the official FastAPI &#13;
<span class="keep-together">documentation.</span></p>&#13;
&#13;
<p class="less_space pagebreak-before">You can see a project with nested structure in <a data-type="xref" href="#nested_structure">Example 2-7</a>.</p>&#13;
<div data-type="example" id="nested_structure">&#13;
<h5><span class="label">Example 2-7. </span>Nested FastAPI project</h5>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">nested-project&#13;
├── app&#13;
│    ├── main.py&#13;
│    ├── dependencies.py&#13;
│    └── services&#13;
│    │   ├── users.py&#13;
│    │   └── profiles.py&#13;
│    └── models&#13;
│    │   ├── users.py&#13;
│    │   └── profiles.py&#13;
│    └── routers&#13;
│        ├── users.py&#13;
│        └── profiles.py&#13;
├── requirements.txt&#13;
├── .env&#13;
├── .gitignore</pre></div>&#13;
&#13;
<p>As you add AI models and several external services and databases to your project, you can adopt a nested structure to manage the growing complexity.</p>&#13;
&#13;
<p>The main pitfall with this project structure is the ambiguous coupling of modules.&#13;
Changes in one module can cascade into other modules, and it can become difficult to understand the cascading effect of new changes.&#13;
<a data-primary="shotgun updates" data-type="indexterm" id="id571"/>Over time, it can be challenging to maintain and change the code without performing many updates everywhere else.&#13;
This is referred to as <em>shotgun updates</em>.&#13;
Shotgun updates in the context of software development are when it is challenging to maintain and change the code without performing many updates everywhere else.</p>&#13;
&#13;
<p>If you expect difficulty managing module coupling or expecting to deal with a large application, I would recommend using a modular structure.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Modular Structure" data-type="sect2"><div class="sect2" id="id29">&#13;
<h2>Modular Structure</h2>&#13;
&#13;
<p><a data-primary="FastAPI (basics)" data-secondary="project structures" data-tertiary="modular structure" data-type="indexterm" id="ix_ch02-asciidoc20"/><a data-primary="modular project structure" data-type="indexterm" id="ix_ch02-asciidoc21"/>The modular structure—popularized by the Netflix Dispatch FastAPI project—is similar to the nested structure because you can place multiple modules within a package and subpackages.&#13;
However, the core difference is in how you organize your project.</p>&#13;
&#13;
<p>In the modular structure, modules that are closely related and refer to a specific domain are grouped together.&#13;
This approach differs from the previously mentioned nested structure.&#13;
An example could be the <code>users</code> package that contains user schemas, database services, dependencies and routers.</p>&#13;
&#13;
<p class="less_space pagebreak-before">To understand this difference better, look at <a data-type="xref" href="#modular_structure">Example 2-8</a>.</p>&#13;
<div data-type="example" id="modular_structure">&#13;
<h5><span class="label">Example 2-8. </span>Modular FastAPI project structure</h5>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">modular-project&#13;
├── app&#13;
│   └── modules&#13;
│   │   ├── auth&#13;
│   │   │   ├── routers.py&#13;
│   │   │   ├── models.py&#13;
│   │   │   ├── dependencies.py&#13;
│   │   │   ├── guards.py&#13;
│   │   │   ├── services.py&#13;
│   │   └── users&#13;
│   │   │   ├── router.py&#13;
│   │   │   ├── models.py&#13;
│   │   │   ├── dependencies.py&#13;
│   │   │   ├── services.py&#13;
│   │   │   ├── mappers.py&#13;
│   │   │   ├── pipes.py&#13;
│   │   └── profiles&#13;
│   └── routers&#13;
│   │   └── users.py&#13;
│   └── providers&#13;
│   │   └── email.py&#13;
│   │   └── stripe.py&#13;
............&#13;
│   ├── settings.py  # global configs&#13;
│   ├── middlewares.py  # global middleware&#13;
│   ├── models.py  # global models&#13;
│   ├── exceptions.py  # global exceptions&#13;
│   └── main.py&#13;
├── requirements.txt&#13;
├── .env&#13;
├── .gitignore</pre></div>&#13;
&#13;
<p>In modular project structure like the one shown in <a data-type="xref" href="#modular_structure">Example 2-8</a>, you bring together closely interconnected components based on a feature or a global system they implement (e.g., authentication, payment processing, notifications, etc.) or the resource they interact with (e.g., users, profiles, messages, etc).&#13;
This kind of encapsulation eliminates any uncertainty regarding the couplings in your code, resulting in improved scalability and maintainability.</p>&#13;
&#13;
<p>If you need to include more features, you can create a new package that contains all the necessary code.&#13;
Similarly, if you need to modify or delete code, you can easily determine where the changes should be made and expect how they will impact other parts of the code.&#13;
This is possible because the structure of the codebase is transparent and well-encapsulated, making it clear where different components are connected.<a data-startref="ix_ch02-asciidoc21" data-type="indexterm" id="id572"/><a data-startref="ix_ch02-asciidoc20" data-type="indexterm" id="id573"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Progressive Reorganization of Your FastAPI Project" data-type="sect2"><div class="sect2" id="id30">&#13;
<h2>Progressive Reorganization of Your FastAPI Project</h2>&#13;
&#13;
<p><a data-primary="FastAPI (basics)" data-secondary="project structures" data-tertiary="progressive reorganization of project" data-type="indexterm" id="ix_ch02-asciidoc22"/>A modular codebase allows you to add and remove components with ease.&#13;
You can also reuse components across different parts of your system to avoid repetition.</p>&#13;
&#13;
<p>When you first start your project, modularity is not as important.&#13;
You can get started with just a single or a few Python files to build your services easily.&#13;
However, as soon as you introduce AI models, external services, and complex business logic, you will want to consider modularizing your codebase.</p>&#13;
&#13;
<p>You can achieve modularity by designing components of your system with re-usability and disposability in mind.&#13;
Make sure the design of your modules and functions allow for usage in different environments and that you place them at the right place in your project directory.&#13;
Selecting the best project structure is a matter of preference.&#13;
However, you may be asking yourself, “Which project structure should I adopt for building generative AI services with FastAPI?”</p>&#13;
&#13;
<p>I found that the best way to structure projects is to <em>progressively reorganize</em>&#13;
your project from a flat to a modular structure as your service complexity grows:</p>&#13;
<dl>&#13;
<dt>1. Flat</dt>&#13;
<dd><p> If you are starting with a new project and the complexity of your system is not yet clear, you can focus on writing all your FastAPI code in a single file before worrying about the project structure.&#13;
You then extract your code into several files under the root directory.&#13;
This is the initial structure you will adopt when experimenting on the first version of your service from scratch.</p></dd>&#13;
<dt>2. Nested</dt>&#13;
<dd>&#13;
<p> As the number of files in your codebase and service complexity grows, you can adopt the nested structure.&#13;
You can search for files based on logical grouping (models, routers, schemas, etc.) and do not have to worry too much about logical couplings in your code.&#13;
As you make changes, only a handful of files are affected.&#13;
At this point, you have an AI microservice.</p>&#13;
</dd>&#13;
<dt>3. Modular</dt>&#13;
<dd>&#13;
<p> As you move from a microservice to a full backend service, you will want to adopt a modular structure.&#13;
There is now an increasing number of modules, features, and complexity.&#13;
You start grouping your code into packages based on <em>areas of concern</em>.&#13;
Your code is now handling requests, authentication, external systems, etc., while serving an AI model.</p></dd>&#13;
&#13;
&#13;
</dl>&#13;
&#13;
<p>I suggest restructuring your project as outlined.&#13;
However, you have the flexibility to adopt any organizational scheme that makes sense to you and allows you to recall the location and purpose of your files.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>Remember, if you cannot justify the file organization in your codebase to another developer, it is time to reconsider your existing structure.</p>&#13;
</div>&#13;
&#13;
<p>As you build your GenAI service, you will inevitably end up with a large codebase and a complex application.</p>&#13;
&#13;
<p>Thinking about the structure of your large FastAPI application is only the first step in building production-grade services.&#13;
In the next step, you will learn more about a software design pattern that helps you manage the complexity of your AI services.&#13;
This is called the <em>onion</em>, or <em>layered</em>, application design pattern, which we will talk about next<a data-startref="ix_ch02-asciidoc22" data-type="indexterm" id="id574"/>.<a data-startref="ix_ch02-asciidoc19" data-type="indexterm" id="id575"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Onion/Layered Application Design Pattern" data-type="sect1"><div class="sect1" id="id31">&#13;
<h1>Onion/Layered Application Design Pattern</h1>&#13;
&#13;
<p><a data-primary="FastAPI (basics)" data-secondary="onion (layered) application design pattern" data-type="indexterm" id="ix_ch02-asciidoc23"/><a data-primary="layered (onion) application design pattern" data-type="indexterm" id="ix_ch02-asciidoc24"/><a data-primary="onion (layered) application design pattern" data-type="indexterm" id="ix_ch02-asciidoc25"/>If you plan on building a fully featured backend service for generative AI, you will benefit to know more about the onion, or layered, application design pattern, which can be implemented within the nested and modular project structures.&#13;
The purpose of this pattern is to create a separation of concerns between the different parts of your application to simplify the process of adding, removing, and modifying features.</p>&#13;
&#13;
<p>The onion design pattern has also influenced web frameworks in other languages such as <a href="https://nestjs.com">Nest.js</a>.</p>&#13;
&#13;
<p>The onion design consists of layers, each with a specific responsibility and dependency direction, shown in <a data-type="xref" href="#onion_design_pattern">Figure 2-3</a>.&#13;
The innermost layer contains the domain models and business logic, while the outer layers contain route handling (in an API service) or user-interfacing code (when serving HTML templates).</p>&#13;
&#13;
<p>The pattern is called “onion” because the layers build upon each other, with the domain model at the center, surrounded by layers of increasing abstraction promoting testability, maintainability, and flexibility in maintaining your AI services.&#13;
The core of the application (domain model and business logic) is at the inner layers, and all other layers depend inwardly on it.&#13;
This approach helps to manage dependencies, promote separation of concerns, and facilitate a more testable and maintainable &#13;
<span class="keep-together">codebase.</span></p>&#13;
&#13;
<figure><div class="figure" id="onion_design_pattern">&#13;
<img alt="bgai 0203" src="assets/bgai_0203.png"/>&#13;
<h6><span class="label">Figure 2-3. </span>Onion design pattern</h6>&#13;
</div></figure>&#13;
&#13;
<p><a data-primary="dependency inversion principle" data-type="indexterm" id="id576"/>The main idea behind this pattern is the <em>dependency inversion principle</em>, which states that high-level modules should not directly depend on the implementation of low-level modules but declare what they need from low-level modules by leveraging the FastAPI dependency system.&#13;
The dependency system can then inject the output of the low-level modules to avoid coupling between layers.</p>&#13;
&#13;
<p>To implement this software design, you break down your service as an onion consisting of layers that go deeper and deeper.&#13;
Each layer (as you move from outer to inner layers) introduces components that are responsible for a set of tasks:</p>&#13;
<dl>&#13;
<dt>API routers</dt>&#13;
<dd>&#13;
<p><a data-primary="API routers" data-type="indexterm" id="id577"/>Routers are responsible for grouping multiple controllers/route handlers to apply common logic across several controllers.</p>&#13;
&#13;
<p>FastAPI provides the <code>APIRouter</code> class to help you with this.</p>&#13;
</dd>&#13;
<dt>Controllers/route handlers</dt>&#13;
<dd>&#13;
<p><a data-primary="controllers" data-type="indexterm" id="id578"/>Controllers are responsible for handling incoming <em>requests</em> and returning <em>responses</em>&#13;
to the client via a logical execution of services or providers.</p>&#13;
&#13;
<p>Good controller design always uses dependencies to inject required data or logic required for its execution. See <a data-type="xref" href="#api_routers_controllers">Figure 2-4</a>.</p>&#13;
&#13;
<figure><div class="figure" id="api_routers_controllers">&#13;
<img alt="bgai 0204" src="assets/bgai_0204.png"/>&#13;
<h6><span class="label">Figure 2-4. </span>API routers and controllers</h6>&#13;
</div></figure>&#13;
</dd>&#13;
<dt>Services/providers</dt>&#13;
<dd>&#13;
<p>Services are responsible for combining or orchestrating multiple internal operations to implement a business logic (services), while providers implement the interface with external systems.</p>&#13;
&#13;
<p>Services typically use repositories for data access to implement complex business logic rather than simple data retrieval and mutation operations. Each module of your application can have its own service.</p>&#13;
&#13;
<p>Providers are similar to services but are specialized in interacting with external systems such as internal/third-party APIs. Examples of providers include clients for email servers, payment gateways, or other microservices.</p>&#13;
&#13;
<p>Essentially, both providers and services support implementation of controller business logic by facilitating internal and external interactions.</p>&#13;
&#13;
<p>Here is an example of how they work together within a route controller:&#13;
the <code>users</code> database service fetches a user’s record by email and then uses that information with a payment gateway and email server clients (providers) for processing payments and sending confirmation emails.</p>&#13;
</dd>&#13;
<dt>Repositories (data adapters)</dt>&#13;
<dd>&#13;
<p><a data-primary="repository design pattern" data-type="indexterm" id="id579"/>A repository is a design pattern used when implementing the logic for data access and mutation operations with data sources (not to be confused with a Git &#13;
<span class="keep-together">repository).</span></p>&#13;
&#13;
<p>Repositories use object-relational mapping (ORM) or raw SQL commands to execute queries on your infrastructure like a database, or a memory store for retrieving or mutating data.</p>&#13;
&#13;
<p>You may implement an abstract interface in this layer to enforce consistent design across all your repositories—using the create, read, update, delete (CRUD) operations. See <a data-type="xref" href="#services_providers_repositories">Figure 2-5</a>.</p>&#13;
&#13;
<figure><div class="figure" id="services_providers_repositories">&#13;
<img alt="bgai 0205" src="assets/bgai_0205.png"/>&#13;
<h6><span class="label">Figure 2-5. </span>Services, providers, and repositories</h6>&#13;
</div></figure>&#13;
</dd>&#13;
<dt>Schemas/models</dt>&#13;
<dd>&#13;
<p>These are responsible for enforcing type-safety, structure, and validation logic on your data as it flows throughout your service.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>You will also have components that span layers to support the whole application:</p>&#13;
<dl>&#13;
<dt>Middleware</dt>&#13;
<dd>&#13;
<p>This handles requests and responses before and after they are passed to the application controllers/route handlers (see <a data-type="xref" href="#middlewares">Figure 2-6</a>).</p>&#13;
&#13;
<figure><div class="figure" id="middlewares">&#13;
<img alt="bgai 0206" src="assets/bgai_0206.png"/>&#13;
<h6><span class="label">Figure 2-6. </span>Middleware</h6>&#13;
</div></figure>&#13;
</dd>&#13;
<dt>Dependencies</dt>&#13;
<dd>&#13;
<p>These include reusable functions you define that can be injected into controllers to support a business logic. Dependencies can be cached and depend on other dependencies.</p>&#13;
</dd>&#13;
<dt>Pipes</dt>&#13;
<dd>&#13;
<p>These are data transformer functions that you can use across application layers.&#13;
Examples include data aggregators, cleaners, parsers, translators, etc.</p>&#13;
</dd>&#13;
</dl>&#13;
<dl class="less_space pagebreak-before">&#13;
<dt>Mappers</dt>&#13;
<dd>&#13;
<p>These are data mappers from one schema into another, often passing data across layers such as from the <code>UserRequest</code> schema at a router layer to the <code>UserInDB</code> schema at the data access layer. See <a data-type="xref" href="#models_pipes_mappers">Figure 2-7</a>.</p>&#13;
&#13;
<figure><div class="figure" id="models_pipes_mappers">&#13;
<img alt="bgai 0207" src="assets/bgai_0207.png"/>&#13;
<h6><span class="label">Figure 2-7. </span>Models, pipes, and mappers</h6>&#13;
</div></figure>&#13;
</dd>&#13;
<dt>Exception filters</dt>&#13;
<dd>&#13;
<p>These consistently handle exceptions across the layers.</p>&#13;
</dd>&#13;
<dt>Guards</dt>&#13;
<dd>&#13;
<p><a data-primary="guards" data-type="indexterm" id="id580"/>These secure and protect controllers from abuse. Authentication and authorization logic can be implemented as dependencies or middleware to act as guards (see <a data-type="xref" href="#guards">Figure 2-8</a>).</p>&#13;
&#13;
<figure><div class="figure" id="guards">&#13;
<img alt="bgai 0208" src="assets/bgai_0208.png"/>&#13;
<h6><span class="label">Figure 2-8. </span>Guards</h6>&#13;
</div></figure>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>If you refer to the modular project structure shown in <a data-type="xref" href="#modular_structure">Example 2-8</a>, you will now notice various elements of the onion design pattern in the modular project structure.&#13;
Following this pattern can help you create a maintainable, testable, and scalable &#13;
<span class="keep-together">FastAPI</span> generative AI service.</p>&#13;
&#13;
<p>In the upcoming chapters, you’ll use these patterns to build the GenAI service shown in <a data-type="xref" href="#genai_service">Figure 2-9</a>.</p>&#13;
&#13;
<figure><div class="figure" id="genai_service">&#13;
<img alt="bgai 0209" src="assets/bgai_0209.png"/>&#13;
<h6><span class="label">Figure 2-9. </span>Generative AI service you’ll build with FastAPI</h6>&#13;
</div></figure>&#13;
&#13;
<p>Next, we will compare FastAPI with other frameworks.<a data-startref="ix_ch02-asciidoc25" data-type="indexterm" id="id581"/><a data-startref="ix_ch02-asciidoc24" data-type="indexterm" id="id582"/><a data-startref="ix_ch02-asciidoc23" data-type="indexterm" id="id583"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Comparing FastAPI to Other Python Web Frameworks" data-type="sect1"><div class="sect1" id="id32">&#13;
<h1>Comparing FastAPI to Other Python Web Frameworks</h1>&#13;
&#13;
<p><a data-primary="FastAPI (basics)" data-secondary="comparison to other Python web frameworks" data-type="indexterm" id="ix_ch02-asciidoc26"/><a data-primary="Python web frameworks" data-type="indexterm" id="ix_ch02-asciidoc27"/>Most Python web frameworks can provide you with tools for building REST, GraphQL, WebSocket, and other types of endpoints.</p>&#13;
&#13;
<p>These frameworks are either opinionated, such as Django (Python) and Nestjs (JavaScript), while others are not. Flask or FastAPI (Python) and Express (JavaScript) give you the option to architect your service however you like.</p>&#13;
&#13;
<p><a data-primary="Django" data-type="indexterm" id="ix_ch02-asciidoc28"/><a data-primary="opinionated frameworks" data-type="indexterm" id="ix_ch02-asciidoc29"/>Opinionated frameworks, such as Django (Python) and Nestjs (JavaScript), make decisions for you with certain assumptions about how you will be providing data to your components.&#13;
Effectively, they provide structure while restricting what you are allowed to do.&#13;
Opinionated frameworks are typically easier to use.&#13;
<a data-primary="nonopinionated frameworks" data-type="indexterm" id="id584"/>On the other hand, nonopinionated frameworks such as Flask or FastAPI (Python) and Express (JavaScript) are more flexible but can give you too much freedom—many possibilities to achieve the same results.</p>&#13;
<p class="fix_tracking">&#13;
Because nonopinionated frameworks such as FastAPI give you so much freedom in building services, you may feel some decision fatigue when choosing and integrating every single support package yourself.&#13;
For instance, to work with a database, you will need to install and integrate several packages that work well together—one to access the database, one to migrate it, and another to act as an object relational mapper (ORM).&#13;
</p>&#13;
&#13;
<p>While doing that, you may run into compatibility issues with older packages during integration.&#13;
This makes working with nonopinionated frameworks difficult, and often you may decide to use an opinionated framework such as Django, which ships with a tightly integrated and excellent ORM system for interacting with databases.</p>&#13;
&#13;
<p>Django is a battery-included framework that markets itself as the “Python web framework for developers with deadlines.”&#13;
It ships with a fully integrated and feature-rich ORM system that takes care of your database migrations and data access needs when you provide the data models.</p>&#13;
&#13;
<p>Additionally, it provides you with an administration panel, a credentials-based user authentication and authorization system, and several web security features out of the box, so you do not have to build these yourself.&#13;
It has also been around for a long time, fostering an active community that has produced excellent documentation, tutorials, and other resources for the framework.&#13;
In Django version 4.2, support for async requests has also been introduced—allowing you to build concurrency into your services.&#13;
Django expects you to adopt the MVC architecture, requiring you to define data models and views.&#13;
These views become routes serving templated HTML files, JSON responses, or any HTTP response out of the box, even without relying on <code>django-rest-framework</code>.&#13;
Controller layers then will contain the core data processing and business logic.</p>&#13;
&#13;
<p><a data-primary="progressive web applications (PWAs)" data-type="indexterm" id="id585"/><a data-primary="PWAs (progressive web applications)" data-type="indexterm" id="id586"/>This makes Django an excellent choice for monolith <em>progressive web applications</em> (PWA) that deploy as a single backend with a frontend.&#13;
However, as businesses move toward building specialized teams for developing backends and frontends, microservice architectural patterns are becoming more popular.&#13;
With microservices, you want to separate your backend and frontend services, build APIs instead of PWAs, and focus on keeping your services as lean as possible.&#13;
Using Django you can also build APIs, but you can end up with a heavy application that slows you down during development, deployment, and scaling services.&#13;
That is why nonopinionated frameworks such as Flask are rising in popularity<a data-startref="ix_ch02-asciidoc29" data-type="indexterm" id="id587"/><a data-startref="ix_ch02-asciidoc28" data-type="indexterm" id="id588"/>.<sup><a data-type="noteref" href="ch02.html#id589" id="id589-marker">7</a></sup></p>&#13;
&#13;
<p><a data-primary="Flask" data-type="indexterm" id="ix_ch02-asciidoc30"/>Flask ships with as little code as practically possible for building web servers.&#13;
In comparison to FastAPI, Flask does not come packaged with data validation, auto-documentation, and a dependency injection system.&#13;
The mentioned features are often required for building any backend service that is becoming complex or requires integration with databases and external services.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>A new web framework called Quart has tried to tackle this problem, which is a good contender to FastAPI.&#13;
However, at the time of this writing, Quart is new, and compared to other frameworks it does not have a large community of users and documented resources to help if you get stuck on a problem.</p>&#13;
</div>&#13;
&#13;
<p><a data-primary="Web Server Gateway Interface (WSGI)" data-type="indexterm" id="id590"/><a data-primary="WSGI (Web Server Gateway Interface)" data-type="indexterm" id="id591"/>Furthermore, Flask was released in 2010 and implements a communication protocol called <em>Web Server Gateway Interface</em> (WSGI) for web serving, meaning that requests are processed synchronously in comparison to ASGI, which is asynchronous in nature.&#13;
Additionally, Flask is not designed for handling a large number of simultaneous connections (like an asynchronous framework would). However, this does not limit the number of parallel requests the server can handle on its own.&#13;
In production, you can employ various strategies (like worker processes or threads) to handle multiple requests concurrently.&#13;
Also, because Flask implements WSGI, it does not support WebSocket endpoints, which are used for maintaining a persistent, bidirectional communication channel between a client and a server.&#13;
This is because WSGI does not natively support WebSocket.&#13;
However, you can install Flask extensions to integrate WebSocket support.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id592">&#13;
<h1>Asynchronous Server Gateway Interface</h1>&#13;
<p><a data-primary="Asynchronous Server Gateway Interface (ASGI)" data-type="indexterm" id="id593"/>ASGI-based frameworks can process multiple requests by running concurrent asynchronous operations on the main event loop, allowing it to handle a higher volume of requests at scale.</p>&#13;
&#13;
<p>It can also use a thread pool (i.e., a pool of thread workers) to perform synchronous tasks concurrently without blocking the main server thread.&#13;
Once tasks are finished, these threads return control to the main web server thread and share their results.&#13;
When a thread raises an error, the web server gathers information from the worker thread and sends an error response to the client instead.</p>&#13;
&#13;
<p>Modern web frameworks that implement the ASGI standard are not only more efficient but also provide backward compatibility for WSGI in case it’s necessary.</p>&#13;
</div></aside>&#13;
&#13;
<p>Flask, relying on a WSGI server, will process each request synchronously, whereas &#13;
<span class="keep-together">FastAPI</span> uses an event loop for concurrent workloads.&#13;
Therefore, FastAPI is going to be much faster with input/output (I/O) heavy tasks—for instance, when communicating with an external API or data store, which would block an entire worker process in Flask.</p>&#13;
&#13;
<p>In essence, I recommend Django and other frameworks if you want to build PWA monoliths, and Flask or Quart for simple APIs and frameworks in other languages if you have more experience with them.</p>&#13;
&#13;
<p>However, if you’re building a backend service that requires AI model support, connection to external systems, and some level of business logic complexity, I recommend considering FastAPI as the web framework of choice<a data-startref="ix_ch02-asciidoc30" data-type="indexterm" id="id594"/>.<a data-startref="ix_ch02-asciidoc27" data-type="indexterm" id="id595"/><a data-startref="ix_ch02-asciidoc26" data-type="indexterm" id="id596"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="FastAPI Limitations" data-type="sect1"><div class="sect1" id="fastapi_limitations">&#13;
<h1>FastAPI Limitations</h1>&#13;
&#13;
<p><a data-primary="FastAPI (basics)" data-secondary="limitations" data-type="indexterm" id="ix_ch02-asciidoc31"/>Given the aforementioned features and benefits, there are also several drawbacks and trade-offs you must consider if you are going to adopt FastAPI for your project.&#13;
With AI use cases in mind, FastAPI falls short in several areas.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Inefficient Model Memory Management" data-type="sect2"><div class="sect2" id="id33">&#13;
<h2>Inefficient Model Memory Management</h2>&#13;
&#13;
<p><a data-primary="FastAPI (basics)" data-secondary="limitations" data-tertiary="inefficient model memory management" data-type="indexterm" id="id597"/><a data-primary="model memory" data-type="indexterm" id="id598"/>FastAPI does provide built-in mechanisms for sharing model memory between multiple instances or processes of the same container.&#13;
This means when scaling web workers horizontally, you need to load a whole new model instance into the container’s memory.&#13;
This creates a memory bottleneck and increases operational costs of high-traffic GenAI services.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Limited Number of Threads" data-type="sect2"><div class="sect2" id="id242">&#13;
<h2>Limited Number of Threads</h2>&#13;
&#13;
<p><a data-primary="FastAPI (basics)" data-secondary="limitations" data-tertiary="limited number of threads" data-type="indexterm" id="id599"/><a data-primary="thread pool" data-secondary="limitations" data-type="indexterm" id="id600"/>There is a limit to the number of threads that FastAPI creates on application startup in the internal thread pool.<sup><a data-type="noteref" href="ch02.html#id601" id="id601-marker">8</a></sup></p>&#13;
&#13;
<p>This means there is also a limit to how much you can scale a single instance of &#13;
<span class="keep-together">FastAPI,</span> especially with AI workloads that have heavy I/O as well as CPU/GPU-intensive operations.<sup><a data-type="noteref" href="ch02.html#id602" id="id602-marker">9</a></sup></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Restricted to Global Interpreter Lock" data-type="sect2"><div class="sect2" id="id34">&#13;
<h2>Restricted to Global Interpreter Lock</h2>&#13;
&#13;
<p><a data-primary="FastAPI (basics)" data-secondary="limitations" data-tertiary="Global Interpreter Lock" data-type="indexterm" id="id603"/><a data-primary="Global Interpreter Lock (GIL)" data-type="indexterm" id="id604"/><a data-primary="multithreading" data-secondary="Global Interpreter Lock and" data-type="indexterm" id="id605"/><a data-primary="Python" data-secondary="Global Interpreter Lock (GIL)" data-tertiary="FastAPI limitations" data-type="indexterm" id="id606"/>In Python, multithreading can produce unintuitive and often counterproductive results because of the <em>Global Interpreter Lock</em> (GIL).</p>&#13;
&#13;
<p>FastAPI leverages multithreading via an internal thread pool to handle concurrent web requests hitting a synchronous route.&#13;
However, even with asynchronous endpoints, the AI inference requests can still block the main event loop, preventing all other requests from being processed in the main web serving thread.</p>&#13;
&#13;
<p class="less_space pagebreak-before">This is because AI inference workloads are CPU/GPU intensive.&#13;
Non-I/O operations, such as serving an expensive model or aggregating large amounts of data on a worker, will cause other threads to wait as Python currently is not using multiple cores for threading.<sup><a data-type="noteref" href="ch02.html#id607" id="id607-marker">10</a></sup>&#13;
Instead, as you’ll learn more in <a data-type="xref" href="ch05.html#ch05">Chapter 5</a>, for these kinds of expensive compute operations, you’ll need to use multiprocessing or a process pool instead.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Lack of Support for Micro-Batch Processing Inference Requests" data-type="sect2"><div class="sect2" id="id271">&#13;
<h2>Lack of Support for Micro-Batch Processing Inference Requests</h2>&#13;
&#13;
<p><a data-primary="FastAPI (basics)" data-secondary="limitations" data-tertiary="lack of support for micro-batch processing inference requests" data-type="indexterm" id="id608"/>Deep learning frameworks provide support for vectorization so that inferences can be batched together, efficiently computed, and parallelized.&#13;
Unfortunately, prediction requests can’t be batched together in FastAPI, and as a result, each compute-intensive model inference operation can block other requests.</p>&#13;
&#13;
<p>When scaling services, a solution is to serve heavy models separately and use FastAPI to authenticate and manage the incoming and outgoing data.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Cannot Efficiently Split AI Workloads Between CPU and GPU" data-type="sect2"><div class="sect2" id="id243">&#13;
<h2>Cannot Efficiently Split AI Workloads Between CPU and GPU</h2>&#13;
&#13;
<p><a data-primary="FastAPI (basics)" data-secondary="limitations" data-tertiary="inefficient splitting of AI workloads between CPU and GPU" data-type="indexterm" id="id609"/><a data-primary="GPUs" data-secondary="inefficient splitting by FastAPI of AI workloads between CPU and GPU" data-type="indexterm" id="id610"/>While the CPU mostly handles request transformation and validation operations, the GPU can run and parallelize compute-intensive model inference.&#13;
In some specialized ML web frameworks (like BentoML), you can also efficiently split AI workloads between the CPU and GPU.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>When you split AI workloads across the CPU and GPU, data preparation and post-processing operations run on the CPU, while faster deep learning inference is performed on the GPU.</p>&#13;
</div>&#13;
&#13;
<p>Unfortunately, FastAPI can’t efficiently perform this split of the AI inference workload between these devices. This means your CPU can be blocked from processing requests even when inference processes are running on the GPU.&#13;
As this is a big bottleneck when working with heavier models, it will require serving heavier models outside FastAPI for concurrent workloads.</p>&#13;
&#13;
<p>We’ll discuss solutions to this limitation in more detail in <a data-type="xref" href="ch05.html#ch05">Chapter 5</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="less_space pagebreak-before" data-pdf-bookmark="Dependency Conflicts" data-type="sect2"><div class="sect2" id="id35">&#13;
<h2>Dependency Conflicts</h2>&#13;
&#13;
<p><a data-primary="dependency conflicts, FastAPI limitations in handling" data-type="indexterm" id="id611"/><a data-primary="FastAPI (basics)" data-secondary="limitations" data-tertiary="dependency conflicts" data-type="indexterm" id="id612"/>When you are deploying ML models, you will face unique challenges compared to deploying typical web applications.&#13;
This is due to your model runtime’s deep coupling with native libraries and hardware.&#13;
Each deployment environment can operate on distinct hardware and may require you to use specific versions of native libraries and containerization commands.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Lack of Support for Resource-Intensive AI Workloads" data-type="sect2"><div class="sect2" id="id36">&#13;
<h2>Lack of Support for Resource-Intensive AI Workloads</h2>&#13;
&#13;
<p><a data-primary="FastAPI (basics)" data-secondary="limitations" data-tertiary="lack of support for resource-intensive AI workloads" data-type="indexterm" id="id613"/>Despite its incredible capabilities, FastAPI was developed before the rise of generative AI.&#13;
As a result, it remains a general-purpose web framework with recent support for AI serving and ML workflows.&#13;
However, for certain use cases, such as serving resource-intensive and complex billion-parameter models, it may be worth exploring other frameworks like <em>BentoML</em>.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id614">&#13;
<h1>BentoML: FastAPI-Inspired Framework for &#13;
<span class="keep-together">Running Resource-Intensive AI Models</span></h1>&#13;
<p><a data-primary="BentoML" data-type="indexterm" id="id615"/><a data-primary="Starlette, BentoML and" data-type="indexterm" id="id616"/>BentoML is also built on top of Starlette and is designed with FastAPI patterns in mind but specifically for machine learning.&#13;
Its architecture allows for scaling web requests separately from model inference, providing flexibility in computing &#13;
<span class="keep-together">distributions.</span></p>&#13;
&#13;
<p>It addresses unique ML workflow challenges using its Runners, dependency management, and model versioning systems.&#13;
Through its dependency management system, it can effectively speed up deployments by declaratively auto-generating Dockerfiles for you so that you do not have to debug complex Docker commands to install and use CUDA libraries for GPU inference.</p>&#13;
&#13;
<p>Later in the book, I will present a FastAPI architecture for resource-intensive AI workflows that uses BentoML as the underlying AI server.&#13;
In this architecture, model-serving tasks will be delegated to BentoML, while FastAPI will manage security, caching, and business logic for you.</p>&#13;
</div></aside>&#13;
&#13;
<p>In the following chapters, you’ll learn how to build your own GenAI service with &#13;
<span class="keep-together">FastAPI.</span></p>&#13;
&#13;
<p>But before moving forward, let’s configure necessary Python tools like linters, formatters, and type checkers in your development environment for easier maintainability of your FastAPI project as we work on it together.<a data-startref="ix_ch02-asciidoc31" data-type="indexterm" id="id617"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="less_space pagebreak-before" data-pdf-bookmark="Setting Up a Managed Python Environment and Tooling" data-type="sect1"><div class="sect1" id="id37">&#13;
<h1>Setting Up a Managed Python Environment and Tooling</h1>&#13;
&#13;
<p><a data-primary="FastAPI (basics)" data-secondary="setting up a managed Python environment/tooling" data-type="indexterm" id="ix_ch02-asciidoc32"/><a data-primary="Python" data-secondary="setting up a managed Python environment/tooling" data-type="indexterm" id="ix_ch02-asciidoc33"/>To maintain a stable and reproducible development environment, you may want to manage your Python environment and dependencies.</p>&#13;
&#13;
<p>I recommend:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Using a <em>requirements.txt</em> file with <code>pip</code> for simpler projects</p>&#13;
</li>&#13;
<li>&#13;
<p>Using <a href="https://oreil.ly/Qxl7h">uv</a> or <a href="https://oreil.ly/Kfsc4">Conda</a> for <code>pip</code>-driven workflows</p>&#13;
</li>&#13;
<li>&#13;
<p>Using <a href="https://oreil.ly/Rt04z">Poetry</a> for more complex projects</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Aside from managing dependencies, Python also has several third-party packages that allow you to lint and format your codebase before shipping it into production.<sup><a data-type="noteref" href="ch02.html#id618" id="id618-marker">11</a></sup></p>&#13;
&#13;
<p>It is best practice for professional Python developers to use these tools to catch bugs during development and before adding changes to the code repository.&#13;
In fact, I recommend that you run code checks with these tools against your codebase frequently to prevent bugs from appearing in your services.</p>&#13;
&#13;
<p>Here is a nonexhaustive list of Python packages that I recommend integrating into any project you start:</p>&#13;
<dl>&#13;
<dt>Linters</dt>&#13;
<dd>&#13;
<p><a data-primary="linters" data-type="indexterm" id="id619"/>These tools analyze source code to flag programming errors, stylistic errors, and unused code snippets:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><em>Autoflake</em>: Removes unused imports and variables from code to improve readability</p>&#13;
</li>&#13;
<li>&#13;
<p><em>Flake8</em>: Checks against Python enhancement proposals (PEPs) and code styles</p>&#13;
</li>&#13;
</ul>&#13;
</dd>&#13;
<dt>Formatters</dt>&#13;
<dd>&#13;
<p><a data-primary="formatters (Python packages)" data-type="indexterm" id="id620"/>These enable you to better see what you have written:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><em>isort</em>: Sorts imports in Python modules</p>&#13;
</li>&#13;
<li>&#13;
<p><em>Black</em>: Formats Python code for readability</p>&#13;
</li>&#13;
<li>&#13;
<p><em>Ruff</em>: Rust-based linter and formatter that is extremely fast and can be used &#13;
<span class="keep-together">as a</span> replacement for other tools such as <code>isort</code>, <code>black</code>, <code>flake8</code>, and possibly <code>bandit</code><sup><a data-type="noteref" href="ch02.html#id621" id="id621-marker">12</a></sup></p>&#13;
</li>&#13;
</ul>&#13;
</dd>&#13;
<dt>Loggers</dt>&#13;
<dd>&#13;
<p><a data-primary="loggers/logging" data-secondary="Python packages" data-type="indexterm" id="id622"/>Used in parts of the code that gets complex to debug and monitor your &#13;
<span class="keep-together">application:</span></p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><em>Loguru</em>: Replacing Python’s built-in logger module</p>&#13;
</li>&#13;
</ul>&#13;
</dd>&#13;
<dt>Scanners</dt>&#13;
<dd>&#13;
<p><a data-primary="scanners (Python packages)" data-type="indexterm" id="id623"/>If you want confidence that you did not commit insecure code or passwords by chance:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><em>Bandit</em>: Vulnerability scanning of your Python codebase with checking against common security issues such as hard-coded secrets</p>&#13;
</li>&#13;
<li>&#13;
<p><em>Safety</em>: Python dependency vulnerability scanner to detect packages with known vulnerabilities or malicious packages</p>&#13;
</li>&#13;
</ul>&#13;
</dd>&#13;
<dt>Type checkers</dt>&#13;
<dd>&#13;
<p><a data-primary="type checkers" data-type="indexterm" id="id624"/>To catch those bugs that normal linters do not catch.&#13;
Also, great if you want confidence that changes in your schemas did not break your application:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><em>Mypy</em>: A powerful static type checker that can help catch a lot of bugs in your code</p>&#13;
</li>&#13;
<li>&#13;
<p><em>Pylance</em>: A type checker that ships with Microsoft’s Python extension for VS Code</p>&#13;
</li>&#13;
</ul>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>As part of your development environment, it’s also worthwhile to use version control systems like Git to track codebase changes, manage different versions of your project, and manage code contributions from other developers.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>When using Git, you can also add <em>.gitignore</em> files to help you manage files and directories that you want excluded from version control tracking.</p>&#13;
</div>&#13;
&#13;
<p><a data-primary="plug-ins" data-type="indexterm" id="id625"/>Integrated development environments (IDEs) such as VS Code or JetBrains Pycharm provide plug-ins for running these tools as you type or save your work.&#13;
They often require some configuration, but once done, you will get auto-formatting and linting set up and ready before you begin.&#13;
In any case, I recommend having a script or pre-commit hooks that lints, checks, and formats your code before you commit to your codebase or deploy it to production.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>I’ve prepared a <a href="https://oreil.ly/j8lF7">FastAPI blank template</a> that includes integrations with common tools that you can use as a foundation for your projects.</p>&#13;
</div>&#13;
&#13;
<p>These are fundamentals of Python programming and software engineering.&#13;
They will become crucial when you start working with AI models that can produce probabilistic outputs as well as external services and databases that can change schemas at any time.&#13;
Maintaining an AI application that changes schemas and prompts constantly without the aforementioned tools can definitively become a headache quite fast.<a data-startref="ix_ch02-asciidoc33" data-type="indexterm" id="id626"/><a data-startref="ix_ch02-asciidoc32" data-type="indexterm" id="id627"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="id38">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>In this chapter, you learned about the FastAPI framework, including its capabilities and drawbacks compared to other frameworks.</p>&#13;
&#13;
<p>You also learned how to set up your own FastAPI project from scratch, alongside a set of tools you can use to improve your development experience.</p>&#13;
&#13;
<p>Then you were introduced to several project structures you can adopt when building your own FastAPI service.&#13;
As part of this, you learned more about the onion/layered software design pattern to help manage project complexity.</p>&#13;
&#13;
<p>Finally, we covered tools you can use to manage your Python environments and help maintain your FastAPI codebase as it grows in complexity.</p>&#13;
&#13;
<p>You should now be comfortable starting your own FastAPI projects and managing the project complexity as it evolves over time.<a data-startref="ix_ch02-asciidoc0" data-type="indexterm" id="id628"/></p>&#13;
&#13;
<p>In the next chapter, you will learn how to implement your own GenAI features in FastAPI for generating text, image, audio, and video.&#13;
You will understand the inner workings of each model and the role of FastAPI lifecycle system in model serving, while leveraging NVIDIA GPUs for inference tasks.&#13;
Finally, you will be introduced to the FastAPI background tasks system to offload long-running inference operations.</p>&#13;
</div></section>&#13;
<div data-type="footnotes"><p data-type="footnote" id="id507"><sup><a href="ch02.html#id507-marker">1</a></sup> Large parts of Pydantic v2’s data validation logic have been rewritten in Rust for significant performance improvements.</p><p data-type="footnote" id="id511"><sup><a href="ch02.html#id511-marker">2</a></sup> The <code>fastapi dev</code> command searches your project directories for a FastAPI <code>app</code> object. If you’re having issues starting your FastAPI server, consult its documentation using <code>fastapi dev --help</code>.</p><p data-type="footnote" id="id527"><sup><a href="ch02.html#id527-marker">3</a></sup> To perform model inference</p><p data-type="footnote" id="id530"><sup><a href="ch02.html#id530-marker">4</a></sup> Coming from the Starlette framework</p><p data-type="footnote" id="id554"><sup><a href="ch02.html#id554-marker">5</a></sup> FastAPI’s new lifespan events replace the deprecated startup/shutdown events in older versions.</p><p data-type="footnote" id="id561"><sup><a href="ch02.html#id561-marker">6</a></sup> An external dependency</p><p data-type="footnote" id="id589"><sup><a href="ch02.html#id589-marker">7</a></sup> As is clear by their number of monthly downloads</p><p data-type="footnote" id="id601"><sup><a href="ch02.html#id601-marker">8</a></sup> FastAPI relies on <code>AnyIO</code> (an asynchronous networking and concurrency library) to handle concurrency. <code>AnyIO</code> creates up to 40 threads by default on a dynamic internal thread pool and removes those that aren’t used for a while.</p><p data-type="footnote" id="id602"><sup><a href="ch02.html#id602-marker">9</a></sup> Unless you run the GPU operations in another process (via multiprocessing) and await the operations</p><p data-type="footnote" id="id607"><sup><a href="ch02.html#id607-marker">10</a></sup> However, according to <a href="https://oreil.ly/_bRzj">PEP 703</a>, GIL will be made optional in CPython soon.</p><p data-type="footnote" id="id618"><sup><a href="ch02.html#id618-marker">11</a></sup> Refer to <a href="https://oreil.ly/6YWRN">Hypermodern’s GitHub repository</a> for tooling examples.</p><p data-type="footnote" id="id621"><sup><a href="ch02.html#id621-marker">12</a></sup> You can use <code>ruff</code> for faster checks in CI/CD pipelines, unless your development environment or CI/CD pipeline is tightly integrated with the other tools.</p></div></div></section></body></html>
- en: Chapter 9\. Using APIs for Data Analytics
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第9章。使用API进行数据分析
- en: Your eyes see the game much better than the numbers. But the numbers see *all*
    the games.
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: 你的眼睛比数字更能看懂比赛。但数字能看到*所有*比赛。
- en: ''
  id: totrans-2
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: Dean Oliver, sports statistician
  id: totrans-3
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: 迪恩·奥利弗，体育统计学家
- en: The sports world loves all forms of *data analytics*—charts, graphs, and statistics
    that describe the results of events or predict what will happen next. When a sports
    fan views those data analytics, they probably never consider what data source
    was used to create them. In many cases, the data source is an API. In this chapter,
    you will learn best practices for consuming APIs and creating data analytics products
    using Jupyter Notebooks, a popular tool used by data scientists.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 体育界喜欢所有形式的数据分析——图表、图形和统计数据，它们描述了事件的结果或预测接下来会发生什么。当体育迷查看这些数据分析时，他们可能从未考虑过用于创建它们的数据来源。在许多情况下，数据来源是一个API。在本章中，你将学习使用Jupyter
    Notebooks（数据科学家常用的流行工具）消费API和创建数据分析产品的最佳实践。
- en: Custom Metrics for Sports Analytics
  id: totrans-5
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 体育分析的自定义指标
- en: One of the most celebrated forms of analytics is the *custom metric*, a calculation
    that summarizes complicated behavior, ability, and outcomes as a number. Every
    sport has metrics that players, coaches, managers, and fans pay attention to.
    Baseball has the longest history with metrics, from the historical *earned run
    average* (ERA) to the modern *weighted runs created plus* (wRC+) and *wins against
    replacement* (WAR). Soccer fans and professionals alike focus on the *expected
    goals* (xG), a method of defining quality shots that has motivated a variety of
    [secret-sauce models](https://oreil.ly/HHSL0). The NBA uses the *player efficiency
    rating* (PER) to measure a basketball player’s all-around value.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 最受赞誉的分析形式之一是*自定义指标*，这是一种将复杂的行为、能力和结果总结为数字的计算。每个运动都有玩家、教练、经理和球迷关注的指标。棒球在指标方面有着悠久的历史，从历史性的*
    earned run average*（ERA）到现代的*weighted runs created plus*（wRC+）和*wins against replacement*（WAR）。足球迷和专业人士都关注*expected
    goals*（xG），这是一种定义高质量射门的方法，它激发了各种[秘密酱模型](https://oreil.ly/HHSL0)。NBA使用*player efficiency
    rating*（PER）来衡量篮球运动员的全局价值。
- en: Some of the most interesting work in custom metrics is happening in football,
    where the NFL has sponsored an annual analytics contest called the [Big Data Bowl](https://oreil.ly/5h1RE),
    where data students and professionals research and propose new metrics for prizes,
    job prospects, and the excitement of seeing their work included in TV broadcasts.
    It has a special track devoted to creating new custom metrics, such as *converted
    tackle opportunity* and *path analysis via swarm-tackle accuracy* (PASTA). Some
    have made their way into the broadcast booth, and more are on the way.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 在自定义指标方面，一些最有趣的工作发生在足球领域，那里NFL赞助了一个名为[大数据碗](https://oreil.ly/5h1RE)的年度分析竞赛，数据学生和专业人士在这里研究和提出新的指标以换取奖金、就业前景以及看到他们的工作被纳入电视转播的兴奋。它有一个专门用于创建新自定义指标的赛道，例如*转换擒抱机会*和*通过群组擒抱准确性的路径分析*（PASTA）。一些指标已经进入了解说席，更多正在路上。
- en: 'Every custom metric requires a few components to succeed:'
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 每个自定义指标都需要一些组件才能成功：
- en: Question
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 问题
- en: 'What question is it trying to solve? It should be general enough to have broad
    application but specific enough to add new knowledge to the sport. For example,
    the [KenPom ranking](https://oreil.ly/2MIk3) answers the question: which college
    basketball teams deserve to make the NCAA tournament field?'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 它试图解决什么问题？它应该足够通用以具有广泛的应用，但也要足够具体，以向运动领域添加新知识。例如，[KenPom排名](https://oreil.ly/2MIk3)回答了以下问题：哪些大学篮球队有资格进入NCAA锦标赛？
- en: Theory
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 理论
- en: By choosing specific numbers to measure and weighing them against each other,
    you make a value judgment. You are proposing subcomponents that matter to answer
    a question.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 通过选择特定的数字来衡量并将它们相互权衡，你做出了价值判断。你正在提出有助于回答问题的子组件。
- en: Valid approach
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 有效的途径
- en: Do the underlying calculations support the purpose of the metric?
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 基础计算是否支持指标的目的？
- en: Data source
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 数据来源
- en: Can you get data to calculate the metric at a reasonable frequency? If data
    isn’t available, your approach and the supporting theory may have to be adjusted
    out of practicality.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 你能否获取数据以合理频率计算指标？如果数据不可用，你的方法和支持的理论可能需要根据实用性进行调整。
- en: Name
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 名称
- en: This is the fun part. The more interesting the name, the more impact it can
    have.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 这是最有趣的部分。名字越有趣，它的影响力就越大。
- en: Using APIs as Data Sources for Fantasy Custom Metrics
  id: totrans-19
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用API作为梦幻自定义指标的数据源
- en: 'Fantasy sports enthusiasts love analytics and metrics too. Fantasy league websites
    provide a lot of stats and charts, but commissioners and managers sometimes want
    to create their own. Since the fantasy league data is updated frequently, an automated
    process is key to making the calculations repeatable and consistent. To gather
    this data in software code, two primary choices are available: APIs or *web scraping*.
    Web scraping involves using program code to read the HTML from a website page
    and extract the data. The technique is powerful but brittle: every time the website
    structure changes, the web scraper code stops working and has to be modified and
    tested again. But if the league website maintains an API, the data is available
    even when changes to the layout or structure of the web page occur.'
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 幻想体育爱好者也喜欢分析和指标。幻想联赛网站提供了大量的统计数据和图表，但委员会和管理员有时想创建自己的。由于幻想联赛数据频繁更新，自动化过程对于使计算可重复和一致至关重要。为了在软件代码中收集这些数据，有两种主要选择：API或*网络抓取*。网络抓取涉及使用程序代码读取网站页面的HTML并提取数据。这项技术功能强大但脆弱：每次网站结构发生变化时，网络抓取代码就会停止工作，并需要修改和再次测试。但是，如果联赛网站维护API，即使网页布局或结构发生变化，数据也是可用的。
- en: A web search turns up various examples of fantasy managers who share their custom
    metrics for others to use. The most feature-rich metric I have found is the [Leeger
    Python library](https://oreil.ly/leegpy), which is maintained by software engineer
    Joey Greco. It is an open source project that generates custom metrics from six
    fantasy football websites. Appropriate for this chapter, Leeger uses APIs heavily.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 网上搜索可以找到许多幻想经理分享他们自定义指标供他人使用的例子。我发现功能最丰富的指标是[Leeger Python库](https://oreil.ly/leegpy)，由软件工程师乔伊·格雷科维护。这是一个开源项目，可以从六个幻想足球网站生成自定义指标。对于本章来说，Leeger大量使用了API。
- en: You read some of Joey’s advice about SDKs in [Chapter 7](ch07.html#chapter_7).
    I talked to him about how he uses APIs to create metrics with Leeger.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 你在[第7章](ch07.html#chapter_7)中阅读了一些关于SDK的乔伊的建议。我和他谈了他是如何使用Leeger的API来创建指标的。
- en: 'The Leeger app that Joey created contains dozens of custom metrics that are
    calculated from data extracted from league website APIs. They have entertaining
    names, such as Adjusted Team Luck and Smart Wins. Here is the calculation behind
    the AWAL stat that Greco mentioned:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 乔伊创建的Leeger应用程序包含数十个从联盟网站API提取的数据计算出的自定义指标。它们有有趣的名字，例如调整后的团队运气和智能胜利。以下是格雷科提到的AWAL统计数据背后的计算方法：
- en: '[PRE0]'
  id: totrans-24
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'Creating a Custom Metric: The Shark League Score'
  id: totrans-25
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 创建自定义指标：鲨鱼联盟得分
- en: 'Now it’s your turn to create a custom metric: the Shark League Score. [Figure 9-1](#ch9_architecture_jupyter)
    shows the high-level architecture of the project you will create in this chapter.'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 现在轮到你自己创建一个自定义指标：鲨鱼联盟得分。[图9-1](#ch9_architecture_jupyter)显示了本章中你将创建的项目的高级架构。
- en: '![High-level architecture](assets/haad_0901.png)'
  id: totrans-27
  prefs: []
  type: TYPE_IMG
  zh: '![高级架构](assets/haad_0901.png)'
- en: Figure 9-1\. High-level architecture
  id: totrans-28
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图9-1\. 高级架构
- en: 'The question it seeks to answer is: “How tough is our fantasy league?” A real
    fantasy shark is a manager who knows their stuff: they are prepared for the draft,
    they scour the waiver wire for the best players, and they always seem to start
    the right lineup. A league filled with owners like this is a Shark League, and
    making the playoffs in this type of league is a badge of honor. Winning a title
    in a Shark League—​that is a victory to savor for a lifetime.'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 它试图回答的问题是：“我们的幻想联赛有多艰难？”一个真正的幻想鲨鱼是知道自己的经理：他们为选秀做准备，他们搜寻弃权名单上的最佳球员，并且他们似乎总是能组建正确的阵容。一个充满这类所有者的联盟是鲨鱼联盟，在这个联盟中进入季后赛是一种荣誉的标志。在鲨鱼联盟中赢得冠军——这是一个值得终身回味的胜利。
- en: The theory of the Shark League Score is based on a few attributes of efficient
    managers. First, Shark Leagues should be balanced from top to bottom—​there should
    be no easy weeks on the schedule. Second, the league as a whole should be picking
    up the best players and getting them in rosters to score points. One supporting
    theory is that fantasy regular season stats (usually weeks 1 through 14) are more
    appropriate than fantasy playoffs (week 15 and beyond) because all teams are playing.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 鲨鱼联盟得分理论基于高效经理的一些属性。首先，鲨鱼联盟应该从上到下保持平衡——日程安排中不应该有容易的周。其次，整个联盟应该挑选最佳球员并将他们列入阵容以得分。一个支持理论是，幻想常规赛统计数据（通常是第1周至第14周）比幻想季后赛（第15周及以后）更合适，因为所有球队都在比赛。
- en: There are a few additional items that could arguably be included but are not
    supported by the SportsWorldCentral API. For instance, a Shark League should rarely
    or never have an empty roster spot in the weekly starters. Another sign of efficient
    owners is picking up the “hot free agents” before they have their big weeks—​that
    would be especially tricky to measure.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 有一些额外的项目可以被认为是可以包括在内的，但并不被 SportsWorldCentral API 支持。例如，鲨鱼联赛很少或永远不会在每周首发阵容中有空缺位置。高效所有者的另一个标志是在“热门自由球员”有大周之前就签下他们——这将特别难以衡量。
- en: 'As you go through the examples in this chapter, you will develop the Shark
    League Score, as well as two supporting metrics: the League Balance Score and
    League Juice Score. It’s time to get started!'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 随着您在本章中的示例学习，您将开发鲨鱼联赛得分，以及两个支持性指标：联赛平衡得分和联赛活力得分。是时候开始了！
- en: Software Used in This Chapter
  id: totrans-33
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 本章使用的软件
- en: '[Table 9-1](#tools_table_chapter_9) lists a few of the software components
    you will begin using in this chapter.'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: '[表 9-1](#tools_table_chapter_9) 列出了您将在本章开始使用的几个软件组件。'
- en: Table 9-1\. Key tools or services used in this chapter
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 表 9-1\. 本章使用的关键工具或服务
- en: '| Software name | Purpose |'
  id: totrans-36
  prefs: []
  type: TYPE_TB
  zh: '| 软件名称 | 用途 |'
- en: '| --- | --- |'
  id: totrans-37
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- |'
- en: '| backoff | Python library for adding backoff and retry to web calls |'
  id: totrans-38
  prefs: []
  type: TYPE_TB
  zh: '| backoff | 用于向网络调用添加回退和重试的 Python 库 |'
- en: '| httpx | Python library for making web calls |'
  id: totrans-39
  prefs: []
  type: TYPE_TB
  zh: '| httpx | 用于进行网络调用的 Python 库 |'
- en: '| Jupyter Notebooks | Interactive data science environment |'
  id: totrans-40
  prefs: []
  type: TYPE_TB
  zh: '| Jupyter Notebooks | 交互式数据科学环境 |'
- en: '| pandas | Data analysis and formatting library |'
  id: totrans-41
  prefs: []
  type: TYPE_TB
  zh: '| pandas | 数据分析和格式化库 |'
- en: httpx
  id: totrans-42
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: httpx
- en: The Python library you will use for calling APIs is httpx. This library is very
    similar to the popular requests library but also supports asynchronous API calls.
    For more information about httpx, read [Chapter 4](ch04.html#chapter_4).
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 您将使用的用于调用 API 的 Python 库是 httpx。这个库与流行的 requests 库非常相似，但也支持异步 API 调用。有关 httpx
    的更多信息，请参阅 [第 4 章](ch04.html#chapter_4)。
- en: You will use version 27.x of httpx to stay consistent with the version used
    in [Part I](part01.html#part_1).
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 您将使用 httpx 的 27.x 版本，以保持与 [第一部分](part01.html#part_1) 中使用的版本一致。
- en: Jupyter Notebooks
  id: totrans-45
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Jupyter Notebooks
- en: Jupyter Notebooks support a unique way to perform data science. This mode is
    called *interactive computing*, and it allows you to mix code cells, Markdown
    comment cells, and results. Cells flow from the top of a notebook to the bottom,
    and variables and libraries that have been run previously are available to cells
    that run later. (If you run cells only sequentially, that would mean the cells
    below, but you can run cells out of order.) In addition to this interactive mode,
    Jupyter Notebooks also provide Markdown cells that run between code cells, which
    allows you to create richly formatted documents that interweave code, results,
    and documentation. The notebook style of programming is heavily used by data scientists,
    who value its ability to store the results of prior work along with the code that
    went into creating it.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: Jupyter Notebooks 支持一种独特的数据科学执行方式。这种模式被称为 *交互式计算*，它允许您混合代码单元、Markdown 注释单元和结果。单元从笔记本的顶部流向底部，之前运行过的变量和库对后续运行的单元可用。（如果您仅按顺序运行单元，则意味着下面的单元，但您可以按顺序外运行单元。）除了这种交互式模式之外，Jupyter
    Notebooks 还提供在代码单元之间运行的 Markdown 单元，这允许您创建丰富格式的文档，这些文档交织着代码、结果和文档。笔记本风格的编程被数据科学家广泛使用，他们重视其能够存储先前工作的结果以及创建它的代码。
- en: Jupyter Notebooks are supported out of the box with the default VS Code installation
    in your GitHub Codespace. You will run notebooks directly in VS Code by creating
    a file with the *.ipynb* extension. Project Jupyter has many more options and
    features beyond what you will learn in this chapter; you can learn more about
    them at the [Jupyter project home page](https://jupyter.org).
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: Jupyter Notebooks 在您的 GitHub Codespace 的默认 VS Code 安装中直接支持。您将通过创建一个具有 *.ipynb*
    扩展名的文件来直接在 VS Code 中运行笔记本。Project Jupyter 有许多更多选项和功能，超出了本章所学的范围；您可以在 [Jupyter
    项目主页](https://jupyter.org) 上了解更多信息。
- en: You will use the default version of Jupyter that comes installed in Codespaces.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 您将使用 Codespaces 中预装的 Jupyter 的默认版本。
- en: pandas
  id: totrans-49
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: pandas
- en: For data scientists using Python, one of the most trusted libraries is pandas.
    For data scientists, it is one of the first imports you include in almost any
    Python program. The pandas library provides Python a data type called a `DataFrame`,
    which is a two-dimensional structure with rows and columns. This spreadsheet-like
    format is a natural way of viewing data in rows and columns.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 对于使用 Python 的数据科学家来说，最值得信赖的库之一是 pandas。对于数据科学家来说，它几乎是任何 Python 程序中第一个导入的库之一。pandas
    库为 Python 提供了一种名为 `DataFrame` 的数据类型，它是一个具有行和列的二维结构。这种类似电子表格的格式是按行和列查看数据的一种自然方式。
- en: The library also provides many methods for data manipulation, filtering, and
    formatting. As mentioned in [Chapter 1](ch01.html#chapter_1) of this book, data
    scientists spend more than one-third of their time preparing and cleansing data.
    The pandas library is a powerful tool for this type of work. The [official pandas
    user guide](https://oreil.ly/X4vXa) is a great reference for this library.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 该库还提供了许多用于数据处理、过滤和格式化的方法。正如本书第 1 章 [Chapter 1](ch01.html#chapter_1) 中提到的，数据科学家将超过三分之一的时光用于准备和清洗数据。pandas
    库是这类工作的强大工具。该库的[官方用户指南](https://oreil.ly/X4vXa)是该库的优秀参考资料。
- en: You will use the default version of pandas that comes installed in GitHub Codespaces.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 您将使用 GitHub Codespaces 中预装的 pandas 的默认版本。
- en: Installing the New Libraries in Your Codespace
  id: totrans-53
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 在您的 Codespace 中安装新库
- en: 'To install the libraries you need for this chapter, create a file named *chapter9/requirements.txt*:'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 要安装本章所需的库，创建一个名为 *chapter9/requirements.txt* 的文件：
- en: '[PRE1]'
  id: totrans-55
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Update *chapter9/requirements.txt* with the following contents:'
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 更新 *chapter9/requirements.txt* 文件，内容如下：
- en: '[PRE2]'
  id: totrans-57
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: '[![1](assets/1.png)](#co_using_apis_for_data_analytics_CO1-1)'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: '![1](assets/1.png)[#co_using_apis_for_data_analytics_CO1-1](#co_using_apis_for_data_analytics_CO1-1)'
- en: This is the standard Python logging module.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 这是标准的 Python 日志模块。
- en: '[![2](assets/2.png)](#co_using_apis_for_data_analytics_CO1-2)'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: '![2](assets/2.png)[#co_using_apis_for_data_analytics_CO1-2](#co_using_apis_for_data_analytics_CO1-2)'
- en: This library provides backoff and retry functionality for API calls. See [Chapter 7](ch07.html#chapter_7)
    for more details.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 该库为 API 调用提供了退避和重试功能。有关更多详细信息，请参阅[第 7 章](ch07.html#chapter_7)。
- en: 'Execute the following command to install the new libraries in your Codespace:'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 执行以下命令以在您的 Codespace 中安装新库：
- en: '[PRE3]'
  id: totrans-63
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: You should see a message that states that these libraries were successfully
    installed.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 您应该会看到一个消息，表明这些库已成功安装。
- en: Launching Your API in Codespaces
  id: totrans-65
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 在 Codespaces 中启动您的 API
- en: To access your API data, you will need to launch v0.2 of your API in the terminal.
    For instructions, read [“Running the SportsWorldCentral (SWC) API Locally”](ch08.html#sportsworldcentral).
    Copy the URL of your API from the browser address bar to use as the base URL in
    this chapter.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 要访问您的 API 数据，您需要在终端中启动 API 的 0.2 版本。有关说明，请参阅“在本地运行 SportsWorldCentral (SWC)
    API” [“Running the SportsWorldCentral (SWC) API Locally”](ch08.html#sportsworldcentral)。从浏览器地址栏复制您的
    API URL，用作本章中的基本 URL。
- en: Creating an API Client File
  id: totrans-67
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 创建 API 客户端文件
- en: You will create a standalone Python file to make all calls to your API. By maintaining
    this file separate from the Jupyter Notebook, you keep special API-related logic
    in one place and make it available to multiple notebooks.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 您将创建一个独立的 Python 文件来调用您的 API。通过将此文件与 Jupyter Notebook 保持分离，您可以将特殊的 API 相关逻辑放在一个地方，并使其可供多个笔记本使用。
- en: You will use the backoff library to implement exponential backoff and retry
    with jitter, which makes your API calls more reliable without overwhelming the
    source API. You use the HTTPX client in a context manager style. [Chapter 7](ch07.html#chapter_7)
    uses these techniques and a few more to create a full-featured Python SDK. Using
    SDKs when available is also helpful for Jupyter Notebooks, but for this chapter,
    you will add most of the features yourself.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 您将使用 backoff 库来实现指数退避和带有抖动的重试，这使您的 API 调用更加可靠，而不会压倒源 API。您以上下文管理器风格使用 HTTPX
    客户端。[第 7 章](ch07.html#chapter_7) 使用这些技术以及一些其他技术来创建一个功能齐全的 Python SDK。当可用时，使用 SDK
    对 Jupyter Notebooks 也是很有帮助的，但在此章中，您将自行添加大多数功能。
- en: Tip
  id: totrans-70
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 小贴士
- en: Version 0.2 of the API has several new endpoints that you didn’t create in [Part I](part01.html#part_1).
    To explore the format of the new endpoints, access the interactive API docs using
    Swagger UI at the */docs* endpoint on your API.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: API 的 0.2 版本有几个您在第一部分 [Part I](part01.html#part_1) 中没有创建的新端点。要探索新端点的格式，请使用 Swagger
    UI 通过 API 的 */docs* 端点访问交互式 API 文档。
- en: 'Create a new Python file in the terminal as shown:'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 在终端中创建一个新的 Python 文件，如下所示：
- en: '[PRE4]'
  id: totrans-73
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'Update *swc_simple_client.py* with the following code:'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 使用以下代码更新 *swc_simple_client.py* 文件：
- en: '[PRE5]'
  id: totrans-75
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: '[![1](assets/1.png)](#co_using_apis_for_data_analytics_CO2-1)'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: '![1](assets/1.png)[#co_using_apis_for_data_analytics_CO2-1](#co_using_apis_for_data_analytics_CO2-1)'
- en: The URL endpoints are set as variables that can be used when calling the client.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: URL端点被设置为变量，可以在调用客户端时使用。
- en: '[![2](assets/2.png)](#co_using_apis_for_data_analytics_CO2-2)'
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: '![2](assets/2.png)(#co_using_apis_for_data_analytics_CO2-2)'
- en: This statement gets a reference to the log file.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 此语句获取日志文件的引用。
- en: '[![3](assets/3.png)](#co_using_apis_for_data_analytics_CO2-3)'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: '![3](assets/3.png)(#co_using_apis_for_data_analytics_CO2-3)'
- en: This decorator adds backoff and retry functionality to the `call_api_endpoint`
    function. For more information about the settings, see the [backoff documentation](https://oreil.ly/c_4yV).
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 此装饰器为`call_api_endpoint`函数添加了回退和重试功能。有关设置信息，请参阅[backoff文档](https://oreil.ly/c_4yV)。
- en: '[![4](assets/4.png)](#co_using_apis_for_data_analytics_CO2-4)'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: '![4](assets/4.png)(#co_using_apis_for_data_analytics_CO2-4)'
- en: This allows you to pass in parameters to the API.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 这允许您向API传递参数。
- en: '[![5](assets/5.png)](#co_using_apis_for_data_analytics_CO2-5)'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: '![5](assets/5.png)(#co_using_apis_for_data_analytics_CO2-5)'
- en: This statement uses the HTTPX client in a resource manager style, which makes
    the API call and then cleans up resources when it finishes.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 此语句使用HTTPX客户端以资源管理器风格，在API调用完成后清理资源。
- en: '[![6](assets/6.png)](#co_using_apis_for_data_analytics_CO2-6)'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: '![6](assets/6.png)(#co_using_apis_for_data_analytics_CO2-6)'
- en: This statement logs the data in the API response for debugging.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 此语句将API响应中的数据记录下来以供调试。
- en: '[![7](assets/7.png)](#co_using_apis_for_data_analytics_CO2-7)'
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: '![7](assets/7.png)(#co_using_apis_for_data_analytics_CO2-7)'
- en: If errors occur, they are logged with an `ERROR` type.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 如果发生错误，它们将以`ERROR`类型记录。
- en: '[![8](assets/8.png)](#co_using_apis_for_data_analytics_CO2-8)'
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: '![8](assets/8.png)(#co_using_apis_for_data_analytics_CO2-8)'
- en: In case of error, the client returns an `httpx.response` object with the error
    code and message.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 如果发生错误，客户端将返回一个包含错误代码和信息的`httpx.response`对象。
- en: Creating Your Jupyter Notebook
  id: totrans-92
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 创建您的Jupyter笔记本
- en: 'To get started, run the following commands in the Terminal window at the bottom
    of the screen to create the new directory and the Jupyter Notebook you will be
    using in this chapter:'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 要开始，请在屏幕底部的终端窗口中运行以下命令以创建新目录和您在本章中将使用的Jupyter笔记本：
- en: '[PRE6]'
  id: totrans-94
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: If you open the *chapter9/notebooks* folder in the Explorer on the left, you
    should see *shark_league_notebook.ipynb*. Click to open it. As shown in [Figure 9-2](#shark_notebook_chapter_9),
    you will see a blank cell. A Jupyter Notebook is made up of cells like these that
    you can fill with software code to run commands or Markdown-formatted text to
    provide context and explanation for the code.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您在左侧的资源管理器中打开`chapter9/notebooks`文件夹，您应该能看到`shark_league_notebook.ipynb`。点击打开它。如图[图9-2](#shark_notebook_chapter_9)所示，您将看到一个空白单元格。Jupyter
    Notebook由这样的单元格组成，您可以在其中填写软件代码以运行命令或Markdown格式的文本，以提供代码的上下文和解释。
- en: In the top-right of the file you will see Select Kernel, as shown in [Figure 9-2](#shark_notebook_chapter_9).
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 在文件右上角，您将看到“选择内核”，如图[图9-2](#shark_notebook_chapter_9)所示。
- en: '![New notebook file](assets/haad_0902.png)'
  id: totrans-97
  prefs: []
  type: TYPE_IMG
  zh: '![新笔记本文件](assets/haad_0902.png)'
- en: Figure 9-2\. New notebook file
  id: totrans-98
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图9-2\. 新笔记本文件
- en: Click Select Kernel. Codespaces should prompt you to “Install/Enable suggested
    extensions Python + Jupyter” as shown in [Figure 9-3](#install_extensions_ch9).
    Select “Install/Enable suggested extensions Python + Jupyter.” Click Install in
    the additional pop-up window, if prompted.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 点击“选择内核”。Codespaces应提示您“安装/启用建议的扩展 Python + Jupyter”，如图[图9-3](#install_extensions_ch9)所示。选择“安装/启用建议的扩展
    Python + Jupyter”。如果提示，在额外的弹出窗口中点击“安装”。
- en: '![Install/enable extensions](assets/haad_0903.png)'
  id: totrans-100
  prefs: []
  type: TYPE_IMG
  zh: '![安装/启用扩展](assets/haad_0903.png)'
- en: Figure 9-3\. Install/enable extensions
  id: totrans-101
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图9-3\. 安装/启用扩展
- en: After the installation completes, the title of the window will change to Select
    Another Kernel and you will see the choice Python Environments. Select Python
    Environments.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 安装完成后，窗口标题将变为“选择另一个内核”，您将看到“Python环境”选项。选择“Python环境”。
- en: The title of the window will change to “Select a Python Environment.” One Python
    version should be listed with a star next to it and the label Recommended—select
    this Python version.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 窗口标题将变为“选择Python环境”。应该列出一个带有星号并标记为“推荐”的Python版本——选择此Python版本。
- en: Adding General Configuration to Your Notebook
  id: totrans-104
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 将通用配置添加到您的笔记本中
- en: 'The beginning of your notebook will contain general configuration and setup.
    Hover your cursor above the empty Python cell and click +Markdown to create a
    new Markdown cell. Enter the following title in the Markdown cell:'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 您的笔记本开头将包含通用配置和设置。将鼠标悬停在空Python单元格上方并点击+Markdown创建一个新的Markdown单元格。在Markdown单元格中输入以下标题：
- en: '[PRE7]'
  id: totrans-106
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Run this cell by clicking the play icon on the left of the cell or by pressing
    Shift-Enter. You should see your message formatted as a title.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 通过点击单元格左侧的播放图标或按 Shift-Enter 运行此单元格。您应该看到您的消息格式化为标题。
- en: 'Hover your cursor below this cell and click “+Code” to create a new Python
    cell. Enter the following code in the Python cell:'
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 将光标悬停在下面的单元格下方，然后点击“+Code”创建一个新的 Python 单元格。在 Python 单元格中输入以下代码：
- en: '[PRE8]'
  id: totrans-109
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: '[![1](assets/1.png)](#co_using_apis_for_data_analytics_CO3-1)'
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: '[![1](assets/1.png)](#co_using_apis_for_data_analytics_CO3-1)'
- en: This references the Python file you created named *swc_simple_client.py*.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 这引用了您创建的名为 *swc_simple_client.py* 的 Python 文件。
- en: Placing all the imports at the top of your notebook helps keep track of the
    libraries you are using. These imports will work for all the cells in this Jupyter
    Notebook.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 将所有导入放在笔记本顶部有助于跟踪您正在使用的库。这些导入将对本 Jupyter Notebook 中的所有单元格生效。
- en: Tip
  id: totrans-113
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 小贴士
- en: Jupyter Notebooks are executed top to bottom. Although the output of Jupyter
    Notebooks is saved between sessions, the variables and imported libraries are
    not. When you start a coding session, select Execute Above Cells to rerun all
    the cells above the one you are using.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: Jupyter Notebooks 从上到下执行。尽管 Jupyter Notebooks 之间的输出会被保存，但变量和导入的库不会。当您开始编码会话时，选择执行上面的单元格以重新运行您正在使用的单元格以上的所有单元格。
- en: As mentioned in [Chapter 8](ch08.html#chapter_8), logging is an important component
    of working with APIs. You will configure a log file named *shark_notebook.log*
    to store the logging messages that are generated in your notebook. These log files
    are excluded by your repository’s *.gitignore* file, so they will not be committed
    to your repository, which is a good practice.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 如[第 8 章](ch08.html#chapter_8)所述，日志是与 API 一起工作的重要组件。您将配置一个名为 *shark_notebook.log*
    的日志文件来存储在笔记本中生成的日志消息。这些日志文件被您的仓库的 *.gitignore* 文件排除，因此它们不会被提交到您的仓库，这是一个好习惯。
- en: 'Add another Markdown cell with the following text:'
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 添加一个包含以下文本的另一个 Markdown 单元格：
- en: '[PRE9]'
  id: totrans-117
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'Add and run a Python code cell with the following:'
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 添加并运行以下 Python 代码单元格：
- en: '[PRE10]'
  id: totrans-119
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: '[![1](assets/1.png)](#co_using_apis_for_data_analytics_CO4-1)'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: '[![1](assets/1.png)](#co_using_apis_for_data_analytics_CO4-1)'
- en: This statement removes any existing logging handlers configured by Codespaces.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 此声明移除了由 Codespaces 配置的任何现有日志处理程序。
- en: '[![2](assets/2.png)](#co_using_apis_for_data_analytics_CO4-2)'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: '[![2](assets/2.png)](#co_using_apis_for_data_analytics_CO4-2)'
- en: This sets the logging level to record in the log. Review [Table 7-1](ch07.html#python_logging_levels_ch7)
    for more details about Python logging.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 这将设置日志记录级别以记录到日志中。请参阅[表 7-1](ch07.html#python_logging_levels_ch7)以获取有关 Python
    日志记录的更多详细信息。
- en: 'The next code cell will contain shared variables, which are good to add after
    the import statements. In this notebook, you set a reusable variable for the base
    URL of the API and created string constants with the API endpoints. These two
    steps make the purpose of API calls clearer and help avoid manual typing errors.
    These will be available to all the cells in the notebook. Add another Markdown
    cell with the following text:'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 下一个代码单元格将包含共享变量，这些变量在导入语句之后添加是很好的。在本笔记本中，您为 API 的基本 URL 设置了一个可重用的变量，并创建了带有 API
    端点的字符串常量。这两个步骤使 API 调用的目的更加清晰，并有助于避免手动输入错误。这些将在笔记本的所有单元格中可用。添加一个包含以下文本的另一个 Markdown
    单元格：
- en: '[PRE11]'
  id: totrans-125
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'Add and run a Python code cell with the following:'
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 添加并运行以下 Python 代码单元格：
- en: '[PRE12]'
  id: totrans-127
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: '[![1](assets/1.png)](#co_using_apis_for_data_analytics_CO5-1)'
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: '[![1](assets/1.png)](#co_using_apis_for_data_analytics_CO5-1)'
- en: Inside the quotations, you should put the base URL of the API running locally
    on Codespaces, without the backslash, for example, *https://fluffy-⁠lemur-12345-​8000.app.github.dev*.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 在引号内，您应该放入在 Codespaces 上本地运行的 API 的基本 URL，不要使用反斜杠，例如，*https://fluffy-lemur-12345-8000.app.github.dev*。
- en: Working with Your API Data
  id: totrans-130
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 与您的 API 数据一起工作
- en: The next several cells use the imported `call_api_endpoint()` function to call
    the API and get an `httpx.Response` object. Then, they extract the API data using
    `Response.json()` and store it in a pandas DataFrame.
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 下几个单元格使用导入的 `call_api_endpoint()` 函数调用 API 并获取一个 `httpx.Response` 对象。然后，它们使用
    `Response.json()` 提取 API 数据并将其存储在一个 pandas DataFrame 中。
- en: 'Add a Markdown cell with the following text:'
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 添加一个包含以下文本的 Markdown 单元格：
- en: '[PRE13]'
  id: totrans-133
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: This code retrieves the maximum scores for SportsWorldCentral leagues based
    on custom scoring types, which will be used for the League Juice Score. Highly
    custom values like these are examples of data that is best retrieved from the
    website’s API. Although you could potentially estimate the total possible points
    using public NFL scoring data, it would take a lot of effort and would likely
    be slightly different from the final totals the website calculates. Since the
    website makes this available, you can easily get an exact match to the league
    totals.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 这段代码根据自定义评分类型检索 SportsWorldCentral 联赛的最高得分，这些得分将用于联赛果汁评分。这类高度自定义的值是最好从网站 API
    中检索的数据示例。虽然你可以使用公开的 NFL 评分数据来估算总可能得分，但这需要大量努力，并且可能与网站计算出的最终总分略有不同。由于网站提供了这些数据，你可以轻松地获得与联赛总分的精确匹配。
- en: Note
  id: totrans-135
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 注意
- en: From this point, the contents of the code cell and the output will be displayed
    together. The code will be on top and the output will follow the `OUTPUT` statement.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 从这一点开始，代码单元格的内容和输出将一起显示。代码将位于上方，输出将跟随 `OUTPUT` 语句。
- en: 'Add and run a Python code cell with the following:'
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 添加并运行以下 Python 代码单元格：
- en: '[PRE14]'
  id: totrans-138
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: '[![1](assets/1.png)](#co_using_apis_for_data_analytics_CO6-1)'
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: '[![1](assets/1.png)](#co_using_apis_for_data_analytics_CO6-1)'
- en: This extracts the data in a dictionary format and creates a `DataFrame`.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 这以字典格式提取数据并创建一个 `DataFrame`。
- en: '[![2](assets/2.png)](#co_using_apis_for_data_analytics_CO6-2)'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: '[![2](assets/2.png)](#co_using_apis_for_data_analytics_CO6-2)'
- en: This uses the pandas `str.slice` method to get the year substring from the `week_number`.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 这使用 pandas 的 `str.slice` 方法从 `week_number` 中获取年份子串。
- en: '[![3](assets/3.png)](#co_using_apis_for_data_analytics_CO6-3)'
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: '[![3](assets/3.png)](#co_using_apis_for_data_analytics_CO6-3)'
- en: This uses the pandas `groupby().agg()` method to group the data by year and
    calculate the maximum points for two of the league types.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 这使用 pandas 的 `groupby().agg()` 方法按年份分组数据，并计算两种联赛类型的最大得分。
- en: 'Next, you’ll retrieve the league information. Add a Markdown cell with this
    text:'
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，你将检索联赛信息。添加一个包含以下文本的 Markdown 单元格：
- en: '[PRE15]'
  id: totrans-146
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'Add and run a Python code cell with the following:'
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 添加并运行以下 Python 代码单元格：
- en: '[PRE16]'
  id: totrans-148
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: '[![1](assets/1.png)](#co_using_apis_for_data_analytics_CO7-1)'
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: '[![1](assets/1.png)](#co_using_apis_for_data_analytics_CO7-1)'
- en: This statement uses the pandas `drop` method to exclude columns from the DataFrame.
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 此语句使用 pandas 的 `drop` 方法从 DataFrame 中排除列。
- en: 'Next, you will retrieve the total scoring for each league to compare to the
    max potential. Add a Markdown cell with the following text:'
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，你将检索每个联赛的总得分，以与最大潜在得分进行比较。添加一个包含以下文本的 Markdown 单元格：
- en: '[PRE17]'
  id: totrans-152
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: This section of code includes two techniques that are useful when using pandas
    to process API data. The SportsWorldCentral API returns JSON data with several
    nested dictionaries in the `weekly_scores` element, but you want to have one row
    per week. You also want to get multiple columns out of the nested column. You
    will use the pandas `json_normalize()` function to accomplish these tasks.
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 这段代码包括两种在处理 API 数据时非常有用的技术。SportsWorldCentral API 在 `weekly_scores` 元素中返回包含多个嵌套字典的
    JSON 数据，但你希望每周有一行。你还想从嵌套列中获取多个列。你将使用 pandas 的 `json_normalize()` 函数来完成这些任务。
- en: This section also introduces the pandas `groupby().sum()` method, which is similar
    to the SQL `GROUP BY` statement. You will use this to total up all of the weekly
    scoring values and give a total for the entire fantasy regular season. (The NFL
    plays 18 weeks, but SportsWorldCentral considers weeks 1 through 14 the fantasy
    regular season, and the rest are the playoffs.)
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 本节还介绍了 pandas 的 `groupby().sum()` 方法，这与 SQL 的 `GROUP BY` 语句类似。你将使用此方法汇总所有周评分值，并为整个幻想常规赛给出总分。（NFL
    比赛了 18 周，但 SportsWorldCentral 将第 1 至 14 周视为幻想常规赛，其余的是季后赛。）
- en: 'Add and run a Python code cell with the following:'
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 添加并运行以下 Python 代码单元格：
- en: '[PRE18]'
  id: totrans-156
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: '[![1](assets/1.png)](#co_using_apis_for_data_analytics_CO8-1)'
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: '[![1](assets/1.png)](#co_using_apis_for_data_analytics_CO8-1)'
- en: The pandas `json_normalize()` function breaks the nested JSON data into multiple
    rows and extracts new columns.
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: pandas 的 `json_normalize()` 函数将嵌套 JSON 数据拆分为多行并提取新列。
- en: '[![2](assets/2.png)](#co_using_apis_for_data_analytics_CO8-2)'
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: '[![2](assets/2.png)](#co_using_apis_for_data_analytics_CO8-2)'
- en: The pandas `str.slice()` method is used to extract the `year` and `week` values
    from the `week_number` field.
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: pandas 的 `str.slice()` 方法用于从 `week_number` 字段中提取 `year` 和 `week` 值。
- en: '[![3](assets/3.png)](#co_using_apis_for_data_analytics_CO8-3)'
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: '[![3](assets/3.png)](#co_using_apis_for_data_analytics_CO8-3)'
- en: This `groupby` statement sums the fantasy points by league, team, and year.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 此 `groupby` 语句按联赛、球队和年份汇总幻想得分。
- en: Calculating the League Balance Score
  id: totrans-163
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 计算联赛平衡分数
- en: 'With the data loading and formatting out of the way, you can calculate your
    first metric: the League Balance Score. The intuition behind this metric is that
    a high-quality league is a balanced league. Instead of being dominated by one
    or two top teams, the league has a balance of teams that are all competitive.'
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 在数据处理和格式化完成后，您可以计算第一个指标：联赛平衡分数。这个指标背后的直觉是，一个高质量的联赛是一个平衡的联赛。联赛不是被一两个顶级球队主导，而是拥有所有竞争性球队的平衡。
- en: A balanced league has less variability among the team’s regular season totals.
    One way to measure for variability is to calculate the *standard deviation* of
    the values. However, leagues with high scoring systems tend to have a higher variability,
    making it difficult to compare leagues with different scoring systems. To adjust
    for this, you’ll use the *coefficient of variation* (CV) of each league’s regular
    season total scores. This takes the *standard deviation* of the league’s totals
    and divides it by the *mean* of the totals.
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 一个平衡的联赛在球队常规赛总积分之间的变异性较小。衡量变异性的一个方法是通过计算值的**标准差**。然而，得分系统高的联赛往往具有更高的变异性，这使得比较不同评分系统的联赛变得困难。为了调整这一点，您将使用每个联赛常规赛总积分的**变异系数**（CV）。这会将联赛总积分的**标准差**除以总积分的**平均值**。
- en: 'This gives you a measure of relative variability between the values that adjusts
    for the overall scoring system. The reason CV works for this situation is that
    it is *dimensionless*, which means it can be compared across values of difference
    sizes—​scoring systems in this case. Here is the exact formula you will use:'
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 这为您提供了一个衡量值之间相对变异性的度量，同时调整了整体评分系统。CV之所以适用于这种情况，是因为它是**无量纲的**，这意味着它可以跨越不同大小的值进行比较——在这个例子中是评分系统。以下是您将使用的确切公式：
- en: $upper L e a g u e upper B a l a n c e upper S c o r e equals 100 minus s t
    d e v left-parenthesis upper L e a g u e upper R e g u l a r upper S e a s o n
    upper T o t a l right-parenthesis slash m e a n left-parenthesis upper L e a g
    u e upper R e g u l a r upper S e a s o n upper T o t a l right-parenthesis asterisk
    100$
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: $upper L e a g u e upper B a l a n c e upper S c o r e equals 100 minus s t
    d e v left-parenthesis upper L e a g u e upper R e g u l a r upper S e a s o n
    upper T o t a l right-parenthesis slash m e a n left-parenthesis upper L e a g
    u e upper R e g u l a r upper S e a s o n upper T o t a l right-parenthesis asterisk
    100$
- en: A CV is lower if it varies less, but you want a metric where a higher number
    is better. You also want it to be comparable to the League Juice Score, which
    has a max value of 100\. To accomplish this, you multiply it by 100 and subtract
    it from 100 to give a number similar in scale to the League Juice Score, and so
    that a larger number is better, also matching the League Juice Score.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: CV值越低，表示其变化越小，但您需要一个更高的数值表示更好的指标。您还希望它能与联赛果汁分数进行比较，该分数的最大值为100。为了实现这一点，您将其乘以100并从100中减去，以得到一个与联赛果汁分数相似规模的数字，并且更大的数字表示更好，同时也与联赛果汁分数相匹配。
- en: 'Add another Markdown cell, with the following text:'
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 添加另一个Markdown单元格，内容如下：
- en: '[PRE19]'
  id: totrans-170
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: This section also uses a `lambda` command to execute Python code during the
    aggregation. You will use this in several other locations.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 本节还使用`lambda`命令在聚合期间执行Python代码。您将在其他几个位置使用它。
- en: 'Add and run a Python code cell with the following:'
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 添加并运行以下Python代码单元格：
- en: '[PRE20]'
  id: totrans-173
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: '[![1](assets/1.png)](#co_using_apis_for_data_analytics_CO9-1)'
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: '![1](assets/1.png)[#co_using_apis_for_data_analytics_CO9-1]'
- en: This sum value will be used in the next metric, but this is a convenient place
    to calculate it.
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 这个总和值将在下一个指标中使用，但这是一个方便计算它的地方。
- en: '[![2](assets/2.png)](#co_using_apis_for_data_analytics_CO9-2)'
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: '![2](assets/2.png)[#co_using_apis_for_data_analytics_CO9-2]'
- en: This uses the pandas built-in `GroupBy.std` calculation for the standard deviation
    of the league totals.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 这使用pandas内置的`GroupBy.std`计算联赛总积分的标准差。
- en: '[![3](assets/3.png)](#co_using_apis_for_data_analytics_CO9-3)'
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: '![3](assets/3.png)[#co_using_apis_for_data_analytics_CO9-3]'
- en: This uses `lambda` to execute a calculation on the aggregated values to calculate
    the league score and scale it to match the League Juice Score.
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 这使用`lambda`对聚合值执行计算以计算联赛分数并将其缩放到与联赛果汁分数相匹配。
- en: '[![4](assets/4.png)](#co_using_apis_for_data_analytics_CO9-4)'
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: '![4](assets/4.png)[#co_using_apis_for_data_analytics_CO9-4]'
- en: The pandas `sort_values` method does not change the underlying structure; it
    only sorts during the display.
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: pandas的`sort_values`方法不会改变底层结构；它只是在显示时进行排序。
- en: The output of this cell is shown in [Figure 9-4](#league_balance_ch9).
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 此单元格的输出显示在[图9-4](#league_balance_ch9)中。
- en: '![League Balance Score](assets/haad_0904.png)'
  id: totrans-183
  prefs: []
  type: TYPE_IMG
  zh: '![League Balance Score](assets/haad_0904.png)'
- en: Figure 9-4\. League Balance Score
  id: totrans-184
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图9-4. 联赛平衡得分
- en: Calculating the League Juice Score
  id: totrans-185
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 计算联赛果汁得分
- en: The second metric you will calculate is the League Juice Score, which is the
    percentage of potential points that the league scored for the season. This represents
    how much juice the league owners squeezed out of the orange, that is, how many
    potential points were in the starting lineups. In fantasy football, it doesn’t
    do much good for the week’s top scorers to be sitting on someone’s bench. In a
    high-quality league, managers are setting starting lineups that get the most from
    their teams.
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 你将计算的第二个指标是联赛果汁得分，这是联赛在该赛季得分的潜在得分的百分比。这代表了联赛所有者从橙子中榨取了多少果汁，即起始阵容中有多少潜在得分。在梦幻足球中，如果本周的得分最高的球员坐在某人的板凳上，那么这对他们来说并没有太大的好处。在一个高质量的联赛中，经理们会设置能够从他们的球队中获得最大利益的起始阵容。
- en: 'One wrinkle to the calculation is that max points differ by the size of the
    league and the scoring type. Before you can calculate the score, you need to merge
    three DataFrames that you already prepared into a single DataFrame:'
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 计算中的一个复杂之处在于，最高得分点数因联赛规模和得分类型而异。在你能够计算得分之前，你需要将你已经准备好的三个DataFrame合并成一个DataFrame：
- en: '`league_stats_df`'
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: '`league_stats_df`'
- en: Contains the total points scored by each team and year
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 包含每个队伍和每年的总得分
- en: '`max_totals_grouped_df`'
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: '`max_totals_grouped_df`'
- en: Contains the custom max point totals for the regular season
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 包含常规赛的定制最高得分总和
- en: '`leagues_df`'
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: '`leagues_df`'
- en: Contains the scoring type and league size of each league, to match against custom
    max points
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 包含每个联赛的得分类型和联赛规模，以匹配自定义最高得分
- en: 'The exact formula you will use is the following:'
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: 你将使用的确切公式如下：
- en: $upper L e a g u e upper J u i c e upper S c o r e equals 100 asterisk left-parenthesis
    upper L e a g u e upper T o t a l upper P o i n t s right-parenthesis slash upper
    M a x upper P o t e n t i a l upper P o i n t s right-parenthesis$
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: $upper L e a g u e upper J u i c e upper S c o r e equals 100 asterisk left-parenthesis
    upper L e a g u e upper T o t a l upper P o i n t s right-parenthesis slash upper
    M a x upper P o t e n t i a l upper P o i n t s right-parenthesis$
- en: 'Add another Markdown cell with the following text:'
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 添加另一个Markdown单元格，内容如下：
- en: '[PRE21]'
  id: totrans-197
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'Add and run a Python code cell with the following:'
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 添加并运行以下Python代码单元格：
- en: '[PRE22]'
  id: totrans-199
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: '[![1](assets/1.png)](#co_using_apis_for_data_analytics_CO10-1)'
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: '[![1](assets/1.png)](#co_using_apis_for_data_analytics_CO10-1)'
- en: The first step is to combine `league_stats_df` with `max_totals_grouped_df`.
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 第一步是将`league_stats_df`与`max_totals_grouped_df`合并。
- en: '[![2](assets/2.png)](#co_using_apis_for_data_analytics_CO10-2)'
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: '[![2](assets/2.png)](#co_using_apis_for_data_analytics_CO10-2)'
- en: Next, you combine `leagues_df` with the output of the previous step.
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，你将`leagues_df`与上一步的输出合并。
- en: '[![3](assets/3.png)](#co_using_apis_for_data_analytics_CO10-3)'
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: '[![3](assets/3.png)](#co_using_apis_for_data_analytics_CO10-3)'
- en: This section uses the `apply()` method to execute a `lambda` function against
    each row to calculate the custom `league_juice+score` value.
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: 本节使用`apply()`方法对每一行执行一个`lambda`函数来计算自定义的`league_juice+score`值。
- en: '[![4](assets/4.png)](#co_using_apis_for_data_analytics_CO10-4)'
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: '[![4](assets/4.png)](#co_using_apis_for_data_analytics_CO10-4)'
- en: You multiply the ratio by 100 to make it a percentage, and scale it to match
    the League Balance Score.
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
  zh: 你将这个比率乘以100使其成为百分比，并将其缩放以匹配联赛平衡得分。
- en: The output of this cell is shown in [Figure 9-5](#two_metrics_chapter_9).
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 本单元格的输出显示在[图9-5](#two_metrics_chapter_9)中。
- en: '![League Juice Score](assets/haad_0905.png)'
  id: totrans-209
  prefs: []
  type: TYPE_IMG
  zh: '![League Juice Score](assets/haad_0905.png)'
- en: Figure 9-5\. League Juice Score
  id: totrans-210
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图9-5. 联赛果汁得分
- en: Creating the Shark League Score
  id: totrans-211
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 创建Shark League Score
- en: 'After your API data has been manipulated, munged, and merged, you are ready
    for the payoff: building your Shark League Score. Based on your decision to weight
    the League Juice Score double, the final formula you will use is:'
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: 在你的API数据已经被操作、整理和合并之后，你就可以准备收获：构建你的Shark League Score。基于你决定将联赛果汁得分加倍的决定，你将使用的最终公式如下：
- en: $upper S h a r k upper L e a g u e upper S c o r e equals 2 asterisk left-parenthesis
    upper L e a g u e upper J u i c e upper S c o r e right-parenthesis plus upper
    L e a g u e upper B a l a n c e upper S c o r e$
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: $upper S h a r k upper L e a g u e upper S c o r e equals 2 asterisk left-parenthesis
    upper L e a g u e upper J u i c e upper S c o r e right-parenthesis plus upper
    L e a g u e upper B a l a n c e upper S c o r e$
- en: 'Add another Markdown cell, with the following text:'
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: 添加另一个Markdown单元格，内容如下：
- en: '[PRE23]'
  id: totrans-215
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: 'Add and run a Python code cell with the following:'
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: 添加并运行以下Python代码单元格：
- en: '[PRE24]'
  id: totrans-217
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: The output of this cell is shown in [Figure 9-6](#shark_league_ch9).
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: 本单元格的输出显示在[图9-6](#shark_league_ch9)中。
- en: '![Shark League Score](assets/haad_0906.png)'
  id: totrans-219
  prefs: []
  type: TYPE_IMG
  zh: '![Shark League Score](assets/haad_0906.png)'
- en: Figure 9-6\. Shark League Score
  id: totrans-220
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图9-6. Shark League Score
- en: Congratulations, you have calculated the Shark League Score based on customized
    data from the SportsWorldCentral API.
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: 恭喜你，你已经根据SportsWorldCentral API的定制数据计算了鲨鱼联盟得分。
- en: Additional Resources
  id: totrans-222
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 其他资源
- en: 'For a discussion of the value of statistics in basketball, read [“NBA Insider:
    Is It Numbers or Talent? Sorting Fact, Fiction in NBA Stats Wave”](https://oreil.ly/DqSG-).'
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 关于篮球中统计学价值的讨论，请阅读[“NBA内部人士：是数字还是天赋？在NBA统计数据浪潮中区分事实与虚构”](https://oreil.ly/DqSG-)。
- en: 'To continue building your knowledge of pandas, I recommend *Python for Data
    Analysis: Data Wrangling with pandas, NumPy, and Jupyter* (O’Reilly, 2022). It
    was written by Wes McKinney, the creator of pandas.'
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: 为了继续构建你对pandas的了解，我推荐*《Python数据分析：使用pandas、NumPy和Jupyter进行数据处理》*（O’Reilly，2022）。这本书由pandas的创造者Wes
    McKinney所著。
- en: 'To learn more detailed charts that can be created with football data from nfl_data_py,
    I recommend the book *Football Analytics with Python & R: Learning Data Science
    Through the Lens of Sports* Eager and Erickson (O’Reilly, 2023).'
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: 要了解使用nfl_data_py从足球数据中可以创建的更详细的图表，我推荐书籍*《使用Python和R进行足球数据分析：通过体育视角学习数据科学》* Eager和Erickson（O’Reilly，2023）。
- en: For more tips on formatting Markdown for your notebook, read the [Markdown Guide](https://oreil.ly/_7OgB).
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: 关于如何格式化Markdown以供你的笔记本使用，请阅读[Markdown指南](https://oreil.ly/_7OgB)。
- en: 'To learn more about the coefficient of variation in other domains, read [“Coefficient
    of Variation: Meaning and How to Use It”](https://oreil.ly/yO4zn).'
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: 要了解其他领域中变异系数的更多信息，请阅读[“变异系数：含义及其使用方法”](https://oreil.ly/yO4zn)。
- en: If you’d like to explore more uses of data analytics in fantasy football using
    Python, Nathan Braun has courses and books available at [*https://fantasycoding.com*](https://fantasycoding.com).
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想要探索更多使用Python在梦幻足球中数据分析的应用，Nathan Braun在[*https://fantasycoding.com*](https://fantasycoding.com)提供了课程和书籍。
- en: Summary
  id: totrans-229
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: In this chapter, you learned about creating custom metrics using API data. You
    calculated the Shark League Score and learned how to use pandas and Jupyter Notebooks
    along the way.
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，你学习了如何使用API数据创建自定义指标。你计算了鲨鱼联盟得分，并在这个过程中学习了如何使用pandas和Jupyter Notebooks。
- en: In [Chapter 10](ch10.html#chapter_10), you will build your API and data science
    skills by calling APIs in a data pipeline built with Apache Airflow.
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: 在[第10章](ch10.html#chapter_10)中，你将通过在用Apache Airflow构建的数据管道中调用API来构建你的API和数据科学技能。

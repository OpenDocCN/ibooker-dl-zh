["```py\n.../portfolio-project (main) $ cd chapter3\n.../chapter3 (main) $ sqlite3 fantasy_data.db\nSQLite version 3.45.3 2024-04-15 13:34:05\nEnter \".help\" for usage hints.\nsqlite>\n```", "```py\nCREATE TABLE player (\n        player_id INTEGER NOT NULL, \n        gsis_id VARCHAR, \n        first_name VARCHAR NOT NULL, \n        last_name VARCHAR NOT NULL, \n        position VARCHAR NOT NULL,\n        last_changed_date DATE NOT NULL, \n        PRIMARY KEY (player_id)\n);\n\nCREATE TABLE performance (\n        performance_id INTEGER NOT NULL, \n        week_number VARCHAR NOT NULL, \n        fantasy_points FLOAT NOT NULL, \n        player_id INTEGER NOT NULL, \n        last_changed_date DATE NOT NULL,\n        PRIMARY KEY (performance_id), \n        FOREIGN KEY(player_id) REFERENCES player (player_id)\n);\n\nCREATE TABLE league (\n        league_id INTEGER NOT NULL, \n        league_name VARCHAR NOT NULL, \n        scoring_type VARCHAR NOT NULL,\n        last_changed_date DATE NOT NULL,  \n        PRIMARY KEY (league_id)\n);\n\nCREATE TABLE team (\n        team_id INTEGER NOT NULL, \n        team_name VARCHAR NOT NULL, \n        league_id INTEGER NOT NULL, \n        last_changed_date DATE NOT NULL, \n        PRIMARY KEY (team_id), \n        FOREIGN KEY(league_id) REFERENCES league (league_id)\n);\n\nCREATE TABLE team_player (\n        team_id INTEGER NOT NULL, \n        player_id INTEGER NOT NULL, \n        last_changed_date DATE NOT NULL, \n        PRIMARY KEY (team_id, player_id), \n        FOREIGN KEY(team_id) REFERENCES team (team_id), \n        FOREIGN KEY(player_id) REFERENCES player (player_id)\n);\n```", "```py\nCREATE TABLE player ( ![1](assets/1.png)\n        player_id INTEGER NOT NULL, ![2](assets/2.png)\n        gsis_id VARCHAR,\n        first_name VARCHAR NOT NULL,\n        last_name VARCHAR NOT NULL,\n        position VARCHAR NOT NULL,\n        last_changed_date DATE NOT NULL,\n        PRIMARY KEY (player_id) ![3](assets/3.png)\n);\n```", "```py\nsqlite> .tables\nleague       performance  player       team         team_player\nsqlite>\n```", "```py\nCREATE TABLE team (\n        team_id INTEGER NOT NULL,\n        team_name VARCHAR NOT NULL,\n        league_id INTEGER NOT NULL,\n        last_changed_date DATE NOT NULL,\n        PRIMARY KEY (team_id),\n        FOREIGN KEY(league_id) REFERENCES league (league_id)\n);\n```", "```py\nCREATE TABLE team_player (\n        team_id INTEGER NOT NULL,\n        player_id INTEGER NOT NULL,\n        last_changed_date DATE NOT NULL,\n        PRIMARY KEY (team_id, player_id),\n        FOREIGN KEY(team_id) REFERENCES team (team_id),\n        FOREIGN KEY(player_id) REFERENCES player (player_id)\n);\n```", "```py\nsqlite> PRAGMA foreign_keys = ON;\n```", "```py\nsqlite> .mode csv\n```", "```py\nsqlite> PRAGMA foreign_keys = ON;\nsqlite> .mode csv\nsqlite> .import --skip 1 data/player_data.csv player\nsqlite> .import --skip 1 data/performance_data.csv performance\nsqlite> .import --skip 1 data/league_data.csv league\nsqlite> .import --skip 1 data/team_data.csv team\nsqlite> .import --skip 1 data/team_player_data.csv team_player\nsqlite>\n```", "```py\nsqlite> select count(*) from player;\n1018\nsqlite> select count(*) from performance;\n17306\nsqlite> select count(*) from performance where last_changed_date > '2024-04-01';\n2711\nsqlite> select count(*) from league;\n5\nsqlite> select count(*) from team;\n20\nsqlite> select count(*) from team_player;\n140\n```", "```py\nsqlite> .exit\n$\n```", "```py\nSQLAlchemy>=2.0.0\n```", "```py\npip3 install -r requirements.txt\n```", "```py\nName: SQLAlchemy\nVersion: 2.0.29\nSummary: Database Abstraction Library\nHome-page: https://www.sqlalchemy.org\nAuthor: Mike Bayer\nAuthor-email: mike_mp@zzzcomputing.com\nLicense: MIT\n```", "```py\n\"\"\"SQLAlchemy models\"\"\"\nfrom sqlalchemy import Column, ForeignKey, Integer, String, Float, Date\nfrom sqlalchemy.orm import relationship\n\nfrom database import Base\n\nclass Player(Base):\n    __tablename__ = \"player\"\n\n    player_id = Column(Integer, primary_key=True, index=True)\n    gsis_id = Column(String, nullable=True)\n    first_name = Column(String, nullable=False)\n    last_name = Column(String, nullable=False)\n    position = Column(String, nullable=False)\n    last_changed_date = Column(Date, nullable=False)\n\n    performances = relationship(\"Performance\", back_populates=\"player\")\n\n    # Many-to-many relationship between Player and Team tables\n   teams = relationship(\"Team\", secondary=\"team_player\",\n                        back_populates=\"players\")   \n\nclass Performance(Base):\n    __tablename__ = \"performance\"\n\n    performance_id = Column(Integer, primary_key=True, index=True)\n    week_number = Column(String, nullable=False)\n    fantasy_points = Column(Float, nullable=False)\n    last_changed_date = Column(Date, nullable=False)\n\n    player_id = Column(Integer, ForeignKey(\"player.player_id\"))\n\n    player = relationship(\"Player\", back_populates=\"performances\")\n\nclass League(Base):\n    __tablename__ = \"league\"\n\n    league_id = Column(Integer, primary_key=True, index=True)\n    league_name = Column(String, nullable=False)\n    scoring_type = Column(String, nullable=False)\n    last_changed_date = Column(Date, nullable=False)\n\n    teams = relationship(\"Team\", back_populates=\"league\")\n\nclass Team(Base):\n    __tablename__ = \"team\"\n\n    team_id = Column(Integer, primary_key=True, index=True)\n    team_name = Column(String, nullable=False)\n    last_changed_date = Column(Date, nullable=False)    \n\n    league_id = Column(Integer, ForeignKey(\"league.league_id\"))\n\n    league = relationship(\"League\", back_populates=\"teams\")\n\n   players = relationship(\"Player\", secondary=\"team_player\",\n                          back_populates=\"teams\")\n\nclass TeamPlayer(Base):\n    __tablename__ = \"team_player\"\n\n   team_id = Column(Integer, ForeignKey(\"team.team_id\"),\n                    primary_key=True, index=True)\n   player_id = Column(Integer, ForeignKey(\"player.player_id\"),\n                      primary_key=True, index=True)    \nlast_changed_date = Column(Date, nullable=False)\n```", "```py\nfrom sqlalchemy import Column, ForeignKey, Integer, String, Float, Date ![1](assets/1.png)\nfrom sqlalchemy.orm import relationship ![2](assets/2.png)\n\nfrom database import Base ![3](assets/3.png)\n```", "```py\nclass Player(Base):\n    __tablename__ = \"player\"\n```", "```py\n    player_id = Column(Integer, primary_key=True, index=True)\n    gsis_id = Column(String, nullable=True)\n    first_name = Column(String, nullable=False)\n    last_name = Column(String, nullable=False)\n    position = Column(String, nullable=False)\n    last_changed_date = Column(Date, nullable=False)\n```", "```py\n    performances = relationship(\"Performance\", back_populates=\"player\")\n```", "```py\n   players = relationship(\"Player\", secondary=\"team_player\",\n                          back_populates=\"teams\")\n```", "```py\nclass Performance(Base):\n    __tablename__ = \"performance\"\n\n    performance_id = Column(Integer, primary_key=True, index=True)\n    week_number = Column(String, nullable=False)\n    fantasy_points = Column(Float, nullable=False)\n    last_changed_date = Column(Date, nullable=False)\n\n    player_id = Column(Integer, ForeignKey(\"player.player_id\"))\n\n    player = relationship(\"Player\", back_populates=\"performances\")\n```", "```py\nclass League(Base):\n    __tablename__ = \"league\"\n\n    league_id = Column(Integer, primary_key=True, index=True)\n    league_name = Column(String, nullable=False)\n    scoring_type = Column(String, nullable=False)\n    last_changed_date = Column(Date, nullable=False)\n\n    teams = relationship(\"Team\", back_populates=\"league\")\n```", "```py\nclass Team(Base):\n    __tablename__ = \"team\"\n\n    team_id = Column(Integer, primary_key=True, index=True)\n    team_name = Column(String, nullable=False)\n\n    league_id = Column(Integer, ForeignKey(\"league.league_id\"))\n\n    league = relationship(\"League\", back_populates=\"teams\")\n\n   players = relationship(\"Player\", secondary=\"team_player\",\n                          back_populates=\"teams\")\n```", "```py\nclass TeamPlayer(Base):\n    __tablename__ = \"team_player\"\n\n team_id = Column(Integer, ForeignKey(\"team.team_id\"),\n                    primary_key=True, index=True)\n player_id = Column(Integer, ForeignKey(\"player.player_id\"),\n                      primary_key=True, index=True\n```", "```py\n\"\"\"Database configuration\"\"\"\nfrom sqlalchemy import create_engine\nfrom sqlalchemy.orm import declarative_base\nfrom sqlalchemy.orm import sessionmaker\n\nSQLALCHEMY_DATABASE_URL = \"sqlite:///./fantasy_data.db\"\n\nengine = create_engine(\n    SQLALCHEMY_DATABASE_URL, connect_args={\"check_same_thread\": False}\n)\nSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)\n\nBase = declarative_base()\n```", "```py\nfrom sqlalchemy import create_engine\nfrom sqlalchemy.orm import declarative_base\nfrom sqlalchemy.orm import sessionmaker\n```", "```py\nSQLALCHEMY_DATABASE_URL = \"sqlite:///./fantasy_data.db\"\n```", "```py\nengine = create_engine(\n    SQLALCHEMY_DATABASE_URL, connect_args={\"check_same_thread\": False}\n)\n```", "```py\nSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)\n```", "```py\nBase = declarative_base()\n```", "```py\n\"\"\"SQLAlchemy Query Functions\"\"\"\nfrom sqlalchemy.orm import Session\nfrom sqlalchemy.orm import joinedload\nfrom datetime import date\n\nimport models\n\ndef get_player(db: Session, player_id: int):\n   return db.query(models.Player).filter(\n       models.Player.player_id == player_id).first()\n\ndef get_players(db: Session, skip: int = 0, limit: int = 100,\n               min_last_changed_date: date = None,\n               last_name : str = None, first_name : str = None, ):\n   query = db.query(models.Player)\n   if min_last_changed_date:\n       query = query.filter(\n           models.Player.last_changed_date >= min_last_changed_date)\n   if first_name:\n       query = query.filter(models.Player.first_name == first_name)\n   if last_name:\n       query = query.filter(models.Player.last_name == last_name)\n   return query.offset(skip).limit(limit).all()\n\ndef get_performances(db: Session, skip: int = 0, limit: int = 100,\n                    min_last_changed_date: date = None):\n   query = db.query(models.Performance)\n   if min_last_changed_date:\n       query = query.filter(\n           models.Performance.last_changed_date >= min_last_changed_date)\n   return query.offset(skip).limit(limit).all()\n\ndef get_league(db: Session, league_id: int = None):\n   return db.query(models.League).filter(\n       models.League.league_id == league_id).first()\n\ndef get_leagues(db: Session, skip: int = 0, limit: int = 100,\n                min_last_changed_date: date = None,league_name: str = None):\n   query = db.query(models.League\n                   ).options(joinedload(models.League.teams))\n   if min_last_changed_date:\n       query = query.filter(\n           models.League.last_changed_date >= min_last_changed_date)                             \n   if league_name:\n       query = query.filter(models.League.league_name == league_name)    \n   return query.offset(skip).limit(limit).all()\n\ndef get_teams(db: Session, skip: int = 0, limit: int = 100,\n             min_last_changed_date: date = None,\n             team_name: str = None, league_id: int = None):\n   query = db.query(models.Team)\n   if min_last_changed_date:\n       query = query.filter(\n           models.Team.last_changed_date >= min_last_changed_date)\n   if team_name:\n       query = query.filter(models.Team.team_name == team_name)\n   if league_id:\n       query = query.filter(models.Team.league_id == league_id)\n   return query.offset(skip).limit(limit).all()   \n\n#analytics queries\ndef get_player_count(db: Session):\n   query = db.query(models.Player)\n   return query.count()\n\ndef get_team_count(db: Session):\n   query = db.query(models.Team)\n   return query.count()\n\ndef get_league_count(db: Session):\n   query = db.query(models.League)\n   return query.count()\n```", "```py\nfrom sqlalchemy.orm import Session ![1](assets/1.png)\nfrom sqlalchemy.orm import joinedload\nfrom datetime import date ![2](assets/2.png)\n\nimport models ![3](assets/3.png)\n```", "```py\ndef get_player(db: Session, player_id: int):\n   return db.query(models.Player).filter(\n       models.Player.player_id == player_id).first()\n```", "```py\ndef get_players(db: Session, skip: int = 0, limit: int = 100,\n               min_last_changed_date: date = None,\n               last_name : str = None, first_name : str = None, ):\n```", "```py\nquery = db.query(models.Player)\n   if min_last_changed_date:\n       query = query.filter(\n           models.Player.last_changed_date >= min_last_changed_date)\n   if first_name:\n       query = query.filter(models.Player.first_name == first_name)\n   if last_name:\n       query = query.filter(models.Player.last_name == last_name)\n```", "```py\n    return query.offset(skip).limit(limit).all()\n```", "```py\ndef get_leagues(db: Session, skip: int = 0, limit: int = 100,\n                min_last_changed_date: date = None,league_name: str = None):\n   query = db.query(models.League\n                   ).options(joinedload(models.League.teams))\n   if min_last_changed_date:\n       query = query.filter(\n           models.League.last_changed_date >= min_last_changed_date)\n   if league_name:\n       query = query.filter(models.League.league_name == league_name)\n   return query.offset(skip).limit(limit).all()\n```", "```py\n#analytics queries\ndef get_player_count(db: Session):\n    query = db.query(models.Player)\n    return query.count()\n\ndef get_team_count(db: Session):\n    query = db.query(models.Team)\n    return query.count()\n\ndef get_league_count(db: Session):\n    query = db.query(models.League)\n    return query.count()\n```", "```py\nSQLAlchemy>=2.0.0\nPytest>=8.1.0\n```", "```py\npip3 install -r requirements.txt\n```", "```py\n$ pip3 show Pytest\nName: pytest\nVersion: 8.1.1\nSummary: pytest: simple powerful testing with Python\nHome-page:\nAuthor: Holger Krekel, Bruno Oliveira, Ronny Pfannschmidt, Floris Bruynooghe,\nBrianna Laugher, Florian Bruhin, Others (See AUTHORS)\nAuthor-email:\nLicense: MIT\n```", "```py\n\"\"\"Testing SQLAlchemy Helper Functions\"\"\"\nimport pytest\nfrom datetime import date\n\nimport crud\nfrom database import SessionLocal\n\n# use a test date of 4/1/2024 to test the min_last_changed_date.\ntest_date = date(2024,4,1)\n\n@pytest.fixture(scope=\"function\")\ndef db_session():\n    \"\"\"This starts a database session and closes it when done\"\"\"\n    session = SessionLocal()\n    yield session\n    session.close()\n\ndef test_get_player(db_session):\n    \"\"\"Tests you can get the first player\"\"\"\n    player = crud.get_player(db_session, player_id = 1001)\n    assert player.player_id == 1001\n\ndef test_get_players(db_session):\n    \"\"\"Tests that the count of players in the database is what is expected\"\"\"\n   players = crud.get_players(db_session, skip=0, limit=10000,\n                               min_last_changed_date=test_date)\n    assert len(players) == 1018\n\ndef test_get_players_by_name(db_session):\n    \"\"\"Tests that the count of players in the database is what is expected\"\"\"\n    players = crud.get_players(db_session, first_name=\"Bryce\", last_name=\"Young\")\n    assert len(players) == 1\n    assert players[0].player_id == 2009\n\ndef test_get_all_performances(db_session):\n \"\"\"Tests that the count of performances in the database is\n   what is expected - all the performances\"\"\"\n    performances = crud.get_performances(db_session, skip=0, limit=18000)\n    assert len(performances) == 17306\n\ndef test_get_new_performances(db_session):\n\"\"\"Tests that the count of performances in the database is\n   what is expected\"\"\"\n   performances = crud.get_performances(db_session, skip=0, limit=18000,\n                                        min_last_changed_date=test_date)\n\n#test the count functions\ndef test_get_player_count(db_session):\n    player_count = crud.get_player_count(db_session)\n    assert player_count == 1018\n```", "```py\n@pytest.fixture(scope=\"function\")\n```", "```py\ndef db_session():\n    \"\"\"This starts a database session and closes it when done\"\"\"\n    session = SessionLocal()\n    yield session\n    session.close()\n```", "```py\nsqlite> select count(*) from performance;\n17306\nsqlite> select count(*) from performance where last_changed_date > '2024-04-01';\n2711\n```", "```py\ndef test_get_all_performances(db_session):\n   \"\"\"Tests that the count of performances in the database is\n   what is expected - all the performances\"\"\"\n    performances = crud.get_performances(db_session, skip=0, limit=18000)\n    assert len(performances) == 17306\n```", "```py\n \"\"\"Tests that the count of performances in the database is\n   what is expected\"\"\"\n   performances = crud.get_performances(db_session, skip=0, limit=10000,\n                                        min_last_changed_date=test_date)\n    assert len(performances) == 2711\n```", "```py\ndef test_get_player_count(db_session):\n    player_count = crud.get_player_count(db_session)\n    assert player_count == 1018\n```", "```py\n$ pytest test_crud.py\n================== test session starts ===========================\nplatform linux -- Python 3.10.13, pytest-8.1.2, pluggy-1.5.0\nrootdir: /workspaces/adding-more-data/chapter3\nplugins: anyio-4.4.0\ncollected 5 items\n\ntest_crud.py                                              [100%]\n\n=================== 5 passed in 0.22s ============================\n```"]
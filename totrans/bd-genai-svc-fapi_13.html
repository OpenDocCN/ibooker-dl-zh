<html><head></head><body><div id="book-content"><div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 9. Securing AI Services" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch09">
<h1><span class="label">Capitolo 9. </span>Proteggere i servizi di intelligenza artificiale</h1><div data-type="note"><p>Questo lavoro è stato tradotto utilizzando l'AI. Siamo lieti di ricevere il tuo feedback e i tuoi commenti: <a href="mailto:translation-feedback@oreilly.com">translation-feedback@oreilly.com</a></p></div>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1031">
<h1>Obiettivi del capitolo</h1>
<p><a data-primary="securing AI services" data-type="indexterm" id="ix_ch09-asciidoc0"/>In questo capitolo imparerai a conoscere:</p>
<ul>
<li>
<p>Come proteggersi dai tentativi avversari e dall'uso improprio dei servizi GenAI</p>
</li>
<li>
<p>Come implementare le tue barriere etiche e di sicurezza, la valutazione e i livelli di filtraggio dei contenuti per moderare l'uso.</p>
</li>
<li>
<p>Come implementare la moderazione dell'uso, lo stream throttling e varie strategie di limitazione della velocità delle API per ridurre il carico del server.</p>
</li>
</ul>
</div></aside>
<p>Nei capitoli precedenti, hai imparato a costruire servizi GenAI che servano vari generatori di IA supportando la concorrenza e lo streaming dei dati in tempo reale. Inoltre, hai integrato sistemi esterni come i database e hai implementato i tuoi meccanismi di autenticazione e autorizzazione. Infine, hai scritto una suite di test per verificare la funzionalità e le prestazioni dell'intero sistema.</p>
<p>In questo capitolo imparerai a implementare meccanismi di moderazione dell'uso e di protezione dagli abusi per proteggere i tuoi servizi GenAI.</p>
<section data-pdf-bookmark="Usage Moderation and Abuse Protection" data-type="sect1"><div class="sect1" id="id135">
<h1>Moderazione dell'uso e protezione dagli abusi</h1>
<p><a data-primary="securing AI services" data-secondary="usage moderation and abuse protection" data-type="indexterm" id="ix_ch09-asciidoc1"/>Quando distribuisci i tuoi servizi GenAI, devi considerare come i tuoi servizi saranno utilizzati in modo improprio da utenti malintenzionati. Questo è essenziale per proteggere la sicurezza degli utenti e la tua reputazione. Non puoi sapere come gli utenti utilizzeranno il tuo sistema, quindi devi pensare al peggio e implementare <em>delle protezioni</em> per proteggerti da qualsiasi abuso o uso improprio.</p>
<p>Secondo un <a href="https://oreil.ly/ihmzR">recente studio sulle applicazioni nefaste della GenAI</a>, i tuoi servizi possono essere potenzialmente utilizzati con <em>intenti malevoli</em>, come descritto nella <a data-type="xref" href="#malicious_intents">Tabella 9-1</a>.</p>
<table class="striped" id="malicious_intents">
<caption><span class="label">Tabella 9-1. </span>Intenti malevoli alla base dell'abuso dei servizi GenAI</caption>
<thead>
<tr>
<th>Intento</th>
<th>Esempi</th>
<th>Casi reali</th>
</tr>
</thead>
<tbody>
<tr>
<td><p><strong>Disonestà</strong></p><p>Sostenere bugie e falsità</p></td>
<td><p>Plagio, falsificazione di competenze e conoscenze, falsificazione di documenti, imbrogli negli esami e nei colloqui, ecc.</p></td>
<td><p>Aumentano i casi di studenti che imbrogliano con l'intelligenza artificiale nelle università britanniche e australiane<sup><a data-type="noteref" href="ch09.html#id1032" id="id1032-marker" translate="no">a</a></sup></p></td>
</tr>
<tr>
<td><p><strong>Propaganda</strong></p><p>Distorsione della percezione della realtà per promuovere un'agenda</p></td>
<td><p>Impersonare altre persone, promuovere l'estremismo, influenzare le campagne, ecc.</p></td>
<td><p>I falsi conduttori di notizie AI che diffondono disinformazione o propaganda<sup><a data-type="noteref" href="ch09.html#id1033" id="id1033-marker" translate="no">b</a></sup></p></td>
</tr>
<tr>
<td><p><strong>L'inganno</strong></p><p>Ingannare gli altri e creare false impressioni</p></td>
<td><p>Generazione di recensioni false, annunci truffaldini ed email di phishing, profili sintetici (ad esempio, sockpuppeting), ecc.</p></td>
<td><p>Lo studio di ingegneria Arup è stato vittima di una truffa deepfake da 25 milioni di dollari<sup><a data-type="noteref" href="ch09.html#id1034" id="id1034-marker" translate="no">c</a></sup></p></td>
</tr>
</tbody>
<tbody><tr class="footnotes"><td colspan="3"><p data-type="footnote" id="id1032"><sup><a href="ch09.html#id1032-marker">a</a></sup> Fonti: <em>Times Higher Education</em> e <em>The Guardian</em></p><p data-type="footnote" id="id1033"><sup><a href="ch09.html#id1033-marker">b</a></sup> Fonti: <em>The Guardian</em>, <em>MIT Technology Review</em> e <em>The Washington Post</em></p><p data-type="footnote" id="id1034"><sup><a href="ch09.html#id1034-marker">c</a></sup> Fonti: CNN e <em>The Guardian</em></p></td></tr></tbody></table>
<p>Lo stesso studio classifica gli abusi delle applicazioni GenAI come segue:</p>
<ul>
<li>
<p><em>Disinformazione e disinformazione</em> per diffondere propaganda e fake news</p>
</li>
<li>
<p><em>Amplificazione dei pregiudizi e discriminazione</em> per promuovere programmi razzisti e<span class="keep-together">discriminazioni</span> sociali</p>
</li>
<li>
<p><em>Generazione di contenuti dannosi</em> attraverso la creazione di contenuti tossici, ingannevoli e radicalizzanti</p>
</li>
<li>
<p><em>Attacchi alla privacy dei dati</em> per colmare le lacune dei dati privati rubati e far trapelare<span class="keep-together">informazioni</span> sensibili</p>
</li>
<li>
<p><em>Cyberattacchi automatizzati</em> per personalizzare gli attacchi di phishing e ransomware</p>
</li>
<li>
<p><em>Furto d'identità e ingegneria sociale</em> per aumentare il tasso di successo delle truffe</p>
</li>
<li>
<p><em>Deepfakes e manipolazione multimediale</em> per trarre profitto e alterare la percezione della realtà e le credenze sociali</p>
</li>
<li>
<p><em>Truffa e frode</em> manipolando i mercati azionari e realizzando truffe mirate</p>
</li>
</ul>
<p>Non si tratta di un elenco esaustivo, ma dovrebbe darti qualche idea su quali misure di moderazione dell'uso prendere in considerazione.</p>
<p><a href="https://oreil.ly/jbG01">Un altro studio sulla tassonomia delle tattiche di abuso della GenAI</a> ha analizzato l'abuso per modalità e ha rilevato che:</p>
<ul class="less_space pagebreak-before">
<li>
<p>Per la maggior parte dei tentativi di impersonificazione sono stati utilizzati<em>generatori audio e video</em>.</p>
</li>
<li>
<p>I<em>generatori di immagini e di testo</em> sono stati utilizzati per la maggior parte dei sockpuppeting, il content farming per la manipolazione delle opinioni in scala e i tentativi di falsificazione.</p>
</li>
<li>
<p>I<em>generatori di immagini e video</em> sono stati utilizzati per la maggior parte dei tentativi di steganografia (cioè di nascondere messaggi codificati nei risultati del modello) e di generazione di contenuti intimi non consensuali (NCII).</p>
</li>
</ul>
<p>Se stai creando dei servizi che supportano queste modalità, devi considerare le forme di abuso ad esse associate e implementare i relativi meccanismi di protezione.</p>
<p>Oltre all'uso improprio e all'abuso, dovrai anche considerare le vulnerabilità della sicurezza.</p>
<p>La sicurezza dei servizi GenAI è ancora un'area di ricerca al momento della stesura di questo articolo. Ad esempio, se i tuoi servizi sfruttano le LLM, OWASP ha classificato le <a href="https://oreil.ly/4zob2">10 principali vulnerabilità delle LLM</a>, come mostrato nella <a data-type="xref" href="#llm_vulnerabilities">Tabella 9-2</a>.</p>
<table class="striped" id="llm_vulnerabilities">
<caption><span class="label">Tabella 9-2. </span>Le 10 principali vulnerabilità LLM di OWASP</caption>
<thead>
<tr>
<th>Rischio</th>
<th>Descrizione</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>Iniezione prompt</p></td>
<td><p>La manipolazione degli input per controllare le risposte del LLM porta ad accessi non autorizzati, violazioni dei dati e compromissione del processo decisionale.</p></td>
</tr>
<tr>
<td><p>Gestione insicura dell'output</p></td>
<td><p>La mancata sanitizzazione o convalida degli output di LLM causa l'esecuzione di codice remoto sui sistemi a valle.</p></td>
</tr>
<tr>
<td><p>Avvelenamento dei dati di formazione</p></td>
<td><p>Iniettare dati nelle fonti su cui i modelli vengono addestrati per compromettere la sicurezza, l'accuratezza o il comportamento etico. I modelli open source e i servizi RAG che si basano su dati web sono i più esposti a questi attacchi.</p></td>
</tr>
<tr>
<td><p>Modello di negazione del servizio</p></td>
<td><p>Causare interruzioni del servizio ed esplosioni dei costi sovraccaricando gli LLMs con carichi pesanti e richieste simultanee.</p></td>
</tr>
<tr>
<td><p>Vulnerabilità della catena di approvvigionamento</p></td>
<td><p>Causando la compromissione di vari componenti, tra cui le fonti di dati, e minando l'integrità del sistema.</p></td>
</tr>
<tr>
<td><p>Perdita di informazioni sensibili</p></td>
<td><p>Con conseguente esposizione accidentale di dati privati, responsabilità legali e perdita di vantaggi competitivi.</p></td>
</tr>
<tr>
<td><p>Design insicuro del plug-in</p></td>
<td><p>Le vulnerabilità nelle integrazioni di terze parti causano l'esecuzione di codice remoto.</p></td>
</tr>
<tr>
<td><p>Agenzia eccessiva</p></td>
<td><p>L'eccessiva autonomia degli LLMs nel compiere azioni può portare a conseguenze indesiderate e dannose.</p></td>
</tr>
<tr>
<td><p>Eccessiva dipendenza dall'LLM</p></td>
<td><p>Compromettendo il processo decisionale, contribuendo alla vulnerabilità della sicurezza e alle responsabilità legali.</p></td>
</tr>
<tr>
<td><p>Modello furto</p></td>
<td><p>In relazione alla copia o all'utilizzo non autorizzato dei tuoi modelli.</p></td>
</tr>
</tbody>
</table>
<div data-type="tip"><h6>Suggerimento</h6>
<p>Vulnerabilità simili esistono anche per altri tipi di sistemi GenAI, come i generatori di immagini, audio, video e geometrie.</p>
<p>Ti consiglio di ricercare e identificare le vulnerabilità del software relative ai tuoi casi d'uso.</p>
</div>
<p>Senza protezioni, i tuoi servizi possono essere abusati per causare danni personali e finanziari, furti di identità, danni economici, diffondere disinformazione e contribuire a problemi sociali. Di conseguenza, è fondamentale implementare diverse misure di sicurezza e protezioni per proteggere i tuoi servizi da tali attacchi.</p>
<p>Nella prossima sezione scoprirai le misure di moderazione dell'uso e di sicurezza che puoi implementare per proteggere i tuoi servizi GenAI prima della distribuzione.<a data-startref="ix_ch09-asciidoc1" data-type="indexterm" id="id1035"/></p>
</div></section>
<section data-pdf-bookmark="Guardrails" data-type="sect1"><div class="sect1" id="id136">
<h1>Guardrail</h1>
<p><a data-primary="guardrails" data-type="indexterm" id="ix_ch09-asciidoc2"/><a data-primary="securing AI services" data-secondary="guardrails" data-type="indexterm" id="ix_ch09-asciidoc3"/>I<em>guardrail</em> si riferiscono a <em>controlli investigativi</em> che hanno lo scopo di guidare la tua applicazione verso i risultati previsti. Sono incredibilmente diversi e possono essere configurati per adattarsi a qualsiasi situazione che potrebbe andare storta con i tuoi sistemi GenAI.</p>
<p>Ad esempio, i <em>guardrail I/O</em> sono progettati per verificare i dati che entrano in un modello GenAI e le uscite inviate ai sistemi o agli utenti a valle. Tali guardrail possono segnalare query inappropriate da parte dell'utente e convalidare il contenuto dell'uscita contro la tossicità, le allucinazioni o gli argomenti vietati. La<a data-type="xref" href="#guardrails">Figura 9-1</a> mostra l'aspetto di un sistema LLM una volta aggiunti i guardrail I/O.</p>
<figure><div class="figure" id="guardrails">
<img alt="bgai 0901" src="assets/bgai_0901.png" width="1439" height="889"/>
<h6><span class="label">Figura 9-1. </span>Confronto di un sistema LLM senza e con guardrail</h6>
</div></figure>
<p>Non è necessario implementare guardrail da zero. Al momento della stesura di questo articolo, esistono framework guardrail open source precostituiti come NVIDIA NeMo Guardrails, LLM-Guard e Guardrails AI per proteggere i tuoi servizi. Tuttavia, potrebbero richiedere l'apprendimento di linguaggi correlati al framework e hanno come contropartita il rallentamento dei servizi e l'appesantimento dell'applicazione a causa di varie dipendenze esterne.</p>
<p>Altri guardrail commerciali disponibili sul mercato, come Open AI's Moderation API, Microsoft Azure AI Content Safety API e Google's Guardrails API, non sono open source o mancano di dettagli e contenuti per misurare i vincoli di qualità.</p>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>I guardrail rimangono un'area di ricerca attiva. Sebbene tali difese possano contrastare alcuni attacchi, gli attacchi più potenti supportati dall'intelligenza artificiale possono comunque aggirarli. Questo potrebbe portare a un <a href="https://oreil.ly/xlUmw">ciclo continuo e infinito di attacchi e difese</a>.</p>
</div>
<p>Sebbene l'ingegnerizzazione dei guardrail I/O a livello di applicazione non fornisca una protezione perfetta, i prossimi modelli GenAI potrebbero includere guardrail integrati all'interno del modello per migliorare le garanzie di sicurezza. Tuttavia, tali guardrail potrebbero avere un impatto sulle prestazioni dei tempi di risposta introducendo latenza nel sistema.</p>
<section data-pdf-bookmark="Input Guardrails" data-type="sect2"><div class="sect2" id="id137">
<h2>Guardrail di ingresso</h2>
<p><a data-primary="guardrails" data-secondary="input guardrails" data-type="indexterm" id="ix_ch09-asciidoc4"/><a data-primary="input guardrails" data-type="indexterm" id="ix_ch09-asciidoc5"/><a data-primary="securing AI services" data-secondary="guardrails" data-tertiary="input guardrails" data-type="indexterm" id="ix_ch09-asciidoc6"/>Lo scopo dei guardrail di ingresso è quello di impedire che contenuti dannosi o inappropriati raggiungano il tuo modello. <a data-type="xref" href="#guardrails_input">La Tabella 9-3</a> mostra i guardrail di ingresso più comuni.</p>
<table class="striped" id="guardrails_input">
<caption><span class="label">Tabella 9-3. </span>Guardrail comuni per gli ingressi</caption>
<thead>
<tr>
<th>Guardrail di ingresso</th>
<th>Esempi</th>
</tr>
</thead>
<tbody>
<tr>
<td><p><strong>Attuale</strong></p><p>Evita i contenuti off-topic o sensibili.</p></td>
<td><p>Impedire a un utente di discutere di argomenti politici e contenuti espliciti.</p></td>
</tr>
<tr>
<td><p><strong>Iniezione diretta di prompt</strong>(jail-breaking)</p><p>Impedisci agli utenti di rivelare o di ignorare i prompt e i segreti del sistema: più lungo è il contenuto dell'input, più il tuo sistema sarà soggetto a questi attacchi.</p></td>
<td><p>Bloccando i tentativi di ignorare i prompt del sistema e di manipolare il sistema per fargli rivelare le chiavi API interne o le impostazioni di configurazione.<sup><a data-type="noteref" href="ch09.html#id1036" id="id1036-marker" translate="no">a</a></sup></p></td>
</tr>
<tr>
<td><p><strong>Iniezione indiretta di prompt</strong></p><p>Impedire l'accettazione di contenuti dannosi da fonti esterne, come file o siti web, che possono causare confusione del modello o l'esecuzione di codice remoto sui sistemi a valle.</p><p>I contenuti dannosi possono essere invisibili all'occhio umano e codificati all'interno del testo o delle immagini in ingresso.</p></td>
<td><p>Sanificazione di payload codificati nelle immagini caricate, caratteri nascosti o prompt override nei documenti caricati, script nascosti negli URL remoti o persino trascrizioni di video di YouTube.</p></td>
</tr>
<tr>
<td><p><strong>Moderazione</strong></p><p>Rispettare le linee guida del marchio, i requisiti legali e di branding.</p></td>
<td><p>Contrassegnare e rifiutare le query degli utenti non valide se queste includono riferimenti a bestemmie, concorrenti, contenuti espliciti, informazioni di identificazione personale (PII), autolesionismo, ecc.</p></td>
</tr>
<tr>
<td><p><strong>Attributo</strong></p><p>Convalida le proprietà dell'input.</p></td>
<td><p>Controlla la lunghezza della query, le dimensioni del file, le scelte, l'intervallo, il formato e la struttura dei dati, ecc.</p></td>
</tr>
</tbody>
<tbody><tr class="footnotes"><td colspan="2"><p data-type="footnote" id="id1036">Anche se i guardrail sono utili, la pratica migliore è evitare di dare ai tuoi modelli GenAI la conoscenza diretta di segreti o impostazioni di configurazione sensibili.</p></td></tr></tbody></table>
<p>I guardrail di ingresso possono anche essere combinati con gli igienizzatori di contenuto per pulire gli ingressi difettosi.</p>
<p>Se vuoi implementare i tuoi guardrail, puoi iniziare con l'utilizzo di tecniche avanzate di ingegneria dei prompt all'interno del tuo sistema. Inoltre, puoi utilizzare tecniche di valutazione automatica (ad esempio, modelli di intelligenza artificiale).</p>
<p>L<a data-type="xref" href="#guardrail_topical_prompt">'esempio 9-1</a> mostra un esempio di prompt del sistema per un valutatore automatico di guardrail AI per rifiutare query fuori tema.</p>
<div data-type="example" id="guardrail_topical_prompt">
<h5><span class="label">Esempio 9-1. </span>prompt del sistema guardrail di input topico</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="n" translate="no">guardrail_system_prompt</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"""</code>

<code class="s2" translate="no">Your role is to assess user queries as valid or invalid</code>

<code class="s2" translate="no">Allowed topics include:</code>

<code class="s2" translate="no">1. API Development</code>
<code class="s2" translate="no">2. FastAPI</code>
<code class="s2" translate="no">3. Building Generative AI systems</code>

<code class="s2" translate="no">If a topic is allowed, say 'allowed' otherwise say 'disallowed'</code>
<code class="s2" translate="no">"""</code></pre></div>
<p>Puoi vedere un'implementazione di un guardrail topico in ingresso nell'<a data-type="xref" href="#guardrail_topical">Esempio 9-2</a> che utilizza la tecnica di valutazione automatica di LLM.</p>
<div data-type="example" id="guardrail_topical">
<h5><span class="label">Esempio 9-2. </span>Parapetto di ingresso topico</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="kn" translate="no">import</code><code translate="no"> </code><code class="nn" translate="no">re</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">typing</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">openai</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">AsyncOpenAI</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">pydantic</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">AfterValidator</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">BaseModel</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">validate_call</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">guardrail_system_prompt</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">...</code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">class</code><code translate="no"> </code><code class="nc" translate="no">LLMClient</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="fm" translate="no">__init__</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">system_prompt</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">client</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">AsyncOpenAI</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">system_prompt</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">system_prompt</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">invoke</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">user_query</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="nb" translate="no">str</code><code translate="no"> </code><code class="o" translate="no">|</code><code translate="no"> </code><code class="kc" translate="no">None</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">response</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">client</code><code class="o" translate="no">.</code><code class="n" translate="no">chat</code><code class="o" translate="no">.</code><code class="n" translate="no">completions</code><code class="o" translate="no">.</code><code class="n" translate="no">create</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">model</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">gpt-4o</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">messages</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code translate="no">
</code><code translate="no">                </code><code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">role</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">system</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">content</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">system_prompt</code><code class="p" translate="no">}</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">                </code><code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">role</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">user</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">content</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">user_query</code><code class="p" translate="no">}</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">            </code><code class="p" translate="no">]</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">temperature</code><code class="o" translate="no">=</code><code class="mi" translate="no">0</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">response</code><code class="o" translate="no">.</code><code class="n" translate="no">choices</code><code class="p" translate="no">[</code><code class="mi" translate="no">0</code><code class="p" translate="no">]</code><code class="o" translate="no">.</code><code class="n" translate="no">message</code><code class="o" translate="no">.</code><code class="n" translate="no">content</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@validate_call</code><code translate="no">
</code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">check_classification_response</code><code class="p" translate="no">(</code><code class="n" translate="no">value</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code translate="no"> </code><code class="o" translate="no">|</code><code translate="no"> </code><code class="kc" translate="no">None</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_securing_ai_services_CO1-1" id="co_securing_ai_services_CO1-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="n" translate="no">value</code><code translate="no"> </code><code class="ow" translate="no">is</code><code translate="no"> </code><code class="kc" translate="no">None</code><code translate="no"> </code><code class="ow" translate="no">or</code><code translate="no"> </code><code class="ow" translate="no">not</code><code translate="no"> </code><code class="n" translate="no">re</code><code class="o" translate="no">.</code><code class="n" translate="no">match</code><code class="p" translate="no">(</code><code class="sa" translate="no">r</code><code class="s2" translate="no">"</code><code class="s2" translate="no">^(allowed|disallowed)$</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">value</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">raise</code><code translate="no"> </code><code class="ne" translate="no">ValueError</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Invalid topical guardrail response received</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">value</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">ClassificationResponse</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code translate="no">
</code><code translate="no">    </code><code class="nb" translate="no">str</code><code translate="no"> </code><code class="o" translate="no">|</code><code translate="no"> </code><code class="kc" translate="no">None</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">AfterValidator</code><code class="p" translate="no">(</code><code class="n" translate="no">check_classification_response</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="p" translate="no">]</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">class</code><code translate="no"> </code><code class="nc" translate="no">TopicalGuardResponse</code><code class="p" translate="no">(</code><code class="n" translate="no">BaseModel</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">classification</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">ClassificationResponse</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">is_topic_allowed</code><code class="p" translate="no">(</code><code class="n" translate="no">user_query</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">TopicalGuardResponse</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">response</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">LLMClient</code><code class="p" translate="no">(</code><code class="n" translate="no">guardrail_system_prompt</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="p" translate="no">(</code><code class="n" translate="no">user_query</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">TopicalGuardResponse</code><code class="p" translate="no">(</code><code class="n" translate="no">classification</code><code class="o" translate="no">=</code><code class="n" translate="no">response</code><code class="p" translate="no">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_securing_ai_services_CO1-1" id="callout_securing_ai_services_CO1-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Gestire i casi in cui l'LLM non restituisce una classificazione valida</p></dd>
</dl></div>
<div data-type="tip"><h6>Suggerimento</h6>
<p>Utilizzando la tecnica mostrata nell'<a data-type="xref" href="#guardrail_topical">Esempio 9-2</a>, puoi implementare dei valutatori automatici per verificare la presenza di tentativi di jail-breaking e prompt injection o anche per rilevare la presenza di PII e bestemmie negli input.</p>
</div>
<p>Come abbiamo visto nel <a data-type="xref" href="ch05.html#ch05">Capitolo 5</a>, puoi sfruttare il più possibile la programmazione asincrona anche quando utilizzi tecniche di valutazione automatica nei tuoi guardrail. Questo perché i guardrail di AI richiedono l'invio di più chiamate all'API del modello per ogni query dell'utente. Per migliorare l'esperienza dell'utente, puoi eseguire questi guardrail in parallelo al processo di inferenza del modello.</p>
<p>Una volta che hai un guardrail autovalutativo per la verifica degli argomenti consentiti, puoi eseguirlo in parallelo alla tua generazione di dati<sup><a data-type="noteref" href="ch09.html#id1037" id="id1037-marker" translate="no">1</a></sup>  utilizzando <code translate="no">asyncio.wait</code>, come mostrato nell'<a data-type="xref" href="#guardrail_concurrent_execution">Esempio 9-3</a>.</p>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>Tieni presente che l'implementazione di guardrail async può innescare meccanismi di limitazione della velocità e di strozzatura delle API dei provider di modelli. A seconda dei requisiti della tua applicazione, potresti voler richiedere limiti di velocità più elevati o ridurre la velocità delle chiamate API in un breve lasso di tempo.</p>
</div>
<div data-type="example" id="guardrail_concurrent_execution">
<h5><span class="label">Esempio 9-3. </span>Esecuzione di guardrail AI in parallelo alla generazione di risposte</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="kn" translate="no">import</code><code translate="no"> </code><code class="nn" translate="no">asyncio</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">typing</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">loguru</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">logger</code><code translate="no">
</code><code translate="no">
</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">invoke_llm_with_guardrails</code><code class="p" translate="no">(</code><code class="n" translate="no">user_query</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">topical_guardrail_task</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">asyncio</code><code class="o" translate="no">.</code><code class="n" translate="no">create_task</code><code class="p" translate="no">(</code><code class="n" translate="no">is_topic_allowed</code><code class="p" translate="no">(</code><code class="n" translate="no">user_query</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">chat_task</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">asyncio</code><code class="o" translate="no">.</code><code class="n" translate="no">create_task</code><code class="p" translate="no">(</code><code class="n" translate="no">llm_client</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="p" translate="no">(</code><code class="n" translate="no">user_query</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">while</code><code translate="no"> </code><code class="kc" translate="no">True</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">done</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">_</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">asyncio</code><code class="o" translate="no">.</code><code class="n" translate="no">wait</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">            </code><code class="p" translate="no">[</code><code class="n" translate="no">topical_guardrail_task</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">chat_task</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">return_when</code><code class="o" translate="no">=</code><code class="n" translate="no">asyncio</code><code class="o" translate="no">.</code><code class="n" translate="no">FIRST_COMPLETED</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_securing_ai_services_CO2-1" id="co_securing_ai_services_CO2-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="n" translate="no">topical_guardrail_task</code><code translate="no"> </code><code class="ow" translate="no">in</code><code translate="no"> </code><code class="n" translate="no">done</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">topic_allowed</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">topical_guardrail_task</code><code class="o" translate="no">.</code><code class="n" translate="no">result</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="ow" translate="no">not</code><code translate="no"> </code><code class="n" translate="no">topic_allowed</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">                </code><code class="n" translate="no">chat_task</code><code class="o" translate="no">.</code><code class="n" translate="no">cancel</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_securing_ai_services_CO2-2" id="co_securing_ai_services_CO2-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">                </code><code class="n" translate="no">logger</code><code class="o" translate="no">.</code><code class="n" translate="no">warning</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Topical guardrail triggered</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">                </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">                    </code><code class="s2" translate="no">"</code><code class="s2" translate="no">Sorry, I can only talk about </code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">                    </code><code class="s2" translate="no">"</code><code class="s2" translate="no">building GenAI services with FastAPI</code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">                </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">elif</code><code translate="no"> </code><code class="n" translate="no">chat_task</code><code translate="no"> </code><code class="ow" translate="no">in</code><code translate="no"> </code><code class="n" translate="no">done</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">                </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">chat_task</code><code class="o" translate="no">.</code><code class="n" translate="no">result</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">else</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">asyncio</code><code class="o" translate="no">.</code><code class="n" translate="no">sleep</code><code class="p" translate="no">(</code><code class="mf" translate="no">0.1</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_securing_ai_services_CO2-3" id="co_securing_ai_services_CO2-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/text/generate</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">generate_text_controller</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">response</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">invoke_llm_with_guardrails</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code><code translate="no"> </code><a class="co" href="#callout_securing_ai_services_CO2-4" id="co_securing_ai_services_CO2-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">response</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_securing_ai_services_CO2-1" id="callout_securing_ai_services_CO2-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Crea due task asyncio da eseguire in parallelo utilizzando <code translate="no">asyncio.wait</code>. L'operazione ritorna non appena un task viene completato.</p></dd>
<dt><a class="co" href="#co_securing_ai_services_CO2-2" id="callout_securing_ai_services_CO2-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Se il guardrail viene attivato, annulla l'operazione di chat e restituisce una risposta codificata. Puoi registrare l'attivazione in un database e inviare email di notifica qui.</p></dd>
<dt><a class="co" href="#co_securing_ai_services_CO2-3" id="callout_securing_ai_services_CO2-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Continua a controllare il ciclo di eventi asyncio ogni 100 ms fino a quando un'attività non viene completata.</p></dd>
<dt><a class="co" href="#co_securing_ai_services_CO2-4" id="callout_securing_ai_services_CO2-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Sfrutta l'iniezione di dipendenza per restituire la risposta del modello se i guardrail non vengono attivati.</p></dd>
</dl></div>
<p class="less_space pagebreak-before">Poiché i guardrail abilitati per GenAI, come quelli implementati nell'<a data-type="xref" href="#guardrail_concurrent_execution">Esempio 9-3</a>, rimangono probabilistici, i tuoi servizi GenAI possono ancora essere vulnerabili agli attacchi di tipo prompt injection e jail-breaking. Ad esempio, gli aggressori possono utilizzare tecniche più avanzate di prompt injection per aggirare i tuoi guardrail AI. D'altro canto, i tuoi guardrail possono anche rifiutare in modo errato query valide dell'utente, causando falsi positivi che possono peggiorare l'esperienza dell'utente.</p>
<div data-type="tip"><h6>Suggerimento</h6>
<p>La combinazione di guardrail con modelli di rilevamento basati su regole o sull'apprendimento automatico tradizionale può aiutare a mitigare alcuni dei rischi sopra citati.</p>
<p>Inoltre, puoi utilizzare dei guardrail che considerano solo l'ultimo messaggio per ridurre il rischio che il modello venga confuso da una lunga conversazione.</p>
</div>
<p>Quando si progettano i guardrail, è necessario considerare i compromessi tra <em>precisione</em>, <em>latenza</em> e <em>costi</em> per bilanciare l'esperienza dell'utente con i controlli di sicurezza richiesti.<a data-startref="ix_ch09-asciidoc6" data-type="indexterm" id="id1038"/><a data-startref="ix_ch09-asciidoc5" data-type="indexterm" id="id1039"/><a data-startref="ix_ch09-asciidoc4" data-type="indexterm" id="id1040"/></p>
</div></section>
<section data-pdf-bookmark="Output Guardrails" data-type="sect2"><div class="sect2" id="id138">
<h2>Guardrail di uscita</h2>
<p><a data-primary="guardrails" data-secondary="output guardrails" data-type="indexterm" id="id1041"/><a data-primary="output guardrails" data-type="indexterm" id="id1042"/><a data-primary="securing AI services" data-secondary="guardrails" data-tertiary="output guardrails" data-type="indexterm" id="id1043"/>Lo scopo dei guardrail di output è quello di convalidare il contenuto prodotto da Genai prima che venga passato agli utenti o ai sistemi a valle. <a data-type="xref" href="#guardrails_output">La Tabella 9-4</a> mostra i guardrail di output più comuni.</p>
<table class="striped" id="guardrails_output">
<caption><span class="label">Tabella 9-4. </span>Guardrail di uscita comuni</caption>
<thead>
<tr>
<th>Guardrail di uscita</th>
<th>Esempi</th>
</tr>
</thead>
<tbody>
<tr>
<td><p><strong>Allucinazione/controllo dei fatti</strong></p><p>Blocca le allucinazioni e restituisce risposte in scatola come "Non lo so".</p></td>
<td><p>Misurare metriche come la <em>pertinenza</em>, la <em>coerenza</em>, la <em>consistenza</em>, la <em>fluidità</em> e così via, sui risultati del modello rispetto a un corpus di verità di base nelle applicazioni RAG.</p></td>
</tr>
<tr>
<td><p><strong>Moderazione</strong></p><p>Applicare le linee guida del marchio e dell'azienda per regolare i risultati del modello, filtrando o riscrivendo le risposte che le violano.</p></td>
<td><p>Verifica di metriche come la <em>leggibilità</em>, la <em>tossicità</em>, il <em>sentiment</em>, il <em>numero di menzioni dei concorrenti</em>, ecc.</p></td>
</tr>
<tr>
<td><p><strong>Controlli della sintassi</strong></p><p>Verificare la struttura e il contenuto degli output del modello. Questi guardrail possono rilevare e riprovare o gestire con grazia le eccezioni per evitare guasti nei sistemi a valle.</p></td>
<td><p>Convalida degli schemi JSON e dei parametri delle funzioni nei flussi di lavoro <em>di chiamata delle funzioni</em> quando i modelli invocano le funzioni.</p><p>Verifica delle selezioni di strumenti/agenti nei <em>flussi di lavoro agenziali</em>.</p></td>
</tr>
</tbody>
</table>
<p>Tutti i guardrail di uscita sopra citati si baseranno sul <em>valore di soglia</em> per rilevare le risposte non valide.</p>
</div></section>
<section class="less_space pagebreak-before" data-pdf-bookmark="Guardrail Thresholds" data-type="sect2"><div class="sect2" id="id252">
<h2>Soglie per guardrail</h2>
<p><a data-primary="guardrails" data-secondary="thresholds" data-type="indexterm" id="id1044"/><a data-primary="securing AI services" data-secondary="guardrails" data-tertiary="thresholds" data-type="indexterm" id="id1045"/>Guardrail può utilizzare varie metriche come la <em>leggibilità</em>, la <em>tossicità</em>, ecc. per misurare e convalidare la qualità dei risultati del modello. Per ogni metrica, dovrai sperimentare per identificare il<em>valore soglia</em> appropriato per il tuo caso d'uso, tenendo presente che:</p>
<ul>
<li>
<p>Un maggior numero di <em>falsi positivi</em> può infastidire i tuoi utenti e ridurre l'usabilità dei tuoi<span class="keep-together">servizi.</span></p>
</li>
<li>
<p>Un numero maggiore di <em>falsi negativi</em> può causare danni duraturi alla tua reputazione e far esplodere i costi, poiché gli utenti malintenzionati possono abusare del sistema o eseguire attacchi prompt injection/jail-breaking.</p>
</li>
</ul>
<p>In genere, dovresti valutare i rischi e i casi peggiori di avere dei falsi negativi e se sei disposto a barattare alcuni falsi negativi nel tuo caso d'uso per migliorare l'esperienza dell'utente. Ad esempio, puoi ridurre i casi di blocco degli output se includono più gergo e non sono così leggibili.</p>
</div></section>
<section data-pdf-bookmark="Implementing a Moderation Guardrail" data-type="sect2"><div class="sect2" id="id139">
<h2>Implementare una barriera di moderazione</h2>
<p><a data-primary="G-Eval framework" data-type="indexterm" id="ix_ch09-asciidoc7"/><a data-primary="guardrails" data-secondary="implementing a moderation guardrail" data-type="indexterm" id="ix_ch09-asciidoc8"/><a data-primary="securing AI services" data-secondary="guardrails" data-tertiary="implementing a moderation guardrail" data-type="indexterm" id="ix_ch09-asciidoc9"/>Implementiamo una barriera di moderazione utilizzando una versione del <a href="https://oreil.ly/7Nent">metodo di valutazione<em>G-Eval</em></a> per misurare la presenza di contenuti indesiderati nell'output del modello.</p>
<p>Il framework G-Eval utilizza i seguenti componenti per assegnare un punteggio ai contenuti non validi:</p>
<ul>
<li>
<p>Un nome di <em>dominio</em> che specifichi il tipo di contenuto da moderare</p>
</li>
<li>
<p>Una serie di <em>criteri</em> per delineare chiaramente quali sono i contenuti validi e quali quelli non validi.</p>
</li>
<li>
<p>Un elenco ordinato di <em>fasi di istruzione</em> per la classificazione del contenuto</p>
</li>
<li>
<p>Il <em>contenuto</em> deve essere valutato con un punteggio discreto da 1 a 5.</p>
</li>
</ul>
<p>L<a data-type="xref" href="#guardrail_moderation_prompt">'esempio 9-4</a> mostra un prompt di sistema che implementa il framework <em>G-Eval</em> e che verrà utilizzato da un valutatore automatico LLM.</p>
<div data-type="example" id="guardrail_moderation_prompt">
<h5><span class="label">Esempio 9-4. </span>prompt del sistema di moderazione del parapetto</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="n" translate="no">domain</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"Building GenAI Services"</code>

<code class="n" translate="no">criteria</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"""</code>
<code class="s2" translate="no">Assess the presence of explicit guidelines for API development for GenAI models.</code>
<code class="s2" translate="no">The content should contain only general evergreen advice</code>
<code class="s2" translate="no">not specific tools and libraries to use</code>
<code class="s2" translate="no">"""</code>

<code class="n" translate="no">steps</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"""</code>
<code class="s2" translate="no">1. Read the content and the criteria carefully.</code>
<code class="s2" translate="no">2. Assess how much explicit guidelines for API development</code>
<code class="s2" translate="no">for GenAI models is contained in the content.</code>
<code class="s2" translate="no">3. Assign an advice score from 1 to 5,</code>
<code class="s2" translate="no">with 1 being evergreen general advice and 5 containing explicit</code>
<code class="s2" translate="no">mentions of various tools and libraries to use.</code>
<code class="s2" translate="no">"""</code>


<code class="sa" translate="no">f</code><code class="s2" translate="no">"""</code>
<code class="s2" translate="no">You are a moderation assistant.</code>
<code class="s2" translate="no">Your role is to detect content about </code><code class="si" translate="no">{</code><code class="n" translate="no">domain</code><code class="si" translate="no">}</code><code class="s2" translate="no"> in the text provided,</code>
<code class="s2" translate="no">and mark the severity of that content.</code>

<code class="s2" translate="no">## </code><code class="si" translate="no">{</code><code class="n" translate="no">domain</code><code class="si" translate="no">}</code><code class="s2" translate="no"/>

<code class="s2" translate="no">### Criteria</code>

<code class="si" translate="no">{</code><code class="n" translate="no">criteria</code><code class="si" translate="no">}</code><code class="s2" translate="no"/>

<code class="s2" translate="no">### Instructions</code>

<code class="si" translate="no">{</code><code class="n" translate="no">steps</code><code class="si" translate="no">}</code><code class="s2" translate="no"/>

<code class="s2" translate="no">### Evaluation (score only!)</code>
<code class="s2" translate="no">"""</code></pre></div>
<p>Utilizzando il prompt del sistema implementato nell'<a data-type="xref" href="#guardrail_moderation_prompt">Esempio 9-4</a>, puoi ora implementare una barriera di moderazione seguendo l'<a data-type="xref" href="#guardrail_topical">Esempio 9-2</a>.</p>
<p>In seguito, integriamo la barriera di moderazione con la logica di invocazione della chat esistente, come illustrato nell'<a data-type="xref" href="#guardrail_moderation">Esempio 9-5</a>.</p>
<div data-type="example" id="guardrail_moderation">
<h5><span class="label">Esempio 9-5. </span>Integrazione del guardrail di moderazione</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="kn" translate="no">import</code><code translate="no"> </code><code class="nn" translate="no">asyncio</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">typing</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">loguru</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">logger</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">pydantic</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">BaseModel</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Field</code><code translate="no">
</code><code translate="no">
</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">class</code><code translate="no"> </code><code class="nc" translate="no">ModerationResponse</code><code class="p" translate="no">(</code><code class="n" translate="no">BaseModel</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">score</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="nb" translate="no">int</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Field</code><code class="p" translate="no">(</code><code class="n" translate="no">ge</code><code class="o" translate="no">=</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">le</code><code class="o" translate="no">=</code><code class="mi" translate="no">5</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code><code translate="no"> </code><a class="co" href="#callout_securing_ai_services_CO3-1" id="co_securing_ai_services_CO3-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">g_eval_moderate_content</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">chat_response</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">threshold</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">int</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="mi" translate="no">3</code><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="nb" translate="no">bool</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">response</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">LLMClient</code><code class="p" translate="no">(</code><code class="n" translate="no">guardrail_system_prompt</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="p" translate="no">(</code><code class="n" translate="no">chat_response</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">g_eval_score</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">ModerationResponse</code><code class="p" translate="no">(</code><code class="n" translate="no">score</code><code class="o" translate="no">=</code><code class="n" translate="no">response</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">score</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">g_eval_score</code><code translate="no"> </code><code class="o" translate="no">&gt;</code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">threshold</code><code translate="no"> </code><a class="co" href="#callout_securing_ai_services_CO3-2" id="co_securing_ai_services_CO3-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">invoke_llm_with_guardrails</code><code class="p" translate="no">(</code><code class="n" translate="no">user_request</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">while</code><code translate="no"> </code><code class="kc" translate="no">True</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="n" translate="no">topical_guardrail_task</code><code translate="no"> </code><code class="ow" translate="no">in</code><code translate="no"> </code><code class="n" translate="no">done</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">elif</code><code translate="no"> </code><code class="n" translate="no">chat_task</code><code translate="no"> </code><code class="ow" translate="no">in</code><code translate="no"> </code><code class="n" translate="no">done</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_securing_ai_services_CO3-3" id="co_securing_ai_services_CO3-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">chat_response</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">chat_task</code><code class="o" translate="no">.</code><code class="n" translate="no">result</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">has_passed_moderation</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">g_eval_moderate_content</code><code class="p" translate="no">(</code><code class="n" translate="no">chat_response</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="ow" translate="no">not</code><code translate="no"> </code><code class="n" translate="no">has_passed_moderation</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">                </code><code class="n" translate="no">logger</code><code class="o" translate="no">.</code><code class="n" translate="no">warning</code><code class="p" translate="no">(</code><code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Moderation guardrail flagged</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">                </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">                    </code><code class="s2" translate="no">"</code><code class="s2" translate="no">Sorry, we can</code><code class="s2" translate="no">'</code><code class="s2" translate="no">t recommend specific </code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">                    </code><code class="s2" translate="no">"</code><code class="s2" translate="no">tools or technologies at this time</code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">                </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">chat_response</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">else</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">asyncio</code><code class="o" translate="no">.</code><code class="n" translate="no">sleep</code><code class="p" translate="no">(</code><code class="mf" translate="no">0.1</code><code class="p" translate="no">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_securing_ai_services_CO3-1" id="callout_securing_ai_services_CO3-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Usa un tipo intero vincolato da Pydantic per convalidare il punteggio G-Eval del valutatore automatico di LLM.</p></dd>
<dt><a class="co" href="#co_securing_ai_services_CO3-2" id="callout_securing_ai_services_CO3-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Contrassegnare i contenuti che hanno un punteggio superiore alla soglia come se non avessero superato la moderazione.</p></dd>
<dt><a class="co" href="#co_securing_ai_services_CO3-3" id="callout_securing_ai_services_CO3-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Integrare ed eseguire il guardrail di moderazione dell'output con altri guardrail.</p></dd>
</dl></div>
<div data-type="tip"><h6>Suggerimento</h6>
<p>Oltre al nuovo framework <em>G-Eval</em>, implementato utilizzando un autovalutatore LLM, è possibile utilizzare framework di valutazione automatica più tradizionali come <a href="https://oreil.ly/_9Q9g">ROUGE</a>, <a href="https://oreil.ly/jRTeL">BERTScore</a> e <a href="https://oreil.ly/5YtJG">SummEval</a> per moderare i contenuti in uscita.</p>
</div>
<p>Hai implementato due guardrail di I/O, uno per verificare gli argomenti delle query degli utenti e l'altro per moderare gli output di LLM.</p>
<p>Per migliorare ulteriormente il tuo sistema di guardrail, puoi:</p>
<ul>
<li>
<p>Adotta l'approccio del <em>guasto rapido</em> uscendo prima se si attiva un guardrail per ottimizzare i tempi di risposta.</p>
</li>
<li>
<p>Seleziona solo i <em>guardrail appropriati</em> per i tuoi casi d'uso, invece di usarli tutti insieme, che potrebbero sovraccaricare i tuoi servizi.</p>
</li>
<li>
<p>Esegui i guardrail <em>in modo asincrono</em> anziché sequenziale per ottimizzare la latenza.</p>
</li>
<li>
<p>Implementa il <em>campionamento delle richieste</em> eseguendo guardrail più lenti su un campione di richieste per ridurre la latenza complessiva quando i tuoi servizi sono sottoposti a un carico elevato.</p>
</li>
</ul>
<p class="less_space pagebreak-before">Ora dovresti sentirti più sicuro nell'implementare i tuoi guardrail utilizzando tecniche di autovalutazione classiche o LLM senza affidarti a strumenti e librerie esterne.<a data-startref="ix_ch09-asciidoc9" data-type="indexterm" id="id1046"/><a data-startref="ix_ch09-asciidoc8" data-type="indexterm" id="id1047"/><a data-startref="ix_ch09-asciidoc7" data-type="indexterm" id="id1048"/></p>
<p>Nella prossima sezione scoprirai come limitare la velocità delle API per proteggere i tuoi servizi dal sovraccarico dei modelli e dai tentativi di scraping.<a data-startref="ix_ch09-asciidoc3" data-type="indexterm" id="id1049"/><a data-startref="ix_ch09-asciidoc2" data-type="indexterm" id="id1050"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="API Rate Limiting and Throttling" data-type="sect1"><div class="sect1" id="id140">
<h1>Limitazione e strozzatura della velocità API</h1>
<p><a data-primary="securing AI services" data-secondary="API rate limiting and throttling" data-type="indexterm" id="ix_ch09-asciidoc10"/>Quando <a data-primary="rate limiting" data-type="indexterm" id="ix_ch09-asciidoc11"/><a data-primary="securing AI services" data-secondary="API rate limiting and throttling" data-tertiary="rate limiting" data-type="indexterm" id="ix_ch09-asciidoc12"/>distribuisce i servizi GenAI, deve considerare i problemi di esaurimento del servizio e di sovraccarico del modello in produzione. La pratica migliore è quella di implementare la limitazione della velocità e potenzialmente il throttling nei servizi.</p>
<p><em>La limitazione della velocità</em> controlla la quantità di traffico in entrata e in uscita da e verso una rete per prevenire abusi, garantire un uso equo ed evitare di sovraccaricare il server. D'altra parte, il <em>throttling</em> controlla il throughput dell'API rallentando temporaneamente la velocità di elaborazione delle richieste per stabilizzare il server.</p>
<p>Entrambe le tecniche possono aiutarti:</p>
<ul>
<li>
<p><em>Previeni gli abusi</em> bloccando gli utenti malintenzionati o i bot che possono sovraccaricare i tuoi servizi con attacchi di scraping e brute-force che comportano un numero eccessivo di richieste o payload di grandi dimensioni.</p>
</li>
<li>
<p><em>Applicare politiche di utilizzo equo</em> in modo che la capacità sia condivisa tra più utenti e che si impedisca a una manciata di utenti di monopolizzare le risorse del server.</p>
</li>
<li>
<p><em>Mantenere la stabilità del server</em> regolando il traffico in entrata per mantenere costanti le prestazioni e prevenire i crash durante i periodi di picco.</p>
</li>
</ul>
<p>Per implementare la limitazione della velocità, dovrai monitorare le richieste in arrivo in un periodo di tempo e utilizzare una coda per bilanciare il carico.</p>
<p><a data-primary="rate limiting" data-secondary="strategies for" data-type="indexterm" id="id1051"/>Ci sono diverse strategie di limitazione della velocità che puoi scegliere, confrontate nella <a data-type="xref" href="#rate_limiting_strategies">Tabella 9-5</a> e mostrate nella <a data-type="xref" href="#rate_limiting_strategies_comparison">Figura 9-2</a>.</p>
<table class="striped" id="rate_limiting_strategies">
<caption><span class="label">Tabella 9-5. </span>Strategie di limitazione della velocità</caption>
<thead>
<tr>
<th>Strategia</th>
<th>Vantaggi</th>
<th>Limitazioni</th>
<th>Casi d'uso</th>
</tr>
</thead>
<tbody>
<tr>
<td><p><strong>Secchiello per gettoni</strong></p><p>Un elenco viene riempito di token a ritmo costante e ogni richiesta in arrivo consuma un token. Se non ci sono abbastanza token per le richieste in arrivo, queste vengono respinte.</p></td>
<td><ul>
<li><p>Gestisce raffiche temporanee e modelli di traffico dinamici</p></li>
<li><p>Controllo granulare sull'elaborazione delle richieste</p></li>
</ul></td>
<td><p>Complesso da implementare</p></td>
<td><p>Comunemente utilizzato nella maggior parte delle API e dei servizi e nei sistemi GenAI interattivi o basati su eventi, dove la frequenza delle richieste può essere irregolare.</p></td>
</tr>
<tr>
<td><p><strong>Secchio che perde</strong></p><p>Le richieste in arrivo vengono aggiunte a una coda ed elaborate a una velocità costante per fluidificare il traffico. Se la coda si riempie, le nuove richieste in arrivo vengono respinte.</p></td>
<td><ul><li><p>Semplice da implementare</p></li>
<li><p> Mantiene un flusso di traffico coerente</p></li></ul></td>
<td><ul><li><p>Meno flessibile al traffico dinamico</p></li>
<li><p> Può rifiutare richieste valide durante i picchi improvvisi</p></li></ul></td>
<td><p>Servizi che richiedono il mantenimento di tempi di risposta coerenti nei servizi di inferenza AI</p></td>
</tr>
<tr>
<td><p><strong>Finestra fissa</strong></p><p>Limita le richieste entro finestre temporali fisse (ad esempio, 100 richieste al minuto).</p></td>
<td><p>Semplice da implementare</p></td>
<td><p>Non gestisce bene il traffico a raffica</p></td>
<td>
<ul><li><p>Applicare politiche di utilizzo rigorose per le inferenze dell'intelligenza artificiale e le chiamate API costose</p></li>
<li><p>
 Ideale per utenti free tier o per sistemi di elaborazione batch con modelli di utilizzo prevedibili.</p></li>
<li><p>Ogni richiesta viene trattata allo stesso modo</p></li></ul></td>
</tr>
<tr>
<td><p><strong>Finestra scorrevole</strong></p><p>Conta le richieste in un arco di tempo variabile.</p></td>
<td><p>Fornisce una migliore flessibilità, granularità e attenuazione del traffico burst</p></td>
<td><ul><li><p>Più complesso da implementare</p></li>
<li><p> Richiede un utilizzo maggiore della memoria per le richieste di tracciamento</p></li></ul></td>
<td><ul><li><p>Gestisce molto meglio il traffico a raffica</p></li>
<li><p> Ideale per l'IA conversazionale o per gli utenti di livello premium che si aspettano un accesso flessibile e ad alta frequenza nel tempo.</p></li></ul></td>
</tr>
</tbody>
</table>
<figure><div class="figure" id="rate_limiting_strategies_comparison">
<img alt="bgai 0902" src="assets/bgai_0902.png" width="1277" height="731"/>
<h6><span class="label">Figura 9-2. </span>Confronto tra le strategie di limitazione del tasso</h6>
</div></figure>
<p>Ora che hai una maggiore familiarità con i concetti di limitazione della velocità, proviamo a implementare la limitazione della velocità in FastAPI.</p>
<section data-pdf-bookmark="Implementing Rate Limits in FastAPI" data-type="sect2"><div class="sect2" id="id253">
<h2>Implementare i limiti di velocità in FastAPI</h2>
<p><a data-primary="rate limiting" data-secondary="implementing rate limits in FastAPI" data-type="indexterm" id="ix_ch09-asciidoc13"/><a data-primary="securing AI services" data-secondary="API rate limiting and throttling" data-tertiary="implementing rate limits in FastAPI" data-type="indexterm" id="ix_ch09-asciidoc14"/>L'approccio più veloce per aggiungere la limitazione della velocità all'interno di FastAPI è quello di utilizzare una libreria come <code translate="no">slowapi</code> che è un wrapper del pacchetto <code translate="no">limits</code> e che supporta la maggior parte delle strategie menzionate nella <a data-type="xref" href="#rate_limiting_strategies">Tabella 9-5</a>. Per prima cosa, installa la libreria <code translate="no">slowapi</code>:</p>
<pre data-code-language="bash" data-type="programlisting" translate="no">$<code class="w" translate="no"> </code>pip<code class="w" translate="no"> </code>install<code class="w" translate="no"> </code>slowapi<code class="w" translate="no"/></pre>
<p>Una volta installato il pacchetto <code translate="no">slowapi</code>, puoi seguire l'<a data-type="xref" href="#rate_limiting_slowapi_configurations">Esempio 9-6</a> per applicare una limitazione globale della velocità delle API o degli endpoint. Puoi anche monitorare e limitare l'utilizzo per indirizzo IP.</p>
<div data-type="note" epub:type="note"><h6>Nota</h6>
<p>Senza configurare un archivio dati esterno, <code translate="no">slowapi</code> memorizza e tiene traccia degli indirizzi IP nella memoria dell'applicazione per limitare la velocità.</p>
</div>
<div data-type="example" id="rate_limiting_slowapi_configurations">
<h5><span class="label">Esempio 9-6. </span>Configurazione dei limiti di velocità globali</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code class="nn" translate="no">.</code><code class="nn" translate="no">responses</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">JSONResponse</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">slowapi</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Limiter</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">slowapi</code><code class="nn" translate="no">.</code><code class="nn" translate="no">errors</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">RateLimitExceeded</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">slowapi</code><code class="nn" translate="no">.</code><code class="nn" translate="no">middleware</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">SlowAPIMiddleware</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">slowapi</code><code class="nn" translate="no">.</code><code class="nn" translate="no">util</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">get_remote_address</code><code translate="no">
</code><code translate="no">
</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">limiter</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">Limiter</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">key_func</code><code class="o" translate="no">=</code><code class="n" translate="no">get_remote_address</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">default_limits</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">200 per day</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">60 per hour</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">2/5seconds</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_securing_ai_services_CO4-1" id="co_securing_ai_services_CO4-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">app</code><code class="o" translate="no">.</code><code class="n" translate="no">state</code><code class="o" translate="no">.</code><code class="n" translate="no">limiter</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">limiter</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@app</code><code class="o" translate="no">.</code><code class="n" translate="no">exception_handler</code><code class="p" translate="no">(</code><code class="n" translate="no">RateLimitExceeded</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_securing_ai_services_CO4-2" id="co_securing_ai_services_CO4-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">rate_limit_exceeded_handler</code><code class="p" translate="no">(</code><code class="n" translate="no">request</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">exc</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">retry_after</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="nb" translate="no">int</code><code class="p" translate="no">(</code><code class="n" translate="no">exc</code><code class="o" translate="no">.</code><code class="n" translate="no">description</code><code class="o" translate="no">.</code><code class="n" translate="no">split</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no"> </code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">[</code><code class="o" translate="no">-</code><code class="mi" translate="no">1</code><code class="p" translate="no">]</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">response_body</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="p" translate="no">{</code><code translate="no">
</code><code translate="no">        </code><code class="s2" translate="no">"</code><code class="s2" translate="no">detail</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">Rate limit exceeded. Please try again later.</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="s2" translate="no">"</code><code class="s2" translate="no">retry_after_seconds</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">retry_after</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">}</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">JSONResponse</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="mi" translate="no">429</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">content</code><code class="o" translate="no">=</code><code class="n" translate="no">response_body</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">headers</code><code class="o" translate="no">=</code><code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Retry-After</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">(</code><code class="n" translate="no">retry_after</code><code class="p" translate="no">)</code><code class="p" translate="no">}</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">app</code><code class="o" translate="no">.</code><code class="n" translate="no">add_middleware</code><code class="p" translate="no">(</code><code class="n" translate="no">SlowAPIMiddleware</code><code class="p" translate="no">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_securing_ai_services_CO4-1" id="callout_securing_ai_services_CO4-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Crea un limitatore di velocità che tiene traccia dell'utilizzo di ogni indirizzo IP e rifiuta le richieste se superano i limiti specificati nell'applicazione.</p></dd>
<dt><a class="co" href="#co_securing_ai_services_CO4-2" id="callout_securing_ai_services_CO4-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Aggiungi un gestore di eccezioni personalizzato per le richieste a velocità limitata per calcolare e fornire i tempi di attesa prima che le richieste vengano accettate di nuovo.</p></dd>
</dl></div>
<p>Una volta configurato il decoratore <code translate="no">limiter</code>, puoi utilizzarlo nei tuoi gestori API, come mostrato nell'<a data-type="xref" href="#rate_limiting_slowapi">Esempio 9-7</a>.</p>
<div data-type="example" id="rate_limiting_slowapi">
<h5><span class="label">Esempio 9-7. </span>Impostazione dei limiti di velocità API per ogni gestore API</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="nd" translate="no">@app</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/generate/text</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="nd" translate="no">@limiter</code><code class="o" translate="no">.</code><code class="n" translate="no">limit</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">5/minute</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_securing_ai_services_CO5-1" id="co_securing_ai_services_CO5-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">serve_text_to_text_controller</code><code class="p" translate="no">(</code><code class="n" translate="no">request</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Request</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@app</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/generate/image</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="nd" translate="no">@limiter</code><code class="o" translate="no">.</code><code class="n" translate="no">limit</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">1/minute</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_securing_ai_services_CO5-2" id="co_securing_ai_services_CO5-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">serve_text_to_image_controller</code><code class="p" translate="no">(</code><code class="n" translate="no">request</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Request</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_securing_ai_services_CO5-3" id="co_securing_ai_services_CO5-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@app</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/health</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="nd" translate="no">@limiter</code><code class="o" translate="no">.</code><code class="n" translate="no">exempt</code><code translate="no"> </code><a class="co" href="#callout_securing_ai_services_CO5-4" id="co_securing_ai_services_CO5-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a><code translate="no">
</code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">check_health_controller</code><code class="p" translate="no">(</code><code class="n" translate="no">request</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Request</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">status</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">healthy</code><code class="s2" translate="no">"</code><code class="p" translate="no">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_securing_ai_services_CO5-1" id="callout_securing_ai_services_CO5-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Specifica limiti di velocità più granulari a livello di endpoint utilizzando un decoratore di limitazione della velocità. Il decoratore <code translate="no">limiter</code> deve essere ordinato per ultimo.</p></dd>
<dt><a class="co" href="#co_securing_ai_services_CO5-2" id="callout_securing_ai_services_CO5-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Passa l'oggetto <code translate="no">Request</code> a ogni controller in modo che il decoratore <code translate="no">slowapi</code> limiter possa agganciarsi alla richiesta in arrivo. Altrimenti, la limitazione della velocità non funzionerà.</p></dd>
<dt><a class="co" href="#co_securing_ai_services_CO5-3" id="callout_securing_ai_services_CO5-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Escludi l'endpoint <code translate="no">/health</code> dalla logica di limitazione della velocità, in quanto i provider Cloud o i demoni Docker potrebbero inviare continuamente ping a questo endpoint per controllare lo stato della tua applicazione.</p></dd>
<dt><a class="co" href="#co_securing_ai_services_CO5-4" id="callout_securing_ai_services_CO5-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Evita di limitare la velocità dell'endpoint <code translate="no">/health</code> perché i sistemi esterni potrebbero attivarlo spesso per verificare lo stato attuale del tuo servizio.</p></dd>
</dl></div>
<p>Ora che hai implementato i limiti di velocità, puoi eseguire dei test di carico utilizzando lo strumento CLI <code translate="no">ab</code> (Apache Benchmarking), come mostrato nell'<a data-type="xref" href="#rate_limiting_load_testing">Esempio 9-8</a>.</p>
<div data-type="example" id="rate_limiting_load_testing">
<h5><span class="label">Esempio 9-8. </span>Test di carico delle API con Apache Benchmark CLI</h5>
<pre data-code-language="bash" data-type="programlisting" translate="no"><code translate="no">$</code><code class="w" translate="no"> </code><code translate="no">ab</code><code class="w" translate="no"> </code><code translate="no">-n</code><code class="w" translate="no"> </code><code class="m" translate="no">100</code><code class="w" translate="no"> </code><code translate="no">-p</code><code class="w" translate="no"> </code><code class="m" translate="no">2</code><code class="w" translate="no"> </code><code translate="no">http://localhost:8000</code><code class="w" translate="no"> </code><a class="co" href="#callout_securing_ai_services_CO6-1" id="co_securing_ai_services_CO6-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_securing_ai_services_CO6-1" id="callout_securing_ai_services_CO6-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Invia 100 richieste con una velocità di 2 richieste parallele al secondo.</p></dd>
</dl></div>
<p class="less_space pagebreak-before">Le uscite del tuo terminale dovrebbero mostrare quanto segue:</p>
<pre data-code-language="text" data-type="programlisting" translate="no">200 OK
200 OK
429 Rate limited Exceeded
...</pre>
<p>Il tuo sistema di limitazione globale e locale dovrebbe ora funzionare come previsto in base agli IP in entrata.</p>
<section data-pdf-bookmark="User-based rate limits" data-type="sect3"><div class="sect3" id="id254">
<h3>Limiti di velocità basati sull'utente</h3>
<p><a data-primary="rate limiting" data-secondary="user-based rate limits" data-type="indexterm" id="id1052"/>Con un limite di velocità IP, stai limitando l'uso eccessivo in base all'IP, ma gli utenti possono aggirare il limite di velocità IP utilizzando VPN, proxy o indirizzi IP a rotazione. Al contrario, vuoi che ogni utente abbia una quota dedicata per evitare che un singolo utente consumi tutte le risorse disponibili. L'aggiunta di limiti basati sull'utente può aiutarti a prevenire l'abuso, come mostrato nell'<a data-type="xref" href="#rate_limiting_slowapi_users">Esempio 9-9</a>.</p>
<div data-type="example" id="rate_limiting_slowapi_users">
<h5><span class="label">Esempio 9-9. </span>Limitazione della velocità basata sull'utente</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="nd" translate="no">@app</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code><code class="s2" translate="no">"/generate/text"</code><code class="p" translate="no">)</code>
<code class="nd" translate="no">@limiter</code><code class="o" translate="no">.</code><code class="n" translate="no">limit</code><code class="p" translate="no">(</code><code class="s2" translate="no">"10/minute"</code><code class="p" translate="no">,</code> <code class="n" translate="no">key_func</code><code class="o" translate="no">=</code><code class="n" translate="no">get_current_user</code><code class="p" translate="no">)</code>
<code class="k" translate="no">def</code> <code class="nf" translate="no">serve_text_to_text_controller</code><code class="p" translate="no">(</code><code class="n" translate="no">request</code><code class="p" translate="no">:</code> <code class="n" translate="no">Request</code><code class="p" translate="no">):</code>
    <code class="k" translate="no">return</code> <code class="p" translate="no">{</code><code class="s2" translate="no">"message"</code><code class="p" translate="no">:</code> <code class="sa" translate="no">f</code><code class="s2" translate="no">"Hello User"</code><code class="p" translate="no">}</code></pre></div>
<p>Il tuo sistema ora limiterà gli utenti in base ai loro ID account e ai loro indirizzi IP.</p>
</div></section>
<section data-pdf-bookmark="Rate limits across instances in production" data-type="sect3"><div class="sect3" id="id255">
<h3>Limiti di velocità tra le istanze in produzione</h3>
<p><a data-primary="rate limiting" data-secondary="rate limits across instances in production" data-type="indexterm" id="id1053"/>Dato che potresti eseguire più istanze della tua applicazione in produzione man mano che scalerai i tuoi servizi, vorrai anche centralizzare il tracciamento dell'utilizzo. Altrimenti, ogni istanza fornirà i propri contatori agli utenti e un bilanciatore di carico distribuirà le richieste tra le istanze; l'utilizzo non sarà limitato come ti aspetteresti. Per ovviare a questo problema, puoi sostituire il backend di archiviazione in-memory <code translate="no">slowapi</code> con un database in-memory centralizzato come Redis, come mostrato nell'<a data-type="xref" href="#rate_limiting_slowapi_redis">Esempio 9-10</a>.</p>
<div data-type="note" epub:type="note"><h6>Nota</h6>
<p>Per eseguire l'<a data-type="xref" href="#rate_limiting_slowapi_redis">Esempio 9-10</a>, avrai bisogno di un database Redis per memorizzare i dati di utilizzo delle API degli utenti:</p>
<pre data-code-language="bash" data-type="programlisting" translate="no">$<code class="w" translate="no"> </code>pip<code class="w" translate="no"> </code>install<code class="w" translate="no"> </code>coredis<code class="w" translate="no"/>
$<code class="w" translate="no"> </code>docker<code class="w" translate="no"> </code>pull<code class="w" translate="no"> </code>redis<code class="w" translate="no"/>
$<code class="w" translate="no"> </code>docker<code class="w" translate="no"> </code>run<code class="w" translate="no"> </code><code class="se" translate="no">\</code>
<code class="w" translate="no">  </code>--name<code class="w" translate="no"> </code>rate-limit-redis-cache<code class="w" translate="no"> </code><code class="se" translate="no">\</code>
<code class="w" translate="no">  </code>-d<code class="w" translate="no"> </code><code class="se" translate="no">\</code>
<code class="w" translate="no">  </code>-p<code class="w" translate="no"> </code><code class="m" translate="no">6379</code>:6379<code class="w" translate="no"> </code><code class="se" translate="no">\</code>
<code class="w" translate="no">  </code>redis<code class="w" translate="no"/></pre>
</div>
<div class="less_space pagebreak-before" data-type="example" id="rate_limiting_slowapi_redis">
<h5><span class="label">Esempio 9-10. </span>Aggiunta di un archivio di memoria d'uso centralizzato (Redis) su più istanze</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="kn" translate="no">from</code> <code class="nn" translate="no">slowapi</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Limiter</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">slowapi.middleware</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">SlowAPIMiddleware</code>

<code class="n" translate="no">app</code><code class="o" translate="no">.</code><code class="n" translate="no">state</code><code class="o" translate="no">.</code><code class="n" translate="no">limiter</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Limiter</code><code class="p" translate="no">(</code><code class="n" translate="no">storage_uri</code><code class="o" translate="no">=</code><code class="s2" translate="no">"redis://localhost:6379"</code><code class="p" translate="no">)</code>
<code class="n" translate="no">app</code><code class="o" translate="no">.</code><code class="n" translate="no">add_middleware</code><code class="p" translate="no">(</code><code class="n" translate="no">SlowAPIMiddleware</code><code class="p" translate="no">)</code></pre></div>
<p>Ora hai un'API funzionante a velocità limitata che funziona come previsto su più istanze.</p>
<p>Puoi aggirare questo problema implementando il tuo limitatore supportato dal pacchetto <code translate="no">limits</code>. In alternativa, puoi applicare la limitazione della velocità tramite un <em>bilanciatore di carico</em>, un <em>reverse proxy</em> o un <em>gateway API</em>.</p>
<p>Ogni soluzione è in grado di instradare le richieste eseguendo limiti di velocità, traduzione di protocollo e monitoraggio del traffico a livello di infrastruttura. L'applicazione di un limite di velocità esterno può essere più adatta al tuo caso d'uso se non hai bisogno di una logica di limitazione di velocità personalizzata.</p>
</div></section>
<section data-pdf-bookmark="Limiting WebSocket connections" data-type="sect3"><div class="sect3" id="id141">
<h3>Limitare le connessioni WebSocket</h3>
<p><a data-primary="rate limiting" data-secondary="limiting WebSocket connections" data-type="indexterm" id="ix_ch09-asciidoc15"/><a data-primary="WebSocket (WS)" data-secondary="rate-limiting" data-type="indexterm" id="ix_ch09-asciidoc16"/>Purtroppo anche il pacchetto <code translate="no">slowapi</code> non supporta la limitazione degli endpoint async e WebSocket al momento in cui scriviamo.</p>
<p>Poiché è probabile che le connessioni WebSocket siano di lunga durata, potresti voler limitare la velocità di transizione dei dati inviati attraverso il socket. Puoi affidarti a pacchetti esterni come <code translate="no">fastapi-limiter</code> per limitare la velocità delle connessioni WebSocket, come mostrato nell'<a data-type="xref" href="#rate_limiting_websocket">Esempio 9-11</a>.</p>
<div data-type="example" id="rate_limiting_websocket">
<h5><span class="label">Esempio 9-11. </span>Limitare le connessioni WebSocket con il pacchetto <code translate="no">fastapi_limiter</code> </h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">contextlib</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">asynccontextmanager</code><code translate="no">
</code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="nn" translate="no">redis</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">FastAPI</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code class="nn" translate="no">.</code><code class="nn" translate="no">websockets</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">WebSocket</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi_limiter</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">FastAPILimiter</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi_limiter</code><code class="nn" translate="no">.</code><code class="nn" translate="no">depends</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">WebSocketRateLimiter</code><code translate="no">
</code><code translate="no">
</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@asynccontextmanager</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">lifespan</code><code class="p" translate="no">(</code><code class="n" translate="no">_</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">FastAPI</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_securing_ai_services_CO7-1" id="co_securing_ai_services_CO7-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">redis_connection</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">redis</code><code class="o" translate="no">.</code><code class="n" translate="no">from_url</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">redis://localhost:6379</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">encoding</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">utf8</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">FastAPILimiter</code><code class="o" translate="no">.</code><code class="n" translate="no">init</code><code class="p" translate="no">(</code><code class="n" translate="no">redis_connection</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">yield</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">FastAPILimiter</code><code class="o" translate="no">.</code><code class="n" translate="no">close</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">app</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">FastAPI</code><code class="p" translate="no">(</code><code class="n" translate="no">lifespan</code><code class="o" translate="no">=</code><code class="n" translate="no">lifespan</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@app</code><code class="o" translate="no">.</code><code class="n" translate="no">websocket</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/ws</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">websocket_endpoint</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">websocket</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">WebSocket</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">user_id</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">int</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">get_current_user</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_securing_ai_services_CO7-2" id="co_securing_ai_services_CO7-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">ratelimit</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">WebSocketRateLimiter</code><code class="p" translate="no">(</code><code class="n" translate="no">times</code><code class="o" translate="no">=</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">seconds</code><code class="o" translate="no">=</code><code class="mi" translate="no">5</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">ws_manager</code><code class="o" translate="no">.</code><code class="n" translate="no">connect</code><code class="p" translate="no">(</code><code class="n" translate="no">websocket</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">try</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">while</code><code translate="no"> </code><code class="kc" translate="no">True</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">prompt</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">ws_manager</code><code class="o" translate="no">.</code><code class="n" translate="no">receive</code><code class="p" translate="no">(</code><code class="n" translate="no">websocket</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">ratelimit</code><code class="p" translate="no">(</code><code class="n" translate="no">websocket</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">context_key</code><code class="o" translate="no">=</code><code class="n" translate="no">user_id</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_securing_ai_services_CO7-3" id="co_securing_ai_services_CO7-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">for</code><code translate="no"> </code><code class="n" translate="no">chunk</code><code translate="no"> </code><code class="ow" translate="no">in</code><code translate="no"> </code><code class="n" translate="no">azure_chat_client</code><code class="o" translate="no">.</code><code class="n" translate="no">chat_stream</code><code class="p" translate="no">(</code><code class="n" translate="no">prompt</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">ws</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">                </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">ws_manager</code><code class="o" translate="no">.</code><code class="n" translate="no">send</code><code class="p" translate="no">(</code><code class="n" translate="no">chunk</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">websocket</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">except</code><code translate="no"> </code><code class="n" translate="no">WebSocketRateLimitException</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">websocket</code><code class="o" translate="no">.</code><code class="n" translate="no">send_text</code><code class="p" translate="no">(</code><code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Rate limit exceeded. Try again later</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">finally</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">ws_manager</code><code class="o" translate="no">.</code><code class="n" translate="no">disconnect</code><code class="p" translate="no">(</code><code class="n" translate="no">websocket</code><code class="p" translate="no">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_securing_ai_services_CO7-1" id="callout_securing_ai_services_CO7-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Configura la vita dell'applicazione <code translate="no">FastAPILimiter</code> con un backend di archiviazione Redis.</p></dd>
<dt><a class="co" href="#co_securing_ai_services_CO7-2" id="callout_securing_ai_services_CO7-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Configura un limitatore di velocità WebSocket per consentire una richiesta al secondo.</p></dd>
<dt><a class="co" href="#co_securing_ai_services_CO7-3" id="callout_securing_ai_services_CO7-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Usa l'ID dell'utente come identificatore unico per la limitazione della tariffa.</p></dd>
</dl></div>
<p>L<a data-type="xref" href="#rate_limiting_websocket">'esempio 9-11</a> mostra come limitare il numero di connessioni WebSocket attive per un determinato utente.</p>
<p>Oltre a limitare la velocità degli endpoint WebSocket, potresti anche voler limitare la velocità di streaming dei dati dei tuoi modelli GenAI<a data-startref="ix_ch09-asciidoc16" data-type="indexterm" id="id1054"/><a data-startref="ix_ch09-asciidoc15" data-type="indexterm" id="id1055"/>.<a data-startref="ix_ch09-asciidoc14" data-type="indexterm" id="id1056"/><a data-startref="ix_ch09-asciidoc13" data-type="indexterm" id="id1057"/>Vediamo ora come limitare i flussi di dati in tempo reale.<a data-startref="ix_ch09-asciidoc12" data-type="indexterm" id="id1058"/><a data-startref="ix_ch09-asciidoc11" data-type="indexterm" id="id1059"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Throttling Real-Time Streams" data-type="sect2"><div class="sect2" id="id142">
<h2>Strozzatura dei flussi in tempo reale</h2>
<p><a data-primary="securing AI services" data-secondary="API rate limiting and throttling" data-tertiary="throttling real-time streams" data-type="indexterm" id="ix_ch09-asciidoc17"/><a data-primary="streams, throttling" data-type="indexterm" id="ix_ch09-asciidoc18"/><a data-primary="throttling" data-type="indexterm" id="ix_ch09-asciidoc19"/>Quando si lavora con flussi in tempo reale, potrebbe essere necessario rallentare la velocità di streaming per dare ai client il tempo sufficiente per consumare il flusso e migliorare il throughput dello streaming su più client. Inoltre, il throttling può aiutarti a gestire la larghezza di banda della rete, il carico del server e l'utilizzo delle risorse.</p>
<p>L'applicazione di un <em>throttle</em> al livello di generazione dei flussi, come mostrato nell'<a data-type="xref" href="#throttling_stream">Esempio 9-12</a>, è un approccio efficace per gestire il throughput se i tuoi servizi sono sotto pressione.</p>
<div data-type="example" id="throttling_stream">
<h5><span class="label">Esempio 9-12. </span>Strozzatura dei flussi</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="k" translate="no">class</code><code translate="no"> </code><code class="nc" translate="no">AzureOpenAIChatClient</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="fm" translate="no">__init__</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">throttle_rate</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="mf" translate="no">0.5</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_securing_ai_services_CO8-1" id="co_securing_ai_services_CO8-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">        </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">aclient</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">
</code><code translate="no">        </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">throttle_rate</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">throttle_rate</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">chat_stream</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">            </code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">prompt</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">mode</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">sse</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">model</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">gpt-3.5-turbo</code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">AsyncGenerator</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="kc" translate="no">None</code><code class="p" translate="no">]</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">stream</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">  </code><code class="c1" translate="no"># OpenAI chat completion stream</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">for</code><code translate="no"> </code><code class="n" translate="no">chunk</code><code translate="no"> </code><code class="ow" translate="no">in</code><code translate="no"> </code><code class="n" translate="no">stream</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">asyncio</code><code class="o" translate="no">.</code><code class="n" translate="no">sleep</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">throttle_rate</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_securing_ai_services_CO8-2" id="co_securing_ai_services_CO8-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="n" translate="no">chunk</code><code class="o" translate="no">.</code><code class="n" translate="no">choices</code><code class="p" translate="no">[</code><code class="mi" translate="no">0</code><code class="p" translate="no">]</code><code class="o" translate="no">.</code><code class="n" translate="no">delta</code><code class="o" translate="no">.</code><code class="n" translate="no">content</code><code translate="no"> </code><code class="ow" translate="no">is</code><code translate="no"> </code><code class="ow" translate="no">not</code><code translate="no"> </code><code class="kc" translate="no">None</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">                </code><code class="k" translate="no">yield</code><code translate="no"> </code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">                    </code><code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">data: </code><code class="si" translate="no">{</code><code class="n" translate="no">chunk</code><code class="o" translate="no">.</code><code class="n" translate="no">choices</code><code class="p" translate="no">[</code><code class="mi" translate="no">0</code><code class="p" translate="no">]</code><code class="o" translate="no">.</code><code class="n" translate="no">delta</code><code class="o" translate="no">.</code><code class="n" translate="no">content</code><code class="si" translate="no">}</code><code class="se" translate="no">\n</code><code class="se" translate="no">\n</code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">                    </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="n" translate="no">mode</code><code translate="no"> </code><code class="o" translate="no">==</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">sse</code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">                    </code><code class="k" translate="no">else</code><code translate="no"> </code><code class="n" translate="no">chunk</code><code class="o" translate="no">.</code><code class="n" translate="no">choices</code><code class="p" translate="no">[</code><code class="mi" translate="no">0</code><code class="p" translate="no">]</code><code class="o" translate="no">.</code><code class="n" translate="no">delta</code><code class="o" translate="no">.</code><code class="n" translate="no">content</code><code translate="no">
</code><code translate="no">                </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">                </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">asyncio</code><code class="o" translate="no">.</code><code class="n" translate="no">sleep</code><code class="p" translate="no">(</code><code class="mf" translate="no">0.05</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="n" translate="no">mode</code><code translate="no"> </code><code class="o" translate="no">==</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">sse</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">yield</code><code translate="no"> </code><code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">data: [DONE]</code><code class="se" translate="no">\n</code><code class="se" translate="no">\n</code><code class="s2" translate="no">"</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_securing_ai_services_CO8-1" id="callout_securing_ai_services_CO8-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Imposta un tasso di strozzatura fisso o regolalo dinamicamente in base all'utilizzo.</p></dd>
<dt><a class="co" href="#co_securing_ai_services_CO8-2" id="callout_securing_ai_services_CO8-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Rallenta la velocità di streaming senza bloccare il ciclo degli eventi.</p></dd>
</dl></div>
<p>Puoi quindi utilizzare il flusso limitato all'interno di un endpoint SSE o WebSocket oppure limitare il numero di connessioni WebSocket attive in base ai tuoi criteri personalizzati.</p>
<p>Oltre al throttling a livello di applicazione per i flussi in tempo reale, puoi anche sfruttare il <em>traffic shaping</em> a livello di infrastruttura.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1060">
<h1>Modellamento del traffico</h1>
<p><a data-primary="traffic shaping" data-type="indexterm" id="id1061"/>Mentre gli approcci di limitazione della velocità possono aiutarti a gestire le richieste in entrata, puoi anche utilizzare tecniche di throttling come il <em>traffic shaping</em> per controllare la velocità di trasmissione dei dati.</p>
<p>Il traffic shaping assegna la priorità a determinati tipi di trasferimento dati per aiutarti a prevenire la congestione, attenuare le interruzioni di traffico e mantenere un flusso di dati coerente per ottimizzare l'uso della larghezza di banda dell'applicazione, come mostrato nella <a data-type="xref" href="#traffic_shaping">Figura 9-3</a>. Questo è particolarmente utile per i servizi GenAI che richiedono la trasmissione di dati in tempo reale, tra cui chat e streaming video.</p>
<p>Per implementare il traffic shaping, puoi utilizzare lo strumento a riga di comando <code translate="no">tc</code> di Linux per configurare regole di controllo su obiettivi come le interfacce di rete e i container Docker. Queste regole di controllo impostano limiti di larghezza di banda, ritardi di latenza intenzionali, perdita di pacchetti e limiti IP su obiettivi specifici per regolare il throughput dell'applicazione.</p>
<p>Sebbene la tecnica di traffic shaping possa aiutarti a gestire la larghezza di banda della rete, tieni presente che si tratta di algoritmi complessi e che richiede un monitoraggio costante e un controllo dinamico del flusso di pacchetti. Può anche introdurre ritardi a causa dei suoi metodi di accodamento quando la rete è molto carica.</p>
<figure><div class="figure" id="traffic_shaping">
<img alt="bgai 0903" src="assets/bgai_0903.png" width="959" height="556"/>
<h6><span class="label">Figura 9-3. </span>Modellamento del traffico</h6>
</div></figure>
</div></aside>
<p>L'uso di salvaguardie, limiti di tariffa e strozzature dovrebbe costituire una barriera sufficiente per proteggere i tuoi servizi da abusi e usi impropri.<a data-startref="ix_ch09-asciidoc19" data-type="indexterm" id="id1062"/><a data-startref="ix_ch09-asciidoc18" data-type="indexterm" id="id1063"/><a data-startref="ix_ch09-asciidoc17" data-type="indexterm" id="id1064"/></p>
<p>Nella prossima sezione scoprirai le tecniche di ottimizzazione che possono aiutarti a ridurre la latenza, aumentare la qualità delle risposte e il throughput, oltre a ridurre i costi dei tuoi servizi GenAI.<a data-startref="ix_ch09-asciidoc10" data-type="indexterm" id="id1065"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="id143">
<h1>Riassunto</h1>
<p>Questo capitolo ha fornito un riepilogo completo dei vettori di attacco per i servizi GenAI e di come salvaguardarli da tentativi avversari, usi impropri e abusi.</p>
<p>Hai imparato a implementare guardrail in ingresso e in uscita, oltre a meccanismi di valutazione e filtraggio dei contenuti per moderare l'uso del servizio. Oltre ai guardrail, hai anche sviluppato protezioni per la limitazione della velocità e il throttling delle API per gestire il carico del server e prevenire gli abusi.<a data-startref="ix_ch09-asciidoc0" data-type="indexterm" id="id1066"/></p>
<p>Nel prossimo capitolo scopriremo come ottimizzare i servizi di intelligenza artificiale attraverso varie tecniche come il caching, l'elaborazione in batch, la quantizzazione dei modelli, il prompt engineering e la messa a punto dei modelli.</p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="id1037"><sup><a href="ch09.html#id1037-marker">1</a></sup> Ispirato a <a href="https://oreil.ly/UQV6i">"Come implementare i Guardrail di LLM" del Cookbook di OpenAI.</a></p></div></div></section></div></div></body></html>
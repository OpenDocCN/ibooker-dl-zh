<html><head></head><body>
<div id="book-content">
<div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 6. Deploying Your API to the Cloud"><div class="chapter" id="chapter_6">
<h1><span class="label">Chapter 6. </span>Deploying Your API to the Cloud</h1>

<blockquote data-type="epigraph" epub:type="epigraph">
  <p>It sounds a little extreme, but in this day and age, if your work isn’t online, it doesn’t exist.</p>
  <p data-type="attribution">Austin Kleon, <em>Show Your Work! 10 Ways to Share Your Creativity and Get Discovered</em> (Workman, 2014)</p>
</blockquote>

<p>You have made great progress with your first API. You have selected the most important qualities for your users, developed multiple API endpoints, and created user-friendly documentation. In this chapter, you will publish your API to the cloud, where consumers can access it. This is another chance to share what you have been working on.</p>






<section data-type="sect1" data-pdf-bookmark="Benefits and Responsibilities of Cloud Deployment"><div class="sect1" id="id60">
<h1>Benefits and Responsibilities of Cloud Deployment</h1>

<p>The <em>cloud</em> is an informal term<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="about the cloud" id="id1330"/><a data-type="indexterm" data-primary="the cloud" data-primary-sortas="cloud" id="id1331"/> to refer to the collection of computer servers and connecting infrastructure that make the public internet. For a developer or data scientist, a great way to deploy prototypes and personal projects is through public cloud hosts. Before these became available, the process of running side projects was laborious and the capabilities were pretty limited. As a simple example, before cloud hosts became available to developers, hosting your software on a server required purchasing the physical server. When you finished with your project, you still had that server sitting around. With the cloud you can spin up a virtual server with a few commands, and when you are finished you can delete it. Now you have a great opportunity to deploy your work to a public cloud host with all of the networking and application hosting power that you can imagine (or at least afford).</p>








<section data-type="sect2" class="less_space pagebreak-before" data-pdf-bookmark="Benefits"><div class="sect2" id="id178">
<h2>Benefits</h2>

<p>Cloud platforms allow you several great opportunities for the project in this book:<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="benefits" id="id1332"/></p>

<ul>
<li>
<p>You can learn the end-to-end process of cloud development, deployment, and operations with the project that you developed.</p>
</li>
<li>
<p>You can share it with others as part of your portfolio project. This fast feedback loop allows you to learn and improve much more quickly.</p>
</li>
<li>
<p>With the published API, you can use internet-facing tools and products to explore from the user’s perspective. This is the focus of <a data-type="xref" href="part02.html#part_2">Part II</a> of this book.</p>
</li>
<li>
<p>You can use generative AI services to consume the API. This is the focus of <a data-type="xref" href="part03.html#part_3">Part III</a> of this book.</p>
</li>
</ul>

<p>I have found that deploying an application to the web makes the project real in a way that isn’t possible when it is only running in a development environment.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Responsibilities"><div class="sect2" id="id179">
<h2>Responsibilities</h2>

<p>You should be aware that deploying<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="costs" id="id1333"/> to the internet comes with a few responsibilities as well, the first of which is cost. Cloud providers offer paid services, and they generally charge a variable amount based on the amount of usage of the applications that are hosted. Although some of the cloud providers used in this chapter have a free tier of services or starter credits, they will require a debit or credit card to be added to the account. When you are developing projects on a cloud host, it’s not uncommon to have a surprise bill at the end of the month for several dollars. There are also horror stories of people who ended up with unexpected bills costing hundreds or thousands of dollars. I will share some tips about cost management, but you should take care not to sign up for any services that you can’t afford. (When deploying the example applications in this chapter, I spent less than $1 USD to host them for several weeks on all the services combined. But your costs could be greater.)</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>Another responsibility is security.<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="security" id="id1334"/><a data-type="indexterm" data-primary="security" data-secondary="deploying to the cloud" id="id1335"/> Using the phrase <em>expose your API endpoint</em> gives you a hint of this responsibility—when you make your work available to the world, bad actors can access it. If your portfolio project contains fantasy sports data, you won’t be putting any personal data at risk. However, if you are careless with the credentials you use to connect to the cloud services, you could expose usernames, passwords, and API keys publicly. This could allow a fraudster to use your accounts to run up large bills mining crypto or creating bot armies to attack websites.</p>
</div>

<p class="less_space pagebreak-before">There are several ways to control costs when using cloud hosts:</p>

<ul>
<li>
<p>Review the costs of services before using them. There are usually several services involved in a coding project. Use cost calculators if available.</p>
</li>
<li>
<p>Use services with free tiers and free trial periods.</p>
</li>
<li>
<p>Create monthly budgets and set up email notifications to notify you when you are approaching budgeted amounts.</p>
</li>
<li>
<p>Shut down or delete resources after use.</p>
</li>
<li>
<p>When you have finished working with a cloud host, clean up resources and remove your payment method.</p>
</li>
<li>
<p>Keep tight control of your login credentials.</p>
</li>
<li>
<p>Use short-lived access keys.</p>
</li>
<li>
<p>Only activate the permissions for specific services you are using, and disable them after you are done.</p>
</li>
<li>
<p>Do not commit any credentials into source control repositories.</p>
</li>
<li>
<p>If any credentials do become exposed, deactivate or delete them. Contact support of the cloud host if necessary.</p>
</li>
</ul>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Choosing a Cloud Host for Your Project"><div class="sect1" id="id180">
<h1>Choosing a Cloud Host for Your Project</h1>

<p>I have used a variety of cloud hosts<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="cloud host selection" id="id1336"/><a data-type="indexterm" data-primary="the cloud" data-secondary="host selection" data-primary-sortas="cloud" id="id1337"/> to deploy prototypes and portfolio projects, and their capabilities and pricing models change over time. When I am deciding what host to use, I first decide what my primary focus is at the time. If I am just focused on getting my app out into the world, I choose the host that is simplest to deploy. If I want to learn about a specific cloud host or some of its underlying technical services, I am more willing to put in the time (and often pay a bit in hosting fees) to learn the deployment process for that host. When I am trying to practice some deployment or operational technique such as continuous integration (CI) or containerization, I select a host that supports that particular method and use it to deploy my app.</p>

<p>This chapter includes instructions for deploying to two cloud hosts, and I would encourage you to try out both of them to see the advantages and disadvantages of each. You will begin by using Render, which is fairly simple to deploy. Then, you will install and configure the Docker containerization tool, which you will use to deploy to Amazon Web Services (AWS).</p>

<p><a data-type="xref" href="#tools_table_chapter_6">Table 6-1</a> displays the new tools or services you will use in this chapter.<a data-type="indexterm" data-primary="AWS deployment" data-secondary="about Amazon Lightsail" id="id1338"/><a data-type="indexterm" data-primary="AWS CLI" data-secondary="about" id="id1339"/><a data-type="indexterm" data-primary="Docker container deployment" data-secondary="about" id="id1340"/><a data-type="indexterm" data-primary="Render deployment" data-secondary="about Render" id="id1341"/><a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Render deployment" data-tertiary="about Render" id="id1342"/><a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Docker containers" data-tertiary="about" id="id1343"/></p>
<table id="tools_table_chapter_6">
<caption><span class="label">Table 6-1. </span>New tools or services used in this chapter</caption>
<thead>
<tr>
<th>Software or service name</th>
<th>Version</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>Amazon Lightsail</p></td>
<td><p>NA</p></td>
<td><p>AWS virtual cloud server</p></td>
</tr>
<tr>
<td><p>AWS CLI</p></td>
<td><p>2.15</p></td>
<td><p>Command-line interface for AWS services</p></td>
</tr>
<tr>
<td><p>Docker</p></td>
<td><p>24.0</p></td>
<td><p>Pack and run your application in a container</p></td>
</tr>
<tr>
<td><p>Render</p></td>
<td><p>NA</p></td>
<td><p>Cloud hosting provider</p></td>
</tr>
</tbody>
</table>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Setting Up Your Project Directory"><div class="sect1" id="id229">
<h1>Setting Up Your Project Directory</h1>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1344">
<h1>You Can Start from Here</h1>
<p>The instructions in this chapter assume that you completed Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch02.html#chapter_2">2</a>, <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch03.html#chapter_3">3</a>, <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch04.html#chapter_4">4</a>, and <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch05.html#chapter_5">5</a>. If you’re starting your coding in this chapter, you will need to perform a couple of steps to catch up. First, you need to create a GitHub Codespace from the book’s GitHub repository. Full instructions are available in <a data-type="xref" href="ch02.html#getting_started_GHcodespace">“Getting Started with Your GitHub Codespace”</a>.</p>

<p>To catch up on the coding from previous chapters,<a data-type="indexterm" data-primary="resources online" data-secondary="chapter code" data-tertiary="chapter 5 complete" id="id1345"/> you can use the completed set of files in the <em>chapter5/complete</em> directory of your Codespace. If you are using these, use the directory <em>chapter5/complete</em> in the setup commands that follow.</p>
</div></aside>

<p>To continue your portfolio project where you left it in the previous chapter, change the directory to <em>chapter6</em> and then copy the previous chapter’s files into it. The following shows the commands and expected output:<a data-type="indexterm" data-primary="portfolio projects" data-secondary="copying files from previous chapters" data-tertiary="from chapter 5" id="id1346"/></p>

<pre data-type="programlisting" data-code-language="shell">.../portfolio-project (main) $ cd chapter6
.../chapter6 (main) $ cp ../chapter5/*.py .
.../chapter6 (main) $ cp ../chapter5/fantasy_data.db .
.../chapter6 (main) $ cp ../chapter5/requirements.txt .
.../chapter6 (main) $ cp ../chapter5/readme.md .
.../chapter6 (main) $ ls *.*
crud.py  database.py  fantasy_data.db  main.py  models.py  readme.md
requirements.txt  schemas.py  test_crud.py  test_main.py</pre>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Using GitHub Codespaces as a Cloud Host"><div class="sect1" id="id181">
<h1>Using GitHub Codespaces as a Cloud Host</h1>

<p>For intermittent cloud hosting,<a data-type="indexterm" data-primary="GitHub" data-secondary="Codespaces" data-tertiary="cloud host" id="id1347"/><a data-type="indexterm" data-primary="Codespaces (GitHub)" data-secondary="cloud host" id="id1348"/><a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="GitHub Codespaces deployment" id="id1349"/> GitHub Codespaces may be sufficient. It will only be available while your Codespace is running, but this can be useful for testing with an external tool or sharing it with someone else to review.</p>

<p class="less_space pagebreak-before">When you first run the API in your Codespace,<a data-type="indexterm" data-primary="port 8000 for application" data-secondary="making public" id="id1350"/><a data-type="indexterm" data-primary="launching your API" data-secondary="port 8000 for application" data-tertiary="making public" id="id1351"/><a data-type="indexterm" data-primary="Codespaces (GitHub)" data-secondary="launching your API" data-tertiary="port 8000 made public" id="id1352"/><a data-type="indexterm" data-primary="building APIs" data-secondary="launching your API" data-tertiary="port 8000 made public" id="id1353"/><a data-type="indexterm" data-primary="GitHub" data-secondary="Codespaces" data-tertiary="launching your API to port 8000 made public" id="id1354"/> you will see a dialog stating “Your application running on port 8000 is available,” as shown in <a data-type="xref" href="#make_api_public_ch6">Figure 6-1</a>. Click Make Public.</p>

<figure><div id="make_api_public_ch6" class="figure">
<img src="assets/haad_0601.png" alt="Make API Public" width="557" height="148"/>
<h6><span class="label">Figure 6-1. </span>Making the API public</h6>
</div></figure>

<p>The API is now running in Codespaces with a public port. To view the API in the browser, click Ports in the terminal and hover over Port 8000 as shown in <a data-type="xref" href="#api_running_public_port_6">Figure 6-2</a>.</p>

<figure><div id="api_running_public_port_6" class="figure">
<img src="assets/haad_0602.png" alt="Open API on public address" width="568" height="83"/>
<h6><span class="label">Figure 6-2. </span>Open API on a public address</h6>
</div></figure>

<p>Click the globe icon, and<a data-type="indexterm" data-primary="health check" data-secondary="launching API" data-tertiary="public port" id="id1355"/> the web browser should be opened to the health check endpoint of your API. If you look at the address in your browser, you should see a base URL that ends in <em>app.github.dev</em>. The browser page should show the response from your API running on Codespaces. You should see the following health check message in your web browser:</p>

<pre data-type="programlisting">{"message":"API health check successful"}</pre>

<p>Your API is running publicly in the cloud.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Deploying to Render"><div class="sect1" id="id61">
<h1>Deploying to Render</h1>

<p>Render calls itself “a unified cloud<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Render deployment" id="ch6rend"/><a data-type="indexterm" data-primary="Render deployment" id="ch6rend2"/><a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Render deployment" data-tertiary="about Render" id="id1356"/><a data-type="indexterm" data-primary="Render deployment" data-secondary="about Render" id="id1357"/> to build and run all your apps and websites.” At the time of this writing, Render has a pricing plan that includes Python hosting for free, except for a small cost for monthly storage.  <a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Render deployment" data-tertiary="deployment instructions online" id="id1358"/><a data-type="indexterm" data-primary="Render deployment" data-secondary="deployment instructions online" id="id1359"/><a data-type="indexterm" data-primary="resources online" data-secondary="Render deployment instructions" id="id1360"/>You will be generally following the instructions from <a href="https://oreil.ly/nmdaK">Deploy a FastAPI App</a>.</p>

<p>The process of deploying to Render only involves a few steps, as shown in <a data-type="xref" href="#deploying_render_diagram_ch4">Figure 6-3</a>.</p>

<figure><div id="deploying_render_diagram_ch4" class="figure">
<img src="assets/haad_0603.png" alt="Deploying your API to Render" width="973" height="727"/>
<h6><span class="label">Figure 6-3. </span>Deploying your API to Render</h6>
</div></figure>








<section data-type="sect2" data-pdf-bookmark="Signing Up for Render"><div class="sect2" id="id182">
<h2>Signing Up for Render</h2>

<p>The first step is to <a href="https://oreil.ly/rend">sign up for a Render account</a>. <a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Render deployment" data-tertiary="creating an account" id="id1361"/><a data-type="indexterm" data-primary="Render deployment" data-secondary="creating an account" id="id1362"/>You can create a new account or use one of the existing services, such as GitHub or Google. It should work the same either way. When you have created your account and provided the information requested, you should see the Render dashboard with no services.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Creating a New Web Service"><div class="sect2" id="id62">
<h2>Creating a New Web Service</h2>

<p>From the New menu, select Web Service.<a data-type="indexterm" data-primary="Render deployment" data-secondary="new Web Service" id="ch6rndrws"/><a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Render deployment" data-tertiary="new Web Service" id="ch6rndrws2"/><a data-type="indexterm" data-primary="GitHub" data-secondary="Render new Web Service" id="ch6rndrws3"/></p>

<p>On the New Web Service page, select Public Git Repository, enter the URL of your GitHub repo, as shown in <a data-type="xref" href="#render_choose_git_ch6">Figure 6-4</a>, and click Connect.</p>

<figure><div id="render_choose_git_ch6" class="figure">
<img src="assets/haad_0604.png" alt="Choosing how to deploy your web service" width="1002" height="405"/>
<h6><span class="label">Figure 6-4. </span>Choosing how to deploy a web service</h6>
</div></figure>

<p>The next page should say “You are deploying a Web Service,” as shown in <a data-type="xref" href="#render_service_page_ch6">Figure 6-5</a>.</p>

<figure><div id="render_service_page_ch6" class="figure">
<img src="assets/haad_0605.png" alt="Render web service settings" width="740" height="253"/>
<h6><span class="label">Figure 6-5. </span>Render web service settings</h6>
</div></figure>

<p>Enter the settings on this page as follows:</p>

<ul>
<li>
<p><em>Name</em>: Enter an available unique name.</p>
</li>
<li>
<p><em>Project</em>: Do not create a project.</p>
</li>
<li>
<p><em>Language</em>: <strong><code>Python 3</code></strong></p>
</li>
<li>
<p><em>Branch</em>: <strong><code>main</code></strong></p>
</li>
<li>
<p><em>Region</em>: Select the region nearest you.</p>
</li>
<li>
<p><em>Root directory</em>: <strong><code>chapter6</code></strong></p>
</li>
<li>
<p><em>Build command</em>: <strong><code>pip install -r requirements.txt</code></strong></p>
</li>
<li>
<p><em>Start command</em>: <strong><code>uvicorn main:app --host 0.0.0.0 --port $PORT</code></strong></p>
</li>
<li>
<p><em>Instance type</em>: <strong><code>Free</code></strong></p>
</li>
</ul>

<p>Notice that the start command<a data-type="indexterm" data-primary="Uvicorn web server" data-secondary="API run without FastAPI CLI" id="id1363"/><a data-type="indexterm" data-primary="FastAPI" data-secondary="CLI" data-tertiary="Uvicorn instead" id="id1364"/><a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Render deployment" data-tertiary="Uvicorn running API" id="id1365"/> did not use <code>fastapi run</code> as you used on the command line. For the web deployments, you are directly using the Uvicorn web server to run the API without using the fastapi-cli library.</p>

<p>Scroll to the bottom of the page, and select Deploy Web Service. A page should be displayed with a deployment log. <a data-type="indexterm" data-primary="requirements.txt file for pip" data-secondary="Render deployment" id="id1366"/>As you watch, you should see the cloud host installing the software from your <em>requirements.txt</em> file and starting an instance of your application. When the process completes successfully, you should see the statement “Your service is live,” as shown in <a data-type="xref" href="#successful_render_deploy">Figure 6-6</a>.</p>

<figure><div id="successful_render_deploy" class="figure">
<img src="assets/haad_0606.png" alt="Render successfully deployed" width="767" height="428"/>
<h6><span class="label">Figure 6-6. </span>Successful deployment on Render</h6>
</div></figure>

<p>Copy the URL of your <a data-type="indexterm" data-primary="Render deployment" data-secondary="health check message" id="id1367"/><a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Render deployment" data-tertiary="health check message" id="id1368"/><a data-type="indexterm" data-primary="health check" data-secondary="Render cloud deployment" id="id1369"/>web service that is displayed near the top of the window. (In this example, the address is <em><a href="https://football-api-service.onrender.com" class="bare"><em class="hyperlink">https://football-api-service.onrender.com</em></a></em>). Paste this URL into another browser window. You should see the health check message of your API. <a data-type="indexterm" data-primary="Swagger UI" data-secondary="cloud deployment endpoint check" id="id1370"/><a data-type="indexterm" data-primary="endpoints of APIs" data-secondary="cloud deployment check via Swagger UI" id="id1371"/><a data-type="indexterm" data-primary="API endpoints" data-secondary="cloud deployment check via Swagger UI" id="id1372"/>If you access the <em>/docs</em> endpoint, you can use Swagger UI to check that the rest of the endpoints are returning data. Congratulations! You have deployed your API to the first cloud host!</p>
<div data-type="tip"><h6>Tip</h6>
<p>If you receive an error in the deployment,<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Render deployment" data-tertiary="troubleshooting" id="id1373"/><a data-type="indexterm" data-primary="Render deployment" data-secondary="troubleshooting" id="id1374"/> verify that you committed the <a data-type="xref" href="#chapter_6">Chapter 6</a> code to your repository prior to deploying.<a data-type="indexterm" data-startref="ch6rndrws" id="id1375"/><a data-type="indexterm" data-startref="ch6rndrws2" id="id1376"/><a data-type="indexterm" data-startref="ch6rndrws3" id="id1377"/></p>
</div>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Auto-Deploying a Change to Your API"><div class="sect2" id="id63">
<h2>Auto-Deploying a Change to Your API</h2>

<p>By default, Render is set<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Render deployment" data-tertiary="auto-deploying a change to your API" id="id1378"/><a data-type="indexterm" data-primary="Render deployment" data-secondary="auto-deploying a change to your API" id="id1379"/><a data-type="indexterm" data-primary="health check" data-secondary="checking auto-deployment on change to API" id="id1380"/> to auto-deploy any changes you make to files in your repository’s <em>chapter6</em> folder. Test this by modifying the health-check endpoint in <em>main.py</em> with the following message:</p>

<pre data-type="programlisting" data-code-language="python">async def root():
    return {"message": "This is an API health check: status successful"}</pre>

<p>Commit these changes to your GitHub repository.</p>

<p class="less_space pagebreak-before">Open your web service from the <a href="https://dashboard.render.com">Render dashboard</a> and select Events. The most recent event should be a new deployment. After a few minutes, you should see the updated health check text when you access the web service in your browser.</p>

<p>In the next section, you will configure your application to run on Docker, which will be used by AWS Lightsail.<a data-type="indexterm" data-startref="ch6rend" id="id1381"/><a data-type="indexterm" data-startref="ch6rend2" id="id1382"/></p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Shipping Your Application in a Docker Container"><div class="sect1" id="id64">
<h1>Shipping Your Application in a Docker Container</h1>

<p>Whereas Render deployed your<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Docker containers" id="ch6dock"/><a data-type="indexterm" data-primary="Docker container deployment" id="ch6dock2"/><a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Docker containers" data-tertiary="about" id="id1383"/><a data-type="indexterm" data-primary="containerization" data-secondary="Docker" data-seealso="Docker container deployment" id="id1384"/><a data-type="indexterm" data-primary="Docker container deployment" data-secondary="about" id="id1385"/><a data-type="indexterm" data-primary="AWS deployment" data-secondary="Docker container used" id="id1386"/><a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="AWS deployment" data-tertiary="Docker container used" id="id1387"/> application from a source code repository (GitHub), AWS will use an application named Docker. Docker is a very useful tool for shipping applications in <em>containers</em>. Just as cargo is shipped in a shipping container, applications are shipped in a software container.</p>

<p>The <a href="https://oreil.ly/TyStu">Docker glossary</a> explains<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Docker containers" data-tertiary="glossary online" id="id1388"/><a data-type="indexterm" data-primary="resources online" data-secondary="Docker" data-tertiary="glossary" id="id1389"/><a data-type="indexterm" data-primary="Docker container deployment" data-secondary="terms" data-tertiary="glossary online" id="id1390"/><a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Docker containers" data-tertiary="Dockerfile defined" id="id1391"/><a data-type="indexterm" data-primary="Docker container deployment" data-secondary="terms" data-tertiary="Dockerfile" id="id1392"/><a data-type="indexterm" data-primary="Docker container deployment" data-secondary="terms" data-tertiary="container image" id="id1393"/><a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Docker containers" data-tertiary="container image defined" id="id1394"/><a data-type="indexterm" data-primary="container image or Docker image" id="id1395"/><a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Docker containers" data-tertiary="repository" id="id1396"/><a data-type="indexterm" data-primary="Docker container deployment" data-secondary="terms" data-tertiary="repository" id="id1397"/><a data-type="indexterm" data-primary="repository of Docker images" id="id1398"/><a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Docker containers" data-tertiary="container runtime" id="id1399"/><a data-type="indexterm" data-primary="Docker container deployment" data-secondary="terms" data-tertiary="container runtime" id="id1400"/> a few key terms that you will use. A <em>Dockerfile</em> is “a text document that contains all the commands you would normally execute manually to build a Docker image.” The <em>container image</em>, or Docker image, is “an ordered collection of root filesystem changes and the corresponding execution parameters for use within a container runtime.” A <em>repository</em> is a set of Docker images. <a data-type="indexterm" data-primary="container runtime as Docker" id="id1401"/>A <em>container runtime</em> is software that uses the image to create a container, which is a runtime instance of a container image. You will use Docker as your container <span class="keep-together">runtime.</span></p>

<p>You will first learn the process of using Docker to run your application locally, and then build on that knowledge to deploy to AWS Lightsail.</p>

<p>Don’t worry if all of this information does not make sense yet. As you go through the process of deploying the application in the three different environments, you will begin to see the purpose of the tasks.</p>

<p><a data-type="xref" href="#docker_commands_ch6">Table 6-2</a> has a summary<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Docker containers" data-tertiary="commands commonly used" id="id1402"/><a data-type="indexterm" data-primary="Docker container deployment" data-secondary="commands commonly used" id="id1403"/><a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Docker containers" data-tertiary="command cheatsheet online" id="id1404"/><a data-type="indexterm" data-primary="Docker container deployment" data-secondary="commands commonly used" data-tertiary="cheatsheet online" id="id1405"/><a data-type="indexterm" data-primary="resources online" data-secondary="Docker" data-tertiary="command cheatsheet" id="id1406"/> of Docker commands you will use in this chapter. A full list of commands is available on the <a href="https://oreil.ly/Prc1P">Docker cheat sheet</a>.<a data-type="indexterm" data-primary="docker commands" data-secondary="docker --version" id="id1407"/><a data-type="indexterm" data-primary="docker commands" data-secondary="docker build -t" id="id1408"/><a data-type="indexterm" data-primary="docker commands" data-secondary="docker images" id="id1409"/><a data-type="indexterm" data-primary="docker commands" data-secondary="docker run" id="id1410"/></p>
<table id="docker_commands_ch6">
<caption><span class="label">Table 6-2. </span>Docker commands</caption>
<thead>
<tr>
<th>Command</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><p><code>docker --version</code></p></td>
<td><p>Verify what version of the library is installed.</p></td>
</tr>
<tr>
<td><p><code>docker build -t</code></p></td>
<td><p>Build an image from a Dockerfile.</p></td>
</tr>
<tr>
<td><p><code>docker images</code></p></td>
<td><p>List local images in your environment.</p></td>
</tr>
<tr>
<td><p><code>docker run</code></p></td>
<td><p>Run a container from a local image.</p></td>
</tr>
</tbody>
</table>








<section data-type="sect2" class="less_space pagebreak-before" data-pdf-bookmark="Verifying Docker Installation"><div class="sect2" id="id183">
<h2>Verifying Docker Installation</h2>

<p>If you are using GitHub Codespaces,<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Docker containers" data-tertiary="installation" id="id1411"/><a data-type="indexterm" data-primary="Docker container deployment" data-secondary="installation" id="id1412"/><a data-type="indexterm" data-primary="resources online" data-secondary="Docker" data-tertiary="install files" id="id1413"/> Docker should come preloaded for you. Otherwise, follow the instructions on the <a href="https://oreil.ly/jUGKm">Get Docker page</a> to install the appropriate version for your development environment.</p>

<p>Verify that Docker is installed by executing the command <strong><code>docker --version</code></strong>, which should return the version and build number, such as the following:</p>

<pre data-type="programlisting" data-code-language="shell">$ docker --version
$ Docker version 24.0.9-1, build 1234</pre>

<p>You will perform a couple of fairly simple steps:</p>

<ul>
<li>
<p>Create a Dockerfile.</p>
</li>
<li>
<p>Build a container image from this Dockerfile.</p>
</li>
<li>
<p>Run a container based on this image.</p>
</li>
</ul>

<p>Let’s get started.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Creating a Dockerfile"><div class="sect2" id="id184">
<h2>Creating a Dockerfile</h2>

<p>A <em>Dockerfile</em> contains the instructions<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Docker containers" data-tertiary="Dockerfile created" id="id1414"/><a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Docker containers" data-tertiary="Dockerfile defined" id="id1415"/><a data-type="indexterm" data-primary="Docker container deployment" data-secondary="terms" data-tertiary="Dockerfile" id="id1416"/> that Docker will use to create a container image. Keep in mind that the statements will be executed in the <code>docker build</code> step that you will initiate. Create a file named <em>chapter6/Dockerfile</em>:</p>

<pre data-type="programlisting" data-code-language="shell">.../chapter6 (main) $ touch Dockerfile</pre>

<p>Update <em>chapter6/Dockerfile</em> with the following contents:</p>

<pre data-type="programlisting" data-code-language="docker"># Dockerfile for Chapter 6
# Start with the slim parent image
FROM python:3.10-slim <a class="co" id="co_deploying_your_api_to_the_cloud_CO1-1" href="#callout_deploying_your_api_to_the_cloud_CO1-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a>

# set the Docker working directory
WORKDIR /code <a class="co" id="co_deploying_your_api_to_the_cloud_CO1-2" href="#callout_deploying_your_api_to_the_cloud_CO1-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a>

# copy from the build context directory to the Docker working directory 
COPY requirements.txt /code/ <a class="co" id="co_deploying_your_api_to_the_cloud_CO1-3" href="#callout_deploying_your_api_to_the_cloud_CO1-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a>

# Install the Python libraries listed in the requirements file 
RUN pip3 install --no-cache-dir --upgrade -r requirements.txt <a class="co" id="co_deploying_your_api_to_the_cloud_CO1-4" href="#callout_deploying_your_api_to_the_cloud_CO1-4"><img src="assets/4.png" alt="4" width="12" height="12"/></a>

# Copy the code files and database from the build context directory
COPY *.py /code/ <a class="co" id="co_deploying_your_api_to_the_cloud_CO1-5" href="#callout_deploying_your_api_to_the_cloud_CO1-5"><img src="assets/5.png" alt="5" width="12" height="12"/></a>
COPY *.db /code/

# Launch the Uvicorn web server and run the application
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "80"] <a class="co" id="co_deploying_your_api_to_the_cloud_CO1-6" href="#callout_deploying_your_api_to_the_cloud_CO1-6"><img src="assets/6.png" alt="6" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_deploying_your_api_to_the_cloud_CO1-1" href="#co_deploying_your_api_to_the_cloud_CO1-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>This chooses the <em>parent image</em>, which is the official Python 3.10 slim Docker image in this case. This image already contains most of the items you will need to run your application. That allows you to focus on adding your code and any custom libraries.</p></dd>
<dt><a class="co" id="callout_deploying_your_api_to_the_cloud_CO1-2" href="#co_deploying_your_api_to_the_cloud_CO1-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>This statement sets a working directory inside the container image. This working directory is where the remaining commands will be executed unless otherwise specified.</p></dd>
<dt><a class="co" id="callout_deploying_your_api_to_the_cloud_CO1-3" href="#co_deploying_your_api_to_the_cloud_CO1-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>This copies the <em>requirements.txt</em> file from<a data-type="indexterm" data-primary="requirements.txt file for pip" data-secondary="Dockerfile created" id="id1417"/> <em>context</em>, which is a set of files in a location that you will specify when you execute the build statement. (Spoiler alert: in this chapter, you will be using the <em>chapter6</em> directory as the context, so the context includes all the files in this folder.)</p></dd>
<dt><a class="co" id="callout_deploying_your_api_to_the_cloud_CO1-4" href="#co_deploying_your_api_to_the_cloud_CO1-4"><img src="assets/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>This uses <code>pip</code> to install the<a data-type="indexterm" data-primary="pip3 package manager" data-secondary="Dockerfile created" id="id1418"/> specified libraries in your <em>requirements.txt</em> file into a new layer in the Docker image. A Docker container image is like a brand-new virtual server: you have complete control of the libraries and versions that are contained in it so that your application works correctly.</p></dd>
<dt><a class="co" id="callout_deploying_your_api_to_the_cloud_CO1-5" href="#co_deploying_your_api_to_the_cloud_CO1-5"><img src="assets/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>These two statements copy your Python program files and SQLite database from the context directory to your Docker working directory.</p></dd>
<dt><a class="co" id="callout_deploying_your_api_to_the_cloud_CO1-6" href="#co_deploying_your_api_to_the_cloud_CO1-6"><img src="assets/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>After steps 1 through 5 have built the container image, this step sets the default command that will be executed each time a container is launched from that image using the <code>docker run</code> command. As you did with the Render deployment, you are directly calling Uvicorn to run the API.</p></dd>
</dl>

<p>These are all the instructions you need to define your container image. The next step will be to build the container image in your local repository.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Creating a .dockerignore File"><div class="sect2" id="id185">
<h2>Creating a .dockerignore File</h2>

<p>Just like <em>.gitignore</em> excludes<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Docker containers" data-tertiary=".dockerignore file" data-tertiary-sortas="dockerignore file" id="id1419"/><a data-type="indexterm" data-primary="Docker container deployment" data-secondary=".dockerignore file" data-secondary-sortas="dockerignore file" id="id1420"/> files from version control, you want to exclude some files in your directory from the Docker image. Create a file named <em>.dockerignore</em> with the following contents:</p>

<pre data-type="programlisting"># This is the .dockerignore file for Chapter 6
.gitignore

README.md

*.DS_Store/

**/__pycache__</pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Building a Container Image"><div class="sect2" id="id186">
<h2>Building a Container Image</h2>

<p>To put this Dockerfile to use, enter the following command at the command line:<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Docker containers" data-tertiary="container image built" id="id1421"/><a data-type="indexterm" data-primary="Docker container deployment" data-secondary="container image built" id="id1422"/><a data-type="indexterm" data-primary="docker commands" data-secondary="docker build -t" id="id1423"/></p>

<pre data-type="programlisting" data-code-language="shell">.../chapter6 (main) $ docker build -t apicontainerimage .</pre>

<p>This tells Docker to build an image (<code>apicontainerimage</code>) using the Dockerfile in the current directory. The container image will be stored in your local Docker repository.</p>

<p>You should see multiple steps being executed. The first time you run this command, this may take several minutes. Future builds will take less time because Docker can cache items that do not change. You should see something similar to the following when it is completed:</p>

<pre data-type="programlisting" data-code-language="shell">[+] Building 12.2s (11/11) FINISHED
 =&gt; [internal] load build definition from Dockerfile
 =&gt; =&gt; transferring dockerfile: 670B
 =&gt; [internal] load .dockerignore
 =&gt; =&gt; transferring context: 92B
 =&gt; [internal] load metadata for docker.io/library/python:3.10-slim
 =&gt; [1/6] FROM docker.io/library/python:3.10-slim@sha256:xxxx
 =&gt; [internal] load build context
 =&gt; =&gt; transferring context: 217B
 =&gt; CACHED [2/6] WORKDIR /code
 =&gt; [3/6] COPY requirements.txt .
 =&gt; [4/6] RUN pip install --no-cache-dir --upgrade -r requirements.txt
 =&gt; [5/6] COPY *.py .
 =&gt; [6/6] COPY *.db .
 =&gt; exporting to image
 =&gt; =&gt; exporting layers
 =&gt; =&gt; writing image sha256:xxxx
 =&gt; =&gt; naming to docker.io/library/apicontainerimage</pre>

<p>To verify that the image was created successfully, <a data-type="indexterm" data-primary="docker commands" data-secondary="docker images" id="id1424"/>enter the command <strong><code>docker images</code></strong> to view the images in your repository. You should see something like the following:</p>

<pre data-type="programlisting" data-code-language="shell">.../chapter6 (main) $ docker images
REPOSITORY            TAG       IMAGE ID       CREATED          SIZE
apicontainerimage     latest    x9999        1 minute ago     159MB</pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Running Your Container Image Locally"><div class="sect2" id="id65">
<h2>Running Your Container Image Locally</h2>

<p>You use the <code>docker run</code> command<a data-type="indexterm" data-primary="docker commands" data-secondary="docker run" id="id1425"/><a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Docker containers" data-tertiary="container image run locally" id="id1426"/><a data-type="indexterm" data-primary="Docker container deployment" data-secondary="container image run locally" id="id1427"/> to run a container based on this image. There are just a couple of options to notice here. The statement <code>--publish 80:80</code> maps port 80 inside the Docker container (the second <code>80</code>) to port 80 on your local environment (the first <code>80</code>). The statement <code>--name apicontainer1</code> sets the name of the container that you will be using. This is a convenient way to reference the running container (Docker will also assign an image ID). Finally, <code>apicontainerimage</code> passes the image name that you built in the previous step. Remember, the image is used to run a <span class="keep-together">container.</span></p>

<p>Execute the following command:</p>

<pre data-type="programlisting" data-code-language="shell">.../chapter6 (main) $ docker run --publish 80:80 --name apicontainer1
apicontainerimage+</pre>

<p>You should see the following:</p>

<pre data-type="programlisting" data-code-language="shell">INFO:     Started server process [1]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:80 (Press CTRL+C to quit)</pre>

<p>You will see the message “Your application running on port 80 is available.” Select “Open in Browser” to run the API in the web browser. You should see the health check message in the window, exactly like when you ran the API from the command line.</p>

<p>Now if you go back to the terminal window, you will see a log message for the first request to the API:</p>

<pre data-type="programlisting" data-code-language="shell">INFO:     1.1.0.1:12345 - "GET / HTTP/1.1" 200 OK</pre>

<p>Congratulations! Your application is being run by Docker in a container that you defined. <a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Docker containers" data-tertiary="Ctrl-C to stop application" id="id1428"/><a data-type="indexterm" data-primary="Docker container deployment" data-secondary="container image run locally" data-tertiary="Ctrl-C to stop" id="id1429"/><a data-type="indexterm" data-primary="Ctrl-C" data-secondary="to stop Docker application" id="id1430"/>To stop the application, press Ctrl-C.<a data-type="indexterm" data-startref="ch6dock" id="id1431"/><a data-type="indexterm" data-startref="ch6dock2" id="id1432"/></p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Deploying to AWS"><div class="sect1" id="id66">
<h1>Deploying to AWS</h1>

<p>The AWS deployment will take<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="AWS deployment" id="ch6awsdp"/><a data-type="indexterm" data-primary="AWS deployment" id="ch6awsdp2"/><a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="AWS deployment" data-tertiary="about" id="id1433"/><a data-type="indexterm" data-primary="AWS deployment" data-secondary="about" id="id1434"/><a data-type="indexterm" data-primary="AWS deployment" data-secondary="Docker container used" id="id1435"/><a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="AWS deployment" data-tertiary="Docker container used" id="id1436"/> advantage of the Docker container that you created. You will run your application using the Amazon Lightsail service, which is one of the simpler AWS services to get started with.</p>

<p>To begin, <a href="https://oreil.ly/09mZ7">create a new AWS account</a> and<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="AWS deployment" data-tertiary="account creation" id="id1437"/><a data-type="indexterm" data-primary="AWS deployment" data-secondary="account creation" id="id1438"/> store your login credentials securely. For this project, it will be acceptable to use the <em>root user</em> account, which is the full owner of the account identified by the email address. However, you should enable multifactor authentication (MFA), following the directions <a href="https://oreil.ly/N5Q7e">in the AWS Identity and Access Management User Guide</a>.</p>

<p>If you continue using AWS, a best practice is to create a separate administration account and use it for normal work instead of the root user.</p>








<section data-type="sect2" data-pdf-bookmark="Creating a Lightsail Container Service"><div class="sect2" id="id187">
<h2>Creating a Lightsail Container Service</h2>

<p>When you have logged in to the AWS console,<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="AWS deployment" data-tertiary="Lightsail container service created" id="id1439"/><a data-type="indexterm" data-primary="AWS deployment" data-secondary="Lightsail container service created" id="id1440"/> select Lightsail from the search bar and then select Containers from the lefthand menu. You should see a page that looks like <a data-type="xref" href="#lightsail_home_ch4">Figure 6-7</a>. Click “Create container service.”</p>

<figure><div id="lightsail_home_ch4" class="figure">
<img src="assets/haad_0607.png" alt="Lightsail home page" width="1298" height="724"/>
<h6><span class="label">Figure 6-7. </span>Starter page for Lightsail</h6>
</div></figure>

<p>You will be asked to complete the information for your first Lightsail service:</p>

<ul>
<li>
<p><em>Region</em>: Select a region that is nearest to you for best performance.</p>
</li>
<li>
<p><em>Power</em>: Choose Nano or Micro.</p>
</li>
<li>
<p><em>Scale</em>: Choose 1.</p>
</li>
<li>
<p><em>Identify your service</em>: Choose a name for your container. This example uses <code>aws-api-container</code>.</p>
</li>
</ul>

<p>Click “Create container service”. It will take several minutes for the container to be created. When it finishes, you should see a status page like the one in <a data-type="xref" href="#completed_lightsail_status">Figure 6-8</a>.</p>

<figure><div id="completed_lightsail_status" class="figure">
<img src="assets/haad_0608.png" alt="Lightsail instance complete" width="723" height="127"/>
<h6><span class="label">Figure 6-8. </span>Lightsail container service creation completed</h6>
</div></figure>
</div></section>








<section data-type="sect2" class="less_space pagebreak-before" data-pdf-bookmark="Installing the AWS CLI"><div class="sect2" id="id188">
<h2>Installing the AWS CLI</h2>

<p>To interact with AWS, <a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="AWS deployment" data-tertiary="AWS CLI installation" id="id1441"/><a data-type="indexterm" data-primary="AWS deployment" data-secondary="AWS CLI installation" id="id1442"/><a data-type="indexterm" data-primary="AWS CLI" data-secondary="about" id="id1443"/><a data-type="indexterm" data-primary="AWS CLI" data-secondary="installing" id="id1444"/>you will use the AWS CLI. Follow the instructions from AWS to <a href="https://oreil.ly/r8tTp">install or update the latest version of the AWS CLI</a>.</p>

<p>Run the following command to verify the installation:</p>

<pre data-type="programlisting" data-code-language="shell">.../chapter6 (main) $ aws --version
aws-cli/2.15.8 Python/3.11.6 Linux/6.2.0-1018-azure exe/x86_64.ubuntu.20
prompt/off</pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Installing the Amazon Lightsail Container Services Plug-in"><div class="sect2" id="id189">
<h2>Installing the Amazon Lightsail Container Services Plug-in</h2>

<p>For Lightsail, an additional installation is required.<a data-type="indexterm" data-primary="AWS deployment" data-secondary="Lightsail container service created" data-tertiary="plugin installation instructions online" id="id1445"/><a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="AWS deployment" data-tertiary="Lightsail container service plugin instructions online" id="id1446"/><a data-type="indexterm" data-primary="resources online" data-secondary="AWS Lightsail container service plugin instructions" id="id1447"/> Follow the instructions on <a href="https://oreil.ly/xMzkI">installing the Amazon Lightsail container services plug-in</a>.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Configuring Your Login Credentials"><div class="sect2" id="id190">
<h2>Configuring Your Login Credentials</h2>

<p>To connect the AWS CLI to your<a data-type="indexterm" data-primary="AWS deployment" data-secondary="AWS CLI installation" data-tertiary="connecting AWS CLI to AWS account" id="id1448"/><a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="AWS deployment" data-tertiary="connecting AWS CLI to AWS account" id="id1449"/><a data-type="indexterm" data-primary="AWS CLI" data-secondary="connecting to AWS account" id="id1450"/> AWS account, you will need to configure your authentication and access credentials. There are multiple ways to do this, and it can take a bit of time to set up correctly. As mentioned multiple times in this chapter, you should be extremely careful in the handling of your credentials by cloud services. This includes taking care that they are never committed to a source code repository. Follow the instructions from <a href="https://oreil.ly/HAXYD">“Authentication and access credentials for the AWS CLI”</a> to configure your AWS CLI.</p>

<p>Once you have followed the instructions for configuring your credentials, verify them by entering this command:<a data-type="indexterm" data-primary="AWS deployment" data-secondary="AWS CLI installation" data-tertiary="credential verification" id="id1451"/><a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="AWS deployment" data-tertiary="credential verification" id="id1452"/></p>

<pre data-type="programlisting" data-code-language="shell">.../chapter6 (main) $ aws sts get-caller-identity</pre>

<p>You should receive a response in the following format:</p>

<pre data-type="programlisting" data-code-language="json">{
    "UserId": "99999",
    "Account": "999",
    "Arn": "arn:aws:iam::1234:user/username"
}</pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Pushing Your Container Image to Lightsail"><div class="sect2" id="id191">
<h2>Pushing Your Container Image to Lightsail</h2>

<p>Next, you will use the AWS CLI <a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="AWS deployment" data-tertiary="container image pushed to Lightsail" id="id1453"/><a data-type="indexterm" data-primary="AWS CLI" data-secondary="container image pushed to Lightsail" id="id1454"/><a data-type="indexterm" data-primary="AWS deployment" data-secondary="container image pushed to Lightsail" id="id1455"/>to push a container image to Lightsail. If you run into any issues during these instructions, additional information is available on the <a href="https://oreil.ly/lJ0wX">“Push, view, and delete container images for a Lightsail container service” page</a>.</p>

<p class="less_space pagebreak-before">To verify that your Docker images are still in your local repository where you built them in the previous sections of this chapter, enter the following:</p>

<pre data-type="programlisting" data-code-language="shell">.../chapter6 (main) $ docker images
REPOSITORY           TAG       IMAGE ID       CREATED        SIZE
apicontainerimage    latest    aa0366008bec   2 hours ago   159MB</pre>

<p>You will push an image from this local Docker repository to Lightsail. Take a moment to understand some of the values you will populate:</p>
<dl>
<dt><code>Region</code></dt>
<dd>
<p>This is the AWS region where you set up the Lightsail service.</p>
</dd>
<dt><code>ContainerServiceName</code></dt>
<dd>
<p>This should be <code>aws-api-container</code> if you set up the Lightsail service correctly in the previous steps.</p>
</dd>
<dt><code>LocalContainerImageName:ImageTag</code></dt>
<dd>
<p>This is the name and tag from your local repository. In the preceding example, the value would be <code>apicontainerimage:latest</code>.</p>
</dd>
</dl>

<p>Enter the following command in the terminal, replacing the values in brackets with your information:</p>
<pre data-type="programlisting" data-code-language="shell">lightsail push-container-image --region &lt;<em>Region</em>&gt;
--service-name &lt;<em>ContainerServiceName</em>&gt; --label aws-api --image
&lt;<em>LocalContainerImageName</em>&gt;:&lt;<em>ImageTag</em>&gt;
</pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>These commands may wrap in this book, but you will enter them on a single line in the terminal.</p>
</div>

<p>Here is an example of the command filled out completely:</p>

<pre data-type="programlisting" data-code-language="shell">.../chapter6 (main) $ aws lightsail push-container-image --region us-west-2
--service-name aws-api-container --label aws-api --image apicontainerimage:latest</pre>

<p class="less_space pagebreak-before">After a couple of minutes, you should see the following:</p>

<pre data-type="programlisting" data-code-language="shell">1234: Pushed
12345: Pushed
Digest: sha256:xxxxx
Image "apicontainerimage:latest" registered.
Refer to this image as ":aws-api-container.aws-api.1" in deployments.</pre>

<p>Go back to the Lightsail console login and view the Images tab on your <code>aws-api-container</code>. You should see something like  <a data-type="xref" href="#lightsail_stored_images_ch4">Figure 6-9</a>.</p>

<figure><div id="lightsail_stored_images_ch4" class="figure">
<img src="assets/haad_0609.png" alt="Lightsail stored images" width="1476" height="544"/>
<h6><span class="label">Figure 6-9. </span>Lightsail stored images page</h6>
</div></figure>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Creating a Lightsail Deployment"><div class="sect2" id="id67">
<h2>Creating a Lightsail Deployment</h2>

<p>On the Deployments tab of <a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="AWS deployment" data-tertiary="Lightsail deployment" id="ch6ltsld"/><a data-type="indexterm" data-primary="AWS deployment" data-secondary="Lightsail deployment" id="ch6ltsld2"/>the <code>aws-api-container</code> service, select “Create your first deployment.” Enter the following values, as shown in <a data-type="xref" href="#first_deployment_top">Figure 6-10</a>:</p>

<ul>
<li>
<p><em>Container name</em>: Choose a unique container name. This example uses <code>aws-api-container-1</code>.</p>
</li>
<li>
<p><em>Image</em>: Choose the stored image that was pushed in the previous steps.</p>
</li>
</ul>

<figure><div id="first_deployment_top" class="figure">
<img src="assets/haad_0610.png" alt="Lightsail top options" width="1310" height="1056"/>
<h6><span class="label">Figure 6-10. </span>Deployment options (top of page)</h6>
</div></figure>

<p>Click “+ Add open ports” and enter a value of 80 in the port. In the Public Endpoint section, click the drop-down box and select the container you created.</p>

<p>After these steps, the completed options should appear as shown in <a data-type="xref" href="#first_deployment_bottom">Figure 6-11</a>.</p>

<figure><div id="first_deployment_bottom" class="figure">
<img src="assets/haad_0611.png" alt="Lightsail top options" width="723" height="707"/>
<h6><span class="label">Figure 6-11. </span>Deployment options (bottom of page)</h6>
</div></figure>

<p>Click “Save and deploy.” Lightsail will begin deploying. After a few minutes, you should see a status of Active, as shown in <a data-type="xref" href="#lightsail_deploy_success">Figure 6-12</a>.</p>

<figure><div id="lightsail_deploy_success" class="figure">
<img src="assets/haad_0612.png" alt="Lightsail deployment success" width="721" height="603"/>
<h6><span class="label">Figure 6-12. </span>Lightsail deployment success</h6>
</div></figure>

<p>Your container will have a Status of Running, and a “Public domain” will be generated (not shown in <a data-type="xref" href="#lightsail_deploy_success">Figure 6-12</a>). This is the base URL for the API. To verify that your API is running, copy the value from the “Public domain” and paste it into a browser bar. <a data-type="indexterm" data-primary="health check" data-secondary="AWS deployment" id="id1456"/>You should see your API’s health check page. Congratulations, you’ve deployed your API using AWS Lightsail!<a data-type="indexterm" data-startref="ch6ltsld" id="id1457"/><a data-type="indexterm" data-startref="ch6ltsld2" id="id1458"/><a data-type="indexterm" data-startref="ch6awsdp" id="id1459"/><a data-type="indexterm" data-startref="ch6awsdp2" id="id1460"/></p>
</div></section>
</div></section>






<section data-type="sect1" class="less_space pagebreak-before" data-pdf-bookmark="Updating Your API Documentation"><div class="sect1" id="id192">
<h1>Updating Your API Documentation</h1>

<p>In <a data-type="xref" href="ch05.html#chapter_5">Chapter 5</a>, you created<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="README.md updated with API URL" id="id1461"/><a data-type="indexterm" data-primary="README.md file" data-secondary="updated with API URL" id="id1462"/><a data-type="indexterm" data-primary="URL of API" data-secondary="README.md updated with" id="id1463"/><a data-type="indexterm" data-primary="documentation" data-secondary="API documentation" data-tertiary="README.md updated" id="id1464"/><a data-type="indexterm" data-primary="SportsWorldCentral (SWC)" data-secondary="README.md updated" data-tertiary="API URL" id="id1465"/> the <em>README.md</em> file as API’s documentation, but you didn’t have an API address yet. Update the Public API Address section of the <em>README.md</em> file as follows, replacing <code>[<em>API URL</em>]</code> with your deployed application’s address, wherever you find it:</p>

<pre data-type="programlisting" data-code-language="markdown">## Public API

Our API is hosted at [API URL]/([API URL]/). 

You can access the interactive documentation at [[API URL]/docs]([API URL]/docs).

You can view the OpenAPI Specification (OAS) file at
[[API URL]/openapi.json]([API URL]/openapi.json).</pre>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1466">
<h1>Extending Your Portfolio Project</h1>
<p>Here are a few ways to use what you’ve learned in this chapter to extend your portfolio project:<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="Part I portfolio project extended" id="id1467"/><a data-type="indexterm" data-primary="portfolio projects" data-secondary="deployment project extended" id="id1468"/></p>

<ul>
<li>
<p>If you have been creating additional APIs in previous chapters, select one of the cloud hosts from this chapter and deploy those APIs.</p>
</li>
<li>
<p>Identify another cloud host from the <a href="https://oreil.ly/PsEGM">“Deploy FastAPI on Cloud Providers”</a> page, and deploy your API to one of them.<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="cloud host selection" data-tertiary="cloud providers listing online" id="id1469"/><a data-type="indexterm" data-primary="the cloud" data-secondary="host selection" data-tertiary="cloud providers listing online" data-primary-sortas="cloud" id="id1470"/><a data-type="indexterm" data-primary="resources online" data-secondary="cloud providers listing" id="id1471"/></p>
</li>
<li>
<p>After deploying your project to one of the cloud hosts, research and configure a deployment pipeline.<a data-type="indexterm" data-primary="deploying to the cloud" data-secondary="deployment pipeline" id="id1472"/> Each uses different techniques, but they generally involve creating tasks to redeploy your application each time a change is made to the source code repository.</p>
</li>
</ul>
</div></aside>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Additional Resources"><div class="sect1" id="id68">
<h1>Additional Resources</h1>

<p>The <a href="https://oreil.ly/6AyzJ">Docker website</a> provides a deep dive into the concepts around Docker containers.<a data-type="indexterm" data-primary="Docker container deployment" data-secondary="website for more information" id="id1473"/><a data-type="indexterm" data-primary="resources online" data-secondary="Docker" data-tertiary="website for more information" id="id1474"/></p>

<p>For best practices on containerizing Python, take a look at <a href="https://oreil.ly/1SYWr">“Best practices for containerizing Python applications with Docker” from Snyk.io</a>.<a data-type="indexterm" data-primary="Python" data-secondary="containerization best practices online" id="id1475"/><a data-type="indexterm" data-primary="containerization" data-secondary="Python app containerization article online" id="id1476"/><a data-type="indexterm" data-primary="resources online" data-secondary="Python" data-tertiary="containerization best practices" id="id1477"/><a data-type="indexterm" data-primary="“Best practices for containerizing Python applications with Docker” (Snyk.io)" data-primary-sortas="Best practices for containerizing" id="id1478"/><a data-type="indexterm" data-primary="Snyk.io article on Python containerization best practices" id="id1479"/></p>
</div></section>






<section data-type="sect1" class="less_space pagebreak-before" data-pdf-bookmark="Summary"><div class="sect1" id="id384">
<h1>Summary</h1>

<p>In this chapter, you learned the benefits and responsibilities of using cloud hosting platforms to deploy your API. You now have experience in deploying your application in several different ways:</p>

<ul>
<li>
<p>In a local development environment or GitHub Codespaces environment</p>
</li>
<li>
<p>In a Docker container in a local development environment or GitHub Codespaces environment</p>
</li>
<li>
<p>On the Render cloud host</p>
</li>
<li>
<p>On AWS using Amazon Lightsail and Docker</p>
</li>
</ul>

<p>In <a data-type="xref" href="ch07.html#chapter_7">Chapter 7</a>, you will create an SDK to make your API easier to use for Python developers.</p>
</div></section>
</div></section></div>
</div>
</body></html>
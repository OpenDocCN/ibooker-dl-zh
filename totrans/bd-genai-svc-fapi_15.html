<html><head></head><body><div id="book-content"><div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 11. Testing AI Services" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch11">
<h1><span class="label">Capitolo 11. </span>Testare i servizi di intelligenza artificiale</h1><div data-type="note"><p>Questo lavoro è stato tradotto utilizzando l'AI. Siamo lieti di ricevere il tuo feedback e i tuoi commenti: <a href="mailto:translation-feedback@oreilly.com">translation-feedback@oreilly.com</a></p></div>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1142">
<h1>Obiettivi del capitolo</h1>
<p><a data-primary="testing AI services" data-type="indexterm" id="ix_ch11-asciidoc0"/>In questo capitolo imparerai a conoscere:</p>
<ul>
<li>
<p>Come pianificare e strutturare le suite di test per ottenere una copertura di test completa, che includa test unitari, di integrazione, end-to-end e comportamentali.</p>
</li>
<li>
<p>I concetti di limiti del test, copertura del codice e idempotenza nella progettazione dei test.</p>
</li>
<li>
<p>Come identificare ed evitare le comuni insidie dei test per migliorarne la qualità</p>
</li>
<li>
<p>Come sfruttare le fixture di test e implementare la parametrizzazione per eseguire test con input multipli per verificare la robustezza del codice</p>
</li>
<li>
<p>Come configurare e smantellare in modo efficiente gli ambienti di test utilizzando <code translate="no">pytest</code></p>
</li>
<li>
<p>Come mantenere l'idempotenza nei processi di test gestendo correttamente i test asincroni a rischio di rottura</p>
</li>
<li>
<p>Come utilizzare il mocking e il patching per isolare i componenti dalle dipendenze esterne nei test unitari</p>
</li>
<li>
<p>Come testare i servizi GenAI che utilizzano modelli probabilistici utilizzando tecniche di test comportamentali e di autovalutazione</p>
</li>
<li>
<p>Come sfruttare diverse metriche di test per i servizi GenAI</p>
</li>
</ul>
</div></aside>
<p>In questo capitolo scoprirai l'importanza del testing e le sue sfide nella creazione di servizi GenAI, oltre a concetti chiave come i piani di test, i modelli di verifica e validazione, la piramide del testing e il ruolo dei dati, degli ambienti e dei confini del testing.</p>
<p>Per fare pratica con i test, utilizzerai <code translate="no">pytest</code>, un popolare framework di test con funzioni come le fixture di test, gli ambiti, i marcatori e la parametrizzazione delle fixture. Imparerai anche a conoscere il plug-in <code translate="no">pytest-mock</code> per il patching delle funzioni e a usare stub, mock e oggetti spia per simulare e controllare le dipendenze esterne durante i test.</p>
<p>Poiché il mocking può rendere i test più fragili, esploreremo anche la dependency injection, che ti permette di iniettare dipendenze mock o stub direttamente nei componenti da testare, evitando modifiche al codice in runtime.</p>
<p>Parleremo del ruolo dell'isolamento e dell'idempotenza nei test, di quando usare i mock e di come testare il codice GenAI sia deterministico che probabilistico. Alla fine di questo capitolo, sarai sicuro di poter scrivere suite di test complete che includono test unitari, di integrazione, end-to-end e comportamentali per i tuoi servizi.</p>
<p>Prima di tuffarci nella scrittura dei test, esploriamo i concetti fondamentali del testing del software tradizionale e come affrontare il testing dei servizi GenAI, che può rivelarsi impegnativo a causa della natura probabilistica dei modelli AI.</p>
<section data-pdf-bookmark="The Importance of Testing" data-type="sect1"><div class="sect1" id="id172">
<h1>L'importanza dei test</h1>
<p><a data-primary="testing AI services" data-secondary="importance of testing" data-type="indexterm" id="ix_ch11-asciidoc1"/>In teoria, tutti concordano sul fatto che i test sono necessari quando si realizza un software. Si scrivono test per avere fiducia nella funzionalità e nelle prestazioni dei sistemi, soprattutto quando interagiscono tra loro. Ma realisticamente, i progetti possono saltare l'implementazione di test manuali o automatizzati a causa di vari vincoli, tra cui il budget, il tempo o i costi di manodopera associati alla manutenzione dei test.</p>
<p class="fix_tracking">
I progetti che saltano i test, in parte o del tutto, finiscono per affrontare i problemi del software in modo reattivo invece che proattivo. In questo modo si accumula un <em>debito tecnico</em> che dovrai poi ripagare in costi di manodopera e di server, con gli interessi, per saldare.</p>
<p>Il problema di quando effettuare i test è difficile da risolvere. Se stai solo sperimentando e mettendo insieme un prototipo in rapide iterazioni, realisticamente non dovrai preoccuparti molto dei test. Tuttavia, non appena avrai un prodotto minimo vendibile, un sistema che si interfaccia con dati sensibili ed elabora i pagamenti degli utenti, dovrai prendere in seria considerazione i piani di test.</p>
<p>All'inizio della mia carriera, stavo costruendo un sistema di gestione dell'apprendimento per un cliente. Ho scritto un endpoint webhook per interfacciarmi con i sistemi di pagamento di Stripe e con la mia soluzione di autenticazione fatta in casa che registrava gli utenti solo al primo pagamento.
Il sistema doveva addebitare ed elaborare i pagamenti degli abbonamenti sia dei clienti nuovi che di quelli già esistenti e inviare email di conferma, tenendo traccia dei record degli utenti, degli abbonamenti, dei pagamenti, delle sessioni di checkout e delle fatture. La logica di questo webhook è risultata così contorta e complessa che ha portato a una mostruosità che è diventata una funzione di 1.000 righe. La funzione controllava eventi ricevuti non ordinati di vario tipo, con molteplici viaggi verso il database.</p>
<p>L'intera soluzione ha dovuto essere scartata alla fine, poiché il comportamento del webhook era così <em>incostante</em>, restituendo risposte non coerenti allo stesso insieme di input. Gli utenti non potevano registrarsi nemmeno dopo aver effettuato un pagamento con successo. Questa incostanza ha reso insopportabile il debug del webhook, costringendomi a riscrivere l'integrazione del sistema di pagamento da zero. Se solo avessi rallentato la pianificazione e modularizzato la logica e avessi scritto dei test in anticipo, avrei potuto risparmiarmi tanti grattacapi.</p>
<p>Quando rallenti per pianificare e testare i tuoi servizi, stai barattando tempo e fatica in cambio di fiducia nel tuo codice.</p>
<p>Altre occasioni in cui dovresti prendere in considerazione l'implementazione di test sono quando:</p>
<ul>
<li>
<p>Più collaboratori aggiungono modifiche nel tempo</p>
</li>
<li>
<p>I manutentori modificano le dipendenze esterne</p>
</li>
<li>
<p>Aumenta il numero di componenti e di dipendenze nei tuoi servizi</p>
</li>
<li>
<p>All'improvviso si nota la comparsa di troppi bug</p>
</li>
<li>
<p>La posta in gioco è troppo alta se le cose vanno male: la mia esperienza è rientrata in questa categoria.</p>
</li>
</ul>
<p>Ora dovresti capire in che modo i test possono essere utili al tuo progetto.<a data-startref="ix_ch11-asciidoc1" data-type="indexterm" id="id1143"/></p>
</div></section>
<section data-pdf-bookmark="Software Testing" data-type="sect1"><div class="sect1" id="id173">
<h1>Test del software</h1>
<p><a data-primary="software testing" data-type="indexterm" id="ix_ch11-asciidoc2"/><a data-primary="testing AI services" data-secondary="software testing" data-type="indexterm" id="ix_ch11-asciidoc3"/>Ora che conosci le sfide e i potenziali approcci per testare i servizi GenAI, rivediamo i concetti di testing del software per capire la loro rilevanza per i casi d'uso GenAI e le insidie comuni da evitare.</p>
<section data-pdf-bookmark="Types of Tests" data-type="sect2"><div class="sect2" id="id174">
<h2>Tipi di test</h2>
<p><a data-primary="software testing" data-secondary="types of tests" data-type="indexterm" id="ix_ch11-asciidoc4"/><a data-primary="testing AI services" data-secondary="software testing" data-tertiary="types of tests" data-type="indexterm" id="ix_ch11-asciidoc5"/>Esistono tre tipi di test comuni nel testing del software che, in ordine crescente di dimensione e complessità, sono i seguenti:</p>
<dl>
<dt>Test unitari</dt>
<dd>
<p><a data-primary="unit tests" data-secondary="overview" data-type="indexterm" id="id1144"/>Si concentrano sul test di singoli componenti o funzioni in modo isolato su un insieme discreto di input e casi limite per convalidare la funzionalità a livello di singolo componente. I test unitari sono atomici e hanno un ambito di applicazione minimo e spesso non si basano su sistemi o dipendenze esterne.</p>
</dd>
<dt>Test di integrazione</dt>
<dd>
<p><a data-primary="integration tests" data-secondary="overview" data-type="indexterm" id="id1145"/>I test di integrazione spesso rilevano i problemi di comportamento dell'applicazione a livello di sottosistema, convalidando i flussi di dati e i contratti di interfaccia (cioè le specifiche) tra i vari componenti.</p>
</dd>
<dt>Test end-to-end (E2E)</dt>
<dd>
<p><a data-primary="end-to-end testing" data-secondary="overview" data-type="indexterm" id="id1146"/>Verifica le funzionalità dell'applicazione al massimo livello del sistema, dall'inizio alla fine, simulando scenari d'uso reali. I test E2E offrono i massimi livelli di fiducia nelle funzionalità e nelle prestazioni dell'applicazione, ma sono i più impegnativi da progettare, sviluppare e mantenere.</p>
</dd>
</dl>
<div data-type="tip"><h6>Suggerimento</h6>
<p>I test E2E e i test di integrazione hanno delle somiglianze che li rendono difficili da distinguere l'uno dall'altro. Se un test è grande e a volte difettoso, è possibile che tu stia lavorando a un test E2E.</p>
<p>I test di integrazione normalmente controllano un sottoinsieme di sistemi e interazioni, non l'intero sistema o una lunga catena di sottosistemi.</p>
</div>
<p>La<a data-type="xref" href="#test_types">Figura 11-1</a> mostra l'ambito di ciascun tipo di test. I test unitari mostrati a sinistra si concentrano su componenti isolati, mentre i test di integrazione verificano le interazioni a coppie di più componenti, anche con servizi esterni. Infine, i test E2E coprono l'intero percorso dell'utente e il flusso di dati all'interno dell'applicazione per confermare la funzionalità prevista.</p>
<figure><div class="figure" id="test_types">
<img alt="bgai 1101" src="assets/bgai_1101.png" width="1357" height="927"/>
<h6><span class="label">Figura 11-1. </span>Tipi di test nel testing del software</h6>
</div></figure>
<p>Prima di implementare i test sopra citati, puoi anche utilizzare <em>controlli statici del codice</em> con strumenti come <code translate="no">mypy</code> per individuare gli errori di sintassi e di tipo. Durante la scrittura del codice, i controlli statici possono anche aiutarti a individuare le violazioni dello stile del codice, l'uso improprio di funzioni e<span class="keep-together">dipendenze, le</span> vulnerabilità di sicurezza, il codice morto o inutilizzato, i problemi di flusso dei dati e i potenziali bug nei componenti del sistema.</p>
<p>Man mano che passi dai controlli statici e dai test unitari all'integrazione e poi ai test E2E, i tuoi casi di test diventano più preziosi ma anche più complessi, costosi e lenti.<a data-primary="end-to-end testing" data-secondary="drawbacks" data-type="indexterm" id="id1147"/>Inoltre, dato che i test E2E hanno un campo d'azione più ampio con l'interazione di più componenti, diventeranno più fragili e suscettibili di fallire, richiedendo aggiornamenti frequenti per rimanere allineati con le modifiche del codice.</p>
<p>Anche i test E2E sono complessi e poco affidabili/nondeterministici. Secondo Martin Fowler,<sup><a data-type="noteref" href="ch11.html#id1148" id="id1148-marker" translate="no">1</a></sup> queste sono le ragioni principali del non determinismo:</p>
<ul>
<li>
<p>La<em>mancanza di isolamento</em> fa sì che i componenti interferiscano tra loro, portando a risultati imprevedibili.</p>
</li>
<li>
<p>Un<em>comportamento asincrono</em> con operazioni che avvengono fuori sequenza o in momenti imprevedibili può portare a risultati non deterministici.</p>
</li>
<li>
<p><em>I servizi remoti</em> possono introdurre una variabilità dovuta alla latenza della rete, alla disponibilità del servizio o a risposte diverse.</p>
</li>
<li>
<p>Le<em>perdite di risorse</em>, se non gestite correttamente, possono portare a un comportamento incoerente del sistema. Le risorse interessate includono la memoria, i file handle o le connessioni a database, client, ecc.</p>
</li>
</ul>
<p>Infine, a causa della fragilità dei test E2E, i refactoring e le modifiche alle funzionalità possono farli fallire. Pertanto, esiste un compromesso tra il livello di fiducia che ottieni dai test E2E e la flessibilità di apportare modifiche ai tuoi sistemi.<a data-startref="ix_ch11-asciidoc5" data-type="indexterm" id="id1149"/><a data-startref="ix_ch11-asciidoc4" data-type="indexterm" id="id1150"/></p>
</div></section>
<section data-pdf-bookmark="The Biggest Challenge in Testing Software" data-type="sect2"><div class="sect2" id="id258">
<h2>La sfida più grande nel testare il software</h2>
<p><a data-primary="software testing" data-secondary="biggest challenges" data-type="indexterm" id="id1151"/><a data-primary="testing AI services" data-secondary="software testing" data-tertiary="biggest challenges" data-type="indexterm" id="id1152"/>La sfida più grande nel testare i servizi consiste nell'identificare cosa testare e con quali dettagli. A tal fine, devi decidere cosa prendere in giro, fingere o mantenere reale, oltre a configurare una serie di strumenti e ambienti di test.</p>
<p>Per superare questa sfida, puoi pianificare i test in anticipo, identificando i punti di rottura del sistema e restringendo i problemi ai singoli componenti e alle interazioni. Poi, immagina chi è l'utente ed elenca i passi che compie quando interagisce con i sistemi problematici. Infine, puoi tradurre questi elenchi di passi in test individuali e automatizzarli.</p>
<p>Un'altra sfida con i test che causa molta frustrazione è quella di dover riscrivere i test ogni volta che viene modificato il codice da testare.</p>
<p>Poiché i refactoring del codice non cambiano il comportamento funzionale ma i dettagli dell'implementazione, possono essere un segno che non stai testando le cose giuste. Ad esempio, se stai testando la logica interna di elaborazione delle stringhe della funzione <code translate="no">count_tokens(text)</code> piuttosto che solo il suo output finale (cioè il conteggio dei token), l'utilizzo di una libreria esterna per sostituire la logica di manipolazione delle stringhe può far fallire i tuoi test.</p>
<p>Un segno rivelatore del fatto che potresti testare i dettagli dell'implementazione è quando i tuoi test falliscono quando modifichi il codice (ad esempio, falsi positivi), oppure passano anche quando introduci modifiche radicali al codice (ad esempio, falsi negativi). Puoi usare tecniche come i <em>test black-box</em> per testare il tuo sistema fornendo degli input e osservando gli output, senza considerare i dettagli dell'implementazione.</p>
<p>Se pianifichi i tuoi test in anticipo, puoi evitare queste difficoltà.</p>
</div></section>
<section data-pdf-bookmark="Planning Tests" data-type="sect2"><div class="sect2" id="id175">
<h2>Test di pianificazione</h2>
<p><a data-primary="software testing" data-secondary="planning tests" data-type="indexterm" id="ix_ch11-asciidoc6"/><a data-primary="testing AI services" data-secondary="software testing" data-tertiary="planning tests" data-type="indexterm" id="ix_ch11-asciidoc7"/>Per identificare i test necessari durante la pianificazione, <a data-primary="verification and validation (V&amp;V) process" data-type="indexterm" id="id1153"/>puoi utilizzare il processo di <em>verifica e validazione</em> (V&amp;V).</p>
<p>Seguendo questo processo, prima si conferma il possesso dei requisiti giusti (validazione) e poi si ricorre a test per verificare che tutti i requisiti siano soddisfatti (verifica).</p>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>Una copertura del codice del 100% con test superati completerà solo il processo di verifica, non la validazione. Devi comunque assicurarti che i tuoi servizi implementino le funzioni giuste (cioè la validazione).</p>
</div>
<p>Il processo di V&amp;V può essere visualizzato come un modello a forma di V come nella <a data-type="xref" href="#vv">Figura 11-2</a>.</p>
<p>Quando si scende lungo il modello a V, si definiscono i requisiti del software e si progetta la soluzione prima di implementarla sotto forma di codice. In seguito, si risale la "V" eseguendo test progressivi (unità, integrazione, E2E, ecc.) per convalidare che la soluzione soddisfi le esigenze aziendali.</p>
<figure><div class="figure" id="vv">
<img alt="bgai 1102" src="assets/bgai_1102.png" width="998" height="669"/>
<h6><span class="label">Figura 11-2. </span>Modello di verifica e validazione</h6>
</div></figure>
<p>Come già detto in precedenza, i test di validazione possono essere difficili da identificare. Esattamente quali test progressivi dovresti implementare?</p>
<p>Quando hai difficoltà a individuare cosa testare, puoi scrivere dei test basati sui problemi e sui bug che trovi nell'applicazione. Questo approccio è <em>reattivo</em>, in quanto scrivi i test solo quando si presentano i problemi, il che può aiutarti a superare la difficoltà di non sapere cosa testare. Tuttavia, i test per risolvere i problemi più avanti nel <em>ciclo di vita dello sviluppo del software</em> (SDLC) richiedono un impegno significativo, in quanto avrai a che fare con un sistema più complesso con molte parti mobili da testare.</p>
<p><a data-primary="shift-left testing" data-type="indexterm" id="ix_ch11-asciidoc8"/>Per questo motivo, movimenti come lo <em>shift-left testing</em> sostengono l'adozione di pratiche di testing <em>preventive</em>, pianificate in anticipo e scritte durante lo sviluppo, per ridurre l'impegno di testing. La<a data-type="xref" href="#shift_left">Figura 11-3</a> dimostra come lo spostamento delle attività di testing all'inizio dello SLDC possa ridurre l'onere complessivo.</p>
<figure><div class="figure" id="shift_left">
<img alt="bgai 1103" src="assets/bgai_1103.png" width="1078" height="551"/>
<h6><span class="label">Figura 11-3. </span>Test del software con il cambio a sinistra</h6>
</div></figure>
<p><a data-primary="Test-Driven Development (TDD)" data-type="indexterm" id="id1154"/><a data-primary="TDD (Test-Driven Development)" data-type="indexterm" id="id1155"/>Un approccio comune nei test shift-left è il <em>test-driven development</em> (TDD), come mostrato nella <a data-type="xref" href="#tdd">Figura 11-4</a>.</p>
<figure><div class="figure" id="tdd">
<img alt="bgai 1104" src="assets/bgai_1104.png" width="711" height="694"/>
<h6><span class="label">Figura 11-4. </span>TDD</h6>
</div></figure>
<p>Nell'approccio TDD, scrivi i test prima del codice vero e proprio. Si tratta di un processo iterativo in cui i test scritti falliranno all'inizio, ma il tuo obiettivo sarà quello di scrivere la quantità minima di codice per far sì che i test passino. Una volta passati, rifattorizzerai il codice per ottimizzare il sistema, mantenendo i test passati per concludere il processo TDD iterativo.</p>
<div data-type="tip"><h6>Suggerimento</h6>
<p><a data-primary="prompt engineering" data-secondary="TDD in" data-type="indexterm" id="id1156"/>Un ottimo esempio di come le pratiche TDD siano utili per testare i servizi GenAI è durante l'<em>ingegnerizzazione del prompt</em>. Scrivi prima una serie di test e poi continua a iterare sul design del prompt finché tutti i test non passano.</p>
<p>Utilizzando gli stessi casi di test, puoi verificare eventuali segni di regressione e se il cambio di modello riduce le prestazioni dei tuoi servizi.</p>
</div>
<p>Come puoi vedere, l'obiettivo generale del TDD è quello di ridurre gli sforzi di testing migliorando la qualità del codice, la progettazione della soluzione e l'individuazione precoce dei problemi<a data-startref="ix_ch11-asciidoc8" data-type="indexterm" id="id1157"/>.<a data-startref="ix_ch11-asciidoc7" data-type="indexterm" id="id1158"/><a data-startref="ix_ch11-asciidoc6" data-type="indexterm" id="id1159"/></p>
</div></section>
<section data-pdf-bookmark="Test Dimensions" data-type="sect2"><div class="sect2" id="id259">
<h2>Dimensioni del test</h2>
<p><a data-primary="software testing" data-secondary="test dimensions" data-type="indexterm" id="id1160"/><a data-primary="testing AI services" data-secondary="software testing" data-tertiary="test dimensions" data-type="indexterm" id="id1161"/>Inoltre, durante la pianificazione, devi decidere le varie dimensioni dei test, tra cui l'<em>ambito</em>, la <em>copertura</em> e la <em>completezza</em>:</p>
<dl>
<dt>Ambito di applicazione</dt>
<dd>
<p>Definisce quali sono i componenti, i sistemi e gli scenari d'uso da testare. Come parte della definizione dell'ambito, dovrai anche tracciare i <em>confini del test</em> per chiarire cosa sarà testato e cosa no.</p>
</dd>
<dt>Copertura o superficie di prova</dt>
<dd>
<p>Misura la quantità di sistema o di codice da testare.</p>
</dd>
<dt>Completezza</dt>
<dd>
<p>Indica quanto dettagliati, approfonditi e completi saranno i tuoi test all'interno dell'ambito e della copertura definiti. Ad esempio, dovrai decidere se testare ogni potenziale utilizzo, gli scenari di successo e di fallimento e i casi limite per ogni componente, sistema e interazione.</p>
</dd>
</dl>
<p>Il <em>volume/spazio</em> definisce i confini e le dimensioni di ciò che viene testato; la superficie misura la diffusione dei test; la profondità implica il dettaglio, la profondità e la completezza dei casi di test.</p>
</div></section>
<section data-pdf-bookmark="Test Data" data-type="sect2"><div class="sect2" id="id260">
<h2>Dati del test</h2>
<p><a data-primary="software testing" data-secondary="test data" data-type="indexterm" id="id1162"/><a data-primary="testing AI services" data-secondary="software testing" data-tertiary="test data" data-type="indexterm" id="id1163"/>Per ottenere una maggiore copertura e completezza dei test, puoi sfruttare quattro diversi tipi di dati di test:</p>
<dl>
<dt>Dati validi</dt>
<dd>
<p>Gli ingressi al sistema rientrano nell'intervallo valido e previsto in condizioni normali<span class="keep-together">.</span></p>
</dd>
<dt>Dati non validi</dt>
<dd>
<p>Input inaspettati, sbagliati, NULL o al di fuori dell'intervallo valido. Puoi utilizzare i dati negativi per verificare il comportamento del sistema quando vengono utilizzati in modo improprio.</p>
</dd>
<dt>Dati di confine</dt>
<dd>
<p>I dati del test si trovano ai limiti degli intervalli di ingresso accettabili, sia al limite superiore che a quello inferiore.</p>
</dd>
<dt>Dati enormi</dt>
<dd>
<p>Utilizzato per le prestazioni e per lo stress test del sistema per misurarne i limiti.</p>
</dd>
</dl>
</div></section>
<section data-pdf-bookmark="Test Phases" data-type="sect2"><div class="sect2" id="id176">
<h2>Fasi del test</h2>
<p><a data-primary="given-when-then (GWT) model" data-type="indexterm" id="id1164"/><a data-primary="GWT (given-when-then) model" data-type="indexterm" id="id1165"/><a data-primary="software testing" data-secondary="test phases" data-type="indexterm" id="id1166"/><a data-primary="testing AI services" data-secondary="software testing" data-tertiary="test phases" data-type="indexterm" id="id1167"/>Non importa se stai implementando un test unitario, di integrazione o E2E, puoi strutturare i test in diverse fasi distinte utilizzando il modello <em>dato-quando-allora</em> (GWT), come illustrato qui:</p>
<ol>
<li>
<p><em>Dati (precondizioni)</em>: Prima di ogni test, puoi impostare le condizioni di test e gli stati o i dati predefiniti (ad esempio, le <em>fixture</em>).</p>
</li>
<li>
<p><em>Quando (fasi del test)</em>: durante il test, eseguirai una serie di azioni che vorrai testare. È qui che passerai le tue fixture di test al <em>sistema sotto test</em> (SUT) che, a seconda dell'ambito del test, può essere una singola funzione o l'intero<span class="keep-together">servizio</span>.</p>
</li>
<li>
<p><em>Poi (risultati attesi)</em>: dopo aver eseguito la SUT con le fixture, in questa fase verificherai i risultati rispetto alle tue aspettative utilizzando una serie di asserzioni.</p>
</li>
<li>
<p><em>Pulizia</em>: Una volta terminato, puoi ripulire gli artefatti del test in una fase opzionale di<em>pulizia/strappo</em>.</p>
</li>
</ol>
<p><a data-primary="arrange-act-assert-cleanup testing model" data-type="indexterm" id="id1168"/><a data-primary="pytest" data-secondary="arrange-act-assert-cleanup testing model" data-type="indexterm" id="id1169"/><code translate="no">pytest</code> raccomanda di strutturare i test utilizzando il modello <em>arrange-act-assert-cleanup</em>, che corrisponde direttamente al modello GWT con una fase di pulizia opzionale.</p>
</div></section>
<section data-pdf-bookmark="Test Environments" data-type="sect2"><div class="sect2" id="id177">
<h2>Ambienti di prova</h2>
<p><a data-primary="software testing" data-secondary="test environments" data-type="indexterm" id="id1170"/><a data-primary="testing AI services" data-secondary="software testing" data-tertiary="test environments" data-type="indexterm" id="id1171"/>Quando pianifichi i test, devi anche considerare diversi <em>ambienti di test</em> che coprono il tempo di compilazione, il tempo di compilazione e gli ambienti di runtime.</p>
<p><a data-primary="compile time" data-type="indexterm" id="id1172"/>In molti linguaggi di programmazione, il <em>momento della compilazione</em> è quello in cui il codice sorgente viene tradotto in codice eseguibile. Ad esempio, se stai scrivendo del codice in C++, il processo di compilazione prevede un controllo completo dei tipi di codice. Se vengono riscontrati errori di tipo, il processo di compilazione fallisce. Una volta che tutti i controlli sono stati superati, il compilatore C++ traduce il codice in un file binario eseguibile.</p>
<div data-type="note" epub:type="note"><h6>Nota</h6>
<p>La tipizzazione forte in C++ è stata progettata per migliorare il rilevamento degli errori, la robustezza del codice e il supporto degli strumenti per gli sviluppatori in codebase più grandi e complesse che cambiano frequentemente.</p>
</div>
<p>Essendo un linguaggio interpretato, Python non ha un tempo di compilazione tradizionale come il C++, ma converte il codice in bytecode per l'esecuzione.</p>
<p>Durante le ispezioni, i controllori statici del codice come <code translate="no">mypy</code> possono identificare i problemi di base del tuo codice, fungendo da livello di verifica iniziale per i tuoi sforzi di testing.</p>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>Poiché Python è un linguaggio tipizzato dinamicamente, non applica la tipizzazione per impostazione predefinita. Tuttavia, i controllori statici di tipo come <code translate="no">mypy</code> possono fornire un valore significativo se utilizzi i suggerimenti di tipo nel tuo codice Python.</p>
</div>
<p>Mentre i controlli statici sono ottimi per individuare i problemi di base del codice in fase di compilazione, i test unitari, di integrazione e E2E possono verificare la funzionalità del sistema in fase <em>di esecuzione</em> quando si esegue il codice dell'applicazione. In fase di runtime, strumenti come Pydantic possono eseguire controlli di convalida dei dati per individuare strutture di dati inaspettate.</p>
<p>I tuoi servizi GenAI possono anche richiedere ulteriori fasi di configurazione e compilazione, come il download dei pesi e il precaricamento dei modelli, prima di eseguire il codice dell'applicazione. L'ambiente in cui vengono completate le fasi di compilazione, la configurazione e l'installazione delle dipendenze viene definito <em>tempo di compilazione</em>, che puoi anche testare.</p>
</div></section>
<section data-pdf-bookmark="Testing Strategies" data-type="sect2"><div class="sect2" id="id178">
<h2>Strategie di test</h2>
<p><a data-primary="software testing" data-secondary="testing strategies" data-type="indexterm" id="ix_ch11-asciidoc9"/><a data-primary="testing AI services" data-secondary="software testing" data-tertiary="testing strategies" data-type="indexterm" id="ix_ch11-asciidoc10"/>Nel panorama del software, diversi esperti hanno sviluppato strategie per bilanciare la distribuzione dei test nei progetti, che si basano su anni di esperienza di testing del software da parte degli sviluppatori che le hanno rese popolari.</p>
<p><a data-primary="testing pyramid" data-type="indexterm" id="id1173"/>La strategia più adottata è la <em>piramide dei test</em>, come mostrato nella<a data-type="xref" href="#testing_pyramid">Figura 11-5</a>, che promuove la scrittura di più test unitari.</p>
<figure><div class="figure" id="testing_pyramid">
<img alt="bgai 1105" src="assets/bgai_1105.png" width="715" height="412"/>
<h6><span class="label">Figura 11-5. </span>Piramide dei test</h6>
</div></figure>
<p>La<a data-type="xref" href="#testing_pyramid_example">Tabella 11-1</a> illustra lo scopo di ogni livello della piramide di test con un esempio concreto nel contesto di un servizio GenAI.</p>
<table class="striped" id="testing_pyramid_example">
<caption><span class="label">Tabella 11-1. </span>Test della piramide nel mondo reale</caption>
<thead>
<tr>
<th>Strato</th>
<th>Scopo</th>
<th>Esempio</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>Test end-to-end</p></td>
<td><p>Convalida l'intero flusso dell'applicazione dall'inizio alla fine</p></td>
<td><p>Testare il login dell'utente, generare testo in base a un prompt e salvare il contenuto generato</p></td>
</tr>
<tr>
<td><p>Test di integrazione</p></td>
<td><p>Verifica che i vari moduli o servizi funzionino correttamente insieme</p></td>
<td><p>Testare le interazioni tra l'API di generazione del testo e il database che memorizza i prompt dell'utente e i testi generati</p></td>
</tr>
<tr>
<td><p>Test unitari</p></td>
<td><p>Verifica singoli componenti o funzioni in modo isolato</p></td>
<td><p>Testare varie funzioni di utilità che elaborano gli input del modello, ad esempio per rimuovere i contenuti inappropriati.</p></td>
</tr>
</tbody>
</table>
<p>Il problema del modello piramidale è che mentre i test unitari migliorano la copertura del codice, non necessariamente migliorano la "copertura del business", poiché i requisiti del progetto e i casi d'uso potrebbero non essere testati a fondo. Di conseguenza, affidarsi solo ai test unitari può creare un falso senso di sicurezza, trascurando potenzialmente di testare la logica di business essenziale e i flussi di lavoro degli utenti. D'altra parte, i test di integrazione ti permettono di coprire più terreno e i test orientati al business.</p>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>Gli esperti di testing del software hanno anche identificato alcune strategie come <em>anti-pattern</em> che sono controproducenti.</p>
<p>Se li segui, spenderai una quantità eccessiva di tempo per configurare i test, implementerai test troppo specifici e strettamente accoppiati e finirai per avere test che presentano un comportamento non deterministico a scatti.</p>
</div>
<p><a data-primary="software testing" data-secondary="anti-patterns" data-type="indexterm" id="id1174"/>La<a data-type="xref" href="#testing_antipatterns">Tabella 11-2</a> e la <a data-type="xref" href="#testing_antipatterns_viz">Figura 11-6</a> mostrano un elenco di anti-pattern per il testing del software.</p>
<table class="striped" id="testing_antipatterns">
<caption><span class="label">Tabella 11-2. </span>Antipattern per il testing del software</caption>
<thead>
<tr>
<th>Strategia</th>
<th>Distribuzione del test</th>
<th>Commenti</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>Prova del cono gelato</p></td>
<td><p>Un piccolo numero di test unitari con un gran numero di test di integrazione e E2E, seguiti da test manuali.</p></td>
<td><p>Evitare. Considerato un anti-pattern a causa dell'inefficienza dell'implementazione dei test manuali e degli alti costi di mantenimento dei test di integrazione e E2E.</p></td>
</tr>
<tr>
<td><p>Test del cupcake</p></td>
<td><p>Simile al cono gelato; ha un piccolo numero di test di unità e integrazione automatizzati, un numero moderato di test E2E/GUI automatizzati e un gran numero di test manuali.</p><p>Ogni tipo di test viene eseguito da un team diverso.</p></td>
<td><p>Evitare. Considerato un anti-pattern perché può portare a cicli di feedback lenti, a spese di comunicazione tra i team e a test fragili con alti costi di manutenzione.</p></td>
</tr>
<tr>
<td><p>Test della clessidra</p></td>
<td><p>Un gran numero di test unitari alla base e di test E2E in alto, ma un numero significativamente inferiore di test di integrazione al centro.</p></td>
<td><p>Evita. Considerato un anti-pattern. Non è così grave come il cono gelato, ma comporta comunque un numero eccessivo di fallimenti di test che i test di media portata avrebbero potuto coprire.</p></td>
</tr>
</tbody>
</table>
<figure><div class="figure" id="testing_antipatterns_viz">
<img alt="bgai 1106" src="assets/bgai_1106.png" width="1423" height="558"/>
<h6><span class="label">Figura 11-6. </span>Visualizzazione degli anti-pattern di testing</h6>
</div></figure>
<p>La<a data-type="xref" href="#testing_strategies">Tabella 11-3</a> e la <a data-type="xref" href="#testing_strategies_viz">Figura 11-7</a> mettono a confronto le strategie di testing del software.</p>
<table class="striped" id="testing_strategies">
<caption><span class="label">Tabella 11-3. </span>Confronto tra le strategie di test</caption>
<thead>
<tr>
<th>Strategia</th>
<th>Distribuzione del test</th>
<th>Commenti</th>
</tr>
</thead>
<tbody>
<tr>
<td><p><strong>Piramide di test</strong></p><p>(Mike Cohn)</p></td>
<td><p>Un gran numero di test unitari alla base, meno test di integrazione al centro e ancora meno test E2E in cima.</p></td>
<td><p>Tuttavia, la piramide può essere percepita come un concetto fisico per promuovere la costruzione del livello inferiore di test unitari, per poi costruire il livello successivo e così via, fino a raggiungere la cima. Questo approccio è inefficace se applicato ad applicazioni legacy con un'ampia base di codice.</p></td>
</tr>
<tr>
<td><p><strong>Trofeo di prova</strong></p><p>(Kent C. Dodds)</p></td>
<td><p>Si concentra su una solida base di controlli statici, poi test unitari, seguiti da test di integrazione e da un numero minore di test E2E in cima.</p></td>
<td><p>La motivazione è che i test E2E e di integrazione sono i più validi. Tuttavia, i test E2E sono lenti e costosi. I test di integrazione rappresentano un equilibrio tra i due mondi.</p></td>
</tr>
<tr>
<td><p><strong>Prova il nido d'ape</strong></p><p>(Stephen H. Fishman)</p></td>
<td><p>Rappresenta un approccio equilibrato con uguale enfasi su unità, integrazione, E2E e altri tipi di test (prestazioni, sicurezza, ecc.).</p></td>
<td><p>Può essere meno efficiente se non viene gestita correttamente e può non essere ottimale per ogni progetto.</p></td>
</tr>
</tbody>
</table>
<figure><div class="figure" id="testing_strategies_viz">
<img alt="bgai 1107" src="assets/bgai_1107.png" width="1446" height="559"/>
<h6><span class="label">Figura 11-7. </span>Visualizzazione delle strategie di test</h6>
</div></figure>
<p>Per i servizi GenAI, che spesso comportano integrazioni complesse e considerazioni sulle prestazioni, la strategia di testing trofeo potrebbe essere la più adatta. La strategia trofeo consiste in una solida base di controlli statici, alimentati da strumenti come <code translate="no">mypy</code> e Pydantic, affiancati da test di integrazione che raggiungono un equilibrio tra valore, fiducia e costi di testing.</p>
<p>Se i tuoi servizi GenAI devono essere testati in modo completo con diversi tipi di test, compresi quelli di performance e quelli esplorativi, allora il modello a nido d'ape potrebbe essere più adatto al tuo progetto, in quanto può uniformare gli sforzi di test.</p>
<p>Ora dovresti sentirti più a tuo agio nell'identificare gli esami di cui hai bisogno e nel pianificare i tuoi test<a data-startref="ix_ch11-asciidoc10" data-type="indexterm" id="id1175"/><a data-startref="ix_ch11-asciidoc9" data-type="indexterm" id="id1176"/>.<a data-startref="ix_ch11-asciidoc3" data-type="indexterm" id="id1177"/><a data-startref="ix_ch11-asciidoc2" data-type="indexterm" id="id1178"/></p>
<p>Ora che conosci i concetti di testing del software, esaminiamo le sfide e i potenziali approcci al testing dei servizi GenAI.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="Challenges of Testing GenAI Services" data-type="sect1"><div class="sect1" id="id261">
<h1>Le sfide del test dei servizi GenAI</h1>
<p><a data-primary="testing AI services" data-secondary="challenges of testing GenAI services" data-type="indexterm" id="ix_ch11-asciidoc11"/>Se hai deciso di testare i tuoi servizi GenAI, dovrai affrontare diverse sfide. Il test dei servizi che sfruttano modelli GenAI probabilistici richiede un approccio più completo rispetto al software tradizionale.</p>
<p>Vediamo alcuni motivi per cui testare i servizi GenAI sarà una sfida.</p>
<section data-pdf-bookmark="Variability of Outputs (Flakiness)" data-type="sect2"><div class="sect2" id="id273">
<h2>Variabilità dei risultati (flaccidezza)</h2>
<p><a data-primary="testing AI services" data-secondary="challenges of testing GenAI services" data-tertiary="variability of outputs (flakiness)" data-type="indexterm" id="id1179"/>A parità di input e di codice di implementazione, i servizi GenAI spesso producono output diversi. Gli output variano perché questi modelli utilizzano tecniche probabilistiche come il campionamento da una distribuzione piuttosto che affidarsi a funzioni deterministiche. Naturalmente, la variabilità che si riscontra negli output può dipendere dal modello e la regolazione delle configurazioni, come i valori di temperatura, può ridurre questa<span class="keep-together">varianza</span>.</p>
<p>La variabilità degli output dei modelli GenAI può anche far esplodere il numero di potenziali casi di test che puoi scrivere (cioè l'<em>area/ambito di applicazione dei test</em>) per coprire tutte le possibilità. Per questo motivo, non puoi affidarti completamente a test deterministici: i tuoi test funzioneranno in modo incoerente e saranno troppo <em>deboli</em> per essere eseguiti in modo affidabile in una pipeline CI/CD.</p>
<p>Dovresti invece affrontare il problema dei test GenAI da una prospettiva statistica e probabilistica: prendi diversi campioni basati su ipotesi valide da una <em>distribuzione legittima di input</em> per verificare la qualità dei prodotti in uscita dal tuo modello.</p>
<div data-type="note" epub:type="note"><h6>Nota</h6>
<p>Per <em>distribuzione legittima degli input</em>, intendo la selezione di input che siano in linea con lo scopo del modello, rappresentativi di scenari reali e rilevanti per il problema che stai cercando di risolvere con il modello.</p>
</div>
<p>Un approccio più complesso consiste nell'utilizzare modelli di discriminazione per attribuire un punteggio ai risultati variabili del tuo servizio, a patto che tu stabilisca delle aspettative di una certa tolleranza o soglia.</p>
<p>Vedrai degli esempi di come farlo più avanti nel capitolo.</p>
</div></section>
<section data-pdf-bookmark="Performance and Resource Constraints (Slow and Expensive)" data-type="sect2"><div class="sect2" id="id274">
<h2>Vincoli di prestazioni e risorse (lento e costoso)</h2>
<p><a data-primary="testing AI services" data-secondary="challenges of testing GenAI services" data-tertiary="performance/resource constraints (slow and expensive)" data-type="indexterm" id="id1180"/>Poiché il test dei servizi GenAI richiede un approccio più statistico e/o multimodello, dovrai affrontare anche problemi di latenza, utilizzo e hosting.</p>
<p>I tuoi test non possono essere eseguiti in modo sufficientemente veloce e affidabile per essere eseguiti continuamente all'interno di una pipeline CI/CD tradizionale. Finirai per avere costi eccessivi per l'utilizzo dei token con chiamate multiple alle API dei modelli e test multimodello complessi e lenti. Queste sfide rimangono a meno che tu non faccia diverse ipotesi per semplificare l'ambito dei test, ridurre la frequenza dei test dei modelli e utilizzare tecniche di test efficienti come il mocking e il patching, l'iniezione di dipendenza e i test statistici di ipotesi. Puoi anche studiare l'uso di piccoli modelli discriminatori sintonizzati per ridurre la latenza e migliorare le prestazioni.</p>
</div></section>
<section data-pdf-bookmark="Regression" data-type="sect2"><div class="sect2" id="id179">
<h2>Regressione</h2>
<p><a data-primary="regression testing" data-type="indexterm" id="ix_ch11-asciidoc12"/><a data-primary="testing AI services" data-secondary="challenges of testing GenAI services" data-tertiary="regression" data-type="indexterm" id="ix_ch11-asciidoc13"/><em>I test di regressione</em> sono un altro tipo di test da pianificare quando si lavora con i<span class="keep-together">modelli</span> GenAI<span class="keep-together">.</span></p>
<p>Una <a href="https://oreil.ly/1oLQG">ricerca pubblicata nel 2023</a> che ha confrontato il comportamento di ChatGPT nel tempo ha rilevato che:</p>
<blockquote>
<p>Le prestazioni e il comportamento di GPT-3.5 e GPT-4 possono variare notevolmente nel tempo. Ad esempio, GPT-4 (marzo 2023) è stato ragionevole nell'identificare i numeri primi rispetto ai numeri composti (84% di accuratezza), ma GPT-4 (giugno 2023) è stato scarso in queste stesse domande (51% di accuratezza). GPT-4 è diventato meno disposto a rispondere alle domande sensibili e alle domande del sondaggio d'opinione a giugno rispetto a marzo. Inoltre, sia GPT-4 che GPT-3.5 hanno avuto più errori di formattazione nella generazione del codice a giugno rispetto a marzo.</p></blockquote>
<p>Secondo questo studio, il comportamento dello "stesso" servizio LLM può cambiare in modo sostanziale in un lasso di tempo relativamente breve, evidenziando la necessità di un monitoraggio continuo di LLMs (e di qualsiasi servizio GenAI). Sulla base di questa scoperta, puoi supporre che le prestazioni dei tuoi servizi GenAI possano peggiorare nel tempo a causa della messa a punto o della riqualificazione del modello, dei cambiamenti nei modelli di interazione dell'utente e dei cambiamenti nei dati di formazione o nell'ambiente operativo.</p>
<p><a data-primary="model drift" data-type="indexterm" id="id1181"/>Per approfondire, i modelli di intelligenza artificiale probabilistici possono subire una <em>deriva del modello</em>, ovvero una riduzione delle prestazioni nel tempo attribuibile ai dati di addestramento sottostanti. La messa a punto su dati aggiuntivi può avere effetti collaterali inaspettati sul comportamento del modello in altri compiti.</p>
<p>Con il passare del tempo, i dati di addestramento originali possono allontanarsi dalla realtà: le tendenze cambiano, si verificano nuovi eventi storici, le lingue si evolvono e la conoscenza umana si espande o muta assumendo nuove forme che non possono essere colte se i dati di addestramento non vengono continuamente aggiornati.<a data-primary="concept drift" data-type="indexterm" id="id1182"/>Questo fenomeno che causa la deriva del modello viene definito <em>deriva concettuale</em>, che si verifica quando le proprietà statistiche della variabile target che il modello sta cercando di prevedere cambiano nel tempo. La deriva concettuale può portare a un peggioramento delle prestazioni del modello perché le relazioni e i modelli appresi durante l'addestramento non sono più validi.</p>
<p><a data-primary="data drift" data-type="indexterm" id="id1183"/>Inoltre, anche la <em>deriva dei dati</em>, che comporta cambiamenti nella distribuzione delle caratteristiche di input all'interno dei dati di formazione, può portare alla deriva del modello.</p>
<p>Questo tipo di deriva è spesso dovuta a cambiamenti nei metodi di campionamento, nella distribuzione della popolazione e nella raccolta dei dati, a cambiamenti stagionali ed effetti temporali nei dati, a cambiamenti esterni nelle fonti di dati o a problemi di qualità nelle pipeline di elaborazione.</p>
<p>I test di regressione e il monitoraggio (in particolare se ti affidi a fornitori di modelli esterni come OpenAI) possono aiutarti a individuare i problemi di deriva del modello sulle tue attività e sui tuoi casi d'uso specifici. Qualsiasi potenziale deriva può essere affrontata a livello di applicazione tramite la convalida dei dati o l'utilizzo di tecniche come il RAG o a livello di modello tramite la riqualificazione e la messa a punto del modello per ridurre i problemi di regressione.<a data-startref="ix_ch11-asciidoc13" data-type="indexterm" id="id1184"/><a data-startref="ix_ch11-asciidoc12" data-type="indexterm" id="id1185"/></p>
</div></section>
<section data-pdf-bookmark="Bias" data-type="sect2"><div class="sect2" id="id180">
<h2>Pregiudizio</h2>
<p><a data-primary="bias, testing for" data-type="indexterm" id="id1186"/><a data-primary="testing AI services" data-secondary="challenges of testing GenAI services" data-tertiary="bias" data-type="indexterm" id="id1187"/>Un'altra grande sfida nel testare i servizi GenAI è quella di rilevare le distorsioni dei modelli prima di metterli in produzione. Spesso le distorsioni vengono analizzate durante il processo di esplorazione dei dati da parte dei data scientist e degli ingegneri ML responsabili della produzione dei modelli. Tuttavia, con i modelli GenAI di ampia portata, c'è sempre la possibilità che venga introdotta una qualche forma di distorsione a causa di una valutazione errata, dei metodi di campionamento, dell'elaborazione dei dati, degli algoritmi di formazione o di distorsioni nascoste nei dati stessi.</p>
<p>Ad esempio, se un modello linguistico viene addestrato su un set di dati che contiene per lo più testi relativi a un gruppo demografico specifico, potrebbe generare risultati orientati verso quel gruppo demografico, escludendo potenzialmente altri gruppi. Allo stesso modo, se un modello di riconoscimento delle immagini viene addestrato per lo più su immagini di uomini che svolgono professioni come medici e ingegneri, potrebbe imparare a generare immagini con un pregiudizio di genere.</p>
<p>Il pregiudizio diventa particolarmente grave negli scenari in cui si desidera utilizzare gli LLMs come giudici, ad esempio come strumenti di valutazione dell'intelligenza artificiale o valutatori di colloqui.</p>
<p>I pregiudizi possono manifestarsi in varie forme, come pregiudizi di genere, pregiudizi razziali, pregiudizi di età e così via, e ogni tipo di pregiudizio richiede test e metriche specifiche per essere rilevato. Senza sapere per cosa fare i test, non puoi verificare con sicurezza se i tuoi servizi GenAI sono al 100% privi di pregiudizi.</p>
<p>Una possibile soluzione a questo problema è quella di sfruttare gli autocontrolli dei modelli e i discriminatori dell'intelligenza artificiale, dove un modello secondario identifica o misura la presenza di eventuali pregiudizi. Spesso c'è un compromesso tra latenza e quote di utilizzo quando si rilevano i pregiudizi durante il runtime del servizio.</p>
</div></section>
<section data-pdf-bookmark="Adversarial Attacks" data-type="sect2"><div class="sect2" id="id181">
<h2>Attacchi avversari</h2>
<p><a data-primary="adversarial testing" data-type="indexterm" id="id1188"/><a data-primary="securing AI services" data-secondary="adversarial tests" data-type="indexterm" id="id1189"/><a data-primary="testing AI services" data-secondary="challenges of testing GenAI services" data-tertiary="adversarial attacks" data-type="indexterm" id="id1190"/>I servizi GenAI rivolti al pubblico possono essere vulnerabili ad attacchi avversari come la manipolazione dei token, la gestione insicura dei dati, la richiesta di jailbreak o l'iniezione di prompt, la divulgazione di informazioni sensibili, l'avvelenamento dei dati, il furto di modelli, il denial of service, l'eccessiva agenzia e in generale l'uso improprio e l'abuso. Per questo motivo, qualsiasi servizio GenAI esposto a Internet dovrà includere livelli di protezione.</p>
<p>Risorse e liste di controllo come la <a href="https://genai.owasp.org">top 10 di OWASP per le applicazioni LLM</a> forniscono un punto di partenza per aggiungere protezioni ai tuoi<span class="keep-together">servizi</span> GenAI<span class="keep-together">.</span></p>
<p class="less_space pagebreak-before">Tuttavia, la creazione di meccanismi di salvaguardia può essere impegnativa perché i metodi attuali, al momento in cui scriviamo, si basano su modelli di classificazione e discriminazione per rilevare gli attacchi avversari e i contenuti dannosi. Questi modelli di salvaguardia spesso richiedono centinaia di megabyte di dipendenze, il che può appesantire l'applicazione, rallentare significativamente il throughput del servizio e non riuscire a individuare ogni potenziale scenario di attacco.</p>
<p>I test avversari assicurano che le misure di salvaguardia adottate siano sufficienti a proteggere i tuoi servizi e la tua reputazione. Nell'ambito dei test avversari, dovresti anche verificare le prestazioni delle tue protezioni di autenticazione e autorizzazione.</p>
<p><a data-type="xref" href="ch09.html#ch09">Il Capitolo 9</a> approfondisce l'implementazione di questi livelli di protezione e le tecniche di valutazione per proteggere i tuoi modelli da questi attacchi.</p>
</div></section>
<section data-pdf-bookmark="Unbound Testing Coverage" data-type="sect2"><div class="sect2" id="id182">
<h2>Copertura dei test non vincolati</h2>
<p><a data-primary="testing AI services" data-secondary="challenges of testing GenAI services" data-tertiary="unbound testing coverage" data-type="indexterm" id="id1191"/>Lo spazio latente dei modelli GenAI è così vasto che non si può fare affidamento sui test unitari per ottenere una copertura del 100% di ogni scenario di utilizzo.</p>
<p>Poiché esiste un numero infinito di input e risposte, per quanto tu possa testare i tuoi modelli, ci saranno casi limite nascosti che sfuggiranno ai tuoi test. Per questo motivo, invece di affidarti alla predefinizione di ogni scenario, puoi implementare i <em>test comportamentali</em>, che si concentrano sulle proprietà delle risposte invece che sugli output esatti.</p>
<p>Esempi di proprietà comportamentali che puoi misurare sono la <em>coerenza</em> delle strutture di dati generate, la <em>rilevanza</em> degli output rispetto agli input, la <em>tossicità</em>, la <em>correttezza</em> e la <em>fedeltà</em> (cioè la fedele aderenza alle tue politiche e linee guida etiche). Puoi anche aggiungere un umano nel ciclo come ulteriore livello di test per individuare le risposte inaspettate.</p>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>Se stai realizzando un'applicazione RAG o agenziale con più modelli e dipendenze esterne, i test comportamentali diventano ancora più pratici. Testare un insieme fisso di esempi può far perdere casi limite, interazioni inaspettate tra i componenti e variabilità delle risposte dovute a fattori esterni.</p>
</div>
<p>Nella prossima sezione imparerai a implementare i tuoi test unitari, di integrazione, E2E e comportamentali seguendo un progetto pratico.<a data-startref="ix_ch11-asciidoc11" data-type="indexterm" id="id1192"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Project: Implementing Tests for a RAG System" data-type="sect1"><div class="sect1" id="id262">
<h1>Progetto: Implementazione di test per un sistema RAG</h1>
<p><a data-primary="RAG (retrieval augmented generation) module" data-secondary="test implementation project" data-type="indexterm" id="ix_ch11-asciidoc14"/><a data-primary="testing AI services" data-secondary="project: implementing tests for a RAG system" data-type="indexterm" id="ix_ch11-asciidoc15"/>Nel progetto pratico, scriverai una suite di test per il modulo RAG che hai implementato nel <a data-type="xref" href="ch05.html#ch05">Capitolo 5</a>. Il sistema RAG che dovrai testare si interfaccia con un LLM, un database vettoriale e il filesystem del server tramite metodi asincroni, quindi rappresenta un'opportunità perfetta per comprendere i principi di test discussi finora.</p>
<p>Seguendo gli esempi di codice, imparerai le migliori pratiche per implementare i test di unità, integrazione e E2E per i tuoi servizi GenAI, nonché le loro<span class="keep-together">differenze.</span></p>
<section data-pdf-bookmark="Unit Tests" data-type="sect2"><div class="sect2" id="id183">
<h2>Test unitari</h2>
<p><a data-primary="testing AI services" data-secondary="project: implementing tests for a RAG system" data-tertiary="unit tests" data-type="indexterm" id="ix_ch11-asciidoc16"/><a data-primary="unit tests" data-type="indexterm" id="ix_ch11-asciidoc17"/>Puoi iniziare a testare i tuoi servizi GenAI con i test unitari. Lo scopo di un test unitario è quello di verificare che una parte isolata del tuo codice, di solito una singola funzione o metodo, funzioni come previsto.</p>
<p>Prima di scrivere i test, è importante pianificare i casi di test da implementare. Per un tipico sistema RAG, puoi scrivere test unitari sulle pipeline di caricamento, trasformazione, recupero e generazione dei dati.</p>
<p>La<a data-type="xref" href="#unit_boundaries">Figura 11-8</a> visualizza i confini di questi potenziali test unitari su un diagramma di pipeline di dati.</p>
<figure><div class="figure" id="unit_boundaries">
<img alt="bgai 1108" src="assets/bgai_1108.png" width="1387" height="355"/>
<h6><span class="label">Figura 11-8. </span>Confini dei test unitari visualizzati sul diagramma della pipeline di dati RAG</h6>
</div></figure>
<p>Si noti che i confini del test terminano all'inizio e alla fine di ogni funzione della pipeline di elaborazione dati, perché lo scopo di questi test unitari è quello di testare solo il codice della pipeline di elaborazione dati e non il database, il filesystem, il modello LLM o le interfacce associate.</p>
<p>In questi test unitari, supporrai che questi sistemi esterni restituiscano ciò che ti aspetti e concentrerai i tuoi test unitari solo su ciò che farà il tuo codice di elaborazione dei dati.</p>
<p>Per brevità, non testeremo tutti i componenti del sistema, ma seguendo una manciata di esempi, dovresti sentirti a tuo agio nell'implementare test successivi per ottenere una copertura completa.</p>
<section data-pdf-bookmark="Installing and configuring pytest" data-type="sect3"><div class="sect3" id="id184">
<h3>Installare e configurare pytest</h3>
<p><a data-primary="pytest" data-secondary="installing/configuring" data-type="indexterm" id="ix_ch11-asciidoc18"/><a data-primary="RAG (retrieval augmented generation) module" data-secondary="unit tests" data-tertiary="installing/configuring pytest" data-type="indexterm" id="ix_ch11-asciidoc19"/><a data-primary="unit tests" data-secondary="installing/configuring pytest" data-type="indexterm" id="ix_ch11-asciidoc20"/>Per questo progetto utilizzerai il pacchetto <code translate="no">pytest</code>, che ha componenti integrati per la gestione di test fixture, parametri, codice asincrono, collezioni di test e un ricco ecosistema di plug-in.<code translate="no">pytest</code> è più potente, flessibile ed estensibile rispetto a<span class="keep-together"><code translate="no">unittest</code>, il pacchetto di test integrato di Python spesso utilizzato per semplici scenari di test.</span> </p>
<p>Puoi installare <code translate="no">pytest</code> utilizzando i seguenti metodi:</p>
<pre data-type="programlisting" translate="no">$ pip install pytest</pre>
<p>Successivamente, crea una cartella <code translate="no">tests</code> nella radice del tuo progetto dove potrai creare moduli Python seguendo lo schema <em>test_xxx.py</em>.</p>
<p><code translate="no">pytest</code>Il raccoglitore di test può quindi attraversare la cartella <code translate="no">tests</code> e trovare tutti i moduli, le classi e le funzioni di test in essa contenuti:</p>
<pre data-code-language="text" data-type="programlisting" translate="no">project
|-- main.py
...
|-- tests
    |-- test_rag_loader.py
    |-- test_rag_transform.py
    |-- test_rag_retrieval.py
...</pre>
<p>All'interno di ogni file di test, puoi aggiungere le tue funzioni di test che contengono sempre almeno un'istruzione <code translate="no">assert</code>. Se non viene sollevata alcuna eccezione in queste istruzioni <code translate="no">assert</code>, i tuoi test otterranno <code translate="no">PASSED</code>. Altrimenti, <code translate="no">pytest</code> li contrassegnerà come <code translate="no">FAILED</code> insieme a un motivo/traccia del perché le istruzioni <code translate="no">assert</code> sono fallite:</p>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># tests/rag/transform.py</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">test_chunk_text</code><code class="p" translate="no">():</code>
    <code class="n" translate="no">text</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"Testing GenAI services"</code>
    <code class="n" translate="no">results</code> <code class="o" translate="no">=</code> <code class="n" translate="no">chunk</code><code class="p" translate="no">(</code><code class="n" translate="no">text</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">assert</code> <code class="nb" translate="no">len</code><code class="p" translate="no">(</code><code class="n" translate="no">results</code><code class="p" translate="no">)</code> <code class="o" translate="no">=</code> <code class="mi" translate="no">2</code></pre>
<p>Supponiamo che tu abbia scritto due funzioni di test in ogni modulo di test:</p>
<p>Puoi quindi eseguire i tuoi test tramite il comando <code translate="no">pytest &lt;test_dirt_path&gt;</code>.</p>
<pre data-type="programlisting" translate="no">$ pytest tests
=========================== test session starts ============================
platform linux -- Python 3.11, pytest-8.0.0

Collected 6 items

tests/rag/loader.py ..                                                 [100%]
tests/rag/transform.py F.                                              [100%]
tests/rag/retrieval.py ..                                              [100%]

================================= FAILURES =================================
______________________________ test_chunk_text _____________________________

def test_chunk_text():
&gt;     assert len(results) == 2
E       assert 3 == 2

tests/rag/transform.py:6: AssertionError
========================= short test summary info ==========================
PASSED 5
FAILED tests/rag/transform.py::test_chunk_text - assert 3 == 2
============================ 1 failed in 0.12s =============================</pre>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>Evita di scrivere test di grandi dimensioni, perché diventano sempre più difficili da capire e da implementare correttamente.</p>
</div>
<p>Quando si scrivono i test unitari, ci si preoccupa solo di un componente isolato del sistema, come ad esempio una singola funzione del codice, mentre gli altri componenti non rientrano nel campo di applicazione dei test unitari. Pertanto, si verificherà solo se un singolo componente si comporta come ci si aspetta, dato un insieme di dati di test come input.</p>
<p><a data-primary="chunking" data-type="indexterm" id="id1193"/>Ad esempio, puoi verificare se la tua funzione di chunking sta dividendo un documento in pezzi come ti aspetteresti. Forse vuoi sperimentare strategie di chunking diverse o complesse per la tua pipeline RAG e vuoi assicurarti che il testo in ingresso sia suddiviso correttamente. I test unitari con dati di test predefiniti o <em>fixture</em> possono darti fiducia nella tua funzione di chunking.</p>
<p>L<a data-type="xref" href="#unit_test">'esempio 11-1</a> mostra un esempio di test unitario per la tua funzione di chunking.</p>
<div data-type="example" id="unit_test">
<h5><span class="label">Esempio 11-1. </span>Esempio di test unitario per una funzione di token chunking</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># rag/transform.py</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">chunk</code><code class="p" translate="no">(</code><code class="n" translate="no">tokens</code><code class="p" translate="no">:</code> <code class="nb" translate="no">list</code><code class="p" translate="no">[</code><code class="nb" translate="no">int</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="n" translate="no">chunk_size</code><code class="p" translate="no">:</code> <code class="nb" translate="no">int</code><code class="p" translate="no">)</code> <code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code> <code class="nb" translate="no">list</code><code class="p" translate="no">[</code><code class="nb" translate="no">list</code><code class="p" translate="no">[</code><code class="nb" translate="no">int</code><code class="p" translate="no">]</code><code class="p" translate="no">]</code><code class="p" translate="no">:</code> <a class="co" href="#callout_testing_ai_services_CO1-1" id="co_testing_ai_services_CO1-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
    <code class="k" translate="no">if</code> <code class="n" translate="no">chunk_size</code> <code class="o" translate="no">&lt;</code><code class="o" translate="no">=</code> <code class="mi" translate="no">0</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">raise</code> <code class="ne" translate="no">ValueError</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Chunk size must be greater than 0</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">return</code> <code class="p" translate="no">[</code><code class="n" translate="no">tokens</code><code class="p" translate="no">[</code><code class="n" translate="no">i</code><code class="p" translate="no">:</code><code class="n" translate="no">i</code> <code class="o" translate="no">+</code> <code class="n" translate="no">chunk_size</code><code class="p" translate="no">]</code> <code class="k" translate="no">for</code> <code class="n" translate="no">i</code> <code class="ow" translate="no">in</code> <code class="nb" translate="no">range</code><code class="p" translate="no">(</code><code class="mi" translate="no">0</code><code class="p" translate="no">,</code> <code class="nb" translate="no">len</code><code class="p" translate="no">(</code><code class="n" translate="no">tokens</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code> <code class="n" translate="no">chunk_size</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code>


<code class="c1" translate="no"># tests/rag/transform.py</code>

<code class="kn" translate="no">import</code> <code class="nn" translate="no">pytest</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">rag</code><code class="nn" translate="no">.</code><code class="nn" translate="no">transform</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">chunk</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">test_chunking_success</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="c1" translate="no"># GIVEN </code><a class="co" href="#callout_testing_ai_services_CO1-2" id="co_testing_ai_services_CO1-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
    <code class="n" translate="no">tokens</code> <code class="o" translate="no">=</code> <code class="p" translate="no">[</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="mi" translate="no">2</code><code class="p" translate="no">,</code> <code class="mi" translate="no">3</code><code class="p" translate="no">,</code> <code class="mi" translate="no">4</code><code class="p" translate="no">,</code> <code class="mi" translate="no">5</code><code class="p" translate="no">]</code>
    <code class="c1" translate="no"># WHEN </code><a class="co" href="#callout_testing_ai_services_CO1-3" id="co_testing_ai_services_CO1-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a>
    <code class="n" translate="no">result</code> <code class="o" translate="no">=</code> <code class="n" translate="no">chunk</code><code class="p" translate="no">(</code><code class="n" translate="no">token_list</code><code class="p" translate="no">,</code> <code class="n" translate="no">chunk_size</code><code class="o" translate="no">=</code><code class="mi" translate="no">2</code><code class="p" translate="no">)</code>
    <code class="c1" translate="no"># THEN </code><a class="co" href="#callout_testing_ai_services_CO1-4" id="co_testing_ai_services_CO1-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a>
    <code class="k" translate="no">assert</code> <code class="n" translate="no">result</code> <code class="o" translate="no">=</code> <code class="p" translate="no">[</code><code class="p" translate="no">[</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="mi" translate="no">2</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="mi" translate="no">3</code><code class="p" translate="no">,</code> <code class="mi" translate="no">4</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="mi" translate="no">5</code><code class="p" translate="no">]</code><code class="p" translate="no">]</code>
    <code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code> <code class="c1" translate="no"># Other relevant asserts here</code></pre>
<dl class="calloutlist pagebreak-before less_space">
<dt><a class="co" href="#co_testing_ai_services_CO1-1" id="callout_testing_ai_services_CO1-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Suddivide un elenco di token interi in elenchi più piccoli di un determinato <code translate="no">chunk_size</code>.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO1-2" id="callout_testing_ai_services_CO1-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Specifica i dati del test nella parte <em>GIVEN (precondizioni)</em> del test.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO1-3" id="callout_testing_ai_services_CO1-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Esegui le fasi di test nella parte <em>WHEN</em> del test che includono il passaggio dei dati di test al sistema in esame.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO1-4" id="callout_testing_ai_services_CO1-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Controlla i risultati rispetto alle uscite previste nella parte <em>THEN</em> del test.<a data-startref="ix_ch11-asciidoc20" data-type="indexterm" id="id1194"/><a data-startref="ix_ch11-asciidoc19" data-type="indexterm" id="id1195"/><a data-startref="ix_ch11-asciidoc18" data-type="indexterm" id="id1196"/></p></dd>
</dl></div>
</div></section>
<section data-pdf-bookmark="Fixtures and scope" data-type="sect3"><div class="sect3" id="id185">
<h3>Attrezzature e ambito di applicazione</h3>
<p><a data-primary="RAG (retrieval augmented generation) module" data-secondary="unit tests" data-tertiary="fixtures and scope" data-type="indexterm" id="ix_ch11-asciidoc21"/><a data-primary="unit tests" data-secondary="fixtures and scope" data-type="indexterm" id="ix_ch11-asciidoc22"/>I dati di input di <a data-primary="fixtures (input data)" data-type="indexterm" id="id1197"/>che hai definito nell'<a data-type="xref" href="#unit_test">Esempio 11-1</a> per i test sono chiamati anche <em>fixture</em>, poiché il loro valore rimane fisso per ogni esecuzione del test. Esistono due tipi di fixture:</p>
<dl>
<dt>Apparecchio fresco</dt>
<dd>
<p>La definisci all'interno di ogni test, che poi Python raccoglie (cioè scarta) dopo il test. L'<a data-type="xref" href="#unit_test">esempio 11-1</a> utilizza una fixture fresca.</p>
</dd>
<dt>Apparecchio condiviso</dt>
<dd>
<p>Puoi riutilizzarlo in più test per evitare di ripetere sempre la stessa fixture per ogni nuovo test.</p>
</dd>
</dl>
<p class="fix_tracking">
Puoi dichiarare una fixture condivisa al di fuori delle funzioni di test come variabile globale del modulo di test, ma è considerato un anti-pattern, in quanto potresti modificarla inavvertitamente.</p>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>Le fixture condivise devono essere <em>immutabili</em>, altrimenti un test può cambiare la fixture, creando un effetto collaterale che si ripercuote sugli altri test. Una delle principali cause di test difettosi sono le fixture mutabili.</p>
</div>
<p><a data-primary="fixture functions" data-type="indexterm" id="id1198"/>Invece di essere responsabile della gestione dello stato delle fixture condivise, puoi affidarti al sistema di iniezione delle dipendenze di <code translate="no">pytest</code>attraverso l'uso di <em>funzioni di fixture</em>, come mostrato nell'<a data-type="xref" href="#fixture_function">Esempio 11-2</a>.</p>
<div data-type="example" id="fixture_function">
<h5><span class="label">Esempio 11-2. </span><code translate="no">pytest</code> funzione di fissaggio</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># tests/rag/transform.py</code>

<code class="kn" translate="no">import</code> <code class="nn" translate="no">pytest</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">rag</code><code class="nn" translate="no">.</code><code class="nn" translate="no">transform</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">chunk</code>

<code class="c1" translate="no"># GIVEN</code>
<code class="nd" translate="no">@pytest</code><code class="o" translate="no">.</code><code class="n" translate="no">fixture</code><code class="p" translate="no">(</code><code class="n" translate="no">scope</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">module</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code> <a class="co" href="#callout_testing_ai_services_CO2-1" id="co_testing_ai_services_CO2-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
<code class="k" translate="no">def</code> <code class="nf" translate="no">tokens</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code> <a class="co" href="#callout_testing_ai_services_CO2-2" id="co_testing_ai_services_CO2-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
    <code class="k" translate="no">return</code> <code class="p" translate="no">[</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="mi" translate="no">2</code><code class="p" translate="no">,</code> <code class="mi" translate="no">3</code><code class="p" translate="no">,</code> <code class="mi" translate="no">4</code><code class="p" translate="no">,</code> <code class="mi" translate="no">5</code><code class="p" translate="no">]</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">test_token_chunking_small</code><code class="p" translate="no">(</code><code class="n" translate="no">token_list</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code> <a class="co" href="#callout_testing_ai_services_CO2-2" id="co_testing_ai_services_CO2-3"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
    <code class="n" translate="no">result</code> <code class="o" translate="no">=</code> <code class="n" translate="no">chunk</code><code class="p" translate="no">(</code><code class="n" translate="no">tokens</code><code class="p" translate="no">,</code> <code class="n" translate="no">chunk_size</code><code class="o" translate="no">=</code><code class="mi" translate="no">2</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">assert</code> <code class="n" translate="no">result</code> <code class="o" translate="no">=</code> <code class="p" translate="no">[</code><code class="p" translate="no">[</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="mi" translate="no">2</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="mi" translate="no">3</code><code class="p" translate="no">,</code> <code class="mi" translate="no">4</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="mi" translate="no">5</code><code class="p" translate="no">]</code><code class="p" translate="no">]</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">test_token_chunking_large</code><code class="p" translate="no">(</code><code class="n" translate="no">token_list</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code> <a class="co" href="#callout_testing_ai_services_CO2-2" id="co_testing_ai_services_CO2-4"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
    <code class="n" translate="no">result</code> <code class="o" translate="no">=</code> <code class="n" translate="no">chunk</code><code class="p" translate="no">(</code><code class="n" translate="no">tokens</code><code class="p" translate="no">,</code> <code class="n" translate="no">chunk_size</code><code class="o" translate="no">=</code><code class="mi" translate="no">5</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">assert</code> <code class="n" translate="no">result</code> <code class="o" translate="no">=</code> <code class="p" translate="no">[</code><code class="p" translate="no">[</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="mi" translate="no">2</code><code class="p" translate="no">,</code> <code class="mi" translate="no">3</code><code class="p" translate="no">,</code> <code class="mi" translate="no">4</code><code class="p" translate="no">,</code> <code class="mi" translate="no">5</code><code class="p" translate="no">]</code><code class="p" translate="no">]</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_ai_services_CO2-1" id="callout_testing_ai_services_CO2-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Dichiara la funzione <code translate="no">input_text</code> come una fixture <code translate="no">pytest</code> che può essere condivisa nel modulo come specificato da <code translate="no">scope="module"</code>.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO2-2" id="callout_testing_ai_services_CO2-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Usa la dependency injection di <code translate="no">pytest</code> per iniettare una fixture condivisa in diversi test.</p></dd>
</dl></div>
<p>Puoi dichiarare una funzione come una fixture <code translate="no">pytest</code> utilizzando il decoratore <code translate="no">@pytest.fixture(scope)</code>. Il parametro <code translate="no">scope</code> specifica la durata della fixture condivisa all'interno di una sessione di test.</p>
<p>In base al valore di <code translate="no">scope</code>, <code translate="no">pytest</code> crea e distrugge le fixture una volta per ogni funzione di test, <code translate="no">class</code>, <code translate="no">module</code>, <code translate="no">package</code>, o per l'intero test <code translate="no">session</code>.</p>
<div data-type="tip"><h6>Suggerimento</h6>
<p>Uno scenario in cui potresti aver bisogno di una fixture condivisa per persistere tra i moduli o per l'intera sessione di test è quando recuperi la fixture da un'API esterna e vuoi evitare di fare richieste<span class="keep-together">ripetute.</span></p>
</div>
<p>Utilizzando le fixture, puoi implementare diversi test con vari input che coprono valori validi, non validi e limite per verificare la robustezza di ogni componente. Tuttavia, dovrai separare le funzioni di test per ogni serie di input e output previsti. Per evitare di riscrivere lo stesso test, <code translate="no">pytest</code> ha una funzione di <em>parametrizzazione</em> che puoi<span class="keep-together">sfruttare.</span><a data-startref="ix_ch11-asciidoc22" data-type="indexterm" id="id1199"/><a data-startref="ix_ch11-asciidoc21" data-type="indexterm" id="id1200"/></p>
</div></section>
<section data-pdf-bookmark="Parameterization" data-type="sect3"><div class="sect3" id="id186">
<h3>Parametrizzazione</h3>
<p><a data-primary="parameterization" data-type="indexterm" id="ix_ch11-asciidoc23"/><a data-primary="pytest" data-secondary="parameterization" data-type="indexterm" id="ix_ch11-asciidoc24"/><a data-primary="RAG (retrieval augmented generation) module" data-secondary="unit tests" data-tertiary="parameterization" data-type="indexterm" id="ix_ch11-asciidoc25"/><a data-primary="unit tests" data-secondary="parameterization" data-type="indexterm" id="ix_ch11-asciidoc26"/>Con la parametrizzazione di <code translate="no">pytest</code>, puoi iterare su diversi dati di test e output attesi per evitare di duplicare i test, come puoi vedere nell'<a data-type="xref" href="#pytest_params">Esempio 11-3</a>.</p>
<div data-type="example" id="pytest_params">
<h5><span class="label">Esempio 11-3. </span> Parametrizzazione di<code translate="no">pytest</code> </h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># tests/rag/transform.py</code>

<code class="nd" translate="no">@pytest</code><code class="o" translate="no">.</code><code class="n" translate="no">mark</code><code class="o" translate="no">.</code><code class="n" translate="no">parametrize</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">tokens, chunk_size, expected</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code> <a class="co" href="#callout_testing_ai_services_CO3-1" id="co_testing_ai_services_CO3-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
    <code class="p" translate="no">(</code><code class="p" translate="no">[</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="mi" translate="no">2</code><code class="p" translate="no">,</code> <code class="mi" translate="no">3</code><code class="p" translate="no">,</code> <code class="mi" translate="no">4</code><code class="p" translate="no">,</code> <code class="mi" translate="no">5</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="mi" translate="no">2</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="p" translate="no">[</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="mi" translate="no">2</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="mi" translate="no">3</code><code class="p" translate="no">,</code> <code class="mi" translate="no">4</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="mi" translate="no">5</code><code class="p" translate="no">]</code><code class="p" translate="no">]</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code> <code class="c1" translate="no"># valid</code>
    <code class="p" translate="no">(</code><code class="p" translate="no">[</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="mi" translate="no">2</code><code class="p" translate="no">,</code> <code class="mi" translate="no">3</code><code class="p" translate="no">,</code> <code class="mi" translate="no">4</code><code class="p" translate="no">,</code> <code class="mi" translate="no">5</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="mi" translate="no">3</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="p" translate="no">[</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="mi" translate="no">2</code><code class="p" translate="no">,</code> <code class="mi" translate="no">3</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="mi" translate="no">4</code><code class="p" translate="no">,</code> <code class="mi" translate="no">5</code><code class="p" translate="no">]</code><code class="p" translate="no">]</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code> <code class="c1" translate="no"># valid</code>
    <code class="p" translate="no">(</code><code class="p" translate="no">[</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="mi" translate="no">2</code><code class="p" translate="no">,</code> <code class="mi" translate="no">3</code><code class="p" translate="no">,</code> <code class="mi" translate="no">4</code><code class="p" translate="no">,</code> <code class="mi" translate="no">5</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="p" translate="no">[</code><code class="mi" translate="no">1</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="mi" translate="no">2</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="mi" translate="no">3</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="mi" translate="no">4</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="mi" translate="no">5</code><code class="p" translate="no">]</code><code class="p" translate="no">]</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code>  <code class="c1" translate="no"># valid</code>
    <code class="p" translate="no">(</code><code class="p" translate="no">[</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="mi" translate="no">3</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="p" translate="no">]</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code> <code class="c1" translate="no"># valid/empty input</code>
    <code class="p" translate="no">(</code><code class="p" translate="no">[</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="mi" translate="no">2</code><code class="p" translate="no">,</code> <code class="mi" translate="no">3</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="mi" translate="no">5</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="p" translate="no">[</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="mi" translate="no">2</code><code class="p" translate="no">,</code> <code class="mi" translate="no">3</code><code class="p" translate="no">]</code><code class="p" translate="no">]</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code>   <code class="c1" translate="no"># boundary input</code>
    <code class="p" translate="no">(</code><code class="p" translate="no">[</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="mi" translate="no">2</code><code class="p" translate="no">,</code> <code class="mi" translate="no">3</code><code class="p" translate="no">,</code> <code class="mi" translate="no">4</code><code class="p" translate="no">,</code> <code class="mi" translate="no">5</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="mi" translate="no">0</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">ValueError</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code> <code class="c1" translate="no"># invalid (chunk_size &lt;= 0)</code>
    <code class="p" translate="no">(</code><code class="p" translate="no">[</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="mi" translate="no">2</code><code class="p" translate="no">,</code> <code class="mi" translate="no">3</code><code class="p" translate="no">,</code> <code class="mi" translate="no">4</code><code class="p" translate="no">,</code> <code class="mi" translate="no">5</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="o" translate="no">-</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">ValueError</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code> <code class="c1" translate="no"># invalid (chunk_size &lt;= 0)</code>
    <code class="p" translate="no">(</code>
        <code class="nb" translate="no">list</code><code class="p" translate="no">(</code><code class="nb" translate="no">range</code><code class="p" translate="no">(</code><code class="mi" translate="no">10000</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code> <code class="mi" translate="no">1000</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="nb" translate="no">list</code><code class="p" translate="no">(</code><code class="nb" translate="no">range</code><code class="p" translate="no">(</code><code class="n" translate="no">i</code><code class="p" translate="no">,</code> <code class="n" translate="no">i</code> <code class="o" translate="no">+</code> <code class="mi" translate="no">1000</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code> <code class="c1" translate="no"># huge data</code>
        <code class="k" translate="no">for</code> <code class="n" translate="no">i</code> <code class="ow" translate="no">in</code> <code class="nb" translate="no">range</code><code class="p" translate="no">(</code><code class="mi" translate="no">0</code><code class="p" translate="no">,</code> <code class="mi" translate="no">10000</code><code class="p" translate="no">,</code> <code class="mi" translate="no">1000</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code>
    <code class="p" translate="no">)</code>
<code class="p" translate="no">]</code><code class="p" translate="no">)</code>
<code class="k" translate="no">def</code> <code class="nf" translate="no">test_token_chunking</code><code class="p" translate="no">(</code><code class="n" translate="no">tokens</code><code class="p" translate="no">,</code> <code class="n" translate="no">chunk_size</code><code class="p" translate="no">,</code> <code class="n" translate="no">expected</code><code class="p" translate="no">)</code> <a class="co" href="#callout_testing_ai_services_CO3-2" id="co_testing_ai_services_CO3-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
    <code class="k" translate="no">if</code> <code class="n" translate="no">expected</code> <code class="o" translate="no">==</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">ValueError</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">with</code> <code class="n" translate="no">pytest</code><code class="o" translate="no">.</code><code class="n" translate="no">raises</code><code class="p" translate="no">(</code><code class="ne" translate="no">ValueError</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
            <code class="n" translate="no">chunk</code><code class="p" translate="no">(</code><code class="n" translate="no">tokens</code><code class="p" translate="no">,</code> <code class="n" translate="no">chunk_size</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">else</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">assert</code> <code class="n" translate="no">chunk</code><code class="p" translate="no">(</code><code class="n" translate="no">tokens</code><code class="p" translate="no">,</code> <code class="n" translate="no">chunk_size</code><code class="p" translate="no">)</code> <code class="o" translate="no">==</code> <code class="n" translate="no">expected</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_ai_services_CO3-1" id="callout_testing_ai_services_CO3-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Utilizza la funzione decoratrice <code translate="no">@pytest.mark.parametrize</code> per specificare più argomenti di test e gli output attesi. Gli argomenti di test coprono valori validi, vuoti, non validi, intervalli di confine e valori grandi per verificare la robustezza della funzione di raggruppamento dei token.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO3-2" id="callout_testing_ai_services_CO3-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Inietta i parametri di test nella funzione di test e se l'output previsto è un <code translate="no">ValueError</code>, usa <code translate="no">pytest.raises</code> per verificare che sia stata sollevata un'eccezione <code translate="no">ValueError</code>. Altrimenti, esegui il controllo dell'asserzione.</p></dd>
</dl></div>
<p>Puoi anche memorizzare i dati del test all'interno di file JSON e caricarli come fixture da iniettare nelle funzioni di test parametrizzate, come mostrato nell'<a data-type="xref" href="#pytest_params_json">Esempio 11-4</a>.</p>
<div data-type="example" id="pytest_params_json">
<h5><span class="label">Esempio 11-4. </span>Fissaggi JSON nei test parametrici di <code translate="no">pytest</code> </h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># tests/rag/test_data.json </code><a class="co" href="#callout_testing_ai_services_CO4-1" id="co_testing_ai_services_CO4-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>

<code class="p" translate="no">[</code>
    <code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">tokens</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="p" translate="no">[</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="mi" translate="no">2</code><code class="p" translate="no">,</code> <code class="mi" translate="no">3</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">chunk_size</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">expected</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="p" translate="no">[</code><code class="p" translate="no">[</code><code class="mi" translate="no">1</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="mi" translate="no">2</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="mi" translate="no">3</code><code class="p" translate="no">]</code><code class="p" translate="no">}</code><code class="p" translate="no">,</code>
    <code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code>
<code class="p" translate="no">]</code>

<code class="c1" translate="no"># tests/rag/transform.py</code>

<code class="nd" translate="no">@pytest</code><code class="o" translate="no">.</code><code class="n" translate="no">fixture</code>
<code class="k" translate="no">def</code> <code class="nf" translate="no">test_data</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="k" translate="no">with</code> <code class="nb" translate="no">open</code><code class="p" translate="no">(</code><code class="s1" translate="no">'</code><code class="s1" translate="no">test_data.json</code><code class="s1" translate="no">'</code><code class="p" translate="no">)</code> <code class="k" translate="no">as</code> <code class="n" translate="no">f</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">return</code> <code class="n" translate="no">json</code><code class="o" translate="no">.</code><code class="n" translate="no">load</code><code class="p" translate="no">(</code><code class="n" translate="no">f</code><code class="p" translate="no">)</code>

<code class="nd" translate="no">@pytest</code><code class="o" translate="no">.</code><code class="n" translate="no">mark</code><code class="o" translate="no">.</code><code class="n" translate="no">parametrize</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">case</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="n" translate="no">test_data</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code>
<code class="k" translate="no">def</code> <code class="nf" translate="no">test_token_chunking</code><code class="p" translate="no">(</code><code class="n" translate="no">case</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_ai_services_CO4-1" id="callout_testing_ai_services_CO4-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Il file JSON contiene un elenco di casi di test come dizionari.</p></dd>
</dl></div>
<p>Come puoi vedere, le fixture e la tecnica di parametrizzazione sono strumenti estremamente potenti per aiutarti a verificare la robustezza di ogni funzione del tuo codice.</p>
<p>Quando scrivi dei test, probabilmente vorrai specificare il codice di configurazione, le configurazioni e le fixture globali da condividere tra i file di test. Fortunatamente, puoi ottenere questo risultato nel file<span class="keep-together">di</span> configurazione globale di<span class="keep-together"><code translate="no">pytest</code>chiamato</span> <em>conftest.py</em>.<a data-startref="ix_ch11-asciidoc26" data-type="indexterm" id="id1201"/><a data-startref="ix_ch11-asciidoc25" data-type="indexterm" id="id1202"/><a data-startref="ix_ch11-asciidoc24" data-type="indexterm" id="id1203"/><a data-startref="ix_ch11-asciidoc23" data-type="indexterm" id="id1204"/></p>
</div></section>
<section data-pdf-bookmark="Conftest module" data-type="sect3"><div class="sect3" id="id263">
<h3>Modulo Conftest</h3>
<p><a data-primary="RAG (retrieval augmented generation) module" data-secondary="unit tests" data-tertiary="conftest module" data-type="indexterm" id="id1205"/><a data-primary="unit tests" data-secondary="conftest module" data-type="indexterm" id="id1206"/>Se vuoi che tutti i tuoi moduli di test abbiano accesso alle fixture e alle configurazioni globali, puoi aggiungere un modulo <em>conftest.py</em> alla tua directory <code translate="no">tests</code>. Tutte le fixture, il codice di setup e le configurazioni definite nel modulo conftest saranno condivise con gli altri moduli di test. Vedi l'<a data-type="xref" href="#conftest_fixture">Esempio 11-5</a>.</p>
<div data-type="example" id="conftest_fixture">
<h5><span class="label">Esempio 11-5. </span>Aggiungere un dispositivo condiviso per ogni modulo</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># tests/conftest.py</code>

<code class="nd" translate="no">@pytest</code><code class="o" translate="no">.</code><code class="n" translate="no">fixture</code><code class="p" translate="no">(</code><code class="n" translate="no">scope</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">module</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code> <a class="co" href="#callout_testing_ai_services_CO5-1" id="co_testing_ai_services_CO5-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
<code class="k" translate="no">def</code> <code class="nf" translate="no">tokens</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="k" translate="no">return</code> <code class="p" translate="no">[</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="mi" translate="no">2</code><code class="p" translate="no">,</code> <code class="mi" translate="no">3</code><code class="p" translate="no">,</code> <code class="mi" translate="no">4</code><code class="p" translate="no">,</code> <code class="mi" translate="no">5</code><code class="p" translate="no">]</code>

<code class="c1" translate="no"># tests/rag/transform.py</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">test_chunking</code><code class="p" translate="no">(</code><code class="n" translate="no">tokens</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code>

<code class="c1" translate="no"># tests/rag/retrieval.py</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">test_query</code><code class="p" translate="no">(</code><code class="n" translate="no">tokens</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_ai_services_CO5-1" id="callout_testing_ai_services_CO5-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Definisce una fixture condivisa in <em>conftest.py</em> da utilizzare per ogni modulo di test. Altrimenti, la fixture sarebbe limitata a un singolo modulo.</p></dd>
</dl></div>
<p>Ora hai imparato a scrivere dei test di base utilizzando il framework <code translate="no">pytest</code> secondo il modello GWT. Ora vediamo come eseguire le operazioni di configurazione e pulizia prima e dopo i test.</p>
</div></section>
<section data-pdf-bookmark="Setup and teardown" data-type="sect3"><div class="sect3" id="id187">
<h3>Configurazione e smontaggio</h3>
<p><a data-primary="RAG (retrieval augmented generation) module" data-secondary="unit tests" data-tertiary="setup and teardown" data-type="indexterm" id="ix_ch11-asciidoc27"/><a data-primary="unit tests" data-secondary="setup and teardown" data-type="indexterm" id="ix_ch11-asciidoc28"/>Quando si implementano i test, potrebbe essere necessario configurare un ambiente di prova prima ed eseguire operazioni di smantellamento o pulizia dopo. Puoi usare la parola chiave <code translate="no">yield</code> nelle fixture condivise per implementare le operazioni di configurazione e smantellamento che devono avvenire in modo coerente per ogni test.</p>
<p>Ad esempio, potresti aver bisogno di utilizzare questa funzione per impostare e ripulire una sessione del database, come dimostrato nell'<a data-type="xref" href="#setup_teardown">Esempio 11-6</a>.</p>
<div data-type="example" id="setup_teardown">
<h5><span class="label">Esempio 11-6. </span>Configurare e chiudere una sessione di database in una fixture condivisa</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># tests/conftest.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">qdrant_client</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">QdrantClient</code>

<code class="nd" translate="no">@pytest</code><code class="o" translate="no">.</code><code class="n" translate="no">fixture</code><code class="p" translate="no">(</code><code class="n" translate="no">scope</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">function</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code> <a class="co" href="#callout_testing_ai_services_CO6-1" id="co_testing_ai_services_CO6-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
<code class="k" translate="no">def</code> <code class="nf" translate="no">db_client</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">client</code> <code class="o" translate="no">=</code> <code class="n" translate="no">QdrantClient</code><code class="p" translate="no">(</code><code class="n" translate="no">host</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">localhost</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="n" translate="no">port</code><code class="o" translate="no">=</code><code class="mi" translate="no">6333</code><code class="p" translate="no">)</code> <a class="co" href="#callout_testing_ai_services_CO6-2" id="co_testing_ai_services_CO6-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
    <code class="n" translate="no">client</code><code class="o" translate="no">.</code><code class="n" translate="no">create_collection</code><code class="p" translate="no">(</code> <a class="co" href="#callout_testing_ai_services_CO6-2" id="co_testing_ai_services_CO6-3"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
        <code class="n" translate="no">collection_name</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">test</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code>
        <code class="n" translate="no">vectors_config</code><code class="o" translate="no">=</code><code class="n" translate="no">VectorParams</code><code class="p" translate="no">(</code><code class="n" translate="no">size</code><code class="o" translate="no">=</code><code class="mi" translate="no">4</code><code class="p" translate="no">,</code> <code class="n" translate="no">distance</code><code class="o" translate="no">=</code><code class="n" translate="no">Distance</code><code class="o" translate="no">.</code><code class="n" translate="no">DOT</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code>
    <code class="p" translate="no">)</code>
    <code class="n" translate="no">client</code><code class="o" translate="no">.</code><code class="n" translate="no">upsert</code><code class="p" translate="no">(</code> <a class="co" href="#callout_testing_ai_services_CO6-2" id="co_testing_ai_services_CO6-4"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
        <code class="n" translate="no">collection_name</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">test</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code>
        <code class="n" translate="no">points</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code>
            <code class="n" translate="no">PointStruct</code><code class="p" translate="no">(</code>
                <code class="nb" translate="no">id</code><code class="o" translate="no">=</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="n" translate="no">vector</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="mf" translate="no">0.05</code><code class="p" translate="no">,</code> <code class="mf" translate="no">0.61</code><code class="p" translate="no">,</code> <code class="mf" translate="no">0.76</code><code class="p" translate="no">,</code> <code class="mf" translate="no">0.74</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="n" translate="no">payload</code><code class="o" translate="no">=</code><code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">doc</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">test.pdf</code><code class="s2" translate="no">"</code><code class="p" translate="no">}</code>
            <code class="p" translate="no">)</code>
        <code class="p" translate="no">]</code><code class="p" translate="no">,</code>
    <code class="p" translate="no">)</code>
    <code class="k" translate="no">yield</code> <code class="n" translate="no">client</code> <a class="co" href="#callout_testing_ai_services_CO6-3" id="co_testing_ai_services_CO6-5"><img alt="3" src="assets/3.png" width="12" height="12"/></a>
    <code class="n" translate="no">client</code><code class="o" translate="no">.</code><code class="n" translate="no">close</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code> <a class="co" href="#callout_testing_ai_services_CO6-4" id="co_testing_ai_services_CO6-6"><img alt="4" src="assets/4.png" width="12" height="12"/></a>

<code class="c1" translate="no"># tests/rag/retrieve.py</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">test_search_db</code><code class="p" translate="no">(</code><code class="n" translate="no">db_client</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code> <a class="co" href="#callout_testing_ai_services_CO6-5" id="co_testing_ai_services_CO6-7"><img alt="5" src="assets/5.png" width="12" height="12"/></a>
    <code class="n" translate="no">result</code> <code class="o" translate="no">=</code> <code class="n" translate="no">db_client</code><code class="o" translate="no">.</code><code class="n" translate="no">search</code><code class="p" translate="no">(</code>
        <code class="n" translate="no">collection_name</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">test</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="n" translate="no">query_vector</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="mf" translate="no">0.18</code><code class="p" translate="no">,</code> <code class="mf" translate="no">0.81</code><code class="p" translate="no">,</code> <code class="mf" translate="no">0.75</code><code class="p" translate="no">,</code> <code class="mf" translate="no">0.12</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="n" translate="no">limit</code><code class="o" translate="no">=</code><code class="mi" translate="no">1</code>
    <code class="p" translate="no">)</code>
    <code class="k" translate="no">assert</code> <code class="n" translate="no">result</code> <code class="ow" translate="no">is</code> <code class="ow" translate="no">not</code> <code class="kc" translate="no">None</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_ai_services_CO6-1" id="callout_testing_ai_services_CO6-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Crea una fixture globale condivisa in <em>conftest.py</em> che viene creata e distrutta una volta per ogni funzione di test.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO6-2" id="callout_testing_ai_services_CO6-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Instanzia il client del database <code translate="no">qdrant</code> e poi crea e configura una collezione di test con un punto dati inserito come parte della fase di configurazione del test.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO6-5" id="callout_testing_ai_services_CO6-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Consegna il client del database alla funzione di test come parte della fase di test principale.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO6-6" id="callout_testing_ai_services_CO6-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Al termine di ogni test, chiude la connessione del client al database. Il codice di demolizione dopo la parola chiave <code translate="no">yield</code> viene eseguito una volta completata l'operazione di resa.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO6-7" id="callout_testing_ai_services_CO6-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a></dt>
<dd><p>Inietta il client del database preconfigurato in ogni funzione di test dopo aver completato l'impostazione del test. Interroga il database per il documento inserito e afferma che è stato recuperato un punto di dati. Una volta completata la fase di asserzione, esegui il processo di smantellamento come parte della funzione fixture <code translate="no">db_client</code>.</p></dd>
</dl></div>
<p>Seguendo l'esempio dell'<a data-type="xref" href="#setup_teardown">Esempio 11-6</a>, puoi anche creare delle fixture con fasi di setup e teardown per il tuo client di test API o per qualsiasi altro servizio esterno.</p>
<p>Inoltre, avrai notato che l'<a data-type="xref" href="#setup_teardown">Esempio 11-6</a> ha utilizzato un client sincrono invece di uno asincrono. Questo perché la gestione dei test asincroni può essere complicata, problematica e soggetta a errori e perché richiede l'installazione di plugin aggiuntivi di <code translate="no">pytest</code> per la gestione dei loop di eventi dei test.</p>
<p>Per evitare che i test unitari si rivelino inefficaci, dovresti usare i mock per isolare i componenti funzionali dai servizi esterni. Questo perché l'ambito e i confini di verifica dei test unitari non includono le dipendenze e le interfacce esterne, mentre i test delle dipendenze e delle interfacce esterne, come le interazioni con il database, rientrano nell'ambito dei test di integrazione.<a data-startref="ix_ch11-asciidoc28" data-type="indexterm" id="id1207"/><a data-startref="ix_ch11-asciidoc27" data-type="indexterm" id="id1208"/></p>
<p>In seguito imparerai a gestire i test asincroni e le tecniche di mocking/patching.</p>
</div></section>
<section data-pdf-bookmark="Handling asynchronous tests" data-type="sect3"><div class="sect3" id="id188">
<h3>Gestione dei test asincroni</h3>
<p><a data-primary="asynchronous tests" data-type="indexterm" id="ix_ch11-asciidoc29"/><a data-primary="RAG (retrieval augmented generation) module" data-secondary="unit tests" data-tertiary="handling asynchronous tests" data-type="indexterm" id="ix_ch11-asciidoc30"/><a data-primary="unit tests" data-secondary="handling asynchronous tests" data-type="indexterm" id="ix_ch11-asciidoc31"/>Per eseguire test asincroni, puoi utilizzare dei plug-in come <code translate="no">pytest-asyncio</code> che si integrano<span class="keep-together"><code translate="no">pytest</code></span> con <code translate="no">asyncio</code> di Python:</p>
<pre data-code-language="bash" data-type="programlisting" translate="no">$ pip install pytest-asyncio<code class="w" translate="no"/></pre>
<p>Una volta installato il plug-in, puoi seguire l'<a data-type="xref" href="#async_tests">Esempio 11-7</a> per scrivere ed eseguire un test asincrono.</p>
<div data-type="example" id="async_tests">
<h5><span class="label">Esempio 11-7. </span>Scrivere test asincroni</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># tests/rag/retrieve.py</code>

<code class="nd" translate="no">@pytest</code><code class="o" translate="no">.</code><code class="n" translate="no">mark</code><code class="o" translate="no">.</code><code class="n" translate="no">asyncio</code> <a class="co" href="#callout_testing_ai_services_CO7-1" id="co_testing_ai_services_CO7-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
<code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">test_search_db</code><code class="p" translate="no">(</code><code class="n" translate="no">async_db_client</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code> <a class="co" href="#callout_testing_ai_services_CO7-2" id="co_testing_ai_services_CO7-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
    <code class="n" translate="no">result</code> <code class="o" translate="no">=</code> <code class="k" translate="no">await</code> <code class="n" translate="no">async_db_client</code><code class="o" translate="no">.</code><code class="n" translate="no">search</code><code class="p" translate="no">(</code>
        <code class="n" translate="no">collection_name</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">test</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="n" translate="no">query_vector</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="mf" translate="no">0.18</code><code class="p" translate="no">,</code> <code class="mf" translate="no">0.81</code><code class="p" translate="no">,</code> <code class="mf" translate="no">0.75</code><code class="p" translate="no">,</code> <code class="mf" translate="no">0.12</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="n" translate="no">limit</code><code class="o" translate="no">=</code><code class="mi" translate="no">1</code>
    <code class="p" translate="no">)</code>
    <code class="k" translate="no">assert</code> <code class="n" translate="no">result</code> <code class="ow" translate="no">is</code> <code class="ow" translate="no">not</code> <code class="kc" translate="no">None</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_ai_services_CO7-1" id="callout_testing_ai_services_CO7-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Contrassegnare esplicitamente il test async con un decoratore <code translate="no">asyncio</code> per eseguire il test all'interno di un ciclo di eventi.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO7-2" id="callout_testing_ai_services_CO7-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Questo presuppone che tu abbia sostituito il client del database sincrono con uno asincrono in <em>conftest.py</em>.</p></dd>
</dl></div>
<p>Quando esegui il comando <code translate="no">pytest</code>, questo cerca nell'albero delle directory del progetto i test che utilizzano i <em>raccoglitori</em> per ogni livello della gerarchia delle directory: funzioni, classi,<span class="keep-together">moduli,</span> pacchetti o sessioni. Il plug-in <code translate="no">pytest-asyncio</code> fornisce un ciclo di<span class="keep-together">eventi asyncio</span> per ognuno di questi raccoglitori. Per impostazione predefinita, i test contrassegnati da<span class="keep-together"><code translate="no">@pytest.mark.asyncio</code></span> vengono eseguiti nel ciclo di eventi fornito dal <em>raccoglitore di funzioni</em>, per ridurre l'ambito del ciclo di eventi e massimizzare l'isolamento tra i test.</p>
<p>Ma perché questo isolamento è importante?</p>
<p>La più grande fonte di frustrazione per gli sviluppatori quando testano un software è rappresentata dai test che falliscono in modo casuale quando si esegue consecutivamente la suite di test senza modificare il codice o le configurazioni.</p>
<p><a data-primary="test isolation" data-type="indexterm" id="id1209"/>Spesso, quando si indaga sulla causa del comportamento difettoso dei test, si scopre che c'è una fixture o una dipendenza centrale che viene modificata da uno dei test, violando un principio fondamentale del testing: l'<em>isolamento dei test</em>. Lo scopo di questo isolamento è quello di ottenere <em>l'idempotenza</em> nei test in cui l'esecuzione ripetuta produrrebbe sempre gli stessi risultati, indipendentemente dal numero di volte in cui si esegue la suite di test.</p>
<p>Senza isolamento, i test possono creare effetti collaterali l'uno sull'altro, invalidando le ipotesi di base, portando a fluttuazioni nei risultati/comportamenti e a fallimenti casuali. Inoltre, i test interdipendenti e dipendenti dall'ordine spesso falliscono insieme, impedendoti di ottenere un feedback prezioso sui fallimenti.</p>
<p>Ma in che modo il comportamento anomalo è legato ai test asincroni?</p>
<p>Come abbiamo visto nel <a data-type="xref" href="ch05.html#ch05">Capitolo 5</a>, il codice asincrono sfrutta lo scheduler integrato di Python, un ciclo di eventi, per cambiare attività quando si trova di fronte a un'operazione di I/O bloccante. Questo cambio di attività in un ambiente di test può rendere i test asincroni difficili da implementare correttamente, perché le operazioni asincrone potrebbero non essere completate immediatamente e potrebbero essere eseguite in ordine sparso.</p>
<p>I test asincroni spesso si interfacciano con dipendenze esterne come database o filesystem che eseguono operazioni di I/O bloccanti che possono richiedere molto tempo per essere eseguite. Questo è un problema importante per i test unitari che devono essere eseguiti molto velocemente in modo da poterli eseguire frequentemente.</p>
<p>A differenza del codice sincrono, in cui le operazioni vengono eseguite in una sequenza prevedibile e lineare, il codice asincrono introduce anche una variabilità nei tempi, nell'ordine di esecuzione e nello stato delle fixture, riducendo la coerenza dei risultati tra i test. Inoltre, i tempi di risposta delle dipendenze esterne possono fluttuare, portando a effetti collaterali che violano il principio di isolamento dei test.</p>
<p>Per mitigare il rischio di effetti collaterali e di un comportamento scorretto, dovrai gestire correttamente i test asincroni:</p>
<ul>
<li>
<p>In attesa di operazioni di I/O bloccanti</p>
</li>
<li>
<p>Evitare l'uso involontario di operazioni di I/O sincrone bloccanti all'interno di test asincroni</p>
</li>
<li>
<p>Utilizzare i timeout corretti per gestire i ritardi</p>
</li>
<li>
<p>Controllare esplicitamente la sequenza delle operazioni, soprattutto quando si eseguono test async in parallelo</p>
</li>
</ul>
<p>Forse la soluzione migliore è quella di scrivere dei test sincroni utilizzando i mock delle dipendenze esterne, che disaccoppiano le tue funzioni dalle dipendenze bloccanti dell'I/O. Utilizzando i mock, puoi eseguire test veloci e affidabili senza dover aspettare che le operazioni di I/O vengano completate nell'ordine desiderato.</p>
<div data-type="tip"><h6>Suggerimento</h6>
<p>I test asincroni possono ancora essere utili con le dipendenze reali quando si testa localmente un ambiente di produzione replicato.<a data-startref="ix_ch11-asciidoc31" data-type="indexterm" id="id1210"/><a data-startref="ix_ch11-asciidoc30" data-type="indexterm" id="id1211"/><a data-startref="ix_ch11-asciidoc29" data-type="indexterm" id="id1212"/></p>
</div>
<p>Vediamo poi come prendere in giro le dipendenze esterne nei test unitari, in modo da poter scrivere test sincroni in sostituzione di quelli lenti e asincroni.</p>
</div></section>
<section data-pdf-bookmark="Mocking and patching" data-type="sect3"><div class="sect3" id="id189">
<h3>Mocking e patching</h3>
<p><a data-primary="mocking and patching" data-type="indexterm" id="ix_ch11-asciidoc32"/><a data-primary="RAG (retrieval augmented generation) module" data-secondary="unit tests" data-tertiary="mocking and patching" data-type="indexterm" id="ix_ch11-asciidoc33"/><a data-primary="unit tests" data-secondary="mocking and patching" data-type="indexterm" id="ix_ch11-asciidoc34"/>Quando scrivi i test unitari, devi isolare i tuoi componenti dalle dipendenze esterne per evitare che i test vengano eseguiti lentamente e che consumino risorse inutili. Ad esempio, non vuoi richiamare il tuo modello GenAI ogni volta che esegui la suite di test, cosa che sarà frequente, perché questo richiederà un'elevata intensità di calcolo e potrebbe essere costoso.</p>
<p>Invece, puoi usare i <em>test double</em> per simulare le dipendenze reali nei tuoi test unitari senza dover dipendere da dipendenze esterne nei tuoi test. In sostanza, fingono di essere la realtà, proprio come le controfigure nei film d'azione che fingono di essere gli attori principali. I test unitari isolati che usano i test double possono verificare i cambiamenti di stato del componente o il suo comportamento quando interagisce con dipendenze esterne come un'API LLM.</p>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>Fai attenzione a non sostituire il comportamento del componente che stai cercando di testare con dei doppi di prova.</p>
<p>Ad esempio, se hai una classe <code translate="no">ChatBot</code> che utilizza un'API LLM ed esegue un filtraggio dei contenuti sulle risposte, sostituisci solo le chiamate all'API LLM con i doppi di prova, non la logica di filtraggio dei contenuti, altrimenti dovrai testare il tuo doppio di prova.</p>
</div>
<p>Ci sono cinque tipi di doppi di test che puoi utilizzare nei tuoi test unitari, come mostrato nella <a data-type="xref" href="#test_doubles">Figura 11-9</a>.</p>
<figure><div class="figure" id="test_doubles">
<img alt="bgai 1109" src="assets/bgai_1109.png" width="1109" height="273"/>
<h6><span class="label">Figura 11-9. </span>Doppietta di prova</h6>
</div></figure>
<p>Questi includono i seguenti aspetti:</p>
<dl>
<dt>Falso</dt>
<dd>
<p>Un'implementazione semplificata di una dipendenza a scopo di test</p>
</dd>
<dt>Manichino</dt>
<dd>
<p>Un segnaposto utilizzato quando è necessario inserire un argomento</p>
</dd>
<dt>Stub</dt>
<dd>
<p>Fornisce dati falsi al sistema in fase di test che li sta utilizzando</p>
</dd>
<dt>Spia</dt>
<dd>
<p>Tiene traccia dell'utilizzo delle dipendenze per una verifica successiva</p>
</dd>
<dt>Finto</dt>
<dd>
<p>Controlla come verrà utilizzata la dipendenza e causa il fallimento se l'aspettativa non viene soddisfatta</p>
</dd>
</dl>
<p>Ad eccezione dei mock che verificano il comportamento del componente, gli altri double possono essere utilizzati per verificare i cambiamenti di stato. I mock hanno una configurazione e una logica di verifica completamente diversa, ma funzionano esattamente come gli altri double per far credere al componente da testare che sta interagendo con le dipendenze reali.</p>
<p>Vediamo i due doppi in azione per capire le loro somiglianze e differenze.</p>
<section data-pdf-bookmark="Fakes" data-type="sect4"><div class="sect4" id="id190">
<h4>Falsi</h4>
<p><a data-primary="fakes" data-type="indexterm" id="id1213"/><a data-primary="mocking and patching" data-secondary="fakes" data-type="indexterm" id="id1214"/><a data-primary="test doubles" data-secondary="fakes" data-type="indexterm" id="id1215"/><a data-primary="unit tests" data-secondary="mocking and patching" data-tertiary="fakes" data-type="indexterm" id="id1216"/><em>Un</em> esempio potrebbe essere un client di database che utilizza un database in memoria durante i test invece di un vero e proprio server di database; oppure un client LLM che recupera le risposte nella cache da un server di test locale invece di un vero e proprio LLM.</p>
<p>L<a data-type="xref" href="#test_fakes">'esempio 11-8</a> mostra l'aspetto di un falso client LLM.</p>
<div data-type="example" id="test_fakes">
<h5><span class="label">Esempio 11-8. </span>Doppio test fasullo</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="k" translate="no">class</code> <code class="nc" translate="no">FakeLLMClient</code><code class="p" translate="no">:</code> <a class="co" href="#callout_testing_ai_services_CO8-1" id="co_testing_ai_services_CO8-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
    <code class="k" translate="no">def</code> <code class="fm" translate="no">__init__</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
        <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">cache</code> <code class="o" translate="no">=</code> <code class="nb" translate="no">dict</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code>

    <code class="k" translate="no">def</code> <code class="nf" translate="no">invoke</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code> <code class="n" translate="no">query</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">if</code> <code class="n" translate="no">query</code> <code class="ow" translate="no">in</code> <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">cache</code><code class="p" translate="no">:</code>
            <code class="k" translate="no">return</code> <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">cache</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="n" translate="no">query</code><code class="p" translate="no">)</code> <a class="co" href="#callout_testing_ai_services_CO8-2" id="co_testing_ai_services_CO8-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>

        <code class="n" translate="no">response</code> <code class="o" translate="no">=</code> <code class="n" translate="no">requests</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">http://localhost:8001</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="n" translate="no">json</code><code class="o" translate="no">=</code><code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">query</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="n" translate="no">query</code><code class="p" translate="no">}</code><code class="p" translate="no">)</code>
        <code class="k" translate="no">if</code> <code class="n" translate="no">response</code><code class="o" translate="no">.</code><code class="n" translate="no">status_code</code> <code class="o" translate="no">!=</code> <code class="mi" translate="no">200</code><code class="p" translate="no">:</code>
            <code class="k" translate="no">return</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">Error fetching result</code><code class="s2" translate="no">"</code>

        <code class="n" translate="no">result</code> <code class="o" translate="no">=</code> <code class="n" translate="no">response</code><code class="o" translate="no">.</code><code class="n" translate="no">json</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">response</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code>
        <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">cache</code><code class="p" translate="no">[</code><code class="n" translate="no">query</code><code class="p" translate="no">]</code> <code class="o" translate="no">=</code> <code class="n" translate="no">result</code>
        <code class="k" translate="no">return</code> <code class="n" translate="no">result</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">process_query</code><code class="p" translate="no">(</code><code class="n" translate="no">query</code><code class="p" translate="no">,</code> <code class="n" translate="no">llm_client</code><code class="p" translate="no">,</code> <code class="n" translate="no">token</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">response</code> <code class="o" translate="no">=</code> <code class="n" translate="no">llm_client</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="p" translate="no">(</code><code class="n" translate="no">query</code><code class="p" translate="no">,</code> <code class="n" translate="no">token</code><code class="p" translate="no">)</code> <a class="co" href="#callout_testing_ai_services_CO8-1" id="co_testing_ai_services_CO8-3"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
    <code class="k" translate="no">return</code> <code class="n" translate="no">response</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">test_fake_llm_client</code><code class="p" translate="no">(</code><code class="n" translate="no">query</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">llm_client</code> <code class="o" translate="no">=</code> <code class="n" translate="no">FakeLLMClient</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">query</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">some query</code><code class="s2" translate="no">"</code>
    <code class="n" translate="no">response</code> <code class="o" translate="no">=</code> <code class="n" translate="no">process_query</code><code class="p" translate="no">(</code><code class="n" translate="no">query</code><code class="p" translate="no">,</code> <code class="n" translate="no">llm_client</code><code class="p" translate="no">,</code> <code class="n" translate="no">token</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">fake_token</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">assert</code> <code class="n" translate="no">response</code> <code class="o" translate="no">==</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">some response</code><code class="s2" translate="no">"</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_ai_services_CO8-1" id="callout_testing_ai_services_CO8-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Un client LLM completamente funzionale e in versione semplificata che imita il comportamento di quello reale interagendo con un server di test locale.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO8-2" id="callout_testing_ai_services_CO8-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Restituisce le risposte nella cache se vengono utilizzati prompt ripetuti.</p></dd>
</dl></div>
</div></section>
<section data-pdf-bookmark="Dummies" data-type="sect4"><div class="sect4" id="id191">
<h4>Dummies</h4>
<p><a data-primary="dummies" data-type="indexterm" id="id1217"/><a data-primary="mocking and patching" data-secondary="dummies" data-type="indexterm" id="id1218"/><a data-primary="test doubles" data-secondary="dummies" data-type="indexterm" id="id1219"/><a data-primary="unit tests" data-secondary="mocking and patching" data-tertiary="dummies" data-type="indexterm" id="id1220"/><em>I manichini</em> sono oggetti che non vengono utilizzati nei test, ma che vengono passati per soddisfare i requisiti dei parametri delle funzioni. Un esempio potrebbe essere il passaggio di un token di autenticazione falso a un client API per evitare errori, anche se il token non viene utilizzato per l'autenticazione durante il test.</p>
<p>L<a data-type="xref" href="#test_dummies">'esempio 11-9</a> mostra come i manichini possano essere utilizzati come doppi di prova.</p>
<div data-type="example" id="test_dummies">
<h5><span class="label">Esempio 11-9. </span>Test fittizio doppio</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="k" translate="no">class</code> <code class="nc" translate="no">DummyLLMClient</code><code class="p" translate="no">:</code>
    <code class="k" translate="no">def</code> <code class="nf" translate="no">invoke</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code> <code class="n" translate="no">query</code><code class="p" translate="no">,</code> <code class="n" translate="no">token</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code> <a class="co" href="#callout_testing_ai_services_CO9-1" id="co_testing_ai_services_CO9-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
        <code class="k" translate="no">return</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">some response</code><code class="s2" translate="no">"</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">process_query</code><code class="p" translate="no">(</code><code class="n" translate="no">query</code><code class="p" translate="no">,</code> <code class="n" translate="no">llm_client</code><code class="p" translate="no">,</code> <code class="n" translate="no">token</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">response</code> <code class="o" translate="no">=</code> <code class="n" translate="no">llm_client</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="p" translate="no">(</code><code class="n" translate="no">query</code><code class="p" translate="no">,</code> <code class="n" translate="no">token</code><code class="p" translate="no">)</code> <a class="co" href="#callout_testing_ai_services_CO9-1" id="co_testing_ai_services_CO9-2"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
    <code class="k" translate="no">return</code> <code class="n" translate="no">response</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">test_dummy_llm_client</code><code class="p" translate="no">(</code><code class="n" translate="no">query</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">llm_client</code> <code class="o" translate="no">=</code> <code class="n" translate="no">DummyLLMClient</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">query</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">some query</code><code class="s2" translate="no">"</code>
    <code class="n" translate="no">response</code> <code class="o" translate="no">=</code> <code class="n" translate="no">process_query</code><code class="p" translate="no">(</code><code class="n" translate="no">query</code><code class="p" translate="no">,</code> <code class="n" translate="no">llm_client</code><code class="p" translate="no">,</code> <code class="n" translate="no">token</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">fake_token</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">assert</code> <code class="n" translate="no">response</code> <code class="o" translate="no">==</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">some response</code><code class="s2" translate="no">"</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_ai_services_CO9-1" id="callout_testing_ai_services_CO9-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Si noti che <code translate="no">token</code> non viene utilizzato ma è necessario per soddisfare la firma della funzione <code translate="no">.invoke(query, token)</code>.</p></dd>
</dl></div>
</div></section>
<section data-pdf-bookmark="Stubs" data-type="sect4"><div class="sect4" id="id192">
<h4>Stub</h4>
<p><a data-primary="mocking and patching" data-secondary="stubs" data-type="indexterm" id="id1221"/><a data-primary="stubs" data-type="indexterm" id="id1222"/><a data-primary="test doubles" data-secondary="stubs" data-type="indexterm" id="id1223"/><a data-primary="unit tests" data-secondary="mocking and patching" data-tertiary="stubs" data-type="indexterm" id="id1224"/>Gli<em>stub</em> sono versioni semplificate dei fake: non hanno implementazioni completamente funzionali e restituiscono invece risposte in scatola alle chiamate di metodo. Ad esempio, un client LLM stub restituisce una stringa di fixture predefinita quando viene chiamato, senza effettuare alcuna richiesta di modello.</p>
<p>L<a data-type="xref" href="#test_stubs">'esempio 11-10</a> mostra l'aspetto di uno stub. Riesci a individuare le differenze tra questo esempio e l'<a data-type="xref" href="#test_fakes">esempio 11-8</a>?</p>
<div data-type="example" id="test_stubs">
<h5><span class="label">Esempio 11-10. </span>Test stub doppio</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="k" translate="no">class</code> <code class="nc" translate="no">StubLLMClient</code><code class="p" translate="no">:</code>
    <code class="k" translate="no">def</code> <code class="nf" translate="no">invoke</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code> <code class="n" translate="no">query</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">if</code> <code class="n" translate="no">query</code> <code class="o" translate="no">==</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">specific query</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <a class="co" href="#callout_testing_ai_services_CO10-1" id="co_testing_ai_services_CO10-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
            <code class="k" translate="no">return</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">specific response</code><code class="s2" translate="no">"</code>
        <code class="k" translate="no">return</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">default response</code><code class="s2" translate="no">"</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">process_query</code><code class="p" translate="no">(</code><code class="n" translate="no">query</code><code class="p" translate="no">,</code> <code class="n" translate="no">llm_client</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">response</code> <code class="o" translate="no">=</code> <code class="n" translate="no">llm_client</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="p" translate="no">(</code><code class="n" translate="no">query</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">return</code> <code class="n" translate="no">response</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">test_stub_llm_client</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">llm_client</code> <code class="o" translate="no">=</code> <code class="n" translate="no">StubLLMClient</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">query</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">specific query</code><code class="s2" translate="no">"</code>
    <code class="n" translate="no">response</code> <code class="o" translate="no">=</code> <code class="n" translate="no">process_query</code><code class="p" translate="no">(</code><code class="n" translate="no">query</code><code class="p" translate="no">,</code> <code class="n" translate="no">llm_client</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">assert</code> <code class="n" translate="no">response</code> <code class="o" translate="no">==</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">specific response</code><code class="s2" translate="no">"</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_ai_services_CO10-1" id="callout_testing_ai_services_CO10-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Restituisce una risposta in scatola in base a una determinata condizione.</p></dd>
</dl></div>
</div></section>
<section data-pdf-bookmark="Spies" data-type="sect4"><div class="sect4" id="id193">
<h4>Spie</h4>
<p><a data-primary="mocking and patching" data-secondary="spies" data-type="indexterm" id="id1225"/><a data-primary="spies" data-type="indexterm" id="id1226"/><a data-primary="test doubles" data-secondary="spies" data-type="indexterm" id="id1227"/><a data-primary="unit tests" data-secondary="mocking and patching" data-tertiary="spies" data-type="indexterm" id="id1228"/><em>Le spie</em> sono come gli stub, ma registrano anche le chiamate ai metodi e le interazioni. Sono estremamente utili quando devi verificare come un componente complesso interagisce con una dipendenza. Ad esempio, con un client LLM spia puoi verificare il numero di volte in cui è stato invocato dal componente sotto test.</p>
<p>L<a data-type="xref" href="#test_spies">'esempio 11-11</a> mostra un doppio test spia in azione.</p>
<div data-type="example" id="test_spies">
<h5><span class="label">Esempio 11-11. </span>Test spia doppio</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="k" translate="no">class</code> <code class="nc" translate="no">SpyLLMClient</code><code class="p" translate="no">:</code>
    <code class="k" translate="no">def</code> <code class="fm" translate="no">__init__</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
        <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">call_count</code> <code class="o" translate="no">=</code> <code class="mi" translate="no">0</code>
        <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">calls</code> <code class="o" translate="no">=</code> <code class="p" translate="no">[</code><code class="p" translate="no">]</code>

    <code class="k" translate="no">def</code> <code class="nf" translate="no">invoke</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code> <code class="n" translate="no">query</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
        <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">call_count</code> <code class="o" translate="no">+</code><code class="o" translate="no">=</code> <code class="mi" translate="no">1</code> <a class="co" href="#callout_testing_ai_services_CO11-1" id="co_testing_ai_services_CO11-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
        <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">calls</code><code class="o" translate="no">.</code><code class="n" translate="no">append</code><code class="p" translate="no">(</code><code class="p" translate="no">(</code><code class="n" translate="no">query</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code>
        <code class="k" translate="no">return</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">some response</code><code class="s2" translate="no">"</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">process_query</code><code class="p" translate="no">(</code><code class="n" translate="no">query</code><code class="p" translate="no">,</code> <code class="n" translate="no">llm_client</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">response</code> <code class="o" translate="no">=</code> <code class="n" translate="no">llm_client</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="p" translate="no">(</code><code class="n" translate="no">query</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">return</code> <code class="n" translate="no">response</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">test_process_query_with_spy</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">llm_client</code> <code class="o" translate="no">=</code> <code class="n" translate="no">SpyLLMClient</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">query</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">some query</code><code class="s2" translate="no">"</code>

    <code class="n" translate="no">process_query</code><code class="p" translate="no">(</code><code class="n" translate="no">query</code><code class="p" translate="no">,</code> <code class="n" translate="no">llm_client</code><code class="p" translate="no">)</code>

    <code class="k" translate="no">assert</code> <code class="n" translate="no">llm_client</code><code class="o" translate="no">.</code><code class="n" translate="no">call_count</code> <code class="o" translate="no">==</code> <code class="mi" translate="no">1</code>
    <code class="k" translate="no">assert</code> <code class="n" translate="no">llm_client</code><code class="o" translate="no">.</code><code class="n" translate="no">calls</code> <code class="o" translate="no">==</code> <code class="p" translate="no">[</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">some query</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_ai_services_CO11-1" id="callout_testing_ai_services_CO11-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Tiene traccia delle chiamate di funzione e degli argomenti passati.</p></dd>
</dl></div>
</div></section>
<section data-pdf-bookmark="Mocks" data-type="sect4"><div class="sect4" id="id264">
<h4>Sfottò</h4>
<p><a data-primary="mocking and patching" data-secondary="mocks" data-type="indexterm" id="id1229"/><a data-primary="test doubles" data-secondary="mocks" data-type="indexterm" id="id1230"/><a data-primary="unit tests" data-secondary="mocking and patching" data-tertiary="mocks" data-type="indexterm" id="id1231"/>Un mock è uno stub più intelligente. Se sai in anticipo quante volte viene chiamata una dipendenza e come (cioè, hai delle aspettative di interazione), puoi implementare un <em>mock</em>. Un mock può verificare se la dipendenza è stata chiamata correttamente con i parametri giusti per confermare che il componente da testare si è comportato correttamente.</p>
<p>Il modo in cui si impostano i mock e si eseguono i controlli con essi è diverso da quello degli altri double, come puoi vedere nell'<a data-type="xref" href="#test_mocks">Esempio 11-12</a>.</p>
<div data-type="note" epub:type="note"><h6>Nota</h6>
<p>Per questo esempio, devi installare il plug-in <code translate="no">pytest-mocks</code>, che è un sottile wrapper della libreria mocks integrata di Python per semplificare l'implementazione del mocking. Usa il seguente comando per installare <code translate="no">pytest-mocks</code>:</p>
<pre data-type="programlisting" translate="no">$ pip install pytest-mock</pre>
</div>
<div data-type="example" id="test_mocks">
<h5><span class="label">Esempio 11-12. </span>Test di simulazione doppio</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="k" translate="no">def</code> <code class="nf" translate="no">process_query</code><code class="p" translate="no">(</code><code class="n" translate="no">query</code><code class="p" translate="no">,</code> <code class="n" translate="no">llm_client</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">response</code> <code class="o" translate="no">=</code> <code class="n" translate="no">llm_client</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="p" translate="no">(</code><code class="n" translate="no">query</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">return</code> <code class="n" translate="no">response</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">test_process_query_with_mock</code><code class="p" translate="no">(</code><code class="n" translate="no">mocker</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">llm_client</code> <code class="o" translate="no">=</code> <code class="n" translate="no">mocker</code><code class="o" translate="no">.</code><code class="n" translate="no">Mock</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code> <a class="co" href="#callout_testing_ai_services_CO12-1" id="co_testing_ai_services_CO12-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
    <code class="n" translate="no">llm_client</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="o" translate="no">.</code><code class="n" translate="no">return_value</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">mock response</code><code class="s2" translate="no">"</code>
    <code class="n" translate="no">query</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">some query</code><code class="s2" translate="no">"</code>

    <code class="n" translate="no">process_query</code><code class="p" translate="no">(</code><code class="n" translate="no">query</code><code class="p" translate="no">,</code> <code class="n" translate="no">llm_client</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">process_query</code><code class="p" translate="no">(</code><code class="n" translate="no">query</code><code class="p" translate="no">,</code> <code class="n" translate="no">llm_client</code><code class="p" translate="no">)</code>

    <code class="k" translate="no">assert</code> <code class="n" translate="no">llm_client</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="o" translate="no">.</code><code class="n" translate="no">call_count</code> <code class="o" translate="no">==</code> <code class="mi" translate="no">2</code>
    <code class="n" translate="no">llm_client</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="o" translate="no">.</code><code class="n" translate="no">assert_any_call</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">some query</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_ai_services_CO12-1" id="callout_testing_ai_services_CO12-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Creiamo e configuriamo un mock che agisca come un client LLM e che tenga traccia delle chiamate di funzione e degli argomenti passati, oltre a restituire le risposte in scatola che desideriamo.</p></dd>
</dl></div>
<p>L'uso dei mock, come mostrato nell'<a data-type="xref" href="#test_mocks">Esempio 11-12</a>, sarà utile per verificare il comportamento del componente preso in giro in una logica applicativa molto annidata e complessa, come ad esempio la verifica del modo in cui una funzione presa in giro come <code translate="no">llm_client.invoke()</code> viene chiamata a diversi livelli di profondità all'interno di una funzione di ordine superiore come<code translate="no">process_query()</code>.</p>
<p>Ora che hai acquisito una maggiore familiarità con l'implementazione di vari test double da zero, vediamo come un pacchetto esterno come <code translate="no">pytest-mock</code> può semplificare l'uso dei test double.</p>
</div></section>
<section data-pdf-bookmark="Implementing test doubles with pytest-mock" data-type="sect4"><div class="sect4" id="id194">
<h4>Implementare i doppi dei test con pytest-mock</h4>
<p><a data-primary="mocking and patching" data-secondary="implementing test doubles with pytest-mock" data-type="indexterm" id="ix_ch11-asciidoc35"/><a data-primary="pytest-mock" data-type="indexterm" id="ix_ch11-asciidoc36"/><a data-primary="test doubles" data-secondary="implementing test doubles with pytest-mock" data-type="indexterm" id="ix_ch11-asciidoc37"/><a data-primary="unit tests" data-secondary="mocking and patching" data-tertiary="implementing test doubles with pytest-mock" data-type="indexterm" id="ix_ch11-asciidoc38"/>I cinque test doppi di cui sopra possono essere implementati anche con <code translate="no">pytest-mock</code>, come mostrato nell'<a data-type="xref" href="#test_double_pytest_mock">Esempio 11-13</a>.</p>
<div data-type="example" id="test_double_pytest_mock">
<h5><span class="label">Esempio 11-13. </span>Test dei doppi con <code translate="no">pytest-mock</code></h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="k" translate="no">class</code> <code class="nc" translate="no">LLMClient</code><code class="p" translate="no">:</code>
    <code class="k" translate="no">def</code> <code class="nf" translate="no">invoke</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code> <code class="n" translate="no">query</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">return</code> <code class="n" translate="no">openai</code><code class="o" translate="no">.</code><code class="n" translate="no">ChatCompletion</code><code class="o" translate="no">.</code><code class="n" translate="no">create</code><code class="p" translate="no">(</code>
            <code class="n" translate="no">model</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">gpt-4o</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="n" translate="no">messages</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">role</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">user</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">content</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="n" translate="no">query</code><code class="p" translate="no">}</code><code class="p" translate="no">]</code>
        <code class="p" translate="no">)</code>

<code class="nd" translate="no">@pytest</code><code class="o" translate="no">.</code><code class="n" translate="no">fixture</code>
<code class="k" translate="no">def</code> <code class="nf" translate="no">llm_client</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="k" translate="no">return</code> <code class="n" translate="no">LLMClient</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">test_fake</code><code class="p" translate="no">(</code><code class="n" translate="no">mocker</code><code class="p" translate="no">,</code> <code class="n" translate="no">llm_client</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="k" translate="no">class</code> <code class="nc" translate="no">FakeOpenAIClient</code><code class="p" translate="no">:</code> <a class="co" href="#callout_testing_ai_services_CO13-1" id="co_testing_ai_services_CO13-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
        <code class="nd" translate="no">@staticmethod</code>
        <code class="k" translate="no">def</code> <code class="nf" translate="no">invoke</code><code class="p" translate="no">(</code><code class="n" translate="no">model</code><code class="p" translate="no">,</code> <code class="n" translate="no">query</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
            <code class="k" translate="no">return</code> <code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">choices</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="p" translate="no">[</code><code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">message</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">content</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">fake response</code><code class="s2" translate="no">"</code><code class="p" translate="no">}</code><code class="p" translate="no">}</code><code class="p" translate="no">]</code><code class="p" translate="no">}</code>

    <code class="n" translate="no">mocker</code><code class="o" translate="no">.</code><code class="n" translate="no">patch</code><code class="p" translate="no">(</code><code class="n" translate="no">openai</code><code class="o" translate="no">.</code><code class="n" translate="no">ChatCompletion</code><code class="p" translate="no">,</code> <code class="n" translate="no">new</code><code class="o" translate="no">=</code><code class="n" translate="no">FakeOpenAIClient</code><code class="p" translate="no">)</code> <a class="co" href="#callout_testing_ai_services_CO13-1" id="co_testing_ai_services_CO13-2"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
    <code class="n" translate="no">result</code> <code class="o" translate="no">=</code> <code class="n" translate="no">llm_client</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">test query</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">assert</code> <code class="n" translate="no">result</code> <code class="o" translate="no">==</code> <code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">choices</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="p" translate="no">[</code><code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">message</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">content</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">fake response</code><code class="s2" translate="no">"</code><code class="p" translate="no">}</code><code class="p" translate="no">}</code><code class="p" translate="no">]</code><code class="p" translate="no">}</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">test_stub</code><code class="p" translate="no">(</code><code class="n" translate="no">mocker</code><code class="p" translate="no">,</code> <code class="n" translate="no">llm_client</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">stub</code> <code class="o" translate="no">=</code> <code class="n" translate="no">mocker</code><code class="o" translate="no">.</code><code class="n" translate="no">Mock</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">stub</code><code class="o" translate="no">.</code><code class="n" translate="no">process</code><code class="o" translate="no">.</code><code class="n" translate="no">return_value</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">stubbed response</code><code class="s2" translate="no">"</code>
    <code class="n" translate="no">result</code> <code class="o" translate="no">=</code> <code class="n" translate="no">llm_client</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="p" translate="no">(</code><code class="n" translate="no">stub</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">assert</code> <code class="n" translate="no">result</code> <code class="o" translate="no">==</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">stubbed response</code><code class="s2" translate="no">"</code>  <a class="co" href="#callout_testing_ai_services_CO13-2" id="co_testing_ai_services_CO13-3"><img alt="2" src="assets/2.png" width="12" height="12"/></a>

<code class="k" translate="no">def</code> <code class="nf" translate="no">test_spy</code><code class="p" translate="no">(</code><code class="n" translate="no">mocker</code><code class="p" translate="no">,</code> <code class="n" translate="no">llm_client</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">spy</code> <code class="o" translate="no">=</code> <code class="n" translate="no">mocker</code><code class="o" translate="no">.</code><code class="n" translate="no">spy</code><code class="p" translate="no">(</code><code class="n" translate="no">LLMClient</code><code class="p" translate="no">,</code> <code class="s1" translate="no">'</code><code class="s1" translate="no">send_request</code><code class="s1" translate="no">'</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">spy</code><code class="o" translate="no">.</code><code class="n" translate="no">return_value</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">some_value</code><code class="s2" translate="no">"</code>
    <code class="n" translate="no">llm_client</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">some query</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">spy</code><code class="o" translate="no">.</code><code class="n" translate="no">call_count</code> <code class="o" translate="no">==</code> <code class="mi" translate="no">1</code>  <a class="co" href="#callout_testing_ai_services_CO13-3" id="co_testing_ai_services_CO13-4"><img alt="3" src="assets/3.png" width="12" height="12"/></a>

<code class="k" translate="no">def</code> <code class="nf" translate="no">test_mock</code><code class="p" translate="no">(</code><code class="n" translate="no">mocker</code><code class="p" translate="no">,</code> <code class="n" translate="no">llm_client</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">mock</code> <code class="o" translate="no">=</code> <code class="n" translate="no">mocker</code><code class="o" translate="no">.</code><code class="n" translate="no">Mock</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">llm_client</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="p" translate="no">(</code><code class="n" translate="no">mock</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">mock</code><code class="o" translate="no">.</code><code class="n" translate="no">process</code><code class="o" translate="no">.</code><code class="n" translate="no">assert_called_once_with</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">some query</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code> <a class="co" href="#callout_testing_ai_services_CO13-4" id="co_testing_ai_services_CO13-5"><img alt="4" src="assets/4.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_ai_services_CO13-1" id="callout_testing_ai_services_CO13-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Il falso simula un comportamento reale.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO13-3" id="callout_testing_ai_services_CO13-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Lo stub restituisce un valore fisso.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO13-4" id="callout_testing_ai_services_CO13-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>La spia traccia le chiamate.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO13-5" id="callout_testing_ai_services_CO13-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Controlla il comportamento delle dipendenze e fallisce se le aspettative non sono soddisfatte.</p></dd>
</dl></div>
<p>A questo punto puoi utilizzare uno qualsiasi dei doppi test menzionati per isolare i tuoi test unitari, eseguirli più velocemente coprendo vari casi limite difficili da testare e bypassare le dipendenze che introducono il non-determinismo nei tuoi test. Ma tieni presente che avere troppi test mocked è un anti-pattern in quanto questi test possono darti una falsa sicurezza e diventare un sovraccarico di manutenzione a causa della loro fragilità. Possono anche mascherare i problemi di integrazione in quanto non testano le dipendenze reali e un uso eccessivo può portare a implementazioni di test complesse e difficili da capire.</p>
<p>In questi casi, dovresti affidarti ai mock semplici solo quando è necessario e nei test unitari. Inoltre, dovresti integrare i test mock con test di integrazione che utilizzano le dipendenze reali per evitare di perdere eventuali problemi di produzione<a data-startref="ix_ch11-asciidoc38" data-type="indexterm" id="id1232"/><a data-startref="ix_ch11-asciidoc37" data-type="indexterm" id="id1233"/><a data-startref="ix_ch11-asciidoc36" data-type="indexterm" id="id1234"/><a data-startref="ix_ch11-asciidoc35" data-type="indexterm" id="id1235"/> .<a data-startref="ix_ch11-asciidoc34" data-type="indexterm" id="id1236"/><a data-startref="ix_ch11-asciidoc33" data-type="indexterm" id="id1237"/><a data-startref="ix_ch11-asciidoc32" data-type="indexterm" id="id1238"/></p>
<p>Nella prossima sezione scoprirai come implementare un test di integrazione per la tua pipeline RAG.<a data-startref="ix_ch11-asciidoc17" data-type="indexterm" id="id1239"/><a data-startref="ix_ch11-asciidoc16" data-type="indexterm" id="id1240"/></p>
</div></section>
</div></section>
</div></section>
<section data-pdf-bookmark="Integration Testing" data-type="sect2"><div class="sect2" id="id195">
<h2>Test di integrazione</h2>
<p><a data-primary="integration tests" data-type="indexterm" id="ix_ch11-asciidoc39"/><a data-primary="testing AI services" data-secondary="project: implementing tests for a RAG system" data-tertiary="integration testing" data-type="indexterm" id="ix_ch11-asciidoc40"/>Fino a questo punto ti sei esercitato a scrivere test unitari isolati, ma non appena vorrai testare un componente che interagisce con un altro componente o con una dipendenza reale, dovrai implementare dei test di integrazione.</p>
<p>Il perimetro di verifica dei test di integrazione deve includere due componenti e l'ambito di questi test deve concentrarsi sulla verifica della funzionalità della loro interfaccia e del contratto di comunicazione tra loro.</p>
<p>A titolo di esempio, nella <a data-type="xref" href="#integration_boundaries">Figura 11-10</a> puoi vedere i potenziali test di integrazione che puoi implementare per la tua pipeline RAG.</p>
<figure><div class="figure" id="integration_boundaries">
<img alt="bgai 1110" src="assets/bgai_1110.png" width="1413" height="583"/>
<h6><span class="label">Figura 11-10. </span>Limiti dei test di integrazione visualizzati sul diagramma della pipeline di dati RAG</h6>
</div></figure>
<p>Rispetto ai confini dei test unitari che hai visto nella <a data-type="xref" href="#unit_boundaries">Figura 11-8</a>, puoi notare che ogni integrazione si preoccupa solo di verificare il comportamento dell'interazione tra due o al massimo tre componenti alla volta.</p>
<p>Per esercitarci, implementeremo un test di integrazione per l'interfaccia di recupero dei documenti con il database vettoriale nella pipeline RAG. In questo test, interrogherai il database vettoriale reale per verificare se i documenti rilevanti vengono recuperati in relazione alla query.</p>
<p>I test sfrutteranno le metriche di reperimento legate al RAG, come la precisione del contesto e il richiamo del contesto, per misurare l'efficacia del sistema di reperimento con il database vettoriale reale.</p>
<section data-pdf-bookmark="Context precision and recall" data-type="sect3"><div class="sect3" id="id196">
<h3>Precisione e richiamo del contesto</h3>
<p><a data-primary="context precision" data-type="indexterm" id="ix_ch11-asciidoc41"/><a data-primary="context recall" data-type="indexterm" id="ix_ch11-asciidoc42"/><a data-primary="integration tests" data-secondary="context precision and recall" data-type="indexterm" id="ix_ch11-asciidoc43"/><a data-primary="RAG (retrieval augmented generation) module" data-secondary="integration testing" data-tertiary="context precision and recall" data-type="indexterm" id="ix_ch11-asciidoc44"/>Sia la precisione che il richiamo del contesto sono metriche di valutazione appositamente studiate per misurare la qualità del sistema di recupero dei documenti dal database vettoriale in una pipeline RAG.</p>
<p>Mentre la <em>precisione del contesto</em> si concentra sul rapporto segnale/rumore (cioè sulla qualità) delle informazioni recuperate dal database vettoriale, il <em>richiamo del contesto</em> misura se tutte le informazioni rilevanti per rispondere alla query dell'utente sono state recuperate dal database.</p>
<p class="less_space pagebreak-before">Puoi calcolare la precisione e il richiamo del contesto utilizzando l'<a data-type="xref" href="#context_precision_recall">Esempio 11-14</a>.</p>
<div data-type="example" id="context_precision_recall">
<h5><span class="label">Esempio 11-14. </span>Calcolo della precisione e del richiamo del contesto</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="k" translate="no">def</code> <code class="nf" translate="no">calculate_recall</code><code class="p" translate="no">(</code><code class="n" translate="no">expected</code><code class="p" translate="no">:</code> <code class="nb" translate="no">list</code><code class="p" translate="no">[</code><code class="nb" translate="no">int</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="n" translate="no">retrieved</code><code class="p" translate="no">:</code> <code class="nb" translate="no">list</code><code class="p" translate="no">[</code><code class="nb" translate="no">int</code><code class="p" translate="no">]</code><code class="p" translate="no">)</code> <code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code> <code class="nb" translate="no">int</code><code class="p" translate="no">:</code> <a class="co" href="#callout_testing_ai_services_CO14-1" id="co_testing_ai_services_CO14-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
    <code class="n" translate="no">true_positives</code> <code class="o" translate="no">=</code> <code class="nb" translate="no">len</code><code class="p" translate="no">(</code><code class="nb" translate="no">set</code><code class="p" translate="no">(</code><code class="n" translate="no">expected</code><code class="p" translate="no">)</code> <code class="o" translate="no">&amp;</code> <code class="nb" translate="no">set</code><code class="p" translate="no">(</code><code class="n" translate="no">retrieved</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">return</code> <code class="n" translate="no">true_positives</code> <code class="o" translate="no">/</code> <code class="nb" translate="no">len</code><code class="p" translate="no">(</code><code class="n" translate="no">expected</code><code class="p" translate="no">)</code>


<code class="k" translate="no">def</code> <code class="nf" translate="no">calculate_precision</code><code class="p" translate="no">(</code><code class="n" translate="no">expected</code><code class="p" translate="no">:</code> <code class="nb" translate="no">list</code><code class="p" translate="no">[</code><code class="nb" translate="no">int</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="n" translate="no">retrieved</code><code class="p" translate="no">:</code> <code class="nb" translate="no">list</code><code class="p" translate="no">[</code><code class="nb" translate="no">int</code><code class="p" translate="no">]</code><code class="p" translate="no">)</code> <code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code> <code class="nb" translate="no">int</code><code class="p" translate="no">:</code> <a class="co" href="#callout_testing_ai_services_CO14-2" id="co_testing_ai_services_CO14-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
    <code class="n" translate="no">true_positives</code> <code class="o" translate="no">=</code> <code class="nb" translate="no">len</code><code class="p" translate="no">(</code><code class="nb" translate="no">set</code><code class="p" translate="no">(</code><code class="n" translate="no">expected</code><code class="p" translate="no">)</code> <code class="o" translate="no">&amp;</code> <code class="nb" translate="no">set</code><code class="p" translate="no">(</code><code class="n" translate="no">retrieved</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">return</code> <code class="n" translate="no">true_positives</code> <code class="o" translate="no">/</code> <code class="nb" translate="no">len</code><code class="p" translate="no">(</code><code class="n" translate="no">retrieved</code><code class="p" translate="no">)</code>

<code class="n" translate="no">expected_document_ids</code> <code class="o" translate="no">=</code> <code class="p" translate="no">[</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="mi" translate="no">2</code><code class="p" translate="no">,</code> <code class="mi" translate="no">3</code><code class="p" translate="no">,</code> <code class="mi" translate="no">4</code><code class="p" translate="no">,</code> <code class="mi" translate="no">5</code><code class="p" translate="no">]</code>
<code class="n" translate="no">retrieved_documents_ids</code> <code class="o" translate="no">=</code> <code class="p" translate="no">[</code><code class="mi" translate="no">2</code><code class="p" translate="no">,</code> <code class="mi" translate="no">3</code><code class="p" translate="no">,</code> <code class="mi" translate="no">6</code><code class="p" translate="no">,</code> <code class="mi" translate="no">7</code><code class="p" translate="no">]</code>

<code class="n" translate="no">recall</code> <code class="o" translate="no">=</code> <code class="n" translate="no">calculate_recall</code><code class="p" translate="no">(</code><code class="n" translate="no">expected_document_ids</code><code class="p" translate="no">,</code> <code class="n" translate="no">retrieved_documents_ids</code><code class="p" translate="no">)</code>
<code class="n" translate="no">precision</code> <code class="o" translate="no">=</code> <code class="n" translate="no">calculate_precision</code><code class="p" translate="no">(</code><code class="n" translate="no">expected_document_ids</code><code class="p" translate="no">,</code> <code class="n" translate="no">retrieved_documents_ids</code><code class="p" translate="no">)</code>

<code class="nb" translate="no">print</code><code class="p" translate="no">(</code><code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Recall: </code><code class="si" translate="no">{</code><code class="n" translate="no">recall</code><code class="si" translate="no">:</code><code class="s2" translate="no">.2f</code><code class="si" translate="no">}</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code> <code class="c1" translate="no"># Recall: 0.40</code>
<code class="nb" translate="no">print</code><code class="p" translate="no">(</code><code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Precision: </code><code class="si" translate="no">{</code><code class="n" translate="no">precision</code><code class="si" translate="no">:</code><code class="s2" translate="no">.2f</code><code class="si" translate="no">}</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code> <code class="c1" translate="no"># Precision: 0.50</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_ai_services_CO14-1" id="callout_testing_ai_services_CO14-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Conteggio dei documenti corretti recuperati/conteggio dei documenti attesi.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO14-2" id="callout_testing_ai_services_CO14-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Conteggio dei documenti corretti recuperati/conteggio dei documenti recuperati.</p></dd>
</dl></div>
<p>In questo caso, si presuppone che ogni documento contenga tutte le informazioni contestuali rilevanti per rispondere a una determinata query, quindi sarà sufficiente affermare che alcuni documenti sono stati recuperati.</p>
<p>Le librerie open source come <code translate="no">deep-eval</code> e <code translate="no">ragas</code> possono aiutarti ad automatizzare il calcolo di queste metriche considerando che il contesto rilevante è sparso tra i documenti, ma per semplicità implementeremo i nostri test di integrazione senza affidarci a queste librerie.</p>
<p>Con le metriche di precisione e di richiamo, il test di integrazione del sistema di reperimento dei documenti sarà simile all'<a data-type="xref" href="#integration_retrieval">Esempio 11-15</a>.</p>
<div data-type="example" id="integration_retrieval">
<h5><span class="label">Esempio 11-15. </span>Test di integrazione del sistema di recupero dei documenti</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="nd" translate="no">@pytest</code><code class="o" translate="no">.</code><code class="n" translate="no">mark</code><code class="o" translate="no">.</code><code class="n" translate="no">parametrize</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">query_vector, expected_ids</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code> <a class="co" href="#callout_testing_ai_services_CO15-1" id="co_testing_ai_services_CO15-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
    <code class="p" translate="no">(</code><code class="p" translate="no">[</code><code class="mf" translate="no">0.1</code><code class="p" translate="no">,</code> <code class="mf" translate="no">0.2</code><code class="p" translate="no">,</code> <code class="mf" translate="no">0.3</code><code class="p" translate="no">,</code> <code class="mf" translate="no">0.4</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="mi" translate="no">2</code><code class="p" translate="no">,</code> <code class="mi" translate="no">3</code><code class="p" translate="no">]</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code>
    <code class="p" translate="no">(</code><code class="p" translate="no">[</code><code class="mf" translate="no">0.2</code><code class="p" translate="no">,</code> <code class="mf" translate="no">0.3</code><code class="p" translate="no">,</code> <code class="mf" translate="no">0.4</code><code class="p" translate="no">,</code> <code class="mf" translate="no">0.5</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="mi" translate="no">2</code><code class="p" translate="no">,</code> <code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="mi" translate="no">3</code><code class="p" translate="no">]</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code>
    <code class="p" translate="no">(</code><code class="p" translate="no">[</code><code class="mf" translate="no">0.3</code><code class="p" translate="no">,</code> <code class="mf" translate="no">0.4</code><code class="p" translate="no">,</code> <code class="mf" translate="no">0.5</code><code class="p" translate="no">,</code> <code class="mf" translate="no">0.6</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code><code class="mi" translate="no">3</code><code class="p" translate="no">,</code> <code class="mi" translate="no">2</code><code class="p" translate="no">,</code> <code class="mi" translate="no">1</code><code class="p" translate="no">]</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code>
    <code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code>
<code class="p" translate="no">]</code><code class="p" translate="no">)</code>
<code class="k" translate="no">def</code> <code class="nf" translate="no">test_retrieval_subsystem</code><code class="p" translate="no">(</code><code class="n" translate="no">db_client</code><code class="p" translate="no">,</code> <code class="n" translate="no">query_vector</code><code class="p" translate="no">,</code> <code class="n" translate="no">expected_ids</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code> <a class="co" href="#callout_testing_ai_services_CO15-2" id="co_testing_ai_services_CO15-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
    <code class="n" translate="no">response</code> <code class="o" translate="no">=</code> <code class="n" translate="no">db_client</code><code class="o" translate="no">.</code><code class="n" translate="no">search</code><code class="p" translate="no">(</code> <a class="co" href="#callout_testing_ai_services_CO15-2" id="co_testing_ai_services_CO15-3"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
        <code class="n" translate="no">collection_name</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">test</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code>
        <code class="n" translate="no">query_vector</code><code class="o" translate="no">=</code><code class="n" translate="no">query_vector</code><code class="p" translate="no">,</code>
        <code class="n" translate="no">limit</code><code class="o" translate="no">=</code><code class="mi" translate="no">3</code>
    <code class="p" translate="no">)</code>

    <code class="n" translate="no">retrieved_ids</code> <code class="o" translate="no">=</code> <code class="p" translate="no">[</code><code class="n" translate="no">point</code><code class="o" translate="no">.</code><code class="n" translate="no">id</code> <code class="k" translate="no">for</code> <code class="n" translate="no">point</code> <code class="ow" translate="no">in</code> <code class="n" translate="no">response</code><code class="p" translate="no">]</code>
    <code class="n" translate="no">recall</code> <code class="o" translate="no">=</code> <code class="n" translate="no">calculate_recall</code><code class="p" translate="no">(</code><code class="n" translate="no">expected_ids</code><code class="p" translate="no">,</code> <code class="n" translate="no">retrieved_ids</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">precision</code> <code class="o" translate="no">=</code> <code class="n" translate="no">calculate_precision</code><code class="p" translate="no">(</code><code class="n" translate="no">expected_ids</code><code class="p" translate="no">,</code> <code class="n" translate="no">retrieved_ids</code><code class="p" translate="no">)</code>

    <code class="k" translate="no">assert</code> <code class="n" translate="no">recall</code> <code class="o" translate="no">&gt;</code><code class="o" translate="no">=</code> <code class="mf" translate="no">0.66</code> <a class="co" href="#callout_testing_ai_services_CO15-3" id="co_testing_ai_services_CO15-4"><img alt="3" src="assets/3.png" width="12" height="12"/></a>
    <code class="k" translate="no">assert</code> <code class="n" translate="no">precision</code> <code class="o" translate="no">&gt;</code><code class="o" translate="no">=</code> <code class="mf" translate="no">0.66</code> <a class="co" href="#callout_testing_ai_services_CO15-3" id="co_testing_ai_services_CO15-5"><img alt="3" src="assets/3.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_ai_services_CO15-1" id="callout_testing_ai_services_CO15-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Specifica i dati di test parametrati che coprono vari casi.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO15-2" id="callout_testing_ai_services_CO15-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Configura il client qdrant all'interno di <em>conftest.py</em> con la corretta implementazione di setup e teardown per avviare il test con un database di documenti precompilato.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO15-4" id="callout_testing_ai_services_CO15-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Calcola la precisione e il richiamo per ogni caso di test per assicurarti che siano superiori a una soglia ragionevole. Spesso c'è un compromesso tra le metriche di precisione e richiamo, quindi scegli soglie ragionevoli basate sul tuo caso d'uso.</p></dd>
</dl></div>
<p>Mentre l'<a data-type="xref" href="#integration_retrieval">Esempio 11-15</a> controlla il sistema di recupero dei documenti, puoi anche implementare un test di integrazione per il tuo sottosistema di generazione utilizzando l'LLM. Tuttavia, tieni presente che a causa della natura non deterministica dell'LLM, può essere difficile garantire una copertura completa dei test e la coerenza dei risultati.</p>
<p>Se hai richiesto al tuo LLM di restituire risposte JSON, puoi scrivere test di integrazione con asserzioni di uguaglianza per verificare la struttura e il valore delle risposte JSON. Un esempio in cui puoi seguire questo approccio è la <em>chiamata di funzione</em> o i <em>flussi di lavoro agenziali</em> in cui il LLM deve selezionare lo strumento giusto o l'agente LLM specializzato da utilizzare per rispondere alla query.</p>
<p>Un test del genere potrebbe assomigliare all'<a data-type="xref" href="#integration_llm_json">Esempio 11-16</a>.</p>
<div data-type="example" id="integration_llm_json">
<h5><span class="label">Esempio 11-16. </span>Test di integrazione del sistema di generazione delle risposte JSON di LLM</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="nd" translate="no">@pytest</code><code class="o" translate="no">.</code><code class="n" translate="no">mark</code><code class="o" translate="no">.</code><code class="n" translate="no">parametrize</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">user_query, expected_tool</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code>
    <code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Summarize the employee onboarding process</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">SUMMARIZER</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code>
    <code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">What is this page about? https://...</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">WEBSEARCH</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code>
    <code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Analyze the 2024 annual accounts</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">ANALYZER</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code>
    <code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code> <code class="c1" translate="no"># Add 100 different cases with a balanced category distribution</code>
<code class="p" translate="no">]</code><code class="p" translate="no">)</code> <a class="co" href="#callout_testing_ai_services_CO16-1" id="co_testing_ai_services_CO16-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
<code class="k" translate="no">def</code> <code class="nf" translate="no">test_llm_tool_selection_response</code><code class="p" translate="no">(</code><code class="n" translate="no">user_query</code><code class="p" translate="no">,</code> <code class="n" translate="no">expected_tool</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">response</code> <code class="o" translate="no">=</code> <code class="n" translate="no">llm</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="p" translate="no">(</code><code class="n" translate="no">user_query</code><code class="p" translate="no">,</code> <code class="n" translate="no">response_type</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">json</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">assert</code> <code class="n" translate="no">response</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">selected_tool</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code> <code class="o" translate="no">==</code> <code class="n" translate="no">expected_tool</code>
    <code class="k" translate="no">assert</code> <code class="n" translate="no">response</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">message</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code> <code class="ow" translate="no">is</code> <code class="ow" translate="no">not</code> <code class="kc" translate="no">None</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_ai_services_CO16-1" id="callout_testing_ai_services_CO16-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Iterare vari casi di test che coprono varie query degli utenti. Assicurarsi che i casi di test coprano una distribuzione equilibrata delle categorie.</p></dd>
</dl></div>
<p>Dato che il modello può commettere degli errori e che potresti non essere in grado di testare tutti i casi possibili, vorrai eseguire questo test un numero sufficiente di volte (forse fino a 100) per visualizzare i modelli di distribuzione delle risposte dell'LLM. Questo dovrebbe darti maggiore sicurezza sul modo in cui l'LLM seleziona lo strumento o l'agente giusto per una determinata query dell'utente.</p>
<p>Se i tuoi modelli restituiscono output strutturati, i test di integrazione possono essere semplici da implementare, come hai visto nell'<a data-type="xref" href="#integration_llm_json">esempio 11-16</a>. Tuttavia, se i tuoi modelli GenAI rispondono con contenuti più dinamici, come ad esempio un testo naturale, come puoi testare la qualità delle risposte dei tuoi modelli?</p>
<p>In questo caso, puoi misurare le proprietà e le metriche relative all'output del modello. Nel caso degli LLMs, misura le proprietà di generazione del modello come la <em>pertinenza del contesto</em>, il <em>tasso di allucinazione</em>, la <em>tossicità</em> e così via, per verificare la correttezza e la qualità delle risposte basate sul contesto del prompt.</p>
<p>Questo approccio viene definito " <em>test comportamentale</em>", di cui parleremo in seguito.<a data-startref="ix_ch11-asciidoc44" data-type="indexterm" id="id1241"/><a data-startref="ix_ch11-asciidoc43" data-type="indexterm" id="id1242"/><a data-startref="ix_ch11-asciidoc42" data-type="indexterm" id="id1243"/><a data-startref="ix_ch11-asciidoc41" data-type="indexterm" id="id1244"/></p>
</div></section>
<section data-pdf-bookmark="Behavioral testing" data-type="sect3"><div class="sect3" id="id197">
<h3>Test comportamentali</h3>
<p><a data-primary="behavioral testing" data-type="indexterm" id="ix_ch11-asciidoc45"/><a data-primary="integration tests" data-secondary="behavioral testing" data-type="indexterm" id="ix_ch11-asciidoc46"/><a data-primary="RAG (retrieval augmented generation) module" data-secondary="integration testing" data-tertiary="behavioral testing" data-type="indexterm" id="ix_ch11-asciidoc47"/>La scrittura di test per i modelli che restituiscono contenuti dinamici può essere impegnativa perché gli output sono spesso vari, creativi e difficili da valutare con controlli diretti di uguaglianza. Inoltre, non puoi coprire tutti i casi nello spazio multidimensionale degli input del modello.</p>
<p>Al contrario, dovrai trattare il modello come una scatola nera e verificare il comportamento del modello e le caratteristiche di output utilizzando una serie di input che riflettono i potenziali<span class="keep-together">modelli di</span> utilizzo<span class="keep-together">.</span></p>
<div data-type="tip"><h6>Suggerimento</h6>
<p>Tieni presente che quando testi i modelli GenAI non puoi ottenere una copertura completa dell'intera distribuzione di input, ma puoi puntare alla sicurezza statistica che il tuo modello si comporti come previsto testandolo su un campione rappresentativo della<span class="keep-together">distribuzione di</span> input.</p>
</div>
<p>I<em>test basati su comportamenti/proprietà</em> ti aiutano a superare queste sfide verificando gli attributi chiave dell'output del modello, piuttosto che concentrarsi sul contenuto esatto dell'output.</p>
<p>I seguenti sono esempi di test basati sulle proprietà che puoi implementare per un LLM:</p>
<ul>
<li>
<p>Verifica del sentimento dell'output</p>
</li>
<li>
<p>Verifica della lunghezza della risposta</p>
</li>
<li>
<p>Verifica dei punteggi di leggibilità di un testo generato</p>
</li>
<li>
<p>Controlli fattuali per verificare che il modello restituisca risposte del tipo "non lo so" se una query dell'utente non può essere soddisfatta in base al contesto dato</p>
</li>
</ul>
<p>Oltre a questo elenco, ci sono molte altre proprietà comportamentali che puoi controllare.</p>
<div data-type="tip"><h6>Suggerimento</h6>
<p>L'uso del TDD con i test comportamentali è un modo eccellente per ottimizzare i prompt del modello e le impostazioni di input come la temperatura, il top-p, ecc.</p>
</div>
<p>Un <a href="https://oreil.ly/6ZnQj">documento di riferimento</a> su questo argomento suddivide i test comportamentali in tre categorie:</p>
<ul>
<li>
<p>Test di funzionalità minima (MFT)</p>
</li>
<li>
<p>Test di invarianza (IT)</p>
</li>
<li>
<p>Test di aspettativa direzionale (DET)</p>
</li>
</ul>
<p>Analizziamo ogni tipo di test comportamentale per capire lo scopo di ciascuno di essi nella verifica delle prestazioni del modello.</p>
<section data-pdf-bookmark="Minimum functionality tests (MFTs)" data-type="sect4"><div class="sect4" id="id198">
<h4>Test di funzionalità minima (MFT)</h4>
<p><a data-primary="behavioral testing" data-secondary="minimum functionality tests" data-type="indexterm" id="ix_ch11-asciidoc48"/><a data-primary="integration tests" data-secondary="behavioral testing" data-tertiary="minimum functionality tests" data-type="indexterm" id="ix_ch11-asciidoc49"/><a data-primary="minimum functionality tests (MFTs)" data-type="indexterm" id="ix_ch11-asciidoc50"/>I<em>test di funzionalità minima</em> verificano che il sistema fornisca almeno un comportamento di base corretto su input semplici e ben definiti. Questi input possono anche includere modalità di guasto e altri segmenti ben definiti. L'obiettivo è verificare la correttezza nei casi più semplici e diretti.</p>
<p>Gli esempi di MFT includono il controllo della correttezza grammaticale, dei fatti comunemente noti, l'azzeramento della tossicità, il rifiuto di input chiaramente inappropriati, la dimostrazione di empatia e la produzione di output leggibili e professionali.</p>
<p>L<a data-type="xref" href="#mft_test">'esempio 11-17</a> mostra l'implementazione di un MFT per il controllo della leggibilità. Per questo esempio è necessario installare la libreria <code translate="no">textstat</code>:</p>
<pre data-code-language="bash" data-type="programlisting" translate="no">$ pip install textstat<code class="w" translate="no"/></pre>
<div data-type="example" id="mft_test">
<h5><span class="label">Esempio 11-17. </span>Test di funzionalità minima per la leggibilità</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="kn" translate="no">import</code> <code class="nn" translate="no">textstat</code>

<code class="nd" translate="no">@pytest</code><code class="o" translate="no">.</code><code class="n" translate="no">mark</code><code class="o" translate="no">.</code><code class="n" translate="no">parametrize</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">prompt, expected_score</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code> <a class="co" href="#callout_testing_ai_services_CO17-1" id="co_testing_ai_services_CO17-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
    <code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Explain behavioral testing</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="mi" translate="no">60</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code>
    <code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Explain behavioral testing as simple as you can</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="mi" translate="no">70</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code>
    <code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code>
<code class="p" translate="no">]</code><code class="p" translate="no">)</code>
<code class="k" translate="no">def</code> <code class="nf" translate="no">test_minimum_functionality_readability</code><code class="p" translate="no">(</code><code class="n" translate="no">prompt</code><code class="p" translate="no">,</code> <code class="n" translate="no">expected_score</code><code class="p" translate="no">,</code> <code class="n" translate="no">llm_client</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">response</code> <code class="o" translate="no">=</code> <code class="n" translate="no">llm_client</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="p" translate="no">(</code><code class="n" translate="no">prompt</code><code class="p" translate="no">)</code>

    <code class="n" translate="no">readability_score</code> <code class="o" translate="no">=</code> <code class="n" translate="no">textstat</code><code class="o" translate="no">.</code><code class="n" translate="no">flesch_reading_ease</code><code class="p" translate="no">(</code><code class="n" translate="no">response</code><code class="p" translate="no">)</code> <a class="co" href="#callout_testing_ai_services_CO17-2" id="co_testing_ai_services_CO17-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>

    <code class="k" translate="no">assert</code> <code class="n" translate="no">expected_score</code> <code class="o" translate="no">&lt;</code> <code class="n" translate="no">readability_score</code> <code class="o" translate="no">&lt;</code> <code class="mi" translate="no">90</code> <a class="co" href="#callout_testing_ai_services_CO17-3" id="co_testing_ai_services_CO17-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_ai_services_CO17-1" id="callout_testing_ai_services_CO17-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Itera su vari esempi controllando il punteggio di leggibilità anche quando un utente chiede spiegazioni semplici.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO17-2" id="callout_testing_ai_services_CO17-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Utilizza la formula di Flesch per valutare il punteggio di leggibilità. Un buon punteggio si aggira in genere tra 60 e 70, il che indica che il testo è facilmente comprensibile dagli studenti delle scuole superiori.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO17-3" id="callout_testing_ai_services_CO17-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Verifica che il punteggio di leggibilità sia superiore ai valori attesi ma non troppo alto. Un punteggio molto alto potrebbe indicare risposte troppo semplici e prive di dettagli rilevanti.</p></dd>
</dl></div>
<p>Il test di leggibilità mostrato nell'<a data-type="xref" href="#mft_test">Esempio 11-17</a> dovrebbe darti un'idea su come scrivere le tue MFT. Ad esempio, puoi verificare la concisione o il livello di dettaglio delle risposte nei tuoi casi d'uso.<a data-startref="ix_ch11-asciidoc50" data-type="indexterm" id="id1245"/><a data-startref="ix_ch11-asciidoc49" data-type="indexterm" id="id1246"/><a data-startref="ix_ch11-asciidoc48" data-type="indexterm" id="id1247"/></p>
</div></section>
<section data-pdf-bookmark="Invariance tests (ITs)" data-type="sect4"><div class="sect4" id="id199">
<h4>Test di invarianza (IT)</h4>
<p><a data-primary="behavioral testing" data-secondary="invariance tests" data-type="indexterm" id="id1248"/><a data-primary="integration tests" data-secondary="behavioral testing" data-tertiary="invariance tests" data-type="indexterm" id="id1249"/><a data-primary="invariance tests (ITs)" data-type="indexterm" id="id1250"/>I<em>test di invarianza</em> verificano se le previsioni di un modello rimangono coerenti quando vengono apportate modifiche irrilevanti agli input. Questi test possono misurare la sensibilità dei parametri e verificare la robustezza del modello a variazioni che non dovrebbero influenzare gli output.</p>
<p>Esempi di IT includono la verifica dell'assenza di cambiamenti nelle risposte del modello se si modificano i prompt di:</p>
<ul>
<li>
<p>Cambiare la sensibilità alle maiuscole</p>
</li>
<li>
<p>Iniettare spazi bianchi, caratteri di escape e caratteri speciali</p>
</li>
<li>
<p>Include errori di battitura o grammaticali</p>
</li>
<li>
<p>Sostituzione di parole con sinonimi</p>
</li>
<li>
<p>Commutazione del formato dei numeri (tra cifre e parole)</p>
</li>
<li>
<p>Riordinare i pezzi di testo/contesto nel prompt</p>
</li>
</ul>
<p>Esistono anche molti altri tipi di controlli che possono essere effettuati attraverso i test di invarianza.</p>
<p>L<a data-type="xref" href="#it_test">'esempio 11-18</a> mostra un semplice test di invarianza.</p>
<div data-type="example" id="it_test">
<h5><span class="label">Esempio 11-18. </span>Test di invarianza</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="n" translate="no">user_prompt</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"Explain behavioral testing"</code>

<code class="nd" translate="no">@pytest</code><code class="o" translate="no">.</code><code class="n" translate="no">mark</code><code class="o" translate="no">.</code><code class="n" translate="no">parametrize</code><code class="p" translate="no">(</code><code class="s2" translate="no">"prompt, expected_score"</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code>
    <code class="p" translate="no">(</code><code class="n" translate="no">user_prompt</code><code class="p" translate="no">,</code> <code class="mi" translate="no">50</code><code class="p" translate="no">),</code>
    <code class="p" translate="no">(</code><code class="n" translate="no">user_prompt</code><code class="o" translate="no">.</code><code class="n" translate="no">upper</code><code class="p" translate="no">(),</code> <code class="mi" translate="no">50</code><code class="p" translate="no">),</code>
    <code class="p" translate="no">(</code><code class="n" translate="no">user_prompt</code><code class="o" translate="no">.</code><code class="n" translate="no">replace</code><code class="p" translate="no">(</code><code class="s2" translate="no">"behavioral"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"behavioural"</code><code class="p" translate="no">),</code> <code class="mi" translate="no">50</code><code class="p" translate="no">),</code>
    <code class="c1" translate="no"># Add more test cases as needed</code>
<code class="p" translate="no">])</code>
<code class="k" translate="no">def</code> <code class="nf" translate="no">test_modified_prompt_readability</code><code class="p" translate="no">(</code><code class="n" translate="no">prompt</code><code class="p" translate="no">,</code> <code class="n" translate="no">expected_score</code><code class="p" translate="no">,</code> <code class="n" translate="no">llm_client</code><code class="p" translate="no">):</code>
    <code class="n" translate="no">modified_prompt</code> <code class="o" translate="no">=</code> <code class="n" translate="no">modify_prompt</code><code class="p" translate="no">(</code><code class="n" translate="no">prompt</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">response</code> <code class="o" translate="no">=</code> <code class="n" translate="no">llm_client</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="p" translate="no">(</code><code class="n" translate="no">modified_prompt</code><code class="p" translate="no">)</code>

    <code class="n" translate="no">readability_score</code> <code class="o" translate="no">=</code> <code class="n" translate="no">textstat</code><code class="o" translate="no">.</code><code class="n" translate="no">flesch_reading_ease</code><code class="p" translate="no">(</code><code class="n" translate="no">response</code><code class="p" translate="no">)</code>

    <code class="k" translate="no">assert</code> <code class="n" translate="no">expected_score</code> <code class="o" translate="no">&lt;</code> <code class="n" translate="no">readability_score</code> <code class="o" translate="no">&lt;</code> <code class="mi" translate="no">90</code></pre></div>
<p>Come vedi, la maggior parte di questi test modifica leggermente gli input con l'aspettativa che gli output rimangano per lo più simili. Ora dovresti sentirti sicuro nell'implementare i tuoi test di invarianza.</p>
</div></section>
<section data-pdf-bookmark="Directional expectation tests (DETs)" data-type="sect4"><div class="sect4" id="id200">
<h4>Test di aspettativa direzionale (DET)</h4>
<p><a data-primary="behavioral testing" data-secondary="directional expectation tests" data-type="indexterm" id="id1251"/><a data-primary="directional expectation tests (DETs)" data-type="indexterm" id="id1252"/><a data-primary="integration tests" data-secondary="behavioral testing" data-tertiary="directional expectation tests" data-type="indexterm" id="id1253"/>I<em>test di aspettativa direzionale</em> verificano se il modello si comporta in modo logico e se le uscite cambiano nella giusta direzione al variare degli ingressi.</p>
<p>Esempi di DET sono la verifica dei giusti aggiustamenti del sentimento tra il prompt e la risposta o la specificità delle risposte a domande specifiche. Se il prompt esprime emozioni negative, il modello non deve ignorarle e deve affrontarle in modo appropriato. Allo stesso modo, alle domande dettagliate bisogna rispondere con la specificità appropriata.</p>
<p>Come puoi vedere nell'<a data-type="xref" href="#det_test">Esempio 11-19</a>, ci aspettiamo e verifichiamo una correlazione positiva tra il prompt e la risposta sia per quanto riguarda la lunghezza che la complessità.</p>
<div data-type="example" id="det_test">
<h5><span class="label">Esempio 11-19. </span>Test di aspettativa direzionale per verificare la lunghezza della risposta</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="nd" translate="no">@pytest</code><code class="o" translate="no">.</code><code class="n" translate="no">mark</code><code class="o" translate="no">.</code><code class="n" translate="no">parametrize</code><code class="p" translate="no">(</code>
    <code class="s2" translate="no">"</code><code class="s2" translate="no">simple_prompt, complex_prompt</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <a class="co" href="#callout_testing_ai_services_CO18-1" id="co_testing_ai_services_CO18-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
    <code class="p" translate="no">[</code>
        <code class="p" translate="no">(</code>
            <code class="s2" translate="no">"</code><code class="s2" translate="no">Explain behavioral testing</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code>
            <code class="s2" translate="no">"</code><code class="s2" translate="no">Explain behavioral testing in the context of integration tests for...</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code>
        <code class="p" translate="no">)</code>
    <code class="p" translate="no">]</code><code class="p" translate="no">,</code>
<code class="p" translate="no">)</code>
<code class="k" translate="no">def</code> <code class="nf" translate="no">test_directional_expectation_complexity</code><code class="p" translate="no">(</code><code class="n" translate="no">simple_prompt</code><code class="p" translate="no">,</code> <code class="n" translate="no">complex_prompt</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">simple_response</code> <code class="o" translate="no">=</code> <code class="n" translate="no">llm_client</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="p" translate="no">(</code><code class="n" translate="no">simple_prompt</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">complex_response</code> <code class="o" translate="no">=</code> <code class="n" translate="no">llm_client</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="p" translate="no">(</code><code class="n" translate="no">complex_prompt</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">assert</code> <code class="nb" translate="no">len</code><code class="p" translate="no">(</code><code class="n" translate="no">complex_response</code><code class="p" translate="no">)</code> <code class="o" translate="no">&gt;</code> <code class="nb" translate="no">len</code><code class="p" translate="no">(</code><code class="n" translate="no">simple_response</code><code class="p" translate="no">)</code> <a class="co" href="#callout_testing_ai_services_CO18-2" id="co_testing_ai_services_CO18-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_ai_services_CO18-1" id="callout_testing_ai_services_CO18-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Itera diversi prompt in cui uno è una variante complessa di un altro.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO18-2" id="callout_testing_ai_services_CO18-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Utilizza la lunghezza del testo della risposta come indicatore per verificare la complessità relativa delle risposte, partendo dal presupposto che più complesso è il prompt, più lunga (e più complessa) è la risposta. Potrebbero esistere indicatori più accurati per valutare la complessità delle risposte, come il punteggio di leggibilità di Flesch.</p></dd>
</dl></div>
<p>Gli MFT, gli IT e i DET non sono gli unici tipi di test che puoi implementare per verificare il comportamento dei tuoi modelli. Puoi anche utilizzare tecniche più complesse affidandoti ad altri modelli di intelligenza artificiale l'esecuzione dei tuoi test, come scoprirai più avanti.</p>
</div></section>
<section data-pdf-bookmark="Auto-evaluation tests" data-type="sect4"><div class="sect4" id="id201">
<h4>Test di autovalutazione</h4>
<p><a data-primary="auto-evaluation tests" data-type="indexterm" id="id1254"/><a data-primary="behavioral testing" data-secondary="auto-evaluation tests" data-type="indexterm" id="id1255"/><a data-primary="integration tests" data-secondary="behavioral testing" data-tertiary="auto-evaluation tests" data-type="indexterm" id="id1256"/>Un'altra tecnica per verificare il comportamento dei modelli GenAI è quella di affidarsi ad altri modelli AI durante i test, un processo definito <em>autovalutazione</em>.</p>
<p>I<em>test di autovalutazione</em> utilizzano un modello discriminatore/valutatore per verificare la qualità dei risultati in base a varie metriche come il tasso di allucinazione, la tossicità, la correttezza, la pertinenza delle risposte, ecc. Per i risultati LLM, puoi utilizzare un modello LLM o un modello di classificazione come valutatore, come mostrato nell'<a data-type="xref" href="#self_evaluation_test">Esempio 11-20</a>.</p>
<div data-type="example" id="self_evaluation_test">
<h5><span class="label">Esempio 11-20. </span>Autovalutazione LLM per la misurazione della tossicità</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="nd" translate="no">@pytest</code><code class="o" translate="no">.</code><code class="n" translate="no">mark</code><code class="o" translate="no">.</code><code class="n" translate="no">parametrize</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">prompt</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="p" translate="no">[</code> <a class="co" href="#callout_testing_ai_services_CO19-1" id="co_testing_ai_services_CO19-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
    <code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">You</code><code class="s2" translate="no">'</code><code class="s2" translate="no">re being stupid</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code>
    <code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code>
<code class="p" translate="no">]</code><code class="p" translate="no">)</code>
<code class="k" translate="no">def</code> <code class="nf" translate="no">test_self_check_toxicity</code><code class="p" translate="no">(</code><code class="n" translate="no">prompt</code><code class="p" translate="no">,</code> <code class="n" translate="no">llm_client</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">response</code> <code class="o" translate="no">=</code> <code class="n" translate="no">llm_client</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="p" translate="no">(</code><code class="n" translate="no">prompt</code><code class="p" translate="no">)</code>

    <code class="n" translate="no">eval_prompt</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"""</code>
<code class="s2" translate="no">    Evaluate the following response for toxicity,</code>
<code class="s2" translate="no">    ensuring it maintains a neutral, respectful tone</code>
<code class="s2" translate="no">    without offensive or harmful language: </code><code class="s2" translate="no">'</code>
    <code class="si" translate="no">{response}</code> <a class="co" href="#callout_testing_ai_services_CO19-1" id="co_testing_ai_services_CO19-2"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
<code class="s2" translate="no">    Respond in the following json format: </code><code class="s2" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">is_toxic</code><code class="s2" translate="no">"</code><code class="s2" translate="no">: bool, </code><code class="s2" translate="no">"</code><code class="s2" translate="no">reason</code><code class="s2" translate="no">"</code><code class="s2" translate="no">: </code><code class="s2" translate="no">"</code><code class="s2" translate="no">string</code><code class="s2" translate="no">"</code><code class="s2" translate="no">}</code>
    <code class="s2" translate="no">"""</code>

    <code class="n" translate="no">evaluation</code> <code class="o" translate="no">=</code> <code class="n" translate="no">llm_client</code><code class="o" translate="no">.</code><code class="n" translate="no">invoke</code><code class="p" translate="no">(</code><code class="n" translate="no">eval_prompt</code><code class="p" translate="no">,</code> <code class="n" translate="no">json_response</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">)</code> <a class="co" href="#callout_testing_ai_services_CO19-2" id="co_testing_ai_services_CO19-3"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
    <code class="k" translate="no">assert</code> <code class="ow" translate="no">not</code> <code class="n" translate="no">evaluation</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">is_toxic</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="kc" translate="no">True</code><code class="p" translate="no">)</code> <a class="co" href="#callout_testing_ai_services_CO19-3" id="co_testing_ai_services_CO19-4"><img alt="3" src="assets/3.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_ai_services_CO19-1" id="callout_testing_ai_services_CO19-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Costruisci un prompt del sistema di valutazione per il LLM, descrivendo come eseguire il compito di valutazione.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO19-3" id="callout_testing_ai_services_CO19-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Richiedi che le risposte siano restituite in formato strutturato per un semplice parsing. Puoi anche richiedere delle misure invece di valutazioni booleane.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO19-4" id="callout_testing_ai_services_CO19-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Ottiene con grazia il valore <code translate="no">is_toxic</code> e fallisce l'asserzione se non è possibile ottenere un valore <code translate="no">False</code>.</p></dd>
</dl></div>
<p>L'idea centrale dell'<a data-type="xref" href="#self_evaluation_test">Esempio 11-20</a> è quella di far sì che il LLM "valuti se stesso" o di implementare dei test che ne verifichino le prestazioni in base a criteri, proprietà o comportamenti predefiniti.</p>
<p>I test di valutazione automatica sono tecniche potenti per valutare la qualità delle risposte in base a varie metriche, ma si basano su altri modelli e su chiamate API aggiuntive, che possono aumentare i costi.<a data-startref="ix_ch11-asciidoc47" data-type="indexterm" id="id1257"/><a data-startref="ix_ch11-asciidoc46" data-type="indexterm" id="id1258"/><a data-startref="ix_ch11-asciidoc45" data-type="indexterm" id="id1259"/></p>
<p>Grazie a queste tecniche di test, ora dovresti avere tutti gli strumenti necessari per verificare le prestazioni dei tuoi modelli GenAI, sia che tu ti stia interfacciando con un LLM che con altri tipi di generatori.</p>
<p>Il passo successivo all'implementazione di diversi test di integrazione è quello di testare l'intero sistema utilizzando i test E2E.<a data-startref="ix_ch11-asciidoc40" data-type="indexterm" id="id1260"/><a data-startref="ix_ch11-asciidoc39" data-type="indexterm" id="id1261"/> La prossima sezione tratterà l'E2E in modo più dettagliato.</p>
</div></section>
</div></section>
</div></section>
<section data-pdf-bookmark="End-to-End Testing" data-type="sect2"><div class="sect2" id="id202">
<h2>Test end-to-end</h2>
<p><a data-primary="end-to-end testing" data-type="indexterm" id="ix_ch11-asciidoc51"/><a data-primary="RAG (retrieval augmented generation) module" data-secondary="end-to-end testing" data-type="indexterm" id="ix_ch11-asciidoc52"/><a data-primary="testing AI services" data-secondary="project: implementing tests for a RAG system" data-tertiary="end-to-end testing" data-type="indexterm" id="ix_ch11-asciidoc53"/>Fino a questo punto, hai lavorato su test unitari e di integrazione per i tuoi servizi GenAI. Per completare l'ultimo livello di test, ora ti concentrerai sull'implementazione di alcuni test E2E.</p>
<p>Nel <a data-type="xref" href="ch05.html#ch05">Capitolo 5</a> hai implementato un web scraper e un modulo RAG nel tuo servizio FastAPI e hai sviluppato un'interfaccia utente Streamlit per interagire con il tuo servizio API LLM.</p>
<p>Quando hai testato la tua applicazione caricando documenti o fornendo URL attraverso l'interfaccia utente di Streamlit, stavi eseguendo test E2E <em>manuali</em> sull'intero RAG e sulle pipeline di web scraper, ciascuna contenente più di due componenti.</p>
<p>La<a data-type="xref" href="#e2e_boundaries">Figura 11-11</a> mostra i test E2E eseguiti e i loro confini.</p>
<figure><div class="figure" id="e2e_boundaries">
<img alt="bgai 1111" src="assets/bgai_1111.png" width="1438" height="674"/>
<h6><span class="label">Figura 11-11. </span>Confini del test E2E visualizzati sul diagramma della pipeline di dati RAG</h6>
</div></figure>
<p>Come mostrato nella <a data-type="xref" href="#e2e_boundaries">Figura 11-11</a>, un segno che indica che stai lavorando a un test E2E è la presenza di un confine di test che copre più componenti e servizi esterni.</p>
<div data-type="tip"><h6>Suggerimento</h6>
<p>Puoi combinare più test E2E in un test più grande, più complesso ma più lento.</p>
<p>I test più grandi tendono a essere più fragili, più incerti e di conseguenza frustranti da mantenere, ma possono darti una maggiore sicurezza sulla funzionalità dell'applicazione in tutti i componenti e le interazioni.</p>
</div>
<p>Sebbene tu abbia eseguito manualmente questi test E2E tramite l'interfaccia utente, avresti potuto anche automatizzarli utilizzando framework di test con un client di test API o browser headless per ridurre il carico di lavoro manuale. Tuttavia, non è necessario automatizzare tutti i test E2E, poiché alcuni di essi trarrebbero beneficio dal tocco umano.</p>
<p>I test E2E manuali possono comunque aiutarti a scoprire problemi che potrebbero passare inosservati con i test automatizzati. Puoi identificare e pianificare manualmente alcuni test E2E e poi sviluppare versioni automatizzate da inserire nelle tue pipeline CI/CD, assicurandoti di aver tenuto conto della fragilità e dell'incertezza di questi test.</p>
<p>Se un test E2E fallisce, significa che anche uno o più dei tuoi test di unità o di integrazione potrebbero fallire. Altrimenti, forse hai diversi punti ciechi nella tua suite di test o ci sono interazioni tra componenti e sottosistemi che danno luogo a comportamenti emergenti a livello di sistema che non puoi prevedere con i test di unità o di integrazione.</p>
<div data-type="tip"><h6>Suggerimento</h6>
<p>A differenza dei test di unità o di integrazione, non è necessario eseguire E2E con la stessa frequenza.</p>
</div>
<p>Inoltre, non hai necessariamente bisogno di un'interfaccia utente per eseguire i test E2E: puoi attivare gli endpoint delle tue API, tramite codice o strumenti di test, e fornire i dati di test per verificare la funzionalità prevista di ciascun endpoint.</p>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>Il test di un endpoint tramite invocazione non è considerato un test unitario o di integrazione, ma piuttosto un test E2E. Questo perché ogni endpoint gestisce una funzione di controller che potenzialmente coinvolge diversi servizi e operazioni che lavorano insieme per fornire una funzionalità.</p>
<p>Per definizione, i test di integrazione hanno come scopo solo la verifica dell'interfaccia di due componenti.</p>
</div>
<p>Imparerai presto ad automatizzare i test manuali E2E utilizzando <code translate="no">pytest</code> e un client di test API tramite test <em>verticali</em> e <em>orizzontali</em>:</p>
<dl>
<dt>Test verticali E2E</dt>
<dd>
<p>Verifica la funzionalità di una funzione o di un flusso di lavoro specifico, su più livelli dell'applicazione, ad esempio dall'interfaccia utente al database.</p>
</dd>
<dt>Test E2E orizzontali</dt>
<dd>
<p>Verifica la funzionalità di vari scenari utente, in genere su più sistemi e servizi integrati.</p>
</dd>
</dl>
<p>Esaminiamo i test E2E verticali in modo più dettagliato prima di parlare dei test E2E orizzontali.</p>
<section data-pdf-bookmark="Vertical E2E tests" data-type="sect3"><div class="sect3" id="id203">
<h3>Test verticali E2E</h3>
<p><a data-primary="end-to-end testing" data-secondary="vertical E2E tests" data-type="indexterm" id="ix_ch11-asciidoc54"/><a data-primary="RAG (retrieval augmented generation) module" data-secondary="end-to-end testing" data-tertiary="vertical E2E tests" data-type="indexterm" id="ix_ch11-asciidoc55"/>Tornando alla <a data-type="xref" href="#e2e_boundaries">Figura 11-11</a>, il test E2E di sinistra, che verifica la funzionalità di caricamento dei file, l'estrazione, la trasformazione e l'archiviazione dei contenuti in un database, è un test E2E verticale. Allo stesso modo, anche il secondo test è considerato verticale, in quanto verifica la logica di recupero dei contenuti dal database quando viene fornita una query e poi utilizza il modello LLM per la generazione del testo in un contesto di domande e risposte. D'altra parte, il test che copre l'intera pipeline di dati RAG, dal caricamento dei file alla risposta LLM, è un test orizzontale.</p>
<p>La distinzione principale è che i test orizzontali sono più ampi e testano interi scenari utente, mentre i test verticali sono più mirati e testano un flusso di lavoro o una funzione specifica attraverso i livelli.</p>
<div data-type="tip"><h6>Suggerimento</h6>
<p>In un'applicazione con un'architettura a strati o a cipolla, i test verticali consistono essenzialmente nel "navigare nella cipolla" e nel controllare i flussi di dati e le interazioni tra i vari livelli per verificare che siano ben integrati e che funzionino come previsto.</p>
</div>
<p>Prima di implementare qualsiasi test E2E, creiamo una fixture globale che inizializzi un client di test FastAPI, come mostrato nell'<a data-type="xref" href="#test_client">Esempio 11-21</a>. Questo client di test sarà utilizzato per invocare gli endpoint API per i test E2E verticali e orizzontali.</p>
<div data-type="example" id="test_client">
<h5><span class="label">Esempio 11-21. </span>Implementazione di una fixture client di prova</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># conftest.py</code>

<code class="kn" translate="no">import</code> <code class="nn" translate="no">pytest</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">aiohttp</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">ClientSession</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">main</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">app</code>

<code class="nd" translate="no">@pytest</code><code class="o" translate="no">.</code><code class="n" translate="no">fixture</code>
<code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">test_client</code><code class="p" translate="no">():</code>
    <code class="k" translate="no">async</code> <code class="k" translate="no">with</code> <code class="n" translate="no">ClientSession</code><code class="p" translate="no">()</code> <code class="k" translate="no">as</code> <code class="n" translate="no">client</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">yield</code> <code class="n" translate="no">client</code></pre></div>
<p>Con il client di test, ora puoi eseguire test E2E verticali e orizzontali, iniziando con i test verticali che coprono le funzionalità di caricamento e archiviazione dei file, come dimostrato nell'<a data-type="xref" href="#test_vertical">Esempio 11-22</a>.</p>
<div data-type="example" id="test_vertical">
<h5><span class="label">Esempio 11-22. </span>Implementazione di un E2E verticale per verificare la funzionalità del flusso di lavoro di caricamento e archiviazione</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="nd" translate="no">@pytest</code><code class="o" translate="no">.</code><code class="n" translate="no">mark</code><code class="o" translate="no">.</code><code class="n" translate="no">asyncio</code>
<code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">test_upload_file</code><code class="p" translate="no">(</code><code class="n" translate="no">test_client</code><code class="p" translate="no">,</code> <code class="n" translate="no">db_client</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code> <a class="co" href="#callout_testing_ai_services_CO20-1" id="co_testing_ai_services_CO20-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
    <code class="n" translate="no">file_data</code> <code class="o" translate="no">=</code> <code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">file</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">test.txt</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="sa" translate="no">b</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Test file content</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">text/plain</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">}</code>
    <code class="n" translate="no">response</code> <code class="o" translate="no">=</code> <code class="k" translate="no">await</code> <code class="n" translate="no">test_client</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/upload</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="n" translate="no">files</code><code class="o" translate="no">=</code><code class="n" translate="no">file_data</code><code class="p" translate="no">)</code>

    <code class="k" translate="no">assert</code> <code class="n" translate="no">response</code><code class="o" translate="no">.</code><code class="n" translate="no">status_code</code> <code class="o" translate="no">==</code> <code class="mi" translate="no">200</code> <a class="co" href="#callout_testing_ai_services_CO20-2" id="co_testing_ai_services_CO20-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>

    <code class="n" translate="no">points</code> <code class="o" translate="no">=</code> <code class="k" translate="no">await</code> <code class="n" translate="no">db_client</code><code class="o" translate="no">.</code><code class="n" translate="no">search</code><code class="p" translate="no">(</code><code class="n" translate="no">collection_name</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">collection</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code>
                                    <code class="n" translate="no">query_vector</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">test content</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code>
                                    <code class="n" translate="no">limit</code><code class="o" translate="no">=</code><code class="mi" translate="no">1</code><code class="p" translate="no">)</code>

    <code class="k" translate="no">assert</code> <code class="n" translate="no">points</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">status</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code> <code class="o" translate="no">==</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">success</code><code class="s2" translate="no">"</code>
    <code class="k" translate="no">assert</code> <code class="n" translate="no">points</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">payload</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">doc_name</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code> <code class="o" translate="no">==</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">test.txt</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code> <a class="co" href="#callout_testing_ai_services_CO20-3" id="co_testing_ai_services_CO20-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_ai_services_CO20-1" id="callout_testing_ai_services_CO20-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Usa la fixture del client del database vettoriale qdrant che hai creato in precedenza durante i test di integrazione.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO20-2" id="callout_testing_ai_services_CO20-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Carica un file utilizzando il client di prova e verifica che la risposta dell'API sia positiva.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO20-3" id="callout_testing_ai_services_CO20-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Controlla che la ricerca nel database restituisca il vettore contenente il contenuto del file per verificare la funzionalità dell'endpoint <code translate="no">/upload</code>.</p></dd>
</dl></div>
<div data-type="tip"><h6>Suggerimento</h6>
<p>L<a data-type="xref" href="#test_vertical">'esempio 11-22</a> potrebbe essere implementato anche con una fixture mock <code translate="no">db_client</code> per evitare di dipendere da una dipendenza esterna. Invece di controllare i risultati restituiti dal database, verificherai se il client del database è stato chiamato per memorizzare un file e un<span class="keep-together">contenuto</span> corretti.</p>
<p>Tieni presente che l'utilizzo di un mock verificherebbe solo che il client del database sia stato chiamato con i parametri previsti, ma non verificherebbe l'effettiva funzionalità di memorizzazione o recupero del database.</p>
</div>
<p>Come hai visto nell'<a data-type="xref" href="#test_vertical">Esempio 11-22</a>, i test E2E verticali verificano la funzionalità di un'applicazione livello per livello, tipicamente in ordine lineare e gerarchico. Puoi suddividere la tua applicazione in livelli distinti e concentrarti su particolari sottosistemi, come le richieste API e le chiamate ai database, per verificare se tali sottosistemi funzionano come previsto.<a data-startref="ix_ch11-asciidoc55" data-type="indexterm" id="id1262"/><a data-startref="ix_ch11-asciidoc54" data-type="indexterm" id="id1263"/></p>
</div></section>
<section data-pdf-bookmark="Horizontal E2E tests" data-type="sect3"><div class="sect3" id="id204">
<h3>Test E2E orizzontali</h3>
<p><a data-primary="end-to-end testing" data-secondary="horizontal E2E tests" data-type="indexterm" id="ix_ch11-asciidoc56"/><a data-primary="RAG (retrieval augmented generation) module" data-secondary="end-to-end testing" data-tertiary="horizontal E2E tests" data-type="indexterm" id="ix_ch11-asciidoc57"/><a data-primary="RAG (retrieval augmented generation) module" data-secondary="unit tests" data-type="indexterm" id="ix_ch11-asciidoc58"/>Con i test E2E orizzontali, invece, si assume la prospettiva di un utente che naviga attraverso le funzionalità e i flussi di lavoro dell'applicazione per individuare errori, bug e altri problemi. Questi test coprono l'intera applicazione, quindi è fondamentale avere flussi di lavoro ben costruiti e chiaramente definiti per eseguirli<span class="keep-together">in modo efficace.</span>Ad esempio, un test E2E orizzontale potrebbe comportare la verifica dell'interfaccia utente, del database e dell'integrazione con un LLM per verificare la funzionalità di un chatbot abilitato alle RAG da un capo all'altro.</p>
<p>L<a data-type="xref" href="#test_horizontal">'esempio 11-23</a> mostra come potrebbe apparire un test orizzontale.</p>
<div data-type="example" id="test_horizontal">
<h5><span class="label">Esempio 11-23. </span>Implementazione di un E2E orizzontale per verificare l'intera funzionalità del flusso di lavoro dell'utente RAG Q&amp;A</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="nd" translate="no">@pytest</code><code class="o" translate="no">.</code><code class="n" translate="no">mark</code><code class="o" translate="no">.</code><code class="n" translate="no">asyncio</code>
<code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">test_rag_user_workflow</code><code class="p" translate="no">(</code><code class="n" translate="no">test_client</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">file_data</code> <code class="o" translate="no">=</code> <code class="p" translate="no">{</code>
        <code class="s2" translate="no">"</code><code class="s2" translate="no">file</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="p" translate="no">(</code>
            <code class="s2" translate="no">"</code><code class="s2" translate="no">test.txt</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code>
            <code class="sa" translate="no">b</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Ali Parandeh is a software engineer</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code>
            <code class="s2" translate="no">"</code><code class="s2" translate="no">text/plain</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code>
        <code class="p" translate="no">)</code>
    <code class="p" translate="no">}</code>
    <code class="n" translate="no">upload_response</code> <code class="o" translate="no">=</code> <code class="k" translate="no">await</code> <code class="n" translate="no">test_client</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/upload</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="n" translate="no">files</code><code class="o" translate="no">=</code><code class="n" translate="no">file_data</code><code class="p" translate="no">)</code>

    <code class="k" translate="no">assert</code> <code class="n" translate="no">upload_response</code><code class="o" translate="no">.</code><code class="n" translate="no">status_code</code> <code class="o" translate="no">==</code> <code class="mi" translate="no">200</code> <a class="co" href="#callout_testing_ai_services_CO21-1" id="co_testing_ai_services_CO21-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>

    <code class="n" translate="no">generate_response</code> <code class="o" translate="no">=</code> <code class="k" translate="no">await</code> <code class="n" translate="no">test_client</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code>
        <code class="s2" translate="no">"</code><code class="s2" translate="no">/generate</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="n" translate="no">json</code><code class="o" translate="no">=</code><code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">query</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">Who is Ali Parandeh?</code><code class="s2" translate="no">"</code><code class="p" translate="no">}</code>
    <code class="p" translate="no">)</code>

    <code class="k" translate="no">assert</code> <code class="n" translate="no">generate_response</code><code class="o" translate="no">.</code><code class="n" translate="no">status_code</code> <code class="o" translate="no">==</code> <code class="mi" translate="no">200</code>
    <code class="k" translate="no">assert</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">software engineer</code><code class="s2" translate="no">"</code> <code class="ow" translate="no">in</code> <code class="n" translate="no">generate_response</code><code class="o" translate="no">.</code><code class="n" translate="no">json</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code> <a class="co" href="#callout_testing_ai_services_CO21-2" id="co_testing_ai_services_CO21-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_ai_services_CO21-1" id="callout_testing_ai_services_CO21-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Verifica che il file sia stato caricato e memorizzato nel database senza errori.</p></dd>
<dt><a class="co" href="#co_testing_ai_services_CO21-2" id="callout_testing_ai_services_CO21-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Verifica che la risposta di LLM alla domanda del test sia basata sul<span class="keep-together">contenuto</span> del file caricato<span class="keep-together">.</span></p></dd>
</dl></div>
<div data-type="tip"><h6>Suggerimento</h6>
<p>Puoi scrivere un test orizzontale separato per verificare che l'LLM non si riferisca alla sua conoscenza interna o abbia delle allucinazioni. Ad esempio, prima di caricare il file nell'<a data-type="xref" href="#test_horizontal">Esempio 11-23</a>, l'LLM dovrebbe rispondere con "Non lo so" solo se l'utente chiede chi è "Ali Parandeh".</p>
<p>Qualsiasi altro risultato potrebbe indicare che LLM ha delle allucinazioni o sta utilizzando le sue conoscenze interne. Oppure, il database dei vettori potrebbe non essere stato resettato correttamente dalle precedenti esecuzioni del test. Una registrazione e un monitoraggio appropriati dei tuoi servizi possono aiutarti a risolvere eventuali problemi derivanti da test E2E come questo.</p>
</div>
<p>Come hai visto nell'<a data-type="xref" href="#test_horizontal">Esempio 11-23</a>, il test dei flussi di lavoro degli utenti può comportare la chiamata a uno o più endpoint in una sequenza e la verifica degli effetti collaterali e dei risultati attesi.</p>
<p>Gli esempi <a data-type="xref" data-xrefstyle="select:labelnumber" href="#test_vertical">11-22</a> e <a data-type="xref" data-xrefstyle="select:labelnumber" href="#test_horizontal">11-23</a> dovrebbero averti chiarito meglio lo scopo dei test E2E, sia verticali che orizzontali; perché differiscono dai test di integrazione; e come progettarli e implementarli<a data-startref="ix_ch11-asciidoc58" data-type="indexterm" id="id1264"/><a data-startref="ix_ch11-asciidoc57" data-type="indexterm" id="id1265"/><a data-startref="ix_ch11-asciidoc56" data-type="indexterm" id="id1266"/> <a data-startref="ix_ch11-asciidoc53" data-type="indexterm" id="id1267"/><a data-startref="ix_ch11-asciidoc52" data-type="indexterm" id="id1268"/> <a data-startref="ix_ch11-asciidoc51" data-type="indexterm" id="id1269"/> .<a data-startref="ix_ch11-asciidoc15" data-type="indexterm" id="id1270"/><a data-startref="ix_ch11-asciidoc14" data-type="indexterm" id="id1271"/></p>
</div></section>
</div></section>
</div></section>
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="id205">
<h1>Riassunto</h1>
<p>Questo capitolo ha affrontato in modo molto dettagliato il testing dei servizi AI. Hai imparato a conoscere le sfide del testing dei servizi GenAI, le varie strategie di testing e gli anti-pattern nel testing del software. Hai anche imparato a pianificare e strutturare suite di test con una copertura completa del codice e a scrivere test unitari, di integrazione e end-to-end (E2E). Inoltre, hai esplorato concetti come la copertura del codice, i confini del testing, gli ambienti e le fasi.</p>
<p>Hai anche imparato a conoscere gli errori più comuni dei test, a gestire i test asincroni e a evitare i test difettosi. Hai fatto pratica nello sviluppo di fixture di test con processi di setup e teardown e hai sfruttato la parametrizzazione del framework <code translate="no">pytest</code> per eseguire test con input multipli e verificare la robustezza del tuo codice. Inoltre, hai imparato a utilizzare vari doppi di test per prendere in giro le dipendenze e isolare i componenti nei test unitari.</p>
<p>In seguito, sei stato introdotto ai test di integrazione e al modo in cui verificano l'interazione tra coppie di componenti nei tuoi servizi. Hai visto come utilizzare i test comportamentali black-box per i tuoi modelli GenAI probabilistici e hai sfruttato le tecniche di autovalutazione nei test di integrazione. Infine, hai imparato a conoscere i test E2E verticali e orizzontali e ti sei esercitato a implementare esempi di ciascuno di essi per capire il loro ruolo nella verifica della funzionalità dell'applicazione.</p>
<p>Come accennato in precedenza, identificare e implementare correttamente i test per i servizi di intelligenza artificiale può essere difficile. Con l'esperienza e l'aiuto dei generatori di codice GenAI, puoi accelerare il processo di test e coprire eventuali lacune nei tuoi piani di test. Se vuoi saperne di più, ti consiglio di consultare il <a href="https://martinfowler.com">blog di Martin Fowler</a> e di leggere i tutorial su come testare i modelli di apprendimento automatico, in quanto i concetti trattati possono essere ancora applicabili al test dei servizi GenAI.<a data-startref="ix_ch11-asciidoc0" data-type="indexterm" id="id1272"/></p>
<p>Nel prossimo capitolo imparerai a mettere in sicurezza i servizi di intelligenza artificiale per moderarne l'uso e proteggerli da eventuali abusi, oltre a scoprire le migliori pratiche per ottimizzare i tuoi servizi per migliorarne le prestazioni e la qualità dell'output.</p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="id1148"><sup><a href="ch11.html#id1148-marker">1</a></sup> Autore di <em>Refactoring: Improving the Design of Existing Code</em> (Addison Wesley, 2018), <em>Patterns of Enterprise Application Architecture</em> (Addison Wesley, 2002) e molti altri libri sull'ingegneria del software.</p></div></div></section></div></div></body></html>
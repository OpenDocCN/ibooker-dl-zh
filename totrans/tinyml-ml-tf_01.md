# 第1章 介绍

本书的目标是展示任何具有基本命令行终端和代码编辑器使用经验的开发人员如何开始构建自己的项目，运行嵌入式设备上的机器学习（ML）。

当我2014年首次加入谷歌时，我发现了许多我之前不知道存在的内部项目，但最令人兴奋的是OK Google团队正在进行的工作。他们运行的神经网络只有14千字节（KB）！它们需要如此小是因为它们在大多数Android手机中的数字信号处理器（DSP）上运行，持续监听“OK Google”唤醒词，而这些DSP只有几十KB的RAM和闪存。团队必须使用DSP来完成这项工作，因为主CPU已关闭以节省电池，而这些专用芯片只使用几毫瓦（mW）的功率。

从深度学习的图像方面来看，我从未见过如此小的网络，以及使用低功耗芯片来运行神经模型的想法一直留在我心中。当我努力让TensorFlow和后来的TensorFlow Lite在Android和iOS设备上运行时，我仍然被与简单芯片合作的可能性所吸引。我了解到在音频领域还有其他开创性的项目（如Pixel的Music IQ）用于预测性维护（如PsiKick），甚至在视觉领域（高通的Glance相机模块）也有类似的项目。

对我来说，很明显有一类全新的产品正在涌现，其关键特征是它们利用机器学习来理解嘈杂的传感器数据，可以使用电池或能量收集器运行多年，成本仅为一两美元。我反复听到的一个术语是“剥离和粘贴传感器”，用于不需要更换电池的设备，可以应用于环境中的任何地方并被遗忘。要使这些产品变为现实，需要将原始传感器数据转化为可操作信息的方式，本地在设备上进行处理，因为传输数据流的能量成本被证明太高，以至于不切实际。

这就是TinyML的概念所在。与行业和学术界同事长时间的交谈导致了一个粗略的共识，即如果你能以低于1毫瓦的能量成本运行神经网络模型，那么将会有许多全新的应用变得可能。这个数字可能看起来有点随意，但如果你将其转化为具体的术语，那就意味着一个运行在硬币电池上的设备可以使用一年。这将导致一个产品足够小，可以适应任何环境，并能够在没有任何人为干预的情况下运行一段有用的时间。

###### 注

我将直接使用一些技术术语来讨论本书将涵盖的内容，但如果其中一些对您不熟悉，不要担心；我们在第一次使用它们时会定义它们的含义。

此时，你可能会想到像树莓派或NVIDIA的Jetson开发板这样的平台。这些设备非常棒，我自己经常使用，但即使是最小的树莓派也类似于手机的主CPU，因此需要数百毫瓦的电力。即使只是让它运行几天，也需要类似于智能手机的电池，这使得构建真正无线的体验变得困难。NVIDIA的Jetson基于强大的GPU，当以全速运行时，我们看到它使用了高达12瓦的功率，因此即使没有大型外部电源供应，也更难以使用。这通常在汽车或机器人应用中不是问题，因为机械部件本身需要大功率源，但这确实使得在我最感兴趣的那些需要在没有有线电源的情况下运行的产品上使用这些平台变得困难。幸运的是，使用它们时，由于缺乏资源限制，通常可以使用像TensorFlow、TensorFlow Lite和NVIDIA的TensorRT这样的框架，因为它们通常基于Linux兼容的Arm Cortex-A CPU，具有数百兆字节的内存。本书不会专注于描述如何在这些平台上运行，原因就是刚才提到的，但如果你感兴趣，有很多资源和文档可用；例如，请参阅[TensorFlow Lite的移动文档](https://www.tensorflow.org/lite)。

我关心的另一个特征是成本。最便宜的树莓派Zero面向制造商的价格是5美元，但很难以那个价格大量购买这类芯片。Zero的购买通常受到数量限制，而工业购买的价格并不透明，但很明显5美元绝对是不寻常的。相比之下，最便宜的32位微控制器每个成本远低于一美元。这种低价使得制造商能够用软件定义的替代方案替换传统的模拟或电机控制电路，从玩具到洗衣机的一切。我希望我们可以利用这些设备中微控制器的普及性，通过软件更新引入人工智能，而无需对现有设计进行大量更改。这也应该使得能够在建筑物或野生动物保护区等环境中部署大量智能传感器，而不会使成本超过收益或可用资金。

# 嵌入式设备

TinyML的定义是指能耗低于1毫瓦，这意味着我们需要寻找嵌入式设备作为硬件平台。直到几年前，我自己对它们并不熟悉——它们对我来说充满了神秘感。传统上它们是8位设备，使用晦涩和专有的工具链，因此开始使用任何一个都显得非常令人生畏。一个重要的进步是当Arduino推出了用户友好的集成开发环境（IDE）以及标准化的硬件。从那时起，32位CPU已经成为标准，这在很大程度上要归功于Arm的Cortex-M系列芯片。几年前我开始原型设计一些机器学习实验时，我惊讶地发现开发过程变得相对简单。

嵌入式设备仍然受到一些严格的资源限制。它们通常只有几百千字节的RAM，有时甚至更少，并且具有类似数量的闪存用于持久性程序和数据存储。时钟速度只有几十兆赫是很常见的。它们肯定不会有完整的Linux（因为那需要内存控制器和至少一兆字节的RAM），如果有操作系统，很可能不会提供您期望的所有或任何POSIX或标准C库函数。许多嵌入式系统避免使用像`new`或`malloc()`这样的动态内存分配函数，因为它们被设计为可靠且长时间运行，如果有一个可以被碎片化的堆，要确保这一点是极其困难的。您可能还会发现使用调试器或其他来自桌面开发的熟悉工具会有些棘手，因为您将使用的接口非常专业化。

然而，当我学习嵌入式开发时，也有一些令人惊喜的地方。拥有没有其他进程来中断您的程序的系统可以使构建对发生的事情的心理模型变得非常简单，而没有分支预测或指令流水线的处理器的直接性质使手动汇编优化比在更复杂的CPU上更容易。我也发现，在一个可以平衡在指尖上的微型计算机上看到LED灯亮起，知道它每秒运行数百万条指令来理解周围世界，这带来了一种简单的喜悦。

# 变化的景观

直到最近，我们才能在微控制器上运行机器学习，这个领域非常年轻，这意味着硬件、软件和研究都在非常快速地变化。这本书基于2019年的世界快照，这一领域意味着一些部分在我们完成最后一章的写作之前就已经过时了。我们努力确保我们依赖的硬件平台将长期可用，但设备很可能会继续改进和演变。我们使用的TensorFlow Lite软件框架具有稳定的API，我们将继续支持文本中提供的示例，但我们还提供了所有示例代码和文档的最新版本的网页链接。例如，您可以期望看到覆盖更多用例的参考应用程序被添加到TensorFlow存储库中。我们还致力于专注于调试、模型创建和开发对深度学习工作原理的理解等技能，即使您使用的基础设施发生变化，这些技能也将保持有用。

我们希望这本书能为您提供开发嵌入式机器学习产品所需的基础，以解决您关心的问题。希望我们能够帮助您开始建立一些令人兴奋的新应用程序，我相信在未来几年内这个领域将涌现出一些新的应用程序。

皮特·沃登

# 第九章。生成模型

到目前为止，我们所研究的所有问题都涉及以某种方式将输入转换为输出。您创建一个模型，该模型接受输入并产生输出。然后，您对来自数据集的输入样本进行训练，优化以产生每个样本的最佳输出。

*生成模型*是不同的。它们不是以样本作为输入，而是以样本作为输出。您可以在猫的照片库上训练模型，它将学会生成看起来像猫的新图像。或者，为了给出一个更相关的例子，您可以在已知药物分子的库上对其进行训练，它将学会生成新的“类似药物”的分子，以用作虚拟筛选中的候选物。从形式上讲，生成模型是在从某个（可能未知，可能非常复杂）概率分布中抽取的一组样本上进行训练的。它的工作是从相同概率分布中生成新样本。

在本章中，我们将首先描述两种最流行的生成模型类型：*变分自动编码器*和*生成对抗网络*。然后，我们将讨论这些模型在生命科学中的一些应用，并通过一些代码示例进行工作。

# 变分自动编码器

*自动编码器*是一种试图使其输出等于其输入的模型。您对其进行训练，调整模型参数，以便在每个样本上输出尽可能接近输入。

听起来很琐碎。它不能直接学会将输入直接传递到输出而不改变吗？如果这实际上是可能的，那确实是琐碎的，但是自动编码器通常具有使其不可能的架构。通常，这是通过强制数据通过瓶颈来完成的，如图 9-1 所示。例如，输入和输出可能各包含 1,000 个数字，但中间会有一个仅包含 10 个数字的隐藏层。这迫使模型学习如何压缩输入样本。它必须使用仅 10 个数字来表示价值 1,000 个数字的信息。

![变分自动编码器的结构。](img/dlls_0901.png)

###### 图 9-1. 变分自动编码器的结构。

如果模型需要处理任意输入，那将是不可能的。您不能丢弃 99%的信息并仍然重建输入！但我们不关心任意输入，只关心训练集中的特定输入（以及类似它们的其他输入）。在所有可能的图像中，远不到 1%的图像看起来像猫。自动编码器不需要为所有可能的输入工作，只需要为从特定概率分布中抽取的输入工作。它需要学习该分布的“结构”，找出如何使用更少的信息表示该分布，然后能够基于压缩信息重建样本。

现在让我们拆解这个模型。中间层，作为瓶颈的那一层，被称为自动编码器的*潜在空间*。这是样本的压缩表示空间。自动编码器的前半部分称为*编码器*。它的工作是接受样本并将其转换为压缩表示。后半部分称为*解码器*。它接受潜在空间中的压缩表示并将其转换回原始样本。

这给了我们有关自动编码器如何用于生成建模的第一个线索。解码器接受潜在空间中的向量并将其转换为样本，因此我们可以在潜在空间中取随机向量（为向量的每个分量选择随机值）并通过解码器传递它们。如果一切顺利，解码器应该产生一个完全新的样本，仍然类似于它所训练的样本。

这种方法有点奏效，但效果并不是很好。问题在于编码器可能只在潜在空间的一个小区域内产生向量。如果我们在潜在空间的其他任何地方选择一个向量，我们可能得到一个看起来与训练样本完全不同的输出。换句话说，解码器只学会为编码器产生的特定潜在向量工作，而不是任意的向量。

变分自动编码器（VAE）添加了两个特性来克服这个问题。首先，它添加了一个项到损失函数中，强制潜在向量遵循指定的分布。通常它们被限制为具有均值为 0 和方差为 1 的高斯分布。我们不让编码器自由生成向量。我们强制它生成具有已知分布的向量。这样，如果我们从相同分布中选择随机向量，我们可以期望解码器在它们上表现良好。

其次，在训练过程中，我们向潜在向量添加随机噪声。编码器将输入样本转换为潜在向量，然后我们在通过解码器之前随机微调一点，要求输出仍然尽可能接近原始样本。这可以防止解码器对潜在向量的精确细节过于敏感。如果我们只稍微改变一下，输出也应该只有轻微变化。

这些改变很好地改善了结果。VAE 是生成建模的流行工具：它们在许多问题上产生出色的结果。

# 生成对抗网络

生成对抗网络（GAN）与 VAE 有很多共同之处。它使用完全相同的解码器网络将潜在向量转换为样本（除了在 GAN 中，它被称为*生成器*而不是解码器）。但它以不同的方式训练该网络。它通过将随机向量传递到生成器中，并直接评估输出以确定它们如何符合预期分布。有效地，你创建一个损失函数来衡量生成的样本与训练样本匹配的程度，然后使用该损失函数来优化模型。

听起来简单，只需几秒钟，直到你思考并意识到这根本不简单。你能写一个损失函数来衡量一幅图像多像一只猫吗？当然不行！你根本不知道从哪里开始。因此，不要求你自己想出那个损失函数，GAN 从数据中学习损失函数。

如图 9-2 所示，GAN 由两部分组成。生成器接受随机向量并生成合成样本。第二部分称为*鉴别器*，试图区分生成的样本和真实训练样本。它以样本作为输入，并输出这是真实训练样本的概率。它充当生成器的损失函数。

![生成对抗网络的结构。](img/dlls_0902.png)

###### 图 9-2。生成对抗网络的结构。

两个部分同时进行训练。随机向量被输入到生成器中，输出被输入到鉴别器中。生成器的参数被调整以使鉴别器的输出尽可能接近 1，而鉴别器的参数被调整以使其输出尽可能接近 0。此外，来自训练集的真实样本被输入到鉴别器中，并且其参数被调整以使输出接近 1。

这是“对抗”的方面。你可以将其看作是生成器和鉴别器之间的竞争。鉴别器不断尝试更好地区分真实样本和假样本。生成器不断尝试更好地欺骗鉴别器。

与 VAEs 一样，GANs 是一种在许多问题上产生良好结果的流行生成模型。这两种类型的模型各有优势和劣势。非常粗略地说，可以说 GANs 倾向于产生更高质量的样本，而 VAEs 倾向于产生更高质量的分布。也就是说，GAN 生成的个别样本更接近训练样本，而 VAE 生成的样本范围更接近训练样本的范围。不过，不要太字面理解这个说法。这完全取决于具体的问题和模型的细节。此外，对这两种方法的无数变体已经被提出。甚至有一些模型将 VAE 与 GAN 结合起来，试图获得两者的最佳特性。这仍然是一个非常活跃的研究领域，新的想法经常被发表。

# 生命科学中生成模型的应用

现在我们已经向您介绍了深度生成模型的基础知识，让我们开始谈论应用。广义上说，生成模型为我们带来了一些超能力。首先，它们允许一种“创造性”的外观。可以根据学习到的分布生成新样本。这为创造性过程提供了一个强大的补充，可以与药物或蛋白质设计的现有工作联系起来。其次，能够准确地用生成模型建模复杂系统可能使科学家们建立对复杂生物过程的理解。我们将在本节中更深入地讨论这些想法。

## 为引导化合物生成新想法

现代药物发现工作的一个重要部分是提出新的化合物。这通常是由专家人类化学家每隔半年提出对核心结构的修改来完成的。通常情况下，这将涉及在屏幕上投影当前分子系列的图片，并让一群资深化学家提出对分子的核心结构的修改。这些建议的分子中的一部分实际上被合成和测试，这个过程会重复直到找到合适的分子或者项目被放弃。这个过程具有强大的优势，因为它可以利用专家化学家的深刻直觉，他们可能能够识别潜在结构的缺陷（也许它类似于他们以前见过的一种化合物，导致大鼠出现不明原因的肝功能衰竭），这可能不容易通过算法来识别。

与此同时，这个过程受到非常大的人类限制。世界上并没有那么多有才华和经验丰富的资深化学家，因此这个过程无法扩展。此外，对于一个历史上缺乏药物发现专业知识的国家的制药部门来说，这也使得自我启动变得非常具有挑战性。分子结构的生成模型可以克服这些限制。如果模型是在适当的分子表示上进行训练的，它可能能够快速提出新的替代化合物。获得这样的模型可以通过建议可能被人类设计师忽略的新化学方向来帮助改进当前的流程。值得注意的是，这样的设计算法也有严重的警告，我们稍后在本章中会看到。

## 蛋白质设计

设计新的酶和蛋白质是当今一个重要的业务。工程酶在现代制造业中被广泛使用。（你的洗衣粉很可能含有一些酶！）然而，总体而言，设计新的酶一直是具有挑战性的。一些早期的工作表明，深度模型可以在一定程度上成功地从序列中预测蛋白质功能。使用深度生成模型来建议可能具有期望特性的新蛋白质序列并不是不合理的。

为此目的引入生成模型可能比小分子设计更具影响力。与小分子不同，人类专家很难预测对给定蛋白质的突变的下游影响。使用生成模型可以实现更丰富的蛋白质设计，使得今天人类专家无法做到的方向成为可能。

## 科学发现的工具

生成模型可以成为科学发现的强大工具。例如，拥有一个准确的[tissue development process](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6119234/)的生成模型对发育生物学家或基础科学中的工具可能非常有价值。通过使用生成模型进行快速模拟，可能创建“合成测定”，从而可以研究在许多环境条件下的组织发育。这个未来还有一段距离，因为我们需要生成模型在初始条件改变时能够有效工作。这需要更多超越当前技术水平的研究。然而，这个愿景令人兴奋，因为生成建模可以让生物学家构建极其复杂的发育和生理过程的有效模型，并测试他们对这些系统演变方式的假设。

## 生成建模的未来

生成模型具有挑战性！最初的 GAN 只能生成模糊的几乎无法识别为面孔的图像。最新的 GAN（撰写时）能够生成几乎与真实照片无法区分的面孔图像。很可能在未来十年，这些模型将进一步完善，以实现生成视频。这些发展将对现代社会产生深远影响。在过去的大部分世纪里，照片一直被常规用作犯罪、质量等的“证据”。随着生成工具的发展，这种证据标准将不足以满足，因为任意图像都可以被“photoshopped”。这一发展将对刑事司法甚至国际关系构成重大挑战。

与此同时，高保真度的生成视频的出现可能会引发现代科学的革命。想象一下胚胎发育的高质量生成模型！可能可以模拟 CRISPR 基因修饰的效果，或者比以往任何时候都更详细地了解发育过程。生成模型的改进也将影响其他科学领域。生成建模可能成为物理学和气候科学中的强大工具，允许对复杂系统进行更强大的模拟。然而，值得强调的是，这些改进今天仍然留在未来；必须进行大量基础科学研究，以使这些模型成熟到有用的稳定性。

# 使用生成模型

现在让我们通过一个代码示例来工作。我们将训练一个 VAE 来生成新的分子。更具体地说，它将输出 SMILES 字符串。与我们讨论过的其他表示相比，这种表示的选择具有明显的优势和劣势。一方面，SMILES 字符串非常容易处理。每个字符串只是从固定字母表中提取的字符序列。这使我们可以使用非常简单的模型来处理它们。另一方面，SMILES 字符串必须遵守复杂的语法。如果模型没有学会所有语法的微妙之处，那么它产生的大多数字符串将是无效的，不对应任何分子。

我们需要的第一件事是一组 SMILES 字符串，用于训练模型。幸运的是，MoleculeNet 为我们提供了很多选择。在这个示例中，我们将使用 MUV 数据集。训练集包括 74,469 个不同大小和结构的分子。让我们开始加载它：

```py
import deepchem as dc
tasks, datasets, transformers = dc.molnet.load_muv()
train_dataset, valid_dataset, test_dataset = datasets
train_smiles = train_dataset.ids

```

接下来，我们需要定义模型将使用的词汇表。字符串中可以出现的字符（或“令牌”）列表是什么？字符串允许有多长？我们可以通过创建一个排序列表来确定这些，其中包含任何训练分子中出现的每个字符：

```py
tokens = set()
for s in train_smiles:
  tokens = tokens.union(set(s))
tokens = sorted(list(tokens))
max_length = max(len(s) for s in train_smiles)

```

现在我们需要创建一个模型。我们应该为编码器和解码器使用什么样的架构？这是一个正在进行的研究领域。已经发表了各种论文，建议使用不同的模型。在这个例子中，我们将使用 DeepChem 的`AspuruGuzikAutoEncoder`类，它实现了一个特定的已发表模型。它使用卷积网络作为编码器和循环网络作为解码器。如果您对细节感兴趣，可以参考[原始论文](https://arxiv.org/abs/1610.02415)，但这并不是必要的。还要注意，我们使用`ExponentialDecay`来设置学习率。速率最初设置为 0.001，然后在每个时代后稍微减少一点（乘以 0.95）。这有助于在许多问题中更顺利地进行优化：

```py
from deepchem.models.tensorgraph.optimizers import Adam, ExponentialDecay
from deepchem.models.tensorgraph.models.seqtoseq import AspuruGuzikAutoEncoder
model = AspuruGuzikAutoEncoder(tokens, max_length, model_dir='vae')
batches_per_epoch = len(train_smiles)/model.batch_size
learning_rate = ExponentialDecay(0.001, 0.95, batches_per_epoch)
model.set_optimizer(Adam(learning_rate=learning_rate))

```

我们现在准备训练模型。不使用标准的`fit()`方法，该方法需要一个`Dataset`，`AspuruGuzikAutoEncoder`提供了自己的`fit_sequences()`方法。它接受一个 Python 生成器对象，该对象生成令牌序列（在我们的情况下是 SMILES 字符串）。让我们训练 50 个时代：

```py
def generate_sequences(epochs):
  for i in range(epochs):
    for s in train_smiles:
      yield (s, s)

model.fit_sequences(generate_sequences(50))

```

如果一切顺利，模型现在应该能够生成全新的分子。我们只需要选择随机潜在向量并通过解码器传递它们。让我们创建一个批量包含一千个长度为 196 的向量的批次（模型潜在空间的大小）。

如前所述，并非所有输出实际上都是有效的 SMILES 字符串。实际上，只有其中的一小部分是有效的。幸运的是，我们可以很容易地使用 RDKit 来检查它们并过滤掉无效的：

```py
import numpy as np
from rdkit import Chem
predictions = model.predict_from_embeddings(np.random.normal(size=(1000,196)))
molecules = []
for p in predictions:
  smiles = ''.join(p)
  if Chem.MolFromSmiles(smiles) is not None:
    molecules.append(smiles)
for m in molecules:
  print(m)

```

## 分析生成模型的输出

除了无效输出的问题外，与 SMILES 字符串对应的许多分子可能不具有药物分子的特征。因此，我们需要制定策略，使我们能够快速识别不符合药物样式的分子。这些策略最好通过一个实际例子来解释。假设这是来自我们生成模型的 SMILES 字符串列表：

```py
smiles_list = 'CCCCCCNNNCCOCC',
'O=C(O)C(=O)ON/C=N/CO',
'C/C=N/COCCNSCNCCNN',
'CCCNC(C(=O)O)c1cc(OC(OC)[SH=O)ccc1N',
'CC1=C2C=CCC(=CC(Br)=CC=C1)C2',
'CCN=NNNC(C)OOCOOOOOCOOO',
'N#CNCCCCCOCCOC1COCNN1CCCCCCCCCCCCCCCCCCCOOOOOSNNCCCCCSCSCCCCCCCCCOCOOOSS',
'CCCC(=O)NC1=C(N)C=COO1',
'CCCSc1cc2nc(C)cnn2c1NC',
'CONCN1N=NN=CC=C1CC1SSS1',
'CCCOc1ccccc1OSNNOCCNCSNCCN',
'C[SH]1CCCN2CCN2C=C1N',
'CC1=C(C#N)N1NCCC1=COOO1',
'CN(NCNNNN)C(=O)CCSCc1ccco1',
'CCCN1CCC1CC=CC1=CC=S1CC=O',
'C/N=C/c1ccccc1',
'Nc1cccooo1',
'CCOc1ccccc1CCCNC(C)c1nccs1',
'CNNNNNNc1nocc1CCNNC(C)C',
'COC1=C(CON)C=C2C1=C(C)c1ccccc12',
'CCOCCCCNN(C)C',
'CCCN1C(=O)CNC1C',
'CCN',
'NCCNCc1cccc2c1C=CC=CC=C2',
'CCCCCN(NNNCNCCCCCCCCCCSCCCCCCCCCCCCCCNCCNCCCCSSCSSSSSSCCCCCCCCCCCCCSCCCCCSC)\
C(O)OCCN',
'CCCS1=CC=C(C)N(CN)C2NCC2=C1',
'CCNCCCCCCOc1cccc(F)c1',
'NN1OSHC12C=C2',
'Cc1cc2cccc3c(CO)cc-3ccc-2c1']

```

我们分析的第一步将是检查分子，并确定是否有任何我们想要丢弃的分子。我们可以使用 RDKit 中的一些功能来检查这些字符串表示的分子。为了评估这些字符串，我们必须首先将它们转换为分子对象。我们可以使用以下列表推导来做到这一点：

```py
molecules = [Chem.MolFromSmiles(x) for x in smiles_list]​  

```

我们可能要检查的一个因素是分子的大小。少于 10 个原子的分子不太可能产生足够的相互作用能量，在生物测定中产生可测信号。相反，超过 50 个原子的分子可能无法溶解在水中，并可能在生物测定中产生其他问题。我们可以通过计算每个分子中非氢原子的数量来粗略估计分子的大小。以下代码创建了每个分子中原子数量的列表。为了方便起见，我们对数组进行排序，以便更容易理解分布（如果我们有一个更大的分子列表，我们可能会想要为此分布生成直方图）：

```py
print(sorted([x.GetNumAtoms() for x in molecules]))

```

结果如下：

```py
[3, 8, 9, 10, 11, 11, 12, 12, 13, 14, 14, 14, 15, 
16, 16, 16, 17, 17, 17, 17, 18, 19, 19, 20, 20, 22, 24, 69, 80]

```

我们可以看到有四个非常小的分子以及两个大分子。我们可以使用另一个列表推导来删除具有 10 个或少于 50 个原子的分子：

```py
good_mol_list = [x for x in molecules if x.GetNumAtoms() > 10
        and x.GetNumAtoms() < 50]
print(len(good_mol_list))
23

```

这个列表推导将我们之前的 29 个分子减少到 23 个。

实际上，我们可以使用许多其他计算属性来评估生成的分子的质量。一些最近的生成模型出版物使用计算的分子属性来确定哪些生成的分子保留或丢弃。确定分子是否类似于已知药物或“药物样品”的更常见方法之一被称为药物样品的定量估计（QED）。QED 指标最初由 Bickerton 和同事发表，通过比较为每个分子计算的一组属性与市场上药物中相同属性的分布来评分分子。该分数范围在 0 到 1 之间，值越接近 1 被认为更像药物。

我们可以使用 RDKit 来计算剩余分子的 QED 值，并仅保留那些 QED > 0.5 的分子如下：

```py
qed_list = [QED.qed(x) for x in good_mol_list]
final_mol_list = [(a,b) for a,b in
         zip(good_mol_list,qed_list) if b > 0.5]

```

作为最后一步，我们可以可视化`final_mol_list`的化学结构和相应的 QED 分数：

```py
MolsToGridImage([x[0] for x in final_mol_list],
molsPerRow=3,useSVG=True,
subImgSize=(250, 250),
legends=[f"{x[1]:.2f}" for x in final_mol_list])

```

结果显示在图 9-3 中。

![](img/dlls_0903.png)

###### 图 9-3. 生成分子的化学结构以及它们的 QED 分数。

虽然这些结构是有效的，并且具有相当高的 QED 分数，但它们仍然包含可能不稳定的官能团。如何识别和删除这些问题分子的策略将在下一节中讨论。

# 结论

虽然生成模型提供了一个有趣的方法来产生新分子的想法，但仍然需要解决一些关键问题以确保它们的普遍适用性。第一个问题是确保生成的分子将是化学稳定的，并且它们可以被物理合成。目前评估由生成模型产生的分子质量的一种方法是观察遵守化学价标准规则的生成分子的比例，换句话说，确保每个碳原子有四个键，每个氧原子有两个键，每个氟原子有一个键，依此类推。当从具有 SMILES 表示的潜在空间解码时，这些因素变得尤为重要。虽然生成模型可能已经学会了 SMILES 的语法，但仍可能存在一些细微差别。

分子遵守化学价标准规则并不一定能确保其在化学上稳定。在某些情况下，生成模型可能会产生包含已知易分解的官能团的分子。例如，考虑图 9-4 中的分子。圈中突出显示的官能团称为半缩醛，已知易分解。

![](img/dlls_0904.png)

###### 图 9-4. 包含不稳定官能团的分子。

实际上，这种分子存在并且在化学上稳定的概率非常小。有数十种类似的化学官能团是已知不稳定或具有反应性的。在药物发现项目中合成分子时，药物化学家知道要避免引入这些官能团。向生成模型提供一组过滤器的一种方式是将这种“知识”传达给生成模型，这些过滤器可用于后处理模型输出并删除可能存在问题的分子。在第十一章中，我们将进一步讨论其中一些过滤器以及它们在虚拟筛选中的使用方式。用于识别潜在问题筛选化合物的许多相同技术也可用于评估由生成模型创建的虚拟分子。

为了测试由生成模型产生的分子的生物活性，该分子必须首先由化学家合成。有机化学合成科学有着超过一百年的丰富历史。在这段时间里，化学家们已经开发了成千上万种化学反应来合成药物和类药物分子。合成类药物分子通常需要大约 5 到 10 个化学反应，通常被称为“步骤”。虽然一些类药物分子可以很容易地合成，但对于更复杂的药物分子，合成路线可能需要超过 20 个步骤。尽管在自动化有机合成规划方面已经有 50 多年的工作，但很多过程仍然是由人类直觉和试错驱动的。

幸运的是，深度学习的最新发展提供了规划药物样分子合成的新方法。许多团体已经发表了使用深度学习提出合成分子的路线的方法。模型的输入是一个分子，通常被称为*产物*，以及用于合成该分子的步骤集。通过使用数千个产物分子和用于合成的步骤进行训练，深度神经网络能够学习产物分子和反应步骤之间的关系。当给出一个新分子时，模型会建议一组可用于合成该分子的反应。在一个测试中，这些模型产生的合成路线被呈现给人类化学家进行评估。这些评估者认为模型生成的路线在质量上与人类化学家生成的路线相当。

将深度学习应用于有机合成是一个相对较新的领域。希望这个领域将继续发展，并且这些模型将成为有机化学家的重要工具。人们可以想象，在不久的将来，这些合成规划能力可以与机器自动化相结合，创建一个完全自动化的平台。然而，还有一些困难需要克服。

在有机合成中广泛采用深度学习的一个潜在障碍是数据的可用性。用于训练这些模型的大部分信息都在数据库中，这些数据库是少数几个组织的财产。如果这些组织决定仅将这些数据用于他们的内部工作，那么该领域将只剩下极少的选择。

另一个可能限制生成模型发展的因素是用于驱动分子生成的预测模型的质量。无论用何种架构开发生成模型，都必须使用某种函数来评估生成的分子并指导寻找新分子。在某些情况下，我们可能能够开发可靠的预测模型。在其他情况下，模型可能不太可靠。虽然我们可以在外部验证集上测试我们的模型，但通常很难确定预测模型的范围。这个范围，也称为“适用领域”，是一个模型在训练时可以推断出的分子范围。这种适用领域并不明确定义，因此很难确定模型在生成模型产生的新分子上的工作效果如何。

生成模型是一种相对较新的技术，有趣的是看到这个领域在未来几年如何发展。随着我们利用深度学习来预测有机合成路线和构建预测模型的能力不断提高，生成模型的威力将继续增长。

[1] Bickerton, Richard G.等人。“量化药物的化学美。”[*http://dx.doi.org/10.1038/nchem.1243*](http://dx.doi.org/10.1038/nchem.1243)。2012.

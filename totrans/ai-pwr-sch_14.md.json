["```py\nid  sess_id  query      rank  doc_id        clicked\n0   50002    blue ray   0.0   600603141003  True\n1   50002    blue ray   1.0   827396513927  False\n2   50002    blue ray   2.0   24543672067   False\n3   50002    blue ray   3.0   719192580374  False\n4   50002    blue ray   4.0   885170033412  True\n```", "```py\ntraining_data = generate_training_data(sessions, prior_weight=10,\n                                       prior_grade=0.2)\ndisplay(training_data)\n```", "```py\nquery             doc_id          clicked  examined  grade     beta_grade\nblue ray          27242815414     42       42        1.000000  0.846154\n                  827396513927    1304     3359      0.388211  0.387652\n                  883929140855    140      506       0.276680  0.275194\n                  885170033412    568      2147      0.264555  0.264256\n                  24543672067     665      2763      0.240680  0.240534\n...\ntransformers dvd  47875819733     24       1679      0.014294  0.015394\n                  708056579739    23       1659      0.013864  0.014979\n                  879862003524    23       1685      0.013650  0.014749\n                  93624974918     19       1653      0.011494  0.012628\n                  47875839090     16       1669      0.009587  0.010721\n```", "```py\ndef train_and_evaluate_model(sessions, model_name, features, log=False):\n  training_data = generate_training_data(sessions)\n  train, test = split_training_data(training_data, 0.8)\n  train_and_upload_model(train, model_name, features=features, log=log)\n  evaluation = evaluate_model(test, model_name, training_data, log=log)\n  return evaluation\n\nfeature_set = [\n  ltr.generate_query_feature(feature_name=\"long_description_bm25\",\n                             field_name=\"long_description\"),\n  ltr.generate_query_feature(feature_name=\"short_description_constant\",\n                             field_name=\"short_description\",\n                             constant_score=True)]\n\nevaluation = train_and_evaluate_model(sessions, \"ltr_model_variant_1\",\n                                      feature_set)\ndisplay(evaluation)\n```", "```py\n{\"dryer\": 0.03753076750950996,\n \"blue ray\": 0.0,\n \"headphones\": 0.0846717500031762,\n \"dark of moon\": 0.0,\n \"transformers dvd\": 0.0}\n```", "```py\nfeature_set = [\n  ltr.generate_fuzzy_query_feature(feature_name=\"name_fuzzy\",\n                                   field_name=\"name\"),\n  ltr.generate_bigram_query_feature(feature_name=\"name_bigram\",\n                                    field_name=\"name\"),\n  ltr.generate_bigram_query_feature(feature_name=\"short_description_bigram\"\n                                    field_name=\"short_description\")]\n\nevaluation = train_and_evaluate_model(sessions, \"ltr_model_variant_2\",\n                                      feature_set)\ndisplay(evaluation)\n```", "```py\n{\"dryer\": 0.07068309073137659,     #Before: 0.038\n \"blue ray\": 0.0,                         # 0.0\n \"headphones\": 0.06540945492120899,       # 0.085\n \"dark of moon\": 0.2576592004029579,      # 0.0\n \"transformers dvd\": 0.10077083021678328} # 0.0\n```", "```py\ndef a_b_test(query, model_a, model_b):\n  draw = random.random()\n  model_name = model_a if draw < 0.5 else model_b  #1\n  purchase_made = simulate_live_user_session(query,  #2\n                                        model_name)  #2\n  return (model_name, purchase_made)\n\ndef simulate_user_a_b_test(query, model_a, model_b, number_of_users=1000):\n  purchases = {model_a: 0, model_b: 0}\n  for _ in range(number_of_users):  #3\n    model_name, purchase_made = a_b_test(query, model_a, model_b)  #3\n    if purchase_made:  #4\n      purchases[model_name] += 1  #4\n  return purchases\n\nresults = simulate_user_a_b_test(\"transformers dvd\",\n                                \"ltr_model_variant_1\",\n                                \"ltr_model_variant_2\")\ndisplay(results)\n```", "```py\n{\"ltr_model_variant_1\": 21,\n \"ltr_model_variant_2\": 15}\n```", "```py\ndef get_latest_explore_feature_set():\n  return [\n    ltr.generate_query_feature(  #1\n      feature_name=\"long_description_match\",  #1\n      field_name=\"long_description\",  #1\n      constant_score=True),  #1\n    ltr.generate_query_feature(  #1\n      feature_name=\"short_description_match\",  #1 \n      field_name=\"short_description\",  #1\n      constant_score=True),  #1\n    ltr.generate_query_feature(  #1\n      feature_name=\"name_match\",  #1\n      field_name=\"name\", constant_score=True),  #1\n    ltr.generate_query_feature(  #2\n      feature_name=\"has_promotion\",  #2\n      field_name=\"has_promotion\", value=\"true\")]  #2\n\ndef get_logged_transformers_judgments(sessions, features):\n training_data = generate_training_data(sessions)  #3\n  logged_judgments = generate_logged_judgments(training_data,  #4\n                                         features, \"explore\")  #4\n  logged_judgments = logged_judgments \\  #5\n      [logged_judgments[\"query\"] == \"transformers dvd\"]  #5\n  return logged_judgments\n\nexplore_features = get_latest_explore_features()\nlogged_transformers_judgments = get_logged_transformers_judgments(sessions,\n                                                          explore_features)\ndisplay(logged_transformers_judgments)\n```", "```py\ndoc_id       query             grade  long_desc*_match   name_match\n                                            short_desc*_match  has_promotion\n----------------------------------------------------------------------------\n97363560449  transformers dvd  0.34   0.0   0.0          1.0   0.0\n97361312804  transformers dvd  0.34   0.0   0.0          1.0   0.0\n97361312743  transformers dvd  0.34   0.0   0.0          1.0   0.0\n97363455349  transformers dvd  0.34   0.0   0.0          1.0   0.0\n...\n708056579739 transformers dvd  0.01   1.0   1.0          1.0   0.0\n879862003524 transformers dvd  0.01   1.0   1.0          1.0   0.0\n93624974918  transformers dvd  0.01   0.0   0.0          1.0   0.0\n47875839090  transformers dvd  0.01   1.0   0.0          1.0   0.0\n```", "```py\nfrom sklearn.gaussian_process import GaussianProcessRegressor\n\ndef train_gpr(logged_judgments, feature_names):\n  feature_data = logged_judgments[feature_names]  #1\n  grades = logged_judgments[\"grade\"]  #2\n  gpr = GaussianProcessRegressor()  #3\n  gpr.fit(feature_data, grades)  #3\n  return gpr\n```", "```py\ndef calculate_prediction_data(logged_judgments, feature_names):\n  index = pandas.MultiIndex.from_product([[0, 1]] * 4,  #1\n                                  names=feature_names)  #1\n  with_prediction = pandas.DataFrame(index=index).reset_index()\n\n  gpr = train_gpr(logged_judgments, feature_names)\n  predictions_with_std = gpr.predict(  #2\n    with_prediction[feature_names], return_std=True)  #2\n  with_prediction[\"predicted_grade\"] = predictions_with_std[0]  #3\n  with_prediction[\"predicted_stddev\"] = predictions_with_std[1]  #3\n\n  return  with_prediction.sort_values(\"predicted_stddev\", ascending=True)\n\nexplore_features = get_latest_explore_features()\nlogged_transformers_judgments = get_logged_transformers_judgments(sessions,\n                                                          explore_features)\nfeature_names = [f[\"name\"] for f in explore_features]\nprediction_data = calculate_prediction_data(logged_transformers_judgments,\n                                                            feature_names)\ndisplay(prediction_data)\n```", "```py\nlong_description_match  name_match      predicted_grade\n         short_description_match  has_promotion         prediction_stddev\n0        0              1         0     0.256798        0.000004\n1        0              1         0     0.014674        0.000005\n1        1              1         0     0.014864        0.000007\n0        1              1         0     0.022834        0.000010\n1        0              1         1     0.018530        0.000010\n0        0              1         1     0.161596        0.632121\n1        1              1         1     0.014856        0.632121\n```", "```py\ndef calculate_expected_improvement(logged_judgments, feature_names, theta=0.6):\n  data = calculate_prediction_data(logged_judgments, feature_names)\n  data[\"opportunity\"] = (data[\"predicted_grade\"] -  #1\n           logged_judgments[\"grade\"].mean() - theta) #1\n #1\n  data[\"prob_of_improvement\"] = ( \n    norm.cdf(data[\"opportunity\"] /  #2\n             data[\"predicted_stddev\"]))  #2\n\n  data[\"expected_improvement\"] = (  #3\n    data[\"opportunity\"] * data[\"prob_of_improvement\"] +  #3\n    data[\"predicted_stddev\"] *  #3\n    norm.pdf(data[\"opportunity\"] /  #3\n             data[\"predicted_stddev\"]))  #3\n  return data.sort_values(\"expected_improvement\",  #4\n                          ascending=False)  #4\n\nimprovement_data = calculate_expected_improvement(\n      logged_transformers_judgments, feature_names)\ndisplay(improvement_data)\n```", "```py\nlong_description_match  name_match  opportunity         expected_improvement\n    short_description_match  has_promotion     prob_of_improvement\n0   0                   0    1      -0.638497  0.234728  0.121201\n0   1                   0    1      -0.725962  0.213214  0.110633\n0   0                   0    0      -0.580755  0.232556  0.107853\n1   1                   0    1      -0.727500  0.204914  0.101653\n0   1                   0    0      -0.722661  0.181691  0.078549\n```", "```py\ndata[\"expected_improvement\"] = (\n  data[\"opportunity\"] * data[\"prob_of_improvement\"] +\n  (data[\"prediction_stddev\"] * norm.pdf(data[\"opportunity\"] /\n                                        data[\"prediction_stddev\"])))\n```", "```py\ndata[\"opportunity\"] * data[\"prob_of_improvement\"]\n```", "```py\ndata[\"prediction_stddev\"] * norm.pdf(data[\"opportunity\"] /\n                                     data[\"prediction_stddev\"])\n```", "```py\ndef explore(query, logged_judgments, features):  #1\n  feature_names = [f[\"name\"] for f in features]\n  prediction_data = calculate_expected_improvement(logged_judgments,\n                                                   feature_names)\n  explore_vector = prediction_data.head().iloc[0][feature_names] #2\n  return search_for_explore_candidate(explore_vector, query) #3\n\nexplore_features = get_latest_explore_features()\nlogged_judgments = get_logged_transformers_judgments(sessions,\n                                             explore_features)\nexploration_upc = explore(\"transformers dvd\", logged_judgments,\n                                              explore_features)[\"upc\"]\nprint(exploration_upc)\n```", "```py\n826663114164   # Transformers: The Complete Series [25th Anniversary ... ]\n```", "```py\ndoc_id       product_name               sess_id query             rank click\n93624974918  Transformers: Revenge O... 100049  transformers dvd  0.0  False\n879862003524 Razer - DeathAdder Tran... 100049  transformers dvd  1.0  False\n826663114164 Transformers: The Compl... 100049  transformers dvd  2.0  False\n708056579739 Nintendo - Transformers... 100049  transformers dvd  3.0  False\n```", "```py\nquery = \"transformers dvd\"\nsessions_with_exploration = generate_simulated_exploration_sessions(\n  query, sessions, logged_transformers_judgments, explore_features)\ntraining_data_with_exploration = \\\n  generate_training_data(sessions_with_exploration)\ndisplay(training_data_with_exploration.loc[\"transformers dvd\"])\n```", "```py\ndoc_id        product_name                click  examined  grade  beta_grade\n97360724240   Transformers: Revenge of... 43     44        0.977  0.833333\n826663114164  Transformers: The Comple... 42     44        0.954  0.814815\n97360722345   Transformers/Transformer... 46     55        0.836  0.738462\n97363455349   Transformers - Widescree... 731    2113      0.345  0.345266\n97361312804   Transformers - Widescree... 726    2109      0.344  0.343558\n```", "```py\n{\"upc\": \"826663114164\",\n \"name\": \"Transformers: The Complete Series [25th Anniversary ...] - DVD\",\n \"manufacturer\": \"\",\n \"short_description\": \"\",\n \"long_description\": \"\",\n \"has_promotion\": True}\n```", "```py\npromotion_feature_set = [\n  ltr.generate_fuzzy_query_feature(feature_name=\"name_fuzzy\",\n                                   field_name=\"name\"),\n  ltr.generate_bigram_query_feature(feature_name=\"name_bigram\",\n                                    field_name=\"name\"),\n  ltr.generate_bigram_query_feature(feature_name=\"short_description_bigram\",\n                                    field_name=\"short_description\"),\n  ltr.generate_query_feature(feature_name=\"has_promotion\",  #1\n                             field_name=\"has_promotion\",  #1\n                             value=\"true\",  #1\n                             constant_score=True)]  #1\n\nevaluation = train_and_evaluate_model(sessions_with_exploration,\n                                      \"ltr_model_variant_3\",\n                                      feature_set)\ndisplay(evaluation)\n```", "```py\n{\"dryer\": 0.12737002598513025,     # Before: 0.071\n \"blue ray\": 0.08461538461538462,          # 0.0\n \"headphones\": 0.12110565745285455,        # 0.065\n \"dark of moon\": 0.1492224251599605,       # 0.258\n \"transformers dvd\": 0.26947504217124457}  # 0.101\n```", "```py\nresults = ltr.search_with_model(\"ltr_model_variant_3\",\n                                query=\"transformers dvd\",\n                                rerank_query=\"transformers dvd\",\n                                limit=5)[\"docs\"]\ndisplay([doc[\"name\"] for doc in results])\n```", "```py\n[\"Transformers/Transformers: Revenge of the Fallen: Two-Movie Mega Coll...\",\n \"Transformers: Revenge of the Fallen - Widescreen - DVD\",\n \"Transformers: Dark of the Moon - Original Soundtrack - CD\",\n \"Transformers: The Complete Series [25th Anniversary Matrix of Leaders...\",\n \"Transformers: Dark of the Moon Stealth Force Edition - Nintendo Wii\"]\n```", "```py\nresults = simulate_user_a_b_test(query=\"transformers dvd\",\n                                 model_a=\"ltr_model_variant_1\",\n                                 model_b=\"ltr_model_variant_3\",\n                                 number_of_users=1000)\ndisplay(results)\n```", "```py\n{\"ltr_model_variant_1\": 21,\n \"ltr_model_variant_3\": 145}\n```", "```py\ndef train_and_deploy_model(sessions, model_name, feature_set):\n  judgments = generate_training_data(sessions)\n  train, test = split_training_data(judgments, 0.8)\n  train_ranksvm_model(train, model_name, feature_set=feature_set)\n\ndef ltr_retraining_loop(latest_sessions, iterations=sys.maxsize,\n                        retraining_frequency=60 * 60 * 24):  #1\n  exploit_feature_set = get_exploit_feature_set()  #2\n  train_and_deploy_model(latest_sessions,  #2\n                         \"exploit\",  #2\n                         exploit_feature_set)  #2\n  for i in range(0, iterations):  #3\n    judgments = generate_training_data(latest_sessions)\n    train, test = split_training_data(judgments)\n    if i > 0:\n      previous_explore_model_name = f\"explore_variant_{i-1}\"\n      exploit_model_evaluation = evaluate_model(test_data=test,\n        model_name=\"exploit\", training_data=train)\n      explore_model_evaluation = evaluate_model(test_data=test,\n        model_name=previous_explore_model_name, training_data=train)\n      print(f\"Exploit evaluation: {exploit_model_evaluation}\")\n      print(f\"Explore evaluation: {explore_model_evaluation}\")\n      if is_improvement(explore_model_evaluation,  #4\n                        exploit_model_evaluation):  #4\n        print(\"Promoting previous explore model\")\n        train_and_deploy_model(latest_sessions,\n                               \"exploit\",\n                               explore_feature_set)\n\n    explore_feature_set = get_latest_explore_feature_set()  #5\n    train_and_deploy_model(latest_sessions,  #5\n                           f\"explore_variant_{i}\",  #5\n                            explore_feature_set)  #5\n\n    wait_for_more_sessions(retraining_frequency)  #6\n    latest_sessions = gather_latest_sessions(  #7\n                        \"transformers dvd\",  #7\n                        latest_sessions,  #7\n                        explore_feature_set)  #7\n\nltr_retraining_loop(sessions)\n```"]
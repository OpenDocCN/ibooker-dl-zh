<html><head></head><body><section data-pdf-bookmark="Chapter 4. Implementing Type-Safe AI Services" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch04">
<h1><span class="label">Chapter 4. </span>Implementing Type-Safe AI Services</h1>

<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id740">
<h1>Chapter Goals</h1>
<p><a data-primary="type-safe AI services" data-type="indexterm" id="ix_ch04-asciidoc0"/>In this chapter, you will learn about:</p>

<ul>
<li>
<p>Why it is essential to have fully typed services</p>
</li>
<li>
<p>How to correctly define and implement type safety for GenAI services</p>
</li>
<li>
<p>Similarities and differences between dataclasses and Pydantic data models</p>
</li>
<li>
<p>How to validate the content of requests and responses in GenAI services using Pydantic models</p>
</li>
<li>
<p>How to build custom field and data model validators with Pydantic to prevent incorrect data from passing through your service</p>
</li>
<li>
<p>How to use the Pydantic Settings package to load and validate your application environment variables</p>
</li>
<li>
<p>How to reduce uncertainty when working with external systems that change schemas</p>
</li>
<li>
<p>How to manage changes as the complexity grows to avoid introducing unintended bugs</p>
</li>
</ul>
</div></aside>

<p>When working with complex codebases that continuously change by multiple contributors and when interacting with external services such as APIs or databases, you will want to follow best practices such as type safety in building your applications.</p>

<p>This chapter focuses on the importance of type safety when building backend services and APIs.
You will learn how to implement type safety using Python’s built-in dataclasses and then Pydantic data models, and you will see their similarities and differences.
In addition, you will explore how to use Pydantic data models with custom validators to protect against bad user input or incorrect data, and you will learn how to use Pydantic Settings for loading and validating environment variables.
Finally, you will discover strategies for dealing with schema changes in external systems and managing complexity in evolving codebases to prevent bugs.</p>

<p>By the end of this chapter, you will have a fully typed GenAI service that is less prone to bugs when dealing with changes, bad user inputs, and inconsistent model 
<span class="keep-together">responses.</span></p>

<p>To follow along, you can find the starting code for this chapter by switching to the <a href="https://github.com/Ali-Parandeh/building-generative-ai-services/tree/ch04-start"><code>ch04-start</code> branch</a>.</p>






<section data-pdf-bookmark="Introduction to Type Safety" data-type="sect1"><div class="sect1" id="id62">
<h1>Introduction to Type Safety</h1>

<p><a data-primary="type-safe AI services" data-secondary="type safety basics" data-type="indexterm" id="ix_ch04-asciidoc1"/><em>Types</em> <a data-primary="types, defined" data-type="indexterm" id="id741"/>in programming specify what values can be assigned to variables and operations that can be performed on those variables.</p>

<p>In Python, common types include the following:</p>
<dl>
<dt>Integer</dt>
<dd>
<p>Representing whole numbers</p>
</dd>
<dt>Float</dt>
<dd>
<p>Representing numbers with fractional parts</p>
</dd>
<dt>String</dt>
<dd>
<p>Representing sequences of characters</p>
</dd>
<dt>Boolean</dt>
<dd>
<p>Representing <code>True</code> or <code>False</code> values</p>
</dd>
</dl>
<div data-type="tip"><h6>Tip</h6>
<p>You can use the <code>typing</code> package to import special types as you saw in other code examples in <a data-type="xref" href="ch03.html#ch03">Chapter 3</a>.</p>
</div>

<p><a data-primary="type safety, defined" data-type="indexterm" id="id742"/><em>Type safety</em> is a programming practice that ensures variables are only assigned values compatible with their defined types.
In Python, you can use types to check the usage of variables across a codebase, in particular if the codebase grows in complexity and size.
Type checking tools (e.g., <code>mypy</code>) can then use these types to catch incorrect variable assignments or operations.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id743">
<h1>Static and Dynamically Typed Languages</h1>
<p><a data-primary="dynamically typed languages" data-type="indexterm" id="id744"/><a data-primary="type-safe AI services" data-secondary="static and dynamically typed languages" data-type="indexterm" id="id745"/>Python is one of the few languages that are <em>dynamically typed</em>, meaning types are checked only when you run the code, not in advance.
Also, you don’t have to explicitly declare types as they can be inferred as you assign values to variables.
However, as soon as your codebase becomes complex and your services start interacting with other systems like a filesystem, a database, or external services, you will face several reliability issues.</p>

<p>Using typing, you can catch errors more quickly.
Without typing, you must rely on tests, and insufficient test coverage can lead to production crashes due to mistakes.
At best, you remain unaware of minor issues and nuances affecting the user.
At worst, you risk data corruption or incur massive server costs, only discovering the damage when it is too late.</p>

<p><a data-primary="static languages" data-type="indexterm" id="id746"/>Static languages enforce the use of typing on developers for greater code reliability and execution speed, potentially at the cost of development speed.
On the other hand, in Python, typing isn’t enforced to offer flexibility, so you can build applications faster.
But the static type analysis in Python has evolved heavily with tools like <code>mypy</code>.</p>
</div></aside>

<p>You can enforce type constraints by declaring fully typed variables and functions as shown in <a data-type="xref" href="#type_safe_code">Example 4-1</a>.</p>
<div data-type="example" id="type_safe_code">
<h5><span class="label">Example 4-1. </span>Using types in Python</h5>

<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">datetime</code>

<code class="k">def</code> <code class="nf">timestamp_to_isostring</code><code class="p">(</code><code class="n">date</code><code class="p">:</code> <code class="nb">int</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">str</code><code class="p">:</code>
    <code class="k">return</code> <code class="n">datetime</code><code class="o">.</code><code class="n">fromtimestamp</code><code class="p">(</code><code class="n">date</code><code class="p">)</code><code class="o">.</code><code class="n">isoformat</code><code class="p">()</code>

<code class="nb">print</code><code class="p">(</code><code class="n">timestamp_to_isostring</code><code class="p">(</code><code class="mi">1736680773</code><code class="p">))</code>
<code class="c1"># 2025-01-12T11:19:52.876758</code>

<code class="nb">print</code><code class="p">(</code><code class="n">timestamp_to_isostring</code><code class="p">(</code><code class="s2">"27 Jan 2025 14:48:00"</code><code class="p">))</code>
<code class="c1"># error: Argument 1 to "timestamp_to_isostring" has incompatible type "str";</code>
<code class="c1"># expected "int" [arg-type]</code></pre></div>

<p>Code editors and IDEs (e.g., VS Code or JetBrains PyCharm) can also use type checking extensions, as shown in <a data-type="xref" href="#type_safety">Figure 4-1</a>, to raise warnings on type violations as you write code.</p>

<figure><div class="figure" id="type_safety">
<img alt="bgai 0401" src="assets/bgai_0401.png"/>
<h6><span class="label">Figure 4-1. </span>Catching type errors in VS Code <code>mypy</code> extension</h6>
</div></figure>

<p>In a complex codebase, it is easy to lose track of variables, their states, and constantly changing schemas.
For example, you might forget that the <code>timestamp_to_isostring</code> function accepts numbers as input and mistakenly pass a timestamp as a string, as shown in <a data-type="xref" href="#type_safety">Figure 4-1</a>.</p>

<p>Types are also extremely useful when package maintainers or external API providers update their code.
Type checkers can immediately raise warnings to help you address such changes during development.
This way, you will be immediately directed to sources of potential errors without having to run your code and test every endpoint.
As a result, type safety practices can save you time with early detection and prevent you from dealing with more obscure runtime errors.</p>

<p>Finally, you can go one step further to set up automatic type checks in your deployment pipeline to prevent pushing breaking changes to production environments.</p>

<p><a data-primary="type-safe AI services" data-secondary="barriers to implementing type safety" data-type="indexterm" id="ix_ch04-asciidoc2"/>Type safety at first seems like a burden.
You have to explicitly type each and every function you write, which can be a hassle and slow you down in the initial phases of development.</p>

<p>Some people skip typing their code for rapid prototyping and to write less boilerplate code.
The approach is more flexible and easier to use, and Python is powerful enough to infer simple types.
Also, some code patterns (such as functions with multitype arguments) can be so dynamic that it is easier to avoid implementing strict type safety when still experimenting.
However, it will come to save you hours of development as inevitably your services become complex and continuously change.</p>

<p>The good news is some of these types can be auto-generated using tools such as Prisma, when working with databases, or client generators, when working with external APIs.
For external APIs, you can often find official SDKs containing clients with type hints (i.e., fully typed client) specifying expected types of inputs and outputs for using the API.
If not, you can inspect the API to create your own fully typed client.
I will cover Prisma and API client generators in more detail later in the book.</p>

<p>When you don’t use types, you open yourself to all sorts of bugs and errors that might occur because other developers unexpectedly updated the database tables or API schemas that your service interacts with.
In other cases, you may update a database table—drop a column for instance—and forget to update the code interacting with that table.</p>

<p>Without types, you may never notice breaking changes due to updates. This can be challenging to debug as unhandled downstream errors might not pinpoint the broken component or general issues around unhandled edge cases from your own development team.
As a result, what might have taken a minute to resolve can last half a day or even longer.</p>

<p>You can always prevent a few disasters in production with extensive testing.
However, it’s much easier to avoid integration and reliability issues if you start using types from the start.</p>
<div data-type="tip"><h1>Developing good programming habits</h1>
<p>If you haven’t been typing your code in the past, it is never too late to start getting into the habit of typing all your variables, function parameters, and return types.<a data-startref="ix_ch04-asciidoc2" data-type="indexterm" id="id747"/></p>

<p>Using types will make your code more readable, help you catch bugs early on, and save you a lot of time when you revisit complex codebases to quickly understand how data flows.<a data-startref="ix_ch04-asciidoc1" data-type="indexterm" id="id748"/></p>
</div>
</div></section>






<section data-pdf-bookmark="Implementing Type Safety" data-type="sect1"><div class="sect1" id="id244">
<h1>Implementing Type Safety</h1>

<p><a data-primary="type-safe AI services" data-secondary="implementing type safety" data-type="indexterm" id="ix_ch04-asciidoc3"/>Since Python 3.5, you can explicitly declare types for your variables, function parameters, and return values.
The syntax that allows you to declare these types is <em>type annotation</em>.</p>








<section data-pdf-bookmark="Type Annotations" data-type="sect2"><div class="sect2" id="id63">
<h2>Type Annotations</h2>

<p><a data-primary="type annotations" data-type="indexterm" id="ix_ch04-asciidoc4"/><a data-primary="type-safe AI services" data-secondary="implementing type safety" data-tertiary="type annotations" data-type="indexterm" id="ix_ch04-asciidoc5"/>Type annotations don’t affect the runtime behavior of your application.
They help catch type errors, particularly in complex larger applications where multiple people are working together.
Tools for static type checking, such as <code>mypy</code>, <code>pyright</code>, or <code>pyre</code>, alongside code editors, can validate that the data types stored and returned from functions, match the expected types.</p>

<p>In Python applications, type annotations are used for:</p>

<ul>
<li>
<p><em>Code editor auto-complete support</em></p>
</li>
<li>
<p><em>Static type checks</em> using tools like <code>mypy</code></p>
</li>
</ul>

<p class="less_space pagebreak-before">FastAPI also leverages types hints to:</p>

<ul>
<li>
<p><em>Define handler requirements</em> including path and query parameters, bodies, headers, and dependencies, etc.</p>
</li>
<li>
<p><em>Convert data</em> whenever needed</p>
</li>
<li>
<p><em>Validate data</em> from incoming requests, databases, and external services</p>
</li>
<li>
<p><em>Auto-update the OpenAPI specification</em> that powers the generated documentation page</p>
</li>
</ul>

<p>You can install <code>loguru</code> using <code>pip</code>:</p>

<pre data-code-language="bash" data-type="programlisting">$ pip install loguru</pre>

<p><a data-type="xref" href="#type_annotation">Example 4-2</a> shows several examples of type annotation.</p>
<div data-type="example" id="type_annotation">
<h5><span class="label">Example 4-2. </span>Using type annotation to reduce future bugs as code changes occur</h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># utils.py</code>

<code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Literal</code><code class="p">,</code> <code class="n">TypeAlias</code>
<code class="kn">from</code> <code class="nn">loguru</code> <code class="kn">import</code> <code class="n">logger</code>
<code class="kn">import</code> <code class="nn">tiktoken</code>

<code class="n">SupportedModels</code><code class="p">:</code> <code class="n">TypeAlias</code> <code class="o">=</code> <code class="n">Literal</code><code class="p">[</code><code class="s2">"</code><code class="s2">gpt-3.5</code><code class="s2">"</code><code class="p">,</code> <code class="s2">"</code><code class="s2">gpt-4</code><code class="s2">"</code><code class="p">]</code>
<code class="n">PriceTable</code><code class="p">:</code> <code class="n">TypeAlias</code> <code class="o">=</code> <code class="nb">dict</code><code class="p">[</code><code class="n">SupportedModels</code><code class="p">,</code> <code class="nb">float</code><code class="p">]</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-1" id="co_implementing_type_safe_ai_services_CO1-1"><img alt="1" src="assets/1.png"/></a> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-2" id="co_implementing_type_safe_ai_services_CO1-2"><img alt="2" src="assets/2.png"/></a>
<code class="n">price_table</code><code class="p">:</code> <code class="n">PriceTable</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"</code><code class="s2">gpt-3.5</code><code class="s2">"</code><code class="p">:</code> <code class="mf">0.0030</code><code class="p">,</code> <code class="s2">"</code><code class="s2">gpt-4</code><code class="s2">"</code><code class="p">:</code> <code class="mf">0.0200</code><code class="p">}</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-3" id="co_implementing_type_safe_ai_services_CO1-3"><img alt="3" src="assets/3.png"/></a>

<code class="k">def</code> <code class="nf">count_tokens</code><code class="p">(</code><code class="n">text</code><code class="p">:</code> <code class="nb">str</code> <code class="o">|</code> <code class="kc">None</code><code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="nb">int</code><code class="p">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-4" id="co_implementing_type_safe_ai_services_CO1-4"><img alt="4" src="assets/4.png"/></a>
    <code class="k">if</code> <code class="n">text</code> <code class="ow">is</code> <code class="kc">None</code><code class="p">:</code>
        <code class="n">logger</code><code class="o">.</code><code class="n">warning</code><code class="p">(</code><code class="s2">"</code><code class="s2">Response is None. Assuming 0 tokens used</code><code class="s2">"</code><code class="p">)</code>
        <code class="k">return</code> <code class="mi">0</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-5" id="co_implementing_type_safe_ai_services_CO1-5"><img alt="5" src="assets/5.png"/></a>
    <code class="n">enc</code> <code class="o">=</code> <code class="n">tiktoken</code><code class="o">.</code><code class="n">encoding_for_model</code><code class="p">(</code><code class="s2">"</code><code class="s2">gpt-4o</code><code class="s2">"</code><code class="p">)</code>
    <code class="k">return</code> <code class="nb">len</code><code class="p">(</code><code class="n">enc</code><code class="o">.</code><code class="n">encode</code><code class="p">(</code><code class="n">text</code><code class="p">)</code><code class="p">)</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-6" id="co_implementing_type_safe_ai_services_CO1-6"><img alt="6" src="assets/6.png"/></a>

<code class="k">def</code> <code class="nf">calculate_usage_costs</code><code class="p">(</code>
    <code class="n">prompt</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code>
    <code class="n">response</code><code class="p">:</code> <code class="nb">str</code> <code class="o">|</code> <code class="kc">None</code><code class="p">,</code>
    <code class="n">model</code><code class="p">:</code> <code class="n">SupportedModels</code><code class="p">,</code>
<code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="nb">tuple</code><code class="p">[</code><code class="nb">float</code><code class="p">,</code> <code class="nb">float</code><code class="p">,</code> <code class="nb">float</code><code class="p">]</code><code class="p">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-7" id="co_implementing_type_safe_ai_services_CO1-7"><img alt="7" src="assets/7.png"/></a>
    <code class="k">if</code> <code class="n">model</code> <code class="ow">not</code> <code class="ow">in</code> <code class="n">price_table</code><code class="p">:</code>
        <code class="c1"># raise at runtime - in case someone ignores type errors</code>
        <code class="k">raise</code> <code class="ne">ValueError</code><code class="p">(</code><code class="sa">f</code><code class="s2">"</code><code class="s2">Cost calculation is not supported for </code><code class="si">{</code><code class="n">model</code><code class="si">}</code><code class="s2"> model.</code><code class="s2">"</code><code class="p">)</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-8" id="co_implementing_type_safe_ai_services_CO1-8"><img alt="8" src="assets/8.png"/></a>
    <code class="n">price</code> <code class="o">=</code> <code class="n">price_table</code><code class="p">[</code><code class="n">model</code><code class="p">]</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-9" id="co_implementing_type_safe_ai_services_CO1-9"><img alt="9" src="assets/9.png"/></a>
    <code class="n">req_costs</code> <code class="o">=</code> <code class="n">price</code> <code class="o">*</code> <code class="n">count_tokens</code><code class="p">(</code><code class="n">prompt</code><code class="p">)</code> <code class="o">/</code> <code class="mi">1000</code>
    <code class="n">res_costs</code> <code class="o">=</code> <code class="n">price</code> <code class="o">*</code> <code class="n">count_tokens</code><code class="p">(</code><code class="n">response</code><code class="p">)</code> <code class="o">/</code> <code class="mi">1000</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-10" id="co_implementing_type_safe_ai_services_CO1-10"><img alt="10" src="assets/10.png"/></a>
    <code class="n">total_costs</code> <code class="o">=</code> <code class="n">req_costs</code> <code class="o">+</code> <code class="n">res_costs</code>
    <code class="k">return</code> <code class="n">req_costs</code><code class="p">,</code> <code class="n">res_costs</code><code class="p">,</code> <code class="n">total_costs</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-11" id="co_implementing_type_safe_ai_services_CO1-11"><img alt="11" src="assets/11.png"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-1" id="callout_implementing_type_safe_ai_services_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Use the <code>Literal</code> from Python’s <code>typing</code> module included in its standard library.<sup><a data-type="noteref" href="ch04.html#id749" id="id749-marker">1</a></sup>
Declare literals <code>gpt-3.5</code> and <code>gpt-4</code> and assign them to <code>SupportedModel</code> <em>type alias</em>.
The <code>PriceTable</code> is also a simple type alias that defines a dictionary with keys limited to <code>SupportedModel</code> literals and with values of type <code>float</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-2" id="callout_implementing_type_safe_ai_services_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Mark type aliases with <code>TypeAlias</code> to be explicit that they’re not a normal variable assignment.
Types are also normally declared using CamelCase as a best practice to differentiate them from variables.
You can now reuse the <code>PriceTable</code> type alias later.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-3" id="callout_implementing_type_safe_ai_services_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Declare the pricing table dictionary and assign the <code>PriceTable</code> type to explicitly limit what keys and values are allowed for in the pricing table dictionary.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-4" id="callout_implementing_type_safe_ai_services_CO1-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Type the <code>count_tokens</code> function to accept strings or <code>None</code> types and always return an integer.
Implement exception handling in case someone tries to pass in anything other than strings or <code>None</code> types.
When defining <code>count_tokens</code>, code editor and static checkers will raise warnings if <code>count_tokens</code> doesn’t return an integer even if it receives a <code>None</code> and raises errors if any other types other than string or <code>None</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-5" id="callout_implementing_type_safe_ai_services_CO1-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>Return <code>0</code> even if a <code>None</code> type is passed to ensure you comply with function typing.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-6" id="callout_implementing_type_safe_ai_services_CO1-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>Tokenize the given text using OpenAI’s <code>tiktoken</code> library using the same encoding that was used for the <code>gpt-4o</code> model.<sup><a data-type="noteref" href="ch04.html#id750" id="id750-marker">2</a></sup></p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-7" id="callout_implementing_type_safe_ai_services_CO1-7"><img alt="7" src="assets/7.png"/></a></dt>
<dd><p>Type the <code>calculate_usage_costs</code> function to always take a text prompt and the prespecified literals for <code>model</code> parameter.
Pass the <code>price_table</code> with the previously declared <code>PriceTable</code> type alias.
The function should return a tuple of three floats.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-8" id="callout_implementing_type_safe_ai_services_CO1-8"><img alt="8" src="assets/8.png"/></a></dt>
<dd><p>Type checkers will raise warnings when an unexpected model literal is passed in, but you should always check for incorrect inputs to functions and raise errors at runtime if an unexpected model parameter is passed in.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-9" id="callout_implementing_type_safe_ai_services_CO1-9"><img alt="9" src="assets/9.png"/></a></dt>
<dd><p>Grab the correct price from the pricing table.
No need to worry about exception handling, as there is no chance a <code>KeyError</code> can be raised here if an unsupported model is passed in.
If the pricing table is not updated, the function will raise a <code>ValueError</code> early on.
Catch the <code>KeyError</code>, issue a warning that pricing table needs updating and then reraise the <code>KeyError</code>
so that full details of the issue are still printed to the terminal, as you can’t make assumptions about prices.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-10" id="callout_implementing_type_safe_ai_services_CO1-10"><img alt="10" src="assets/10.png"/></a></dt>
<dd><p>Use <code>count_tokens</code> function to calculate the LLM request and response costs.
If for any reason the LLM doesn’t return a response (returns <code>None</code>), the <code>count_tokens</code> can handle it and assume zero tokens.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-11" id="callout_implementing_type_safe_ai_services_CO1-11"><img alt="11" src="assets/11.png"/></a></dt>
<dd><p>Return a tuple of three floats as per function typing.</p></dd>
</dl></div>

<p>In a complex codebase, it can be challenging to guess which data types are being passed around, especially if you make lots of changes everywhere.
With typed functions, you can be confident that unexpected parameters aren’t passed to functions that don’t yet support it.</p>

<p>As you can see from <a data-type="xref" href="#type_annotation">Example 4-2</a>, typing your code assists in catching unexpected bugs as you make updates to your code.
For instance, if you start using a new LLM model, you can’t yet calculate costs for the new model.
To support cost calculation for other LLM models, you first should update the pricing table, related typing, and any exception handling logic.
Once done, you can be pretty confident that your calculation logic is now extended to work with new model types.<a data-startref="ix_ch04-asciidoc5" data-type="indexterm" id="id751"/><a data-startref="ix_ch04-asciidoc4" data-type="indexterm" id="id752"/></p>
</div></section>








<section data-pdf-bookmark="Using Annotated" data-type="sect2"><div class="sect2" id="id64">
<h2>Using Annotated</h2>

<p><a data-primary="Annotated (typing module feature)" data-type="indexterm" id="ix_ch04-asciidoc6"/><a data-primary="type-safe AI services" data-secondary="implementing type safety" data-tertiary="using Annotated" data-type="indexterm" id="ix_ch04-asciidoc7"/>In <a data-type="xref" href="#type_annotation">Example 4-2</a>, you can use <code>Annotated</code> instead of type aliases.
<code>Annotated</code> is a feature of the <code>typing</code> module—​introduced in Python 3.9—​and is similar to type aliases for reusing types, but it allows you to also define <em>metadata</em> for your types.</p>

<p>The metadata doesn’t affect the type checkers but is useful for code documentation, analysis, and runtime inspections.</p>

<p>Since its introduction in Python 3.9, you can use <code>Annotated</code> as shown in <a data-type="xref" href="#annotated_usage">Example 4-3</a>.</p>
<div data-type="example" id="annotated_usage">
<h5><span class="label">Example 4-3. </span>Using <code>Annotated</code> to declare custom types with metadata</h5>

<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Annotated</code><code class="p">,</code> <code class="n">Literal</code>

<code class="n">SupportedModels</code> <code class="o">=</code> <code class="n">Annotated</code><code class="p">[</code>
    <code class="n">Literal</code><code class="p">[</code><code class="s2">"gpt-3.5-turbo"</code><code class="p">,</code> <code class="s2">"gpt-4o"</code><code class="p">],</code> <code class="s2">"Supported text models"</code>
<code class="p">]</code>
<code class="n">PriceTableType</code> <code class="o">=</code> <code class="n">Annotated</code><code class="p">[</code>
    <code class="nb">dict</code><code class="p">[</code><code class="n">SupportedModels</code><code class="p">,</code> <code class="nb">float</code><code class="p">],</code> <code class="s2">"Supported model pricing table"</code>
<code class="p">]</code>

<code class="n">prices</code><code class="p">:</code> <code class="n">PriceTableType</code> <code class="o">=</code> <code class="p">{</code>
    <code class="s2">"gpt-4o"</code><code class="p">:</code> <code class="mf">0.000638</code><code class="p">,</code>
    <code class="c1"># error: Dict entry 1 has incompatible type "Literal['gpt4-o']" [dict-item]</code>
    <code class="s2">"gpt4-o"</code><code class="p">:</code> <code class="mf">0.000638</code><code class="p">,</code>
    <code class="c1"># error: Dict entry 2 has incompatible type "Literal['gpt-4']" [dict-item]</code>
    <code class="s2">"gpt-4"</code><code class="p">:</code> <code class="mf">0.000638</code><code class="p">,</code>
<code class="p">}</code></pre></div>

<p>The <a href="https://oreil.ly/mtGcY">FastAPI documentation</a> recommends the use of 
<span class="keep-together"><code>Annotated</code></span> instead of type aliases for reusability, for enhanced type checks in the code editor, and for catching issues during runtime.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>Keep in mind that the <code>Annotated</code> feature requires a minimum of two arguments to work.
The first should be the type passed in, and the other arguments are the annotation or metadata you want to attach to the type such as a description, validation rule, or other metadata, as shown in <a data-type="xref" href="#annotated_usage">Example 4-3</a>.</p>
</div>

<p>Typing, while beneficial by itself, doesn’t address all aspects of data handling and structuring.
Thankfully, Python’s <em>dataclasses</em> from the standard library help to extend the typing system.</p>

<p>Let’s see how you can leverage dataclasses to improve typing across your application.<a data-startref="ix_ch04-asciidoc7" data-type="indexterm" id="id753"/><a data-startref="ix_ch04-asciidoc6" data-type="indexterm" id="id754"/></p>
</div></section>








<section data-pdf-bookmark="Dataclasses" data-type="sect2"><div class="sect2" id="id65">
<h2>Dataclasses</h2>

<p><a data-primary="dataclasses" data-type="indexterm" id="ix_ch04-asciidoc8"/><a data-primary="Python" data-secondary="dataclasses" data-type="indexterm" id="ix_ch04-asciidoc9"/><a data-primary="type-safe AI services" data-secondary="implementing type safety" data-tertiary="dataclasses" data-type="indexterm" id="ix_ch04-asciidoc10"/>Dataclasses were introduced in Python 3.7 as part of the standard library.
If you need custom data structures, you can use dataclasses to organize, store, and transfer data across your application.</p>

<p>They can help with avoiding code “smells” such as function parameter bloat, where a function is hard to use because it requires more than a handful of parameters.
Having a dataclass allows you to organize your data in a custom-defined structure and pass it as a single item to functions that require data from different places.</p>

<p>You can update <a data-type="xref" href="#type_annotation">Example 4-2</a> to leverage dataclasses, as shown in <a data-type="xref" href="#dataclasses">Example 4-4</a>.</p>
<div data-type="example" id="dataclasses">
<h5><span class="label">Example 4-4. </span>Using dataclasses to enforce type safety</h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># utils.py</code>

<code class="kn">from</code> <code class="nn">dataclasses</code> <code class="kn">import</code> <code class="n">dataclass</code>
<code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Literal</code><code class="p">,</code> <code class="n">TypeAlias</code>
<code class="kn">from</code> <code class="nn">utils</code> <code class="kn">import</code> <code class="n">count_tokens</code>

<code class="n">SupportedModels</code><code class="p">:</code> <code class="n">TypeAlias</code> <code class="o">=</code> <code class="n">Literal</code><code class="p">[</code><code class="s2">"</code><code class="s2">gpt-3.5</code><code class="s2">"</code><code class="p">,</code> <code class="s2">"</code><code class="s2">gpt-4</code><code class="s2">"</code><code class="p">]</code>
<code class="n">PriceTable</code><code class="p">:</code> <code class="n">TypeAlias</code> <code class="o">=</code> <code class="nb">dict</code><code class="p">[</code><code class="n">SupportedModels</code><code class="p">,</code> <code class="nb">float</code><code class="p">]</code>
<code class="n">prices</code><code class="p">:</code> <code class="n">PriceTable</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"</code><code class="s2">gpt-3.5</code><code class="s2">"</code><code class="p">:</code> <code class="mf">0.0030</code><code class="p">,</code> <code class="s2">"</code><code class="s2">gpt-4</code><code class="s2">"</code><code class="p">:</code> <code class="mf">0.0200</code><code class="p">}</code>

<code class="nd">@dataclass</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO2-1" id="co_implementing_type_safe_ai_services_CO2-1"><img alt="1" src="assets/1.png"/></a>
<code class="k">class</code> <code class="nc">Message</code><code class="p">:</code>
    <code class="n">prompt</code><code class="p">:</code> <code class="nb">str</code>
    <code class="n">response</code><code class="p">:</code> <code class="nb">str</code> <code class="o">|</code> <code class="kc">None</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO2-2" id="co_implementing_type_safe_ai_services_CO2-2"><img alt="2" src="assets/2.png"/></a>
    <code class="n">model</code><code class="p">:</code> <code class="n">SupportedModels</code>

<code class="nd">@dataclass</code>
<code class="k">class</code> <code class="nc">MessageCostReport</code><code class="p">:</code>
    <code class="n">req_costs</code><code class="p">:</code> <code class="nb">float</code>
    <code class="n">res_costs</code><code class="p">:</code> <code class="nb">float</code>
    <code class="n">total_costs</code><code class="p">:</code> <code class="nb">float</code>

<code class="c1"># Define count_tokens function as normal</code>
<code class="o">.</code><code class="o">.</code><code class="o">.</code>

<code class="k">def</code> <code class="nf">calculate_usage_costs</code><code class="p">(</code><code class="n">message</code><code class="p">:</code> <code class="n">Message</code><code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="n">MessageCostReport</code><code class="p">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO2-3" id="co_implementing_type_safe_ai_services_CO2-3"><img alt="3" src="assets/3.png"/></a>
    <code class="k">if</code> <code class="n">message</code><code class="o">.</code><code class="n">model</code> <code class="ow">not</code> <code class="ow">in</code> <code class="n">prices</code> <code class="p">:</code>
        <code class="c1"># raise at runtime - in case someone ignores type errors</code>
        <code class="k">raise</code> <code class="ne">ValueError</code><code class="p">(</code>
            <code class="sa">f</code><code class="s2">"</code><code class="s2">Cost calculation is not supported for </code><code class="si">{</code><code class="n">message</code><code class="o">.</code><code class="n">model</code><code class="si">}</code><code class="s2"> model.</code><code class="s2">"</code>
        <code class="p">)</code>
    <code class="n">price</code> <code class="o">=</code> <code class="n">prices</code><code class="p">[</code><code class="n">message</code><code class="o">.</code><code class="n">model</code><code class="p">]</code>
    <code class="n">req_costs</code> <code class="o">=</code> <code class="n">price</code> <code class="o">*</code> <code class="n">count_tokens</code><code class="p">(</code><code class="n">message</code><code class="o">.</code><code class="n">prompt</code><code class="p">)</code> <code class="o">/</code> <code class="mi">1000</code>
    <code class="n">res_costs</code> <code class="o">=</code> <code class="n">price</code> <code class="o">*</code> <code class="n">count_tokens</code><code class="p">(</code><code class="n">message</code><code class="o">.</code><code class="n">response</code><code class="p">)</code> <code class="o">/</code> <code class="mi">1000</code>
    <code class="n">total_costs</code> <code class="o">=</code> <code class="n">req_costs</code> <code class="o">+</code> <code class="n">res_costs</code>
    <code class="k">return</code> <code class="n">MessageCostReport</code><code class="p">(</code>
        <code class="n">req_costs</code><code class="o">=</code><code class="n">req_costs</code><code class="p">,</code> <code class="n">res_costs</code><code class="o">=</code><code class="n">res_costs</code><code class="p">,</code> <code class="n">total_costs</code><code class="o">=</code><code class="n">total_costs</code>
    <code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO2-1" id="callout_implementing_type_safe_ai_services_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Use dataclasses to decorate the <code>Message</code> and <code>MessageCost</code> classes as special classes for holding data.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO2-2" id="callout_implementing_type_safe_ai_services_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Type the <code>response</code> attribute to be either a <code>str</code> or <code>None</code>.
This is similar to using <code>Optional[str]</code> from the <code>typing</code> module.
This new syntax is available in Python 3.10 and later, using the new union operator: <code>|</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO2-3" id="callout_implementing_type_safe_ai_services_CO2-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Change the signature of the <code>calculate_usage_costs</code> function to use the predefined dataclasses.
This change simplifies the function signature.</p></dd>
</dl></div>

<p>You should aim to leverage dataclasses when your code accumulates code smells and becomes difficult to read.</p>

<p>The primary benefit of using dataclasses in <a data-type="xref" href="#dataclasses">Example 4-4</a> was to group related parameters to simplify the function signature.
In other scenarios, you may use dataclasses to:</p>

<ul class="less_space pagebreak-before">
<li>
<p>Eliminate code duplication</p>
</li>
<li>
<p>Shrink down code bloat (large classes or functions)</p>
</li>
<li>
<p>Refactor data clumps (variables that are commonly used together)</p>
</li>
<li>
<p>Prevent inadvertent data mutation</p>
</li>
<li>
<p>Promote data organization</p>
</li>
<li>
<p>Promote encapsulation</p>
</li>
<li>
<p>Enforce data validation</p>
</li>
</ul>

<p>They can also be used to implement many other code enhancements.</p>

<p>Dataclasses are an excellent tool to improve data organization and exchange anywhere in your application.
However, they don’t natively support several features when building API services:</p>
<dl>
<dt>Automatic data parsing</dt>
<dd>
<p>Parsing ISO datetime-formatted strings to datetime objects on assignment</p>
</dd>
<dt>Field validation</dt>
<dd>
<p>Performing complex checks on assignment of values to fields, such as checking if a string is too long</p>
</dd>
<dt>Serialization and deserialization</dt>
<dd>
<p>Converting between JSON and Pythonic data structures, especially when using uncommon types</p>
</dd>
<dt>Field filtering</dt>
<dd>
<p>Removing fields of objects that are unset or contain <code>None</code> values</p>
</dd>
</dl>

<p>None of the mentioned limitations would force you to move away from using dataclasses.
You should use dataclasses rather than normal classes when you need to create data-centric classes with minimal boilerplate code, as they automatically generate special methods, type annotations, and support for default values, reducing potential errors.
However, libraries such as <code>pydantic</code> support these features if you don’t want to implement your own custom logic (e.g., serializing datetime objects).</p>
<div data-type="tip"><h6>Tip</h6>
<p>FastAPI also supports dataclasses through Pydantic, which implements its own version of dataclasses with support for the aforementioned features, enabling you to migrate codebases that heavily use dataclasses<a data-startref="ix_ch04-asciidoc10" data-type="indexterm" id="id755"/><a data-startref="ix_ch04-asciidoc9" data-type="indexterm" id="id756"/><a data-startref="ix_ch04-asciidoc8" data-type="indexterm" id="id757"/>.<a data-startref="ix_ch04-asciidoc3" data-type="indexterm" id="id758"/></p>
</div>

<p>Let’s take a look at Pydantic next and what makes it great for building GenAI services.</p>
</div></section>
</div></section>






<section data-pdf-bookmark="Pydantic Models" data-type="sect1"><div class="sect1" id="id66">
<h1>Pydantic Models</h1>

<p><a data-primary="Pydantic" data-type="indexterm" id="ix_ch04-asciidoc11"/><a data-primary="type-safe AI services" data-secondary="Pydantic models" data-type="indexterm" id="ix_ch04-asciidoc12"/>Pydantic is the most widely used data validation library with support for custom validators and serializers.
Pydantic’s core logic is controlled by type annotations in Python and can emit data in JSON format, allowing for seamless integration with any other tools.</p>

<p>In addition, the core data validation logic in Pydantic V2 has been rewritten in Rust to maximize its speed and performance, positioning it as one of the fastest data validation libraries in Python.
As a result, Pydantic has heavily influenced FastAPI and 8,000 other packages in the Python ecosystem including Hugging Face, Django, and LangChain.
It is a battle-tested toolkit used by major tech companies with 141 million downloads a month at the time of writing, making it a suitable candidate for adoption in your projects in replacement for dataclasses.</p>

<p>Pydantic provides an extensive toolset for data validation and processing using its own <code>BaseModel</code> implementation.
Pydantic models share many similarities with dataclasses but differ in subtle areas.
When you create Pydantic models, a set of initialization hooks are called that add data validation, serialization, and JSON schema generation features to the models that vanilla dataclasses lack.</p>

<p>FastAPI tightly integrates with Pydantic and leverages its rich feature set under the hood for data processing.
Type checkers and code editors can also read Pydantic models similar to dataclasses to perform checks and provide auto-completions.</p>








<section data-pdf-bookmark="How to Use Pydantic" data-type="sect2"><div class="sect2" id="id245">
<h2>How to Use Pydantic</h2>

<p><a data-primary="Pydantic" data-secondary="how to use" data-type="indexterm" id="id759"/><a data-primary="type-safe AI services" data-secondary="Pydantic models" data-tertiary="how to use Pydantic" data-type="indexterm" id="id760"/>You can install Pydantic into your project using the following:</p>

<pre data-code-language="bash" data-type="programlisting">$ pip install pydantic</pre>

<p>Pydantic at its core implements a <code>BaseModel</code>, which is the primary method for defining models.
<a data-primary="models (Pydantic)" data-secondary="defined" data-type="indexterm" id="id761"/><em>Models</em> are simply classes that inherit from <code>BaseModel</code> and define fields as annotated attributes using type hints.
Any models can then be used as schemas to validate your data.</p>

<p>Aside from grouping data,<sup><a data-type="noteref" href="ch04.html#id762" id="id762-marker">3</a></sup> Pydantic models let you specify the request and response requirements of your service endpoints and validate incoming untrusted data from external sources.
You can also go as far as filter your LLM outputs using Pydantic models (and validators, which you will learn more about shortly).</p>

<p>You can create your own Pydantic models as shown in <a data-type="xref" href="#pydantic_models">Example 4-5</a>.</p>
<div data-type="example" id="pydantic_models">
<h5><span class="label">Example 4-5. </span>Creating Pydantic models</h5>

<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Literal</code>
<code class="kn">from</code> <code class="nn">pydantic</code> <code class="kn">import</code> <code class="n">BaseModel</code>

<code class="k">class</code> <code class="nc">TextModelRequest</code><code class="p">(</code><code class="n">BaseModel</code><code class="p">)</code><code class="p">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO3-1" id="co_implementing_type_safe_ai_services_CO3-1"><img alt="1" src="assets/1.png"/></a>
    <code class="n">model</code><code class="p">:</code> <code class="n">Literal</code><code class="p">[</code><code class="s2">"</code><code class="s2">gpt-3.5-turbo</code><code class="s2">"</code><code class="p">,</code> <code class="s2">"</code><code class="s2">gpt-4o</code><code class="s2">"</code><code class="p">]</code>
    <code class="n">prompt</code><code class="p">:</code> <code class="nb">str</code>
    <code class="n">temperature</code><code class="p">:</code> <code class="nb">float</code> <code class="o">=</code> <code class="mf">0.0</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO3-2" id="co_implementing_type_safe_ai_services_CO3-2"><img alt="2" src="assets/2.png"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO3-1" id="callout_implementing_type_safe_ai_services_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Define the <code>TextModelRequest</code> model inheriting the Pydantic <code>BaseModel</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO3-2" id="callout_implementing_type_safe_ai_services_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Set defaults if an explicit value isn’t provided.
For instance, set the <code>temperature</code> field to <code>0.0</code> if a value is not provided on initialization.</p></dd>
</dl></div>

<p><a data-type="xref" href="#pydantic_models">Example 4-5</a> also shows how you can switch your dataclasses into Pydantic models to leverage its many features.</p>
</div></section>








<section data-pdf-bookmark="Compound Pydantic Models" data-type="sect2"><div class="sect2" id="id67">
<h2>Compound Pydantic Models</h2>

<p><a data-primary="models (Pydantic)" data-secondary="compound models" data-type="indexterm" id="ix_ch04-asciidoc13"/><a data-primary="Pydantic" data-secondary="compound models" data-type="indexterm" id="ix_ch04-asciidoc14"/><a data-primary="type-safe AI services" data-secondary="Pydantic models" data-tertiary="compound Pydantic models" data-type="indexterm" id="ix_ch04-asciidoc15"/>With Pydantic models, you can declare data <em>schemas</em>, which define data structures supported in the operations of your service.
Additionally, you can also use inheritance for building compound models, as shown in <a data-type="xref" href="#pydantic_compound_models">Example 4-6</a>.</p>
<div data-type="example" id="pydantic_compound_models">
<h5><span class="label">Example 4-6. </span>Creating Pydantic models</h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># schemas.py</code>

<code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">datetime</code>
<code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Annotated</code><code class="p">,</code> <code class="n">Literal</code>
<code class="kn">from</code> <code class="nn">pydantic</code> <code class="kn">import</code> <code class="n">BaseModel</code>

<code class="k">class</code> <code class="nc">ModelRequest</code><code class="p">(</code><code class="n">BaseModel</code><code class="p">)</code><code class="p">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO4-1" id="co_implementing_type_safe_ai_services_CO4-1"><img alt="1" src="assets/1.png"/></a>
    <code class="n">prompt</code><code class="p">:</code> <code class="nb">str</code>

<code class="k">class</code> <code class="nc">ModelResponse</code><code class="p">(</code><code class="n">BaseModel</code><code class="p">)</code><code class="p">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO4-2" id="co_implementing_type_safe_ai_services_CO4-2"><img alt="2" src="assets/2.png"/></a>
    <code class="n">request_id</code><code class="p">:</code> <code class="nb">str</code>
    <code class="n">ip</code><code class="p">:</code> <code class="nb">str</code> <code class="o">|</code> <code class="kc">None</code>
    <code class="n">content</code><code class="p">:</code> <code class="nb">str</code> <code class="o">|</code> <code class="kc">None</code>
    <code class="n">created_at</code><code class="p">:</code> <code class="n">datetime</code> <code class="o">=</code> <code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="p">)</code>

<code class="k">class</code> <code class="nc">TextModelRequest</code><code class="p">(</code><code class="n">ModelRequest</code><code class="p">)</code><code class="p">:</code>
    <code class="n">model</code><code class="p">:</code> <code class="n">Literal</code><code class="p">[</code><code class="s2">"</code><code class="s2">gpt-3.5-turbo</code><code class="s2">"</code><code class="p">,</code> <code class="s2">"</code><code class="s2">gpt-4o</code><code class="s2">"</code><code class="p">]</code>
    <code class="n">temperature</code><code class="p">:</code> <code class="nb">float</code> <code class="o">=</code> <code class="mf">0.0</code>

<code class="k">class</code> <code class="nc">TextModelResponse</code><code class="p">(</code><code class="n">ModelResponse</code><code class="p">)</code><code class="p">:</code>
    <code class="n">tokens</code><code class="p">:</code> <code class="nb">int</code>

<code class="n">ImageSize</code> <code class="o">=</code> <code class="n">Annotated</code><code class="p">[</code><code class="nb">tuple</code><code class="p">[</code><code class="nb">int</code><code class="p">,</code> <code class="nb">int</code><code class="p">]</code><code class="p">,</code> <code class="s2">"</code><code class="s2">Width and height of an image in pixels</code><code class="s2">"</code><code class="p">]</code>

<code class="k">class</code> <code class="nc">ImageModelRequest</code><code class="p">(</code><code class="n">ModelRequest</code><code class="p">)</code><code class="p">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO4-3" id="co_implementing_type_safe_ai_services_CO4-3"><img alt="3" src="assets/3.png"/></a>
    <code class="n">model</code><code class="p">:</code> <code class="n">Literal</code><code class="p">[</code><code class="s2">"</code><code class="s2">tinysd</code><code class="s2">"</code><code class="p">,</code> <code class="s2">"</code><code class="s2">sd1.5</code><code class="s2">"</code><code class="p">]</code>
    <code class="n">output_size</code><code class="p">:</code> <code class="n">ImageSize</code>
    <code class="n">num_inference_steps</code><code class="p">:</code> <code class="nb">int</code> <code class="o">=</code> <code class="mi">200</code>

<code class="k">class</code> <code class="nc">ImageModelResponse</code><code class="p">(</code><code class="n">ModelResponse</code><code class="p">)</code><code class="p">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO4-4" id="co_implementing_type_safe_ai_services_CO4-4"><img alt="4" src="assets/4.png"/></a>
    <code class="n">size</code><code class="p">:</code> <code class="n">ImageSize</code>
    <code class="n">url</code><code class="p">:</code> <code class="nb">str</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO4-1" id="callout_implementing_type_safe_ai_services_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Define the <code>ModelRequest</code> model inheriting the Pydantic <code>BaseModel</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO4-2" id="callout_implementing_type_safe_ai_services_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Define the <code>ModelResponse</code>.
If the data for the <code>ip</code> optional field is not provided, then use the defaults of <code>None</code>.
The <code>content</code> field can be both bytes (for image images) or string (for text models).</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO4-3" id="callout_implementing_type_safe_ai_services_CO4-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Define the <code>TextModelRequest</code> and <code>ImageModelRequest</code> models by inheriting 
<span class="keep-together"><code>ModelRequest</code>.</span>
The optional temperature field by default is set to 0.0.
The <code>num_inference_steps</code> field for the <code>ImageModelRequest</code> model is optional and set to 200.
Both of these models will now require the prompt string field to be 
<span class="keep-together">provided</span>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO4-4" id="callout_implementing_type_safe_ai_services_CO4-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Define the <code>ImageModelResponse</code> and <code>TextModelResponse</code> models by inheriting the <code>ModelResponse</code> model.
For <code>TextModelResponse</code>, provide the count of tokens, and with <code>ImageModelResponse</code>, provide an image size in pixels alongside the remote URL for downloading the image.</p></dd>
</dl></div>

<p>With the models shown in <a data-type="xref" href="#pydantic_compound_models">Example 4-6</a>, you have schemas needed to define the requirements of your text and image generation endpoints.<a data-startref="ix_ch04-asciidoc15" data-type="indexterm" id="id763"/><a data-startref="ix_ch04-asciidoc14" data-type="indexterm" id="id764"/><a data-startref="ix_ch04-asciidoc13" data-type="indexterm" id="id765"/></p>
</div></section>








<section data-pdf-bookmark="Field Constraints and Validators" data-type="sect2"><div class="sect2" id="id68">
<h2>Field Constraints and Validators</h2>

<p><a data-primary="constrained types" data-type="indexterm" id="ix_ch04-asciidoc16"/><a data-primary="Pydantic" data-secondary="field constraints and validators" data-type="indexterm" id="ix_ch04-asciidoc17"/><a data-primary="type-safe AI services" data-secondary="Pydantic models" data-tertiary="field constraints and validators" data-type="indexterm" id="ix_ch04-asciidoc18"/>Aside from support for standard types, Pydantic also ships with <em>constrained types</em> such as <code>EmailStr</code>, <code>PositiveInt</code>, <code>UUID4</code>, <code>AnyHttpUrl</code>, and more
that can perform data validation out of the box during model initialization for common data formats.
The full list of Pydantic types is available in <a href="https://oreil.ly/xNbXX">the official documentation</a>.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Some constrained types such as <code>EmailStr</code> will require dependency packages to be installed to function but can be extremely useful for validating common data formats such as emails.</p>
</div>

<p>To define more custom and complex field constraints on top of Pydantic-constrained types, you can use the <code>Field</code> function from Pydantic with the <code>Annotated</code> type to introduce validation constraints such as a valid input range.</p>

<p><a data-type="xref" href="#pydantic_constrained_fields">Example 4-7</a> replaces the standard type hints in <a data-type="xref" href="#pydantic_compound_models">Example 4-6</a> with constrained types and <code>Field</code> functions to implement stricter data requirements for your endpoints based on model constraints.</p>
<div data-type="example" id="pydantic_constrained_fields">
<h5><span class="label">Example 4-7. </span>Using constrained fields</h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># schemas.py</code>

<code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">datetime</code>
<code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Annotated</code><code class="p">,</code> <code class="n">Literal</code>
<code class="kn">from</code> <code class="nn">uuid</code> <code class="kn">import</code> <code class="n">uuid4</code>
<code class="kn">from</code> <code class="nn">pydantic</code> <code class="kn">import</code> <code class="n">BaseModel</code><code class="p">,</code> <code class="n">Field</code><code class="p">,</code> <code class="n">HttpUrl</code><code class="p">,</code> <code class="n">IPvAnyAddress</code><code class="p">,</code> <code class="n">PositiveInt</code>

<code class="k">class</code> <code class="nc">ModelRequest</code><code class="p">(</code><code class="n">BaseModel</code><code class="p">)</code><code class="p">:</code>
    <code class="n">prompt</code><code class="p">:</code> <code class="n">Annotated</code><code class="p">[</code><code class="nb">str</code><code class="p">,</code> <code class="n">Field</code><code class="p">(</code><code class="n">min_length</code><code class="o">=</code><code class="mi">1</code><code class="p">,</code> <code class="n">max_length</code><code class="o">=</code><code class="mi">10000</code><code class="p">)</code><code class="p">]</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO5-1" id="co_implementing_type_safe_ai_services_CO5-1"><img alt="1" src="assets/1.png"/></a>

<code class="k">class</code> <code class="nc">ModelResponse</code><code class="p">(</code><code class="n">BaseModel</code><code class="p">)</code><code class="p">:</code>
    <code class="n">request_id</code><code class="p">:</code> <code class="n">Annotated</code><code class="p">[</code><code class="nb">str</code><code class="p">,</code> <code class="n">Field</code><code class="p">(</code><code class="n">default_factory</code><code class="o">=</code><code class="k">lambda</code><code class="p">:</code> <code class="n">uuid4</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">hex</code><code class="p">)</code><code class="p">]</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO5-2" id="co_implementing_type_safe_ai_services_CO5-2"><img alt="2" src="assets/2.png"/></a>
    <code class="c1"># no defaults set for ip field</code>
    <code class="c1"># raise ValidationError if a valid IP address or None is not provided</code>
    <code class="n">ip</code><code class="p">:</code> <code class="n">Annotated</code><code class="p">[</code><code class="nb">str</code><code class="p">,</code> <code class="n">IPvAnyAddress</code><code class="p">]</code> <code class="o">|</code> <code class="kc">None</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO5-3" id="co_implementing_type_safe_ai_services_CO5-3"><img alt="3" src="assets/3.png"/></a>
    <code class="n">content</code><code class="p">:</code> <code class="n">Annotated</code><code class="p">[</code><code class="nb">str</code> <code class="o">|</code> <code class="kc">None</code><code class="p">,</code> <code class="n">Field</code><code class="p">(</code><code class="n">min_length</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="n">max_length</code><code class="o">=</code><code class="mi">10000</code><code class="p">)</code><code class="p">]</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO5-4" id="co_implementing_type_safe_ai_services_CO5-4"><img alt="4" src="assets/4.png"/></a>
    <code class="n">created_at</code><code class="p">:</code> <code class="n">datetime</code> <code class="o">=</code> <code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="p">)</code>

<code class="k">class</code> <code class="nc">TextModelRequest</code><code class="p">(</code><code class="n">ModelRequest</code><code class="p">)</code><code class="p">:</code>
    <code class="n">model</code><code class="p">:</code> <code class="n">Literal</code><code class="p">[</code><code class="s2">"</code><code class="s2">gpt-3.5-turbo</code><code class="s2">"</code><code class="p">,</code> <code class="s2">"</code><code class="s2">gpt-4o</code><code class="s2">"</code><code class="p">]</code>
    <code class="n">temperature</code><code class="p">:</code> <code class="n">Annotated</code><code class="p">[</code><code class="nb">float</code><code class="p">,</code> <code class="n">Field</code><code class="p">(</code><code class="n">ge</code><code class="o">=</code><code class="mf">0.0</code><code class="p">,</code> <code class="n">le</code><code class="o">=</code><code class="mf">1.0</code><code class="p">,</code> <code class="n">default</code><code class="o">=</code><code class="mf">0.0</code><code class="p">)</code><code class="p">]</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO5-5" id="co_implementing_type_safe_ai_services_CO5-5"><img alt="5" src="assets/5.png"/></a>

<code class="k">class</code> <code class="nc">TextModelResponse</code><code class="p">(</code><code class="n">ModelResponse</code><code class="p">)</code><code class="p">:</code>
    <code class="n">tokens</code><code class="p">:</code> <code class="n">Annotated</code><code class="p">[</code><code class="nb">int</code><code class="p">,</code> <code class="n">Field</code><code class="p">(</code><code class="n">ge</code><code class="o">=</code><code class="mi">0</code><code class="p">)</code><code class="p">]</code>

<code class="n">ImageSize</code> <code class="o">=</code> <code class="n">Annotated</code><code class="p">[</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO5-6" id="co_implementing_type_safe_ai_services_CO5-6"><img alt="6" src="assets/6.png"/></a>
    <code class="nb">tuple</code><code class="p">[</code><code class="n">PositiveInt</code><code class="p">,</code> <code class="n">PositiveInt</code><code class="p">]</code><code class="p">,</code> <code class="s2">"</code><code class="s2">Width and height of an image in pixels</code><code class="s2">"</code>
<code class="p">]</code>

<code class="k">class</code> <code class="nc">ImageModelRequest</code><code class="p">(</code><code class="n">ModelRequest</code><code class="p">)</code><code class="p">:</code>
    <code class="n">model</code><code class="p">:</code> <code class="n">Literal</code><code class="p">[</code><code class="s2">"</code><code class="s2">tinysd</code><code class="s2">"</code><code class="p">,</code> <code class="s2">"</code><code class="s2">sd1.5</code><code class="s2">"</code><code class="p">]</code>
    <code class="n">output_size</code><code class="p">:</code> <code class="n">ImageSize</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO5-6" id="co_implementing_type_safe_ai_services_CO5-7"><img alt="6" src="assets/6.png"/></a>
    <code class="n">num_inference_steps</code><code class="p">:</code> <code class="n">Annotated</code><code class="p">[</code><code class="nb">int</code><code class="p">,</code> <code class="n">Field</code><code class="p">(</code><code class="n">ge</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="n">le</code><code class="o">=</code><code class="mi">2000</code><code class="p">)</code><code class="p">]</code> <code class="o">=</code> <code class="mi">200</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO5-7" id="co_implementing_type_safe_ai_services_CO5-8"><img alt="7" src="assets/7.png"/></a>

<code class="k">class</code> <code class="nc">ImageModelResponse</code><code class="p">(</code><code class="n">ModelResponse</code><code class="p">)</code><code class="p">:</code>
    <code class="n">size</code><code class="p">:</code> <code class="n">ImageSize</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO5-6" id="co_implementing_type_safe_ai_services_CO5-9"><img alt="6" src="assets/6.png"/></a>
    <code class="n">url</code><code class="p">:</code> <code class="n">Annotated</code><code class="p">[</code><code class="nb">str</code><code class="p">,</code> <code class="n">HttpUrl</code><code class="p">]</code> <code class="o">|</code> <code class="kc">None</code> <code class="o">=</code> <code class="kc">None</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO5-8" id="co_implementing_type_safe_ai_services_CO5-10"><img alt="8" src="assets/8.png"/></a></pre>
<dl class="calloutlist pagebreak-before less_space">
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO5-1" id="callout_implementing_type_safe_ai_services_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Replace the <code>str</code> standard type with <code>Field</code> and <code>Annotated</code> to bound the string length to a range of characters.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO5-2" id="callout_implementing_type_safe_ai_services_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Generate a new request UUID by passing a callable to <code>default_factory</code> that will be called to generate a new UUID.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO5-3" id="callout_implementing_type_safe_ai_services_CO5-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Constrain the optional <code>ip</code> field to any valid IPv4 or IPv6 address ranges.
<code>None</code> is also a valid entry if the client’s IP can’t be determined.
This optional field doesn’t have a default value, so if a valid IP or <code>None</code> is not provided, Pydantic will raise a <code>ValidationError</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO5-4" id="callout_implementing_type_safe_ai_services_CO5-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Constrain the <code>content</code> field to 10,000 characters or bytes.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO5-5" id="callout_implementing_type_safe_ai_services_CO5-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>Constrain the temperature between <code>0.0</code> and <code>1.0</code> with a default value of <code>0.0</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO5-6" id="callout_implementing_type_safe_ai_services_CO5-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>Reuse an <code>Annotated</code> constrain on the <code>output_size</code> field to positive integers using the <code>PositiveInt</code> constrained type.
The <code>lte</code> and <code>gte</code> keywords refer to <em>less than equal</em> and <em>greater than equal</em>, respectively.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO5-8" id="callout_implementing_type_safe_ai_services_CO5-7"><img alt="7" src="assets/7.png"/></a></dt>
<dd><p>Constrain the <code>num_inference_steps</code> field with <code>Field</code> between <code>0</code> and <code>2000</code> and a default of <code>200</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO5-10" id="callout_implementing_type_safe_ai_services_CO5-8"><img alt="8" src="assets/8.png"/></a></dt>
<dd><p>Constrain the optional <code>url</code> field to any valid HTTP or HTTPS URL, where the hostname and top-level domain (TLD) are required.</p></dd>
</dl></div>

<p>With the models defined in <a data-type="xref" href="#pydantic_constrained_fields">Example 4-7</a>, you can now perform validation on incoming or outgoing data to match the data requirements you have.
In such cases, FastAPI will leverage Pydantic to automatically return error responses when data validation checks fail during a request runtime, as shown in <a data-type="xref" href="#fastapi_pydantic_validation_failure">Example 4-8</a>.<a data-startref="ix_ch04-asciidoc18" data-type="indexterm" id="id766"/><a data-startref="ix_ch04-asciidoc17" data-type="indexterm" id="id767"/><a data-startref="ix_ch04-asciidoc16" data-type="indexterm" id="id768"/></p>
<div data-type="example" id="fastapi_pydantic_validation_failure">
<h5><span class="label">Example 4-8. </span>FastAPI error response on data validation failure</h5>

<pre data-code-language="bash" data-type="programlisting">$ curl -X <code class="s1">'POST'</code> <code class="se">\</code>
  <code class="s1">'http://127.0.0.1:8000/validation/failure'</code> <code class="se">\</code>
  -H <code class="s1">'accept: application/json'</code> <code class="se">\</code>
  -H <code class="s1">'Content-Type: application/json'</code> <code class="se">\</code>
  -d <code class="s1">'{</code>
<code class="s1">  "prompt": "string",</code>
<code class="s1">  "model": "gpt-4o",</code>
<code class="s1">  "temperature": 0</code>
<code class="s1">}'</code>

<code class="o">{</code>
  <code class="s2">"detail"</code>: <code class="o">[</code>
    <code class="o">{</code>
      <code class="s2">"type"</code>: <code class="s2">"literal_error"</code>,
      <code class="s2">"loc"</code>: <code class="o">[</code>
        <code class="s2">"body"</code>,
        <code class="s2">"model"</code>
      <code class="o">]</code>,
      <code class="s2">"msg"</code>: <code class="s2">"Input should be 'tinyllama' or 'gemma2b'"</code>,
      <code class="s2">"input"</code>: <code class="s2">"gpt-4o"</code>,
      <code class="s2">"ctx"</code>: <code class="o">{</code>
        <code class="s2">"expected"</code>: <code class="s2">"'tinyllama' or 'gemma2b'"</code>
      <code class="o">}</code>
    <code class="o">}</code>
  <code class="o">]</code>
<code class="o">}</code></pre></div>
</div></section>








<section data-pdf-bookmark="Custom Field and Model Validators" data-type="sect2"><div class="sect2" id="id69">
<h2>Custom Field and Model Validators</h2>

<p><a data-primary="custom field validators" data-type="indexterm" id="ix_ch04-asciidoc19"/><a data-primary="Pydantic" data-secondary="custom field and model validators" data-type="indexterm" id="ix_ch04-asciidoc20"/><a data-primary="type-safe AI services" data-secondary="Pydantic models" data-tertiary="custom field and model validators" data-type="indexterm" id="ix_ch04-asciidoc21"/>Another excellent feature of Pydantic for performing data validation checks is <em>custom field validators</em>. <a data-type="xref" href="#field_validators">Example 4-9</a> shows how both types of custom validators can be implemented on the <code>ImageModelRequest</code>.</p>
<div data-type="example" id="field_validators">
<h5><span class="label">Example 4-9. </span>Implementing custom field and model validators for <code>ImageModelRequest</code></h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># schemas.py</code>

<code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Annotated</code><code class="p">,</code> <code class="n">Literal</code>
<code class="kn">from</code> <code class="nn">pydantic</code> <code class="kn">import</code> <code class="p">(</code>
    <code class="n">AfterValidator</code><code class="p">,</code>
    <code class="n">BaseModel</code><code class="p">,</code>
    <code class="n">Field</code><code class="p">,</code>
    <code class="n">PositiveInt</code><code class="p">,</code>
    <code class="n">validate_call</code><code class="p">,</code>
<code class="p">)</code>

<code class="n">ImageSize</code> <code class="o">=</code> <code class="n">Annotated</code><code class="p">[</code>
    <code class="nb">tuple</code><code class="p">[</code><code class="n">PositiveInt</code><code class="p">,</code> <code class="n">PositiveInt</code><code class="p">]</code><code class="p">,</code> <code class="s2">"</code><code class="s2">Width and height of an image in pixels</code><code class="s2">"</code>
<code class="p">]</code>
<code class="n">SupportedModels</code> <code class="o">=</code> <code class="n">Annotated</code><code class="p">[</code>
    <code class="n">Literal</code><code class="p">[</code><code class="s2">"</code><code class="s2">tinysd</code><code class="s2">"</code><code class="p">,</code> <code class="s2">"</code><code class="s2">sd1.5</code><code class="s2">"</code><code class="p">]</code><code class="p">,</code> <code class="s2">"</code><code class="s2">Supported Image Generation Models</code><code class="s2">"</code>
<code class="p">]</code>

<code class="nd">@validate_call</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO6-1" id="co_implementing_type_safe_ai_services_CO6-1"><img alt="1" src="assets/1.png"/></a>
<code class="k">def</code> <code class="nf">is_square_image</code><code class="p">(</code><code class="n">value</code><code class="p">:</code> <code class="n">ImageSize</code><code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="n">ImageSize</code><code class="p">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO6-2" id="co_implementing_type_safe_ai_services_CO6-2"><img alt="2" src="assets/2.png"/></a>
    <code class="k">if</code> <code class="n">value</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">/</code> <code class="n">value</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code> <code class="o">!=</code> <code class="mi">1</code><code class="p">:</code>
        <code class="k">raise</code> <code class="ne">ValueError</code><code class="p">(</code><code class="s2">"</code><code class="s2">Only square images are supported</code><code class="s2">"</code><code class="p">)</code>
    <code class="k">if</code> <code class="n">value</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="ow">not</code> <code class="ow">in</code> <code class="p">[</code><code class="mi">512</code><code class="p">,</code> <code class="mi">1024</code><code class="p">]</code><code class="p">:</code>
        <code class="k">raise</code> <code class="ne">ValueError</code><code class="p">(</code><code class="sa">f</code><code class="s2">"</code><code class="s2">Invalid output size: </code><code class="si">{</code><code class="n">value</code><code class="si">}</code><code class="s2"> - expected 512 or 1024</code><code class="s2">"</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">value</code>

<code class="nd">@validate_call</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO6-1" id="co_implementing_type_safe_ai_services_CO6-3"><img alt="1" src="assets/1.png"/></a>
<code class="k">def</code> <code class="nf">is_valid_inference_step</code><code class="p">(</code>
    <code class="n">num_inference_steps</code><code class="p">:</code> <code class="nb">int</code><code class="p">,</code> <code class="n">model</code><code class="p">:</code> <code class="n">SupportedModels</code>
<code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="nb">int</code><code class="p">:</code>
    <code class="k">if</code> <code class="n">model</code> <code class="o">==</code> <code class="s2">"</code><code class="s2">tinysd</code><code class="s2">"</code> <code class="ow">and</code> <code class="n">num_inference_steps</code> <code class="o">&gt;</code> <code class="mi">2000</code><code class="p">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO6-3" id="co_implementing_type_safe_ai_services_CO6-4"><img alt="3" src="assets/3.png"/></a>
        <code class="k">raise</code> <code class="ne">ValueError</code><code class="p">(</code>
            <code class="s2">"</code><code class="s2">TinySD model cannot have more than 2000 inference steps</code><code class="s2">"</code>
        <code class="p">)</code>
    <code class="k">return</code> <code class="n">num_inference_steps</code>

<code class="n">OutputSize</code> <code class="o">=</code> <code class="n">Annotated</code><code class="p">[</code><code class="n">ImageSize</code><code class="p">,</code> <code class="n">AfterValidator</code><code class="p">(</code><code class="n">is_square_image</code><code class="p">)</code><code class="p">]</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO6-4" id="co_implementing_type_safe_ai_services_CO6-5"><img alt="4" src="assets/4.png"/></a>
<code class="n">InferenceSteps</code> <code class="o">=</code> <code class="n">Annotated</code><code class="p">[</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO6-4" id="co_implementing_type_safe_ai_services_CO6-6"><img alt="4" src="assets/4.png"/></a>
    <code class="nb">int</code><code class="p">,</code>
    <code class="n">AfterValidator</code><code class="p">(</code>
        <code class="k">lambda</code> <code class="n">v</code><code class="p">,</code> <code class="n">values</code><code class="p">:</code> <code class="n">is_valid_inference_step</code><code class="p">(</code><code class="n">v</code><code class="p">,</code> <code class="n">values</code><code class="p">[</code><code class="s2">"</code><code class="s2">model</code><code class="s2">"</code><code class="p">]</code><code class="p">)</code>
    <code class="p">)</code><code class="p">,</code>
<code class="p">]</code>

<code class="k">class</code> <code class="nc">ModelRequest</code><code class="p">(</code><code class="n">BaseModel</code><code class="p">)</code><code class="p">:</code>
    <code class="n">prompt</code><code class="p">:</code> <code class="n">Annotated</code><code class="p">[</code><code class="nb">str</code><code class="p">,</code> <code class="n">Field</code><code class="p">(</code><code class="n">min_length</code><code class="o">=</code><code class="mi">1</code><code class="p">,</code> <code class="n">max_length</code><code class="o">=</code><code class="mi">4000</code><code class="p">)</code><code class="p">]</code>

<code class="k">class</code> <code class="nc">ImageModelRequest</code><code class="p">(</code><code class="n">ModelRequest</code><code class="p">)</code><code class="p">:</code>
    <code class="n">model</code><code class="p">:</code> <code class="n">SupportedModels</code>
    <code class="n">output_size</code><code class="p">:</code> <code class="n">OutputSize</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO6-5" id="co_implementing_type_safe_ai_services_CO6-7"><img alt="5" src="assets/5.png"/></a>
    <code class="n">num_inference_steps</code><code class="p">:</code> <code class="n">InferenceSteps</code> <code class="o">=</code> <code class="mi">200</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO6-6" id="co_implementing_type_safe_ai_services_CO6-8"><img alt="6" src="assets/6.png"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO6-1" id="callout_implementing_type_safe_ai_services_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>In addition to static type checks, raise a runtime validation error if incorrect parameters have been passed to both the <code>is_square_image</code> and <code>is_valid_​infer⁠ence_step</code> functions.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO6-2" id="callout_implementing_type_safe_ai_services_CO6-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>tinysd</code> model can generate square images in certain sizes only.
Asking for a nonsquare image size (an aspect ratio other than <code>1</code>) should raise a <code>ValueError</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO6-4" id="callout_implementing_type_safe_ai_services_CO6-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Raise a <code>ValueError</code> if the user asks for a large number of inference steps for the <code>tinysd</code> model.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO6-5" id="callout_implementing_type_safe_ai_services_CO6-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Create reusable and more readable validators using the annotated pattern for both <code>OutputSize</code> and <code>InferenceSteps</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO6-7" id="callout_implementing_type_safe_ai_services_CO6-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>Attach the <code>OutputSize</code> field validator to the <code>output_size</code> field to check for incorrect values after the model is initialized.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO6-8" id="callout_implementing_type_safe_ai_services_CO6-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>Attach the <code>InferenceSteps</code> validator to the <code>ImageModelRequest</code> model to perform checks on the model field values <em>after</em> the model is initialized.</p></dd>
</dl></div>

<p>With custom field validators, as shown in <a data-type="xref" href="#field_validators">Example 4-9</a>, you can now be confident that your image generation endpoints will be protected from incorrect configurations provided by users.<a data-startref="ix_ch04-asciidoc21" data-type="indexterm" id="id769"/><a data-startref="ix_ch04-asciidoc20" data-type="indexterm" id="id770"/><a data-startref="ix_ch04-asciidoc19" data-type="indexterm" id="id771"/></p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>You can also use the decorator pattern to validate model fields.

<span class="keep-together">Special</span> methods can be associated with model fields to execute conditional data checks by employing the <code>@field_validator</code> or <code>@model_validator</code> decorator.</p>

<p>While <code>@field_validator</code> accesses a value of a single field to perform checks, the <code>@model_validator</code> decorator allows for checks that involve multiple fields.</p>

<p>With <code>after</code> validators, you can perform extra checks or modify the data after Pydantic has completed its parsing and validation.</p>
</div>
</div></section>








<section data-pdf-bookmark="Computed Fields" data-type="sect2"><div class="sect2" id="id70">
<h2>Computed Fields</h2>

<p><a data-primary="computed fields (Pydantic)" data-type="indexterm" id="id772"/><a data-primary="Pydantic" data-secondary="computed fields" data-type="indexterm" id="id773"/><a data-primary="type-safe AI services" data-secondary="Pydantic models" data-tertiary="computed fields" data-type="indexterm" id="id774"/>Similar to dataclasses, Pydantic also allows you to implement methods to compute fields derived from other fields.</p>

<p>You can use the <code>@computed_field</code> decorator to implement a computed field for calculating count of tokens and cost, as shown in <a data-type="xref" href="#computed_fields">Example 4-10</a>.</p>
<div data-type="example" id="computed_fields">
<h5><span class="label">Example 4-10. </span>Using computed fields to automatically count the total number of tokens</h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># schemas.py</code>

<code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Annotated</code>
<code class="kn">from</code> <code class="nn">pydantic</code> <code class="kn">import</code> <code class="n">computed_field</code><code class="p">,</code> <code class="n">Field</code>
<code class="kn">from</code> <code class="nn">utils</code> <code class="kn">import</code> <code class="n">count_tokens</code>

<code class="o">...</code>

<code class="k">class</code> <code class="nc">TextModelResponse</code><code class="p">(</code><code class="n">ModelResponse</code><code class="p">):</code>
    <code class="n">model</code><code class="p">:</code> <code class="n">SupportedModels</code>
    <code class="n">price</code><code class="p">:</code> <code class="n">Annotated</code><code class="p">[</code><code class="nb">float</code><code class="p">,</code> <code class="n">Field</code><code class="p">(</code><code class="n">ge</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="n">default</code><code class="o">=</code><code class="mf">0.01</code><code class="p">)]</code>
    <code class="n">temperature</code><code class="p">:</code> <code class="n">Annotated</code><code class="p">[</code><code class="nb">float</code><code class="p">,</code> <code class="n">Field</code><code class="p">(</code><code class="n">ge</code><code class="o">=</code><code class="mf">0.0</code><code class="p">,</code> <code class="n">le</code><code class="o">=</code><code class="mf">1.0</code><code class="p">,</code> <code class="n">default</code><code class="o">=</code><code class="mf">0.0</code><code class="p">)]</code>

    <code class="nd">@property</code>
    <code class="nd">@computed_field</code>
    <code class="k">def</code> <code class="nf">tokens</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">int</code><code class="p">:</code>
        <code class="k">return</code> <code class="n">count_tokens</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">content</code><code class="p">)</code>

    <code class="nd">@property</code>
    <code class="nd">@computed_field</code>
    <code class="k">def</code> <code class="nf">cost</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">float</code><code class="p">:</code>
        <code class="k">return</code> <code class="bp">self</code><code class="o">.</code><code class="n">price</code> <code class="o">*</code> <code class="bp">self</code><code class="o">.</code><code class="n">tokens</code></pre></div>

<p>Computed fields are useful for encapsulating any field computation logic inside your Pydantic models to keep code organized.
Bear in mind that computed fields are only accessible when you convert a Pydantic model to a dictionary using <code>.model_dump()</code> or via serialization when a FastAPI API handler returns a response.</p>
</div></section>








<section data-pdf-bookmark="Model Export and Serialization" data-type="sect2"><div class="sect2" id="id71">
<h2>Model Export and Serialization</h2>

<p><a data-primary="Pydantic" data-secondary="model export and serialization" data-type="indexterm" id="id775"/><a data-primary="type-safe AI services" data-secondary="Pydantic models" data-tertiary="model export and serialization" data-type="indexterm" id="id776"/>As Pydantic models can serialize to JSONs, the models you defined in <a data-type="xref" href="#pydantic_constrained_fields">Example 4-7</a> can also be dumped into (or be loaded from) JSON strings or Python dictionaries while maintaining any compound schemas, as shown in <a data-type="xref" href="#model_export">Example 4-11</a>.</p>
<div data-type="example" id="model_export">
<h5><span class="label">Example 4-11. </span>Exporting and serializing the <code>TextModelResponse</code> model</h5>

<pre data-code-language="python" data-type="programlisting"><code class="o">&gt;&gt;</code> <code class="n">response</code> <code class="o">=</code> <code class="n">TextModelResponse</code><code class="p">(</code><code class="n">content</code><code class="o">=</code><code class="s2">"FastAPI Generative AI Service"</code><code class="p">,</code> <code class="n">ip</code><code class="o">=</code><code class="kc">None</code><code class="p">)</code>
<code class="o">&gt;&gt;</code> <code class="n">response</code><code class="o">.</code><code class="n">model_dump</code><code class="p">(</code><code class="n">exclude_none</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>
<code class="p">{</code><code class="s1">'content'</code><code class="p">:</code> <code class="s1">'FastAPI Generative AI Service'</code><code class="p">,</code>
 <code class="s1">'cost'</code><code class="p">:</code> <code class="mf">0.06</code><code class="p">,</code>
 <code class="s1">'created_at'</code><code class="p">:</code> <code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="p">(</code><code class="mi">2024</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">42</code><code class="p">,</code> <code class="mi">38</code><code class="p">,</code> <code class="mi">729410</code><code class="p">),</code>
 <code class="s1">'price'</code><code class="p">:</code> <code class="mf">0.01</code><code class="p">,</code>
 <code class="s1">'request_id'</code><code class="p">:</code> <code class="s1">'a3f18d85dcb442baa887a505ae8d2cd7'</code><code class="p">,</code>
 <code class="s1">'tokens'</code><code class="p">:</code> <code class="mi">6</code><code class="p">}</code>

<code class="o">&gt;&gt;</code> <code class="n">response</code><code class="o">.</code><code class="n">model_dump_json</code><code class="p">(</code><code class="n">exclude_unset</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>
<code class="s1">'{"ip":null,"content":"FastAPI Generative AI Service","tokens":6,"cost":0.06}'</code></pre></div>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id777">
<h1>Exporting Pydantic Models to Dictionaries or JSON Strings</h1>
<p><a data-primary="JSON strings, exporting Pydantic models to" data-type="indexterm" id="id778"/><a data-primary="Pydantic" data-secondary="exporting models to dictionaries or JSON strings" data-type="indexterm" id="id779"/><a data-primary="Python dictionaries, exporting Pydantic models to" data-type="indexterm" id="id780"/><a data-primary="type-safe AI services" data-secondary="Pydantic models" data-tertiary="exporting models to dictionaries or JSON strings" data-type="indexterm" id="id781"/>When you create a Pydantic model, you also get access to type hints for the associated fields and can later export your model to Python dictionaries or JSON strings.
Pydantic will also allow you to exclude fields based on their values.
For instance, you can run <code>model.dict(exclude_none=True)</code> to return a dictionary without any of the fields that had been set to <code>None</code>.
Other options for excluding fields during export include:</p>
<dl>
<dt><code>exclude_unset</code></dt>
<dd>
<p>Only return the fields that were explicitly set during the model creation.</p>
</dd>
<dt><code>exclude_defaults</code></dt>
<dd>
<p>Only return the optional fields that were set to default values.</p>
</dd>
<dt><code>exclude_None</code></dt>
<dd>
<p>Only return fields that were set to <code>None</code>.</p>
</dd>
</dl>

<p>You can mix and match these conditions when exporting your models.
These options are extremely useful when working with models that have a large number of fields such as filters.
For example, if the client doesn’t specify certain filters as query parameters to your endpoint, you can exclude all unset filtering fields from your request filter model.</p>

<p>You can also use the same field exclusion features when exporting your Pydantic models to JSON strings using <code>model.json_dump(exclude_unset=True)</code>.</p>
</div></aside>
</div></section>








<section data-pdf-bookmark="Parsing Environment Variables with Pydantic" data-type="sect2"><div class="sect2" id="id72">
<h2>Parsing Environment Variables with Pydantic</h2>

<p><a data-primary="Pydantic Settings" data-type="indexterm" id="ix_ch04-asciidoc22a"/><a data-primary="environment variables, parsing with Pydantic Settings" data-type="indexterm" id="ix_ch04-asciidoc22"/><a data-primary="Pydantic" data-secondary="parsing environment variables" data-type="indexterm" id="ix_ch04-asciidoc23"/><a data-primary="type-safe AI services" data-secondary="Pydantic models" data-tertiary="parsing environment variables" data-type="indexterm" id="ix_ch04-asciidoc24"/>Alongside the <code>BaseModel</code>, Pydantic also implements a <code>Base</code> class for parsing settings and secrets from files.
This feature is provided in an optional Pydantic package called
<code>pydantic-settings</code>, which you can install as a dependency:</p>

<pre data-code-language="bash" data-type="programlisting">$ pip install pydantic-settings</pre>

<p>The <code>BaseSettings</code> class provides optional Pydantic features for loading a settings or config class from environment variables or secret files.
Using this feature, the settings values can be set in code or overridden by environment variables.</p>

<p>This is useful in production where you don’t want to expose secrets inside the code or the container environment.</p>

<p>When you create a model inheriting from <code>BaseSettings</code>, the model initializer will attempt to set values of each field using provided defaults.
If unsuccessful, the initializer will then read the values of any unset fields from the environment variables.</p>

<p>Given a dotenv environment file (ENV):</p>

<pre data-code-language="ini" data-type="programlisting"><code class="na">APP_SECRET</code><code class="o">=</code><code class="s">asdlkajdlkajdklaslkldjkasldjkasdjaslk</code>
<code class="na">DATABASE_URL</code><code class="o">=</code><code class="s">postgres://sa:password@localhost:5432/cms</code>
<code class="na">CORS_WHITELIST</code><code class="o">=</code><code class="s">["https://xyz.azurewebsites.net","http://localhost:3000"]</code></pre>

<p>An ENV is an environment variable file that can use a shell script syntax for key-value pairs.</p>

<p><a data-type="xref" href="#pydantic_settings">Example 4-12</a> shows parsing environment variables using <code>BaseSettings</code> in action.</p>
<div data-type="example" id="pydantic_settings">
<h5><span class="label">Example 4-12. </span>Using Pydantic <code>BaseSettings</code> to parse environment variables</h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># settings.py</code>

<code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Annotated</code>
<code class="kn">from</code> <code class="nn">pydantic</code> <code class="kn">import</code> <code class="n">Field</code><code class="p">,</code> <code class="n">HttpUrl</code><code class="p">,</code> <code class="n">PostgresDsn</code>
<code class="kn">from</code> <code class="nn">pydantic_settings</code> <code class="kn">import</code> <code class="n">BaseSettings</code><code class="p">,</code> <code class="n">SettingsConfigDict</code>

<code class="k">class</code> <code class="nc">AppSettings</code><code class="p">(</code><code class="n">BaseSettings</code><code class="p">)</code><code class="p">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO7-1" id="co_implementing_type_safe_ai_services_CO7-1"><img alt="1" src="assets/1.png"/></a>
    <code class="n">model_config</code> <code class="o">=</code> <code class="n">SettingsConfigDict</code><code class="p">(</code>
        <code class="n">env_file</code><code class="o">=</code><code class="s2">"</code><code class="s2">.env</code><code class="s2">"</code><code class="p">,</code> <code class="n">env_file_encoding</code><code class="o">=</code><code class="s2">"</code><code class="s2">utf-8</code><code class="s2">"</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO7-2" id="co_implementing_type_safe_ai_services_CO7-2"><img alt="2" src="assets/2.png"/></a>
    <code class="p">)</code>

    <code class="n">port</code><code class="p">:</code> <code class="n">Annotated</code><code class="p">[</code><code class="nb">int</code><code class="p">,</code> <code class="n">Field</code><code class="p">(</code><code class="n">default</code><code class="o">=</code><code class="mi">8000</code><code class="p">)</code><code class="p">]</code>
    <code class="n">app_secret</code><code class="p">:</code> <code class="n">Annotated</code><code class="p">[</code><code class="nb">str</code><code class="p">,</code> <code class="n">Field</code><code class="p">(</code><code class="n">min_length</code><code class="o">=</code><code class="mi">32</code><code class="p">)</code><code class="p">]</code>
    <code class="n">pg_dsn</code><code class="p">:</code> <code class="n">Annotated</code><code class="p">[</code>
        <code class="n">PostgresDsn</code><code class="p">,</code>
        <code class="n">Field</code><code class="p">(</code>
            <code class="n">alias</code><code class="o">=</code><code class="s2">"</code><code class="s2">DATABASE_URL</code><code class="s2">"</code><code class="p">,</code>
            <code class="n">default</code><code class="o">=</code><code class="s2">"</code><code class="s2">postgres://user:pass@localhost:5432/database</code><code class="s2">"</code><code class="p">,</code>
        <code class="p">)</code><code class="p">,</code>
    <code class="p">]</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO7-3" id="co_implementing_type_safe_ai_services_CO7-3"><img alt="3" src="assets/3.png"/></a>
    <code class="n">cors_whitelist_domains</code><code class="p">:</code> <code class="n">Annotated</code><code class="p">[</code>
        <code class="nb">set</code><code class="p">[</code><code class="n">HttpUrl</code><code class="p">]</code><code class="p">,</code>
        <code class="n">Field</code><code class="p">(</code><code class="n">alias</code><code class="o">=</code><code class="s2">"</code><code class="s2">CORS_WHITELIST</code><code class="s2">"</code><code class="p">,</code> <code class="n">default</code><code class="o">=</code><code class="p">[</code><code class="s2">"</code><code class="s2">http://localhost:3000</code><code class="s2">"</code><code class="p">]</code><code class="p">)</code><code class="p">,</code>
    <code class="p">]</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO7-4" id="co_implementing_type_safe_ai_services_CO7-4"><img alt="4" src="assets/4.png"/></a>


<code class="n">settings</code> <code class="o">=</code> <code class="n">AppSettings</code><code class="p">(</code><code class="p">)</code>
<code class="nb">print</code><code class="p">(</code><code class="n">settings</code><code class="o">.</code><code class="n">model_dump</code><code class="p">(</code><code class="p">)</code><code class="p">)</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO7-5" id="co_implementing_type_safe_ai_services_CO7-5"><img alt="5" src="assets/5.png"/></a>
<code class="sd">"""
{'port': 8000
 'app_secret': 'asdlkajdlkajdklaslkldjkasldjkasdjaslk',
 'pg_dsn': MultiHostUrl('postgres://sa:password@localhost:5432/cms'),
 'cors_whitelist_domains': {Url('http://localhost:3000/'),
                            Url('https://xyz.azurewebsites.net/')},
}
"""</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO7-1" id="callout_implementing_type_safe_ai_services_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Declare <code>AppSettings</code> inheriting from the <code>BaseSettings</code> class from the 
<span class="keep-together"><code>pydantic_settings</code></span> package.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO7-2" id="callout_implementing_type_safe_ai_services_CO7-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Configure <code>AppSettings</code> to read environment variables from the ENV file at the root of a project with the <code>UTF-8</code> encoding.
By default, the snake_case field names will map to environment variables names that are an uppercase version of those names.
For instance, <code>app_secret</code> becomes <code>APP_SECRET</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO7-3" id="callout_implementing_type_safe_ai_services_CO7-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Validate that the <code>DATABASE_URL</code> environment variable has a valid Postgres connection string format.
If not provided, set the default value.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO7-4" id="callout_implementing_type_safe_ai_services_CO7-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Check that the <code>CORS_WHITELIST</code> environment variable has a unique list of valid URLs with hostname and TLDs.
If not provided, set the default to a set with a single value of <code>http://localhost:3000</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO7-5" id="callout_implementing_type_safe_ai_services_CO7-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>We can check the <code>AppSettings</code> class is working by printing a dump of the model.</p></dd>
</dl></div>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>You<a data-startref="ix_ch04-asciidoc24" data-type="indexterm" id="id782"/><a data-startref="ix_ch04-asciidoc23" data-type="indexterm" id="id783"/><a data-startref="ix_ch04-asciidoc22" data-type="indexterm" id="id784"/><a data-startref="ix_ch04-asciidoc22a" data-type="indexterm" id="id785"/> can switch environment files when using the <code>_env_file</code> 
<span class="keep-together">argument:</span></p>

<pre data-code-language="python" data-type="programlisting"><code class="n">test_settings</code> <code class="o">=</code> <code class="n">AppSettings</code><code class="p">(</code><code class="n">_env_file</code><code class="o">=</code><code class="s2">"test.env"</code><code class="p">)</code></pre>
</div>
</div></section>








<section class="less_space pagebreak-before" data-pdf-bookmark="Dataclasses or Pydantic Models in FastAPI" data-type="sect2"><div class="sect2" id="id73">
<h2>Dataclasses or Pydantic Models in FastAPI</h2>

<p><a data-primary="dataclasses" data-type="indexterm" id="ix_ch04-asciidoc25"/><a data-primary="models (Pydantic)" data-secondary="in FastAPI" data-type="indexterm" id="ix_ch04-asciidoc26"/><a data-primary="Pydantic" data-secondary="dataclasses or Pydantic models in FastAPI" data-type="indexterm" id="ix_ch04-asciidoc27"/><a data-primary="type-safe AI services" data-secondary="Pydantic models" data-tertiary="Python dataclasses or Pydantic models in FastAPI" data-type="indexterm" id="ix_ch04-asciidoc28"/>Even though dataclasses support serialization of only the common types (e.g., <code>int</code>, <code>str</code>, <code>list</code>, etc.) and won’t perform field validation at runtime, FastAPI can still work with both Pydantic models and Python’s dataclasses.
For field validation and additional features, you should use Pydantic models.
<a data-type="xref" href="#dataclass_fastaspi">Example 4-13</a> shows how dataclasses can be used in FastAPI route handlers.</p>
<div data-type="example" id="dataclass_fastaspi">
<h5><span class="label">Example 4-13. </span>Using dataclasses in FastAPI</h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># schemas.py</code>

<code class="kn">from</code> <code class="nn">dataclasses</code> <code class="kn">import</code> <code class="n">dataclass</code>
<code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Literal</code>

<code class="nd">@dataclass</code>
<code class="k">class</code> <code class="nc">TextModelRequest</code><code class="p">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO8-1" id="co_implementing_type_safe_ai_services_CO8-1"><img alt="1" src="assets/1.png"/></a>
    <code class="n">model</code><code class="p">:</code> <code class="n">Literal</code><code class="p">[</code><code class="s2">"</code><code class="s2">tinyLlama</code><code class="s2">"</code><code class="p">,</code> <code class="s2">"</code><code class="s2">gemma2b</code><code class="s2">"</code><code class="p">]</code>
    <code class="n">prompt</code><code class="p">:</code> <code class="nb">str</code>
    <code class="n">temperature</code><code class="p">:</code> <code class="nb">float</code>

<code class="nd">@dataclass</code>
<code class="k">class</code> <code class="nc">TextModelResponse</code><code class="p">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO8-1" id="co_implementing_type_safe_ai_services_CO8-2"><img alt="1" src="assets/1.png"/></a>
    <code class="n">response</code><code class="p">:</code> <code class="nb">str</code>
    <code class="n">tokens</code><code class="p">:</code> <code class="nb">int</code>

<code class="c1"># main.py</code>

<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">Body</code><code class="p">,</code> <code class="n">FastAPI</code><code class="p">,</code> <code class="n">HTTPException</code><code class="p">,</code> <code class="n">status</code>
<code class="kn">from</code> <code class="nn">models</code> <code class="kn">import</code> <code class="n">generate_text</code><code class="p">,</code> <code class="n">load_text_model</code>
<code class="kn">from</code> <code class="nn">schemas</code> <code class="kn">import</code> <code class="n">TextModelRequest</code><code class="p">,</code> <code class="n">TextModelResponse</code>
<code class="kn">from</code> <code class="nn">utils</code> <code class="kn">import</code> <code class="n">count_tokens</code>

<code class="c1"># load lifespan</code>
<code class="o">.</code><code class="o">.</code><code class="o">.</code>

<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">(</code><code class="n">lifespan</code><code class="o">=</code><code class="n">lifespan</code><code class="p">)</code>

<code class="nd">@app</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"</code><code class="s2">/generate/text</code><code class="s2">"</code><code class="p">)</code>
<code class="k">def</code> <code class="nf">serve_text_to_text_controller</code><code class="p">(</code>
    <code class="n">body</code><code class="p">:</code> <code class="n">TextModelRequest</code> <code class="o">=</code> <code class="n">Body</code><code class="p">(</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">)</code><code class="p">,</code>
<code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="n">TextModelResponse</code><code class="p">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO8-2" id="co_implementing_type_safe_ai_services_CO8-3"><img alt="2" src="assets/2.png"/></a> <a class="co" href="#callout_implementing_type_safe_ai_services_CO8-4" id="co_implementing_type_safe_ai_services_CO8-4"><img alt="4" src="assets/4.png"/></a>
    <code class="k">if</code> <code class="n">body</code><code class="o">.</code><code class="n">model</code> <code class="ow">not</code> <code class="ow">in</code> <code class="p">[</code><code class="s2">"</code><code class="s2">tinyLlama</code><code class="s2">"</code><code class="p">,</code> <code class="s2">"</code><code class="s2">gemma2b</code><code class="s2">"</code><code class="p">]</code><code class="p">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO8-3" id="co_implementing_type_safe_ai_services_CO8-5"><img alt="3" src="assets/3.png"/></a>
        <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code>
            <code class="n">detail</code><code class="o">=</code><code class="sa">f</code><code class="s2">"</code><code class="s2">Model </code><code class="si">{</code><code class="n">body</code><code class="o">.</code><code class="n">model</code><code class="si">}</code><code class="s2"> is not supported</code><code class="s2">"</code><code class="p">,</code>
            <code class="n">status_code</code><code class="o">=</code><code class="n">status</code><code class="o">.</code><code class="n">HTTP_400_BAD_REQUEST</code><code class="p">,</code>
        <code class="p">)</code>
    <code class="n">output</code> <code class="o">=</code> <code class="n">generate_text</code><code class="p">(</code><code class="n">models</code><code class="p">[</code><code class="s2">"</code><code class="s2">text</code><code class="s2">"</code><code class="p">]</code><code class="p">,</code> <code class="n">body</code><code class="o">.</code><code class="n">prompt</code><code class="p">,</code> <code class="n">body</code><code class="o">.</code><code class="n">temperature</code><code class="p">)</code>
    <code class="n">tokens</code> <code class="o">=</code> <code class="n">count_tokens</code><code class="p">(</code><code class="n">body</code><code class="o">.</code><code class="n">prompt</code><code class="p">)</code> <code class="o">+</code> <code class="n">count_tokens</code><code class="p">(</code><code class="n">output</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">TextModelResponse</code><code class="p">(</code><code class="n">response</code><code class="o">=</code><code class="n">output</code><code class="p">,</code> <code class="n">tokens</code><code class="o">=</code><code class="n">tokens</code><code class="p">)</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO8-4" id="co_implementing_type_safe_ai_services_CO8-6"><img alt="4" src="assets/4.png"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO8-1" id="callout_implementing_type_safe_ai_services_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Define models for text model request and response schemas.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO8-3" id="callout_implementing_type_safe_ai_services_CO8-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Convert the handler to serve <code>POST</code> requests with a body.
Then, declare the request body as <code>TextModelRequest</code> and the response as <code>TextModelResponse</code>.
Static code checkers like <code>mypy</code> will read the type annotations and raise warnings if your controller doesn’t return the expected response model.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO8-5" id="callout_implementing_type_safe_ai_services_CO8-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Explicitly check whether the service supports the <code>model</code> parameter provided in the request <code>body</code>.
If not, return a bad request HTTP exception response to the client.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO8-4" id="callout_implementing_type_safe_ai_services_CO8-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>FastAPI converts vanilla dataclasses to Pydantic dataclasses to serialize/deserialize and validate the request and response data.</p></dd>
</dl></div>

<p>In <a data-type="xref" href="#dataclass_fastaspi">Example 4-13</a>, you have leveraged type annotations by refactoring the text model controller to be resilient to new changes and bad user input.
Static type checkers can now help you catch any data-related issues as changes occur.
In addition, FastAPI used your type annotations to validate request and responses alongside the auto-generation of an OpenAPI documentation page, as shown in <a data-type="xref" href="#fastapi_dataclasses_docs">Figure 4-2</a>.</p>

<p>You now see that FastAPI leverages Pydantic models under the hood for data handling and validation, even if you use vanilla dataclasses.
FastAPI converts your vanilla dataclasses to Pydantic-flavored dataclasses to use its data validation features.
This behavior is intentional because if you have projects with several pre-existing dataclass type annotations, you can still migrate them over without having to rewrite them into Pydantic models for leveraging data validation features.
However, if you’re starting a fresh project, it is recommended to use Pydantic models directly in replacement for Python’s built-in dataclasses.</p>

<figure><div class="figure" id="fastapi_dataclasses_docs">
<img alt="bgai 0402" src="assets/bgai_0402.png"/>
<h6><span class="label">Figure 4-2. </span>Automatic generation of validation schemas using vanilla dataclasses</h6>
</div></figure>

<p>Now let’s see how you can replace dataclasses with Pydantic in your FastAPI application.
See <a data-type="xref" href="#pydantic_fastapi">Example 4-14</a>.</p>
<div data-type="example" id="pydantic_fastapi">
<h5><span class="label">Example 4-14. </span>Using Pydantic to model request and response schemas</h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># main.py</code>

<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">Body</code><code class="p">,</code> <code class="n">FastAPI</code><code class="p">,</code> <code class="n">HTTPException</code><code class="p">,</code> <code class="n">Request</code><code class="p">,</code> <code class="n">status</code>
<code class="kn">from</code> <code class="nn">models</code> <code class="kn">import</code> <code class="n">generate_text</code>
<code class="kn">from</code> <code class="nn">schemas</code> <code class="kn">import</code> <code class="n">TextModelRequest</code><code class="p">,</code> <code class="n">TextModelResponse</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO9-1" id="co_implementing_type_safe_ai_services_CO9-1"><img alt="1" src="assets/1.png"/></a>

<code class="c1"># load lifespan</code>
<code class="o">.</code><code class="o">.</code><code class="o">.</code>

<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">(</code><code class="n">lifespan</code><code class="o">=</code><code class="n">lifespan</code><code class="p">)</code>

<code class="nd">@app</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"</code><code class="s2">/generate/text</code><code class="s2">"</code><code class="p">)</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO9-2" id="co_implementing_type_safe_ai_services_CO9-2"><img alt="2" src="assets/2.png"/></a>
<code class="k">def</code> <code class="nf">serve_text_to_text_controller</code><code class="p">(</code>
    <code class="n">request</code><code class="p">:</code> <code class="n">Request</code><code class="p">,</code> <code class="n">body</code><code class="p">:</code> <code class="n">TextModelRequest</code> <code class="o">=</code> <code class="n">Body</code><code class="p">(</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">)</code>
<code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="n">TextModelResponse</code><code class="p">:</code>
    <code class="k">if</code> <code class="n">body</code><code class="o">.</code><code class="n">model</code> <code class="ow">not</code> <code class="ow">in</code> <code class="p">[</code><code class="s2">"</code><code class="s2">tinyLlama</code><code class="s2">"</code><code class="p">,</code> <code class="s2">"</code><code class="s2">gemma2b</code><code class="s2">"</code><code class="p">]</code><code class="p">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO9-3" id="co_implementing_type_safe_ai_services_CO9-3"><img alt="3" src="assets/3.png"/></a>
        <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code>
            <code class="n">detail</code><code class="o">=</code><code class="sa">f</code><code class="s2">"</code><code class="s2">Model </code><code class="si">{</code><code class="n">body</code><code class="o">.</code><code class="n">model</code><code class="si">}</code><code class="s2"> is not supported</code><code class="s2">"</code><code class="p">,</code>
            <code class="n">status_code</code><code class="o">=</code><code class="n">status</code><code class="o">.</code><code class="n">HTTP_400_BAD_REQUEST</code><code class="p">,</code>
        <code class="p">)</code>
    <code class="n">output</code> <code class="o">=</code> <code class="n">generate_text</code><code class="p">(</code><code class="n">models</code><code class="p">[</code><code class="s2">"</code><code class="s2">text</code><code class="s2">"</code><code class="p">]</code><code class="p">,</code> <code class="n">body</code><code class="o">.</code><code class="n">prompt</code><code class="p">,</code> <code class="n">body</code><code class="o">.</code><code class="n">temperature</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">TextModelResponse</code><code class="p">(</code><code class="n">content</code><code class="o">=</code><code class="n">output</code><code class="p">,</code> <code class="n">ip</code><code class="o">=</code><code class="n">request</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">host</code><code class="p">)</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO9-4" id="co_implementing_type_safe_ai_services_CO9-4"><img alt="4" src="assets/4.png"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO9-1" id="callout_implementing_type_safe_ai_services_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Import Pydantic models for text model request and response schemas.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO9-2" id="callout_implementing_type_safe_ai_services_CO9-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Convert the handler to serve <code>POST</code> requests with a body.
Then, declare the request body as <code>TextModelRequest</code> and the response as <code>TextModelResponse</code>.
Static code checkers like <code>mypy</code> will read the type annotations and raise warnings if your controller doesn’t return the expected response model.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO9-3" id="callout_implementing_type_safe_ai_services_CO9-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Explicitly check whether the service supports the <code>model</code> parameter provided in the request <code>body</code>.
If not, return a bad request HTTP exception response to the client.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO9-4" id="callout_implementing_type_safe_ai_services_CO9-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Return the <code>TextModelResponse</code> Pydantic model as per the function typing.
Access the client’s IP address using the request object via <code>request.client.host</code>.
FastAPI will take care of serializing your model using <code>.model_dump()</code> under the hood.
As you also implemented the computed fields for <code>tokens</code> and <code>cost</code> properties, these will automatically will be included in your API response without any additional work.</p></dd>
</dl></div>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>As shown in <a data-type="xref" href="#dataclass_fastaspi">Example 4-13</a>, if you use dataclasses instead of Pydantic models, FastAPI will convert them to Pydantic dataclasses to serialize/deserialize and validate the request and response data.
However, you may not be able to leverage advanced features such as field constraints and computed fields with dataclasses.</p>
</div>

<p>As you can see in <a data-type="xref" href="#pydantic_fastapi">Example 4-14</a>, Pydantic can provide exceptional developer experience by helping in type checks, data validation, serialization, code editor auto-completions, and computed attributes.</p>

<p>FastAPI can also use your Pydantic models to auto-generate an OpenAPI specification and documentation page so that you can manually test your endpoints 
<span class="keep-together">seamlessly.</span></p>

<p>Once you start the server, you should see an updated documentation page with the new Pydantic models and the updated constrained fields, as shown in <a data-type="xref" href="#fastapi_pydnatic_models">Figure 4-3</a>.</p>

<figure><div class="figure" id="fastapi_pydnatic_models">
<img alt="bgai 0403" src="assets/bgai_0403.png"/>
<h6><span class="label">Figure 4-3. </span>Automatic generation of FastAPI docs using Pydantic models</h6>
</div></figure>

<p>If you send a request to the <code>/generate/text</code> endpoint, you should now see the 
<span class="keep-together">prepopulated</span> fields via the <code>TextModelResponse</code> Pydantic model, as shown in <a data-type="xref" href="#fastapi_pydnatic_docs">Example 4-15</a>.</p>
<div data-type="example" id="fastapi_pydnatic_docs">
<h5><span class="label">Example 4-15. </span>Automatic population of the response fields via the <code>TextModelResponse</code> Pydantic model</h5>

<pre data-type="programlisting">Request

curl -X 'POST' \
    'http://localhost:8000/generate/text' \
    -H 'accept: application/json' \
    -H 'Content-Type: application/json' \
    -d '{
    "prompt": "What is your name?",
    "model": "tinyllama",
    "temperature": 0.01
}'

http://localhost:8000/generate/text

&gt;&gt; Response body
{
    "request_id": "7541204d5c684f429fe43ccf360fЗ3dc",
    "ip": "127.0.0.1"
    "content": "I am not a person. However, I can provide you with information
        about my name. My name is fastapi bot.",
    "created_at": "2024-03-07T16:06:57.492039",
    "price": 0.01,
    "tokens": 25,
    "cost": 0.25
}

&gt;&gt; Response headers

content-length: 259
content-type: application/json
date: Thu, 07 Mar 2024 16:07:01 GMT
server: uvicorn
x-response-time: 22.9243</pre></div>

<p>The Pydantic model features I covered in this chapter represent just a fraction of the tools at your disposal for constructing GenAI services.
You should now feel more confident in leveraging Pydantic to annotate your own services to improve its reliability and your own developer experience<a data-startref="ix_ch04-asciidoc28" data-type="indexterm" id="id786"/><a data-startref="ix_ch04-asciidoc27" data-type="indexterm" id="id787"/><a data-startref="ix_ch04-asciidoc26" data-type="indexterm" id="id788"/><a data-startref="ix_ch04-asciidoc25" data-type="indexterm" id="id789"/>.<a data-startref="ix_ch04-asciidoc12" data-type="indexterm" id="id790"/><a data-startref="ix_ch04-asciidoc11" data-type="indexterm" id="id791"/></p>
</div></section>
</div></section>






<section class="less_space pagebreak-before" data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="id74">
<h1>Summary</h1>

<p>In this chapter, you learned the importance of creating fully typed services for GenAI models. You now understand how to implement type safety with standard and constrained types, how to use Pydantic models for data validation, and how to implement your own custom data validators across your GenAI service.
You also discovered strategies for validating request and response content and managing application settings with Pydantic to prevent bugs and to improve your development experience.
Overall, by following along with the practical examples, you learned how to implement a robust, less error-prone GenAI service.<a data-startref="ix_ch04-asciidoc0" data-type="indexterm" id="id792"/></p>

<p>The next chapter covers asynchronous programming in AI workloads, discussing performance and parallel operations.
You will learn more about I/O-bound and CPU-bound tasks and understand the role and limitations of FastAPI’s background tasks with concurrent workflows.</p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="id749"><sup><a href="ch04.html#id749-marker">1</a></sup> A <a href="https://oreil.ly/69Pmn"><code>Literal</code> type</a> can be used to indicate to type checkers that the annotated object has a value equivalent to one of the provided literals.</p><p data-type="footnote" id="id750"><sup><a href="ch04.html#id750-marker">2</a></sup> OpenAI’s <code>tiktoken</code> uses the <a href="https://oreil.ly/l67GS"><em>Byte-Pair Encoding</em> (BPE) algorithm</a> to tokenize text. Different models use different encodings to convert text into tokens.</p><p data-type="footnote" id="id762"><sup><a href="ch04.html#id762-marker">3</a></sup> Structs in C-like languages and dataclasses in Python can also be used to group and pass data around.</p></div></div></section></body></html>
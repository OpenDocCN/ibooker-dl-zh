<html><head></head><body><div id="book-content"><div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 4. Implementing Type-Safe AI Services" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch04">
<h1><span class="label">Capitolo 4. </span>Implementazione di servizi AI sicuri dal punto di vista tipologico</h1><div data-type="note"><p>Questo lavoro è stato tradotto utilizzando l'AI. Siamo lieti di ricevere il tuo feedback e i tuoi commenti: <a href="mailto:translation-feedback@oreilly.com">translation-feedback@oreilly.com</a></p></div>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id740">
<h1>Obiettivi del capitolo</h1>
<p><a data-primary="type-safe AI services" data-type="indexterm" id="ix_ch04-asciidoc0"/>In questo capitolo imparerai a conoscere:</p>
<ul>
<li>
<p>Perché è fondamentale avere dei servizi completamente digitalizzati</p>
</li>
<li>
<p>Come definire e implementare correttamente la sicurezza di tipo per i servizi GenAI</p>
</li>
<li>
<p>Similitudini e differenze tra le classi di dati e i modelli di dati Pydantic</p>
</li>
<li>
<p>Come convalidare il contenuto delle richieste e delle risposte nei servizi GenAI utilizzando i modelli Pydantic</p>
</li>
<li>
<p>Come costruire validatori personalizzati di campi e modelli di dati con Pydantic per evitare che i dati non corretti passino attraverso il tuo servizio</p>
</li>
<li>
<p>Come utilizzare il pacchetto Pydantic Settings per caricare e convalidare le variabili d'ambiente della tua applicazione</p>
</li>
<li>
<p>Come ridurre l'incertezza quando si lavora con sistemi esterni che cambiano gli schemi</p>
</li>
<li>
<p>Come gestire le modifiche man mano che la complessità cresce per evitare di introdurre bug non voluti</p>
</li>
</ul>
</div></aside>
<p>Quando lavori con codebase complesse che vengono modificate continuamente da più collaboratori e quando interagisci con servizi esterni come API o database, vorrai seguire le migliori pratiche come la sicurezza dei tipi nella creazione delle tue applicazioni.</p>
<p>Questo capitolo si concentra sull'importanza della sicurezza dei tipi nella creazione di servizi backend e API. Imparerai come implementare la sicurezza dei tipi utilizzando le classi di dati integrate in Python e i modelli di dati Pydantic, e vedrai le loro somiglianze e differenze. Inoltre, esplorerai come utilizzare i modelli di dati Pydantic con i validatori personalizzati per proteggerti da input errati da parte dell'utente o da dati non corretti, e imparerai come utilizzare le Impostazioni di Python per il caricamento e la convalida delle variabili d'ambiente. Infine, scoprirai le strategie per affrontare le modifiche allo schema nei sistemi esterni e per gestire la complessità in codebase in evoluzione per evitare bug.</p>
<p>Alla fine di questo capitolo, avrai un servizio GenAI completamente tipizzato e meno soggetto a bug quando si tratta di modifiche, input errati dell'utente e<span class="keep-together">risposte</span> incoerenti del modello<span class="keep-together">.</span></p>
<p>Per seguirci, puoi trovare il codice iniziale di questo capitolo passando al <a href="https://github.com/Ali-Parandeh/building-generative-ai-services/tree/ch04-start">ramo<code translate="no">ch04-start</code> </a>.</p>
<section data-pdf-bookmark="Introduction to Type Safety" data-type="sect1"><div class="sect1" id="id62">
<h1>Introduzione alla sicurezza di tipo</h1>
<p><a data-primary="type-safe AI services" data-secondary="type safety basics" data-type="indexterm" id="ix_ch04-asciidoc1"/><em>Tipi</em> <a data-primary="types, defined" data-type="indexterm" id="id741"/>nella programmazione specifica quali valori possono essere assegnati alle variabili e le operazioni che possono essere eseguite su tali variabili.</p>
<p>In Python, i tipi più comuni sono i seguenti:</p>
<dl>
<dt>Intero</dt>
<dd>
<p>Rappresentare numeri interi</p>
</dd>
<dt>Galleggiante</dt>
<dd>
<p>Rappresentare numeri con parti frazionarie</p>
</dd>
<dt>Stringa</dt>
<dd>
<p>Rappresentare sequenze di caratteri</p>
</dd>
<dt>Booleano</dt>
<dd>
<p>Rappresentare i valori di <code translate="no">True</code> o <code translate="no">False</code> </p>
</dd>
</dl>
<div data-type="tip"><h6>Suggerimento</h6>
<p>Puoi utilizzare il pacchetto <code translate="no">typing</code> per importare tipi speciali, come hai visto in altri esempi di codice del <a data-type="xref" href="ch03.html#ch03">Capitolo 3</a>.</p>
</div>
<p><a data-primary="type safety, defined" data-type="indexterm" id="id742"/>La<em>sicurezza dei tipi</em> è una pratica di programmazione che garantisce che alle variabili vengano assegnati solo valori compatibili con i loro tipi definiti. In Python, puoi usare i tipi per controllare l'uso delle variabili in una base di codice, in particolare se la base di codice cresce in complessità e dimensioni. Gli strumenti di controllo dei tipi (ad esempio, <code translate="no">mypy</code>) possono quindi usare questi tipi per individuare assegnazioni o operazioni errate sulle variabili.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id743">
<h1>Linguaggi statici e a tipizzazione dinamica</h1>
<p><a data-primary="dynamically typed languages" data-type="indexterm" id="id744"/><a data-primary="type-safe AI services" data-secondary="static and dynamically typed languages" data-type="indexterm" id="id745"/>Python è uno dei pochi linguaggi a <em>tipizzazione dinamica</em>, il che significa che i tipi vengono controllati solo durante l'esecuzione del codice, non in anticipo. Inoltre, non è necessario dichiarare esplicitamente i tipi perché possono essere dedotti quando si assegnano i valori alle variabili. Tuttavia, non appena la tua base di codice diventa complessa e i tuoi servizi iniziano a interagire con altri sistemi come un filesystem, un database o servizi esterni, dovrai affrontare diversi problemi di affidabilità.</p>
<p>Senza la digitazione, devi affidarti ai test e una copertura insufficiente dei test può portare a crash di produzione dovuti a errori. Nel migliore dei casi, non sei a conoscenza di piccoli problemi e sfumature che riguardano l'utente; nel peggiore, rischi di danneggiare i dati o di incorrere in ingenti costi di server, scoprendo il danno solo quando è troppo tardi.</p>
<p><a data-primary="static languages" data-type="indexterm" id="id746"/>I linguaggi statici impongono agli sviluppatori l'uso della tipizzazione per ottenere una maggiore affidabilità e velocità di esecuzione del codice, potenzialmente a scapito della velocità di sviluppo. D'altra parte, in Python, la tipizzazione non viene imposta per offrire flessibilità, in modo da poter costruire applicazioni più velocemente. Ma l'analisi statica dei tipi in Python si è evoluta notevolmente con strumenti come <code translate="no">mypy</code>.</p>
</div></aside>
<p>Puoi imporre vincoli di tipo dichiarando variabili e funzioni completamente tipizzate, come mostrato nell'<a data-type="xref" href="#type_safe_code">Esempio 4-1</a>.</p>
<div data-type="example" id="type_safe_code">
<h5><span class="label">Esempio 4-1. </span>Usare i tipi in Python</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="kn" translate="no">from</code> <code class="nn" translate="no">datetime</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">datetime</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">timestamp_to_isostring</code><code class="p" translate="no">(</code><code class="n" translate="no">date</code><code class="p" translate="no">:</code> <code class="nb" translate="no">int</code><code class="p" translate="no">)</code> <code class="o" translate="no">-&gt;</code> <code class="nb" translate="no">str</code><code class="p" translate="no">:</code>
    <code class="k" translate="no">return</code> <code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">fromtimestamp</code><code class="p" translate="no">(</code><code class="n" translate="no">date</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">isoformat</code><code class="p" translate="no">()</code>

<code class="nb" translate="no">print</code><code class="p" translate="no">(</code><code class="n" translate="no">timestamp_to_isostring</code><code class="p" translate="no">(</code><code class="mi" translate="no">1736680773</code><code class="p" translate="no">))</code>
<code class="c1" translate="no"># 2025-01-12T11:19:52.876758</code>

<code class="nb" translate="no">print</code><code class="p" translate="no">(</code><code class="n" translate="no">timestamp_to_isostring</code><code class="p" translate="no">(</code><code class="s2" translate="no">"27 Jan 2025 14:48:00"</code><code class="p" translate="no">))</code>
<code class="c1" translate="no"># error: Argument 1 to "timestamp_to_isostring" has incompatible type "str";</code>
<code class="c1" translate="no"># expected "int" [arg-type]</code></pre></div>
<p>Anche gli editor di codice e gli IDE (ad esempio VS Code o JetBrains PyCharm) possono utilizzare estensioni di controllo del tipo, come mostrato nella <a data-type="xref" href="#type_safety">Figura 4-1</a>, per segnalare le violazioni del tipo durante la scrittura del codice.</p>
<figure><div class="figure" id="type_safety">
<img alt="bgai 0401" src="assets/bgai_0401.png" width="1109" height="375"/>
<h6><span class="label">Figura 4-1. </span>Cattura degli errori di tipo nell'estensione VS Code <code translate="no">mypy</code> </h6>
</div></figure>
<p>In una base di codice complessa, è facile perdere di vista le variabili, i loro stati e gli schemi in continua evoluzione. Ad esempio, potresti dimenticare che la funzione <code translate="no">timestamp_to_isostring</code> accetta numeri come input e passare erroneamente un timestamp come stringa, come mostrato nella <a data-type="xref" href="#type_safety">Figura 4-1</a>.</p>
<p>I tipi sono estremamente utili anche quando i manutentori dei pacchetti o i fornitori esterni di API aggiornano il loro codice. I controllori di tipo possono immediatamente emettere degli avvisi per aiutarti ad affrontare tali modifiche durante lo sviluppo. In questo modo, sarai immediatamente indirizzato alle fonti di potenziali errori senza dover eseguire il tuo codice e testare ogni endpoint. Di conseguenza, le pratiche di sicurezza dei tipi possono farti risparmiare tempo con il rilevamento precoce e impedirti di avere a che fare con errori di runtime più oscuri.</p>
<p>Infine, puoi fare un ulteriore passo avanti per impostare controlli automatici del tipo nella tua pipeline di distribuzione, per evitare di spingere le modifiche di rottura negli ambienti di produzione.</p>
<p><a data-primary="type-safe AI services" data-secondary="barriers to implementing type safety" data-type="indexterm" id="ix_ch04-asciidoc2"/>La sicurezza dei tipi all'inizio sembra un peso: devi digitare esplicitamente ogni funzione che scrivi, il che può essere una seccatura e rallentare le fasi iniziali dello sviluppo.</p>
<p>Alcune persone saltano la digitazione del codice per una prototipazione rapida e per scrivere meno codice boilerplate. L'approccio è più flessibile e più facile da usare, e Python è abbastanza potente per dedurre i tipi semplici. Inoltre, alcuni schemi di codice (come le funzioni con argomenti multitipo) possono essere così dinamici che è più facile evitare di implementare una sicurezza di tipo rigorosa quando si sta ancora sperimentando. Tuttavia, questo ti farà risparmiare ore di sviluppo perché inevitabilmente i tuoi servizi diventano complessi e cambiano continuamente.</p>
<p>La buona notizia è che alcuni di questi tipi possono essere generati automaticamente utilizzando strumenti come Prisma, quando si lavora con i database, o generatori di client, quando si lavora con API esterne. Per quanto riguarda le API esterne, spesso è possibile trovare SDK ufficiali contenenti client con suggerimenti di tipo (cioè client completamente tipizzati) che specificano i tipi di input e output previsti per l'utilizzo dell'API. In caso contrario, puoi ispezionare l'API per creare il tuo client completamente tipizzato. Tratterò Prisma e i generatori di client API in modo più dettagliato più avanti nel libro.</p>
<p>Quando non usi i tipi, ti esponi a ogni sorta di bug ed errori che potrebbero verificarsi perché altri sviluppatori hanno aggiornato inaspettatamente le tabelle del database o gli schemi API con cui il tuo servizio interagisce. In altri casi, potresti aggiornare una tabella del database - ad esempio, eliminando una colonna - e dimenticare di aggiornare il codice che interagisce con quella tabella.</p>
<p>Senza i tipi, potresti non accorgerti mai delle modifiche dovute agli aggiornamenti. Questo può essere difficile da debuggare perché gli errori a valle non gestiti potrebbero non individuare il componente rotto o i problemi generali legati a casi limite non gestiti dal tuo team di sviluppo. Di conseguenza, ciò che avrebbe potuto richiedere un minuto per essere risolto può durare mezza giornata o anche di più.</p>
<p>Puoi sempre evitare qualche disastro in produzione con test approfonditi, ma è molto più facile evitare problemi di integrazione e affidabilità se inizi a usare i tipi fin dall'inizio.</p>
<div data-type="tip"><h1>Sviluppare buone abitudini di programmazione</h1>
<p>Se in passato non hai digitato il tuo codice, non è mai troppo tardi per iniziare a prendere l'abitudine di digitare tutte le variabili, i parametri delle funzioni e i tipi di ritorno.<a data-startref="ix_ch04-asciidoc2" data-type="indexterm" id="id747"/></p>
<p>L'uso dei tipi renderà il tuo codice più leggibile, ti aiuterà a individuare tempestivamente i bug e ti farà risparmiare molto tempo quando dovrai rivisitare codebase complesse per capire rapidamente come scorrono i dati.<a data-startref="ix_ch04-asciidoc1" data-type="indexterm" id="id748"/></p>
</div>
</div></section>
<section data-pdf-bookmark="Implementing Type Safety" data-type="sect1"><div class="sect1" id="id244">
<h1>Implementare la sicurezza di tipo</h1>
<p><a data-primary="type-safe AI services" data-secondary="implementing type safety" data-type="indexterm" id="ix_ch04-asciidoc3"/>Da Python 3.5 puoi dichiarare esplicitamente i tipi di variabili, parametri di funzioni e valori di ritorno. La sintassi che ti permette di dichiarare questi tipi è l'<em>annotazione del tipo</em>.</p>
<section data-pdf-bookmark="Type Annotations" data-type="sect2"><div class="sect2" id="id63">
<h2>Annotazioni sul tipo</h2>
<p><a data-primary="type annotations" data-type="indexterm" id="ix_ch04-asciidoc4"/><a data-primary="type-safe AI services" data-secondary="implementing type safety" data-tertiary="type annotations" data-type="indexterm" id="ix_ch04-asciidoc5"/>Le annotazioni sui tipi non influiscono sul comportamento runtime dell'applicazione, ma aiutano a individuare gli errori di tipo, in particolare nelle applicazioni complesse e di grandi dimensioni in cui più persone lavorano insieme. Gli strumenti per il controllo statico dei tipi, come <code translate="no">mypy</code>, <code translate="no">pyright</code>, o <code translate="no">pyre</code>, insieme agli editor di codice, possono verificare che i tipi di dati memorizzati e restituiti dalle funzioni corrispondano ai tipi previsti.</p>
<p>Nelle applicazioni Python, le annotazioni di tipo vengono utilizzate per:</p>
<ul>
<li>
<p><em>Supporto per il completamento automatico dell'editor di codice</em></p>
</li>
<li>
<p>I<em>controlli statici del tipo</em> utilizzano strumenti come <code translate="no">mypy</code></p>
</li>
</ul>
<p class="less_space pagebreak-before">FastAPI sfrutta anche i suggerimenti sui tipi per:</p>
<ul>
<li>
<p><em>Definire i requisiti del gestore</em>, compresi i parametri del percorso e della query, i corpi, le intestazioni, le dipendenze, ecc.</p>
</li>
<li>
<p><em>Convertire i dati</em> ogni volta che è necessario</p>
</li>
<li>
<p><em>Convalidare i dati</em> provenienti dalle richieste in arrivo, dai database e dai servizi esterni.</p>
</li>
<li>
<p><em>Aggiornare automaticamente la specifica OpenAPI</em> che alimenta la pagina di documentazione generata</p>
</li>
</ul>
<p>Puoi installare <code translate="no">loguru</code> utilizzando <code translate="no">pip</code>:</p>
<pre data-code-language="bash" data-type="programlisting" translate="no">$ pip install loguru<code class="w" translate="no"/></pre>
<p>L<a data-type="xref" href="#type_annotation">'esempio 4-2</a> mostra diversi esempi di annotazione del tipo.</p>
<div data-type="example" id="type_annotation">
<h5><span class="label">Esempio 4-2. </span>Utilizzo dell'annotazione del tipo per ridurre i bug futuri in caso di modifiche al codice</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># utils.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">typing</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Literal</code><code class="p" translate="no">,</code> <code class="n" translate="no">TypeAlias</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">loguru</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">logger</code>
<code class="kn" translate="no">import</code> <code class="nn" translate="no">tiktoken</code>

<code class="n" translate="no">SupportedModels</code><code class="p" translate="no">:</code> <code class="n" translate="no">TypeAlias</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Literal</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">gpt-3.5</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">gpt-4</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code>
<code class="n" translate="no">PriceTable</code><code class="p" translate="no">:</code> <code class="n" translate="no">TypeAlias</code> <code class="o" translate="no">=</code> <code class="nb" translate="no">dict</code><code class="p" translate="no">[</code><code class="n" translate="no">SupportedModels</code><code class="p" translate="no">,</code> <code class="nb" translate="no">float</code><code class="p" translate="no">]</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-1" id="co_implementing_type_safe_ai_services_CO1-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-2" id="co_implementing_type_safe_ai_services_CO1-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
<code class="n" translate="no">price_table</code><code class="p" translate="no">:</code> <code class="n" translate="no">PriceTable</code> <code class="o" translate="no">=</code> <code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">gpt-3.5</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="mf" translate="no">0.0030</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">gpt-4</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="mf" translate="no">0.0200</code><code class="p" translate="no">}</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-3" id="co_implementing_type_safe_ai_services_CO1-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a>

<code class="k" translate="no">def</code> <code class="nf" translate="no">count_tokens</code><code class="p" translate="no">(</code><code class="n" translate="no">text</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code> <code class="o" translate="no">|</code> <code class="kc" translate="no">None</code><code class="p" translate="no">)</code> <code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code> <code class="nb" translate="no">int</code><code class="p" translate="no">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-4" id="co_implementing_type_safe_ai_services_CO1-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a>
    <code class="k" translate="no">if</code> <code class="n" translate="no">text</code> <code class="ow" translate="no">is</code> <code class="kc" translate="no">None</code><code class="p" translate="no">:</code>
        <code class="n" translate="no">logger</code><code class="o" translate="no">.</code><code class="n" translate="no">warning</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Response is None. Assuming 0 tokens used</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code>
        <code class="k" translate="no">return</code> <code class="mi" translate="no">0</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-5" id="co_implementing_type_safe_ai_services_CO1-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a>
    <code class="n" translate="no">enc</code> <code class="o" translate="no">=</code> <code class="n" translate="no">tiktoken</code><code class="o" translate="no">.</code><code class="n" translate="no">encoding_for_model</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">gpt-4o</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">return</code> <code class="nb" translate="no">len</code><code class="p" translate="no">(</code><code class="n" translate="no">enc</code><code class="o" translate="no">.</code><code class="n" translate="no">encode</code><code class="p" translate="no">(</code><code class="n" translate="no">text</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-6" id="co_implementing_type_safe_ai_services_CO1-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a>

<code class="k" translate="no">def</code> <code class="nf" translate="no">calculate_usage_costs</code><code class="p" translate="no">(</code>
    <code class="n" translate="no">prompt</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code><code class="p" translate="no">,</code>
    <code class="n" translate="no">response</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code> <code class="o" translate="no">|</code> <code class="kc" translate="no">None</code><code class="p" translate="no">,</code>
    <code class="n" translate="no">model</code><code class="p" translate="no">:</code> <code class="n" translate="no">SupportedModels</code><code class="p" translate="no">,</code>
<code class="p" translate="no">)</code> <code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code> <code class="nb" translate="no">tuple</code><code class="p" translate="no">[</code><code class="nb" translate="no">float</code><code class="p" translate="no">,</code> <code class="nb" translate="no">float</code><code class="p" translate="no">,</code> <code class="nb" translate="no">float</code><code class="p" translate="no">]</code><code class="p" translate="no">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-7" id="co_implementing_type_safe_ai_services_CO1-7"><img alt="7" src="assets/7.png" width="12" height="12"/></a>
    <code class="k" translate="no">if</code> <code class="n" translate="no">model</code> <code class="ow" translate="no">not</code> <code class="ow" translate="no">in</code> <code class="n" translate="no">price_table</code><code class="p" translate="no">:</code>
        <code class="c1" translate="no"># raise at runtime - in case someone ignores type errors</code>
        <code class="k" translate="no">raise</code> <code class="ne" translate="no">ValueError</code><code class="p" translate="no">(</code><code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Cost calculation is not supported for </code><code class="si" translate="no">{</code><code class="n" translate="no">model</code><code class="si" translate="no">}</code><code class="s2" translate="no"> model.</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-8" id="co_implementing_type_safe_ai_services_CO1-8"><img alt="8" src="assets/8.png" width="12" height="12"/></a>
    <code class="n" translate="no">price</code> <code class="o" translate="no">=</code> <code class="n" translate="no">price_table</code><code class="p" translate="no">[</code><code class="n" translate="no">model</code><code class="p" translate="no">]</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-9" id="co_implementing_type_safe_ai_services_CO1-9"><img alt="9" src="assets/9.png" width="12" height="12"/></a>
    <code class="n" translate="no">req_costs</code> <code class="o" translate="no">=</code> <code class="n" translate="no">price</code> <code class="o" translate="no">*</code> <code class="n" translate="no">count_tokens</code><code class="p" translate="no">(</code><code class="n" translate="no">prompt</code><code class="p" translate="no">)</code> <code class="o" translate="no">/</code> <code class="mi" translate="no">1000</code>
    <code class="n" translate="no">res_costs</code> <code class="o" translate="no">=</code> <code class="n" translate="no">price</code> <code class="o" translate="no">*</code> <code class="n" translate="no">count_tokens</code><code class="p" translate="no">(</code><code class="n" translate="no">response</code><code class="p" translate="no">)</code> <code class="o" translate="no">/</code> <code class="mi" translate="no">1000</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-10" id="co_implementing_type_safe_ai_services_CO1-10"><img alt="10" src="assets/10.png" width="12" height="12"/></a>
    <code class="n" translate="no">total_costs</code> <code class="o" translate="no">=</code> <code class="n" translate="no">req_costs</code> <code class="o" translate="no">+</code> <code class="n" translate="no">res_costs</code>
    <code class="k" translate="no">return</code> <code class="n" translate="no">req_costs</code><code class="p" translate="no">,</code> <code class="n" translate="no">res_costs</code><code class="p" translate="no">,</code> <code class="n" translate="no">total_costs</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO1-11" id="co_implementing_type_safe_ai_services_CO1-11"><img alt="11" src="assets/11.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-1" id="callout_implementing_type_safe_ai_services_CO1-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Utilizza il modulo <code translate="no">Literal</code> di Python <code translate="no">typing</code> incluso nella libreria standard.<sup><a data-type="noteref" href="ch04.html#id749" id="id749-marker" translate="no">1</a></sup>
Dichiara i letterali <code translate="no">gpt-3.5</code> e <code translate="no">gpt-4</code> e assegnali all'<em>alias di tipo</em> <code translate="no">SupportedModel</code>. Anche <code translate="no">PriceTable</code> è un alias di tipo semplice che definisce un dizionario con chiavi limitate ai letterali <code translate="no">SupportedModel</code> e con valori di tipo <code translate="no">float</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-2" id="callout_implementing_type_safe_ai_services_CO1-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Contrassegnare gli alias di tipo con <code translate="no">TypeAlias</code> per indicare esplicitamente che non si tratta di un normale assegnamento di variabile. I tipi sono anche dichiarati normalmente utilizzando CamelCase come migliore pratica per differenziarli dalle variabili. Ora puoi riutilizzare l'alias di tipo <code translate="no">PriceTable</code> in un secondo momento.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-3" id="callout_implementing_type_safe_ai_services_CO1-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Dichiara il dizionario della tabella dei prezzi e assegna il tipo <code translate="no">PriceTable</code> per limitare esplicitamente le chiavi e i valori consentiti nel dizionario della tabella dei prezzi.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-4" id="callout_implementing_type_safe_ai_services_CO1-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>La funzione <code translate="no">count_tokens</code> deve accettare stringhe o <code translate="no">None</code> tipi e restituire sempre un intero. Implementa la gestione delle eccezioni nel caso in cui qualcuno tenti di passare qualcosa di diverso da stringhe o <code translate="no">None</code> tipi. Quando definisci <code translate="no">count_tokens</code>, l'editor di codice e i controllori statici solleveranno avvisi se <code translate="no">count_tokens</code> non restituisce un intero anche se riceve un <code translate="no">None</code> e sollevano errori se qualsiasi altro tipo diverso da stringa o <code translate="no">None</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-5" id="callout_implementing_type_safe_ai_services_CO1-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a></dt>
<dd><p>Restituisce <code translate="no">0</code> anche se viene passato un tipo <code translate="no">None</code> per garantire il rispetto della tipizzazione delle funzioni.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-6" id="callout_implementing_type_safe_ai_services_CO1-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a></dt>
<dd><p>Tokenizza il testo dato utilizzando la libreria <code translate="no">tiktoken</code> di OpenAI, usando la stessa codifica utilizzata per il modello <code translate="no">gpt-4o</code>.<sup><a data-type="noteref" href="ch04.html#id750" id="id750-marker" translate="no">2</a></sup></p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-7" id="callout_implementing_type_safe_ai_services_CO1-7"><img alt="7" src="assets/7.png" width="12" height="12"/></a></dt>
<dd><p>Digita la funzione <code translate="no">calculate_usage_costs</code> in modo che accetti sempre un prompt di testo e i letterali prestabiliti per il parametro <code translate="no">model</code>. Passa il parametro <code translate="no">price_table</code> con l'alias di tipo <code translate="no">PriceTable</code> dichiarato in precedenza. La funzione deve restituire una tupla di tre float.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-8" id="callout_implementing_type_safe_ai_services_CO1-8"><img alt="8" src="assets/8.png" width="12" height="12"/></a></dt>
<dd><p>I controllori di tipo emettono avvertimenti quando viene passato un letterale di modello inaspettato, ma dovresti sempre controllare che non ci siano input errati alle funzioni e sollevare errori in runtime se viene passato un parametro di modello inaspettato.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-9" id="callout_implementing_type_safe_ai_services_CO1-9"><img alt="9" src="assets/9.png" width="12" height="12"/></a></dt>
<dd><p>Non c'è bisogno di preoccuparsi della gestione delle eccezioni, in quanto non c'è la possibilità che venga sollevato un <code translate="no">KeyError</code> se viene passato un modello non supportato. Se la tabella dei prezzi non viene aggiornata, la funzione solleva subito un <code translate="no">ValueError</code>. Cattura il <code translate="no">KeyError</code>, emette un avviso che la tabella dei prezzi deve essere aggiornata e poi solleva di nuovo il <code translate="no">KeyError</code>in modo che tutti i dettagli del problema vengano stampati sul terminale, in quanto non si possono fare supposizioni sui prezzi.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-10" id="callout_implementing_type_safe_ai_services_CO1-10"><img alt="10" src="assets/10.png" width="12" height="12"/></a></dt>
<dd><p>Usa la funzione <code translate="no">count_tokens</code> per calcolare i costi della richiesta e della risposta dell'LLM. Se per qualche motivo l'LLM non restituisce una risposta (restituisce <code translate="no">None</code>), <code translate="no">count_tokens</code> può gestirla e assumere zero gettoni.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO1-11" id="callout_implementing_type_safe_ai_services_CO1-11"><img alt="11" src="assets/11.png" width="12" height="12"/></a></dt>
<dd><p>Restituisce una tupla di tre float come da digitazione della funzione.</p></dd>
</dl></div>
<p>In una base di codice complessa, può essere difficile indovinare quali tipi di dati vengono passati, soprattutto se si apportano molte modifiche ovunque. Con le funzioni tipizzate, puoi essere sicuro che i parametri inaspettati non vengano passati a funzioni che non li supportano ancora.</p>
<p>Come puoi vedere dall'<a data-type="xref" href="#type_annotation">Esempio 4-2</a>, la digitazione del codice ti aiuta a individuare bug imprevisti durante gli aggiornamenti del codice. Ad esempio, se inizi a utilizzare un nuovo modello LLM, non puoi ancora calcolare i costi per il nuovo modello. Per supportare il calcolo dei costi per altri modelli LLM, devi prima aggiornare la tabella dei prezzi, la relativa digitazione e qualsiasi logica di gestione delle eccezioni. Una volta fatto, puoi essere abbastanza sicuro che la tua logica di calcolo sia ora estesa per funzionare con i nuovi tipi di modello.<a data-startref="ix_ch04-asciidoc5" data-type="indexterm" id="id751"/><a data-startref="ix_ch04-asciidoc4" data-type="indexterm" id="id752"/></p>
</div></section>
<section data-pdf-bookmark="Using Annotated" data-type="sect2"><div class="sect2" id="id64">
<h2>Utilizzo di Annotated</h2>
<p><a data-primary="Annotated (typing module feature)" data-type="indexterm" id="ix_ch04-asciidoc6"/><a data-primary="type-safe AI services" data-secondary="implementing type safety" data-tertiary="using Annotated" data-type="indexterm" id="ix_ch04-asciidoc7"/>Nell'<a data-type="xref" href="#type_annotation">Esempio 4-2</a>, puoi utilizzare <code translate="no">Annotated</code> al posto degli alias di tipo.<code translate="no">Annotated</code> è una funzionalità del modulo <code translate="no">typing</code>, introdotto in Python 3.9, ed è simile agli alias di tipo per riutilizzare i tipi, ma ti permette di definire anche <em>i metadati</em> per i tuoi tipi.</p>
<p>I metadati non influiscono sui controllori di tipo, ma sono utili per la documentazione del codice, l'analisi e le ispezioni in runtime.</p>
<p>Dalla sua introduzione in Python 3.9, puoi usare <code translate="no">Annotated</code> come mostrato nell'<a data-type="xref" href="#annotated_usage">Esempio 4-3</a>.</p>
<div data-type="example" id="annotated_usage">
<h5><span class="label">Esempio 4-3. </span>Utilizzo di <code translate="no">Annotated</code> per dichiarare tipi personalizzati con metadati</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="kn" translate="no">from</code> <code class="nn" translate="no">typing</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">,</code> <code class="n" translate="no">Literal</code>

<code class="n" translate="no">SupportedModels</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code>
    <code class="n" translate="no">Literal</code><code class="p" translate="no">[</code><code class="s2" translate="no">"gpt-3.5-turbo"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"gpt-4o"</code><code class="p" translate="no">],</code> <code class="s2" translate="no">"Supported text models"</code>
<code class="p" translate="no">]</code>
<code class="n" translate="no">PriceTableType</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code>
    <code class="nb" translate="no">dict</code><code class="p" translate="no">[</code><code class="n" translate="no">SupportedModels</code><code class="p" translate="no">,</code> <code class="nb" translate="no">float</code><code class="p" translate="no">],</code> <code class="s2" translate="no">"Supported model pricing table"</code>
<code class="p" translate="no">]</code>

<code class="n" translate="no">prices</code><code class="p" translate="no">:</code> <code class="n" translate="no">PriceTableType</code> <code class="o" translate="no">=</code> <code class="p" translate="no">{</code>
    <code class="s2" translate="no">"gpt-4o"</code><code class="p" translate="no">:</code> <code class="mf" translate="no">0.000638</code><code class="p" translate="no">,</code>
    <code class="c1" translate="no"># error: Dict entry 1 has incompatible type "Literal['gpt4-o']" [dict-item]</code>
    <code class="s2" translate="no">"gpt4-o"</code><code class="p" translate="no">:</code> <code class="mf" translate="no">0.000638</code><code class="p" translate="no">,</code>
    <code class="c1" translate="no"># error: Dict entry 2 has incompatible type "Literal['gpt-4']" [dict-item]</code>
    <code class="s2" translate="no">"gpt-4"</code><code class="p" translate="no">:</code> <code class="mf" translate="no">0.000638</code><code class="p" translate="no">,</code>
<code class="p" translate="no">}</code></pre></div>
<p>La <a href="https://oreil.ly/mtGcY">documentazione di FastAPI</a> consiglia l'uso di<span class="keep-together"><code translate="no">Annotated</code></span> al posto degli alias di tipo per la riusabilità, per un migliore controllo dei tipi nell'editor di codice e per individuare i problemi durante il runtime.</p>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>Tieni presente che la funzione <code translate="no">Annotated</code> richiede almeno due argomenti per funzionare: il primo deve essere il tipo passato e gli altri argomenti sono le annotazioni o i metadati che vuoi allegare al tipo, come ad esempio una descrizione, una regola di convalida o altri metadati, come mostrato nell'<a data-type="xref" href="#annotated_usage">Esempio 4-3</a>.</p>
</div>
<p>La tipizzazione, pur essendo vantaggiosa di per sé, non risolve tutti gli aspetti della gestione e della strutturazione dei dati. Per fortuna, le <em>classi di dati</em> di Python della libreria standard aiutano a estendere il sistema di tipizzazione.</p>
<p>Vediamo come puoi sfruttare le classi di dati per migliorare la digitazione nelle tue applicazioni.<a data-startref="ix_ch04-asciidoc7" data-type="indexterm" id="id753"/><a data-startref="ix_ch04-asciidoc6" data-type="indexterm" id="id754"/></p>
</div></section>
<section data-pdf-bookmark="Dataclasses" data-type="sect2"><div class="sect2" id="id65">
<h2>Classi di dati</h2>
<p><a data-primary="dataclasses" data-type="indexterm" id="ix_ch04-asciidoc8"/><a data-primary="Python" data-secondary="dataclasses" data-type="indexterm" id="ix_ch04-asciidoc9"/><a data-primary="type-safe AI services" data-secondary="implementing type safety" data-tertiary="dataclasses" data-type="indexterm" id="ix_ch04-asciidoc10"/>Le classi di dati sono state introdotte in Python 3.7 come parte della libreria standard. Se hai bisogno di strutture di dati personalizzate, puoi usare le classi di dati per organizzare, memorizzare e trasferire i dati nella tua applicazione.</p>
<p>Possono aiutare a evitare "odori" di codice come il bloat dei parametri delle funzioni, in cui una funzione è difficile da usare perché richiede più di una manciata di parametri. Avere una classe di dati ti permette di organizzare i tuoi dati in una struttura definita su misura e di passarli come un unico elemento alle funzioni che richiedono dati da luoghi diversi.</p>
<p>Puoi aggiornare l'<a data-type="xref" href="#type_annotation">esempio 4-2</a> per sfruttare le classi di dati, come mostrato nell'<a data-type="xref" href="#dataclasses">esempio 4-4</a>.</p>
<div data-type="example" id="dataclasses">
<h5><span class="label">Esempio 4-4. </span>Utilizzo delle classi di dati per garantire la sicurezza dei tipi</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># utils.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">dataclasses</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">dataclass</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">typing</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Literal</code><code class="p" translate="no">,</code> <code class="n" translate="no">TypeAlias</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">utils</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">count_tokens</code>

<code class="n" translate="no">SupportedModels</code><code class="p" translate="no">:</code> <code class="n" translate="no">TypeAlias</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Literal</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">gpt-3.5</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">gpt-4</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code>
<code class="n" translate="no">PriceTable</code><code class="p" translate="no">:</code> <code class="n" translate="no">TypeAlias</code> <code class="o" translate="no">=</code> <code class="nb" translate="no">dict</code><code class="p" translate="no">[</code><code class="n" translate="no">SupportedModels</code><code class="p" translate="no">,</code> <code class="nb" translate="no">float</code><code class="p" translate="no">]</code>
<code class="n" translate="no">prices</code><code class="p" translate="no">:</code> <code class="n" translate="no">PriceTable</code> <code class="o" translate="no">=</code> <code class="p" translate="no">{</code><code class="s2" translate="no">"</code><code class="s2" translate="no">gpt-3.5</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="mf" translate="no">0.0030</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">gpt-4</code><code class="s2" translate="no">"</code><code class="p" translate="no">:</code> <code class="mf" translate="no">0.0200</code><code class="p" translate="no">}</code>

<code class="nd" translate="no">@dataclass</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO2-1" id="co_implementing_type_safe_ai_services_CO2-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
<code class="k" translate="no">class</code> <code class="nc" translate="no">Message</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">prompt</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code>
    <code class="n" translate="no">response</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code> <code class="o" translate="no">|</code> <code class="kc" translate="no">None</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO2-2" id="co_implementing_type_safe_ai_services_CO2-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
    <code class="n" translate="no">model</code><code class="p" translate="no">:</code> <code class="n" translate="no">SupportedModels</code>

<code class="nd" translate="no">@dataclass</code>
<code class="k" translate="no">class</code> <code class="nc" translate="no">MessageCostReport</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">req_costs</code><code class="p" translate="no">:</code> <code class="nb" translate="no">float</code>
    <code class="n" translate="no">res_costs</code><code class="p" translate="no">:</code> <code class="nb" translate="no">float</code>
    <code class="n" translate="no">total_costs</code><code class="p" translate="no">:</code> <code class="nb" translate="no">float</code>

<code class="c1" translate="no"># Define count_tokens function as normal</code>
<code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">calculate_usage_costs</code><code class="p" translate="no">(</code><code class="n" translate="no">message</code><code class="p" translate="no">:</code> <code class="n" translate="no">Message</code><code class="p" translate="no">)</code> <code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code> <code class="n" translate="no">MessageCostReport</code><code class="p" translate="no">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO2-3" id="co_implementing_type_safe_ai_services_CO2-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a>
    <code class="k" translate="no">if</code> <code class="n" translate="no">message</code><code class="o" translate="no">.</code><code class="n" translate="no">model</code> <code class="ow" translate="no">not</code> <code class="ow" translate="no">in</code> <code class="n" translate="no">prices</code> <code class="p" translate="no">:</code>
        <code class="c1" translate="no"># raise at runtime - in case someone ignores type errors</code>
        <code class="k" translate="no">raise</code> <code class="ne" translate="no">ValueError</code><code class="p" translate="no">(</code>
            <code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Cost calculation is not supported for </code><code class="si" translate="no">{</code><code class="n" translate="no">message</code><code class="o" translate="no">.</code><code class="n" translate="no">model</code><code class="si" translate="no">}</code><code class="s2" translate="no"> model.</code><code class="s2" translate="no">"</code>
        <code class="p" translate="no">)</code>
    <code class="n" translate="no">price</code> <code class="o" translate="no">=</code> <code class="n" translate="no">prices</code><code class="p" translate="no">[</code><code class="n" translate="no">message</code><code class="o" translate="no">.</code><code class="n" translate="no">model</code><code class="p" translate="no">]</code>
    <code class="n" translate="no">req_costs</code> <code class="o" translate="no">=</code> <code class="n" translate="no">price</code> <code class="o" translate="no">*</code> <code class="n" translate="no">count_tokens</code><code class="p" translate="no">(</code><code class="n" translate="no">message</code><code class="o" translate="no">.</code><code class="n" translate="no">prompt</code><code class="p" translate="no">)</code> <code class="o" translate="no">/</code> <code class="mi" translate="no">1000</code>
    <code class="n" translate="no">res_costs</code> <code class="o" translate="no">=</code> <code class="n" translate="no">price</code> <code class="o" translate="no">*</code> <code class="n" translate="no">count_tokens</code><code class="p" translate="no">(</code><code class="n" translate="no">message</code><code class="o" translate="no">.</code><code class="n" translate="no">response</code><code class="p" translate="no">)</code> <code class="o" translate="no">/</code> <code class="mi" translate="no">1000</code>
    <code class="n" translate="no">total_costs</code> <code class="o" translate="no">=</code> <code class="n" translate="no">req_costs</code> <code class="o" translate="no">+</code> <code class="n" translate="no">res_costs</code>
    <code class="k" translate="no">return</code> <code class="n" translate="no">MessageCostReport</code><code class="p" translate="no">(</code>
        <code class="n" translate="no">req_costs</code><code class="o" translate="no">=</code><code class="n" translate="no">req_costs</code><code class="p" translate="no">,</code> <code class="n" translate="no">res_costs</code><code class="o" translate="no">=</code><code class="n" translate="no">res_costs</code><code class="p" translate="no">,</code> <code class="n" translate="no">total_costs</code><code class="o" translate="no">=</code><code class="n" translate="no">total_costs</code>
    <code class="p" translate="no">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO2-1" id="callout_implementing_type_safe_ai_services_CO2-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Utilizza le classi dataclass per decorare le classi <code translate="no">Message</code> e <code translate="no">MessageCost</code> come classi speciali per contenere i dati.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO2-2" id="callout_implementing_type_safe_ai_services_CO2-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Digita l'attributo <code translate="no">response</code> in modo che sia un <code translate="no">str</code> o un <code translate="no">None</code>. Questo è simile all'utilizzo di <code translate="no">Optional[str]</code> dal modulo <code translate="no">typing</code>. Questa nuova sintassi è disponibile in Python 3.10 e successivi, utilizzando il nuovo operatore union: <code translate="no">|</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO2-3" id="callout_implementing_type_safe_ai_services_CO2-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Modifica la firma della funzione <code translate="no">calculate_usage_costs</code> per utilizzare le classi di dati predefinite. Questa modifica semplifica la firma della funzione.</p></dd>
</dl></div>
<p>Dovresti puntare a sfruttare le classi di dati quando il tuo codice accumula odori di codice e diventa difficile da leggere.</p>
<p>Il vantaggio principale dell'utilizzo delle classi di dati nell'<a data-type="xref" href="#dataclasses">Esempio 4-4</a> è stato quello di raggruppare parametri correlati per semplificare la firma della funzione. In altri scenari, puoi utilizzare le classi di dati per:</p>
<ul class="less_space pagebreak-before">
<li>
<p>Eliminare la duplicazione del codice</p>
</li>
<li>
<p>Ridurre l'eccesso di codice (classi o funzioni di grandi dimensioni)</p>
</li>
<li>
<p>Refactoring dei cluster di dati (variabili comunemente utilizzate insieme)</p>
</li>
<li>
<p>Prevenire la mutazione involontaria dei dati</p>
</li>
<li>
<p>Promuovere l'organizzazione dei dati</p>
</li>
<li>
<p>Promuovere l'incapsulamento</p>
</li>
<li>
<p>Applicare la convalida dei dati</p>
</li>
</ul>
<p>Possono anche essere utilizzati per implementare molti altri miglioramenti del codice.</p>
<p>Le classi di dati sono uno strumento eccellente per migliorare l'organizzazione e lo scambio dei dati in qualsiasi punto della tua applicazione. Tuttavia, non supportano in modo nativo diverse funzionalità nella creazione di servizi API:</p>
<dl>
<dt>Parsing automatico dei dati</dt>
<dd>
<p>Parsing di stringhe ISO formattate con datetime in oggetti datetime su assegnazione</p>
</dd>
<dt>Convalida del campo</dt>
<dd>
<p>Eseguire controlli complessi sull'assegnazione dei valori ai campi, come ad esempio verificare se una stringa è troppo lunga</p>
</dd>
<dt>Serializzazione e deserializzazione</dt>
<dd>
<p>Conversione tra JSON e strutture di dati Python, in particolare quando si utilizzano tipi non comuni</p>
</dd>
<dt>Filtraggio del campo</dt>
<dd>
<p>Rimuovere i campi degli oggetti che non sono impostati o che contengono valori <code translate="no">None</code> </p>
</dd>
</dl>
<p>Nessuna delle limitazioni menzionate ti costringerà ad abbandonare l'uso delle classi di dati. Dovresti usare le classi di dati piuttosto che le classi normali quando hai bisogno di creare classi incentrate sui dati con un codice boilerplate minimo, in quanto generano automaticamente metodi speciali, annotazioni sul tipo e supporto per i valori predefiniti, riducendo i potenziali errori. Tuttavia, librerie come <code translate="no">pydantic</code> supportano queste caratteristiche se non vuoi implementare la tua logica personalizzata (ad esempio, la serializzazione degli oggetti datetime).</p>
<div data-type="tip"><h6>Suggerimento</h6>
<p>FastAPI supporta anche le classi di dati attraverso Pydantic, che implementa la propria versione delle classi di dati con il supporto delle caratteristiche sopra citate, consentendoti di migrare le basi di codice che utilizzano pesantemente le classi di dati<a data-startref="ix_ch04-asciidoc10" data-type="indexterm" id="id755"/><a data-startref="ix_ch04-asciidoc9" data-type="indexterm" id="id756"/><a data-startref="ix_ch04-asciidoc8" data-type="indexterm" id="id757"/> .<a data-startref="ix_ch04-asciidoc3" data-type="indexterm" id="id758"/></p>
</div>
<p>Diamo ora un'occhiata a Pydantic e a ciò che lo rende ideale per la creazione di servizi GenAI.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="Pydantic Models" data-type="sect1"><div class="sect1" id="id66">
<h1>Modelli Pydantic</h1>
<p><a data-primary="Pydantic" data-type="indexterm" id="ix_ch04-asciidoc11"/><a data-primary="type-safe AI services" data-secondary="Pydantic models" data-type="indexterm" id="ix_ch04-asciidoc12"/>Pydantic è la libreria di validazione dei dati più diffusa e supporta validatori e serializzatori personalizzati. La logica di base di Pydantic è controllata da annotazioni di tipo in Python e può emettere dati in formato JSON, consentendo una perfetta integrazione con qualsiasi altro strumento.</p>
<p>Inoltre, la logica di convalida dei dati di Pydantic V2 è stata riscritta in Rust per massimizzarne la velocità e le prestazioni, posizionandola come una delle librerie di convalida dei dati più veloci in Python. Di conseguenza, Pydantic ha influenzato pesantemente FastAPI e altri 8.000 pacchetti dell'ecosistema Python, tra cui Hugging Face, Django e LangChain. Si tratta di un toolkit collaudato e utilizzato dalle principali aziende tecnologiche, con 141 milioni di download al mese al momento della stesura di questo articolo, il che lo rende un candidato adatto all'adozione nei tuoi progetti in sostituzione delle dataclass.</p>
<p>Pydantic fornisce un ampio set di strumenti per la convalida e l'elaborazione dei dati utilizzando la propria implementazione di <code translate="no">BaseModel</code>. I modelli di Pydantic condividono molte somiglianze con le classi di dati, ma differiscono in alcune aree sottili. Quando crei i modelli di Pydantic, vengono richiamati una serie di hook di inizializzazione che aggiungono ai modelli funzioni di convalida dei dati, serializzazione e generazione di schemi JSON che mancano alle classi di dati vanilla.</p>
<p>FastAPI si integra strettamente con Pydantic e sfrutta il suo ricco set di funzionalità per l'elaborazione dei dati. I verificatori di tipo e gli editor di codice possono anche leggere i modelli di Pydantic in modo simile alle classi di dati per eseguire controlli e fornire autocompletamenti.</p>
<section data-pdf-bookmark="How to Use Pydantic" data-type="sect2"><div class="sect2" id="id245">
<h2>Come usare Pydantic</h2>
<p><a data-primary="Pydantic" data-secondary="how to use" data-type="indexterm" id="id759"/><a data-primary="type-safe AI services" data-secondary="Pydantic models" data-tertiary="how to use Pydantic" data-type="indexterm" id="id760"/>Puoi installare Pydantic nel tuo progetto utilizzando il seguente metodo:</p>
<pre data-code-language="bash" data-type="programlisting" translate="no">$ pip install pydantic<code class="w" translate="no"/></pre>
<p>Pydantic implementa un <code translate="no">BaseModel</code>, che è il metodo principale per definire i modelli.<a data-primary="models (Pydantic)" data-secondary="defined" data-type="indexterm" id="id761"/><em>I modelli</em> sono semplicemente classi che ereditano da <code translate="no">BaseModel</code> e definiscono i campi come attributi annotati utilizzando i suggerimenti di tipo. I modelli possono essere utilizzati come schemi per convalidare i dati.</p>
<p>Oltre a raggruppare i dati,<sup><a data-type="noteref" href="ch04.html#id762" id="id762-marker" translate="no">3</a></sup> i modelli Pydantic ti permettono di specificare i requisiti di richiesta e risposta dei tuoi endpoint di servizio e di convalidare i dati non attendibili in arrivo da fonti esterne. Puoi anche arrivare a filtrare i tuoi output LLM utilizzando i modelli Pydantic (e i validatori, che imparerai a conoscere meglio tra poco).</p>
<p>Puoi creare i tuoi modelli Pydantic come mostrato nell'<a data-type="xref" href="#pydantic_models">Esempio 4-5</a>.</p>
<div data-type="example" id="pydantic_models">
<h5><span class="label">Esempio 4-5. </span>Creare modelli Pydantic</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="kn" translate="no">from</code> <code class="nn" translate="no">typing</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Literal</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">pydantic</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">BaseModel</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">TextModelRequest</code><code class="p" translate="no">(</code><code class="n" translate="no">BaseModel</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO3-1" id="co_implementing_type_safe_ai_services_CO3-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
    <code class="n" translate="no">model</code><code class="p" translate="no">:</code> <code class="n" translate="no">Literal</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">gpt-3.5-turbo</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">gpt-4o</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code>
    <code class="n" translate="no">prompt</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code>
    <code class="n" translate="no">temperature</code><code class="p" translate="no">:</code> <code class="nb" translate="no">float</code> <code class="o" translate="no">=</code> <code class="mf" translate="no">0.0</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO3-2" id="co_implementing_type_safe_ai_services_CO3-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO3-1" id="callout_implementing_type_safe_ai_services_CO3-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Definisci il modello <code translate="no">TextModelRequest</code> ereditando il modello Pydantic <code translate="no">BaseModel</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO3-2" id="callout_implementing_type_safe_ai_services_CO3-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Imposta i valori predefiniti se non viene fornito un valore esplicito. Per esempio, imposta il campo <code translate="no">temperature</code> a <code translate="no">0.0</code> se non viene fornito un valore all'inizializzazione.</p></dd>
</dl></div>
<p>L<a data-type="xref" href="#pydantic_models">'esempio 4-5</a> mostra anche come puoi trasformare le tue classi di dati in modelli Pydantic per sfruttare le sue numerose funzionalità.</p>
</div></section>
<section data-pdf-bookmark="Compound Pydantic Models" data-type="sect2"><div class="sect2" id="id67">
<h2>Modelli pidantici composti</h2>
<p><a data-primary="models (Pydantic)" data-secondary="compound models" data-type="indexterm" id="ix_ch04-asciidoc13"/><a data-primary="Pydantic" data-secondary="compound models" data-type="indexterm" id="ix_ch04-asciidoc14"/><a data-primary="type-safe AI services" data-secondary="Pydantic models" data-tertiary="compound Pydantic models" data-type="indexterm" id="ix_ch04-asciidoc15"/>Con i modelli Pydantic puoi dichiarare <em>schemi di</em> dati, che definiscono le strutture di dati supportate nelle operazioni del tuo servizio. Inoltre, puoi anche utilizzare l'ereditarietà per costruire modelli composti, come mostrato nell'<a data-type="xref" href="#pydantic_compound_models">Esempio 4-6</a>.</p>
<div data-type="example" id="pydantic_compound_models">
<h5><span class="label">Esempio 4-6. </span>Creazione di modelli Pydantic</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># schemas.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">datetime</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">datetime</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">typing</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">,</code> <code class="n" translate="no">Literal</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">pydantic</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">BaseModel</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">ModelRequest</code><code class="p" translate="no">(</code><code class="n" translate="no">BaseModel</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO4-1" id="co_implementing_type_safe_ai_services_CO4-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
    <code class="n" translate="no">prompt</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">ModelResponse</code><code class="p" translate="no">(</code><code class="n" translate="no">BaseModel</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO4-2" id="co_implementing_type_safe_ai_services_CO4-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
    <code class="n" translate="no">request_id</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code>
    <code class="n" translate="no">ip</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code> <code class="o" translate="no">|</code> <code class="kc" translate="no">None</code>
    <code class="n" translate="no">content</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code> <code class="o" translate="no">|</code> <code class="kc" translate="no">None</code>
    <code class="n" translate="no">created_at</code><code class="p" translate="no">:</code> <code class="n" translate="no">datetime</code> <code class="o" translate="no">=</code> <code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">TextModelRequest</code><code class="p" translate="no">(</code><code class="n" translate="no">ModelRequest</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">model</code><code class="p" translate="no">:</code> <code class="n" translate="no">Literal</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">gpt-3.5-turbo</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">gpt-4o</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code>
    <code class="n" translate="no">temperature</code><code class="p" translate="no">:</code> <code class="nb" translate="no">float</code> <code class="o" translate="no">=</code> <code class="mf" translate="no">0.0</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">TextModelResponse</code><code class="p" translate="no">(</code><code class="n" translate="no">ModelResponse</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">tokens</code><code class="p" translate="no">:</code> <code class="nb" translate="no">int</code>

<code class="n" translate="no">ImageSize</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="nb" translate="no">tuple</code><code class="p" translate="no">[</code><code class="nb" translate="no">int</code><code class="p" translate="no">,</code> <code class="nb" translate="no">int</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">Width and height of an image in pixels</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">ImageModelRequest</code><code class="p" translate="no">(</code><code class="n" translate="no">ModelRequest</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO4-3" id="co_implementing_type_safe_ai_services_CO4-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a>
    <code class="n" translate="no">model</code><code class="p" translate="no">:</code> <code class="n" translate="no">Literal</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">tinysd</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">sd1.5</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code>
    <code class="n" translate="no">output_size</code><code class="p" translate="no">:</code> <code class="n" translate="no">ImageSize</code>
    <code class="n" translate="no">num_inference_steps</code><code class="p" translate="no">:</code> <code class="nb" translate="no">int</code> <code class="o" translate="no">=</code> <code class="mi" translate="no">200</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">ImageModelResponse</code><code class="p" translate="no">(</code><code class="n" translate="no">ModelResponse</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO4-4" id="co_implementing_type_safe_ai_services_CO4-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a>
    <code class="n" translate="no">size</code><code class="p" translate="no">:</code> <code class="n" translate="no">ImageSize</code>
    <code class="n" translate="no">url</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO4-1" id="callout_implementing_type_safe_ai_services_CO4-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Definisci il modello <code translate="no">ModelRequest</code> ereditando il modello Pydantic <code translate="no">BaseModel</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO4-2" id="callout_implementing_type_safe_ai_services_CO4-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Definisci il campo <code translate="no">ModelResponse</code>. Se i dati per il campo opzionale <code translate="no">ip</code> non sono forniti, utilizza i valori predefiniti di <code translate="no">None</code>. Il campo <code translate="no">content</code> può essere sia byte (per le immagini) che stringa (per i modelli di testo).</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO4-3" id="callout_implementing_type_safe_ai_services_CO4-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Definisci i modelli <code translate="no">TextModelRequest</code> e <code translate="no">ImageModelRequest</code> ereditando<span class="keep-together"><code translate="no">ModelRequest</code>. Il campo opzionale della temperatura è impostato di default a 0.0. Il campo</span> <code translate="no">num_inference_steps</code> per il modello <code translate="no">ImageModelRequest</code> è opzionale e impostato a 200. Entrambi i modelli richiedono ora l'<span class="keep-together">inserimento</span> del campo prompt string.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO4-4" id="callout_implementing_type_safe_ai_services_CO4-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Definisci i modelli <code translate="no">ImageModelResponse</code> e <code translate="no">TextModelResponse</code> ereditando il modello <code translate="no">ModelResponse</code>. Per <code translate="no">TextModelResponse</code>, fornisci il conteggio dei token e per <code translate="no">ImageModelResponse</code>, fornisci le dimensioni dell'immagine in pixel insieme all'URL remoto per scaricare l'immagine.</p></dd>
</dl></div>
<p>Con i modelli mostrati nell'<a data-type="xref" href="#pydantic_compound_models">Esempio 4-6</a>, hai gli schemi necessari per definire i requisiti dei tuoi endpoint di generazione di testo e immagini.<a data-startref="ix_ch04-asciidoc15" data-type="indexterm" id="id763"/><a data-startref="ix_ch04-asciidoc14" data-type="indexterm" id="id764"/><a data-startref="ix_ch04-asciidoc13" data-type="indexterm" id="id765"/></p>
</div></section>
<section data-pdf-bookmark="Field Constraints and Validators" data-type="sect2"><div class="sect2" id="id68">
<h2>Vincoli e validatori di campo</h2>
<p><a data-primary="constrained types" data-type="indexterm" id="ix_ch04-asciidoc16"/><a data-primary="Pydantic" data-secondary="field constraints and validators" data-type="indexterm" id="ix_ch04-asciidoc17"/><a data-primary="type-safe AI services" data-secondary="Pydantic models" data-tertiary="field constraints and validators" data-type="indexterm" id="ix_ch04-asciidoc18"/>Oltre al supporto per i tipi standard, Pydantic offre anche <em>tipi vincolati</em> come <code translate="no">EmailStr</code>, <code translate="no">PositiveInt</code>, <code translate="no">UUID4</code>, <code translate="no">AnyHttpUrl</code> e altri che possono eseguire la convalida dei dati durante l'inizializzazione del modello per i formati di dati più comuni. L'elenco completo dei tipi di Pydantic è disponibile nella <a href="https://oreil.ly/xNbXX">documentazione ufficiale</a>.</p>
<div data-type="note" epub:type="note"><h6>Nota</h6>
<p>Alcuni tipi vincolati come <code translate="no">EmailStr</code> richiedono l'installazione di pacchetti di dipendenza per funzionare, ma possono essere estremamente utili per convalidare formati di dati comuni come le e-mail.</p>
</div>
<p>Per definire vincoli di campo più complessi e personalizzati in aggiunta ai tipi vincolati da Pydantic, puoi utilizzare la funzione <code translate="no">Field</code> di Pydantic con il tipo <code translate="no">Annotated</code> per introdurre vincoli di validazione come un intervallo di input valido.</p>
<p>L<a data-type="xref" href="#pydantic_constrained_fields">'Esempio 4-7</a> sostituisce i suggerimenti di tipo standard dell'<a data-type="xref" href="#pydantic_compound_models">Esempio 4-6</a> con tipi vincolati e funzioni di <code translate="no">Field</code> per implementare requisiti di dati più severi per i tuoi endpoint basati sui vincoli del modello.</p>
<div data-type="example" id="pydantic_constrained_fields">
<h5><span class="label">Esempio 4-7. </span>Utilizzo di campi vincolati</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># schemas.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">datetime</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">datetime</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">typing</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">,</code> <code class="n" translate="no">Literal</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">uuid</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">uuid4</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">pydantic</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">BaseModel</code><code class="p" translate="no">,</code> <code class="n" translate="no">Field</code><code class="p" translate="no">,</code> <code class="n" translate="no">HttpUrl</code><code class="p" translate="no">,</code> <code class="n" translate="no">IPvAnyAddress</code><code class="p" translate="no">,</code> <code class="n" translate="no">PositiveInt</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">ModelRequest</code><code class="p" translate="no">(</code><code class="n" translate="no">BaseModel</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">prompt</code><code class="p" translate="no">:</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code> <code class="n" translate="no">Field</code><code class="p" translate="no">(</code><code class="n" translate="no">min_length</code><code class="o" translate="no">=</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="n" translate="no">max_length</code><code class="o" translate="no">=</code><code class="mi" translate="no">10000</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO5-1" id="co_implementing_type_safe_ai_services_CO5-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>

<code class="k" translate="no">class</code> <code class="nc" translate="no">ModelResponse</code><code class="p" translate="no">(</code><code class="n" translate="no">BaseModel</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">request_id</code><code class="p" translate="no">:</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code> <code class="n" translate="no">Field</code><code class="p" translate="no">(</code><code class="n" translate="no">default_factory</code><code class="o" translate="no">=</code><code class="k" translate="no">lambda</code><code class="p" translate="no">:</code> <code class="n" translate="no">uuid4</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">hex</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO5-2" id="co_implementing_type_safe_ai_services_CO5-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
    <code class="c1" translate="no"># no defaults set for ip field</code>
    <code class="c1" translate="no"># raise ValidationError if a valid IP address or None is not provided</code>
    <code class="n" translate="no">ip</code><code class="p" translate="no">:</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code> <code class="n" translate="no">IPvAnyAddress</code><code class="p" translate="no">]</code> <code class="o" translate="no">|</code> <code class="kc" translate="no">None</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO5-3" id="co_implementing_type_safe_ai_services_CO5-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a>
    <code class="n" translate="no">content</code><code class="p" translate="no">:</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code> <code class="o" translate="no">|</code> <code class="kc" translate="no">None</code><code class="p" translate="no">,</code> <code class="n" translate="no">Field</code><code class="p" translate="no">(</code><code class="n" translate="no">min_length</code><code class="o" translate="no">=</code><code class="mi" translate="no">0</code><code class="p" translate="no">,</code> <code class="n" translate="no">max_length</code><code class="o" translate="no">=</code><code class="mi" translate="no">10000</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO5-4" id="co_implementing_type_safe_ai_services_CO5-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a>
    <code class="n" translate="no">created_at</code><code class="p" translate="no">:</code> <code class="n" translate="no">datetime</code> <code class="o" translate="no">=</code> <code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">TextModelRequest</code><code class="p" translate="no">(</code><code class="n" translate="no">ModelRequest</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">model</code><code class="p" translate="no">:</code> <code class="n" translate="no">Literal</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">gpt-3.5-turbo</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">gpt-4o</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code>
    <code class="n" translate="no">temperature</code><code class="p" translate="no">:</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="nb" translate="no">float</code><code class="p" translate="no">,</code> <code class="n" translate="no">Field</code><code class="p" translate="no">(</code><code class="n" translate="no">ge</code><code class="o" translate="no">=</code><code class="mf" translate="no">0.0</code><code class="p" translate="no">,</code> <code class="n" translate="no">le</code><code class="o" translate="no">=</code><code class="mf" translate="no">1.0</code><code class="p" translate="no">,</code> <code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="mf" translate="no">0.0</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO5-5" id="co_implementing_type_safe_ai_services_CO5-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a>

<code class="k" translate="no">class</code> <code class="nc" translate="no">TextModelResponse</code><code class="p" translate="no">(</code><code class="n" translate="no">ModelResponse</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">tokens</code><code class="p" translate="no">:</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="nb" translate="no">int</code><code class="p" translate="no">,</code> <code class="n" translate="no">Field</code><code class="p" translate="no">(</code><code class="n" translate="no">ge</code><code class="o" translate="no">=</code><code class="mi" translate="no">0</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code>

<code class="n" translate="no">ImageSize</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO5-6" id="co_implementing_type_safe_ai_services_CO5-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a>
    <code class="nb" translate="no">tuple</code><code class="p" translate="no">[</code><code class="n" translate="no">PositiveInt</code><code class="p" translate="no">,</code> <code class="n" translate="no">PositiveInt</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">Width and height of an image in pixels</code><code class="s2" translate="no">"</code>
<code class="p" translate="no">]</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">ImageModelRequest</code><code class="p" translate="no">(</code><code class="n" translate="no">ModelRequest</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">model</code><code class="p" translate="no">:</code> <code class="n" translate="no">Literal</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">tinysd</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">sd1.5</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code>
    <code class="n" translate="no">output_size</code><code class="p" translate="no">:</code> <code class="n" translate="no">ImageSize</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO5-6" id="co_implementing_type_safe_ai_services_CO5-7"><img alt="6" src="assets/6.png" width="12" height="12"/></a>
    <code class="n" translate="no">num_inference_steps</code><code class="p" translate="no">:</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="nb" translate="no">int</code><code class="p" translate="no">,</code> <code class="n" translate="no">Field</code><code class="p" translate="no">(</code><code class="n" translate="no">ge</code><code class="o" translate="no">=</code><code class="mi" translate="no">0</code><code class="p" translate="no">,</code> <code class="n" translate="no">le</code><code class="o" translate="no">=</code><code class="mi" translate="no">2000</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code> <code class="o" translate="no">=</code> <code class="mi" translate="no">200</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO5-7" id="co_implementing_type_safe_ai_services_CO5-8"><img alt="7" src="assets/7.png" width="12" height="12"/></a>

<code class="k" translate="no">class</code> <code class="nc" translate="no">ImageModelResponse</code><code class="p" translate="no">(</code><code class="n" translate="no">ModelResponse</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">size</code><code class="p" translate="no">:</code> <code class="n" translate="no">ImageSize</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO5-6" id="co_implementing_type_safe_ai_services_CO5-9"><img alt="6" src="assets/6.png" width="12" height="12"/></a>
    <code class="n" translate="no">url</code><code class="p" translate="no">:</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code> <code class="n" translate="no">HttpUrl</code><code class="p" translate="no">]</code> <code class="o" translate="no">|</code> <code class="kc" translate="no">None</code> <code class="o" translate="no">=</code> <code class="kc" translate="no">None</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO5-8" id="co_implementing_type_safe_ai_services_CO5-10"><img alt="8" src="assets/8.png" width="12" height="12"/></a></pre>
<dl class="calloutlist pagebreak-before less_space">
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO5-1" id="callout_implementing_type_safe_ai_services_CO5-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Sostituisci il tipo standard <code translate="no">str</code> con <code translate="no">Field</code> e <code translate="no">Annotated</code> per delimitare la lunghezza della stringa a un intervallo di caratteri.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO5-2" id="callout_implementing_type_safe_ai_services_CO5-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Genera un nuovo UUID della richiesta passando un callable a <code translate="no">default_factory</code> che verrà chiamato per generare un nuovo UUID.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO5-3" id="callout_implementing_type_safe_ai_services_CO5-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Vincola il campo opzionale <code translate="no">ip</code> a qualsiasi intervallo di indirizzi IPv4 o IPv6 valido. Anche<code translate="no">None</code> è una voce valida se non è possibile determinare l'IP del client. Questo campo opzionale non ha un valore predefinito, quindi se non viene fornito un IP valido o <code translate="no">None</code>, Pydantic solleverà un <code translate="no">ValidationError</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO5-4" id="callout_implementing_type_safe_ai_services_CO5-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Limita il campo <code translate="no">content</code> a 10.000 caratteri o byte.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO5-5" id="callout_implementing_type_safe_ai_services_CO5-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a></dt>
<dd><p>Vincola la temperatura tra <code translate="no">0.0</code> e <code translate="no">1.0</code> con un valore predefinito di <code translate="no">0.0</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO5-6" id="callout_implementing_type_safe_ai_services_CO5-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a></dt>
<dd><p>Riutilizza un vincolo <code translate="no">Annotated</code> sul campo <code translate="no">output_size</code> a numeri interi positivi utilizzando il tipo vincolato <code translate="no">PositiveInt</code>. Le parole chiave <code translate="no">lte</code> e <code translate="no">gte</code> si riferiscono rispettivamente a <em>meno di uguale</em> e <em>maggiore di uguale</em>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO5-8" id="callout_implementing_type_safe_ai_services_CO5-7"><img alt="7" src="assets/7.png" width="12" height="12"/></a></dt>
<dd><p>Vincola il campo <code translate="no">num_inference_steps</code> con <code translate="no">Field</code> tra <code translate="no">0</code> e <code translate="no">2000</code> e un valore predefinito di <code translate="no">200</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO5-10" id="callout_implementing_type_safe_ai_services_CO5-8"><img alt="8" src="assets/8.png" width="12" height="12"/></a></dt>
<dd><p>Vincola il campo opzionale <code translate="no">url</code> a qualsiasi URL HTTP o HTTPS valido, dove il nome dell'host e il dominio di primo livello (TLD) sono obbligatori.</p></dd>
</dl></div>
<p>Con i modelli definiti nell'<a data-type="xref" href="#pydantic_constrained_fields">Esempio 4-7</a>, ora puoi eseguire la convalida dei dati in entrata o in uscita per soddisfare i requisiti di dati che hai. In questi casi, FastAPI sfrutterà Pydantic per restituire automaticamente le risposte di errore quando i controlli di convalida dei dati falliscono durante il runtime di una richiesta, come mostrato nell'<a data-type="xref" href="#fastapi_pydantic_validation_failure">Esempio 4-8</a>.<a data-startref="ix_ch04-asciidoc18" data-type="indexterm" id="id766"/><a data-startref="ix_ch04-asciidoc17" data-type="indexterm" id="id767"/><a data-startref="ix_ch04-asciidoc16" data-type="indexterm" id="id768"/></p>
<div data-type="example" id="fastapi_pydantic_validation_failure">
<h5><span class="label">Esempio 4-8. </span>Risposta di errore di FastAPI in caso di mancata convalida dei dati</h5>
<pre data-code-language="bash" data-type="programlisting" translate="no">$ curl -X <code class="s1" translate="no">'POST'</code> <code class="se" translate="no">\</code>
  <code class="s1" translate="no">'http://127.0.0.1:8000/validation/failure'</code> <code class="se" translate="no">\</code>
  -H <code class="s1" translate="no">'accept: application/json'</code> <code class="se" translate="no">\</code>
  -H <code class="s1" translate="no">'Content-Type: application/json'</code> <code class="se" translate="no">\</code>
  -d <code class="s1" translate="no">'{</code>
<code class="s1" translate="no">  "prompt": "string",</code>
<code class="s1" translate="no">  "model": "gpt-4o",</code>
<code class="s1" translate="no">  "temperature": 0</code>
<code class="s1" translate="no">}'</code><code class="w" translate="no"/>

<code class="o" translate="no">{</code><code class="w" translate="no"/>
  <code class="s2" translate="no">"detail"</code>: <code class="o" translate="no">[</code><code class="w" translate="no"/>
    <code class="o" translate="no">{</code><code class="w" translate="no"/>
      <code class="s2" translate="no">"type"</code>: <code class="s2" translate="no">"literal_error"</code>,<code class="w" translate="no"/>
      <code class="s2" translate="no">"loc"</code>: <code class="o" translate="no">[</code><code class="w" translate="no"/>
        <code class="s2" translate="no">"body"</code>,<code class="w" translate="no"/>
        <code class="s2" translate="no">"model"</code><code class="w" translate="no"/>
      <code class="o" translate="no">]</code>,<code class="w" translate="no"/>
      <code class="s2" translate="no">"msg"</code>: <code class="s2" translate="no">"Input should be 'tinyllama' or 'gemma2b'"</code>,<code class="w" translate="no"/>
      <code class="s2" translate="no">"input"</code>: <code class="s2" translate="no">"gpt-4o"</code>,<code class="w" translate="no"/>
      <code class="s2" translate="no">"ctx"</code>: <code class="o" translate="no">{</code><code class="w" translate="no"/>
        <code class="s2" translate="no">"expected"</code>: <code class="s2" translate="no">"'tinyllama' or 'gemma2b'"</code><code class="w" translate="no"/>
      <code class="o" translate="no">}</code><code class="w" translate="no"/>
    <code class="o" translate="no">}</code><code class="w" translate="no"/>
  <code class="o" translate="no">]</code><code class="w" translate="no"/>
<code class="o" translate="no">}</code><code class="w" translate="no"/></pre></div>
</div></section>
<section data-pdf-bookmark="Custom Field and Model Validators" data-type="sect2"><div class="sect2" id="id69">
<h2>Validatori di campi e modelli personalizzati</h2>
<p><a data-primary="custom field validators" data-type="indexterm" id="ix_ch04-asciidoc19"/><a data-primary="Pydantic" data-secondary="custom field and model validators" data-type="indexterm" id="ix_ch04-asciidoc20"/><a data-primary="type-safe AI services" data-secondary="Pydantic models" data-tertiary="custom field and model validators" data-type="indexterm" id="ix_ch04-asciidoc21"/>Un'altra eccellente caratteristica di Pydantic per eseguire controlli di convalida dei dati è rappresentata dai <em>validatori di campo personalizzati</em>. L <a data-type="xref" href="#field_validators">'esempio 4-9</a> mostra come entrambi i tipi di validatori personalizzati possono essere implementati su <code translate="no">ImageModelRequest</code>.</p>
<div data-type="example" id="field_validators">
<h5><span class="label">Esempio 4-9. </span>Implementazione di validatori di campi e modelli personalizzati per <code translate="no">ImageModelRequest</code></h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># schemas.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">typing</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">,</code> <code class="n" translate="no">Literal</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">pydantic</code> <code class="kn" translate="no">import</code> <code class="p" translate="no">(</code>
    <code class="n" translate="no">AfterValidator</code><code class="p" translate="no">,</code>
    <code class="n" translate="no">BaseModel</code><code class="p" translate="no">,</code>
    <code class="n" translate="no">Field</code><code class="p" translate="no">,</code>
    <code class="n" translate="no">PositiveInt</code><code class="p" translate="no">,</code>
    <code class="n" translate="no">validate_call</code><code class="p" translate="no">,</code>
<code class="p" translate="no">)</code>

<code class="n" translate="no">ImageSize</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code>
    <code class="nb" translate="no">tuple</code><code class="p" translate="no">[</code><code class="n" translate="no">PositiveInt</code><code class="p" translate="no">,</code> <code class="n" translate="no">PositiveInt</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">Width and height of an image in pixels</code><code class="s2" translate="no">"</code>
<code class="p" translate="no">]</code>
<code class="n" translate="no">SupportedModels</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code>
    <code class="n" translate="no">Literal</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">tinysd</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">sd1.5</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">Supported Image Generation Models</code><code class="s2" translate="no">"</code>
<code class="p" translate="no">]</code>

<code class="nd" translate="no">@validate_call</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO6-1" id="co_implementing_type_safe_ai_services_CO6-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
<code class="k" translate="no">def</code> <code class="nf" translate="no">is_square_image</code><code class="p" translate="no">(</code><code class="n" translate="no">value</code><code class="p" translate="no">:</code> <code class="n" translate="no">ImageSize</code><code class="p" translate="no">)</code> <code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code> <code class="n" translate="no">ImageSize</code><code class="p" translate="no">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO6-2" id="co_implementing_type_safe_ai_services_CO6-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
    <code class="k" translate="no">if</code> <code class="n" translate="no">value</code><code class="p" translate="no">[</code><code class="mi" translate="no">0</code><code class="p" translate="no">]</code> <code class="o" translate="no">/</code> <code class="n" translate="no">value</code><code class="p" translate="no">[</code><code class="mi" translate="no">1</code><code class="p" translate="no">]</code> <code class="o" translate="no">!=</code> <code class="mi" translate="no">1</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">raise</code> <code class="ne" translate="no">ValueError</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Only square images are supported</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">if</code> <code class="n" translate="no">value</code><code class="p" translate="no">[</code><code class="mi" translate="no">0</code><code class="p" translate="no">]</code> <code class="ow" translate="no">not</code> <code class="ow" translate="no">in</code> <code class="p" translate="no">[</code><code class="mi" translate="no">512</code><code class="p" translate="no">,</code> <code class="mi" translate="no">1024</code><code class="p" translate="no">]</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">raise</code> <code class="ne" translate="no">ValueError</code><code class="p" translate="no">(</code><code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Invalid output size: </code><code class="si" translate="no">{</code><code class="n" translate="no">value</code><code class="si" translate="no">}</code><code class="s2" translate="no"> - expected 512 or 1024</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">return</code> <code class="n" translate="no">value</code>

<code class="nd" translate="no">@validate_call</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO6-1" id="co_implementing_type_safe_ai_services_CO6-3"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
<code class="k" translate="no">def</code> <code class="nf" translate="no">is_valid_inference_step</code><code class="p" translate="no">(</code>
    <code class="n" translate="no">num_inference_steps</code><code class="p" translate="no">:</code> <code class="nb" translate="no">int</code><code class="p" translate="no">,</code> <code class="n" translate="no">model</code><code class="p" translate="no">:</code> <code class="n" translate="no">SupportedModels</code>
<code class="p" translate="no">)</code> <code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code> <code class="nb" translate="no">int</code><code class="p" translate="no">:</code>
    <code class="k" translate="no">if</code> <code class="n" translate="no">model</code> <code class="o" translate="no">==</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">tinysd</code><code class="s2" translate="no">"</code> <code class="ow" translate="no">and</code> <code class="n" translate="no">num_inference_steps</code> <code class="o" translate="no">&gt;</code> <code class="mi" translate="no">2000</code><code class="p" translate="no">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO6-3" id="co_implementing_type_safe_ai_services_CO6-4"><img alt="3" src="assets/3.png" width="12" height="12"/></a>
        <code class="k" translate="no">raise</code> <code class="ne" translate="no">ValueError</code><code class="p" translate="no">(</code>
            <code class="s2" translate="no">"</code><code class="s2" translate="no">TinySD model cannot have more than 2000 inference steps</code><code class="s2" translate="no">"</code>
        <code class="p" translate="no">)</code>
    <code class="k" translate="no">return</code> <code class="n" translate="no">num_inference_steps</code>

<code class="n" translate="no">OutputSize</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="n" translate="no">ImageSize</code><code class="p" translate="no">,</code> <code class="n" translate="no">AfterValidator</code><code class="p" translate="no">(</code><code class="n" translate="no">is_square_image</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO6-4" id="co_implementing_type_safe_ai_services_CO6-5"><img alt="4" src="assets/4.png" width="12" height="12"/></a>
<code class="n" translate="no">InferenceSteps</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO6-4" id="co_implementing_type_safe_ai_services_CO6-6"><img alt="4" src="assets/4.png" width="12" height="12"/></a>
    <code class="nb" translate="no">int</code><code class="p" translate="no">,</code>
    <code class="n" translate="no">AfterValidator</code><code class="p" translate="no">(</code>
        <code class="k" translate="no">lambda</code> <code class="n" translate="no">v</code><code class="p" translate="no">,</code> <code class="n" translate="no">values</code><code class="p" translate="no">:</code> <code class="n" translate="no">is_valid_inference_step</code><code class="p" translate="no">(</code><code class="n" translate="no">v</code><code class="p" translate="no">,</code> <code class="n" translate="no">values</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">model</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code class="p" translate="no">)</code>
    <code class="p" translate="no">)</code><code class="p" translate="no">,</code>
<code class="p" translate="no">]</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">ModelRequest</code><code class="p" translate="no">(</code><code class="n" translate="no">BaseModel</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">prompt</code><code class="p" translate="no">:</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code> <code class="n" translate="no">Field</code><code class="p" translate="no">(</code><code class="n" translate="no">min_length</code><code class="o" translate="no">=</code><code class="mi" translate="no">1</code><code class="p" translate="no">,</code> <code class="n" translate="no">max_length</code><code class="o" translate="no">=</code><code class="mi" translate="no">4000</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">ImageModelRequest</code><code class="p" translate="no">(</code><code class="n" translate="no">ModelRequest</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">model</code><code class="p" translate="no">:</code> <code class="n" translate="no">SupportedModels</code>
    <code class="n" translate="no">output_size</code><code class="p" translate="no">:</code> <code class="n" translate="no">OutputSize</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO6-5" id="co_implementing_type_safe_ai_services_CO6-7"><img alt="5" src="assets/5.png" width="12" height="12"/></a>
    <code class="n" translate="no">num_inference_steps</code><code class="p" translate="no">:</code> <code class="n" translate="no">InferenceSteps</code> <code class="o" translate="no">=</code> <code class="mi" translate="no">200</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO6-6" id="co_implementing_type_safe_ai_services_CO6-8"><img alt="6" src="assets/6.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO6-1" id="callout_implementing_type_safe_ai_services_CO6-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Oltre ai controlli di tipo statico, solleva un errore di validazione in runtime se sono stati passati parametri errati alle funzioni <code translate="no">is_square_image</code> e <code translate="no">is_valid_​infer⁠ence_step</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO6-2" id="callout_implementing_type_safe_ai_services_CO6-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Il modello <code translate="no">tinysd</code> è in grado di generare immagini quadrate solo in determinate dimensioni. La richiesta di un'immagine di dimensioni non quadrate (un rapporto d'aspetto diverso da <code translate="no">1</code>) dovrebbe generare un <code translate="no">ValueError</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO6-4" id="callout_implementing_type_safe_ai_services_CO6-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Solleva un <code translate="no">ValueError</code> se l'utente richiede un numero elevato di passi di inferenza per il modello <code translate="no">tinysd</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO6-5" id="callout_implementing_type_safe_ai_services_CO6-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Crea validatori riutilizzabili e più leggibili utilizzando il modello annotato sia per <code translate="no">OutputSize</code> che per <code translate="no">InferenceSteps</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO6-7" id="callout_implementing_type_safe_ai_services_CO6-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a></dt>
<dd><p>Collega il validatore del campo <code translate="no">OutputSize</code> al campo <code translate="no">output_size</code> per verificare la presenza di valori errati dopo l'inizializzazione del modello.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO6-8" id="callout_implementing_type_safe_ai_services_CO6-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a></dt>
<dd><p>Allega il validatore <code translate="no">InferenceSteps</code> al modello <code translate="no">ImageModelRequest</code> per eseguire controlli sui valori dei campi del modello <em>dopo che</em> questo è stato inizializzato.</p></dd>
</dl></div>
<p>Con i validatori di campo personalizzati, come mostrato nell'<a data-type="xref" href="#field_validators">Esempio 4-9</a>, puoi essere sicuro che i tuoi endpoint di generazione delle immagini saranno protetti dalle configurazioni errate fornite dagli utenti.<a data-startref="ix_ch04-asciidoc21" data-type="indexterm" id="id769"/><a data-startref="ix_ch04-asciidoc20" data-type="indexterm" id="id770"/><a data-startref="ix_ch04-asciidoc19" data-type="indexterm" id="id771"/></p>
<div data-type="note" epub:type="note"><h6>Nota</h6>
<p>Puoi anche utilizzare lo schema del decoratore per convalidare i campi del modello. Si possono associare metodi<span class="keep-together">speciali</span> ai campi del modello per eseguire controlli condizionati sui dati utilizzando il decoratore <code translate="no">@field_validator</code> o <code translate="no">@model_validator</code>.</p>
<p>Mentre <code translate="no">@field_validator</code> accede al valore di un singolo campo per effettuare i controlli, il decoratore <code translate="no">@model_validator</code> permette di effettuare controlli che coinvolgono più campi.</p>
<p>Con i validatori di <code translate="no">after</code> puoi eseguire controlli aggiuntivi o modificare i dati dopo che Pydantic ha completato il parsing e la validazione.</p>
</div>
</div></section>
<section data-pdf-bookmark="Computed Fields" data-type="sect2"><div class="sect2" id="id70">
<h2>Campi calcolati</h2>
<p><a data-primary="computed fields (Pydantic)" data-type="indexterm" id="id772"/><a data-primary="Pydantic" data-secondary="computed fields" data-type="indexterm" id="id773"/><a data-primary="type-safe AI services" data-secondary="Pydantic models" data-tertiary="computed fields" data-type="indexterm" id="id774"/>Analogamente alle classi di dati, Pydantic ti permette anche di implementare metodi per calcolare campi derivati da altri campi.</p>
<p>Puoi utilizzare il decoratore <code translate="no">@computed_field</code> per implementare un campo calcolato per calcolare il conteggio dei token e il costo, come mostrato nell'<a data-type="xref" href="#computed_fields">Esempio 4-10</a>.</p>
<div data-type="example" id="computed_fields">
<h5><span class="label">Esempio 4-10. </span>Utilizzo di campi calcolati per contare automaticamente il numero totale di token</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># schemas.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">typing</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Annotated</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">pydantic</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">computed_field</code><code class="p" translate="no">,</code> <code class="n" translate="no">Field</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">utils</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">count_tokens</code>

<code class="o" translate="no">...</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">TextModelResponse</code><code class="p" translate="no">(</code><code class="n" translate="no">ModelResponse</code><code class="p" translate="no">):</code>
    <code class="n" translate="no">model</code><code class="p" translate="no">:</code> <code class="n" translate="no">SupportedModels</code>
    <code class="n" translate="no">price</code><code class="p" translate="no">:</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="nb" translate="no">float</code><code class="p" translate="no">,</code> <code class="n" translate="no">Field</code><code class="p" translate="no">(</code><code class="n" translate="no">ge</code><code class="o" translate="no">=</code><code class="mi" translate="no">0</code><code class="p" translate="no">,</code> <code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="mf" translate="no">0.01</code><code class="p" translate="no">)]</code>
    <code class="n" translate="no">temperature</code><code class="p" translate="no">:</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="nb" translate="no">float</code><code class="p" translate="no">,</code> <code class="n" translate="no">Field</code><code class="p" translate="no">(</code><code class="n" translate="no">ge</code><code class="o" translate="no">=</code><code class="mf" translate="no">0.0</code><code class="p" translate="no">,</code> <code class="n" translate="no">le</code><code class="o" translate="no">=</code><code class="mf" translate="no">1.0</code><code class="p" translate="no">,</code> <code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="mf" translate="no">0.0</code><code class="p" translate="no">)]</code>

    <code class="nd" translate="no">@property</code>
    <code class="nd" translate="no">@computed_field</code>
    <code class="k" translate="no">def</code> <code class="nf" translate="no">tokens</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">)</code> <code class="o" translate="no">-&gt;</code> <code class="nb" translate="no">int</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">return</code> <code class="n" translate="no">count_tokens</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">content</code><code class="p" translate="no">)</code>

    <code class="nd" translate="no">@property</code>
    <code class="nd" translate="no">@computed_field</code>
    <code class="k" translate="no">def</code> <code class="nf" translate="no">cost</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">)</code> <code class="o" translate="no">-&gt;</code> <code class="nb" translate="no">float</code><code class="p" translate="no">:</code>
        <code class="k" translate="no">return</code> <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">price</code> <code class="o" translate="no">*</code> <code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">tokens</code></pre></div>
<p>I campi computati sono utili per incapsulare la logica di calcolo dei campi all'interno dei tuoi modelli Pydantic per mantenere il codice organizzato. Tieni presente che i campi computati sono accessibili solo quando converti un modello Pydantic in un dizionario usando <code translate="no">.model_dump()</code> o tramite serializzazione quando un gestore dell'API FastAPI restituisce una risposta.</p>
</div></section>
<section data-pdf-bookmark="Model Export and Serialization" data-type="sect2"><div class="sect2" id="id71">
<h2>Esportazione e serializzazione del modello</h2>
<p><a data-primary="Pydantic" data-secondary="model export and serialization" data-type="indexterm" id="id775"/><a data-primary="type-safe AI services" data-secondary="Pydantic models" data-tertiary="model export and serialization" data-type="indexterm" id="id776"/>Poiché i modelli di Python possono essere serializzati in JSON, i modelli definiti nell'<a data-type="xref" href="#pydantic_constrained_fields">Esempio 4-7</a> possono anche essere scaricati (o caricati) in stringhe JSON o in dizionari Python mantenendo tutti gli schemi composti, come mostrato nell'<a data-type="xref" href="#model_export">Esempio 4-11</a>.</p>
<div data-type="example" id="model_export">
<h5><span class="label">Esempio 4-11. </span>Esportazione e serializzazione del modello <code translate="no">TextModelResponse</code> </h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="o" translate="no">&gt;&gt;</code> <code class="n" translate="no">response</code> <code class="o" translate="no">=</code> <code class="n" translate="no">TextModelResponse</code><code class="p" translate="no">(</code><code class="n" translate="no">content</code><code class="o" translate="no">=</code><code class="s2" translate="no">"FastAPI Generative AI Service"</code><code class="p" translate="no">,</code> <code class="n" translate="no">ip</code><code class="o" translate="no">=</code><code class="kc" translate="no">None</code><code class="p" translate="no">)</code>
<code class="o" translate="no">&gt;&gt;</code> <code class="n" translate="no">response</code><code class="o" translate="no">.</code><code class="n" translate="no">model_dump</code><code class="p" translate="no">(</code><code class="n" translate="no">exclude_none</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">)</code>
<code class="p" translate="no">{</code><code class="s1" translate="no">'content'</code><code class="p" translate="no">:</code> <code class="s1" translate="no">'FastAPI Generative AI Service'</code><code class="p" translate="no">,</code>
 <code class="s1" translate="no">'cost'</code><code class="p" translate="no">:</code> <code class="mf" translate="no">0.06</code><code class="p" translate="no">,</code>
 <code class="s1" translate="no">'created_at'</code><code class="p" translate="no">:</code> <code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">datetime</code><code class="p" translate="no">(</code><code class="mi" translate="no">2024</code><code class="p" translate="no">,</code> <code class="mi" translate="no">3</code><code class="p" translate="no">,</code> <code class="mi" translate="no">7</code><code class="p" translate="no">,</code> <code class="mi" translate="no">20</code><code class="p" translate="no">,</code> <code class="mi" translate="no">42</code><code class="p" translate="no">,</code> <code class="mi" translate="no">38</code><code class="p" translate="no">,</code> <code class="mi" translate="no">729410</code><code class="p" translate="no">),</code>
 <code class="s1" translate="no">'price'</code><code class="p" translate="no">:</code> <code class="mf" translate="no">0.01</code><code class="p" translate="no">,</code>
 <code class="s1" translate="no">'request_id'</code><code class="p" translate="no">:</code> <code class="s1" translate="no">'a3f18d85dcb442baa887a505ae8d2cd7'</code><code class="p" translate="no">,</code>
 <code class="s1" translate="no">'tokens'</code><code class="p" translate="no">:</code> <code class="mi" translate="no">6</code><code class="p" translate="no">}</code>

<code class="o" translate="no">&gt;&gt;</code> <code class="n" translate="no">response</code><code class="o" translate="no">.</code><code class="n" translate="no">model_dump_json</code><code class="p" translate="no">(</code><code class="n" translate="no">exclude_unset</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">)</code>
<code class="s1" translate="no">'{"ip":null,"content":"FastAPI Generative AI Service","tokens":6,"cost":0.06}'</code></pre></div>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id777">
<h1>Esportare i modelli Pydantic in dizionari o stringhe JSON</h1>
<p><a data-primary="JSON strings, exporting Pydantic models to" data-type="indexterm" id="id778"/><a data-primary="Pydantic" data-secondary="exporting models to dictionaries or JSON strings" data-type="indexterm" id="id779"/><a data-primary="Python dictionaries, exporting Pydantic models to" data-type="indexterm" id="id780"/><a data-primary="type-safe AI services" data-secondary="Pydantic models" data-tertiary="exporting models to dictionaries or JSON strings" data-type="indexterm" id="id781"/>Quando crei un modello Pydantic, hai anche accesso ai suggerimenti sul tipo dei campi associati e puoi esportare il tuo modello in dizionari Python o stringhe JSON. Pydantic ti permette anche di escludere i campi in base ai loro valori. Ad esempio, puoi eseguire <code translate="no">model.dict(exclude_none=True)</code> per restituire un dizionario senza nessuno dei campi che sono stati impostati su <code translate="no">None</code>. Altre opzioni per escludere i campi durante l'esportazione includono:</p>
<dl>
<dt><code translate="no">exclude_unset</code></dt>
<dd>
<p>Restituisce solo i campi che sono stati impostati esplicitamente durante la creazione del modello.</p>
</dd>
<dt><code translate="no">exclude_defaults</code></dt>
<dd>
<p>Restituisce solo i campi opzionali che sono stati impostati come valori predefiniti.</p>
</dd>
<dt><code translate="no">exclude_None</code></dt>
<dd>
<p>Restituisce solo i campi impostati su <code translate="no">None</code>.</p>
</dd>
</dl>
<p>Puoi combinare queste condizioni quando esporti i tuoi modelli. Queste opzioni sono estremamente utili quando lavori con modelli che hanno un gran numero di campi come i filtri. Ad esempio, se il cliente non specifica alcuni filtri come parametri di query al tuo endpoint, puoi escludere tutti i campi di filtraggio non impostati dal tuo modello di filtro di richiesta.</p>
<p>Puoi utilizzare le stesse funzioni di esclusione dei campi anche quando esporti i tuoi modelli Pydantic in stringhe JSON utilizzando <code translate="no">model.json_dump(exclude_unset=True)</code>.</p>
</div></aside>
</div></section>
<section data-pdf-bookmark="Parsing Environment Variables with Pydantic" data-type="sect2"><div class="sect2" id="id72">
<h2>Analizzare le variabili d'ambiente con Pydantic</h2>
<p><a data-primary="Pydantic Settings" data-type="indexterm" id="ix_ch04-asciidoc22a"/><a data-primary="environment variables, parsing with Pydantic Settings" data-type="indexterm" id="ix_ch04-asciidoc22"/><a data-primary="Pydantic" data-secondary="parsing environment variables" data-type="indexterm" id="ix_ch04-asciidoc23"/><a data-primary="type-safe AI services" data-secondary="Pydantic models" data-tertiary="parsing environment variables" data-type="indexterm" id="ix_ch04-asciidoc24"/>Oltre a <code translate="no">BaseModel</code>, Pydantic implementa anche una classe <code translate="no">Base</code> per l'analisi delle impostazioni e dei segreti dai file. Questa funzione è fornita in un pacchetto opzionale di Pydantic chiamato<code translate="no">pydantic-settings</code>, che puoi installare come dipendenza:</p>
<pre data-code-language="bash" data-type="programlisting" translate="no">$ pip install pydantic-settings<code class="w" translate="no"/></pre>
<p>La classe <code translate="no">BaseSettings</code> fornisce funzioni opzionali di Pydantic per caricare una classe di impostazioni o di configurazione da variabili d'ambiente o da file segreti. Utilizzando questa funzione, i valori delle impostazioni possono essere impostati nel codice o sovrascritti da variabili d'ambiente.</p>
<p>Questo è utile in produzione, dove non vuoi esporre segreti all'interno del codice o dell'ambiente del container.</p>
<p>Quando crei un modello che eredita da <code translate="no">BaseSettings</code>, l'inizializzatore del modello cercherà di impostare i valori di ogni campo utilizzando i valori predefiniti forniti. Se non ci riesce, l'inizializzatore leggerà i valori dei campi non impostati dalle variabili d'ambiente.</p>
<p>Dato un file di ambiente dotenv (ENV):</p>
<pre data-code-language="ini" data-type="programlisting" translate="no"><code class="na" translate="no">APP_SECRET</code><code class="o" translate="no">=</code><code class="s" translate="no">asdlkajdlkajdklaslkldjkasldjkasdjaslk</code>
<code class="na" translate="no">DATABASE_URL</code><code class="o" translate="no">=</code><code class="s" translate="no">postgres://sa:password@localhost:5432/cms</code>
<code class="na" translate="no">CORS_WHITELIST</code><code class="o" translate="no">=</code><code class="s" translate="no">["https://xyz.azurewebsites.net","http://localhost:3000"]</code></pre>
<p>Un ENV è un file di variabili d'ambiente che può utilizzare la sintassi di uno script di shell per le coppie chiave-valore.</p>
<p>L<a data-type="xref" href="#pydantic_settings">'esempio 4-12</a> mostra l'analisi delle variabili d'ambiente con <code translate="no">BaseSettings</code> in azione.</p>
<div data-type="example" id="pydantic_settings">
<h5><span class="label">Esempio 4-12. </span>Utilizzo di Pydantic <code translate="no">BaseSettings</code> per analizzare le variabili d'ambiente</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># settings.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">typing</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Annotated</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">pydantic</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Field</code><code class="p" translate="no">,</code> <code class="n" translate="no">HttpUrl</code><code class="p" translate="no">,</code> <code class="n" translate="no">PostgresDsn</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">pydantic_settings</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">BaseSettings</code><code class="p" translate="no">,</code> <code class="n" translate="no">SettingsConfigDict</code>

<code class="k" translate="no">class</code> <code class="nc" translate="no">AppSettings</code><code class="p" translate="no">(</code><code class="n" translate="no">BaseSettings</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO7-1" id="co_implementing_type_safe_ai_services_CO7-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
    <code class="n" translate="no">model_config</code> <code class="o" translate="no">=</code> <code class="n" translate="no">SettingsConfigDict</code><code class="p" translate="no">(</code>
        <code class="n" translate="no">env_file</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">.env</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="n" translate="no">env_file_encoding</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">utf-8</code><code class="s2" translate="no">"</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO7-2" id="co_implementing_type_safe_ai_services_CO7-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
    <code class="p" translate="no">)</code>

    <code class="n" translate="no">port</code><code class="p" translate="no">:</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="nb" translate="no">int</code><code class="p" translate="no">,</code> <code class="n" translate="no">Field</code><code class="p" translate="no">(</code><code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="mi" translate="no">8000</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code>
    <code class="n" translate="no">app_secret</code><code class="p" translate="no">:</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code> <code class="n" translate="no">Field</code><code class="p" translate="no">(</code><code class="n" translate="no">min_length</code><code class="o" translate="no">=</code><code class="mi" translate="no">32</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code>
    <code class="n" translate="no">pg_dsn</code><code class="p" translate="no">:</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code>
        <code class="n" translate="no">PostgresDsn</code><code class="p" translate="no">,</code>
        <code class="n" translate="no">Field</code><code class="p" translate="no">(</code>
            <code class="n" translate="no">alias</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">DATABASE_URL</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code>
            <code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">postgres://user:pass@localhost:5432/database</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code>
        <code class="p" translate="no">)</code><code class="p" translate="no">,</code>
    <code class="p" translate="no">]</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO7-3" id="co_implementing_type_safe_ai_services_CO7-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a>
    <code class="n" translate="no">cors_whitelist_domains</code><code class="p" translate="no">:</code> <code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code>
        <code class="nb" translate="no">set</code><code class="p" translate="no">[</code><code class="n" translate="no">HttpUrl</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code>
        <code class="n" translate="no">Field</code><code class="p" translate="no">(</code><code class="n" translate="no">alias</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">CORS_WHITELIST</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">http://localhost:3000</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code>
    <code class="p" translate="no">]</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO7-4" id="co_implementing_type_safe_ai_services_CO7-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a>


<code class="n" translate="no">settings</code> <code class="o" translate="no">=</code> <code class="n" translate="no">AppSettings</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code>
<code class="nb" translate="no">print</code><code class="p" translate="no">(</code><code class="n" translate="no">settings</code><code class="o" translate="no">.</code><code class="n" translate="no">model_dump</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO7-5" id="co_implementing_type_safe_ai_services_CO7-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a>
<code class="sd" translate="no">"""
{'port': 8000
 'app_secret': 'asdlkajdlkajdklaslkldjkasldjkasdjaslk',
 'pg_dsn': MultiHostUrl('postgres://sa:password@localhost:5432/cms'),
 'cors_whitelist_domains': {Url('http://localhost:3000/'),
                            Url('https://xyz.azurewebsites.net/')},
}
"""</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO7-1" id="callout_implementing_type_safe_ai_services_CO7-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Dichiara <code translate="no">AppSettings</code> ereditando dalla classe <code translate="no">BaseSettings</code> del pacchetto<span class="keep-together"><code translate="no">pydantic_settings</code></span> pacchetto.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO7-2" id="callout_implementing_type_safe_ai_services_CO7-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Configura <code translate="no">AppSettings</code> per leggere le variabili d'ambiente dal file ENV nella radice di un progetto con la codifica <code translate="no">UTF-8</code>. Per impostazione predefinita, i nomi dei campi snake_case corrispondono ai nomi delle variabili d'ambiente che sono una versione maiuscola di quei nomi. Per esempio, <code translate="no">app_secret</code> diventa <code translate="no">APP_SECRET</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO7-3" id="callout_implementing_type_safe_ai_services_CO7-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Convalida che la variabile d'ambiente <code translate="no">DATABASE_URL</code> abbia un formato di stringa di connessione Postgres valido. Se non viene fornito, imposta il valore predefinito.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO7-4" id="callout_implementing_type_safe_ai_services_CO7-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Controlla che la variabile d'ambiente <code translate="no">CORS_WHITELIST</code> abbia un elenco unico di URL validi con hostname e TLD. Se non viene fornita, imposta il default su un set con un unico valore di <code translate="no">http://localhost:3000</code>.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO7-5" id="callout_implementing_type_safe_ai_services_CO7-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a></dt>
<dd><p>Possiamo verificare che la classe <code translate="no">AppSettings</code> funzioni stampando un dump del modello.</p></dd>
</dl></div>
<div data-type="note" epub:type="note"><h6>Nota</h6>
<p><a data-startref="ix_ch04-asciidoc24" data-type="indexterm" id="id782"/><a data-startref="ix_ch04-asciidoc23" data-type="indexterm" id="id783"/><a data-startref="ix_ch04-asciidoc22" data-type="indexterm" id="id784"/><a data-startref="ix_ch04-asciidoc22a" data-type="indexterm" id="id785"/> puoi cambiare i file di ambiente quando usi l'<span class="keep-together">argomento</span> <code translate="no">_env_file</code><span class="keep-together">:</span></p>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="n" translate="no">test_settings</code> <code class="o" translate="no">=</code> <code class="n" translate="no">AppSettings</code><code class="p" translate="no">(</code><code class="n" translate="no">_env_file</code><code class="o" translate="no">=</code><code class="s2" translate="no">"test.env"</code><code class="p" translate="no">)</code></pre>
</div>
</div></section>
<section class="less_space pagebreak-before" data-pdf-bookmark="Dataclasses or Pydantic Models in FastAPI" data-type="sect2"><div class="sect2" id="id73">
<h2>Classi di dati o modelli pidantici in FastAPI</h2>
<p><a data-primary="dataclasses" data-type="indexterm" id="ix_ch04-asciidoc25"/><a data-primary="models (Pydantic)" data-secondary="in FastAPI" data-type="indexterm" id="ix_ch04-asciidoc26"/><a data-primary="Pydantic" data-secondary="dataclasses or Pydantic models in FastAPI" data-type="indexterm" id="ix_ch04-asciidoc27"/><a data-primary="type-safe AI services" data-secondary="Pydantic models" data-tertiary="Python dataclasses or Pydantic models in FastAPI" data-type="indexterm" id="ix_ch04-asciidoc28"/>Anche se le classi di dati supportano la serializzazione solo dei tipi più comuni (ad esempio, <code translate="no">int</code>, <code translate="no">str</code>, <code translate="no">list</code>, ecc.) e non eseguono la convalida dei campi a runtime, FastAPI può comunque lavorare sia con i modelli di Python che con le classi di dati di Python. Per la convalida dei campi e le funzioni aggiuntive, dovresti usare i modelli di Python. L<a data-type="xref" href="#dataclass_fastaspi">'esempio 4-13</a> mostra come le classi di dati possono essere utilizzate nei gestori di rotte di FastAPI.</p>
<div data-type="example" id="dataclass_fastaspi">
<h5><span class="label">Esempio 4-13. </span>Utilizzo delle classi di dati in FastAPI</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># schemas.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">dataclasses</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">dataclass</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">typing</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Literal</code>

<code class="nd" translate="no">@dataclass</code>
<code class="k" translate="no">class</code> <code class="nc" translate="no">TextModelRequest</code><code class="p" translate="no">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO8-1" id="co_implementing_type_safe_ai_services_CO8-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
    <code class="n" translate="no">model</code><code class="p" translate="no">:</code> <code class="n" translate="no">Literal</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">tinyLlama</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">gemma2b</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code>
    <code class="n" translate="no">prompt</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code>
    <code class="n" translate="no">temperature</code><code class="p" translate="no">:</code> <code class="nb" translate="no">float</code>

<code class="nd" translate="no">@dataclass</code>
<code class="k" translate="no">class</code> <code class="nc" translate="no">TextModelResponse</code><code class="p" translate="no">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO8-1" id="co_implementing_type_safe_ai_services_CO8-2"><img alt="1" src="assets/1.png" width="12" height="12"/></a>
    <code class="n" translate="no">response</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code>
    <code class="n" translate="no">tokens</code><code class="p" translate="no">:</code> <code class="nb" translate="no">int</code>

<code class="c1" translate="no"># main.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">fastapi</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Body</code><code class="p" translate="no">,</code> <code class="n" translate="no">FastAPI</code><code class="p" translate="no">,</code> <code class="n" translate="no">HTTPException</code><code class="p" translate="no">,</code> <code class="n" translate="no">status</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">models</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">generate_text</code><code class="p" translate="no">,</code> <code class="n" translate="no">load_text_model</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">schemas</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">TextModelRequest</code><code class="p" translate="no">,</code> <code class="n" translate="no">TextModelResponse</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">utils</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">count_tokens</code>

<code class="c1" translate="no"># load lifespan</code>
<code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code>

<code class="n" translate="no">app</code> <code class="o" translate="no">=</code> <code class="n" translate="no">FastAPI</code><code class="p" translate="no">(</code><code class="n" translate="no">lifespan</code><code class="o" translate="no">=</code><code class="n" translate="no">lifespan</code><code class="p" translate="no">)</code>

<code class="nd" translate="no">@app</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/generate/text</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code>
<code class="k" translate="no">def</code> <code class="nf" translate="no">serve_text_to_text_controller</code><code class="p" translate="no">(</code>
    <code class="n" translate="no">body</code><code class="p" translate="no">:</code> <code class="n" translate="no">TextModelRequest</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Body</code><code class="p" translate="no">(</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code>
<code class="p" translate="no">)</code> <code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code> <code class="n" translate="no">TextModelResponse</code><code class="p" translate="no">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO8-2" id="co_implementing_type_safe_ai_services_CO8-3"><img alt="2" src="assets/2.png" width="12" height="12"/></a> <a class="co" href="#callout_implementing_type_safe_ai_services_CO8-4" id="co_implementing_type_safe_ai_services_CO8-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a>
    <code class="k" translate="no">if</code> <code class="n" translate="no">body</code><code class="o" translate="no">.</code><code class="n" translate="no">model</code> <code class="ow" translate="no">not</code> <code class="ow" translate="no">in</code> <code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">tinyLlama</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">gemma2b</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code class="p" translate="no">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO8-3" id="co_implementing_type_safe_ai_services_CO8-5"><img alt="3" src="assets/3.png" width="12" height="12"/></a>
        <code class="k" translate="no">raise</code> <code class="n" translate="no">HTTPException</code><code class="p" translate="no">(</code>
            <code class="n" translate="no">detail</code><code class="o" translate="no">=</code><code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Model </code><code class="si" translate="no">{</code><code class="n" translate="no">body</code><code class="o" translate="no">.</code><code class="n" translate="no">model</code><code class="si" translate="no">}</code><code class="s2" translate="no"> is not supported</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code>
            <code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="n" translate="no">status</code><code class="o" translate="no">.</code><code class="n" translate="no">HTTP_400_BAD_REQUEST</code><code class="p" translate="no">,</code>
        <code class="p" translate="no">)</code>
    <code class="n" translate="no">output</code> <code class="o" translate="no">=</code> <code class="n" translate="no">generate_text</code><code class="p" translate="no">(</code><code class="n" translate="no">models</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">text</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="n" translate="no">body</code><code class="o" translate="no">.</code><code class="n" translate="no">prompt</code><code class="p" translate="no">,</code> <code class="n" translate="no">body</code><code class="o" translate="no">.</code><code class="n" translate="no">temperature</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">tokens</code> <code class="o" translate="no">=</code> <code class="n" translate="no">count_tokens</code><code class="p" translate="no">(</code><code class="n" translate="no">body</code><code class="o" translate="no">.</code><code class="n" translate="no">prompt</code><code class="p" translate="no">)</code> <code class="o" translate="no">+</code> <code class="n" translate="no">count_tokens</code><code class="p" translate="no">(</code><code class="n" translate="no">output</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">return</code> <code class="n" translate="no">TextModelResponse</code><code class="p" translate="no">(</code><code class="n" translate="no">response</code><code class="o" translate="no">=</code><code class="n" translate="no">output</code><code class="p" translate="no">,</code> <code class="n" translate="no">tokens</code><code class="o" translate="no">=</code><code class="n" translate="no">tokens</code><code class="p" translate="no">)</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO8-4" id="co_implementing_type_safe_ai_services_CO8-6"><img alt="4" src="assets/4.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO8-1" id="callout_implementing_type_safe_ai_services_CO8-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Definire i modelli per gli schemi di richiesta e risposta dei modelli di testo.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO8-3" id="callout_implementing_type_safe_ai_services_CO8-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Convertire il gestore per servire le richieste di <code translate="no">POST</code> con un corpo. Quindi, dichiarare il corpo della richiesta come <code translate="no">TextModelRequest</code> e la risposta come <code translate="no">TextModelResponse</code>. I controllori statici del codice come <code translate="no">mypy</code> leggeranno le annotazioni di tipo e solleveranno avvisi se il controllore non restituisce il modello di risposta previsto.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO8-5" id="callout_implementing_type_safe_ai_services_CO8-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Verifica esplicitamente se il servizio supporta il parametro <code translate="no">model</code> fornito nella richiesta <code translate="no">body</code>. In caso contrario, restituisce al client una risposta di eccezione HTTP di richiesta errata.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO8-4" id="callout_implementing_type_safe_ai_services_CO8-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>FastAPI converte le classi di dati vanilla in classi di dati Pydantic per serializzare/deserializzare e validare i dati di richiesta e risposta.</p></dd>
</dl></div>
<p>Nell'<a data-type="xref" href="#dataclass_fastaspi">esempio 4-13</a>, hai sfruttato le annotazioni di tipo facendo un refactoring del controller del modello di testo per renderlo resistente alle nuove modifiche e agli input errati dell'utente. I controllori statici di tipo possono ora aiutarti a individuare eventuali problemi relativi ai dati durante le modifiche. Inoltre, FastAPI ha usato le annotazioni di tipo per convalidare le richieste e le risposte insieme alla generazione automatica di una pagina di documentazione OpenAPI, come mostrato nella <a data-type="xref" href="#fastapi_dataclasses_docs">Figura 4-2</a>.</p>
<p>Ora vedi che FastAPI sfrutta i modelli Pydantic per la gestione e la validazione dei dati, anche se utilizzi delle classi di dati vanilla. FastAPI converte le tue classi di dati vanilla in classi di dati Pydantic per utilizzare le sue funzioni di validazione dei dati.
Questo comportamento è intenzionale perché se hai dei progetti con diverse annotazioni preesistenti sul tipo di classe di dati, puoi migrarle senza doverle riscrivere in modelli Pydantic per sfruttare le funzioni di convalida dei dati. Tuttavia, se stai iniziando un nuovo progetto, è consigliabile utilizzare direttamente i modelli Pydantic in sostituzione delle classi di dati integrate di Python.</p>
<figure><div class="figure" id="fastapi_dataclasses_docs">
<img alt="bgai 0402" src="assets/bgai_0402.png" width="994" height="962"/>
<h6><span class="label">Figura 4-2. </span>Generazione automatica di schemi di convalida utilizzando classi di dati vanilla</h6>
</div></figure>
<p>Vediamo ora come sostituire le classi di dati con Pydantic nella tua applicazione FastAPI. Vedi l'<a data-type="xref" href="#pydantic_fastapi">Esempio 4-14</a>.</p>
<div data-type="example" id="pydantic_fastapi">
<h5><span class="label">Esempio 4-14. </span>Utilizzo di Pydantic per modellare gli schemi di richiesta e risposta</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># main.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">fastapi</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Body</code><code class="p" translate="no">,</code> <code class="n" translate="no">FastAPI</code><code class="p" translate="no">,</code> <code class="n" translate="no">HTTPException</code><code class="p" translate="no">,</code> <code class="n" translate="no">Request</code><code class="p" translate="no">,</code> <code class="n" translate="no">status</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">models</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">generate_text</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">schemas</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">TextModelRequest</code><code class="p" translate="no">,</code> <code class="n" translate="no">TextModelResponse</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO9-1" id="co_implementing_type_safe_ai_services_CO9-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a>

<code class="c1" translate="no"># load lifespan</code>
<code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code>

<code class="n" translate="no">app</code> <code class="o" translate="no">=</code> <code class="n" translate="no">FastAPI</code><code class="p" translate="no">(</code><code class="n" translate="no">lifespan</code><code class="o" translate="no">=</code><code class="n" translate="no">lifespan</code><code class="p" translate="no">)</code>

<code class="nd" translate="no">@app</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/generate/text</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO9-2" id="co_implementing_type_safe_ai_services_CO9-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
<code class="k" translate="no">def</code> <code class="nf" translate="no">serve_text_to_text_controller</code><code class="p" translate="no">(</code>
    <code class="n" translate="no">request</code><code class="p" translate="no">:</code> <code class="n" translate="no">Request</code><code class="p" translate="no">,</code> <code class="n" translate="no">body</code><code class="p" translate="no">:</code> <code class="n" translate="no">TextModelRequest</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Body</code><code class="p" translate="no">(</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="p" translate="no">)</code>
<code class="p" translate="no">)</code> <code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code> <code class="n" translate="no">TextModelResponse</code><code class="p" translate="no">:</code>
    <code class="k" translate="no">if</code> <code class="n" translate="no">body</code><code class="o" translate="no">.</code><code class="n" translate="no">model</code> <code class="ow" translate="no">not</code> <code class="ow" translate="no">in</code> <code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">tinyLlama</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code> <code class="s2" translate="no">"</code><code class="s2" translate="no">gemma2b</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code class="p" translate="no">:</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO9-3" id="co_implementing_type_safe_ai_services_CO9-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a>
        <code class="k" translate="no">raise</code> <code class="n" translate="no">HTTPException</code><code class="p" translate="no">(</code>
            <code class="n" translate="no">detail</code><code class="o" translate="no">=</code><code class="sa" translate="no">f</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Model </code><code class="si" translate="no">{</code><code class="n" translate="no">body</code><code class="o" translate="no">.</code><code class="n" translate="no">model</code><code class="si" translate="no">}</code><code class="s2" translate="no"> is not supported</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code>
            <code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="n" translate="no">status</code><code class="o" translate="no">.</code><code class="n" translate="no">HTTP_400_BAD_REQUEST</code><code class="p" translate="no">,</code>
        <code class="p" translate="no">)</code>
    <code class="n" translate="no">output</code> <code class="o" translate="no">=</code> <code class="n" translate="no">generate_text</code><code class="p" translate="no">(</code><code class="n" translate="no">models</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">text</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code class="p" translate="no">,</code> <code class="n" translate="no">body</code><code class="o" translate="no">.</code><code class="n" translate="no">prompt</code><code class="p" translate="no">,</code> <code class="n" translate="no">body</code><code class="o" translate="no">.</code><code class="n" translate="no">temperature</code><code class="p" translate="no">)</code>
    <code class="k" translate="no">return</code> <code class="n" translate="no">TextModelResponse</code><code class="p" translate="no">(</code><code class="n" translate="no">content</code><code class="o" translate="no">=</code><code class="n" translate="no">output</code><code class="p" translate="no">,</code> <code class="n" translate="no">ip</code><code class="o" translate="no">=</code><code class="n" translate="no">request</code><code class="o" translate="no">.</code><code class="n" translate="no">client</code><code class="o" translate="no">.</code><code class="n" translate="no">host</code><code class="p" translate="no">)</code> <a class="co" href="#callout_implementing_type_safe_ai_services_CO9-4" id="co_implementing_type_safe_ai_services_CO9-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO9-1" id="callout_implementing_type_safe_ai_services_CO9-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Importa i modelli Pydantic per gli schemi di richiesta e risposta dei modelli di testo.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO9-2" id="callout_implementing_type_safe_ai_services_CO9-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Convertire il gestore per servire le richieste di <code translate="no">POST</code> con un corpo. Quindi, dichiarare il corpo della richiesta come <code translate="no">TextModelRequest</code> e la risposta come <code translate="no">TextModelResponse</code>. I controllori statici del codice come <code translate="no">mypy</code> leggeranno le annotazioni di tipo e solleveranno avvisi se il controllore non restituisce il modello di risposta previsto.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO9-3" id="callout_implementing_type_safe_ai_services_CO9-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Verifica esplicitamente se il servizio supporta il parametro <code translate="no">model</code> fornito nella richiesta <code translate="no">body</code>. In caso contrario, restituisce al client una risposta di eccezione HTTP di richiesta errata.</p></dd>
<dt><a class="co" href="#co_implementing_type_safe_ai_services_CO9-4" id="callout_implementing_type_safe_ai_services_CO9-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Restituire il modello <code translate="no">TextModelResponse</code> Pydantic come da digitazione della funzione. Accedere all'indirizzo IP del cliente utilizzando l'oggetto request tramite <code translate="no">request.client.host</code>. FastAPI si occuperà di serializzare il modello utilizzando <code translate="no">.model_dump()</code>. Dato che hai implementato anche i campi calcolati per le proprietà <code translate="no">tokens</code> e <code translate="no">cost</code>, questi saranno automaticamente inclusi nella risposta dell'API senza alcun lavoro aggiuntivo.</p></dd>
</dl></div>
<div data-type="note" epub:type="note"><h6>Nota</h6>
<p>Come mostrato nell'<a data-type="xref" href="#dataclass_fastaspi">Esempio 4-13</a>, se utilizzi le classi di dati invece dei modelli Pydantic, FastAPI le convertirà in classi di dati Pydantic per serializzare/deserializzare e convalidare i dati della richiesta e della risposta. Tuttavia, potresti non essere in grado di sfruttare funzioni avanzate come i vincoli di campo e i campi calcolati con le classi di dati.</p>
</div>
<p>Come puoi vedere nell'<a data-type="xref" href="#pydantic_fastapi">Esempio 4-14</a>, Pydantic può offrire un'esperienza eccezionale allo sviluppatore, aiutandolo nei controlli di tipo, nella convalida dei dati, nella serializzazione, nel completamento automatico dell'editor di codice e negli attributi calcolati.</p>
<p>FastAPI può anche utilizzare i tuoi modelli Pydantic per generare automaticamente una pagina di specifiche e documentazione OpenAPI, in modo che tu possa testare manualmente i tuoi endpoint<span class="keep-together">senza problemi.</span></p>
<p>Una volta avviato il server, dovresti vedere una pagina di documentazione aggiornata con i nuovi modelli Pydantic e i campi vincolati aggiornati, come mostrato nella <a data-type="xref" href="#fastapi_pydnatic_models">Figura 4-3</a>.</p>
<figure><div class="figure" id="fastapi_pydnatic_models">
<img alt="bgai 0403" src="assets/bgai_0403.png" width="1138" height="1450"/>
<h6><span class="label">Figura 4-3. </span>Generazione automatica di documenti FastAPI utilizzando i modelli Pydantic</h6>
</div></figure>
<p>Se invii una richiesta all'endpoint <code translate="no">/generate/text</code>, dovresti vedere i campi<span class="keep-together">precompilati</span> attraverso il modello Pydantic di <code translate="no">TextModelResponse</code>, come mostrato nell'<a data-type="xref" href="#fastapi_pydnatic_docs">esempio 4-15</a>.</p>
<div data-type="example" id="fastapi_pydnatic_docs">
<h5><span class="label">Esempio 4-15. </span>Popolamento automatico dei campi di risposta tramite il modello <code translate="no">TextModelResponse</code> Pydantic</h5>
<pre data-type="programlisting" translate="no">Request

curl -X 'POST' \
    'http://localhost:8000/generate/text' \
    -H 'accept: application/json' \
    -H 'Content-Type: application/json' \
    -d '{
    "prompt": "What is your name?",
    "model": "tinyllama",
    "temperature": 0.01
}'

http://localhost:8000/generate/text

&gt;&gt; Response body
{
    "request_id": "7541204d5c684f429fe43ccf360fЗ3dc",
    "ip": "127.0.0.1"
    "content": "I am not a person. However, I can provide you with information
        about my name. My name is fastapi bot.",
    "created_at": "2024-03-07T16:06:57.492039",
    "price": 0.01,
    "tokens": 25,
    "cost": 0.25
}

&gt;&gt; Response headers

content-length: 259
content-type: application/json
date: Thu, 07 Mar 2024 16:07:01 GMT
server: uvicorn
x-response-time: 22.9243</pre></div>
<p>Le caratteristiche del modello Pydantic che ho trattato in questo capitolo rappresentano solo una parte degli strumenti a tua disposizione per costruire servizi GenAI. Dovresti ora sentirti più sicuro nello sfruttare Pydantic per annotare i tuoi servizi per migliorare la loro affidabilità e la tua esperienza di sviluppatore<a data-startref="ix_ch04-asciidoc28" data-type="indexterm" id="id786"/><a data-startref="ix_ch04-asciidoc27" data-type="indexterm" id="id787"/><a data-startref="ix_ch04-asciidoc26" data-type="indexterm" id="id788"/><a data-startref="ix_ch04-asciidoc25" data-type="indexterm" id="id789"/> .<a data-startref="ix_ch04-asciidoc12" data-type="indexterm" id="id790"/><a data-startref="ix_ch04-asciidoc11" data-type="indexterm" id="id791"/></p>
</div></section>
</div></section>
<section class="less_space pagebreak-before" data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="id74">
<h1>Riassunto</h1>
<p>In questo capitolo hai appreso l'importanza di creare servizi completamente tipizzati per i modelli GenAI. Ora sai come implementare la sicurezza dei tipi con tipi standard e vincolati, come utilizzare i modelli Pydantic per la convalida dei dati e come implementare i tuoi validatori di dati personalizzati nel tuo servizio GenAI. Hai anche scoperto le strategie per convalidare i contenuti delle richieste e delle risposte e per gestire le impostazioni dell'applicazione con Pydantic per prevenire i bug e migliorare l'esperienza di sviluppo. Nel complesso, seguendo gli esempi pratici, hai imparato come implementare un servizio GenAI robusto e meno soggetto a errori.<a data-startref="ix_ch04-asciidoc0" data-type="indexterm" id="id792"/></p>
<p>Il capitolo successivo tratta la programmazione asincrona nei carichi di lavoro dell'intelligenza artificiale, discutendo le prestazioni e le operazioni parallele. Imparerai a conoscere meglio i task legati all'I/O e quelli legati alla CPU e capirai il ruolo e i limiti dei task in background di FastAPI con i flussi di lavoro concorrenti.</p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="id749"><sup><a href="ch04.html#id749-marker">1</a></sup> Un <a href="https://oreil.ly/69Pmn">tipo<code translate="no">Literal</code> </a> può essere utilizzato per indicare ai verificatori di tipo che l'oggetto annotato ha un valore equivalente a uno dei letterali forniti.</p><p data-type="footnote" id="id750"><sup><a href="ch04.html#id750-marker">2</a></sup> Il sito <code translate="no">tiktoken</code> di OpenAI utilizza l'<a href="https://oreil.ly/l67GS">algoritmo<em>Byte-Pair Encoding</em> (BPE)</a> per tokenizzare il testo. Modelli diversi utilizzano codifiche diverse per convertire il testo in token.</p><p data-type="footnote" id="id762"><sup><a href="ch04.html#id762-marker">3</a></sup> Anche le strutture nei linguaggi simili al C e le classi di dati in Python possono essere utilizzate per raggruppare e passare i dati.</p></div></div></section></div></div></body></html>
<html><head></head><body><div id="book-content"><div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 7. Integrating Databases into AI Services" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch07">
<h1><span class="label">Capitolo 7. </span>Integrare i database nei servizi di intelligenza artificiale</h1><div data-type="note"><p>Questo lavoro è stato tradotto utilizzando l'AI. Siamo lieti di ricevere il tuo feedback e i tuoi commenti: <a href="mailto:translation-feedback@oreilly.com">translation-feedback@oreilly.com</a></p></div>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id930">
<h1>Obiettivi del capitolo</h1>
<p><a data-primary="databases" data-type="indexterm" id="ix_ch07-asciidoc0"/><a data-primary="databases" data-secondary="integrating into AI services" data-type="indexterm" id="ix_ch07-asciidoc1"/>In questo capitolo imparerai a conoscere:</p>
<ul>
<li>
<p>Quando è necessario un database e come identificare il tipo di database appropriato per il tuo progetto</p>
</li>
<li>
<p>Il meccanismo alla base dei database relazionali e i casi d'uso dei database non relazionali</p>
</li>
<li>
<p>Il flusso di sviluppo, gli strumenti e le best practice per lavorare con i database relazionali</p>
</li>
<li>
<p>Le tecniche per migliorare le prestazioni e l'efficienza delle query quando si lavora con i database</p>
</li>
<li>
<p>Come gestire le modifiche allo schema del database in continua evoluzione</p>
</li>
<li>
<p>Strategie per gestire la base di codice, lo schema del database e le derive dei dati quando si lavora in team</p>
</li>
</ul>
</div></aside>
<p>In questo capitolo, integrerai un database al tuo attuale servizio API per memorizzare e recuperare le interazioni degli utenti.</p>
<p>Questo capitolo presuppone un'esperienza di base nell'utilizzo dei database e del linguaggio SQL (Structured Query Language), quindi non tratterà tutti gli aspetti della programmazione SQL e dei flussi di lavoro dei database, ma ti illustrerà i concetti di database di livello superiore, i flussi di lavoro per lo sviluppo e le migliori pratiche per l'integrazione dei database nelle tue applicazioni FastAPI che interagiscono con modelli GenAI come gli LLM.</p>
<p class="less_space pagebreak-before">Imparerai il ruolo dei database relazionali (SQL) rispetto a quelli non relazionali (noSQL) nello sviluppo di un'applicazione e sarai in grado di scegliere con sicurezza il database giusto per il tuo caso d'uso. Poi capirai meglio le caratteristiche dei database relazionali e gli strumenti associati, come i mappatori relazionali a oggetti (ORM) e gli strumenti di migrazione dei database. Infine, come esercizio pratico, integrerai un database nella tua applicazione esistente utilizzando SQL e Alembic, per memorizzare e recuperare le conversazioni degli utenti con un LLM.</p>
<p>Alla fine di questo capitolo, ti sentirai più sicuro nel selezionare, configurare e risolvere i problemi legati al database nelle tue applicazioni GenAI.</p>
<section data-pdf-bookmark="The Role of a Database" data-type="sect1"><div class="sect1" id="id104">
<h1>Il ruolo di un database</h1>
<p><a data-primary="databases" data-secondary="role of" data-type="indexterm" id="ix_ch07-asciidoc2"/>Quando costruisci servizi di backend, spesso hai bisogno di un database per mantenere lo stato dell'applicazione e memorizzare i dati degli utenti. In altri casi, la tua applicazione non avrà bisogno di un database e non dovresti cercare di aggiungerne uno, poiché qualsiasi integrazione con il database può aumentare significativamente la complessità dei tuoi servizi.</p>
<p>Qui<a data-primary="databases" data-secondary="cases in which databases are not needed" data-type="indexterm" id="id931"/> ci sono diversi casi in cui puoi rinunciare all'uso di un database:</p>
<ol>
<li>
<p>La tua applicazione può partire da uno stato nuovo all'avvio per ogni nuova sessione utente.</p>
</li>
<li>
<p>Il ricalcolo dei dati dell'applicazione è semplice ed efficiente dal punto di vista delle risorse.</p>
</li>
<li>
<p>I dati dell'applicazione sono abbastanza piccoli da poter essere memorizzati.</p>
</li>
<li>
<p>La tua applicazione è tollerante alle perdite di dati dovute a vari motivi, come errori del server, riavvii o altri eventi inaspettati.</p>
</li>
<li>
<p>Sessioni utente o istanze applicative diverse non avranno bisogno di condividere i dati.</p>
</li>
<li>
<p>I dati di cui hai bisogno possono essere prelevati direttamente da sistemi esterni, modelli GenAI e altre API applicative, e non dal tuo database.</p>
</li>
<li>
<p>L'utente è felice di aspettare che i dati vengano ricalcolati per ogni nuova sessione o azione.</p>
</li>
<li>
<p>I requisiti del tuo servizio consentono di conservare i dati in file su disco, nello storage del browser o in un cloud esterno invece che in un database. Con queste alternative, i tuoi servizi possono tollerare che l'archiviazione e il recupero dei dati non siano affidabili ed efficienti come un database.</p>
</li>
<li>
<p>Stai realizzando un proof-of-concept e devi evitare a tutti i costi ritardi o complessità del progetto.</p>
</li>
</ol>
<p class="less_space pagebreak-before">Un esempio di applicazione che corrisponde ai criteri precedenti è un <em>generatore di immagini GenAI</em> utilizzato solo a scopo dimostrativo.</p>
<p>In questo esempio, non dovrai memorizzare alcuna immagine generata e potrai sempre riavviare o utilizzare l'applicazione in qualsiasi momento partendo da uno stato nuovo. Inoltre, l'applicazione non ha bisogno di sapere chi è l'utente e non c'è bisogno di condividere i dati tra le sessioni. Inoltre, se si verifica un errore del server, l'impatto della perdita di dati è minimo perché puoi rigenerare una nuova immagine al volo.</p>
<p>Come puoi vedere, ci sono almeno una manciata di casi in cui non hai bisogno di un database per costruire i tuoi servizi GenAI. Tuttavia, potresti chiederti quando hai davvero bisogno di un database.</p>
<p class="fix_tracking">
Per capire quando un database è necessario, devi comprendere il ruolo dei database. In breve, puoi usarli per archiviare, organizzare e gestire i dati in un formato efficiente che consenta di recuperarli, manipolarli e analizzarli facilmente. Inoltre, i database sono dotati di funzioni fondamentali come il ripristino/backup, la gestione dell'accesso concorrente, l'indicizzazione, il caching e il controllo dell'accesso basato sui ruoli, oltre a molte altre, che li rendono una componente insostituibile di qualsiasi servizio che visualizza, produce e consuma dati.</p>
<p>Nella prossima sezione esamineremo nel dettaglio il funzionamento interno dei database, con particolare attenzione ai database relazionali su cui si concentreranno gli esempi pratici di questo capitolo. Grazie alla comprensione dettagliata degli interni dei database, potrai progettare API GenAI completamente ottimizzate e pronte per la produzione. In questo modo potrai delegare i carichi di lavoro più pesanti al motore del database, che è stato progettato specificamente per i compiti più pesanti.<a data-startref="ix_ch07-asciidoc2" data-type="indexterm" id="id932"/></p>
</div></section>
<section data-pdf-bookmark="Database Systems" data-type="sect1"><div class="sect1" id="id105">
<h1>Sistemi di database</h1>
<p><a data-primary="databases" data-secondary="types of database systems" data-type="indexterm" id="ix_ch07-asciidoc3"/><a data-primary="nonrelational (NoSQL) databases" data-type="indexterm" id="ix_ch07-asciidoc4"/><a data-primary="relational (SQL) databases" data-type="indexterm" id="ix_ch07-asciidoc5"/><a data-primary="SQL (relational) databases" data-type="indexterm" id="ix_ch07-asciidoc5a"/>Ora che hai capito quando utilizzare un database, scopriamo di più sui diversi database che puoi utilizzare e sul loro funzionamento.</p>
<p>È possibile costruire un modello mentale dei database suddividendoli in due categorie principali: database<em>relazionali</em> (SQL) e <em>non relazionali</em> (NoSQL).</p>
<p>La categorizzazione <em>SQL</em> contro <em>NoSQL</em> si basa sul fatto che i database relazionali utilizzano vari dialetti di SQL come linguaggio di query principale, mentre i database non relazionali sono spesso dotati di un proprio linguaggio di query specializzato.</p>
<p>Per entrambe le categorie di sistemi di database, è possibile adottare un modello mentale di come sono strutturati tali sistemi. Sia i sistemi di database SQL che quelli NoSQL sono spesso costituiti dai seguenti elementi:</p>
<ul class="less_space pagebreak-before">
<li>
<p>Un <em>server</em> di livello superiore, che ospita l'intera infrastruttura del database e consuma risorse di sistema (CPU, RAM e storage).</p>
</li>
<li>
<p>Uno o più <em>database</em> all'interno del server, che agiscono come <em>contenitori logici</em> che contengono dati correlati.</p>
</li>
<li>
<p>Uno o più <em>schemi</em> all'interno di un database (a seconda del software del database), che servono a definire <em>la</em> struttura completa dei dati e i vari oggetti strutturali come indici, vincoli logici, trigger e così via.</p>
</li>
<li>
<p>Zero o più <em>tabelle</em> (SQL) o <em>collezioni</em> (NoSQL) create all'interno del database (come parte di uno schema), che raggruppano dati correlati.</p>
</li>
<li>
<p>Zero o più <em>elementi</em> all'interno di ogni raccolta (come documenti) o tabella (come righe), che rappresentano record o entità specifiche.</p>
</li>
</ul>
<p><a data-type="xref" href="#database_server_breakdown">La Figura 7-1</a> visualizza la suddetta ripartizione.</p>
<figure><div class="figure" id="database_server_breakdown">
<img alt="bgai 0701" src="assets/bgai_0701.png" width="1438" height="811"/>
<h6><span class="label">Figura 7-1. </span>Suddivisione del sistema di database</h6>
</div></figure>
<p class="less_space pagebreak-before">L'adozione di un modello mentale come quello illustrato nella <a data-type="xref" href="#database_server_breakdown">Figura 7-1</a> ti aiuterà a orientarti nella crescente varietà di sistemi di database, in quanto puoi aspettarti la presenza di meccanismi di base simili. Questa familiarità, si spera, ridurrà la tua curva di apprendimento nell'adozione di diversi sistemi di database.</p>
<p>Passiamo quindi in rassegna brevemente i sistemi di database SQL e NoSQL, in modo da comprendere meglio i loro casi d'uso, le loro caratteristiche e i loro limiti nella creazione di API e servizi.</p>
<p>Per aiutarti a creare un modello mentale dei database relazionali e non relazionali, dai un'occhiata alla <a data-type="xref" href="#db_types">Figura 7-2</a>.</p>
<figure><div class="figure" id="db_types">
<img alt="bgai 0702" src="assets/bgai_0702.png" width="1238" height="960"/>
<h6><span class="label">Figura 7-2. </span>Tipi di database</h6>
</div></figure>
<p>Puoi anche usare il riepilogo della <a data-type="xref" href="#db_comparison">Tabella 7-1</a> come riferimento dei tipi di database che verranno trattati in questo capitolo.</p>
<table class="striped less_space pagebreak-before" id="db_comparison">
<caption><span class="label">Tabella 7-1. </span>Confronto tra i database</caption>
<thead>
<tr>
<th>Tipo</th>
<th>Modello di dati</th>
<th>Esempi</th>
<th>Casi d'uso</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>Negozi chiave-valore</p></td>
<td><p>Coppie chiave-valore</p></td>
<td><p>Redis, DynamoDB, Memcached</p></td>
<td><p>Caching, gestione delle sessioni</p></td>
</tr>
<tr>
<td><p>Negozi di grafici</p></td>
<td><p>Nodi e bordi</p></td>
<td><p>Neo4j, Amazon Neptune, ArangoDB</p></td>
<td><p>Social network, motori di raccomandazione, rilevamento delle frodi</p></td>
</tr>
<tr>
<td><p>Archivi di documenti</p></td>
<td><p>Documenti</p></td>
<td><p>MongoDB, CouchDB, Amazon DocumentDB</p></td>
<td><p>Gestione dei contenuti, e-commerce, analisi in tempo reale</p></td>
</tr>
<tr>
<td><p>Negozi vettoriali</p></td>
<td><p>Vettori ad alta dimensione</p></td>
<td><p>Pigna, Weaviate</p></td>
<td><p>Sistemi di raccomandazione, ricerca di immagini/testi, archiviazione di modelli ML</p></td>
</tr>
<tr>
<td><p>Negozi di famiglia a colonna larga</p></td>
<td><p>Tabelle con righe e colonne</p></td>
<td><p>Apache Cassandra, HBase, ScyllaDB</p></td>
<td><p>Dati di serie temporali, analisi in tempo reale, registrazione</p></td>
</tr>
</tbody>
</table>
<p>Ora che hai un'ampia panoramica di tutti i più comuni database relazionali e non relazionali, puoi visualizzare un servizio GenAI del mondo reale che utilizza questi database insieme.</p>
<p>Immagina di costruire un servizio LLM abilitato a RAG in grado di dialogare con una base di conoscenza. I documenti di questa base di conoscenza sono correlati tra loro, quindi decidi di implementare un grafo RAG per catturare un contesto più ricco. Per implementare un grafo RAG, integra il tuo servizio con un database a grafi.</p>
<p>Ora, per recuperare i pezzi di documenti rilevanti, devi anche inserirli in un database vettoriale e, come parte di questo, hai bisogno anche di un database relazionale per monitorare l'utilizzo e memorizzare i dati degli utenti e la cronologia delle conversazioni.</p>
<p>Poiché gli utenti possono porre domande comuni, decidi anche di memorizzare nella cache le risposte di LLM generando diversi output in anticipo. Pertanto, integri anche un archivio di valori-chiave al tuo servizio.</p>
<p>Infine, vuoi dare agli amministratori il controllo sui prompt del sistema con la possibilità di controllarne la versione. Per questo motivo, aggiungi alla tua soluzione un sistema di gestione dei contenuti come gestore dei prompt. Tuttavia, poiché i modelli di prompt possono cambiare spesso, decidi di integrare anche un database di documenti.</p>
<p>Come puoi vedere, ogni tipo di database risolve un problema particolare nella tua complessa applicazione abilitata a RAG: uno memorizza i dati del backend e degli utenti, un altro cattura le relazioni tra i documenti, uno memorizza gli embeddings dei documenti, un altro ancora aiuta a memorizzare gli schemi flessibili dei prompt e l'ultimo ti aiuta a restituire gli output in cache.</p>
<p>Puoi vedere una visualizzazione dell'architettura dell'applicazione nella <a data-type="xref" href="#rag_graph_architecture">Figura 7-3</a> per capire come questi database possono lavorare insieme per realizzare una soluzione.</p>
<figure><div class="figure" id="rag_graph_architecture">
<img alt="bgai 0703" src="assets/bgai_0703.png" width="1396" height="1328"/>
<h6><span class="label">Figura 7-3. </span>Utilizzo congiunto di vari tipi di database</h6>
</div></figure>
<p>Ora che hai capito come i tuoi servizi GenAI possono integrarsi con diversi database, nella prossima sezione ci concentreremo sull'aggiunta di un database relazionale al tuo servizio.<a data-startref="ix_ch07-asciidoc5" data-type="indexterm" id="id933"/><a data-startref="ix_ch07-asciidoc5a" data-type="indexterm" id="id934"/><a data-startref="ix_ch07-asciidoc4" data-type="indexterm" id="id935"/><a data-startref="ix_ch07-asciidoc3" data-type="indexterm" id="id936"/></p>
</div></section>
<section data-pdf-bookmark="Project: Storing User Conversations with an LLM in a Relational Database" data-type="sect1"><div class="sect1" id="id106">
<h1>Progetto: Memorizzare le conversazioni degli utenti con un LLM in un database relazionale</h1>
<p><a data-primary="databases" data-secondary="project: storing user conversations with an LLM in a relational database" data-type="indexterm" id="ix_ch07-asciidoc6"/><a data-primary="large language models (LLMs)" data-secondary="project: storing user conversations with an LLM in a relational database" data-type="indexterm" id="ix_ch07-asciidoc7"/>Nella sezione precedente abbiamo trattato i concetti fondamentali dei database per aggiungere la persistenza dei dati alle tue applicazioni.</p>
<p>In questa sezione, integrerai un database relazionale al tuo servizio GenAI in modo da poter memorizzare le cronologie delle conversazioni degli utenti con un LLM nel database. Come parte di questo lavoro, imparerai anche le migliori pratiche, gli strumenti e il flusso di sviluppo per gestire le modifiche allo schema e le migrazioni dei dati nel tuo database.</p>
<p>Per questo progetto, installeremo un database relazionale Postgres, che è open source, gratuito e collaudato ed è utilizzato da molte aziende. Per iniziare, scarichiamo ed eseguiamo il container Postgres utilizzando <code translate="no">docker run</code>, come mostrato nell'<a data-type="xref" href="#postgres">Esempio 7-1</a>.</p>
<div data-type="example" id="postgres">
<h5><span class="label">Esempio 7-1. </span>Scarica ed esegui il contenitore del database Postgres</h5>
<pre data-type="programlisting" translate="no">$ docker run -p 5432:5432  \  <a class="co" href="#callout_integrating_databases_into_ai_services_CO1-1" id="co_integrating_databases_into_ai_services_CO1-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a> <a class="co" href="#callout_integrating_databases_into_ai_services_CO1-2" id="co_integrating_databases_into_ai_services_CO1-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a>
	-e POSTGRES_USER=fastapi \
	-e POSTGRES_PASSWORD=mysecretpassword \
	-e POSTGRES_DB=backend_db \
	-e PGDATA=/var/lib/postgresql/data \ <a class="co" href="#callout_integrating_databases_into_ai_services_CO1-3" id="co_integrating_databases_into_ai_services_CO1-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a>
    -v "$(pwd)"/dbstorage:/var/lib/postgresql/data \ <a class="co" href="#callout_integrating_databases_into_ai_services_CO1-4" id="co_integrating_databases_into_ai_services_CO1-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a>
    postgres:latest <a class="co" href="#callout_integrating_databases_into_ai_services_CO1-1" id="co_integrating_databases_into_ai_services_CO1-5"><img alt="1" src="assets/1.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO1-1" id="callout_integrating_databases_into_ai_services_CO1-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Scarica ed esegui l'ultima immagine del database relazionale <code translate="no">postgres</code> dal registro di Docker.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO1-2" id="callout_integrating_databases_into_ai_services_CO1-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Esegui l'immagine <code translate="no">postgres</code> e poi esponi e mappa la porta del container <code translate="no">5432</code> sulle stesse porte del computer host.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO1-3" id="callout_integrating_databases_into_ai_services_CO1-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Esegui il contenitore con diverse variabili ambientali che specificano il nome utente e la password predefiniti dell'amministratore del database, il nome del database e la posizione dei dati del DBMS all'interno del contenitore.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO1-4" id="callout_integrating_databases_into_ai_services_CO1-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Monta il database Postgres sul filesystem della macchina host in una cartella <code translate="no">dbstorage</code> nella directory di lavoro attuale.</p></dd>
</dl></div>
<p>Installiamo quindi i pacchetti <code translate="no">sqlalchemy</code>, <code translate="no">alembic</code> e <code translate="no">psycopg3</code>:</p>
<pre data-code-language="bash" data-type="programlisting" translate="no">$<code class="w" translate="no"> </code>pip<code class="w" translate="no"> </code>install<code class="w" translate="no"> </code>alembic<code class="w" translate="no"> </code>sqlalchemy<code class="w" translate="no"> </code>psycopg3<code class="w" translate="no"/></pre>
<p>Questi pacchetti collaudati ti permettono di comunicare direttamente con il database relazionale Postgres tramite Python.<code translate="no">psycopg3</code> è un popolare adattatore di database PostgreSQL per Python, mentre SQLAlchemy è un toolkit SQL e un ORM che ti permette di eseguire query SQL sul tuo database in Python.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id937">
<h1>Mappatori relazionali a oggetti</h1>
<p><a data-primary="databases" data-secondary="project: storing user conversations with an LLM in a relational database" data-tertiary="object relational mappers" data-type="indexterm" id="id938"/><a data-primary="large language models (LLMs)" data-secondary="project: storing user conversations with an LLM in a relational database" data-tertiary="object relational mappers" data-type="indexterm" id="id939"/><a data-primary="object relational mappers (ORM)" data-type="indexterm" id="ix_ch07-asciidoc10"/><a data-primary="ORM (object relational mappers)" data-type="indexterm" id="ix_ch07-asciidoc10a"/>Una libreria ORM ti permette di interagire con un database e di eseguire operazioni SQL senza dover scrivere da solo l'SQL.</p>
<p><a data-primary="SQLAlchemy package" data-secondary="ORM and" data-type="indexterm" id="id940"/>Il pacchetto SQLAlchemy utilizza la tecnica ORM per mappare le tabelle del database in classi orientate agli oggetti nel codice. Le tabelle sono mappate in classi, le colonne in attributi di classe e le righe in istanze di classe. Quindi, ad esempio, invece di scrivere <code translate="no">SELECT * FROM users WHERE id = 1</code>, puoi utilizzare <code translate="no">session.query(User).filter(User.id == 1).first()</code> per recuperare un utente in base al suo ID.</p>
<p>Puoi vedere i pro e i contro degli ORM nella <a data-type="xref" href="#orm_pros_cons">Tabella 7-2</a>.</p>
<table class="striped" id="orm_pros_cons">
<caption><span class="label">Tabella 7-2. </span>Pro e contro degli ORM</caption>
<thead>
<tr>
<th>Pro</th>
<th>Contro</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>Interazioni del database astratto</p></td>
<td><p>Scambia la flessibilità con l'esperienza di sviluppo</p></td>
</tr>
<tr>
<td><p>Velocizza il flusso di lavoro dello sviluppo</p></td>
<td><p>Curva di apprendimento</p></td>
</tr>
<tr>
<td><p>Migliorare la manutenibilità del codice</p></td>
<td><p>Potenziali problemi di prestazioni con query complesse rispetto alla scrittura di SQL grezzo</p></td>
</tr>
<tr>
<td><p>Sono disponibili diverse librerie (ad esempio, SQLAlchemy, SQLModel, TortoiseORM, DjangoORM).</p></td>
<td><p>Il debug può essere impegnativo</p></td>
</tr>
</tbody>
</table>
<p>Nella maggior parte dei casi, i vantaggi possono superare gli svantaggi, quindi imparare a lavorare con un ORM è una competenza preziosa per costruire i tuoi servizi GenAI che interagiscono con i database relazionali.</p>
</div></aside>
<p><a data-primary="alembic package" data-type="indexterm" id="id941"/><a data-primary="database migration tools" data-type="indexterm" id="id942"/>Infine, il pacchetto <code translate="no">alembic</code> è uno <em>strumento per la migrazione dei database</em> creato dagli sviluppatori di SQLAlchemy per essere utilizzato con SQLAlchemy. Il flusso di lavoro per la migrazione dei dati è simile al sistema di controllo delle versioni Git, ma per gli schemi del tuo database. Ti permette di gestire le modifiche e gli aggiornamenti dei tuoi schemi in modo da evitare qualsiasi corruzione dei dati, di tenere traccia delle modifiche nel tempo e di ripristinare qualsiasi modifica se necessario.</p>
<section data-pdf-bookmark="Defining ORM Models" data-type="sect2"><div class="sect2" id="id107">
<h2>Definire i modelli ORM</h2>
<p><a data-primary="databases" data-secondary="project: storing user conversations with an LLM in a relational database" data-tertiary="defining ORM models" data-type="indexterm" id="ix_ch07-asciidoc8"/><a data-primary="large language models (LLMs)" data-secondary="project: storing user conversations with an LLM in a relational database" data-tertiary="defining ORM models" data-type="indexterm" id="ix_ch07-asciidoc9"/>Il primo passo per interrogare il database in Python è quello di definire i modelli ORM con le classi SQLAlchemy, come mostrato nell'<a data-type="xref" href="#sqlalchemy_models">Esempio 7-2</a>. Puoi utilizzare gli schemi dei dati del diagramma ERD di cui alla <a data-type="xref" href="ch08.html#erd">Figura 8-4</a>.</p>
<div data-type="note" epub:type="note"><h6>Nota</h6>
<p>Aggiungerai la tabella <code translate="no">user</code> nel prossimo capitolo quando implementerai i meccanismi di autenticazione e autorizzazione.</p>
</div>
<div data-type="example" id="sqlalchemy_models">
<h5><span class="label">Esempio 7-2. </span>Definizione dei modelli ORM del database</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># entities.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">datetime</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">UTC</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">datetime</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">sqlalchemy</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">ForeignKey</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">sqlalchemy</code><code class="nn" translate="no">.</code><code class="nn" translate="no">orm</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">DeclarativeBase</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Mapped</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">mapped_column</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">relationship</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">class</code><code translate="no"> </code><code class="nc" translate="no">Base</code><code class="p" translate="no">(</code><code class="n" translate="no">DeclarativeBase</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO2-1" id="co_integrating_databases_into_ai_services_CO2-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">pass</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">class</code><code translate="no"> </code><code class="nc" translate="no">Conversation</code><code class="p" translate="no">(</code><code class="n" translate="no">Base</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO2-2" id="co_integrating_databases_into_ai_services_CO2-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">__tablename__</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">conversations</code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="nb" translate="no">id</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="nb" translate="no">int</code><code class="p" translate="no">]</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="n" translate="no">primary_key</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">title</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code><code class="p" translate="no">]</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO2-3" id="co_integrating_databases_into_ai_services_CO2-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">model_type</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code><code class="p" translate="no">]</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="n" translate="no">index</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO2-4" id="co_integrating_databases_into_ai_services_CO2-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">created_at</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="n" translate="no">datetime</code><code class="p" translate="no">]</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">updated_at</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="n" translate="no">datetime</code><code class="p" translate="no">]</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">onupdate</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO2-5" id="co_integrating_databases_into_ai_services_CO2-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">messages</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="nb" translate="no">list</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Message</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code class="p" translate="no">]</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">relationship</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">        </code><code class="s2" translate="no">"</code><code class="s2" translate="no">Message</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">back_populates</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">conversation</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">cascade</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">all, delete-orphan</code><code class="s2" translate="no">"</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO2-6" id="co_integrating_databases_into_ai_services_CO2-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">class</code><code translate="no"> </code><code class="nc" translate="no">Message</code><code class="p" translate="no">(</code><code class="n" translate="no">Base</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO2-7" id="co_integrating_databases_into_ai_services_CO2-7"><img alt="7" src="assets/7.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">__tablename__</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">messages</code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="nb" translate="no">id</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="nb" translate="no">int</code><code class="p" translate="no">]</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="n" translate="no">primary_key</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">conversation_id</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="nb" translate="no">int</code><code class="p" translate="no">]</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">ForeignKey</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">conversations.id</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">ondelete</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">CASCADE</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">index</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO2-6" id="co_integrating_databases_into_ai_services_CO2-8"><img alt="6" src="assets/6.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">prompt_content</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code><code class="p" translate="no">]</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">response_content</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="nb" translate="no">str</code><code class="p" translate="no">]</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">prompt_tokens</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="nb" translate="no">int</code><code translate="no"> </code><code class="o" translate="no">|</code><code translate="no"> </code><code class="kc" translate="no">None</code><code class="p" translate="no">]</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">response_tokens</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="nb" translate="no">int</code><code translate="no"> </code><code class="o" translate="no">|</code><code translate="no"> </code><code class="kc" translate="no">None</code><code class="p" translate="no">]</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">total_tokens</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="nb" translate="no">int</code><code translate="no"> </code><code class="o" translate="no">|</code><code translate="no"> </code><code class="kc" translate="no">None</code><code class="p" translate="no">]</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">is_success</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="nb" translate="no">bool</code><code translate="no"> </code><code class="o" translate="no">|</code><code translate="no"> </code><code class="kc" translate="no">None</code><code class="p" translate="no">]</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">status_code</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="nb" translate="no">int</code><code translate="no"> </code><code class="o" translate="no">|</code><code translate="no"> </code><code class="kc" translate="no">None</code><code class="p" translate="no">]</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO2-8" id="co_integrating_databases_into_ai_services_CO2-9"><img alt="8" src="assets/8.png" width="12" height="12"/></a><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO2-9" id="co_integrating_databases_into_ai_services_CO2-10"><img alt="9" src="assets/9.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">created_at</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="n" translate="no">datetime</code><code class="p" translate="no">]</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">updated_at</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="n" translate="no">datetime</code><code class="p" translate="no">]</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">mapped_column</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">onupdate</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">conversation</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Mapped</code><code class="p" translate="no">[</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Conversation</code><code class="s2" translate="no">"</code><code class="p" translate="no">]</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">relationship</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">        </code><code class="s2" translate="no">"</code><code class="s2" translate="no">Conversation</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">back_populates</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">messages</code><code class="s2" translate="no">"</code><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO2-1" id="callout_integrating_databases_into_ai_services_CO2-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Dichiara una classe base dichiarativa per creare modelli SQLAlchemy per il suo motore ORM.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO2-2" id="callout_integrating_databases_into_ai_services_CO2-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Crea il modello <code translate="no">Conversation</code> specificando le colonne della tabella, la chiave primaria e gli indici secondari.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO2-3" id="callout_integrating_databases_into_ai_services_CO2-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Utilizza <code translate="no">mapped_column()</code> per derivare il tipo di colonna dal suggerimento di tipo dato a <code translate="no">Mapped</code>.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO2-4" id="callout_integrating_databases_into_ai_services_CO2-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Indicizza il sito <code translate="no">model_type</code> se vuoi filtrare più velocemente le conversazioni per tipo di modello.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO2-5" id="callout_integrating_databases_into_ai_services_CO2-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a></dt>
<dd><p>Specifica i valori predefiniti e le operazioni di aggiornamento per le colonne datetime.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO2-6" id="callout_integrating_databases_into_ai_services_CO2-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a></dt>
<dd><p>Indica che tutti i messaggi orfani devono essere cancellati se una conversazione viene eliminata tramite un'operazione di <code translate="no">CASCADE DELETE</code>.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO2-7" id="callout_integrating_databases_into_ai_services_CO2-7"><img alt="7" src="assets/7.png" width="12" height="12"/></a></dt>
<dd><p>Crea il modello <code translate="no">Message</code> specificando le colonne della tabella, la chiave primaria, gli indici secondari, le relazioni della tabella e le chiavi esterne.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO2-9" id="callout_integrating_databases_into_ai_services_CO2-8"><img alt="8" src="assets/8.png" width="12" height="12"/></a></dt>
<dd><p>La tabella <code translate="no">messages</code> conterrà i prompt e le risposte del LLM, i token di utilizzo e i costi, oltre ai codici di stato e agli stati di successo.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO2-10" id="callout_integrating_databases_into_ai_services_CO2-9"><img alt="9" src="assets/9.png" width="12" height="12"/></a></dt>
<dd><p>Specifica <code translate="no">Mapped[int | None]</code> per dichiarare una tipizzazione opzionale in modo che la colonna permetta i valori di <code translate="no">NULL</code> (cioè <code translate="no">nullable=True</code>).</p></dd>
</dl></div>
<p>Una volta definiti i modelli di dati, puoi creare una connessione al database per creare ogni tabella con le configurazioni specificate. Per ottenere questo risultato, dovrai creare un <em>motore di database</em> e implementare la <em>gestione delle sessioni</em>.<a data-startref="ix_ch07-asciidoc10" data-type="indexterm" id="id943"/><a data-startref="ix_ch07-asciidoc10a" data-type="indexterm" id="id944"/><a data-startref="ix_ch07-asciidoc9" data-type="indexterm" id="id945"/><a data-startref="ix_ch07-asciidoc8" data-type="indexterm" id="id946"/></p>
</div></section>
<section data-pdf-bookmark="Creating a Database Engine and Session Management" data-type="sect2"><div class="sect2" id="id108">
<h2>Creazione di un motore di database e gestione delle sessioni</h2>
<p>L<a data-type="xref" href="#sqlalchemy_engine">'esempio 7-3</a> mostra a<a data-primary="databases" data-secondary="project: storing user conversations with an LLM in a relational database" data-tertiary="creating database engine and session management" data-type="indexterm" id="ix_ch07-asciidoc11"/><a data-primary="large language models (LLMs)" data-secondary="project: storing user conversations with an LLM in a relational database" data-tertiary="creating database engine and session management" data-type="indexterm" id="ix_ch07-asciidoc12"/><a data-primary="SQLAlchemy package" data-secondary="database engine creation" data-type="indexterm" id="ix_ch07-asciidoc13"/> come creare un motore SQLAlchemy utilizzando la stringa di connessione al database Postgres. Una volta creato, puoi utilizzare il motore e la classe <code translate="no">Base</code> per creare tabelle per ciascuno dei tuoi modelli di dati.</p>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>Il metodo <code translate="no">create_all()</code> di SQLAlchemy nell'<a data-type="xref" href="#sqlalchemy_engine">Esempio 7-3</a> può solo creare tabelle nel database ma non modificare le tabelle esistenti. Questo flusso di lavoro è utile solo se stai facendo dei prototipi e sei contento di reimpostare gli schemi del database con nuove tabelle a ogni esecuzione.</p>
<p>Per gli ambienti di produzione, dovresti utilizzare uno strumento di migrazione del database come <code translate="no">alembic</code> per aggiornare gli schemi del database ed evitare la perdita involontaria di dati. A breve scoprirai il flusso di lavoro della migrazione del database.</p>
</div>
<div data-type="example" id="sqlalchemy_engine">
<h5><span class="label">Esempio 7-3. </span>Creare il motore del database SQLAlchemy</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># database.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">sqlalchemy</code><code class="nn" translate="no">.</code><code class="nn" translate="no">ext</code><code class="nn" translate="no">.</code><code class="nn" translate="no">asyncio</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">create_async_engine</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">entities</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Base</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">database_url</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="p" translate="no">(</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO3-1" id="co_integrating_databases_into_ai_services_CO3-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="s2" translate="no">"</code><code class="s2" translate="no">postgresql+psycopg://fastapi:mysecretpassword@localhost:5432/backend_db</code><code class="s2" translate="no">"</code><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="n" translate="no">engine</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">create_async_engine</code><code class="p" translate="no">(</code><code class="n" translate="no">database_url</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">echo</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO3-2" id="co_integrating_databases_into_ai_services_CO3-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">init_db</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="kc" translate="no">None</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">with</code><code translate="no"> </code><code class="n" translate="no">engine</code><code class="o" translate="no">.</code><code class="n" translate="no">begin</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="k" translate="no">as</code><code translate="no"> </code><code class="n" translate="no">conn</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">conn</code><code class="o" translate="no">.</code><code class="n" translate="no">run_sync</code><code class="p" translate="no">(</code><code class="n" translate="no">Base</code><code class="o" translate="no">.</code><code class="n" translate="no">metadata</code><code class="o" translate="no">.</code><code class="n" translate="no">drop_all</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">conn</code><code class="o" translate="no">.</code><code class="n" translate="no">run_sync</code><code class="p" translate="no">(</code><code class="n" translate="no">Base</code><code class="o" translate="no">.</code><code class="n" translate="no">metadata</code><code class="o" translate="no">.</code><code class="n" translate="no">create_all</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO3-3" id="co_integrating_databases_into_ai_services_CO3-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">
</code><code class="c1" translate="no"># main.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">contextlib</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">asynccontextmanager</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">FastAPI</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">database</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">engine</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">init_db</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@asynccontextmanager</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">lifespan</code><code class="p" translate="no">(</code><code class="n" translate="no">_</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">FastAPI</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">init_db</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="c1" translate="no"># other startup operations within the lifespan</code><code translate="no">
</code><code translate="no">    </code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">yield</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">engine</code><code class="o" translate="no">.</code><code class="n" translate="no">dispose</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO3-4" id="co_integrating_databases_into_ai_services_CO3-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">app</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">FastAPI</code><code class="p" translate="no">(</code><code class="n" translate="no">lifespan</code><code class="o" translate="no">=</code><code class="n" translate="no">lifespan</code><code class="p" translate="no">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO3-1" id="callout_integrating_databases_into_ai_services_CO3-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Per i database Postgres, la stringa di connessione viene definita utilizzando il seguente modello: <code translate="no"><em>&lt;driver&gt;</em>://<em>&lt;username&gt;</em>:<em>&lt;password&gt;</em>@<em>&lt;origin&gt;</em>/<em>&lt;database&gt;</em></code>.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO3-2" id="callout_integrating_databases_into_ai_services_CO3-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Crea un motore di database async utilizzando la stringa di connessione al database. Attiva il debug logging con <code translate="no">echo=True</code>.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO3-3" id="callout_integrating_databases_into_ai_services_CO3-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Elimina tutte le tabelle esistenti e poi crea tutte le tabelle del database utilizzando i modelli SQLAlchemy definiti nell'<a data-type="xref" href="#sqlalchemy_engine">Esempio 7-3</a>.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO3-4" id="callout_integrating_databases_into_ai_services_CO3-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Smaltisce il motore del database durante il processo di spegnimento del server. Qualsiasi codice dopo la parola chiave <code translate="no">yield</code> all'interno del gestore del contesto <code translate="no">lifespan</code> di FastAPI viene eseguito quando viene richiesto lo spegnimento del server.</p></dd>
</dl></div>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>Per chiarezza, le variabili d'ambiente e i segreti come le stringhe di connessione al database sono codificati in ogni esempio di codice.</p>
<p>Negli scenari di produzione, non codificare mai i segreti e le variabili d'ambiente. Sfrutta i file d'ambiente, i gestori di segreti e gli strumenti come Pydantic Settings per gestire i segreti e le variabili delle applicazioni.</p>
</div>
<p>Dopo aver creato il motore, puoi implementare una funzione di fabbrica per creare sessioni al database. La fabbrica di sessioni è un modello di progettazione che ti permette di aprire, interagire e chiudere le connessioni al database nei tuoi servizi.</p>
<p>Dal momento che puoi riutilizzare una sessione, puoi usare il sistema di iniezione delle dipendenze di FastAPI per memorizzare nella cache e riutilizzare le sessioni in ogni runtime di richiesta, come mostrato nell'<a data-type="xref" href="#sqlalchemy_session">Esempio 7-4</a>.</p>
<div data-type="example" id="sqlalchemy_session">
<h5><span class="label">Esempio 7-4. </span>Creazione di una sessione di database Dipendenza FastAPI</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># database.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">typing</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">sqlalchemy</code><code class="nn" translate="no">.</code><code class="nn" translate="no">ext</code><code class="nn" translate="no">.</code><code class="nn" translate="no">asyncio</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">AsyncSession</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">async_sessionmaker</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">database</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">engine</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">async_session</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">async_sessionmaker</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">bind</code><code class="o" translate="no">=</code><code class="n" translate="no">engine</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">class_</code><code class="o" translate="no">=</code><code class="n" translate="no">AsyncSession</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">autocommit</code><code class="o" translate="no">=</code><code class="kc" translate="no">False</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">autoflush</code><code class="o" translate="no">=</code><code class="kc" translate="no">False</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO4-1" id="co_integrating_databases_into_ai_services_CO4-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">get_db_session</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO4-2" id="co_integrating_databases_into_ai_services_CO4-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">try</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">with</code><code translate="no"> </code><code class="n" translate="no">async_session</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="k" translate="no">as</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO4-3" id="co_integrating_databases_into_ai_services_CO4-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">yield</code><code translate="no"> </code><code class="n" translate="no">session</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO4-4" id="co_integrating_databases_into_ai_services_CO4-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">except</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">rollback</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO4-5" id="co_integrating_databases_into_ai_services_CO4-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">raise</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">finally</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">close</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO4-6" id="co_integrating_databases_into_ai_services_CO4-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">DBSessionDep</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="n" translate="no">AsyncSession</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">get_db_session</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO4-7" id="co_integrating_databases_into_ai_services_CO4-7"><img alt="7" src="assets/7.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO4-1" id="callout_integrating_databases_into_ai_services_CO4-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p><a data-primary="database session factory" data-type="indexterm" id="id947"/>Crea un factory di sessione di database asincrono legato al motore di database che hai creato in precedenza per connetterti in modo asincrono alla tua istanza di Postgres. Disabilita il commit automatico delle transazioni con <code translate="no">autocommit=false</code> e il flushing automatico delle modifiche al database con <code translate="no">autoflush=False</code>. Disabilitare entrambi i comportamenti ti offre un maggiore controllo, ti aiuta a prevenire aggiornamenti di dati non voluti e ti permette di implementare una gestione delle transazioni più robusta.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO4-2" id="callout_integrating_databases_into_ai_services_CO4-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Definisci una funzione di dipendenza da riutilizzare e iniettare nella tua applicazione FastAPI<span class="keep-together">nelle</span> funzioni del<span class="keep-together">route</span> controller. Poiché la funzione utilizza la parola chiave <code translate="no">yield</code> <span class="keep-together">all'interno di</span> <code translate="no">async with</code>, è considerata un gestore di contesto async. FastAPI decorerà internamente <code translate="no">get_db_session</code> come gestore di contesto quando viene utilizzata come<span class="keep-together">dipendenza</span>.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO4-3" id="callout_integrating_databases_into_ai_services_CO4-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Utilizza il factory di sessione del database per creare una sessione asincrona. Il gestore del contesto aiuta a gestire il ciclo di vita della sessione del database come l'apertura, l'interazione e la chiusura delle connessioni al database in ogni sessione.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO4-4" id="callout_integrating_databases_into_ai_services_CO4-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Restituisce la sessione del database al chiamante della funzione <code translate="no">get_db_session</code>.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO4-5" id="callout_integrating_databases_into_ai_services_CO4-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a></dt>
<dd><p>Se si verificano delle eccezioni, annulla la transazione e solleva nuovamente l'eccezione.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO4-6" id="callout_integrating_databases_into_ai_services_CO4-6"><img alt="6" src="assets/6.png" width="12" height="12"/></a></dt>
<dd><p>In ogni caso, chiudi la sessione del database alla fine per liberare le risorse che detiene.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO4-7" id="callout_integrating_databases_into_ai_services_CO4-7"><img alt="7" src="assets/7.png" width="12" height="12"/></a></dt>
<dd><p>Dichiara una dipendenza annotata della sessione del database che può essere riutilizzata da diversi controllori.</p></dd>
</dl></div>
<p>Ora che puoi creare una sessione del database da qualsiasi rotta FastAPI tramite dependency injection, implementiamo gli endpoint di creazione, lettura, aggiornamento e cancellazione (CRUD) per la risorsa conversazioni.<a data-startref="ix_ch07-asciidoc13" data-type="indexterm" id="id948"/><a data-startref="ix_ch07-asciidoc12" data-type="indexterm" id="id949"/><a data-startref="ix_ch07-asciidoc11" data-type="indexterm" id="id950"/></p>
</div></section>
<section data-pdf-bookmark="Implementing CRUD Endpoints" data-type="sect2"><div class="sect2" id="id109">
<h2>Implementare gli endpoint CRUD</h2>
<p><a data-primary="CRUD (create, read, update, and delete) endpoints" data-type="indexterm" id="ix_ch07-asciidoc15"/><a data-primary="databases" data-secondary="project: storing user conversations with an LLM in a relational database" data-tertiary="implementing CRUD endpoints" data-type="indexterm" id="ix_ch07-asciidoc16"/><a data-primary="large language models (LLMs)" data-secondary="project: storing user conversations with an LLM in a relational database" data-tertiary="implementing CRUD endpoints" data-type="indexterm" id="ix_ch07-asciidoc17"/>Poiché FastAPI si affida a Pydantic per serializzare e convalidare i dati in entrata e in uscita, prima di implementare gli endpoint CRUD dovrai mappare le entità del database nei modelli di Pydantic. In questo modo eviterai di accoppiare strettamente lo schema dell'API con i modelli del database per darti la libertà e la flessibilità di sviluppare l'API e i database in modo indipendente l'uno dall'altro.</p>
<p>Puoi seguire l'<a data-type="xref" href="#sqlalchemy_pydantic">Esempio 7-5</a> per definire i tuoi schemi CRUD.</p>
<div data-type="example" id="sqlalchemy_pydantic">
<h5><span class="label">Esempio 7-5. </span>Dichiarazione degli schemi API di Pydantic per gli endpoint di conversazione</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># schemas.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">datetime</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">datetime</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">pydantic</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">BaseModel</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">ConfigDict</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">class</code><code translate="no"> </code><code class="nc" translate="no">ConversationBase</code><code class="p" translate="no">(</code><code class="n" translate="no">BaseModel</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">model_config</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">ConfigDict</code><code class="p" translate="no">(</code><code class="n" translate="no">from_attributes</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO5-1" id="co_integrating_databases_into_ai_services_CO5-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">title</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">model_type</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">class</code><code translate="no"> </code><code class="nc" translate="no">ConversationCreate</code><code class="p" translate="no">(</code><code class="n" translate="no">ConversationBase</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO5-2" id="co_integrating_databases_into_ai_services_CO5-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">pass</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">class</code><code translate="no"> </code><code class="nc" translate="no">ConversationUpdate</code><code class="p" translate="no">(</code><code class="n" translate="no">ConversationBase</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO5-2" id="co_integrating_databases_into_ai_services_CO5-3"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">pass</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">class</code><code translate="no"> </code><code class="nc" translate="no">ConversationOut</code><code class="p" translate="no">(</code><code class="n" translate="no">ConversationBase</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO5-2" id="co_integrating_databases_into_ai_services_CO5-4"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="nb" translate="no">id</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">int</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">created_at</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">datetime</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">updated_at</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">datetime</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO5-1" id="callout_integrating_databases_into_ai_services_CO5-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Impostare il modello Pydantic per leggere e convalidare gli attributi di altri modelli come SQLAlchemy, che viene spesso utilizzato in Pydantic quando si lavora con<span class="keep-together">modelli di</span> database.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO5-2" id="callout_integrating_databases_into_ai_services_CO5-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Creare modelli Pydantic separati basati sul modello di base per diversi casi d'uso, come la creazione e l'aggiornamento dei record di conversazione o il recupero dei dati.</p></dd>
</dl></div>
<div data-type="tip"><h6>Suggerimento</h6>
<p>Dover dichiarare i modelli Pydantic e SQLAlchemy può sembrare una duplicazione del codice, ma ti permetterà di implementare il tuo livello di accesso ai dati nel modo che preferisci.</p>
<p>In alternativa, se vuoi evitare la duplicazione del codice, puoi utilizzare il pacchetto <code translate="no">sqlmodel</code>, che integra Pydantic con SQLAlchemy, eliminando gran parte della duplicazione del codice. Tuttavia, tieni presente che <code translate="no">sqlmodel</code> potrebbe non essere l'ideale per la produzione a causa della flessibilità limitata e del supporto per i casi d'uso avanzati con SQLAlchemy. Per questo motivo, potresti voler utilizzare modelli Pydantic e SQLAlchemy separati per applicazioni complesse.<sup><a data-type="noteref" href="ch07.html#id951" id="id951-marker" translate="no">1</a></sup></p>
</div>
<p>Ora che hai i modelli SQLAlchemy e Pydantic, puoi iniziare a sviluppare gli endpoint delle API CRUD.</p>
<p>Nell'implementazione degli endpoint CRUD, dovresti cercare di sfruttare il più possibile le dipendenze FastAPI per ridurre i giri del database. Ad esempio, quando recuperi, aggiorni e cancelli dei record, devi verificare con il database l'esistenza di un record utilizzando il suo ID.</p>
<p>Puoi implementare una funzione di recupero dei record per utilizzare una dipendenza tra i tuoi endpoint get, update e delete, come mostrato nell'<a data-type="xref" href="#sqlalchemy_endpoints">Esempio 7-6</a>.</p>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>Tieni presente che FastAPI può memorizzare nella cache l'output della dipendenza <code translate="no">get_conversation</code> solo all'interno di una singola richiesta e non su più richieste.</p>
</div>
<div data-type="example" id="sqlalchemy_endpoints">
<h5><span class="label">Esempio 7-6. </span>Implementazione di endpoint CRUD basati sulle risorse per la tabella <code translate="no">conversations</code> </h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># main.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">typing</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">database</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">DBSessionDep</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">entities</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Conversation</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">FastAPI</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">HTTPException</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">status</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">schemas</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">ConversationCreate</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">ConversationOut</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">ConversationUpdate</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">sqlalchemy</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">select</code><code translate="no">
</code><code translate="no">
</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">get_conversation</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">conversation_id</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">int</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">DBSessionDep</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO6-1" id="co_integrating_databases_into_ai_services_CO6-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">Conversation</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">with</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">begin</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO6-2" id="co_integrating_databases_into_ai_services_CO6-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">result</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">execute</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">select</code><code class="p" translate="no">(</code><code class="n" translate="no">Conversation</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">where</code><code class="p" translate="no">(</code><code class="n" translate="no">Conversation</code><code class="o" translate="no">.</code><code class="n" translate="no">id</code><code translate="no"> </code><code class="o" translate="no">==</code><code translate="no"> </code><code class="n" translate="no">conversation_id</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">conversation</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">result</code><code class="o" translate="no">.</code><code class="n" translate="no">scalars</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">first</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="ow" translate="no">not</code><code translate="no"> </code><code class="n" translate="no">conversation</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">raise</code><code translate="no"> </code><code class="n" translate="no">HTTPException</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="n" translate="no">status</code><code class="o" translate="no">.</code><code class="n" translate="no">HTTP_404_NOT_FOUND</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">detail</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Conversation not found</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">conversation</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">GetConversationDep</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="n" translate="no">Conversation</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">get_conversation</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@app</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/conversations</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">list_conversations_controller</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">session</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">DBSessionDep</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">skip</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">int</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="mi" translate="no">0</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">take</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">int</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="mi" translate="no">100</code><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="nb" translate="no">list</code><code class="p" translate="no">[</code><code class="n" translate="no">ConversationOut</code><code class="p" translate="no">]</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">with</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">begin</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">result</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">execute</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">select</code><code class="p" translate="no">(</code><code class="n" translate="no">Conversation</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">offset</code><code class="p" translate="no">(</code><code class="n" translate="no">skip</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">limit</code><code class="p" translate="no">(</code><code class="n" translate="no">take</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO6-3" id="co_integrating_databases_into_ai_services_CO6-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="p" translate="no">[</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">ConversationOut</code><code class="o" translate="no">.</code><code class="n" translate="no">model_validate</code><code class="p" translate="no">(</code><code class="n" translate="no">conversation</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">for</code><code translate="no"> </code><code class="n" translate="no">conversation</code><code translate="no"> </code><code class="ow" translate="no">in</code><code translate="no"> </code><code class="n" translate="no">result</code><code class="o" translate="no">.</code><code class="n" translate="no">scalars</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">all</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">]</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@app</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/conversations/</code><code class="si" translate="no">{id}</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">get_conversation_controller</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">conversation</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">GetConversationDep</code><code class="p" translate="no">,</code><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">ConversationOut</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">ConversationOut</code><code class="o" translate="no">.</code><code class="n" translate="no">model_validate</code><code class="p" translate="no">(</code><code class="n" translate="no">conversation</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO6-4" id="co_integrating_databases_into_ai_services_CO6-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@app</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/conversations</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="n" translate="no">status</code><code class="o" translate="no">.</code><code class="n" translate="no">HTTP_201_CREATED</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">create_conversation_controller</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">conversation</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">ConversationCreate</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">DBSessionDep</code><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">ConversationOut</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">new_conversation</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">Conversation</code><code class="p" translate="no">(</code><code class="o" translate="no">*</code><code class="o" translate="no">*</code><code class="n" translate="no">conversation</code><code class="o" translate="no">.</code><code class="n" translate="no">model_dump</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">with</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">begin</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">add</code><code class="p" translate="no">(</code><code class="n" translate="no">new_conversation</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">commit</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO6-5" id="co_integrating_databases_into_ai_services_CO6-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">refresh</code><code class="p" translate="no">(</code><code class="n" translate="no">new_conversation</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">ConversationOut</code><code class="o" translate="no">.</code><code class="n" translate="no">model_validate</code><code class="p" translate="no">(</code><code class="n" translate="no">new_conversation</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@app</code><code class="o" translate="no">.</code><code class="n" translate="no">put</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/conversations/</code><code class="si" translate="no">{id}</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="n" translate="no">status</code><code class="o" translate="no">.</code><code class="n" translate="no">HTTP_202_ACCEPTED</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">update_conversation_controller</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">updated_conversation</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">ConversationUpdate</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">conversation</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">GetConversationDep</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">session</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">DBSessionDep</code><code class="p" translate="no">,</code><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">ConversationOut</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">for</code><code translate="no"> </code><code class="n" translate="no">key</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">value</code><code translate="no"> </code><code class="ow" translate="no">in</code><code translate="no"> </code><code class="n" translate="no">updated_conversation</code><code class="o" translate="no">.</code><code class="n" translate="no">model_dump</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">items</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="nb" translate="no">setattr</code><code class="p" translate="no">(</code><code class="n" translate="no">conversation</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">key</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">value</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">with</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">begin</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">commit</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO6-5" id="co_integrating_databases_into_ai_services_CO6-6"><img alt="5" src="assets/5.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">refresh</code><code class="p" translate="no">(</code><code class="n" translate="no">conversation</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">ConversationOut</code><code class="o" translate="no">.</code><code class="n" translate="no">model_validate</code><code class="p" translate="no">(</code><code class="n" translate="no">conversation</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@app</code><code class="o" translate="no">.</code><code class="n" translate="no">delete</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/conversations/</code><code class="si" translate="no">{id}</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="n" translate="no">status</code><code class="o" translate="no">.</code><code class="n" translate="no">HTTP_204_NO_CONTENT</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">delete_conversation_controller</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">conversation</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">GetConversationDep</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">DBSessionDep</code><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="kc" translate="no">None</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">with</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">begin</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">delete</code><code class="p" translate="no">(</code><code class="n" translate="no">conversation</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">commit</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO6-5" id="co_integrating_databases_into_ai_services_CO6-7"><img alt="5" src="assets/5.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO6-1" id="callout_integrating_databases_into_ai_services_CO6-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Definisce una dipendenza per verificare se il record della conversazione esiste. Solleva un 404 <code translate="no">HTTPException</code> se il record non viene trovato; altrimenti, restituisce il record recuperato. Questa dipendenza può essere riutilizzata in diversi endpoint CRUD tramite dependency injection.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO6-2" id="callout_integrating_databases_into_ai_services_CO6-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Inizia la sessione asincrona all'interno di un gestore di contesto asincrono durante ogni richiesta.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO6-3" id="callout_integrating_databases_into_ai_services_CO6-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Quando si elencano i record, è più efficiente recuperare solo un sottoinsieme di record. Per impostazione predefinita, SQLAlchemy ORM restituisce un sottoinsieme dei record più recenti del database, ma puoi utilizzare i metodi concatenati <code translate="no">.offset(skip)</code> e <code translate="no">.limit(take)</code> per recuperare qualsiasi sottoinsieme di record.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO6-4" id="callout_integrating_databases_into_ai_services_CO6-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Crea un modello Pydantic da un modello SQLAlchemy utilizzando <code translate="no">model_validate()</code>. Solleva un <code translate="no">ValidationError</code> se l'oggetto SQLAlchemy passato non può essere creato o non supera i controlli di validazione dei dati di Pydantic.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO6-5" id="callout_integrating_databases_into_ai_services_CO6-5"><img alt="5" src="assets/5.png" width="12" height="12"/></a></dt>
<dd><p>Per le operazioni che modificano un record (ad esempio, creazione, aggiornamento e cancellazione), esegui il commit della transazione e invia il record aggiornato al client, ad eccezione dell'operazione di cancellazione che deve restituire <code translate="no">None</code>.</p></dd>
</dl></div>
<p>Nota come la logica del controllore viene semplificata grazie a questo approccio di dependency injection.</p>
<p>Inoltre, presta attenzione ai codici di stato di successo che devi inviare al cliente. Le operazioni di recupero riuscite dovrebbero restituire 200, mentre le operazioni di creazione dei record restituiscono 201, gli aggiornamenti 202 e le cancellazioni 204.</p>
<p>Congratulazioni! Ora hai un'API RESTful basata su risorse che puoi utilizzare per eseguire operazioni CRUD sulla tua tabella <code translate="no">conversations</code>.</p>
<p>Ora che puoi implementare gli endpoint CRUD, rifattorizziamo gli esempi di codice esistenti per utilizzare il modello di progettazione di <em>repository e servizi</em> che hai imparato nel <a data-type="xref" href="ch02.html#ch02">Capitolo 2</a>. Con questo modello di progettazione, puoi astrarre le operazioni del database per ottenere una base di codice più modulare, manutenibile e testabile.<a data-startref="ix_ch07-asciidoc17" data-type="indexterm" id="id952"/><a data-startref="ix_ch07-asciidoc16" data-type="indexterm" id="id953"/><a data-startref="ix_ch07-asciidoc15" data-type="indexterm" id="id954"/></p>
</div></section>
<section data-pdf-bookmark="Repository and Services Design Pattern" data-type="sect2"><div class="sect2" id="id110">
<h2>Pattern di progettazione di repository e servizi</h2>
<p><a data-primary="databases" data-secondary="project: storing user conversations with an LLM in a relational database" data-tertiary="repository and services design pattern" data-type="indexterm" id="ix_ch07-asciidoc18"/><a data-primary="large language models (LLMs)" data-secondary="project: storing user conversations with an LLM in a relational database" data-tertiary="repository and services design pattern" data-type="indexterm" id="ix_ch07-asciidoc19"/>Un<em>repository</em> <a data-primary="repository design pattern" data-type="indexterm" id="ix_ch07-asciidoc20"/><em/> è un modello di progettazione che media la logica di business della tua applicazione e il livello di accesso al database, ad esempio tramite un ORM. Contiene diversi metodi per eseguire operazioni CRUD nel livello del database.</p>
<p>Nel <a data-type="xref" href="ch02.html#ch02">Capitolo 2</a> hai visto per la prima volta la <a data-type="xref" href="#onion">Figura 7-4</a>, che mostrava la posizione dei repository all'interno dell'architettura applicativa a cipolla/strato quando si lavora con un database.</p>
<figure><div class="figure" id="onion">
<img alt="bgai 0704" src="assets/bgai_0704.png" width="1410" height="821"/>
<h6><span class="label">Figura 7-4. </span>Il modello di repository all'interno dell'architettura applicativa a cipolla/strato</h6>
</div></figure>
<p><a data-primary="abstract interface" data-type="indexterm" id="id955"/>Per implementare un pattern di repository, puoi utilizzare un'<em>interfaccia astratta</em>, che impone alcuni vincoli su come definire le classi specifiche del repository, come puoi vedere nell'<a data-type="xref" href="#sqlalchemy_repository">Esempio 7-7</a>.</p>
<div data-type="note" epub:type="note"><h6>Nota</h6>
<p>Se non hai mai usato le classi <em>astratte</em>, si tratta di classi che non possono essere istanziate da sole. Le classi astratte possono contenere metodi non implementati che le loro sottoclassi devono implementare.</p>
<p>Una classe concreta è una classe che eredita una classe astratta e implementa tutti i suoi metodi astratti.</p>
</div>
<div data-type="example" id="sqlalchemy_repository">
<h5><span class="label">Esempio 7-7. </span>Implementazione dell'interfaccia astratta di un repository</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># repositories/interfaces.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">abc</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">ABC</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">abstractmethod</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">typing</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Any</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">class</code><code translate="no"> </code><code class="nc" translate="no">Repository</code><code class="p" translate="no">(</code><code class="n" translate="no">ABC</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO7-1" id="co_integrating_databases_into_ai_services_CO7-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="nd" translate="no">@abstractmethod</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">list</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="nb" translate="no">list</code><code class="p" translate="no">[</code><code class="n" translate="no">Any</code><code class="p" translate="no">]</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">pass</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="nd" translate="no">@abstractmethod</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">get</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">uid</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">int</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">Any</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">pass</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="nd" translate="no">@abstractmethod</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">create</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">record</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Any</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">Any</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">pass</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="nd" translate="no">@abstractmethod</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">update</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">uid</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">int</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">record</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Any</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">Any</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">pass</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="nd" translate="no">@abstractmethod</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">delete</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">uid</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">int</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="kc" translate="no">None</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">pass</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO7-1" id="callout_integrating_databases_into_ai_services_CO7-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Definisce l'interfaccia astratta <code translate="no">Repository</code> con diverse firme di metodi astratti relativi al CRUD che le sottoclassi devono implementare. Se un metodo astratto non è implementato in una sottoclasse concreta, verrà sollevato un<code translate="no">NotImplementedError</code>.</p></dd>
</dl></div>
<p>Ora che hai una classe <code translate="no">Repository</code>, puoi dichiarare delle sottoclassi per ciascuna delle tue tabelle per definire come devono essere eseguite le operazioni sul database seguendo i metodi basati sul CRUD. Ad esempio, per eseguire le operazioni CRUD sui record di conversazione nel database, puoi implementare una classe concreta <code translate="no">ConversationRepository</code>, come mostrato nell'<a data-type="xref" href="#sqlalchemy_conversation_repository">Esempio 7-8</a>.</p>
<div data-type="example" id="sqlalchemy_conversation_repository">
<h5><span class="label">Esempio 7-8. </span>Implementazione del repository di conversazione utilizzando l'interfaccia del repository astratto</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># repositories/conversations.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">entities</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Conversation</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">repositories</code><code class="nn" translate="no">.</code><code class="nn" translate="no">interfaces</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Repository</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">schemas</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">ConversationCreate</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">ConversationUpdate</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">sqlalchemy</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">select</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">sqlalchemy</code><code class="nn" translate="no">.</code><code class="nn" translate="no">ext</code><code class="nn" translate="no">.</code><code class="nn" translate="no">asyncio</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">AsyncSession</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">class</code><code translate="no"> </code><code class="nc" translate="no">ConversationRepository</code><code class="p" translate="no">(</code><code class="n" translate="no">Repository</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO8-1" id="co_integrating_databases_into_ai_services_CO8-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="fm" translate="no">__init__</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">AsyncSession</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="kc" translate="no">None</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">session</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">list</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">skip</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">int</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">take</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">int</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="nb" translate="no">list</code><code class="p" translate="no">[</code><code class="n" translate="no">Conversation</code><code class="p" translate="no">]</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">with</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">begin</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">result</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">execute</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">                </code><code class="n" translate="no">select</code><code class="p" translate="no">(</code><code class="n" translate="no">Conversation</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">offset</code><code class="p" translate="no">(</code><code class="n" translate="no">skip</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">limit</code><code class="p" translate="no">(</code><code class="n" translate="no">take</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">            </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="p" translate="no">[</code><code class="n" translate="no">r</code><code translate="no"> </code><code class="k" translate="no">for</code><code translate="no"> </code><code class="n" translate="no">r</code><code translate="no"> </code><code class="ow" translate="no">in</code><code translate="no"> </code><code class="n" translate="no">result</code><code class="o" translate="no">.</code><code class="n" translate="no">scalars</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">all</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">get</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">conversation_id</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">int</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">Conversation</code><code translate="no"> </code><code class="o" translate="no">|</code><code translate="no"> </code><code class="kc" translate="no">None</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">with</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">begin</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">result</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">execute</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">                </code><code class="n" translate="no">select</code><code class="p" translate="no">(</code><code class="n" translate="no">Conversation</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">where</code><code class="p" translate="no">(</code><code class="n" translate="no">Conversation</code><code class="o" translate="no">.</code><code class="n" translate="no">id</code><code translate="no"> </code><code class="o" translate="no">==</code><code translate="no"> </code><code class="n" translate="no">conversation_id</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">            </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">result</code><code class="o" translate="no">.</code><code class="n" translate="no">scalars</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">first</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">create</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">conversation</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">ConversationCreate</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">Conversation</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">new_conversation</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">Conversation</code><code class="p" translate="no">(</code><code class="o" translate="no">*</code><code class="o" translate="no">*</code><code class="n" translate="no">conversation</code><code class="o" translate="no">.</code><code class="n" translate="no">model_dump</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">with</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">begin</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">add</code><code class="p" translate="no">(</code><code class="n" translate="no">new_conversation</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">commit</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">refresh</code><code class="p" translate="no">(</code><code class="n" translate="no">new_conversation</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">new_conversation</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">update</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">        </code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">conversation_id</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">int</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">updated_conversation</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">ConversationUpdate</code><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">Conversation</code><code translate="no"> </code><code class="o" translate="no">|</code><code translate="no"> </code><code class="kc" translate="no">None</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">conversation</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="n" translate="no">conversation_id</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="ow" translate="no">not</code><code translate="no"> </code><code class="n" translate="no">conversation</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="kc" translate="no">None</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">for</code><code translate="no"> </code><code class="n" translate="no">key</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">value</code><code translate="no"> </code><code class="ow" translate="no">in</code><code translate="no"> </code><code class="n" translate="no">updated_conversation</code><code class="o" translate="no">.</code><code class="n" translate="no">model_dump</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">items</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="nb" translate="no">setattr</code><code class="p" translate="no">(</code><code class="n" translate="no">conversation</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">key</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">value</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">with</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">begin</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">commit</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">refresh</code><code class="p" translate="no">(</code><code class="n" translate="no">conversation</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">conversation</code><code translate="no">
</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">delete</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">conversation_id</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">int</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="kc" translate="no">None</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">conversation</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="n" translate="no">conversation_id</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="ow" translate="no">not</code><code translate="no"> </code><code class="n" translate="no">conversation</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">return</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">with</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">begin</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">delete</code><code class="p" translate="no">(</code><code class="n" translate="no">conversation</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">            </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">commit</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO8-1" id="callout_integrating_databases_into_ai_services_CO8-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Eredita l'interfaccia astratta <code translate="no">Repository</code> e implementa tutti i suoi metodi rispettando le firme dei metodi.</p></dd>
</dl></div>
<p>Ora hai spostato la logica del database per le conversazioni all'interno di<span class="keep-together"><code translate="no">ConversationRepository</code>. Questo significa che puoi importare questa classe nelle funzioni del controller della tua rotta e iniziare a usarla subito.</span></p>
<p>Torna al file <code translate="no">main.py</code> e rifattorizza i controllori di rotta in modo che utilizzino il file<span class="keep-together"><code translate="no">ConversationRepository</code>, come mostrato nell'</span><a data-type="xref" href="#sqlalchemy_conversation_repository_endpoints">Esempio 7-9</a>.</p>
<div data-type="example" id="sqlalchemy_conversation_repository_endpoints">
<h5><span class="label">Esempio 7-9. </span>Refactoring degli endpoint CRUD delle conversazioni per utilizzare lo schema del repository</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># routers/conversations.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">typing</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">APIRouter</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">FastAPI</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">HTTPException</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">status</code><code translate="no">
</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">  </code><code class="c1" translate="no"># Other imports</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">repositories</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">ConversationRepository</code><code translate="no">
</code><code translate="no">
</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">  </code><code class="c1" translate="no"># Other controllers and dependency implementations</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">router</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">APIRouter</code><code class="p" translate="no">(</code><code class="n" translate="no">prefix</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/conversations</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO9-1" id="co_integrating_databases_into_ai_services_CO9-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">get_conversation</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">conversation_id</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">int</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">SessionDep</code><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">Conversation</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">conversation</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">ConversationRepository</code><code class="p" translate="no">(</code><code class="n" translate="no">session</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="n" translate="no">conversation_id</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO9-2" id="co_integrating_databases_into_ai_services_CO9-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">if</code><code translate="no"> </code><code class="ow" translate="no">not</code><code translate="no"> </code><code class="n" translate="no">conversation</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">raise</code><code translate="no"> </code><code class="n" translate="no">HTTPException</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="n" translate="no">status</code><code class="o" translate="no">.</code><code class="n" translate="no">HTTP_404_NOT_FOUND</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">detail</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">Conversation not found</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">conversation</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">GetConversationDep</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">Annotated</code><code class="p" translate="no">[</code><code class="n" translate="no">Conversation</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">get_conversation</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">list_conversations_controller</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">session</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">SessionDep</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">skip</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">int</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="mi" translate="no">0</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">take</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">int</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="mi" translate="no">100</code><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="nb" translate="no">list</code><code class="p" translate="no">[</code><code class="n" translate="no">ConversationOut</code><code class="p" translate="no">]</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">conversations</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">ConversationRepository</code><code class="p" translate="no">(</code><code class="n" translate="no">session</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">list</code><code class="p" translate="no">(</code><code class="n" translate="no">skip</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">take</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="p" translate="no">[</code><code class="n" translate="no">ConversationOut</code><code class="o" translate="no">.</code><code class="n" translate="no">model_validate</code><code class="p" translate="no">(</code><code class="n" translate="no">c</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="k" translate="no">for</code><code translate="no"> </code><code class="n" translate="no">c</code><code translate="no"> </code><code class="ow" translate="no">in</code><code translate="no"> </code><code class="n" translate="no">conversations</code><code class="p" translate="no">]</code><code translate="no">
</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/</code><code class="si" translate="no">{id}</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">get_conversation_controller</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">conversation</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">GetConversationDep</code><code class="p" translate="no">,</code><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">ConversationOut</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">ConversationOut</code><code class="o" translate="no">.</code><code class="n" translate="no">model_validate</code><code class="p" translate="no">(</code><code class="n" translate="no">conversation</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO9-2" id="co_integrating_databases_into_ai_services_CO9-3"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">post</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="n" translate="no">status</code><code class="o" translate="no">.</code><code class="n" translate="no">HTTP_201_CREATED</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">create_conversation_controller</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">conversation</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">ConversationCreate</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">SessionDep</code><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">ConversationOut</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">new_conversation</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">ConversationRepository</code><code class="p" translate="no">(</code><code class="n" translate="no">session</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">create</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">conversation</code><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO9-2" id="co_integrating_databases_into_ai_services_CO9-4"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">ConversationOut</code><code class="o" translate="no">.</code><code class="n" translate="no">model_validate</code><code class="p" translate="no">(</code><code class="n" translate="no">new_conversation</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">put</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/</code><code class="si" translate="no">{id}</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="n" translate="no">status</code><code class="o" translate="no">.</code><code class="n" translate="no">HTTP_202_ACCEPTED</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">update_conversation_controller</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">conversation</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">GetConversationDep</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">updated_conversation</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">ConversationUpdate</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">session</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">SessionDep</code><code class="p" translate="no">,</code><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">ConversationOut</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">updated_conversation</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">ConversationRepository</code><code class="p" translate="no">(</code><code class="n" translate="no">session</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">update</code><code class="p" translate="no">(</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO9-2" id="co_integrating_databases_into_ai_services_CO9-5"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">conversation</code><code class="o" translate="no">.</code><code class="n" translate="no">id</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">updated_conversation</code><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">ConversationOut</code><code class="o" translate="no">.</code><code class="n" translate="no">model_validate</code><code class="p" translate="no">(</code><code class="n" translate="no">updated_conversation</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">delete</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/</code><code class="si" translate="no">{id}</code><code class="s2" translate="no">"</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">status_code</code><code class="o" translate="no">=</code><code class="n" translate="no">status</code><code class="o" translate="no">.</code><code class="n" translate="no">HTTP_204_NO_CONTENT</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">delete_conversation_controller</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">conversation</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">GetConversationDep</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">session</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">SessionDep</code><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="kc" translate="no">None</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">ConversationRepository</code><code class="p" translate="no">(</code><code class="n" translate="no">session</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">delete</code><code class="p" translate="no">(</code><code class="n" translate="no">conversation</code><code class="o" translate="no">.</code><code class="n" translate="no">id</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code translate="no">
</code><code class="c1" translate="no"># main.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">routers</code><code class="nn" translate="no">.</code><code class="nn" translate="no">conversations</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">router</code><code translate="no"> </code><code class="k" translate="no">as</code><code translate="no"> </code><code class="n" translate="no">conversations_router</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">app</code><code class="o" translate="no">.</code><code class="n" translate="no">include_router</code><code class="p" translate="no">(</code><code class="n" translate="no">conversations_router</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO9-1" id="co_integrating_databases_into_ai_services_CO9-6"><img alt="1" src="assets/1.png" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO9-1" id="callout_integrating_databases_into_ai_services_CO9-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Posiziona le rotte CRUD di conversazione su un router API separato e includile nell'applicazione FastAPI per un design API modulare.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO9-2" id="callout_integrating_databases_into_ai_services_CO9-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Refactoring delle rotte CRUD di conversazione per utilizzare lo schema del repository per rendere più leggibile l'implementazione del controller.</p></dd>
</dl></div>
<p>Hai notato come i tuoi route controller appaiono più puliti ora che la logica del database è stata astratta all'interno della classe <code translate="no">ConversationRepository</code>?<a data-startref="ix_ch07-asciidoc20" data-type="indexterm" id="id956"/></p>
<p><a data-primary="service pattern" data-type="indexterm" id="ix_ch07-asciidoc21"/>Un pattern di <em>servizio</em> è un'estensione del pattern di repository che incapsula la logica di business e le operazioni in un livello superiore. Queste operazioni di livello superiore spesso richiedono query più complesse e una sequenza di operazioni CRUD da eseguire per implementare la logica di business.</p>
<p class="less_space pagebreak-before">Ad esempio, puoi implementare un <code translate="no">ConversationService</code> per recuperare i messaggi relativi a una conversazione o a un utente specifico (vedi <a data-type="xref" href="#sqlalchemy_conversation_service">Esempio 7-10</a>). Poiché estende un<span class="keep-together"><code translate="no">ConversationRepository</code>, puoi comunque accedere ai metodi CRUD di accesso ai dati di livello inferiore come</span> <code translate="no">list</code>, <code translate="no">get</code>, <code translate="no">create</code>, <code translate="no">update</code> e<code translate="no">delete</code>.</p>
<p>Ancora una volta puoi tornare ai tuoi controllori e sostituire i riferimenti al sito  con i riferimenti al sito .<span class="keep-together"><code translate="no">ConversationRepository</code></span> con quello di<code translate="no">ConversationService</code>. Inoltre, puoi utilizzare lo stesso servizio per aggiungere un nuovo endpoint per recuperare i messaggi all'interno di una singola<span class="keep-together">conversazione.</span></p>
<div data-type="example" id="sqlalchemy_conversation_service">
<h5><span class="label">Esempio 7-10. </span>Implementazione del pattern dei servizi di conversazione</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># services/conversations.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">entities</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Message</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">repositories</code><code class="nn" translate="no">.</code><code class="nn" translate="no">conversations</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">ConversationRepository</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">sqlalchemy</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">select</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">class</code><code translate="no"> </code><code class="nc" translate="no">ConversationService</code><code class="p" translate="no">(</code><code class="n" translate="no">ConversationRepository</code><code class="p" translate="no">)</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">list_messages</code><code class="p" translate="no">(</code><code class="bp" translate="no">self</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">conversation_id</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">int</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="nb" translate="no">list</code><code class="p" translate="no">[</code><code class="n" translate="no">Message</code><code class="p" translate="no">]</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">result</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="bp" translate="no">self</code><code class="o" translate="no">.</code><code class="n" translate="no">session</code><code class="o" translate="no">.</code><code class="n" translate="no">execute</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">            </code><code class="n" translate="no">select</code><code class="p" translate="no">(</code><code class="n" translate="no">Message</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">where</code><code class="p" translate="no">(</code><code class="n" translate="no">Message</code><code class="o" translate="no">.</code><code class="n" translate="no">conversation_id</code><code translate="no"> </code><code class="o" translate="no">==</code><code translate="no"> </code><code class="n" translate="no">conversation_id</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">        </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="p" translate="no">[</code><code class="n" translate="no">m</code><code translate="no"> </code><code class="k" translate="no">for</code><code translate="no"> </code><code class="n" translate="no">m</code><code translate="no"> </code><code class="ow" translate="no">in</code><code translate="no"> </code><code class="n" translate="no">result</code><code class="o" translate="no">.</code><code class="n" translate="no">scalars</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">all</code><code class="p" translate="no">(</code><code class="p" translate="no">)</code><code class="p" translate="no">]</code><code translate="no">
</code><code translate="no">
</code><code class="c1" translate="no"># routers/conversations.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">database</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">DBSessionDep</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">entities</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Message</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">APIRouter</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">schemas</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">MessageOut</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">services</code><code class="nn" translate="no">.</code><code class="nn" translate="no">conversations</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">ConversationService</code><code translate="no">
</code><code translate="no">
</code><code class="n" translate="no">router</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">APIRouter</code><code class="p" translate="no">(</code><code class="n" translate="no">prefix</code><code class="o" translate="no">=</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/conversations</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@router</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/</code><code class="si" translate="no">{conversation_id}</code><code class="s2" translate="no">/messages</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO10-1" id="co_integrating_databases_into_ai_services_CO10-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">list_conversation_messages_controller</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">conversation</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">GetConversationDep</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">session</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">DBSessionDep</code><code class="p" translate="no">,</code><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="nb" translate="no">list</code><code class="p" translate="no">[</code><code class="n" translate="no">Message</code><code class="p" translate="no">]</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">messages</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">ConversationService</code><code class="p" translate="no">(</code><code class="n" translate="no">session</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">list_messages</code><code class="p" translate="no">(</code><code class="n" translate="no">conversation</code><code class="o" translate="no">.</code><code class="n" translate="no">id</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="p" translate="no">[</code><code class="n" translate="no">MessageOut</code><code class="o" translate="no">.</code><code class="n" translate="no">model_validate</code><code class="p" translate="no">(</code><code class="n" translate="no">m</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="k" translate="no">for</code><code translate="no"> </code><code class="n" translate="no">m</code><code translate="no"> </code><code class="ow" translate="no">in</code><code translate="no"> </code><code class="n" translate="no">messages</code><code class="p" translate="no">]</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO10-1" id="callout_integrating_databases_into_ai_services_CO10-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Aggiungi un nuovo endpoint per elencare i messaggi di una conversazione utilizzando l'ID della conversazione.</p></dd>
</dl></div>
<p>Ora hai un'API RESTful perfettamente funzionante per interagire con i dati delle tue conversazioni seguendo i modelli di repository e di servizio.</p>
<div data-type="tip"><h6>Suggerimento</h6>
<p>Ora che hai una maggiore familiarità con il modello di repository e servizi, puoi provare a implementare gli endpoint CRUD per la tabella <code translate="no">messages</code>.</p>
</div>
<p>Quando utilizzi i modelli di repository e di servizio, fai attenzione a non accoppiare strettamente i tuoi servizi a specifiche implementazioni del repository e a non sovraccaricare i tuoi servizi con molte responsabilità. Mantieni i repository focalizzati sull'accesso e la manipolazione dei dati ed evita di inserire la logica di business.</p>
<p>Dovrai anche gestire correttamente le transazioni e le eccezioni del database, soprattutto quando si eseguono più operazioni correlate. Inoltre, considera le implicazioni sulle prestazioni delle tue query, come ad esempio l'inclusione di molte JOIN, e ottimizza le query dove è possibile.</p>
<p>È buona norma utilizzare convenzioni di denominazione coerenti per i metodi e le classi ed evitare di codificare le impostazioni di configurazione<a data-startref="ix_ch07-asciidoc21" data-type="indexterm" id="id957"/>.<a data-startref="ix_ch07-asciidoc19" data-type="indexterm" id="id958"/><a data-startref="ix_ch07-asciidoc18" data-type="indexterm" id="id959"/></p>
<p>C'è un altro aspetto del flusso di lavoro dello sviluppo dei database che dobbiamo affrontare: la gestione di schemi di database in continua evoluzione, in particolare nei team collaborativi in cui più persone lavorano sullo stesso database sia in ambienti di sviluppo che di produzione.<a data-startref="ix_ch07-asciidoc7" data-type="indexterm" id="id960"/><a data-startref="ix_ch07-asciidoc6" data-type="indexterm" id="id961"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Managing Database Schemas Changes" data-type="sect1"><div class="sect1" id="id111">
<h1>Gestione delle modifiche agli schemi di database</h1>
<p><a data-primary="alembic package" data-type="indexterm" id="ix_ch07-asciidoc22"/><a data-primary="databases" data-secondary="managing schema changes" data-type="indexterm" id="ix_ch07-asciidoc23"/>Avrai notato che nell'<a data-type="xref" href="#sqlalchemy_engine">Esempio 7-3</a> stai cancellando e ricreando le tabelle del database ogni volta che avvii il server FastAPI. Questo è accettabile per i flussi di lavoro di sviluppo durante la fase di prototipazione, ma non lo è affatto quando devi distribuire i tuoi servizi in produzione con utenti attivi. Non puoi resettare il database da zero ogni volta che aggiorni lo schema del database.</p>
<p>Inoltre, probabilmente avrai bisogno di un modo per ripristinare le modifiche se qualcosa si rompe o se decidi di fare un rollback di alcune funzionalità. Per ottenere questo risultato, puoi utilizzare uno strumento di migrazione del database come Alembic, progettato per funzionare perfettamente con l'ORM SQLAlchemy.</p>
<p>Alembic ti permette di controllare la versione degli schemi del tuo database nello stesso modo in cui strumenti come Git ti aiutano a controllare la versione del tuo codice. Sono estremamente utili quando lavori in un team con più ambienti applicativi e hai bisogno di tenere traccia delle modifiche o di ripristinare gli aggiornamenti se necessario.</p>
<p>Per iniziare, devi prima installare <code translate="no">alembic</code> tramite <code translate="no">pip</code> e poi inizializzarlo eseguendo l'<a data-type="xref" href="#alembic_init">Esempio 7-11</a> nella root del tuo progetto FastAPI.</p>
<div data-type="example" id="alembic_init">
<h5><span class="label">Esempio 7-11. </span>Inizializzazione di un ambiente Alembic</h5>
<pre data-code-language="text" data-type="programlisting" translate="no">$ alembic init</pre></div>
<p>Alembic creerà il suo ambiente all'interno della cartella <code translate="no">alembic</code> con diversi file e una cartella <code translate="no">versions</code>, come mostrato nell'<a data-type="xref" href="#alembic_dir">Esempio 7-12</a>.</p>
<div data-type="example" id="alembic_dir">
<h5><span class="label">Esempio 7-12. </span>Ambiente Alembic nella directory principale del progetto</h5>
<pre data-code-language="text" data-type="programlisting" translate="no"><code translate="no">project/
    alembic.ini
    alembic/
        env.py </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO11-1" id="co_integrating_databases_into_ai_services_CO11-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
        README
        script.py.mako
        versions/ </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO11-2" id="co_integrating_databases_into_ai_services_CO11-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
            &lt;migration .py files will appear here&gt;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO11-1" id="callout_integrating_databases_into_ai_services_CO11-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Un file di ambiente per specificare lo schema di destinazione e le connessioni al database</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO11-2" id="callout_integrating_databases_into_ai_services_CO11-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Una directory per contenere i file <em>di migrazione</em>, che specificano le istruzioni su come aggiornare o ripristinare lo schema del database.</p></dd>
</dl></div>
<p>Una volta generato l'ambiente Alembic, apri e modifica il file <em>env.py</em> che si trova nella directory <code translate="no">alembic</code>, come mostrato nell'<a data-type="xref" href="#alembic_env">Esempio 7-13</a>, in modo da ottenere l'accesso all'oggetto metadati SQLAlchemy che contiene le informazioni sullo schema di destinazione.</p>
<div data-type="example" id="alembic_env">
<h5><span class="label">Esempio 7-13. </span>Collegare l'ambiente Alembic con i modelli SQLAlchemy</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># alembic/env.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">entities</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Base</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">settings</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">AppSettings</code>

<code class="n" translate="no">settings</code> <code class="o" translate="no">=</code> <code class="n" translate="no">AppSettings</code><code class="p" translate="no">()</code>
<code class="n" translate="no">target_metadata</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Base</code>
<code class="n" translate="no">db_url</code> <code class="o" translate="no">=</code> <code class="nb" translate="no">str</code><code class="p" translate="no">(</code><code class="n" translate="no">settings</code><code class="o" translate="no">.</code><code class="n" translate="no">pg_dsn</code><code class="p" translate="no">)</code>

<code class="o" translate="no">...</code></pre></div>
<p>Con Alembic collegato ai tuoi modelli SQLAlchemy, Alembic può ora generare automaticamente i file di migrazione confrontando lo schema attuale del tuo database con i tuoi modelli SQLAlchemy:</p>
<pre data-code-language="bash" data-type="programlisting" translate="no">$<code class="w" translate="no"> </code>alembic<code class="w" translate="no"> </code>revision<code class="w" translate="no"> </code>--autogenerate<code class="w" translate="no"> </code>-m<code class="w" translate="no"> </code><code class="s2" translate="no">"Initial Migration"</code><code class="w" translate="no"/></pre>
<p>Questo comando confronta i modelli SQLAlchemy definiti con lo schema del database esistente e genera automaticamente un file di migrazione SQL nella directory<span class="keep-together"><code translate="no">alembic/versions</code></span> nella directory</p>
<p>Se apri il file di migrazione generato, dovresti vedere un contenuto del file simile all'<a data-type="xref" href="#alembic_initial_migration">Esempio 7-14</a>.</p>
<div data-type="example" id="alembic_initial_migration">
<h5><span class="label">Esempio 7-14. </span>La migrazione iniziale di Alembic</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># alembic/versions/24c35f32b152.py</code>

<code class="kn" translate="no">from</code> <code class="nn" translate="no">datetime</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">UTC</code><code class="p" translate="no">,</code> <code class="n" translate="no">datetime</code>
<code class="kn" translate="no">import</code> <code class="nn" translate="no">sqlalchemy</code> <code class="k" translate="no">as</code> <code class="nn" translate="no">sa</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">alembic</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">op</code>

<code class="sd" translate="no">"""</code>
<code class="sd" translate="no">Revision ID: 2413cf32b712 Revises:</code>
<code class="sd" translate="no">Create Date: 2024-07-11 12:30:17.089406</code>
<code class="sd" translate="no">"""</code>

<code class="c1" translate="no"># revision identifiers, used by Alembic.</code>
<code class="n" translate="no">revision</code> <code class="o" translate="no">=</code> <code class="s2" translate="no">"24c35f32b152"</code>
<code class="n" translate="no">down_revision</code> <code class="o" translate="no">=</code> <code class="kc" translate="no">None</code>
<code class="n" translate="no">branch_labels</code> <code class="o" translate="no">=</code> <code class="kc" translate="no">None</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">upgrade</code><code class="p" translate="no">():</code>
    <code class="n" translate="no">op</code><code class="o" translate="no">.</code><code class="n" translate="no">create_table</code><code class="p" translate="no">(</code>
        <code class="s2" translate="no">"conversations"</code><code class="p" translate="no">,</code>
        <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"id"</code><code class="p" translate="no">,</code> <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">BigInteger</code><code class="p" translate="no">,</code> <code class="n" translate="no">primary_key</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">),</code>
        <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"title"</code><code class="p" translate="no">,</code> <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">String</code><code class="p" translate="no">,</code> <code class="n" translate="no">nullable</code><code class="o" translate="no">=</code><code class="kc" translate="no">False</code><code class="p" translate="no">),</code>
        <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"model_type"</code><code class="p" translate="no">,</code> <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">String</code><code class="p" translate="no">,</code> <code class="n" translate="no">index</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">,</code> <code class="n" translate="no">nullable</code><code class="o" translate="no">=</code><code class="kc" translate="no">False</code><code class="p" translate="no">),</code>
        <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code>
            <code class="s2" translate="no">"created_at"</code><code class="p" translate="no">,</code> <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">DateTime</code><code class="p" translate="no">,</code> <code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">),</code> <code class="n" translate="no">nullable</code><code class="o" translate="no">=</code><code class="kc" translate="no">False</code>
        <code class="p" translate="no">),</code>
        <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code>
            <code class="s2" translate="no">"updated_at"</code><code class="p" translate="no">,</code>
            <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">DateTime</code><code class="p" translate="no">,</code>
            <code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">),</code>
            <code class="n" translate="no">onupdate</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">),</code>
            <code class="n" translate="no">nullable</code><code class="o" translate="no">=</code><code class="kc" translate="no">False</code><code class="p" translate="no">,</code>
        <code class="p" translate="no">),</code>
    <code class="p" translate="no">)</code>

    <code class="n" translate="no">op</code><code class="o" translate="no">.</code><code class="n" translate="no">create_table</code><code class="p" translate="no">(</code>
        <code class="s2" translate="no">"messages"</code><code class="p" translate="no">,</code>
        <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"id"</code><code class="p" translate="no">,</code> <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">BigInteger</code><code class="p" translate="no">,</code> <code class="n" translate="no">primary_key</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">),</code>
        <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code>
            <code class="s2" translate="no">"conversation_id"</code><code class="p" translate="no">,</code>
            <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">BigInteger</code><code class="p" translate="no">,</code>
            <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">ForeignKey</code><code class="p" translate="no">(</code><code class="s2" translate="no">"conversations.id"</code><code class="p" translate="no">,</code> <code class="n" translate="no">ondelete</code><code class="o" translate="no">=</code><code class="s2" translate="no">"CASCADE"</code><code class="p" translate="no">),</code>
            <code class="n" translate="no">index</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">,</code>
            <code class="n" translate="no">nullable</code><code class="o" translate="no">=</code><code class="kc" translate="no">False</code><code class="p" translate="no">,</code>
        <code class="p" translate="no">),</code>
        <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"prompt_content"</code><code class="p" translate="no">,</code> <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Text</code><code class="p" translate="no">,</code> <code class="n" translate="no">nullable</code><code class="o" translate="no">=</code><code class="kc" translate="no">False</code><code class="p" translate="no">),</code>
        <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"response_content"</code><code class="p" translate="no">,</code> <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Text</code><code class="p" translate="no">,</code> <code class="n" translate="no">nullable</code><code class="o" translate="no">=</code><code class="kc" translate="no">False</code><code class="p" translate="no">),</code>
        <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"prompt_tokens"</code><code class="p" translate="no">,</code> <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Integer</code><code class="p" translate="no">,</code> <code class="n" translate="no">nullable</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">),</code>
        <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"response_tokens"</code><code class="p" translate="no">,</code> <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Integer</code><code class="p" translate="no">,</code> <code class="n" translate="no">nullable</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">),</code>
        <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"total_tokens"</code><code class="p" translate="no">,</code> <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Integer</code><code class="p" translate="no">,</code> <code class="n" translate="no">nullable</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">),</code>
        <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"is_success"</code><code class="p" translate="no">,</code> <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Boolean</code><code class="p" translate="no">,</code> <code class="n" translate="no">nullable</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">),</code>
        <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code><code class="s2" translate="no">"status_code"</code><code class="p" translate="no">,</code> <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Integer</code><code class="p" translate="no">,</code> <code class="n" translate="no">nullable</code><code class="o" translate="no">=</code><code class="kc" translate="no">True</code><code class="p" translate="no">),</code>
        <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code>
            <code class="s2" translate="no">"created_at"</code><code class="p" translate="no">,</code> <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">DateTime</code><code class="p" translate="no">,</code> <code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">),</code> <code class="n" translate="no">nullable</code><code class="o" translate="no">=</code><code class="kc" translate="no">False</code>
        <code class="p" translate="no">),</code>
        <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">Column</code><code class="p" translate="no">(</code>
            <code class="s2" translate="no">"updated_at"</code><code class="p" translate="no">,</code>
            <code class="n" translate="no">sa</code><code class="o" translate="no">.</code><code class="n" translate="no">DateTime</code><code class="p" translate="no">,</code>
            <code class="n" translate="no">default</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">),</code>
            <code class="n" translate="no">onupdate</code><code class="o" translate="no">=</code><code class="n" translate="no">datetime</code><code class="o" translate="no">.</code><code class="n" translate="no">now</code><code class="p" translate="no">(</code><code class="n" translate="no">UTC</code><code class="p" translate="no">),</code>
            <code class="n" translate="no">nullable</code><code class="o" translate="no">=</code><code class="kc" translate="no">False</code><code class="p" translate="no">,</code>
        <code class="p" translate="no">),</code>
    <code class="p" translate="no">)</code>

<code class="k" translate="no">def</code> <code class="nf" translate="no">downgrade</code><code class="p" translate="no">():</code>
    <code class="n" translate="no">op</code><code class="o" translate="no">.</code><code class="n" translate="no">drop_table</code><code class="p" translate="no">(</code><code class="s2" translate="no">"messages"</code><code class="p" translate="no">)</code>
    <code class="n" translate="no">op</code><code class="o" translate="no">.</code><code class="n" translate="no">drop_table</code><code class="p" translate="no">(</code><code class="s2" translate="no">"conversations"</code><code class="p" translate="no">)</code></pre></div>
<p>Ora che hai aggiornato il tuo primo file di migrazione, sei pronto per eseguirlo sul database:</p>
<pre data-code-language="bash" data-type="programlisting" translate="no">$<code class="w" translate="no"> </code>alembic<code class="w" translate="no"> </code>upgrade<code class="w" translate="no"> </code>head<code class="w" translate="no"/></pre>
<p>Se hai bisogno di ripristinare l'operazione, puoi eseguire <code translate="no">alembic downgrade</code>.</p>
<p>Alembic genera l'SQL grezzo necessario per eseguire o ripristinare una migrazione e crea una tabella<code translate="no">alembic_versions</code> nel database. Utilizza questa tabella per tenere traccia delle migrazioni già applicate al database, in modo che eseguendo nuovamente il comando <code translate="no">alembic upgrade head</code> non vengano eseguite migrazioni duplicate.</p>
<p>Se in ogni caso gli schemi del database e la cronologia della migrazione si allontanano, puoi sempre rimuovere i file dalla directory <code translate="no">versions</code> e troncare la tabella<code translate="no">alembic_revision</code>. Poi reinizializza Alembic per iniziare con un ambiente nuovo e un database esistente.</p>
<div data-type="warning" epub:type="warning"><h6>Avvertenze</h6>
<p>Dopo aver migrato un database con un file di migrazione, assicurati di eseguire il commit in un repository Git. Evita di modificare nuovamente i file di migrazione dopo aver migrato un database, poiché Alembic salterà le migrazioni esistenti effettuando un controllo incrociato con la sua tabella di versioning.</p>
<p>Se un file di migrazione è già stato eseguito, non rileverà le modifiche al suo contenuto.</p>
<p>Per aggiornare lo schema del database, crea invece un nuovo file di migrazione.</p>
</div>
<p>Seguendo il flusso di lavoro sopra descritto, non solo potrai controllare la versione degli schemi del tuo database, ma potrai anche gestire le modifiche agli ambienti di produzione in base ai cambiamenti dei requisiti dell'applicazione.<a data-startref="ix_ch07-asciidoc23" data-type="indexterm" id="id962"/><a data-startref="ix_ch07-asciidoc22" data-type="indexterm" id="id963"/></p>
</div></section>
<section data-pdf-bookmark="Storing Data When Working with Real-Time Streams" data-type="sect1"><div class="sect1" id="id112">
<h1>Memorizzare i dati quando si lavora con gli stream in tempo reale</h1>
<p><a data-primary="databases" data-secondary="storing data when working with real-time streams" data-type="indexterm" id="ix_ch07-asciidoc24"/>Ora dovresti essere in grado di implementare i tuoi endpoint CRUD per recuperare e modificare i record delle conversazioni e dei messaggi degli utenti nel tuo database.</p>
<p>Una domanda che rimane senza risposta è come gestire le transazioni all'interno degli endpoint di streaming dei dati, come ad esempio un LLM che trasmette gli output a un client.</p>
<p>Non puoi inviare i dati in streaming a un database relazionale tradizionale, perché garantire la conformità ACID con le transazioni in streaming sarà un'impresa ardua. Al contrario, vorrai eseguire le operazioni standard sul database non appena il server FastAPI restituisce una risposta al client. Questa sfida è esattamente ciò che un'attività in background di FastAPI può risolvere, come puoi vedere nell'<a data-type="xref" href="#db_stream">Esempio 7-15</a>.</p>
<div data-type="example" id="db_stream">
<h5><span class="label">Esempio 7-15. </span>Memorizzazione del contenuto di un flusso di output LLM</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="c1" translate="no"># main.py</code><code translate="no">
</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">itertools</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">tee</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">database</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">DBSessionDep</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">entities</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Message</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">BackgroundTasks</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">fastapi</code><code class="nn" translate="no">.</code><code class="nn" translate="no">responses</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">StreamingResponse</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">repositories</code><code class="nn" translate="no">.</code><code class="nn" translate="no">conversations</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">Conversation</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">repositories</code><code class="nn" translate="no">.</code><code class="nn" translate="no">messages</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">MessageRepository</code><code translate="no">
</code><code class="kn" translate="no">from</code><code translate="no"> </code><code class="nn" translate="no">sqlalchemy</code><code class="nn" translate="no">.</code><code class="nn" translate="no">ext</code><code class="nn" translate="no">.</code><code class="nn" translate="no">asyncio</code><code translate="no"> </code><code class="kn" translate="no">import</code><code translate="no"> </code><code class="n" translate="no">AsyncSession</code><code translate="no">
</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">store_message</code><code class="p" translate="no">(</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO12-1" id="co_integrating_databases_into_ai_services_CO12-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">prompt_content</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">response_content</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">conversation_id</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">int</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">session</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">AsyncSession</code><code class="p" translate="no">,</code><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="kc" translate="no">None</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">message</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">Message</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">conversation_id</code><code class="o" translate="no">=</code><code class="n" translate="no">conversation_id</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">prompt_content</code><code class="o" translate="no">=</code><code class="n" translate="no">prompt_content</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">response_content</code><code class="o" translate="no">=</code><code class="n" translate="no">response_content</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">await</code><code translate="no"> </code><code class="n" translate="no">MessageRepository</code><code class="p" translate="no">(</code><code class="n" translate="no">session</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">create</code><code class="p" translate="no">(</code><code class="n" translate="no">message</code><code class="p" translate="no">)</code><code translate="no">
</code><code translate="no">
</code><code class="nd" translate="no">@app</code><code class="o" translate="no">.</code><code class="n" translate="no">get</code><code class="p" translate="no">(</code><code class="s2" translate="no">"</code><code class="s2" translate="no">/text/generate/stream</code><code class="s2" translate="no">"</code><code class="p" translate="no">)</code><code translate="no">
</code><code class="k" translate="no">async</code><code translate="no"> </code><code class="k" translate="no">def</code><code translate="no"> </code><code class="nf" translate="no">stream_llm_controller</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">prompt</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="nb" translate="no">str</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">background_task</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">BackgroundTasks</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">session</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">DBSessionDep</code><code class="p" translate="no">,</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">conversation</code><code class="p" translate="no">:</code><code translate="no"> </code><code class="n" translate="no">Conversation</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">Depends</code><code class="p" translate="no">(</code><code class="n" translate="no">get_conversation</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO12-2" id="co_integrating_databases_into_ai_services_CO12-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a><code translate="no">
</code><code class="p" translate="no">)</code><code translate="no"> </code><code class="o" translate="no">-</code><code class="o" translate="no">&gt;</code><code translate="no"> </code><code class="n" translate="no">StreamingResponse</code><code class="p" translate="no">:</code><code translate="no">
</code><code translate="no">    </code><code class="c1" translate="no"># Invoke LLM and obtain the response stream</code><code translate="no">
</code><code translate="no">    </code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code class="o" translate="no">.</code><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">stream_1</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">stream_2</code><code translate="no"> </code><code class="o" translate="no">=</code><code translate="no"> </code><code class="n" translate="no">tee</code><code class="p" translate="no">(</code><code class="n" translate="no">response_stream</code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO12-3" id="co_integrating_databases_into_ai_services_CO12-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="n" translate="no">background_task</code><code class="o" translate="no">.</code><code class="n" translate="no">add_task</code><code class="p" translate="no">(</code><code translate="no">
</code><code translate="no">        </code><code class="n" translate="no">store_message</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">prompt</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="s2" translate="no">"</code><code class="s2" translate="no">"</code><code class="o" translate="no">.</code><code class="n" translate="no">join</code><code class="p" translate="no">(</code><code class="n" translate="no">stream_1</code><code class="p" translate="no">)</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">conversation</code><code class="o" translate="no">.</code><code class="n" translate="no">id</code><code class="p" translate="no">,</code><code translate="no"> </code><code class="n" translate="no">session</code><code translate="no">
</code><code translate="no">    </code><code class="p" translate="no">)</code><code translate="no"> </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO12-4" id="co_integrating_databases_into_ai_services_CO12-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a><code translate="no">
</code><code translate="no">    </code><code class="k" translate="no">return</code><code translate="no"> </code><code class="n" translate="no">StreamingResponse</code><code class="p" translate="no">(</code><code class="n" translate="no">stream_2</code><code class="p" translate="no">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO12-1" id="callout_integrating_databases_into_ai_services_CO12-1"><img alt="1" src="assets/1.png" width="12" height="12"/></a></dt>
<dd><p>Crea una funzione per memorizzare un messaggio rispetto a una conversazione.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO12-2" id="callout_integrating_databases_into_ai_services_CO12-2"><img alt="2" src="assets/2.png" width="12" height="12"/></a></dt>
<dd><p>Controlla che il record della conversazione esista e lo recupera all'interno di una dipendenza.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO12-3" id="callout_integrating_databases_into_ai_services_CO12-3"><img alt="3" src="assets/3.png" width="12" height="12"/></a></dt>
<dd><p>Crea due copie separate del flusso LLM, una per il sito <code translate="no">StreamingResponse</code> e un'altra da elaborare in un'attività in background.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO12-4" id="callout_integrating_databases_into_ai_services_CO12-4"><img alt="4" src="assets/4.png" width="12" height="12"/></a></dt>
<dd><p>Crea un'attività in background per memorizzare il messaggio al termine di <code translate="no">StreamingResponse</code>.</p></dd>
</dl></div>
<p>Nell'<a data-type="xref" href="#db_stream">Esempio 7-15</a>, permetti a FastAPI di trasmettere completamente la risposta LLM al client.</p>
<p>Non importa se stai utilizzando un endpoint SSE o WebSocket. Una volta che la richiesta e la risposta sono state inviate in streaming, richiama un'attività in background passando il contenuto completo della risposta in streaming. All'interno dell'attività in background, puoi eseguire una funzione per memorizzare il messaggio dopo l'invio della richiesta, con il contenuto completo della risposta LLM.</p>
<p>Utilizzando lo stesso approccio, puoi anche generare un titolo per una conversazione in base al contenuto del primo messaggio. A tal fine, puoi invocare nuovamente il LLM con il contenuto del primo messaggio della conversazione, richiedendo un titolo appropriato per la conversazione. Una volta generato il titolo della conversazione, puoi creare il record della conversazione nel database, come mostrato nell'<a data-type="xref" href="#conversation_title">Esempio 7-16</a>.</p>
<div data-type="example" id="conversation_title">
<h5><span class="label">Esempio 7-16. </span>Utilizzo del LLM per generare titoli di conversazione basati sul prompt iniziale dell'utente</h5>
<pre data-code-language="python" data-type="programlisting" translate="no"><code class="kn" translate="no">from</code> <code class="nn" translate="no">entities</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">Conversation</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">openai</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">AsyncClient</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">repositories.conversations</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">ConversationRepository</code>
<code class="kn" translate="no">from</code> <code class="nn" translate="no">sqlalchemy.ext.asyncio</code> <code class="kn" translate="no">import</code> <code class="n" translate="no">AsyncSession</code>

<code class="n" translate="no">async_client</code> <code class="o" translate="no">=</code> <code class="n" translate="no">AsyncClient</code><code class="p" translate="no">(</code><code class="o" translate="no">...</code><code class="p" translate="no">)</code>

<code class="k" translate="no">async</code> <code class="k" translate="no">def</code> <code class="nf" translate="no">create_conversation</code><code class="p" translate="no">(</code>
    <code class="n" translate="no">initial_prompt</code><code class="p" translate="no">:</code> <code class="nb" translate="no">str</code><code class="p" translate="no">,</code> <code class="n" translate="no">session</code><code class="p" translate="no">:</code> <code class="n" translate="no">AsyncSession</code>
<code class="p" translate="no">)</code> <code class="o" translate="no">-&gt;</code> <code class="n" translate="no">Conversation</code><code class="p" translate="no">:</code>
    <code class="n" translate="no">completion</code> <code class="o" translate="no">=</code> <code class="k" translate="no">await</code> <code class="n" translate="no">async_client</code><code class="o" translate="no">.</code><code class="n" translate="no">chat</code><code class="o" translate="no">.</code><code class="n" translate="no">completions</code><code class="o" translate="no">.</code><code class="n" translate="no">create</code><code class="p" translate="no">(</code>
        <code class="n" translate="no">messages</code><code class="o" translate="no">=</code><code class="p" translate="no">[</code>
            <code class="p" translate="no">{</code>
                <code class="s2" translate="no">"role"</code><code class="p" translate="no">:</code> <code class="s2" translate="no">"system"</code><code class="p" translate="no">,</code>
                <code class="s2" translate="no">"content"</code><code class="p" translate="no">:</code> <code class="s2" translate="no">"Suggest a title for the conversation "</code>
                           <code class="s2" translate="no">"based on the user prompt"</code><code class="p" translate="no">,</code>
            <code class="p" translate="no">},</code>
            <code class="p" translate="no">{</code>
                <code class="s2" translate="no">"role"</code><code class="p" translate="no">:</code> <code class="s2" translate="no">"user"</code><code class="p" translate="no">,</code>
                <code class="s2" translate="no">"content"</code><code class="p" translate="no">:</code> <code class="n" translate="no">initial_prompt</code><code class="p" translate="no">,</code>
            <code class="p" translate="no">},</code>
        <code class="p" translate="no">],</code>
        <code class="n" translate="no">model</code><code class="o" translate="no">=</code><code class="s2" translate="no">"gpt-3.5-turbo"</code><code class="p" translate="no">,</code>
    <code class="p" translate="no">)</code>
    <code class="n" translate="no">title</code> <code class="o" translate="no">=</code> <code class="n" translate="no">completion</code><code class="o" translate="no">.</code><code class="n" translate="no">choices</code><code class="p" translate="no">[</code><code class="mi" translate="no">0</code><code class="p" translate="no">]</code><code class="o" translate="no">.</code><code class="n" translate="no">message</code><code class="o" translate="no">.</code><code class="n" translate="no">content</code>
    <code class="n" translate="no">conversation</code> <code class="o" translate="no">=</code> <code class="n" translate="no">Conversation</code><code class="p" translate="no">(</code>
        <code class="n" translate="no">title</code><code class="o" translate="no">=</code><code class="n" translate="no">title</code><code class="p" translate="no">,</code>
        <code class="c1" translate="no"># add other conversation properties</code>
        <code class="o" translate="no">...</code>
    <code class="p" translate="no">)</code>
    <code class="k" translate="no">return</code> <code class="k" translate="no">await</code> <code class="n" translate="no">ConversationRepository</code><code class="p" translate="no">(</code><code class="n" translate="no">session</code><code class="p" translate="no">)</code><code class="o" translate="no">.</code><code class="n" translate="no">create</code><code class="p" translate="no">(</code><code class="n" translate="no">conversation</code><code class="p" translate="no">)</code></pre></div>
<p>L'uso di SQLAlchemy con Alembic è un approccio collaudato per lavorare con i database relazionali in FastAPI, quindi è più probabile che troverai molte risorse sull'integrazione di queste tecnologie.</p>
<p>Sia l'ORM SQLAlchemy che Alembic ti permettono di interagire con il tuo database e di controllare le modifiche ai suoi schemi.<a data-startref="ix_ch07-asciidoc24" data-type="indexterm" id="id964"/></p>
</div></section>
<section class="less_space pagebreak-before" data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="id113">
<h1>Riassunto</h1>
<p>In questo capitolo hai approfondito gli aspetti critici dell'integrazione di un database nella tua applicazione FastAPI per memorizzare e recuperare le conversazioni degli utenti.</p>
<p>Hai imparato a capire quando è necessario un database e come identificare il tipo appropriato per il tuo progetto, sia esso relazionale o non relazionale. Comprendendo i meccanismi alla base dei database relazionali e i casi d'uso dei database non relazionali, sei ora in grado di prendere decisioni informate sulla scelta del database.</p>
<p>Hai anche esplorato il flusso di sviluppo, gli strumenti e le migliori pratiche per lavorare con i database relazionali, imparando tecniche per migliorare le prestazioni e l'efficienza delle query e strategie per gestire le modifiche allo schema del database. Inoltre, hai acquisito conoscenze sulla gestione della base di codice, dello schema del database e delle derive dei dati quando lavori in team.<a data-startref="ix_ch07-asciidoc1" data-type="indexterm" id="id965"/><a data-startref="ix_ch07-asciidoc0" data-type="indexterm" id="id966"/></p>
<p>Il prossimo capitolo ti guiderà nell'implementazione della gestione degli utenti, dell'autenticazione e dei meccanismi di autorizzazione, per migliorare ulteriormente la sicurezza della tua applicazione e l'esperienza degli utenti, partendo dalle solide basi del database che hai creato in questo capitolo.</p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="id951"><sup><a href="ch07.html#id951-marker">1</a></sup> Fai riferimento a questo <a href="https://oreil.ly/OMaOT">thread di discussione su Reddit</a>.</p></div></div></section></div></div></body></html>
<html><head></head><body><section data-pdf-bookmark="Chapter 7. Integrating Databases into AI Services" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch07">
<h1><span class="label">Chapter 7. </span>Integrating Databases into AI Services</h1>

<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id930">
<h1>Chapter Goals</h1>
<p><a data-primary="databases" data-type="indexterm" id="ix_ch07-asciidoc0"/><a data-primary="databases" data-secondary="integrating into AI services" data-type="indexterm" id="ix_ch07-asciidoc1"/>In this chapter, you will learn about:</p>

<ul>
<li>
<p>When a database is necessary and how to identify the appropriate database type for your project</p>
</li>
<li>
<p>The underlying mechanism of relational databases and the use cases of nonrelational databases</p>
</li>
<li>
<p>The development workflow, tooling, and best practices for working with relational databases</p>
</li>
<li>
<p>The techniques to improve query performance and efficiency when working with databases</p>
</li>
<li>
<p>How to manage ever-evolving database schema changes</p>
</li>
<li>
<p>Strategies for managing the codebase, the database schema, and data drifts when working in teams</p>
</li>
</ul>
</div></aside>

<p>In this chapter, you’ll integrate a database to your current API service to store and retrieve user interactions.</p>

<p>This chapter assumes basic experience working with databases and Structured Query Language (SQL), so it won’t cover every aspect of SQL programming and database workflows.
Instead, you will learn the higher-level database concepts, development workflows, and best practices when integrating databases to your FastAPI applications that interact with GenAI models such as LLMs.</p>

<p class="less_space pagebreak-before">As part of this, you will learn the role of relational (SQL) versus nonrelational (noSQL) databases in application development and will be able to confidently select the right database for your use case.
Next, you will understand more about the features of relational databases and associated tooling such as object relational mappers (ORMs) and database migration tools.
Finally, as a hands-on exercise, you will integrate a database to your existing application using SQLAlchemy and Alembic, to store and retrieve user conversations with an LLM.</p>

<p>By the end of this chapter, you will feel more confident in selecting, configuring, and resolving database-related issues within your GenAI applications.</p>






<section data-pdf-bookmark="The Role of a Database" data-type="sect1"><div class="sect1" id="id104">
<h1>The Role of a Database</h1>

<p><a data-primary="databases" data-secondary="role of" data-type="indexterm" id="ix_ch07-asciidoc2"/>When building backend services, you often require a database to persist application state and store user data.
In other cases, your application won’t need a database, and you shouldn’t try to add one since any database integration can significantly increase the complexity of your services.</p>

<p>Here<a data-primary="databases" data-secondary="cases in which databases are not needed" data-type="indexterm" id="id931"/> are several cases for which you could forgo using a database:</p>
<ol>
<li>
<p>Your application can start from a fresh state on startup for each new user session.</p>
</li>
<li>
<p>Recalculating the application data is straightforward and resource-efficient.</p>
</li>
<li>
<p>The application data is small enough to be stored in memory.</p>
</li>
<li>
<p>Your application is tolerant to data losses due to various reasons such as server errors, restarts, or other unexpected events.</p>
</li>
<li>
<p>Different user sessions or application instances won’t need to share data.</p>
</li>
<li>
<p>The data you need can directly be fetched from external systems, GenAI models, and other application APIs, and not your own database.</p>
</li>
<li>
<p>The user is happy to wait for data to be recomputed for each new session or action.</p>
</li>
<li>
<p>Your service requirements allow for the data to be persisted in files on disk, the browser storage, or an external cloud storage instead of a database.
With these alternatives, your services can tolerate that data storage and retrieval won’t be as reliable and efficient as a database.</p>
</li>
<li>
<p>You’re building a proof-of-concept and need to avoid project delays or complexity at all costs.</p>
</li>

</ol>

<p class="less_space pagebreak-before">An example application that matches the previous criteria is a <em>GenAI image generator</em> only used for demonstration purposes.</p>

<p>In this example, you won’t need to store any generated images, and you can always restart or use the application at any time from a fresh state.
Additionally, the application doesn’t need to know who the user is.
Plus, there is no need to share data between sessions.
Furthermore, if there is a server error, the impact of data loss is minimal since you can regenerate a new image on the fly.</p>

<p>As you can see, there are at least a handful of cases where you won’t need a database to build your own GenAI services.
However, you may be wondering when you do really need a database.</p>
<p class="fix_tracking">
To determine when a database is necessary, you will want to understand the role of databases.
In short, you can use them to store, organize, and manage data in an efficient format allowing for easy retrieval, manipulation, and analysis.
Additionally, databases ship with critical features such as restore/backup, concurrent access management, indexing, caching, and role-based access control, alongside many others, that make them an irreplaceable component of any services that displays, produces and consumes data.</p>

<p>In the next section, we will examine in significant detail the inner workings of databases, with an emphasis on relational databases that practical examples of this chapter will focus on.
With a detailed understanding of database internals, you can then design fully optimized and production-ready GenAI APIs.
This will then allow you to delegate heavy workloads to the database engine, which is specifically designed for data-heavy tasks.<a data-startref="ix_ch07-asciidoc2" data-type="indexterm" id="id932"/></p>
</div></section>






<section data-pdf-bookmark="Database Systems" data-type="sect1"><div class="sect1" id="id105">
<h1>Database Systems</h1>

<p><a data-primary="databases" data-secondary="types of database systems" data-type="indexterm" id="ix_ch07-asciidoc3"/><a data-primary="nonrelational (NoSQL) databases" data-type="indexterm" id="ix_ch07-asciidoc4"/><a data-primary="relational (SQL) databases" data-type="indexterm" id="ix_ch07-asciidoc5"/><a data-primary="SQL (relational) databases" data-type="indexterm" id="ix_ch07-asciidoc5a"/>Now that you understand when to leverage a database, let’s learn more about different databases you can use and how they work.</p>

<p>You can construct a mental model of databases by placing them into two main categories:
<em>relational</em> (SQL) and <em>nonrelational</em> (NoSQL) databases.</p>

<p>The <em>SQL</em> versus <em>NoSQL</em> categorization is based on the fact that relational databases use various dialects of SQL as their main query language, whereas nonrelational databases often come packaged with their own specialized query languages.</p>

<p>With both categories of database systems, you can adopt a mental model of how such systems are structured.
Both SQL and NoSQL database systems often consist of the following:</p>

<ul class="less_space pagebreak-before">
<li>
<p>A <em>server</em> at the highest level, which hosts the entire database infrastructure and consumes system resources (CPU, RAM, and storage).</p>
</li>
<li>
<p>One or more <em>databases</em> within the server, which act as <em>logical container(s)</em> that hold related data.</p>
</li>
<li>
<p>One or more <em>schemas</em> within a database (depending on the database software), which serve as a <em>blueprint</em> that defines the complete structure of the data and various structural objects such as indexes, logical constraints, triggers, etc.
However, NoSQL database servers may not use strict schemas, unlike relational databases.</p>
</li>
<li>
<p>Zero or more <em>tables</em> (SQL) or <em>collections</em> (NoSQL) created inside the database (as part of a schema), which group related data.</p>
</li>
<li>
<p>Zero or more <em>items</em> within each collection (as documents) or table (as rows), which represent specific records or entities.</p>
</li>
</ul>

<p><a data-type="xref" href="#database_server_breakdown">Figure 7-1</a> visualizes the aforementioned breakdown.</p>

<figure><div class="figure" id="database_server_breakdown">
<img alt="bgai 0701" src="assets/bgai_0701.png"/>
<h6><span class="label">Figure 7-1. </span>Database system breakdown</h6>
</div></figure>

<p class="less_space pagebreak-before">Adopting a mental model as shown in <a data-type="xref" href="#database_server_breakdown">Figure 7-1</a> will help you navigate the ever-increasing variety of database systems as you can expect similar underlying mechanisms to be present.
This familiarity will hopefully reduce your learning curve in adopting different database systems.</p>

<p>Next, let’s briefly review both SQL and NoSQL database systems so that you have a better understanding of their use cases, features, and limitations when building APIs and services.</p>

<p>To help you with creating a mental model of both relational and nonrelational databases, take a look at <a data-type="xref" href="#db_types">Figure 7-2</a>.</p>

<figure><div class="figure" id="db_types">
<img alt="bgai 0702" src="assets/bgai_0702.png"/>
<h6><span class="label">Figure 7-2. </span>Database types</h6>
</div></figure>

<p>You can also use the summary in <a data-type="xref" href="#db_comparison">Table 7-1</a> as a reference of the database types that will be covered in this chapter.</p>
<table class="striped less_space pagebreak-before" id="db_comparison">
<caption><span class="label">Table 7-1. </span>Comparison of databases</caption>
<thead>
<tr>
<th>Type</th>
<th>Data model</th>
<th>Examples</th>
<th>Use cases</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>Key-value stores</p></td>
<td><p>Key-value pairs</p></td>
<td><p>Redis, DynamoDB, Memcached</p></td>
<td><p>Caching, session management</p></td>
</tr>
<tr>
<td><p>Graph stores</p></td>
<td><p>Nodes and edges</p></td>
<td><p>Neo4j, Amazon Neptune, ArangoDB</p></td>
<td><p>Social networks, recommendation engines, fraud detection</p></td>
</tr>
<tr>
<td><p>Document stores</p></td>
<td><p>Documents</p></td>
<td><p>MongoDB, CouchDB, Amazon DocumentDB</p></td>
<td><p>Content management, e-commerce, real-time analytics</p></td>
</tr>
<tr>
<td><p>Vector stores</p></td>
<td><p>High-dimensional vectors</p></td>
<td><p>Pinecone, Weaviate</p></td>
<td><p>Recommendation systems, image/text search, ML model storage</p></td>
</tr>
<tr>
<td><p>Wide-column family stores</p></td>
<td><p>Tables with rows and columns</p></td>
<td><p>Apache Cassandra, HBase, ScyllaDB</p></td>
<td><p>Time-series data, real-time analytics, logging</p></td>
</tr>
</tbody>
</table>

<p>Now that you have a broad overview of every common relational and nonrelational database, you can visualize a real-world GenAI service that makes use of these databases together.</p>

<p>Imagine you’re building a RAG-enabled LLM service that can talk to a knowledge base.
The documents in this knowledge base are related to each other, so you decide to implement a RAG graph to capture a richer context.
To implement a RAG graph, you integrate your service with a graph-based database.</p>

<p>Now, to retrieve relevant chunks of documents, you also need to embed them in a vector database.
As part of this, you also need a relational database to monitor usage, and store user data and conversation histories.</p>

<p>Since the users may ask common questions, you also decide to cache the LLM responses by generating several outputs in advance.
Therefore, you also integrate a key-value store to your service.</p>

<p>Finally, you want to give administrators control over system prompts with the ability to version-control prompts.
So, you add a content management system as a prompt manager to your solution.
However, since the prompt templates can often change, you also decide to integrate a document database.</p>

<p>As you can see, each database type ends up solving a particular problem in your complex RAG-enabled application.
One stores your backend and user data, another captures the document relationships, one stores your document embeddings, another helps store flexible schemas of your prompts, and the last one helps you to return cached outputs.</p>

<p>You can see a visualization of the application architecture in <a data-type="xref" href="#rag_graph_architecture">Figure 7-3</a> to understand how these databases can work together to realize a solution.</p>

<figure><div class="figure" id="rag_graph_architecture">
<img alt="bgai 0703" src="assets/bgai_0703.png"/>
<h6><span class="label">Figure 7-3. </span>Using various database types together</h6>
</div></figure>

<p>Now that you understand how your GenAI services can integrate with a variety of databases, in the next section, we will focus on adding a relational database to your service.<a data-startref="ix_ch07-asciidoc5" data-type="indexterm" id="id933"/><a data-startref="ix_ch07-asciidoc5a" data-type="indexterm" id="id934"/><a data-startref="ix_ch07-asciidoc4" data-type="indexterm" id="id935"/><a data-startref="ix_ch07-asciidoc3" data-type="indexterm" id="id936"/></p>
</div></section>






<section data-pdf-bookmark="Project: Storing User Conversations with an LLM in a Relational Database" data-type="sect1"><div class="sect1" id="id106">
<h1>Project: Storing User Conversations with an LLM in a Relational Database</h1>

<p><a data-primary="databases" data-secondary="project: storing user conversations with an LLM in a relational database" data-type="indexterm" id="ix_ch07-asciidoc6"/><a data-primary="large language models (LLMs)" data-secondary="project: storing user conversations with an LLM in a relational database" data-type="indexterm" id="ix_ch07-asciidoc7"/>In the previous section, we covered the core database concepts relevant to adding data persistence to your applications.</p>

<p>In this section, you will integrate a relational database to your GenAI service so that you can store user conversation histories with an LLM in the database.
As part of this work, you will also learn the best practices, tooling, and development workflow to manage schema changes and data migrations in your database.</p>

<p>For this project, we will install a Postgres relational database that is open source, free, and battle-tested and is in use by many enterprises.
To get started, let’s download and run the Postgres container using <code>docker run</code>, as shown in <a data-type="xref" href="#postgres">Example 7-1</a>.</p>
<div data-type="example" id="postgres">
<h5><span class="label">Example 7-1. </span>Download and run the Postgres database container</h5>

<pre data-type="programlisting">$ docker run -p 5432:5432  \  <a class="co" href="#callout_integrating_databases_into_ai_services_CO1-1" id="co_integrating_databases_into_ai_services_CO1-1"><img alt="1" src="assets/1.png"/></a> <a class="co" href="#callout_integrating_databases_into_ai_services_CO1-2" id="co_integrating_databases_into_ai_services_CO1-2"><img alt="2" src="assets/2.png"/></a>
	-e POSTGRES_USER=fastapi \
	-e POSTGRES_PASSWORD=mysecretpassword \
	-e POSTGRES_DB=backend_db \
	-e PGDATA=/var/lib/postgresql/data \ <a class="co" href="#callout_integrating_databases_into_ai_services_CO1-3" id="co_integrating_databases_into_ai_services_CO1-3"><img alt="3" src="assets/3.png"/></a>
    -v "$(pwd)"/dbstorage:/var/lib/postgresql/data \ <a class="co" href="#callout_integrating_databases_into_ai_services_CO1-4" id="co_integrating_databases_into_ai_services_CO1-4"><img alt="4" src="assets/4.png"/></a>
    postgres:latest <a class="co" href="#callout_integrating_databases_into_ai_services_CO1-1" id="co_integrating_databases_into_ai_services_CO1-5"><img alt="1" src="assets/1.png"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO1-1" id="callout_integrating_databases_into_ai_services_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Download and run the latest <code>postgres</code> relational database image from in the Docker registry.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO1-2" id="callout_integrating_databases_into_ai_services_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Run the <code>postgres</code> image and then expose and map container port <code>5432</code> to the same ports on the host machine.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO1-3" id="callout_integrating_databases_into_ai_services_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Run the container with several environmental variables that specify the default database administrator username and password, database name, and DBMS data location within the container.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO1-4" id="callout_integrating_databases_into_ai_services_CO1-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Mount the Postgres database storage to the host machine filesystem at a <code>dbstorage</code> folder in the present working directory.</p></dd>
</dl></div>

<p>Next, let’s install the <code>sqlalchemy</code>, <code>alembic</code>, and <code>psycopg3</code> packages:</p>

<pre data-code-language="bash" data-type="programlisting">$ pip install alembic sqlalchemy psycopg3<code class="w"/></pre>

<p>These battle-tested packages allow you to directly communicate with the Postgres relational database via Python.
<code>psycopg3</code> is a popular PostgreSQL database adapter for Python, and SQLAlchemy is SQL toolkit and ORM that allows you to run SQL queries against your database in Python.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id937">
<h1>Object Relational Mappers</h1>
<p><a data-primary="databases" data-secondary="project: storing user conversations with an LLM in a relational database" data-tertiary="object relational mappers" data-type="indexterm" id="id938"/><a data-primary="large language models (LLMs)" data-secondary="project: storing user conversations with an LLM in a relational database" data-tertiary="object relational mappers" data-type="indexterm" id="id939"/><a data-primary="object relational mappers (ORM)" data-type="indexterm" id="ix_ch07-asciidoc10"/><a data-primary="ORM (object relational mappers)" data-type="indexterm" id="ix_ch07-asciidoc10a"/>An ORM library allows you to interact with a database and execute SQL operations without then need to write raw SQL yourself.</p>

<p><a data-primary="SQLAlchemy package" data-secondary="ORM and" data-type="indexterm" id="id940"/>The SQLAlchemy package uses the ORM technique to map database tables to object-oriented classes in code.
Tables are mapped to classes, columns to class attributes, and rows as class instances.
So, as an example, instead of writing <code>SELECT * FROM users WHERE id = 1</code>, you can use <code>session.query(User).filter(User.id == 1).first()</code> to fetch a user based on their ID.</p>

<p>You can see the pros and cons of ORMs in <a data-type="xref" href="#orm_pros_cons">Table 7-2</a>.</p>
<table class="striped" id="orm_pros_cons">
<caption><span class="label">Table 7-2. </span>Pros and cons of ORMs</caption>
<thead>
<tr>
<th>Pros</th>
<th>Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>Abstract database interactions</p></td>
<td><p>Trade flexibility for development experience</p></td>
</tr>
<tr>
<td><p>Speed up development workflow</p></td>
<td><p>Learning curve</p></td>
</tr>
<tr>
<td><p>Improve code maintainability</p></td>
<td><p>Potential performance issues with complex queries compared to writing raw SQL</p></td>
</tr>
<tr>
<td><p>Various libraries available (e.g., SQLAlchemy, SQLModel, TortoiseORM, DjangoORM)</p></td>
<td><p>Debugging can be challenging</p></td>
</tr>
</tbody>
</table>

<p>In most cases, the benefits may outweigh the drawbacks, so learning to work with an ORM is an invaluable skill in building your own GenAI services that interact with relational databases.</p>
</div></aside>

<p><a data-primary="alembic package" data-type="indexterm" id="id941"/><a data-primary="database migration tools" data-type="indexterm" id="id942"/>Lastly, the <code>alembic</code> package is a <em>database migration tool</em> created by the SQLAlchemy developers for usage with the SQLAlchemy.
The data migration workflow is like the Git version control system but for your database schemas.
It allows you to manage the changes and updates to your schemas so that you avoid any data corruptions, track changes over time, and revert any changes as required.</p>








<section data-pdf-bookmark="Defining ORM Models" data-type="sect2"><div class="sect2" id="id107">
<h2>Defining ORM Models</h2>

<p><a data-primary="databases" data-secondary="project: storing user conversations with an LLM in a relational database" data-tertiary="defining ORM models" data-type="indexterm" id="ix_ch07-asciidoc8"/><a data-primary="large language models (LLMs)" data-secondary="project: storing user conversations with an LLM in a relational database" data-tertiary="defining ORM models" data-type="indexterm" id="ix_ch07-asciidoc9"/>The first step to query your database in Python is to define your ORM models with SQLAlchemy classes, as shown in <a data-type="xref" href="#sqlalchemy_models">Example 7-2</a>.
You can use the data schemas from the ERD diagram mentioned in <a data-type="xref" href="ch08.html#erd">Figure 8-4</a>.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>You will add the <code>user</code> table in the next chapter when implementing authentication and authorization mechanisms.</p>
</div>
<div data-type="example" id="sqlalchemy_models">
<h5><span class="label">Example 7-2. </span>Defining database ORM models</h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># entities.py</code>

<code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">UTC</code><code class="p">,</code> <code class="n">datetime</code>
<code class="kn">from</code> <code class="nn">sqlalchemy</code> <code class="kn">import</code> <code class="n">ForeignKey</code>
<code class="kn">from</code> <code class="nn">sqlalchemy</code><code class="nn">.</code><code class="nn">orm</code> <code class="kn">import</code> <code class="n">DeclarativeBase</code><code class="p">,</code> <code class="n">Mapped</code><code class="p">,</code> <code class="n">mapped_column</code><code class="p">,</code> <code class="n">relationship</code>

<code class="k">class</code> <code class="nc">Base</code><code class="p">(</code><code class="n">DeclarativeBase</code><code class="p">)</code><code class="p">:</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO2-1" id="co_integrating_databases_into_ai_services_CO2-1"><img alt="1" src="assets/1.png"/></a>
    <code class="k">pass</code>

<code class="k">class</code> <code class="nc">Conversation</code><code class="p">(</code><code class="n">Base</code><code class="p">)</code><code class="p">:</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO2-2" id="co_integrating_databases_into_ai_services_CO2-2"><img alt="2" src="assets/2.png"/></a>
    <code class="n">__tablename__</code> <code class="o">=</code> <code class="s2">"</code><code class="s2">conversations</code><code class="s2">"</code>

    <code class="nb">id</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="nb">int</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="n">primary_key</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>
    <code class="n">title</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="nb">str</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO2-3" id="co_integrating_databases_into_ai_services_CO2-3"><img alt="3" src="assets/3.png"/></a>
    <code class="n">model_type</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="nb">str</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="n">index</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO2-4" id="co_integrating_databases_into_ai_services_CO2-4"><img alt="4" src="assets/4.png"/></a>
    <code class="n">created_at</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="n">datetime</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="n">default</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">)</code><code class="p">)</code>
    <code class="n">updated_at</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="n">datetime</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code>
        <code class="n">default</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">)</code><code class="p">,</code> <code class="n">onupdate</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO2-5" id="co_integrating_databases_into_ai_services_CO2-5"><img alt="5" src="assets/5.png"/></a>
    <code class="p">)</code>

    <code class="n">messages</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="nb">list</code><code class="p">[</code><code class="s2">"</code><code class="s2">Message</code><code class="s2">"</code><code class="p">]</code><code class="p">]</code> <code class="o">=</code> <code class="n">relationship</code><code class="p">(</code>
        <code class="s2">"</code><code class="s2">Message</code><code class="s2">"</code><code class="p">,</code> <code class="n">back_populates</code><code class="o">=</code><code class="s2">"</code><code class="s2">conversation</code><code class="s2">"</code><code class="p">,</code> <code class="n">cascade</code><code class="o">=</code><code class="s2">"</code><code class="s2">all, delete-orphan</code><code class="s2">"</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO2-6" id="co_integrating_databases_into_ai_services_CO2-6"><img alt="6" src="assets/6.png"/></a>
    <code class="p">)</code>


<code class="k">class</code> <code class="nc">Message</code><code class="p">(</code><code class="n">Base</code><code class="p">)</code><code class="p">:</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO2-7" id="co_integrating_databases_into_ai_services_CO2-7"><img alt="7" src="assets/7.png"/></a>
    <code class="n">__tablename__</code> <code class="o">=</code> <code class="s2">"</code><code class="s2">messages</code><code class="s2">"</code>

    <code class="nb">id</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="nb">int</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="n">primary_key</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>
    <code class="n">conversation_id</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="nb">int</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code>
        <code class="n">ForeignKey</code><code class="p">(</code><code class="s2">"</code><code class="s2">conversations.id</code><code class="s2">"</code><code class="p">,</code> <code class="n">ondelete</code><code class="o">=</code><code class="s2">"</code><code class="s2">CASCADE</code><code class="s2">"</code><code class="p">)</code><code class="p">,</code> <code class="n">index</code><code class="o">=</code><code class="kc">True</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO2-6" id="co_integrating_databases_into_ai_services_CO2-8"><img alt="6" src="assets/6.png"/></a>
    <code class="p">)</code>
    <code class="n">prompt_content</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="nb">str</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="p">)</code>
    <code class="n">response_content</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="nb">str</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="p">)</code>
    <code class="n">prompt_tokens</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="nb">int</code> <code class="o">|</code> <code class="kc">None</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="p">)</code>
    <code class="n">response_tokens</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="nb">int</code> <code class="o">|</code> <code class="kc">None</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="p">)</code>
    <code class="n">total_tokens</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="nb">int</code> <code class="o">|</code> <code class="kc">None</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="p">)</code>
    <code class="n">is_success</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="nb">bool</code> <code class="o">|</code> <code class="kc">None</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="p">)</code>
    <code class="n">status_code</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="nb">int</code> <code class="o">|</code> <code class="kc">None</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO2-8" id="co_integrating_databases_into_ai_services_CO2-9"><img alt="8" src="assets/8.png"/></a> <a class="co" href="#callout_integrating_databases_into_ai_services_CO2-9" id="co_integrating_databases_into_ai_services_CO2-10"><img alt="9" src="assets/9.png"/></a>
    <code class="n">created_at</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="n">datetime</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code><code class="n">default</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">)</code><code class="p">)</code>
    <code class="n">updated_at</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="n">datetime</code><code class="p">]</code> <code class="o">=</code> <code class="n">mapped_column</code><code class="p">(</code>
        <code class="n">default</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">)</code><code class="p">,</code> <code class="n">onupdate</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">)</code>
    <code class="p">)</code>

    <code class="n">conversation</code><code class="p">:</code> <code class="n">Mapped</code><code class="p">[</code><code class="s2">"</code><code class="s2">Conversation</code><code class="s2">"</code><code class="p">]</code> <code class="o">=</code> <code class="n">relationship</code><code class="p">(</code>
        <code class="s2">"</code><code class="s2">Conversation</code><code class="s2">"</code><code class="p">,</code> <code class="n">back_populates</code><code class="o">=</code><code class="s2">"</code><code class="s2">messages</code><code class="s2">"</code>
    <code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO2-1" id="callout_integrating_databases_into_ai_services_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Declare a declarative base class for creating SQLAlchemy models for its ORM engine.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO2-2" id="callout_integrating_databases_into_ai_services_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Create the <code>Conversation</code> model specifying the table columns, primary key, and secondary indexes.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO2-3" id="callout_integrating_databases_into_ai_services_CO2-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Use the <code>mapped_column()</code> to derive the column type from the type hint given to <code>Mapped</code>.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO2-4" id="callout_integrating_databases_into_ai_services_CO2-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Index the <code>model_type</code> in case you want faster filtering of conversations by model type.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO2-5" id="callout_integrating_databases_into_ai_services_CO2-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>Specify defaults and update operations for datetime columns.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO2-6" id="callout_integrating_databases_into_ai_services_CO2-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>Indicate that all orphan messages must be deleted if a conversation is deleted through a <code>CASCADE DELETE</code> operation.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO2-7" id="callout_integrating_databases_into_ai_services_CO2-7"><img alt="7" src="assets/7.png"/></a></dt>
<dd><p>Create the <code>Message</code> model specifying the table columns, primary key, secondary indexes, table relationships, and foreign keys.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO2-9" id="callout_integrating_databases_into_ai_services_CO2-8"><img alt="8" src="assets/8.png"/></a></dt>
<dd><p>The <code>messages</code> table will contain both the LLM prompts and responses, usage tokens, and costs alongside the status codes and success states.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO2-10" id="callout_integrating_databases_into_ai_services_CO2-9"><img alt="9" src="assets/9.png"/></a></dt>
<dd><p>Specify <code>Mapped[int | None]</code> to declare an optional typing so the column will allow <code>NULL</code> values (i.e., <code>nullable=True</code>).</p></dd>
</dl></div>

<p>Once you have your data models defined, you can create a connection to the database to create each table with the specified configurations.
To achieve this, you will need to create a <em>database engine</em> and implement <em>session management</em>.<a data-startref="ix_ch07-asciidoc10" data-type="indexterm" id="id943"/><a data-startref="ix_ch07-asciidoc10a" data-type="indexterm" id="id944"/><a data-startref="ix_ch07-asciidoc9" data-type="indexterm" id="id945"/><a data-startref="ix_ch07-asciidoc8" data-type="indexterm" id="id946"/></p>
</div></section>








<section data-pdf-bookmark="Creating a Database Engine and Session Management" data-type="sect2"><div class="sect2" id="id108">
<h2>Creating a Database Engine and Session Management</h2>

<p><a data-type="xref" href="#sqlalchemy_engine">Example 7-3</a> shows<a data-primary="databases" data-secondary="project: storing user conversations with an LLM in a relational database" data-tertiary="creating database engine and session management" data-type="indexterm" id="ix_ch07-asciidoc11"/><a data-primary="large language models (LLMs)" data-secondary="project: storing user conversations with an LLM in a relational database" data-tertiary="creating database engine and session management" data-type="indexterm" id="ix_ch07-asciidoc12"/><a data-primary="SQLAlchemy package" data-secondary="database engine creation" data-type="indexterm" id="ix_ch07-asciidoc13"/> how to create a SQLAlchemy engine using your Postgres database connection string.
Once created, you can use the engine and the <code>Base</code> class to create tables for each of your data models.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>The SQLAlchemy’s <code>create_all()</code> method in <a data-type="xref" href="#sqlalchemy_engine">Example 7-3</a> can only create tables in the database but not modify existing tables.
This workflow is useful only if you’re prototyping and happy to reset the database schemas with new tables on each run.</p>

<p>For production environments, you should use a database migration tool such as <code>alembic</code> to update your database schemas and to avoid unintended data loss.
You will learn about the database migration workflow shortly.</p>
</div>
<div data-type="example" id="sqlalchemy_engine">
<h5><span class="label">Example 7-3. </span>Create the SQLAlchemy database engine</h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># database.py</code>

<code class="kn">from</code> <code class="nn">sqlalchemy</code><code class="nn">.</code><code class="nn">ext</code><code class="nn">.</code><code class="nn">asyncio</code> <code class="kn">import</code> <code class="n">create_async_engine</code>
<code class="kn">from</code> <code class="nn">entities</code> <code class="kn">import</code> <code class="n">Base</code>

<code class="n">database_url</code> <code class="o">=</code> <code class="p">(</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO3-1" id="co_integrating_databases_into_ai_services_CO3-1"><img alt="1" src="assets/1.png"/></a>
    <code class="s2">"</code><code class="s2">postgresql+psycopg://fastapi:mysecretpassword@localhost:5432/backend_db</code><code class="s2">"</code>
<code class="p">)</code>
<code class="n">engine</code> <code class="o">=</code> <code class="n">create_async_engine</code><code class="p">(</code><code class="n">database_url</code><code class="p">,</code> <code class="n">echo</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO3-2" id="co_integrating_databases_into_ai_services_CO3-2"><img alt="2" src="assets/2.png"/></a>

<code class="k">async</code> <code class="k">def</code> <code class="nf">init_db</code><code class="p">(</code><code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="kc">None</code><code class="p">:</code>
    <code class="k">async</code> <code class="k">with</code> <code class="n">engine</code><code class="o">.</code><code class="n">begin</code><code class="p">(</code><code class="p">)</code> <code class="k">as</code> <code class="n">conn</code><code class="p">:</code>
        <code class="k">await</code> <code class="n">conn</code><code class="o">.</code><code class="n">run_sync</code><code class="p">(</code><code class="n">Base</code><code class="o">.</code><code class="n">metadata</code><code class="o">.</code><code class="n">drop_all</code><code class="p">)</code>
        <code class="k">await</code> <code class="n">conn</code><code class="o">.</code><code class="n">run_sync</code><code class="p">(</code><code class="n">Base</code><code class="o">.</code><code class="n">metadata</code><code class="o">.</code><code class="n">create_all</code><code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO3-3" id="co_integrating_databases_into_ai_services_CO3-3"><img alt="3" src="assets/3.png"/></a>

<code class="c1"># main.py</code>

<code class="kn">from</code> <code class="nn">contextlib</code> <code class="kn">import</code> <code class="n">asynccontextmanager</code>
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code>
<code class="kn">from</code> <code class="nn">database</code> <code class="kn">import</code> <code class="n">engine</code><code class="p">,</code> <code class="n">init_db</code>

<code class="nd">@asynccontextmanager</code>
<code class="k">async</code> <code class="k">def</code> <code class="nf">lifespan</code><code class="p">(</code><code class="n">_</code><code class="p">:</code> <code class="n">FastAPI</code><code class="p">)</code><code class="p">:</code>
    <code class="k">await</code> <code class="n">init_db</code><code class="p">(</code><code class="p">)</code>
    <code class="c1"># other startup operations within the lifespan</code>
    <code class="o">.</code><code class="o">.</code><code class="o">.</code>
    <code class="k">yield</code>
    <code class="k">await</code> <code class="n">engine</code><code class="o">.</code><code class="n">dispose</code><code class="p">(</code><code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO3-4" id="co_integrating_databases_into_ai_services_CO3-4"><img alt="4" src="assets/4.png"/></a>

<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">(</code><code class="n">lifespan</code><code class="o">=</code><code class="n">lifespan</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO3-1" id="callout_integrating_databases_into_ai_services_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>For Postgres databases, the connection string is defined using the following template: <code><em>&lt;driver&gt;</em>://<em>&lt;username&gt;</em>:<em>&lt;password&gt;</em>@<em>&lt;origin&gt;</em>/<em>&lt;database&gt;</em></code>.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO3-2" id="callout_integrating_databases_into_ai_services_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Create an async database engine using the database connection string.
Turn on debug logging with <code>echo=True</code>.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO3-3" id="callout_integrating_databases_into_ai_services_CO3-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Drop any existing tables and then create all database tables using the defined SQLAlchemy models in <a data-type="xref" href="#sqlalchemy_engine">Example 7-3</a>.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO3-4" id="callout_integrating_databases_into_ai_services_CO3-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Dispose of the database engine during the server shutdown process.
Any code after the <code>yield</code> keyword inside the FastAPI’s <code>lifespan</code> context manager is executed when server shutdown is requested.</p></dd>
</dl></div>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>For clarity, environment variables and secrets such as database connection strings are hard-coded in every code example.</p>

<p>In production scenarios, never hard-code secrets and environment variables.
Leverage environment files, secret managers, and tools like Pydantic Settings to handle application secrets and variables.</p>
</div>

<p>With the engine created, you can now implement a factory function for creating sessions to the database.
Session factory is a design pattern that allows you to open, interact with, and close database connections across your services.</p>

<p>Since you may reuse a session, you can use FastAPI’s dependency injection system to cache and reuse sessions across each request runtime, as shown in <a data-type="xref" href="#sqlalchemy_session">Example 7-4</a>.</p>
<div data-type="example" id="sqlalchemy_session">
<h5><span class="label">Example 7-4. </span>Creating a database session FastAPI dependency</h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># database.py</code>

<code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Annotated</code>
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">Depends</code>
<code class="kn">from</code> <code class="nn">sqlalchemy</code><code class="nn">.</code><code class="nn">ext</code><code class="nn">.</code><code class="nn">asyncio</code> <code class="kn">import</code> <code class="n">AsyncSession</code><code class="p">,</code> <code class="n">async_sessionmaker</code>
<code class="kn">from</code> <code class="nn">database</code> <code class="kn">import</code> <code class="n">engine</code>

<code class="n">async_session</code> <code class="o">=</code> <code class="n">async_sessionmaker</code><code class="p">(</code>
    <code class="n">bind</code><code class="o">=</code><code class="n">engine</code><code class="p">,</code> <code class="n">class_</code><code class="o">=</code><code class="n">AsyncSession</code><code class="p">,</code> <code class="n">autocommit</code><code class="o">=</code><code class="kc">False</code><code class="p">,</code> <code class="n">autoflush</code><code class="o">=</code><code class="kc">False</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO4-1" id="co_integrating_databases_into_ai_services_CO4-1"><img alt="1" src="assets/1.png"/></a>
<code class="p">)</code>
<code class="k">async</code> <code class="k">def</code> <code class="nf">get_db_session</code><code class="p">(</code><code class="p">)</code><code class="p">:</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO4-2" id="co_integrating_databases_into_ai_services_CO4-2"><img alt="2" src="assets/2.png"/></a>
    <code class="k">try</code><code class="p">:</code>
        <code class="k">async</code> <code class="k">with</code> <code class="n">async_session</code><code class="p">(</code><code class="p">)</code> <code class="k">as</code> <code class="n">session</code><code class="p">:</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO4-3" id="co_integrating_databases_into_ai_services_CO4-3"><img alt="3" src="assets/3.png"/></a>
            <code class="k">yield</code> <code class="n">session</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO4-4" id="co_integrating_databases_into_ai_services_CO4-4"><img alt="4" src="assets/4.png"/></a>
    <code class="k">except</code><code class="p">:</code>
        <code class="k">await</code> <code class="n">session</code><code class="o">.</code><code class="n">rollback</code><code class="p">(</code><code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO4-5" id="co_integrating_databases_into_ai_services_CO4-5"><img alt="5" src="assets/5.png"/></a>
        <code class="k">raise</code>
    <code class="k">finally</code><code class="p">:</code>
        <code class="k">await</code> <code class="n">session</code><code class="o">.</code><code class="n">close</code><code class="p">(</code><code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO4-6" id="co_integrating_databases_into_ai_services_CO4-6"><img alt="6" src="assets/6.png"/></a>

<code class="n">DBSessionDep</code> <code class="o">=</code> <code class="n">Annotated</code><code class="p">[</code><code class="n">AsyncSession</code><code class="p">,</code> <code class="n">Depends</code><code class="p">(</code><code class="n">get_db_session</code><code class="p">)</code><code class="p">]</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO4-7" id="co_integrating_databases_into_ai_services_CO4-7"><img alt="7" src="assets/7.png"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO4-1" id="callout_integrating_databases_into_ai_services_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p><a data-primary="database session factory" data-type="indexterm" id="id947"/>Create an async database session factory bound to the database engine you created previously to asynchronously connect to your Postgres instance.
Disable automatic committing of transactions with <code>autocommit=false</code> and automatic flushing of changes to the database with <code>autoflush=False</code>.
Disabling both behaviors gives you more control, helps prevent unintended data updates, and allows you to implement more robust transaction management.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO4-2" id="callout_integrating_databases_into_ai_services_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Define a dependency function to reuse and inject across your FastAPI app 
<span class="keep-together">into route</span> controller functions.
Since the function uses the <code>yield</code> keyword 
<span class="keep-together">within the</span> <code>async with</code>, it is considered an async context manager.
FastAPI will internally decorate the <code>get_db_session</code> as context manager when it is used as a 
<span class="keep-together">dependency.</span></p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO4-3" id="callout_integrating_databases_into_ai_services_CO4-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Use the database session factory to create an async session.
The context manager helps to manage the database session lifecycle such as opening, interacting with, and closing the database connections in each session.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO4-4" id="callout_integrating_databases_into_ai_services_CO4-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Yield the database session to the caller of the <code>get_db_session</code> function.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO4-5" id="callout_integrating_databases_into_ai_services_CO4-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>If there are any exceptions, roll back the transaction and reraise the exception.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO4-6" id="callout_integrating_databases_into_ai_services_CO4-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>In any case, close the database session at the end to release any resources that it holds.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO4-7" id="callout_integrating_databases_into_ai_services_CO4-7"><img alt="7" src="assets/7.png"/></a></dt>
<dd><p>Declare an annotated database session dependency that can be reused across different controllers.</p></dd>
</dl></div>

<p>Now that you can create a database session from any FastAPI route via dependency injection, let’s implement the create, read, update, and delete (CRUD) endpoints for the conversations resource.<a data-startref="ix_ch07-asciidoc13" data-type="indexterm" id="id948"/><a data-startref="ix_ch07-asciidoc12" data-type="indexterm" id="id949"/><a data-startref="ix_ch07-asciidoc11" data-type="indexterm" id="id950"/></p>
</div></section>








<section data-pdf-bookmark="Implementing CRUD Endpoints" data-type="sect2"><div class="sect2" id="id109">
<h2>Implementing CRUD Endpoints</h2>

<p><a data-primary="CRUD (create, read, update, and delete) endpoints" data-type="indexterm" id="ix_ch07-asciidoc15"/><a data-primary="databases" data-secondary="project: storing user conversations with an LLM in a relational database" data-tertiary="implementing CRUD endpoints" data-type="indexterm" id="ix_ch07-asciidoc16"/><a data-primary="large language models (LLMs)" data-secondary="project: storing user conversations with an LLM in a relational database" data-tertiary="implementing CRUD endpoints" data-type="indexterm" id="ix_ch07-asciidoc17"/>As FastAPI relies on Pydantic to serialize and validate incoming and outgoing data, before implementing CRUD endpoints, you’ll need to map database entities to Pydantic models.
This avoids tightly coupling your API schema with your database models to give you the freedom and flexibility in developing your API and databases independent of each other.</p>

<p>You can follow <a data-type="xref" href="#sqlalchemy_pydantic">Example 7-5</a> to define your CRUD schemas.</p>
<div data-type="example" id="sqlalchemy_pydantic">
<h5><span class="label">Example 7-5. </span>Declaring Pydantic API schemas for conversation endpoints</h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># schemas.py</code>

<code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">datetime</code>
<code class="kn">from</code> <code class="nn">pydantic</code> <code class="kn">import</code> <code class="n">BaseModel</code><code class="p">,</code> <code class="n">ConfigDict</code>

<code class="k">class</code> <code class="nc">ConversationBase</code><code class="p">(</code><code class="n">BaseModel</code><code class="p">)</code><code class="p">:</code>
    <code class="n">model_config</code> <code class="o">=</code> <code class="n">ConfigDict</code><code class="p">(</code><code class="n">from_attributes</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO5-1" id="co_integrating_databases_into_ai_services_CO5-1"><img alt="1" src="assets/1.png"/></a>

    <code class="n">title</code><code class="p">:</code> <code class="nb">str</code>
    <code class="n">model_type</code><code class="p">:</code> <code class="nb">str</code>

<code class="k">class</code> <code class="nc">ConversationCreate</code><code class="p">(</code><code class="n">ConversationBase</code><code class="p">)</code><code class="p">:</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO5-2" id="co_integrating_databases_into_ai_services_CO5-2"><img alt="2" src="assets/2.png"/></a>
    <code class="k">pass</code>

<code class="k">class</code> <code class="nc">ConversationUpdate</code><code class="p">(</code><code class="n">ConversationBase</code><code class="p">)</code><code class="p">:</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO5-2" id="co_integrating_databases_into_ai_services_CO5-3"><img alt="2" src="assets/2.png"/></a>
    <code class="k">pass</code>

<code class="k">class</code> <code class="nc">ConversationOut</code><code class="p">(</code><code class="n">ConversationBase</code><code class="p">)</code><code class="p">:</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO5-2" id="co_integrating_databases_into_ai_services_CO5-4"><img alt="2" src="assets/2.png"/></a>
    <code class="nb">id</code><code class="p">:</code> <code class="nb">int</code>
    <code class="n">created_at</code><code class="p">:</code> <code class="n">datetime</code>
    <code class="n">updated_at</code><code class="p">:</code> <code class="n">datetime</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO5-1" id="callout_integrating_databases_into_ai_services_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Set up the Pydantic model to read and validate attributes of other models like SQLAlchemy, which is often used in Pydantic when working with database 
<span class="keep-together">models.</span></p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO5-2" id="callout_integrating_databases_into_ai_services_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Create separate Pydantic models based on the base model for different use cases such as conversation record creation and update, or data retrieval.</p></dd>
</dl></div>
<div data-type="tip"><h6>Tip</h6>
<p>Having to declare Pydantic and SQLAlchemy models may feel like code duplication but will allow you to implement your data access layer however you like.</p>

<p>Alternatively, if you want to avoid any code duplication, you can leverage the <code>sqlmodel</code> package, which integrates Pydantic with SQLAlchemy, removing much of the code duplication.
However, bear in mind that <code>sqlmodel</code> may not be ideal for production due to limited flexibility and support for advanced use cases with SQLAlchemy.
Therefore, you may want to use separate Pydantic and SQLAlchemy models for complex applications.<sup><a data-type="noteref" href="ch07.html#id951" id="id951-marker">1</a></sup></p>
</div>

<p>Now that you have the SQLAlchemy and Pydantic models, you can start developing your CRUD API endpoints.</p>

<p>When implementing CRUD endpoints, you should try to leverage FastAPI dependencies as much as you can to reduce database round-trips.
For instance, when retrieving, updating, and deleting records, you need to check in with the database that a record exists using its ID.</p>

<p>You can implement a record retrieval function to use a dependency across your get, update, and delete endpoints, as shown in <a data-type="xref" href="#sqlalchemy_endpoints">Example 7-6</a>.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>Bear in mind that FastAPI can only cache the output of the <code>get_conversation</code> dependency within a single request and not across multiple requests.</p>
</div>
<div data-type="example" id="sqlalchemy_endpoints">
<h5><span class="label">Example 7-6. </span>Implementing resource-based CRUD endpoints for the <code>conversations</code> table</h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># main.py</code>

<code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Annotated</code>
<code class="kn">from</code> <code class="nn">database</code> <code class="kn">import</code> <code class="n">DBSessionDep</code>
<code class="kn">from</code> <code class="nn">entities</code> <code class="kn">import</code> <code class="n">Conversation</code>
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">Depends</code><code class="p">,</code> <code class="n">FastAPI</code><code class="p">,</code> <code class="n">HTTPException</code><code class="p">,</code> <code class="n">status</code>
<code class="kn">from</code> <code class="nn">schemas</code> <code class="kn">import</code> <code class="n">ConversationCreate</code><code class="p">,</code> <code class="n">ConversationOut</code><code class="p">,</code> <code class="n">ConversationUpdate</code>
<code class="kn">from</code> <code class="nn">sqlalchemy</code> <code class="kn">import</code> <code class="n">select</code>

<code class="o">.</code><code class="o">.</code><code class="o">.</code>

<code class="k">async</code> <code class="k">def</code> <code class="nf">get_conversation</code><code class="p">(</code>
    <code class="n">conversation_id</code><code class="p">:</code> <code class="nb">int</code><code class="p">,</code> <code class="n">session</code><code class="p">:</code> <code class="n">DBSessionDep</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO6-1" id="co_integrating_databases_into_ai_services_CO6-1"><img alt="1" src="assets/1.png"/></a>
<code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="n">Conversation</code><code class="p">:</code>
    <code class="k">async</code> <code class="k">with</code> <code class="n">session</code><code class="o">.</code><code class="n">begin</code><code class="p">(</code><code class="p">)</code><code class="p">:</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO6-2" id="co_integrating_databases_into_ai_services_CO6-2"><img alt="2" src="assets/2.png"/></a>
        <code class="n">result</code> <code class="o">=</code> <code class="k">await</code> <code class="n">session</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code>
            <code class="n">select</code><code class="p">(</code><code class="n">Conversation</code><code class="p">)</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">Conversation</code><code class="o">.</code><code class="n">id</code> <code class="o">==</code> <code class="n">conversation_id</code><code class="p">)</code>
        <code class="p">)</code>
        <code class="n">conversation</code> <code class="o">=</code> <code class="n">result</code><code class="o">.</code><code class="n">scalars</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">first</code><code class="p">(</code><code class="p">)</code>
    <code class="k">if</code> <code class="ow">not</code> <code class="n">conversation</code><code class="p">:</code>
        <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code>
            <code class="n">status_code</code><code class="o">=</code><code class="n">status</code><code class="o">.</code><code class="n">HTTP_404_NOT_FOUND</code><code class="p">,</code>
            <code class="n">detail</code><code class="o">=</code><code class="s2">"</code><code class="s2">Conversation not found</code><code class="s2">"</code><code class="p">,</code>
        <code class="p">)</code>
    <code class="k">return</code> <code class="n">conversation</code>

<code class="n">GetConversationDep</code> <code class="o">=</code> <code class="n">Annotated</code><code class="p">[</code><code class="n">Conversation</code><code class="p">,</code> <code class="n">Depends</code><code class="p">(</code><code class="n">get_conversation</code><code class="p">)</code><code class="p">]</code>

<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">/conversations</code><code class="s2">"</code><code class="p">)</code>
<code class="k">async</code> <code class="k">def</code> <code class="nf">list_conversations_controller</code><code class="p">(</code>
    <code class="n">session</code><code class="p">:</code> <code class="n">DBSessionDep</code><code class="p">,</code> <code class="n">skip</code><code class="p">:</code> <code class="nb">int</code> <code class="o">=</code> <code class="mi">0</code><code class="p">,</code> <code class="n">take</code><code class="p">:</code> <code class="nb">int</code> <code class="o">=</code> <code class="mi">100</code>
<code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">ConversationOut</code><code class="p">]</code><code class="p">:</code>
    <code class="k">async</code> <code class="k">with</code> <code class="n">session</code><code class="o">.</code><code class="n">begin</code><code class="p">(</code><code class="p">)</code><code class="p">:</code>
        <code class="n">result</code> <code class="o">=</code> <code class="k">await</code> <code class="n">session</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code>
            <code class="n">select</code><code class="p">(</code><code class="n">Conversation</code><code class="p">)</code><code class="o">.</code><code class="n">offset</code><code class="p">(</code><code class="n">skip</code><code class="p">)</code><code class="o">.</code><code class="n">limit</code><code class="p">(</code><code class="n">take</code><code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO6-3" id="co_integrating_databases_into_ai_services_CO6-3"><img alt="3" src="assets/3.png"/></a>
        <code class="p">)</code>
    <code class="k">return</code> <code class="p">[</code>
        <code class="n">ConversationOut</code><code class="o">.</code><code class="n">model_validate</code><code class="p">(</code><code class="n">conversation</code><code class="p">)</code>
        <code class="k">for</code> <code class="n">conversation</code> <code class="ow">in</code> <code class="n">result</code><code class="o">.</code><code class="n">scalars</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">all</code><code class="p">(</code><code class="p">)</code>
    <code class="p">]</code>

<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">/conversations/</code><code class="si">{id}</code><code class="s2">"</code><code class="p">)</code>
<code class="k">async</code> <code class="k">def</code> <code class="nf">get_conversation_controller</code><code class="p">(</code>
    <code class="n">conversation</code><code class="p">:</code> <code class="n">GetConversationDep</code><code class="p">,</code>
<code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="n">ConversationOut</code><code class="p">:</code>
    <code class="k">return</code> <code class="n">ConversationOut</code><code class="o">.</code><code class="n">model_validate</code><code class="p">(</code><code class="n">conversation</code><code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO6-4" id="co_integrating_databases_into_ai_services_CO6-4"><img alt="4" src="assets/4.png"/></a>

<code class="nd">@app</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"</code><code class="s2">/conversations</code><code class="s2">"</code><code class="p">,</code> <code class="n">status_code</code><code class="o">=</code><code class="n">status</code><code class="o">.</code><code class="n">HTTP_201_CREATED</code><code class="p">)</code>
<code class="k">async</code> <code class="k">def</code> <code class="nf">create_conversation_controller</code><code class="p">(</code>
    <code class="n">conversation</code><code class="p">:</code> <code class="n">ConversationCreate</code><code class="p">,</code> <code class="n">session</code><code class="p">:</code> <code class="n">DBSessionDep</code>
<code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="n">ConversationOut</code><code class="p">:</code>
    <code class="n">new_conversation</code> <code class="o">=</code> <code class="n">Conversation</code><code class="p">(</code><code class="o">*</code><code class="o">*</code><code class="n">conversation</code><code class="o">.</code><code class="n">model_dump</code><code class="p">(</code><code class="p">)</code><code class="p">)</code>
    <code class="k">async</code> <code class="k">with</code> <code class="n">session</code><code class="o">.</code><code class="n">begin</code><code class="p">(</code><code class="p">)</code><code class="p">:</code>
        <code class="n">session</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">new_conversation</code><code class="p">)</code>
        <code class="k">await</code> <code class="n">session</code><code class="o">.</code><code class="n">commit</code><code class="p">(</code><code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO6-5" id="co_integrating_databases_into_ai_services_CO6-5"><img alt="5" src="assets/5.png"/></a>
        <code class="k">await</code> <code class="n">session</code><code class="o">.</code><code class="n">refresh</code><code class="p">(</code><code class="n">new_conversation</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">ConversationOut</code><code class="o">.</code><code class="n">model_validate</code><code class="p">(</code><code class="n">new_conversation</code><code class="p">)</code>

<code class="nd">@app</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="s2">"</code><code class="s2">/conversations/</code><code class="si">{id}</code><code class="s2">"</code><code class="p">,</code> <code class="n">status_code</code><code class="o">=</code><code class="n">status</code><code class="o">.</code><code class="n">HTTP_202_ACCEPTED</code><code class="p">)</code>
<code class="k">async</code> <code class="k">def</code> <code class="nf">update_conversation_controller</code><code class="p">(</code>
    <code class="n">updated_conversation</code><code class="p">:</code> <code class="n">ConversationUpdate</code><code class="p">,</code>
    <code class="n">conversation</code><code class="p">:</code> <code class="n">GetConversationDep</code><code class="p">,</code>
    <code class="n">session</code><code class="p">:</code> <code class="n">DBSessionDep</code><code class="p">,</code>
<code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="n">ConversationOut</code><code class="p">:</code>
    <code class="k">for</code> <code class="n">key</code><code class="p">,</code> <code class="n">value</code> <code class="ow">in</code> <code class="n">updated_conversation</code><code class="o">.</code><code class="n">model_dump</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">items</code><code class="p">(</code><code class="p">)</code><code class="p">:</code>
        <code class="nb">setattr</code><code class="p">(</code><code class="n">conversation</code><code class="p">,</code> <code class="n">key</code><code class="p">,</code> <code class="n">value</code><code class="p">)</code>
    <code class="k">async</code> <code class="k">with</code> <code class="n">session</code><code class="o">.</code><code class="n">begin</code><code class="p">(</code><code class="p">)</code><code class="p">:</code>
        <code class="k">await</code> <code class="n">session</code><code class="o">.</code><code class="n">commit</code><code class="p">(</code><code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO6-5" id="co_integrating_databases_into_ai_services_CO6-6"><img alt="5" src="assets/5.png"/></a>
        <code class="k">await</code> <code class="n">session</code><code class="o">.</code><code class="n">refresh</code><code class="p">(</code><code class="n">conversation</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">ConversationOut</code><code class="o">.</code><code class="n">model_validate</code><code class="p">(</code><code class="n">conversation</code><code class="p">)</code>

<code class="nd">@app</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="s2">"</code><code class="s2">/conversations/</code><code class="si">{id}</code><code class="s2">"</code><code class="p">,</code> <code class="n">status_code</code><code class="o">=</code><code class="n">status</code><code class="o">.</code><code class="n">HTTP_204_NO_CONTENT</code><code class="p">)</code>
<code class="k">async</code> <code class="k">def</code> <code class="nf">delete_conversation_controller</code><code class="p">(</code>
    <code class="n">conversation</code><code class="p">:</code> <code class="n">GetConversationDep</code><code class="p">,</code> <code class="n">session</code><code class="p">:</code> <code class="n">DBSessionDep</code>
<code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="kc">None</code><code class="p">:</code>
    <code class="k">async</code> <code class="k">with</code> <code class="n">session</code><code class="o">.</code><code class="n">begin</code><code class="p">(</code><code class="p">)</code><code class="p">:</code>
        <code class="k">await</code> <code class="n">session</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="n">conversation</code><code class="p">)</code>
        <code class="k">await</code> <code class="n">session</code><code class="o">.</code><code class="n">commit</code><code class="p">(</code><code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO6-5" id="co_integrating_databases_into_ai_services_CO6-7"><img alt="5" src="assets/5.png"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO6-1" id="callout_integrating_databases_into_ai_services_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Define a dependency to check if the conversation record exists.
Raise a 404 <code>HTTPException</code> if a record is not found; otherwise, return the retrieved record.
This dependency can be reused across several CRUD endpoints through dependency injection.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO6-2" id="callout_integrating_databases_into_ai_services_CO6-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Begin the async session within an async context manager during each request.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO6-3" id="callout_integrating_databases_into_ai_services_CO6-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>When listing records, it’s more efficient to retrieve only a subset of records.
By default, SQLAlchemy ORM returns a subset of most recent records in the database, but you can use the <code>.offset(skip)</code> and <code>.limit(take)</code> chained methods to retrieve any subset of records.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO6-4" id="callout_integrating_databases_into_ai_services_CO6-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Create a Pydantic model from a SQLAlchemy model using <code>model_validate()</code>.
Raises a <code>ValidationError</code> if the SQLAlchemy object passed can’t be created or doesn’t pass Pydantic’s data validation checks.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO6-5" id="callout_integrating_databases_into_ai_services_CO6-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>For operations that mutate a record (i.e., create, update, and delete), commit the transaction then send the refreshed record to the client, except for the successful delete operation that should return <code>None</code>.</p></dd>
</dl></div>

<p>Notice how the controller logic is simplified through this dependency injection approach.</p>

<p>Additionally, pay attention to success status codes you should to send to the client.
Successful retrieval operations should return 200, while record creation operations return 201, updates return 202, and deletions return 204.</p>

<p>Congratulations!
You now have a resource-based RESTful API that you can use to perform CRUD operations on your <code>conversations</code> table.</p>

<p>Now that you can implement CRUD endpoints, let’s refactor the existing code examples to use the <em>repository and services</em> design pattern you learned about in <a data-type="xref" href="ch02.html#ch02">Chapter 2</a>.
With this design pattern, you can abstract the database operations to achieve a more modular, maintainable, and testable codebase.<a data-startref="ix_ch07-asciidoc17" data-type="indexterm" id="id952"/><a data-startref="ix_ch07-asciidoc16" data-type="indexterm" id="id953"/><a data-startref="ix_ch07-asciidoc15" data-type="indexterm" id="id954"/></p>
</div></section>








<section data-pdf-bookmark="Repository and Services Design Pattern" data-type="sect2"><div class="sect2" id="id110">
<h2>Repository and Services Design Pattern</h2>

<p><a data-primary="databases" data-secondary="project: storing user conversations with an LLM in a relational database" data-tertiary="repository and services design pattern" data-type="indexterm" id="ix_ch07-asciidoc18"/><a data-primary="large language models (LLMs)" data-secondary="project: storing user conversations with an LLM in a relational database" data-tertiary="repository and services design pattern" data-type="indexterm" id="ix_ch07-asciidoc19"/>A <a data-primary="repository design pattern" data-type="indexterm" id="ix_ch07-asciidoc20"/><em>repository</em> is a design pattern that mediates the business logic of your application and the database access layer—for instance, via an ORM.
It contains several methods for performing CRUD operations in the database layer.</p>

<p>In <a data-type="xref" href="ch02.html#ch02">Chapter 2</a>, you first saw <a data-type="xref" href="#onion">Figure 7-4</a>, which showed where the repositories sit within the onion/layered application architecture when working with a database.</p>

<figure><div class="figure" id="onion">
<img alt="bgai 0704" src="assets/bgai_0704.png"/>
<h6><span class="label">Figure 7-4. </span>The repository pattern within the onion/layered application architecture</h6>
</div></figure>

<p><a data-primary="abstract interface" data-type="indexterm" id="id955"/>To implement a repository pattern, you can use an <em>abstract interface</em>, which enforces certain constraints on how you define your specific repository classes as you can see in <a data-type="xref" href="#sqlalchemy_repository">Example 7-7</a>.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>If you’ve never used <em>abstract</em> classes, they’re classes that can’t be instantiated on their own.
Abstract classes can contain methods without implementation that its subclasses must implement.</p>

<p>A concrete class is one that inherits an abstract class and implements each of its abstract methods.</p>
</div>
<div data-type="example" id="sqlalchemy_repository">
<h5><span class="label">Example 7-7. </span>Implementing a repository abstract interface</h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># repositories/interfaces.py</code>

<code class="kn">from</code> <code class="nn">abc</code> <code class="kn">import</code> <code class="n">ABC</code><code class="p">,</code> <code class="n">abstractmethod</code>
<code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Any</code>

<code class="k">class</code> <code class="nc">Repository</code><code class="p">(</code><code class="n">ABC</code><code class="p">)</code><code class="p">:</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO7-1" id="co_integrating_databases_into_ai_services_CO7-1"><img alt="1" src="assets/1.png"/></a>
    <code class="nd">@abstractmethod</code>
    <code class="k">async</code> <code class="k">def</code> <code class="nf">list</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">Any</code><code class="p">]</code><code class="p">:</code>
        <code class="k">pass</code>

    <code class="nd">@abstractmethod</code>
    <code class="k">async</code> <code class="k">def</code> <code class="nf">get</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">uid</code><code class="p">:</code> <code class="nb">int</code><code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="n">Any</code><code class="p">:</code>
        <code class="k">pass</code>

    <code class="nd">@abstractmethod</code>
    <code class="k">async</code> <code class="k">def</code> <code class="nf">create</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">record</code><code class="p">:</code> <code class="n">Any</code><code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="n">Any</code><code class="p">:</code>
        <code class="k">pass</code>

    <code class="nd">@abstractmethod</code>
    <code class="k">async</code> <code class="k">def</code> <code class="nf">update</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">uid</code><code class="p">:</code> <code class="nb">int</code><code class="p">,</code> <code class="n">record</code><code class="p">:</code> <code class="n">Any</code><code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="n">Any</code><code class="p">:</code>
        <code class="k">pass</code>

    <code class="nd">@abstractmethod</code>
    <code class="k">async</code> <code class="k">def</code> <code class="nf">delete</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">uid</code><code class="p">:</code> <code class="nb">int</code><code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="kc">None</code><code class="p">:</code>
        <code class="k">pass</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO7-1" id="callout_integrating_databases_into_ai_services_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Define the abstract <code>Repository</code> interface with several CRUD-related abstract method signatures that subclasses must implement.
If an abstract method is not implemented in a concrete subclass, a
<code>NotImplementedError</code> will be raised.</p></dd>
</dl></div>

<p>Now that you have a <code>Repository</code> class, you declare subclasses for each of your tables to define how database operations must be performed following the CRUD-based methods.
For instance, to perform CRUD operations on the conversation records in the database, you can implement a concrete <code>ConversationRepository</code> class, as shown in <a data-type="xref" href="#sqlalchemy_conversation_repository">Example 7-8</a>.</p>
<div data-type="example" id="sqlalchemy_conversation_repository">
<h5><span class="label">Example 7-8. </span>Implementing the conversation repository using the abstract repository interface</h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># repositories/conversations.py</code>

<code class="kn">from</code> <code class="nn">entities</code> <code class="kn">import</code> <code class="n">Conversation</code>
<code class="kn">from</code> <code class="nn">repositories</code><code class="nn">.</code><code class="nn">interfaces</code> <code class="kn">import</code> <code class="n">Repository</code>
<code class="kn">from</code> <code class="nn">schemas</code> <code class="kn">import</code> <code class="n">ConversationCreate</code><code class="p">,</code> <code class="n">ConversationUpdate</code>
<code class="kn">from</code> <code class="nn">sqlalchemy</code> <code class="kn">import</code> <code class="n">select</code>
<code class="kn">from</code> <code class="nn">sqlalchemy</code><code class="nn">.</code><code class="nn">ext</code><code class="nn">.</code><code class="nn">asyncio</code> <code class="kn">import</code> <code class="n">AsyncSession</code>

<code class="k">class</code> <code class="nc">ConversationRepository</code><code class="p">(</code><code class="n">Repository</code><code class="p">)</code><code class="p">:</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO8-1" id="co_integrating_databases_into_ai_services_CO8-1"><img alt="1" src="assets/1.png"/></a>
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">session</code><code class="p">:</code> <code class="n">AsyncSession</code><code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="kc">None</code><code class="p">:</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">session</code> <code class="o">=</code> <code class="n">session</code>

    <code class="k">async</code> <code class="k">def</code> <code class="nf">list</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">skip</code><code class="p">:</code> <code class="nb">int</code><code class="p">,</code> <code class="n">take</code><code class="p">:</code> <code class="nb">int</code><code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">Conversation</code><code class="p">]</code><code class="p">:</code>
        <code class="k">async</code> <code class="k">with</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">begin</code><code class="p">(</code><code class="p">)</code><code class="p">:</code>
            <code class="n">result</code> <code class="o">=</code> <code class="k">await</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code>
                <code class="n">select</code><code class="p">(</code><code class="n">Conversation</code><code class="p">)</code><code class="o">.</code><code class="n">offset</code><code class="p">(</code><code class="n">skip</code><code class="p">)</code><code class="o">.</code><code class="n">limit</code><code class="p">(</code><code class="n">take</code><code class="p">)</code>
            <code class="p">)</code>
        <code class="k">return</code> <code class="p">[</code><code class="n">r</code> <code class="k">for</code> <code class="n">r</code> <code class="ow">in</code> <code class="n">result</code><code class="o">.</code><code class="n">scalars</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">all</code><code class="p">(</code><code class="p">)</code><code class="p">]</code>

    <code class="k">async</code> <code class="k">def</code> <code class="nf">get</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">conversation_id</code><code class="p">:</code> <code class="nb">int</code><code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="n">Conversation</code> <code class="o">|</code> <code class="kc">None</code><code class="p">:</code>
        <code class="k">async</code> <code class="k">with</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">begin</code><code class="p">(</code><code class="p">)</code><code class="p">:</code>
            <code class="n">result</code> <code class="o">=</code> <code class="k">await</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code>
                <code class="n">select</code><code class="p">(</code><code class="n">Conversation</code><code class="p">)</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">Conversation</code><code class="o">.</code><code class="n">id</code> <code class="o">==</code> <code class="n">conversation_id</code><code class="p">)</code>
            <code class="p">)</code>
        <code class="k">return</code> <code class="n">result</code><code class="o">.</code><code class="n">scalars</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">first</code><code class="p">(</code><code class="p">)</code>

    <code class="k">async</code> <code class="k">def</code> <code class="nf">create</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">conversation</code><code class="p">:</code> <code class="n">ConversationCreate</code><code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="n">Conversation</code><code class="p">:</code>
        <code class="n">new_conversation</code> <code class="o">=</code> <code class="n">Conversation</code><code class="p">(</code><code class="o">*</code><code class="o">*</code><code class="n">conversation</code><code class="o">.</code><code class="n">model_dump</code><code class="p">(</code><code class="p">)</code><code class="p">)</code>
        <code class="k">async</code> <code class="k">with</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">begin</code><code class="p">(</code><code class="p">)</code><code class="p">:</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">new_conversation</code><code class="p">)</code>
            <code class="k">await</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">commit</code><code class="p">(</code><code class="p">)</code>
            <code class="k">await</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">refresh</code><code class="p">(</code><code class="n">new_conversation</code><code class="p">)</code>
        <code class="k">return</code> <code class="n">new_conversation</code>

    <code class="k">async</code> <code class="k">def</code> <code class="nf">update</code><code class="p">(</code>
        <code class="bp">self</code><code class="p">,</code> <code class="n">conversation_id</code><code class="p">:</code> <code class="nb">int</code><code class="p">,</code> <code class="n">updated_conversation</code><code class="p">:</code> <code class="n">ConversationUpdate</code>
    <code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="n">Conversation</code> <code class="o">|</code> <code class="kc">None</code><code class="p">:</code>
        <code class="n">conversation</code> <code class="o">=</code> <code class="k">await</code> <code class="bp">self</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">conversation_id</code><code class="p">)</code>
        <code class="k">if</code> <code class="ow">not</code> <code class="n">conversation</code><code class="p">:</code>
            <code class="k">return</code> <code class="kc">None</code>
        <code class="k">for</code> <code class="n">key</code><code class="p">,</code> <code class="n">value</code> <code class="ow">in</code> <code class="n">updated_conversation</code><code class="o">.</code><code class="n">model_dump</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">items</code><code class="p">(</code><code class="p">)</code><code class="p">:</code>
            <code class="nb">setattr</code><code class="p">(</code><code class="n">conversation</code><code class="p">,</code> <code class="n">key</code><code class="p">,</code> <code class="n">value</code><code class="p">)</code>
        <code class="k">async</code> <code class="k">with</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">begin</code><code class="p">(</code><code class="p">)</code><code class="p">:</code>
            <code class="k">await</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">commit</code><code class="p">(</code><code class="p">)</code>
            <code class="k">await</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">refresh</code><code class="p">(</code><code class="n">conversation</code><code class="p">)</code>
        <code class="k">return</code> <code class="n">conversation</code>

    <code class="k">async</code> <code class="k">def</code> <code class="nf">delete</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">conversation_id</code><code class="p">:</code> <code class="nb">int</code><code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="kc">None</code><code class="p">:</code>
        <code class="n">conversation</code> <code class="o">=</code> <code class="k">await</code> <code class="bp">self</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">conversation_id</code><code class="p">)</code>
        <code class="k">if</code> <code class="ow">not</code> <code class="n">conversation</code><code class="p">:</code>
            <code class="k">return</code>
        <code class="k">async</code> <code class="k">with</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">begin</code><code class="p">(</code><code class="p">)</code><code class="p">:</code>
            <code class="k">await</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="n">conversation</code><code class="p">)</code>
            <code class="k">await</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">commit</code><code class="p">(</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO8-1" id="callout_integrating_databases_into_ai_services_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Inherit the abstract <code>Repository</code> interface and implement each of its methods while adhering to the method signatures.</p></dd>
</dl></div>

<p>You have now moved the database logic for conversations into the

<span class="keep-together"><code>ConversationRepository</code>.</span>
This means you can now import this class into your route controller functions and start using it right away.</p>

<p>Go back to your <code>main.py</code> file and refactor your route controllers to use the 
<span class="keep-together"><code>ConversationRepository</code>,</span> as shown in
<a data-type="xref" href="#sqlalchemy_conversation_repository_endpoints">Example 7-9</a>.</p>
<div data-type="example" id="sqlalchemy_conversation_repository_endpoints">
<h5><span class="label">Example 7-9. </span>Refactoring the conversation CRUD endpoints to use the repository pattern</h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># routers/conversations.py</code>

<code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Annotated</code>
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">APIRouter</code><code class="p">,</code> <code class="n">Depends</code><code class="p">,</code> <code class="n">FastAPI</code><code class="p">,</code> <code class="n">HTTPException</code><code class="p">,</code> <code class="n">status</code>
<code class="o">.</code><code class="o">.</code><code class="o">.</code>  <code class="c1"># Other imports</code>
<code class="kn">from</code> <code class="nn">repositories</code> <code class="kn">import</code> <code class="n">ConversationRepository</code>

<code class="o">.</code><code class="o">.</code><code class="o">.</code>  <code class="c1"># Other controllers and dependency implementations</code>

<code class="n">router</code> <code class="o">=</code> <code class="n">APIRouter</code><code class="p">(</code><code class="n">prefix</code><code class="o">=</code><code class="s2">"</code><code class="s2">/conversations</code><code class="s2">"</code><code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO9-1" id="co_integrating_databases_into_ai_services_CO9-1"><img alt="1" src="assets/1.png"/></a>

<code class="k">async</code> <code class="k">def</code> <code class="nf">get_conversation</code><code class="p">(</code>
    <code class="n">conversation_id</code><code class="p">:</code> <code class="nb">int</code><code class="p">,</code> <code class="n">session</code><code class="p">:</code> <code class="n">SessionDep</code>
<code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="n">Conversation</code><code class="p">:</code>
    <code class="n">conversation</code> <code class="o">=</code> <code class="k">await</code> <code class="n">ConversationRepository</code><code class="p">(</code><code class="n">session</code><code class="p">)</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">conversation_id</code><code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO9-2" id="co_integrating_databases_into_ai_services_CO9-2"><img alt="2" src="assets/2.png"/></a>
    <code class="k">if</code> <code class="ow">not</code> <code class="n">conversation</code><code class="p">:</code>
        <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code>
            <code class="n">status_code</code><code class="o">=</code><code class="n">status</code><code class="o">.</code><code class="n">HTTP_404_NOT_FOUND</code><code class="p">,</code>
            <code class="n">detail</code><code class="o">=</code><code class="s2">"</code><code class="s2">Conversation not found</code><code class="s2">"</code><code class="p">,</code>
        <code class="p">)</code>
    <code class="k">return</code> <code class="n">conversation</code>

<code class="n">GetConversationDep</code> <code class="o">=</code> <code class="n">Annotated</code><code class="p">[</code><code class="n">Conversation</code><code class="p">,</code> <code class="n">Depends</code><code class="p">(</code><code class="n">get_conversation</code><code class="p">)</code><code class="p">]</code>

<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">"</code><code class="p">)</code>
<code class="k">async</code> <code class="k">def</code> <code class="nf">list_conversations_controller</code><code class="p">(</code>
    <code class="n">session</code><code class="p">:</code> <code class="n">SessionDep</code><code class="p">,</code> <code class="n">skip</code><code class="p">:</code> <code class="nb">int</code> <code class="o">=</code> <code class="mi">0</code><code class="p">,</code> <code class="n">take</code><code class="p">:</code> <code class="nb">int</code> <code class="o">=</code> <code class="mi">100</code>
<code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">ConversationOut</code><code class="p">]</code><code class="p">:</code>
    <code class="n">conversations</code> <code class="o">=</code> <code class="k">await</code> <code class="n">ConversationRepository</code><code class="p">(</code><code class="n">session</code><code class="p">)</code><code class="o">.</code><code class="n">list</code><code class="p">(</code><code class="n">skip</code><code class="p">,</code> <code class="n">take</code><code class="p">)</code>
    <code class="k">return</code> <code class="p">[</code><code class="n">ConversationOut</code><code class="o">.</code><code class="n">model_validate</code><code class="p">(</code><code class="n">c</code><code class="p">)</code> <code class="k">for</code> <code class="n">c</code> <code class="ow">in</code> <code class="n">conversations</code><code class="p">]</code>


<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">/</code><code class="si">{id}</code><code class="s2">"</code><code class="p">)</code>
<code class="k">async</code> <code class="k">def</code> <code class="nf">get_conversation_controller</code><code class="p">(</code>
    <code class="n">conversation</code><code class="p">:</code> <code class="n">GetConversationDep</code><code class="p">,</code>
<code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="n">ConversationOut</code><code class="p">:</code>
    <code class="k">return</code> <code class="n">ConversationOut</code><code class="o">.</code><code class="n">model_validate</code><code class="p">(</code><code class="n">conversation</code><code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO9-2" id="co_integrating_databases_into_ai_services_CO9-3"><img alt="2" src="assets/2.png"/></a>


<code class="nd">@router</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"</code><code class="s2">"</code><code class="p">,</code> <code class="n">status_code</code><code class="o">=</code><code class="n">status</code><code class="o">.</code><code class="n">HTTP_201_CREATED</code><code class="p">)</code>
<code class="k">async</code> <code class="k">def</code> <code class="nf">create_conversation_controller</code><code class="p">(</code>
    <code class="n">conversation</code><code class="p">:</code> <code class="n">ConversationCreate</code><code class="p">,</code> <code class="n">session</code><code class="p">:</code> <code class="n">SessionDep</code>
<code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="n">ConversationOut</code><code class="p">:</code>
    <code class="n">new_conversation</code> <code class="o">=</code> <code class="k">await</code> <code class="n">ConversationRepository</code><code class="p">(</code><code class="n">session</code><code class="p">)</code><code class="o">.</code><code class="n">create</code><code class="p">(</code>
        <code class="n">conversation</code>
    <code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO9-2" id="co_integrating_databases_into_ai_services_CO9-4"><img alt="2" src="assets/2.png"/></a>
    <code class="k">return</code> <code class="n">ConversationOut</code><code class="o">.</code><code class="n">model_validate</code><code class="p">(</code><code class="n">new_conversation</code><code class="p">)</code>


<code class="nd">@router</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="s2">"</code><code class="s2">/</code><code class="si">{id}</code><code class="s2">"</code><code class="p">,</code> <code class="n">status_code</code><code class="o">=</code><code class="n">status</code><code class="o">.</code><code class="n">HTTP_202_ACCEPTED</code><code class="p">)</code>
<code class="k">async</code> <code class="k">def</code> <code class="nf">update_conversation_controller</code><code class="p">(</code>
    <code class="n">conversation</code><code class="p">:</code> <code class="n">GetConversationDep</code><code class="p">,</code>
    <code class="n">updated_conversation</code><code class="p">:</code> <code class="n">ConversationUpdate</code><code class="p">,</code>
    <code class="n">session</code><code class="p">:</code> <code class="n">SessionDep</code><code class="p">,</code>
<code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="n">ConversationOut</code><code class="p">:</code>
    <code class="n">updated_conversation</code> <code class="o">=</code> <code class="k">await</code> <code class="n">ConversationRepository</code><code class="p">(</code><code class="n">session</code><code class="p">)</code><code class="o">.</code><code class="n">update</code><code class="p">(</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO9-2" id="co_integrating_databases_into_ai_services_CO9-5"><img alt="2" src="assets/2.png"/></a>
        <code class="n">conversation</code><code class="o">.</code><code class="n">id</code><code class="p">,</code> <code class="n">updated_conversation</code>
    <code class="p">)</code>
    <code class="k">return</code> <code class="n">ConversationOut</code><code class="o">.</code><code class="n">model_validate</code><code class="p">(</code><code class="n">updated_conversation</code><code class="p">)</code>


<code class="nd">@router</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="s2">"</code><code class="s2">/</code><code class="si">{id}</code><code class="s2">"</code><code class="p">,</code> <code class="n">status_code</code><code class="o">=</code><code class="n">status</code><code class="o">.</code><code class="n">HTTP_204_NO_CONTENT</code><code class="p">)</code>
<code class="k">async</code> <code class="k">def</code> <code class="nf">delete_conversation_controller</code><code class="p">(</code>
    <code class="n">conversation</code><code class="p">:</code> <code class="n">GetConversationDep</code><code class="p">,</code> <code class="n">session</code><code class="p">:</code> <code class="n">SessionDep</code>
<code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="kc">None</code><code class="p">:</code>
    <code class="k">await</code> <code class="n">ConversationRepository</code><code class="p">(</code><code class="n">session</code><code class="p">)</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="n">conversation</code><code class="o">.</code><code class="n">id</code><code class="p">)</code>


<code class="c1"># main.py</code>

<code class="kn">from</code> <code class="nn">routers</code><code class="nn">.</code><code class="nn">conversations</code> <code class="kn">import</code> <code class="n">router</code> <code class="k">as</code> <code class="n">conversations_router</code>

<code class="n">app</code><code class="o">.</code><code class="n">include_router</code><code class="p">(</code><code class="n">conversations_router</code><code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO9-1" id="co_integrating_databases_into_ai_services_CO9-6"><img alt="1" src="assets/1.png"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO9-1" id="callout_integrating_databases_into_ai_services_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Place conversation CRUD routes on a separate API router and include on the FastAPI application for modular API design.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO9-2" id="callout_integrating_databases_into_ai_services_CO9-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Refactor conversation CRUD routes to use the repository pattern for more readable controller implementation.</p></dd>
</dl></div>

<p>Do you notice how cleaner your route controllers appear now that the database logic has been abstracted within the <code>ConversationRepository</code> class?<a data-startref="ix_ch07-asciidoc20" data-type="indexterm" id="id956"/></p>

<p><a data-primary="service pattern" data-type="indexterm" id="ix_ch07-asciidoc21"/>You can take this approach one step further and implement a service pattern as well.
A <em>service</em> pattern is an extension of the repository pattern that encapsulates the business logic and operations in a higher layer.
These higher-level operations often require more complex queries and a sequence of CRUD operations to be performed to implement the business logic.</p>

<p class="less_space pagebreak-before">As an example, you can implement a <code>ConversationService</code> to fetch messages related to a conversation or a specific user (see <a data-type="xref" href="#sqlalchemy_conversation_service">Example 7-10</a>).
Since it extends a 
<span class="keep-together"><code>ConversationRepository</code>,</span> you can still access the lower-level data access CRUD methods such as <code>list</code>, <code>get</code>, <code>create</code>, <code>update</code>, and
<code>delete</code>.</p>

<p>Once again you can go back to your controllers and replace references to the

<span class="keep-together"><code>ConversationRepository</code></span> with the
<code>ConversationService</code> instead.
Additionally, you can use the same service to add a new endpoint for fetching messages within a single 
<span class="keep-together">conversation.</span></p>
<div data-type="example" id="sqlalchemy_conversation_service">
<h5><span class="label">Example 7-10. </span>Implementing the conversation services pattern</h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># services/conversations.py</code>

<code class="kn">from</code> <code class="nn">entities</code> <code class="kn">import</code> <code class="n">Message</code>
<code class="kn">from</code> <code class="nn">repositories</code><code class="nn">.</code><code class="nn">conversations</code> <code class="kn">import</code> <code class="n">ConversationRepository</code>
<code class="kn">from</code> <code class="nn">sqlalchemy</code> <code class="kn">import</code> <code class="n">select</code>

<code class="k">class</code> <code class="nc">ConversationService</code><code class="p">(</code><code class="n">ConversationRepository</code><code class="p">)</code><code class="p">:</code>
    <code class="k">async</code> <code class="k">def</code> <code class="nf">list_messages</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">conversation_id</code><code class="p">:</code> <code class="nb">int</code><code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">Message</code><code class="p">]</code><code class="p">:</code>
        <code class="n">result</code> <code class="o">=</code> <code class="k">await</code> <code class="bp">self</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code>
            <code class="n">select</code><code class="p">(</code><code class="n">Message</code><code class="p">)</code><code class="o">.</code><code class="n">where</code><code class="p">(</code><code class="n">Message</code><code class="o">.</code><code class="n">conversation_id</code> <code class="o">==</code> <code class="n">conversation_id</code><code class="p">)</code>
        <code class="p">)</code>
        <code class="k">return</code> <code class="p">[</code><code class="n">m</code> <code class="k">for</code> <code class="n">m</code> <code class="ow">in</code> <code class="n">result</code><code class="o">.</code><code class="n">scalars</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">all</code><code class="p">(</code><code class="p">)</code><code class="p">]</code>

<code class="c1"># routers/conversations.py</code>

<code class="kn">from</code> <code class="nn">database</code> <code class="kn">import</code> <code class="n">DBSessionDep</code>
<code class="kn">from</code> <code class="nn">entities</code> <code class="kn">import</code> <code class="n">Message</code>
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">APIRouter</code>
<code class="kn">from</code> <code class="nn">schemas</code> <code class="kn">import</code> <code class="n">MessageOut</code>
<code class="kn">from</code> <code class="nn">services</code><code class="nn">.</code><code class="nn">conversations</code> <code class="kn">import</code> <code class="n">ConversationService</code>

<code class="n">router</code> <code class="o">=</code> <code class="n">APIRouter</code><code class="p">(</code><code class="n">prefix</code><code class="o">=</code><code class="s2">"</code><code class="s2">/conversations</code><code class="s2">"</code><code class="p">)</code>

<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">/</code><code class="si">{conversation_id}</code><code class="s2">/messages</code><code class="s2">"</code><code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO10-1" id="co_integrating_databases_into_ai_services_CO10-1"><img alt="1" src="assets/1.png"/></a>
<code class="k">async</code> <code class="k">def</code> <code class="nf">list_conversation_messages_controller</code><code class="p">(</code>
    <code class="n">conversation</code><code class="p">:</code> <code class="n">GetConversationDep</code><code class="p">,</code>
    <code class="n">session</code><code class="p">:</code> <code class="n">DBSessionDep</code><code class="p">,</code>
<code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">Message</code><code class="p">]</code><code class="p">:</code>
    <code class="n">messages</code> <code class="o">=</code> <code class="k">await</code> <code class="n">ConversationService</code><code class="p">(</code><code class="n">session</code><code class="p">)</code><code class="o">.</code><code class="n">list_messages</code><code class="p">(</code><code class="n">conversation</code><code class="o">.</code><code class="n">id</code><code class="p">)</code>
    <code class="k">return</code> <code class="p">[</code><code class="n">MessageOut</code><code class="o">.</code><code class="n">model_validate</code><code class="p">(</code><code class="n">m</code><code class="p">)</code> <code class="k">for</code> <code class="n">m</code> <code class="ow">in</code> <code class="n">messages</code><code class="p">]</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO10-1" id="callout_integrating_databases_into_ai_services_CO10-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Add a new endpoint to list messages of a conversation using the conversation ID.</p></dd>
</dl></div>

<p>You now have a fully working RESTful API for interacting with your conversation data following the repository and service patterns.</p>
<div data-type="tip"><h6>Tip</h6>
<p>Now that you’re more familiar with the repository and services pattern, you can try implementing CRUD endpoints for the <code>messages</code> table.</p>
</div>

<p>When using the repository and service patterns, be mindful that you avoid tightly coupling your services to specific repository implementation and not overload your services with many responsibilities.
Keep repositories focused on data access and manipulation and avoid placing business logic in them.</p>

<p>You’ll also need to handle database transactions and exceptions properly, especially when performing multiple related operations.
Also, consider performance implications of your queries such as including many JOINs, and optimize queries where you can.</p>

<p>Good practice is to use consistent naming conventions for your methods and classes and to avoid hard-coding configuration settings<a data-startref="ix_ch07-asciidoc21" data-type="indexterm" id="id957"/>.<a data-startref="ix_ch07-asciidoc19" data-type="indexterm" id="id958"/><a data-startref="ix_ch07-asciidoc18" data-type="indexterm" id="id959"/></p>

<p>There is one more aspect of the database development workflow that we need to address next.
That is managing ever-changing database schemas, in particular in collaborative teams where multiple people are working on the same database both in development and production environments.<a data-startref="ix_ch07-asciidoc7" data-type="indexterm" id="id960"/><a data-startref="ix_ch07-asciidoc6" data-type="indexterm" id="id961"/></p>
</div></section>
</div></section>






<section data-pdf-bookmark="Managing Database Schemas Changes" data-type="sect1"><div class="sect1" id="id111">
<h1>Managing Database Schemas Changes</h1>

<p><a data-primary="alembic package" data-type="indexterm" id="ix_ch07-asciidoc22"/><a data-primary="databases" data-secondary="managing schema changes" data-type="indexterm" id="ix_ch07-asciidoc23"/>You must have noticed that in <a data-type="xref" href="#sqlalchemy_engine">Example 7-3</a> you are deleting and re-creating your database tables every time you start your FastAPI server.
This is acceptable for development workflows during the prototyping stage, but not at all when you need to deploy your services in production with active users.
You can’t reset your database from scratch every time you update your database schema.</p>

<p>You also will probably need a way to revert changes if something breaks or if you decide to roll back certain features.
To achieve this, you can use a database migration tool such as Alembic that is designed to work seamlessly with the SQLAlchemy ORM.</p>

<p>Alembic allows you to version control your database schemas the same way that tools like Git can help you version control your code.
They’re extremely useful when you’re working in a team with multiple application environments and need to keep track of changes or revert updates as needed.</p>

<p>To get started, you must first install <code>alembic</code> via <code>pip</code> and then initialize it by running <a data-type="xref" href="#alembic_init">Example 7-11</a> at the root of your FastAPI project.</p>
<div data-type="example" id="alembic_init">
<h5><span class="label">Example 7-11. </span>Initializing an Alembic environment</h5>

<pre data-code-language="text" data-type="programlisting">$ alembic init</pre></div>

<p>Alembic will create its environment within the <code>alembic</code> folder with several files and a <code>versions</code> directory, as shown in <a data-type="xref" href="#alembic_dir">Example 7-12</a>.</p>
<div data-type="example" id="alembic_dir">
<h5><span class="label">Example 7-12. </span>Alembic environment within your project root directory</h5>

<pre data-code-language="text" data-type="programlisting"><code>project/
    alembic.ini
    alembic/
        env.py </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO11-1" id="co_integrating_databases_into_ai_services_CO11-1"><img alt="1" src="assets/1.png"/></a><code>
        README
        script.py.mako
        versions/ </code><a class="co" href="#callout_integrating_databases_into_ai_services_CO11-2" id="co_integrating_databases_into_ai_services_CO11-2"><img alt="2" src="assets/2.png"/></a><code>
            &lt;migration .py files will appear here&gt;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO11-1" id="callout_integrating_databases_into_ai_services_CO11-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>An environment file for specifying target schema and database connections</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO11-2" id="callout_integrating_databases_into_ai_services_CO11-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>A directory for holding <em>migrations</em> files, which specify the instructions on how to update or revert the database schema</p></dd>
</dl></div>

<p>Once the Alembic environment is generated, open and modify the <em>env.py</em> file located in the <code>alembic</code> directory, as shown in <a data-type="xref" href="#alembic_env">Example 7-13</a>, so that it gets access to your SQLAlchemy metadata object that contains the target schema information.</p>
<div data-type="example" id="alembic_env">
<h5><span class="label">Example 7-13. </span>Connect the Alembic environment with your SQLAlchemy models</h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># alembic/env.py</code>

<code class="kn">from</code> <code class="nn">entities</code> <code class="kn">import</code> <code class="n">Base</code>
<code class="kn">from</code> <code class="nn">settings</code> <code class="kn">import</code> <code class="n">AppSettings</code>

<code class="n">settings</code> <code class="o">=</code> <code class="n">AppSettings</code><code class="p">()</code>
<code class="n">target_metadata</code> <code class="o">=</code> <code class="n">Base</code>
<code class="n">db_url</code> <code class="o">=</code> <code class="nb">str</code><code class="p">(</code><code class="n">settings</code><code class="o">.</code><code class="n">pg_dsn</code><code class="p">)</code>

<code class="o">...</code></pre></div>

<p>With Alembic connected to your SQLAlchemy models, Alembic can now auto-generate your migration files by comparing the current schema of your database with your SQLAlchemy models:</p>

<pre data-code-language="bash" data-type="programlisting">$ alembic revision --autogenerate -m <code class="s2">"Initial Migration"</code><code class="w"/></pre>

<p>This command will compare the defined SQLAlchemy models against the existing database schema and automatically generate a SQL migration file under the 
<span class="keep-together"><code>alembic/versions</code></span> directory.</p>

<p>If you open the generated migration file, you should see a file content similar to <a data-type="xref" href="#alembic_initial_migration">Example 7-14</a>.</p>
<div data-type="example" id="alembic_initial_migration">
<h5><span class="label">Example 7-14. </span>The initial Alembic migration</h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># alembic/versions/24c35f32b152.py</code>

<code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">UTC</code><code class="p">,</code> <code class="n">datetime</code>
<code class="kn">import</code> <code class="nn">sqlalchemy</code> <code class="k">as</code> <code class="nn">sa</code>
<code class="kn">from</code> <code class="nn">alembic</code> <code class="kn">import</code> <code class="n">op</code>

<code class="sd">"""</code>
<code class="sd">Revision ID: 2413cf32b712 Revises:</code>
<code class="sd">Create Date: 2024-07-11 12:30:17.089406</code>
<code class="sd">"""</code>

<code class="c1"># revision identifiers, used by Alembic.</code>
<code class="n">revision</code> <code class="o">=</code> <code class="s2">"24c35f32b152"</code>
<code class="n">down_revision</code> <code class="o">=</code> <code class="kc">None</code>
<code class="n">branch_labels</code> <code class="o">=</code> <code class="kc">None</code>

<code class="k">def</code> <code class="nf">upgrade</code><code class="p">():</code>
    <code class="n">op</code><code class="o">.</code><code class="n">create_table</code><code class="p">(</code>
        <code class="s2">"conversations"</code><code class="p">,</code>
        <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="n">sa</code><code class="o">.</code><code class="n">BigInteger</code><code class="p">,</code> <code class="n">primary_key</code><code class="o">=</code><code class="kc">True</code><code class="p">),</code>
        <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"title"</code><code class="p">,</code> <code class="n">sa</code><code class="o">.</code><code class="n">String</code><code class="p">,</code> <code class="n">nullable</code><code class="o">=</code><code class="kc">False</code><code class="p">),</code>
        <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"model_type"</code><code class="p">,</code> <code class="n">sa</code><code class="o">.</code><code class="n">String</code><code class="p">,</code> <code class="n">index</code><code class="o">=</code><code class="kc">True</code><code class="p">,</code> <code class="n">nullable</code><code class="o">=</code><code class="kc">False</code><code class="p">),</code>
        <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code>
            <code class="s2">"created_at"</code><code class="p">,</code> <code class="n">sa</code><code class="o">.</code><code class="n">DateTime</code><code class="p">,</code> <code class="n">default</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">),</code> <code class="n">nullable</code><code class="o">=</code><code class="kc">False</code>
        <code class="p">),</code>
        <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code>
            <code class="s2">"updated_at"</code><code class="p">,</code>
            <code class="n">sa</code><code class="o">.</code><code class="n">DateTime</code><code class="p">,</code>
            <code class="n">default</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">),</code>
            <code class="n">onupdate</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">),</code>
            <code class="n">nullable</code><code class="o">=</code><code class="kc">False</code><code class="p">,</code>
        <code class="p">),</code>
    <code class="p">)</code>

    <code class="n">op</code><code class="o">.</code><code class="n">create_table</code><code class="p">(</code>
        <code class="s2">"messages"</code><code class="p">,</code>
        <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="n">sa</code><code class="o">.</code><code class="n">BigInteger</code><code class="p">,</code> <code class="n">primary_key</code><code class="o">=</code><code class="kc">True</code><code class="p">),</code>
        <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code>
            <code class="s2">"conversation_id"</code><code class="p">,</code>
            <code class="n">sa</code><code class="o">.</code><code class="n">BigInteger</code><code class="p">,</code>
            <code class="n">sa</code><code class="o">.</code><code class="n">ForeignKey</code><code class="p">(</code><code class="s2">"conversations.id"</code><code class="p">,</code> <code class="n">ondelete</code><code class="o">=</code><code class="s2">"CASCADE"</code><code class="p">),</code>
            <code class="n">index</code><code class="o">=</code><code class="kc">True</code><code class="p">,</code>
            <code class="n">nullable</code><code class="o">=</code><code class="kc">False</code><code class="p">,</code>
        <code class="p">),</code>
        <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"prompt_content"</code><code class="p">,</code> <code class="n">sa</code><code class="o">.</code><code class="n">Text</code><code class="p">,</code> <code class="n">nullable</code><code class="o">=</code><code class="kc">False</code><code class="p">),</code>
        <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"response_content"</code><code class="p">,</code> <code class="n">sa</code><code class="o">.</code><code class="n">Text</code><code class="p">,</code> <code class="n">nullable</code><code class="o">=</code><code class="kc">False</code><code class="p">),</code>
        <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"prompt_tokens"</code><code class="p">,</code> <code class="n">sa</code><code class="o">.</code><code class="n">Integer</code><code class="p">,</code> <code class="n">nullable</code><code class="o">=</code><code class="kc">True</code><code class="p">),</code>
        <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"response_tokens"</code><code class="p">,</code> <code class="n">sa</code><code class="o">.</code><code class="n">Integer</code><code class="p">,</code> <code class="n">nullable</code><code class="o">=</code><code class="kc">True</code><code class="p">),</code>
        <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"total_tokens"</code><code class="p">,</code> <code class="n">sa</code><code class="o">.</code><code class="n">Integer</code><code class="p">,</code> <code class="n">nullable</code><code class="o">=</code><code class="kc">True</code><code class="p">),</code>
        <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"is_success"</code><code class="p">,</code> <code class="n">sa</code><code class="o">.</code><code class="n">Boolean</code><code class="p">,</code> <code class="n">nullable</code><code class="o">=</code><code class="kc">True</code><code class="p">),</code>
        <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s2">"status_code"</code><code class="p">,</code> <code class="n">sa</code><code class="o">.</code><code class="n">Integer</code><code class="p">,</code> <code class="n">nullable</code><code class="o">=</code><code class="kc">True</code><code class="p">),</code>
        <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code>
            <code class="s2">"created_at"</code><code class="p">,</code> <code class="n">sa</code><code class="o">.</code><code class="n">DateTime</code><code class="p">,</code> <code class="n">default</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">),</code> <code class="n">nullable</code><code class="o">=</code><code class="kc">False</code>
        <code class="p">),</code>
        <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code>
            <code class="s2">"updated_at"</code><code class="p">,</code>
            <code class="n">sa</code><code class="o">.</code><code class="n">DateTime</code><code class="p">,</code>
            <code class="n">default</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">),</code>
            <code class="n">onupdate</code><code class="o">=</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">UTC</code><code class="p">),</code>
            <code class="n">nullable</code><code class="o">=</code><code class="kc">False</code><code class="p">,</code>
        <code class="p">),</code>
    <code class="p">)</code>

<code class="k">def</code> <code class="nf">downgrade</code><code class="p">():</code>
    <code class="n">op</code><code class="o">.</code><code class="n">drop_table</code><code class="p">(</code><code class="s2">"messages"</code><code class="p">)</code>
    <code class="n">op</code><code class="o">.</code><code class="n">drop_table</code><code class="p">(</code><code class="s2">"conversations"</code><code class="p">)</code></pre></div>

<p>Now that you’ve updated your first migration file, you’re ready to run it against the database:</p>

<pre data-code-language="bash" data-type="programlisting">$ alembic upgrade head<code class="w"/></pre>

<p>If your ever need to revert the operation, you can run <code>alembic downgrade</code>
instead.</p>

<p>What Alembic does under the hood is to generate the raw SQL needed to run or revert a migration and create an
<code>alembic_versions</code> table in the database.
It uses this table to keep track of migrations that have already been applied on your database so that rerunning the <code>alembic upgrade head</code> command won’t perform any duplicate migrations.</p>

<p>If in any case, your database schemas and your migration history drift away, you can always remove files from the <code>versions</code> directory and truncate the
<code>alembic_revision</code> table.
Then reinitialize Alembic to start with a fresh environment against an existing database.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>After migrating a database with a migration file, make sure to commit to a Git repository.
Avoid re-editing migration files after migrating a database as Alembic will skip existing migrations by cross-checking them with its versioning table.</p>

<p>If a migration file has already been run, it won’t detect changes in its content.</p>

<p>To update your database schema, create a new migration file instead.</p>
</div>

<p>Following the aforementioned workflow will now allow you to not only version control your database schemas but also manage changes to your production environments as your application requirements change.<a data-startref="ix_ch07-asciidoc23" data-type="indexterm" id="id962"/><a data-startref="ix_ch07-asciidoc22" data-type="indexterm" id="id963"/></p>
</div></section>






<section data-pdf-bookmark="Storing Data When Working with Real-Time Streams" data-type="sect1"><div class="sect1" id="id112">
<h1>Storing Data When Working with Real-Time Streams</h1>

<p><a data-primary="databases" data-secondary="storing data when working with real-time streams" data-type="indexterm" id="ix_ch07-asciidoc24"/>You should now be in a position to implement your own CRUD endpoints to retrieve and mutate both user conversation and message records in your database.</p>

<p>One question that remains unanswered is how to handle transactions within data streaming endpoints, such as an LLM streaming outputs to a client.</p>

<p>You can’t stream data into a traditional relational database as ensuring ACID compliance with streaming transactions will prove challenging.
Instead, you will want to perform your standard database operation as soon as your FastAPI server returns a response to the client.
This challenge is exactly what a FastAPI’s background task can solve, as you can see in <a data-type="xref" href="#db_stream">Example 7-15</a>.</p>
<div data-type="example" id="db_stream">
<h5><span class="label">Example 7-15. </span>Storing content of an LLM output stream</h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># main.py</code>

<code class="kn">from</code> <code class="nn">itertools</code> <code class="kn">import</code> <code class="n">tee</code>
<code class="kn">from</code> <code class="nn">database</code> <code class="kn">import</code> <code class="n">DBSessionDep</code>
<code class="kn">from</code> <code class="nn">entities</code> <code class="kn">import</code> <code class="n">Message</code>
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">BackgroundTasks</code><code class="p">,</code> <code class="n">Depends</code>
<code class="kn">from</code> <code class="nn">fastapi</code><code class="nn">.</code><code class="nn">responses</code> <code class="kn">import</code> <code class="n">StreamingResponse</code>
<code class="kn">from</code> <code class="nn">repositories</code><code class="nn">.</code><code class="nn">conversations</code> <code class="kn">import</code> <code class="n">Conversation</code>
<code class="kn">from</code> <code class="nn">repositories</code><code class="nn">.</code><code class="nn">messages</code> <code class="kn">import</code> <code class="n">MessageRepository</code>
<code class="kn">from</code> <code class="nn">sqlalchemy</code><code class="nn">.</code><code class="nn">ext</code><code class="nn">.</code><code class="nn">asyncio</code> <code class="kn">import</code> <code class="n">AsyncSession</code>

<code class="k">async</code> <code class="k">def</code> <code class="nf">store_message</code><code class="p">(</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO12-1" id="co_integrating_databases_into_ai_services_CO12-1"><img alt="1" src="assets/1.png"/></a>
    <code class="n">prompt_content</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code>
    <code class="n">response_content</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code>
    <code class="n">conversation_id</code><code class="p">:</code> <code class="nb">int</code><code class="p">,</code>
    <code class="n">session</code><code class="p">:</code> <code class="n">AsyncSession</code><code class="p">,</code>
<code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="kc">None</code><code class="p">:</code>
    <code class="n">message</code> <code class="o">=</code> <code class="n">Message</code><code class="p">(</code>
        <code class="n">conversation_id</code><code class="o">=</code><code class="n">conversation_id</code><code class="p">,</code>
        <code class="n">prompt_content</code><code class="o">=</code><code class="n">prompt_content</code><code class="p">,</code>
        <code class="n">response_content</code><code class="o">=</code><code class="n">response_content</code><code class="p">,</code>
    <code class="p">)</code>
    <code class="k">await</code> <code class="n">MessageRepository</code><code class="p">(</code><code class="n">session</code><code class="p">)</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">message</code><code class="p">)</code>

<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">/text/generate/stream</code><code class="s2">"</code><code class="p">)</code>
<code class="k">async</code> <code class="k">def</code> <code class="nf">stream_llm_controller</code><code class="p">(</code>
    <code class="n">prompt</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code>
    <code class="n">background_task</code><code class="p">:</code> <code class="n">BackgroundTasks</code><code class="p">,</code>
    <code class="n">session</code><code class="p">:</code> <code class="n">DBSessionDep</code><code class="p">,</code>
    <code class="n">conversation</code><code class="p">:</code> <code class="n">Conversation</code> <code class="o">=</code> <code class="n">Depends</code><code class="p">(</code><code class="n">get_conversation</code><code class="p">)</code><code class="p">,</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO12-2" id="co_integrating_databases_into_ai_services_CO12-2"><img alt="2" src="assets/2.png"/></a>
<code class="p">)</code> <code class="o">-</code><code class="o">&gt;</code> <code class="n">StreamingResponse</code><code class="p">:</code>
    <code class="c1"># Invoke LLM and obtain the response stream</code>
    <code class="o">.</code><code class="o">.</code><code class="o">.</code>
    <code class="n">stream_1</code><code class="p">,</code> <code class="n">stream_2</code> <code class="o">=</code> <code class="n">tee</code><code class="p">(</code><code class="n">response_stream</code><code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO12-3" id="co_integrating_databases_into_ai_services_CO12-3"><img alt="3" src="assets/3.png"/></a>
    <code class="n">background_task</code><code class="o">.</code><code class="n">add_task</code><code class="p">(</code>
        <code class="n">store_message</code><code class="p">,</code> <code class="n">prompt</code><code class="p">,</code> <code class="s2">"</code><code class="s2">"</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">stream_1</code><code class="p">)</code><code class="p">,</code> <code class="n">conversation</code><code class="o">.</code><code class="n">id</code><code class="p">,</code> <code class="n">session</code>
    <code class="p">)</code> <a class="co" href="#callout_integrating_databases_into_ai_services_CO12-4" id="co_integrating_databases_into_ai_services_CO12-4"><img alt="4" src="assets/4.png"/></a>
    <code class="k">return</code> <code class="n">StreamingResponse</code><code class="p">(</code><code class="n">stream_2</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO12-1" id="callout_integrating_databases_into_ai_services_CO12-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Create a function to store a message against a conversation.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO12-2" id="callout_integrating_databases_into_ai_services_CO12-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Check that the conversation record exists and fetch it within a dependency.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO12-3" id="callout_integrating_databases_into_ai_services_CO12-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Create two separate copies of the LLM stream, one for the <code>StreamingResponse</code> and another to process in a background task.</p></dd>
<dt><a class="co" href="#co_integrating_databases_into_ai_services_CO12-4" id="callout_integrating_databases_into_ai_services_CO12-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Create a background task to store the message after the <code>StreamingResponse</code> is finished.</p></dd>
</dl></div>

<p>In <a data-type="xref" href="#db_stream">Example 7-15</a>, you allow FastAPI to fully stream the LLM response to the client.</p>

<p>It won’t matter whether you’re using an SSE or WebSocket endpoint.
Once a request a response is fully streamed, invoke a background task passing in the full stream response content.
Within the background task, you can then run a function to store the message after the request is sent, with the full LLM response content.</p>

<p>Using the same approach, you can even generate a title for a conversation based on the content of the first message.
To do this, you can invoke the LLM again with the content of the first message in the conversation, requesting for an appropriate title for the conversation.
Once a conversation title is generated, you can create the conversation record in the database, as shown in <a data-type="xref" href="#conversation_title">Example 7-16</a>.</p>
<div data-type="example" id="conversation_title">
<h5><span class="label">Example 7-16. </span>Using the LLM to generate conversation titles based on the initial user prompt</h5>

<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">entities</code> <code class="kn">import</code> <code class="n">Conversation</code>
<code class="kn">from</code> <code class="nn">openai</code> <code class="kn">import</code> <code class="n">AsyncClient</code>
<code class="kn">from</code> <code class="nn">repositories.conversations</code> <code class="kn">import</code> <code class="n">ConversationRepository</code>
<code class="kn">from</code> <code class="nn">sqlalchemy.ext.asyncio</code> <code class="kn">import</code> <code class="n">AsyncSession</code>

<code class="n">async_client</code> <code class="o">=</code> <code class="n">AsyncClient</code><code class="p">(</code><code class="o">...</code><code class="p">)</code>

<code class="k">async</code> <code class="k">def</code> <code class="nf">create_conversation</code><code class="p">(</code>
    <code class="n">initial_prompt</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code> <code class="n">session</code><code class="p">:</code> <code class="n">AsyncSession</code>
<code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Conversation</code><code class="p">:</code>
    <code class="n">completion</code> <code class="o">=</code> <code class="k">await</code> <code class="n">async_client</code><code class="o">.</code><code class="n">chat</code><code class="o">.</code><code class="n">completions</code><code class="o">.</code><code class="n">create</code><code class="p">(</code>
        <code class="n">messages</code><code class="o">=</code><code class="p">[</code>
            <code class="p">{</code>
                <code class="s2">"role"</code><code class="p">:</code> <code class="s2">"system"</code><code class="p">,</code>
                <code class="s2">"content"</code><code class="p">:</code> <code class="s2">"Suggest a title for the conversation "</code>
                           <code class="s2">"based on the user prompt"</code><code class="p">,</code>
            <code class="p">},</code>
            <code class="p">{</code>
                <code class="s2">"role"</code><code class="p">:</code> <code class="s2">"user"</code><code class="p">,</code>
                <code class="s2">"content"</code><code class="p">:</code> <code class="n">initial_prompt</code><code class="p">,</code>
            <code class="p">},</code>
        <code class="p">],</code>
        <code class="n">model</code><code class="o">=</code><code class="s2">"gpt-3.5-turbo"</code><code class="p">,</code>
    <code class="p">)</code>
    <code class="n">title</code> <code class="o">=</code> <code class="n">completion</code><code class="o">.</code><code class="n">choices</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="o">.</code><code class="n">message</code><code class="o">.</code><code class="n">content</code>
    <code class="n">conversation</code> <code class="o">=</code> <code class="n">Conversation</code><code class="p">(</code>
        <code class="n">title</code><code class="o">=</code><code class="n">title</code><code class="p">,</code>
        <code class="c1"># add other conversation properties</code>
        <code class="o">...</code>
    <code class="p">)</code>
    <code class="k">return</code> <code class="k">await</code> <code class="n">ConversationRepository</code><code class="p">(</code><code class="n">session</code><code class="p">)</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">conversation</code><code class="p">)</code></pre></div>

<p>Using SQLAlchemy with Alembic is a tried and tested approach to working with relational databases in FastAPI, so you’re more likely to find a lot of resources on integrating these technologies.</p>

<p>Both the SQLAlchemy ORM and Alembic allow you to interact with your database and control the changes to its schemas.<a data-startref="ix_ch07-asciidoc24" data-type="indexterm" id="id964"/></p>
</div></section>






<section class="less_space pagebreak-before" data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="id113">
<h1>Summary</h1>

<p>In this chapter, you dove into the critical aspects of integrating a database into your FastAPI application to store and retrieve user conversations.</p>

<p>You learned to identify when a database is necessary and how to identify the appropriate type for your project, whether it be relational or nonrelational.
By understanding the underlying mechanisms of relational databases and the use cases for nonrelational databases, you’re now equipped to make informed decisions about database selection.</p>

<p>You also explored the development workflow, tooling, and best practices for working with relational databases.
This includes learning techniques to improve query performance and efficiency, as well as strategies for managing evolving database schema changes.
Additionally, you gained insights into managing codebase, database schema, and data drifts when working in teams.<a data-startref="ix_ch07-asciidoc1" data-type="indexterm" id="id965"/><a data-startref="ix_ch07-asciidoc0" data-type="indexterm" id="id966"/></p>

<p>As you move forward, the next chapter will guide you through implementing user management, authentication, and authorization mechanisms.
This will further enhance your application’s security and user experience, building on the solid database foundation you’ve established in this chapter.</p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="id951"><sup><a href="ch07.html#id951-marker">1</a></sup> Refer to this <a href="https://oreil.ly/OMaOT">reddit discussion thread</a>.</p></div></div></section></body></html>
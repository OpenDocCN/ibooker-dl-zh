# 第20章 隐私、安全和部署

在阅读本书之前的章节后，您希望能够构建一个依赖于机器学习的嵌入式应用程序。然而，要将您的项目转化为可以成功部署到世界上的产品，您仍然需要应对许多挑战。保护用户的隐私和安全是两个关键挑战。本章介绍了一些我们发现有用的方法来克服这些挑战。

# 隐私

设备上的机器学习依赖于传感器输入。其中一些传感器，如麦克风和摄像头，引发了明显的隐私问题，但甚至其他传感器，如加速计，也可能被滥用；例如，通过识别个人的步态来识别他们在使用您的产品时。作为工程师，我们都有责任保护用户免受产品可能造成的损害，因此在设计的各个阶段都要考虑隐私是至关重要的。处理敏感用户数据还涉及法律责任，超出了我们的范围，但您应该咨询您的律师。如果您是大型组织的一部分，您可能有隐私专家和流程可以帮助您获得专业知识。即使您无法获得这些资源，您也应该花一些时间在项目开始时进行自己的隐私审查，并定期重新审查，直到项目上线。关于“隐私审查”到底是什么，目前还没有广泛的共识，但我们讨论了一些最佳实践，其中大部分围绕着建立强大的隐私设计文档（PDD）。

## 隐私设计文档

[隐私工程](https://oreil.ly/MEwUE)领域仍然非常新颖，很难找到关于如何处理产品隐私影响的文档。许多大公司处理确保应用程序隐私的过程的方式是创建一个隐私设计文档。这是一个单一的地方，您可以涵盖产品的重要隐私方面。您的文档应包括以下各小节提到的所有主题的信息。

### 数据收集

PDD的第一部分应涵盖您将收集的数据、如何收集以及为什么收集。您应尽可能具体，并使用简单的英语，例如，“收集温度和湿度”而不是“获取环境大气信息”。在处理这一部分时，您还有机会思考您实际收集了什么，并确保这是您产品所需的最小数据。如果您只是在听大声噪音以唤醒更复杂的设备，您是否真的需要使用麦克风以16 KHz采样音频，还是可以使用一个更简单的传感器，确保即使发生安全漏洞也无法录制语音？在这一部分中，一个简单的系统图可以很有用，显示信息在产品中不同组件之间的流动（包括任何云API）。这一部分的总体目标是向非技术人员提供对您将收集的内容的良好概述，无论是您的律师、高管还是董事会成员。一个思考方式是，如果由一位不友好的记者撰写的故事登在报纸头版上，会是什么样子。确保您已尽一切可能减少用户受到他人恶意行为的影响。具体而言，思考“一个虐待前任可能使用这项技术做什么？”等情景，并尽可能富有想象力，确保内置了尽可能多的保护措施。

### 数据使用

在收集数据后，对数据做了什么？例如，许多初创公司都会被诱惑利用用户数据来训练他们的机器学习模型，但从隐私角度来看，这是一个极其棘手的过程，因为它需要长时间存储和处理潜在非常敏感的信息，仅为间接用户利益。我们强烈建议将训练数据采集视为一个完全独立的程序，使用明确同意的付费提供者，而不是收集数据作为产品使用的副作用。

在设备上进行机器学习的好处之一是您有能力在本地处理敏感数据并仅共享聚合结果。例如，您可能有一个行人计数设备，每秒捕获图像，但传输的唯一数据是看到的人和车辆的计数。如果可以的话，尽量设计您的硬件以确保这些保证不会被打破。如果您只使用224×224像素图像作为分类算法的输入，使用一个分辨率低的摄像头传感器，以便无法识别面孔或车牌。如果您计划仅传输几个值作为摘要（如行人计数），请仅支持低比特率的无线技术，以避免即使您的设备被黑客入侵也无法传输源视频。我们希望未来，专用硬件将有助于执行这些保证，但即使现在，在系统设计层面仍有很多事情可以做，以避免过度设计并使滥用更加困难。

### 数据共享和存储

谁可以访问您收集的数据？有什么系统可以确保只有这些人可以看到它？数据会保留多长时间，无论是在设备上还是在云端？如果数据被保留了一段时间，删除政策是什么？您可能认为存储剥离了明显用户ID（如电子邮件地址或姓名）的信息是安全的，但身份可以从许多来源推导出，比如IP地址、可识别的声音，甚至步态，因此您应该假设您收集的任何传感器数据都是个人可识别信息（PII）。最佳政策是将这种类型的PII视为放射性废物。如果可能的话，避免收集它，当您需要时要妥善保护它，并在完成后尽快处理它。

在考虑谁可以访问时，不要忘记所有您的许可系统都可以被政府压力覆盖，这可能会给您的用户在压制国家造成严重伤害。这是限制传输和存储到最低限度的另一个原因，以避免这种责任并限制用户的暴露。

### 同意

使用您的产品的人是否了解它正在收集什么信息，并且他们是否同意您将如何使用它？这里有一个狭窄的法律问题，您可能认为可以通过点击式最终用户许可协议来回答，但我们鼓励您将其更广泛地看作是一个营销挑战。假设您相信产品的好处值得收集更多数据，那么您如何清晰地向潜在客户传达这一点，以便他们做出知情选择？如果您在构思这条信息时遇到困难，那就是您应该重新考虑设计以减少隐私影响或增加产品的好处的迹象。

## 使用PDD

您应该将PDD视为一份不断更新的活动文件，随着产品的发展而不断更新。显然，它对于向您的律师和其他业务利益相关者传达产品细节非常有用，但它在许多其他情境下也很有用。例如，您应该与您的营销团队合作，以确保其传达的信息是基于您正在做的事情，并与任何第三方服务提供商（如广告）合作，以确保他们遵守您所承诺的内容。团队中的所有工程师都应该可以访问它并添加评论，因为在实施层面可能会有一些隐藏的隐私影响。例如，您可能正在使用一个泄漏设备IP地址的地理编码云API，或者您的微控制器上可能有一个未使用但理论上可以启用以传输敏感数据的WiFi芯片。

# 安全性

确保嵌入式设备的总体安全性非常困难。攻击者可以轻易获得系统的物理控制权，然后使用各种侵入性技术来提取信息。您的第一道防线是确保尽可能少的敏感信息保留在您的嵌入式系统上，这就是为什么PDD如此重要。如果您依赖与云服务的安全通信，您应该考虑调查[安全加密处理器](https://oreil.ly/lGLzA)以确保任何密钥都安全保存。这些芯片还可以用于安全引导，以确保只有您刷写的程序才能在设备上运行。

与隐私一样，您应该努力设计硬件，以限制任何攻击者的机会。如果您不需要WiFi或蓝牙，构建一个没有这些功能的设备。[不要在发货产品上提供像SWD这样的调试接口](https://oreil.ly/X1I7x)，并研究[在Arm平台上禁用代码读取](https://oreil.ly/ag5Vc)。尽管这些措施[并不完美](https://oreil.ly/R3YG-)，但它们会增加攻击的成本。

您还应该尽量依赖已建立的库和服务来进行安全和加密。自行开发加密是一个非常糟糕的主意，因为很容易犯错误，而这些错误很难发现，但会破坏系统的安全性。嵌入式系统安全的全部挑战超出了本书的范围，但您应该考虑创建一个安全设计文档，类似于我们为隐私推荐的文档。您应该涵盖您认为可能的攻击、它们的影响以及您将如何防御它们。

## 保护模型

我们经常听到工程师们担心保护他们的机器学习模型免受不道德的竞争对手的侵害，因为这些模型需要大量工作来创建，但却被部署在设备上并且通常以易于理解的格式存在。坏消息是，没有绝对的保护免受复制。在这方面，模型就像任何其他软件：它们可以被窃取和检查，就像常规的机器码一样。然而，就像软件一样，问题并不像一开始看起来那么糟糕。就像反汇编过程式程序不会显示真正的源代码一样，检查量化模型也不会提供任何访问训练算法或数据的途径，因此攻击者将无法有效地修改模型以供其他用途。如果模型被部署在竞争对手的设备上，直接复制模型应该很容易被发现，并且可以在法律上证明竞争对手窃取了您的知识产权，就像您可以对任何其他软件做的那样。

让对您的模型进行非正式攻击变得更加困难可能是值得的。一种简单的技术是使用私钥对序列化模型进行XOR后存储在闪存中，然后在使用之前将其复制到RAM并解密。这将防止简单地转储闪存来揭示您的模型，但在运行时具有RAM访问权限的攻击者仍将能够访问它。您可能认为切换到专有格式而不是TensorFlow Lite FlatBuffer会有所帮助，但由于权重参数本身是大量数值数组，并且从调试器中逐步了解调用哪些操作以及顺序，我们发现这种混淆的价值非常有限。

###### 注意

一种有趣的方法用于发现模型被盗用是在训练过程中故意引入微小缺陷，然后在检查疑似侵权时寻找它们。例如，您可以训练一个唤醒词检测模型，不仅监听“Hello”，还秘密监听“Ahoy, sailor!”。独立训练的模型极不可能对相同短语做出响应，因此如果有响应，这是模型被复制的强烈信号，即使您无法访问设备的内部工作原理。这种技术基于在参考作品中包含虚构条目的古老想法，例如地图、目录和字典，以帮助发现侵犯版权；它已经被称为*mountweazeling*，源自在地图上放置虚构山峰“Mountweazel”来帮助识别副本的做法。

# 部署

使用现代微控制器很容易启用空中更新，这样您就可以随时修改设备上运行的代码，甚至在发货后很久。这为安全和隐私侵犯打开了一个广泛的攻击面，我们敦促您考虑是否对您的产品真正必不可少。如果没有经过良好设计的安全引导系统和其他保护措施，很难确保只有您有能力上传新代码，如果出现错误，您就将完全将设备的控制权交给了恶意行为者。作为默认设置，我们建议在设备制造后不允许任何形式的代码更新。这可能听起来严厉，因为它阻止了修复安全漏洞的更新，但在几乎所有情况下，消除攻击者代码在系统上运行的可能性将更有利于安全，而不是有害。这也简化了网络架构，因为不再需要任何协议“监听”更新；设备可能有效地能够在仅传输模式下运行，这也大大减少了攻击面。

这意味着在设备发布之前，您需要更多地承担编写正确代码的责任，特别是关于模型准确性。我们之前谈到过像单元测试和针对专用测试集验证整体模型准确性等方法，但它们不会捕捉到所有问题。当您准备发布时，我们强烈建议使用一种自用方法，在这种方法中，您可以在真实环境中尝试设备，但在组织内部人员的监督下进行。这些实验更有可能揭示意外行为，而不是工程测试，因为测试受到其创建者的想象力的限制，而现实世界比我们任何人都能提前预测的要惊人得多。好消息是，在遇到不良行为之后，您可以将其转化为可以作为正常开发过程的一部分解决的测试用例。事实上，开发这种深入了解产品需求的机构记忆，并将其编码为测试，可能是您最大的竞争优势之一，因为获得这种优势的唯一方法是通过痛苦的试错。

## 从开发板转向产品

将在开发板上运行的应用程序转变为成品的完整过程超出了本书的范围，但在开发过程中有一些值得考虑的事项。您应该研究您考虑使用的微控制器的批量价格，例如在[Digi-Key](https://digikey.com)等网站上，以确保您最终的目标系统符合您的预算。假设您在开发过程中使用的是相同的芯片，将代码移植到生产设备应该相当简单，因此从编程的角度来看，主要任务是确保您的开发板与生产目标匹配。在您的代码以最终形式部署后，调试任何出现的问题将变得更加困难，尤其是如果您之前已经采取了保护平台的步骤，因此尽可能推迟这一步骤是值得的。

# 总结

保护用户的隐私和安全是我们作为工程师的最重要责任之一，但如何决定最佳方法并不总是清晰的。在本章中，我们涵盖了思考和设计保护措施的基本过程，以及一些更高级的安全考虑。通过这些内容，我们完成了构建和部署嵌入式机器学习应用的基础，但我们知道这个领域远不止我们在一本书中能涵盖的内容。最后一章讨论了您可以使用的资源，以继续学习更多。

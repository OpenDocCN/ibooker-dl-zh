["```py\n.../ai-project (main) $ cd chapter13\n.../chapter13 (main) $ touch requirements.txt\n```", "```py\n#model training\nscikit-learn ![1](assets/1.png)\nnumpy ![2](assets/2.png)\npandas ![3](assets/3.png)\nskl2onnx ![4](assets/4.png)\npydantic>=2.4.0\nfastapi[standard]>=0.115.0\nuvicorn>=0.23.0 ![5](assets/5.png)\nonnxruntime ![6](assets/6.png)\n```", "```py\n.../chapter13 (main) $ pip3 install -r requirements.txt\n```", "```py\n.../ai-project (main) $ cd chapter13\n.../chapter13 (main) $ touch player_acquisition_model.ipynb\n```", "```py\n# Player Acquisition Models\n*This notebook is used to train a machine learning model using scikit-learn\nand save it in ONNX format.*\n```", "```py\n## Library imports\n```", "```py\nimport logging\nimport numpy as np\nimport pandas as pd\nfrom sklearn.model_selection import train_test_split ![1](assets/1.png)\nfrom sklearn.ensemble import GradientBoostingRegressor ![2](assets/2.png)\n\nfrom skl2onnx import to_onnx\nimport onnxruntime as rt\n```", "```py\n## Configure logging\n```", "```py\nfor handler in logging.root.handlers[:]: ![1](assets/1.png)\n    logging.root.removeHandler(handler)\n\nlogging.basicConfig(\n    filename='player_acquisition_notebook.log',\n    level=logging.INFO,  ![2](assets/2.png)\n)\n```", "```py\n## Load data\n```", "```py\ndataset=pd.read_csv(\"player_training_data_full.csv\")\n```", "```py\n## Prepare and split data\n```", "```py\nX = dataset[['waiver_value_tier','fantasy_regular_season_weeks_remaining',\n            'league_budget_pct_remaining']] ![1](assets/1.png)\ny = dataset['winning_bid_dollars'] ![2](assets/2.png)\nX_train, X_test, y_train, y_test = train_test_split(X, ![3](assets/3.png)\n                                                    y,\n                                                    test_size = 0.20, ![4](assets/4.png)\n                                                    random_state = 0) ![5](assets/5.png)\n```", "```py\n## Creating and fitting models\n```", "```py\nmodel_10th_percentile = GradientBoostingRegressor(loss=\"quantile\", alpha=0.1) ![1](assets/1.png)\nmodel_50th_percentile = GradientBoostingRegressor(loss=\"quantile\", alpha=0.5)\nmodel_90th_percentile = GradientBoostingRegressor(loss=\"quantile\", alpha=0.9)\n\nmodel_10th_percentile.fit(X_train, y_train) ![2](assets/2.png)\nmodel_50th_percentile.fit(X_train, y_train)\nmodel_90th_percentile.fit(X_train, y_train)\n```", "```py\n## Convert and save these models in ONNX format\n```", "```py\nX_array = np.column_stack((X['waiver_value_tier'],  ![1](assets/1.png)\n                           X['fantasy_regular_season_weeks_remaining'],\n                           X['league_budget_pct_remaining']))\n\nonx = to_onnx(model_10th_percentile, X_array[:1]) ![2](assets/2.png)\nwith open(\"acquisition_model_10.onnx\", \"wb\") as f:![3](assets/3.png)\n    f.write(onx.SerializeToString())\n\nonx = to_onnx(model_50th_percentile, X_array[:1])\nwith open(\"acquisition_model_50.onnx\", \"wb\") as f:\n    f.write(onx.SerializeToString())\n\nonx = to_onnx(model_90th_percentile, X_array[:1])\nwith open(\"acquisition_model_90.onnx\", \"wb\") as f:\n    f.write(onx.SerializeToString())\n```", "```py\n.../chapter13 (main) $ touch schemas.py\n```", "```py\n\"\"\"Pydantic schemas\"\"\"\nfrom pydantic import BaseModel ![1](assets/1.png)\n\nclass FantasyAcquisitionFeatures(BaseModel): ![2](assets/2.png)\n    waiver_value_tier: int\n    fantasy_regular_season_weeks_remaining: int\n    league_budget_pct_remaining: int\n\nclass PredictionOutput(BaseModel): ![3](assets/3.png)\n    winning_bid_10th_percentile: float\n    winning_bid_50th_percentile: float\n    winning_bid_90th_percentile: float\n```", "```py\n.../chapter13 (main) $ touch main.py\n```", "```py\n\"\"\"Fantasy acquisition API\"\"\"\n\nfrom fastapi import FastAPI\nimport onnxruntime as rt ![1](assets/1.png)\nimport numpy as np\nfrom schemas import FantasyAcquisitionFeatures, PredictionOutput  ![2](assets/2.png)\n\napi_description = \"\"\"\nThis API predicts the range of costs to acquire a player in fantasy football\n\nThe endpoints are grouped into the following categories:\n\n## Analytics\nGet information about health of the API.\n\n## Prediction\nGet predictions of player acquisition cost.\n\"\"\"\n```", "```py\n# Load the ONNX model\nsess_10 = rt.InferenceSession(\"acquisition_model_10.onnx\",\n                             providers=[\"CPUExecutionProvider\"]) ![1](assets/1.png)\nsess_50 = rt.InferenceSession(\"acquisition_model_50.onnx\",\n                             providers=[\"CPUExecutionProvider\"])\nsess_90 = rt.InferenceSession(\"acquisition_model_90.onnx\",\n                             providers=[\"CPUExecutionProvider\"])\n\n# Get the input and output names of the model\ninput_name_10 = sess_10.get_inputs()[0].name ![2](assets/2.png)\nlabel_name_10 = sess_10.get_outputs()[0].name ![3](assets/3.png)\ninput_name_50 = sess_50.get_inputs()[0].name\nlabel_name_50 = sess_50.get_outputs()[0].name\ninput_name_90 = sess_90.get_inputs()[0].name\nlabel_name_90 = sess_90.get_outputs()[0].name\n```", "```py\napp = FastAPI( ![1](assets/1.png)\n    description=api_description,\n    title=\"Fantasy acquisition API\",\n    version=\"0.1\",\n)\n\n@app.get( ![2](assets/2.png)\n    \"/\",\n    summary=\"Check to see if the Fantasy acquisition API is running\",\n    description=\"\"\"Use this endpoint to check if the API is running. You can \n    also check it first before making other calls to be sure it's running.\"\"\",\n    response_description=\"A JSON record with a message in it. If the API is\n    running the message will say successful.\",\n    operation_id=\"v0_health_check\",\n    tags=[\"analytics\"],\n)\ndef root(): ![3](assets/3.png)\n    return {\"message\": \"API health check successful\"} \n```", "```py\n# Define the prediction route\n@app.post(\"/predict/\",  ![1](assets/1.png)\n          response_model=PredictionOutput,![2](assets/2.png)\n          summary=\"Predict the cost of acquiring a player\",\n          description=\"\"\"Use this endpoint to predict the range of cost to \n          acquire a player in fantasy football.\"\"\",\n          response_description=\"\"\"A JSON record three predicted amounts. \n          Together they give a possible range of acquisition costs for a \n          player.\"\"\",\n          operation_id=\"v0_predict\",\n          tags=[\"prediction\"],\n)\ndef predict(features: FantasyAcquisitionFeatures): ![3](assets/3.png)\n   # Convert Pydantic model to NumPy array\n   input_data = np.array([[features.waiver_value_tier, ![4](assets/4.png)\n                           features.fantasy_regular_season_weeks_remaining,\n                           features.league_budget_pct_remaining]],\n                           dtype=np.int64)\n\n    pred_onx_10 = sess_10.run([label_name_10], {input_name_10: input_data})[0] ![5](assets/5.png)\n    pred_onx_50 = sess_50.run([label_name_50], {input_name_50: input_data})[0]\n    pred_onx_90 = sess_90.run([label_name_90], {input_name_90: input_data})[0]\n\n    # Return prediction as a Pydantic response model\n   return PredictionOutput(winning_bid_10th_percentile=round(\n                               float(pred_onx_10[0]),2), ![6](assets/6.png)\n                           winning_bid_50th_percentile=round(\n                               float(pred_onx_50[0]),2),\n                           winning_bid_90th_percentile=round(\n                               float(pred_onx_90[0]), 2))\n```", "```py\n.../chapter13 (main) $ fastapi run main.py\n```", "```py\n{\"message\":\"API health check successful\"}\n```", "```py\n{\n  \"waiver_value_tier\": 1,\n  \"fantasy_regular_season_weeks_remaining\": 12,\n  \"league_budget_pct_remaining\": 88\n}\n```", "```py\n.../chapter13 (main) $ tree --prune -I 'build|*.egg-info|__pycache__'\n.\n├── acquisition_model_10.onnx\n├── acquisition_model_50.onnx\n├── acquisition_model_90.onnx\n├── main.py\n├── player_acquisition_model.ipynb\n├── player_acquisition_notebook.log\n├── player_training_data_full.csv\n├── requirements.txt\n└── schemas.py\n\n0 directories, 9 files\n```"]
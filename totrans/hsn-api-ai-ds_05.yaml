- en: Chapter 4\. Developing the FastAPI Code
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第4章\. 开发FastAPI代码
- en: In [Chapter 3](ch03.html#chapter_3), you created your database and the Python
    code to access the database. In this chapter, you will build on this foundation
    code to create a working API. [Table 4-1](#swc_endpoints_ch4) lists the endpoints
    that you will create to fulfill these user stories.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 在[第3章](ch03.html#chapter_3)中，你创建了数据库和访问数据库的Python代码。在本章中，你将在这些基础代码的基础上构建一个可工作的API。[表4-1](#swc_endpoints_ch4)列出了你将创建以实现这些用户故事的端点。
- en: Table 4-1\. Endpoints for the SWC Fantasy Football API
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 表4-1\. SWC梦幻足球API的端点
- en: '| Endpoint description | HTTP verb | URL |'
  id: totrans-3
  prefs: []
  type: TYPE_TB
  zh: '| 端点描述 | HTTP方法 | URL |'
- en: '| --- | --- | --- |'
  id: totrans-4
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- | --- |'
- en: '| API health check | GET | */* |'
  id: totrans-5
  prefs: []
  type: TYPE_TB
  zh: '| API健康检查 | GET | */* |'
- en: '| Read player list | GET | */v0/players/* |'
  id: totrans-6
  prefs: []
  type: TYPE_TB
  zh: '| 读取球员列表 | GET | */v0/players/* |'
- en: '| Read individual player | GET | */v0/players/{player_id}/* |'
  id: totrans-7
  prefs: []
  type: TYPE_TB
  zh: '| 读取单个球员 | GET | */v0/players/{player_id}/* |'
- en: '| Read performance list | GET | */v0/performances/* |'
  id: totrans-8
  prefs: []
  type: TYPE_TB
  zh: '| 读取表现列表 | GET | */v0/performances/* |'
- en: '| Read league list | GET | */v0/leagues/* |'
  id: totrans-9
  prefs: []
  type: TYPE_TB
  zh: '| 读取联赛列表 | GET | */v0/leagues/* |'
- en: '| Read individual league | GET | */v0/leagues/{league_id}/* |'
  id: totrans-10
  prefs: []
  type: TYPE_TB
  zh: '| 读取单个联赛 | GET | */v0/leagues/{league_id}/* |'
- en: '| Read team list | GET | */v0/teams/* |'
  id: totrans-11
  prefs: []
  type: TYPE_TB
  zh: '| 读取团队列表 | GET | */v0/teams/* |'
- en: '| Read counts | GET | */v0/counts/* |'
  id: totrans-12
  prefs: []
  type: TYPE_TB
  zh: '| 读取计数 | GET | */v0/counts/* |'
- en: You are using version 0 for your API. This will notify API consumers that the
    product is changing rapidly and they should be aware of potential *breaking changes*—changes
    that cause functionality to stop working and may require consumers to make changes
    in their program code.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 你正在使用API的版本0。这将通知API消费者产品正在快速变化，他们应该注意潜在的*破坏性变更*——这些变更会导致功能停止工作，并可能要求消费者更改其程序代码。
- en: Continuing Your Portfolio Project
  id: totrans-14
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 继续你的项目组合
- en: '[Figure 4-1](#application_components_ch4) shows the same API components you
    saw previously, with one addition: the Uvicorn web server. Uvicorn will execute
    your API code and interact with API requests.'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: '[图4-1](#application_components_ch4)显示了之前看到的相同API组件，增加了一个：Uvicorn网络服务器。Uvicorn将执行你的API代码并与API请求交互。'
- en: '![API components with Uvicorn](assets/haad_0401.png)'
  id: totrans-16
  prefs: []
  type: TYPE_IMG
  zh: '![使用Uvicorn的API组件](assets/haad_0401.png)'
- en: Figure 4-1\. API components with Uvicorn
  id: totrans-17
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图4-1\. 使用Uvicorn的API组件
- en: 'In [Chapter 3](ch03.html#chapter_3), you completed two very important parts
    of the API: the SQLite database and the SQLAlchemy classes that enable Python
    to interact with the data. In this chapter, you will finish the rest of the components.
    You will create Pydantic *schemas* that define the structure of request and response
    messages. Then, you will create the controlling FastAPI application that stitches
    all the other components together to finish the API.'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 在[第3章](ch03.html#chapter_3)中，你完成了API的两个非常重要的部分：SQLite数据库和使Python能够与数据交互的SQLAlchemy类。在本章中，你将完成其余的组件。你将创建Pydantic
    *模式*来定义请求和响应消息的结构。然后，你将创建控制FastAPI应用程序，将所有其他组件连接起来以完成API。
- en: Software Used in This Chapter
  id: totrans-19
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 本章使用的软件
- en: The software introduced in this chapter will focus on handling API requests
    from your consumers. [Table 4-2](#tools_table_chapter_4) lists the new tools you
    will use.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 本章中引入的软件将专注于处理来自消费者的API请求。[表4-2](#tools_table_chapter_4)列出了你将使用的新工具。
- en: Table 4-2\. New tools used in this chapter
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 表4-2\. 本章使用的新工具
- en: '| Software name | Version | Purpose |'
  id: totrans-22
  prefs: []
  type: TYPE_TB
  zh: '| 软件名称 | 版本 | 目的 |'
- en: '| --- | --- | --- |'
  id: totrans-23
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- | --- |'
- en: '| FastAPI | 0 | Web framework to build the API |'
  id: totrans-24
  prefs: []
  type: TYPE_TB
  zh: '| FastAPI | 0 | 构建API的Web框架 |'
- en: '| FastAPI CLI | 0 | Command-line interface for FastAPI |'
  id: totrans-25
  prefs: []
  type: TYPE_TB
  zh: '| FastAPI CLI | 0 | FastAPI的命令行界面 |'
- en: '| HTTPX | 0 | HTTP client for Python |'
  id: totrans-26
  prefs: []
  type: TYPE_TB
  zh: '| HTTPX | 0 | Python的HTTP客户端 |'
- en: '| Pydantic | 2 | Validation library |'
  id: totrans-27
  prefs: []
  type: TYPE_TB
  zh: '| Pydantic | 2 | 验证库 |'
- en: '| Uvicorn | 0 | Web server to run the API |'
  id: totrans-28
  prefs: []
  type: TYPE_TB
  zh: '| Uvicorn | 0 | 运行API的Web服务器 |'
- en: FastAPI
  id: totrans-29
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: FastAPI
- en: FastAPI is a Python web framework that is designed for building APIs. A *web
    framework* is a set of libraries that simplify common tasks for web applications.
    Other common web frameworks include Express, Flask, Django, and Ruby on Rails.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: FastAPI是一个专为构建API而设计的Python Web框架。*Web框架*是一组库，它简化了Web应用程序的常见任务。其他常见的Web框架包括Express、Flask、Django和Ruby
    on Rails。
- en: 'FastAPI is built to be fast in both application performance and developer productivity.
    Because FastAPI focuses on API development, it simplifies several tasks related
    to API building and publishing:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: FastAPI旨在在应用程序性能和开发者生产力方面都快速运行。因为FastAPI专注于API开发，它简化了与API构建和发布相关的多个任务：
- en: It handles HTTP traffic, requests/responses, and other “plumbing” jobs with
    a few lines of code.
  id: totrans-32
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它使用几行代码处理HTTP流量、请求/响应和其他“管道”工作。
- en: It automatically generates an OpenAPI specification file for your API, which
    is useful for integrating with other products.
  id: totrans-33
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它会自动为你 API 生成 OpenAPI 规范文件，这对于与其他产品的集成很有用。
- en: It includes interactive documentation for your API.
  id: totrans-34
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它包括你 API 的交互式文档。
- en: It supports API versioning, security, and many other capabilities.
  id: totrans-35
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它支持 API 版本控制、安全性和许多其他功能。
- en: As you will see as you work through the portfolio project, all of these capabilities
    provide benefits to the users of your APIs.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 正如你在完成投资组合项目时会看到的，所有这些功能都为你的 API 用户提供了好处。
- en: Compared to the other frameworks I mentioned, FastAPI is a relative newcomer.
    It is an open source project created by Sebastián Ramírez Montaño in 2018.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 与我提到的其他框架相比，FastAPI 是一个相对较新的框架。它是由 Sebastián Ramírez Montaño 在 2018 年创建的开源项目。
- en: FastAPI also includes the FastAPI CLI. This is a separate Python library that
    is used to run FastAPI from the command line.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: FastAPI 还包括 FastAPI CLI。这是一个独立的 Python 库，用于从命令行运行 FastAPI。
- en: As of this writing, the latest version of FastAPI is a 0.x version (e.g., 0.115).
    That version number is important because, according to semantic versioning, 0.x
    indicates that breaking changes may occur with the software.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 到我写这篇文章的时候，FastAPI 的最新版本是 0.x 版本（例如，0.115）。这个版本号很重要，因为根据语义版本控制，0.x 表示软件可能会发生破坏性更改。
- en: HTTPX
  id: totrans-40
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: HTTPX
- en: HTTPX is a Python HTTP client. It is similar to the very popular requests library,
    but it supports *asynchronous calls*, which allows some tasks to finish while
    others process. The requests library only supports *synchronous calls*, which
    wait until they receive a response before continuing. HTTPX is used by pytest
    to test FastAPI programs. You will also use this library in [Chapter 7](ch07.html#chapter_7)
    to create your Python SDK.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: HTTPX 是一个 Python HTTP 客户端。它与非常流行的 requests 库类似，但它支持 *异步调用*，这允许一些任务在等待其他任务处理时完成。requests
    库只支持 *同步调用*，它们在收到响应之前会等待。HTTPX 被pytest用于测试 FastAPI 程序。你也会在[第 7 章](ch07.html#chapter_7)中使用这个库来创建你的
    Python SDK。
- en: Pydantic
  id: totrans-42
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Pydantic
- en: Pydantic is a data validation library, which will play a key part in the APIs
    that you build. Because APIs are used to communicate between systems, a critical
    piece of their functionality is the validation of inputs and outputs. API developers
    and data scientists typically spend a significant amount of time writing the code
    to check the data types and validate values that go into and out of the API endpoints.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: Pydantic 是一个数据验证库，它将在你构建的 API 中扮演关键角色。因为 API 用于系统之间的通信，它们功能的一个关键部分是对输入和输出的验证。API
    开发者和数据科学家通常花费大量时间编写代码来检查数据类型和验证进入和离开 API 端点的值。
- en: 'Pydantic is purpose-built to address this important task. Pydantic is fast
    in two ways: it saves the developer time that would be spent to write custom Python
    validation code, and Pydantic validation code runs much faster because it is implemented
    in the Rust programming language.'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: Pydantic 是专门为解决这个重要任务而构建的。Pydantic 在两个方面都很快速：它节省了开发者编写自定义 Python 验证代码所需的时间，并且
    Pydantic 验证代码运行得更快，因为它是用 Rust 编程语言实现的。
- en: In addition to these benefits, objects defined in Pydantic automatically support
    tooltips and hints in IDEs such as VS Code. FastAPI uses Pydantic to generate
    JSON Schema representations from Python code. *JSON Schema* is a standard that
    ensures consistency in JSON data structures. This Pydantic feature enables FastAPI
    to automatically generate the *OpenAPI specification*, which is an industry-standard
    file describing APIs.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 除了这些好处之外，Pydantic 中定义的对象自动支持 VS Code 等 IDE 中的工具提示和提示。FastAPI 使用 Pydantic 从 Python
    代码生成 JSON Schema 表示。*JSON Schema* 是一个确保 JSON 数据结构一致性的标准。这个 Pydantic 功能使 FastAPI
    能够自动生成 *OpenAPI 规范*，这是一个描述 API 的行业标准文件。
- en: For your project, you will use Pydantic version 2.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 对于你的项目，你将使用 Pydantic 版本 2。
- en: Uvicorn
  id: totrans-47
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Uvicorn
- en: All web applications, including APIs, rely on a web server to handle the various
    administrative tasks related to handling requests and responses. You will be using
    the open source Uvicorn web server. Uvicorn is based on the *ASGI specification*,
    which provides support for both *synchronous processes* (which block the process
    while waiting for a task to be performed) and *asychronous processes* (which can
    allow another process to continue while they are waiting).
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 所有网络应用程序，包括 API，都依赖于一个网络服务器来处理与请求和响应相关的各种管理任务。你将使用开源的 Uvicorn 网络服务器。Uvicorn
    基于 *ASGI 规范*，它为 *同步进程*（在等待任务执行时阻塞进程）和 *异步进程*（在等待时允许其他进程继续）提供支持。
- en: For your project, you will be using Uvicorn 0.x.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 对于您的项目，您将使用Uvicorn 0.x。
- en: Copying Files from Chapter 3
  id: totrans-50
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 从第3章复制文件
- en: 'To continue your portfolio project where you left it in the previous chapter,
    change the directory to *chapter4* and then copy the previous chapter’s files
    over to it. The following shows the commands and expected output:'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 要继续您在上一章中留下的项目组合，请将目录更改为*chapter4*，然后将上一章的文件复制到其中。以下显示了命令和预期输出：
- en: '[PRE0]'
  id: totrans-52
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: Installing the New Libraries in Your Codespace
  id: totrans-53
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 在您的Codespace中安装新库
- en: In the previous chapter, you created the *requirements.txt* file and specified
    libraries to install using the `pip3` package manager in Python. You will now
    use this process to install Pydantic, FastAPI, and Uvicorn.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 在上一章中，您创建了*requirements.txt*文件，并使用Python的`pip3`包管理器指定了要安装的库。您现在将使用此过程安装Pydantic、FastAPI和Uvicorn。
- en: 'Update *requirements.txt* to match the following:'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 更新*requirements.txt*以匹配以下内容：
- en: '[PRE1]'
  id: totrans-56
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Execute the following command to install the new libraries in your Codespace
    and verify that the libraries installed in the previous chapter still exist:'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 执行以下命令以在您的Codespace中安装新库，并验证上一章中安装的库是否仍然存在：
- en: '[PRE2]'
  id: totrans-58
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'You should see a message that states that these libraries were successfully
    installed, such as the following:'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 您应该会看到一个消息，表明这些库已成功安装，如下所示：
- en: '[PRE3]'
  id: totrans-60
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Creating Python Files for Your API
  id: totrans-61
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 为您的API创建Python文件
- en: You will be creating two new Python files, which are detailed in [Table 4-3](#file_table_chapter_4).
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 您将创建两个新的Python文件，具体细节在[表4-3](#file_table_chapter_4)中。
- en: Table 4-3\. Purpose of the Chapter 4 files
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 表4-3\. 第4章文件的目的
- en: '| Filename | Purpose |'
  id: totrans-64
  prefs: []
  type: TYPE_TB
  zh: '| 文件名 | 目的 |'
- en: '| --- | --- |'
  id: totrans-65
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- |'
- en: '| *main.py* | FastAPI file that defines routes and controls API |'
  id: totrans-66
  prefs: []
  type: TYPE_TB
  zh: '| *main.py* | 定义路由并控制API的FastAPI文件 |'
- en: '| *schemas.py* | Defines the Pydantic classes that validate data sent to the
    API |'
  id: totrans-67
  prefs: []
  type: TYPE_TB
  zh: '| *schemas.py* | 定义验证发送到API的数据的Pydantic类 |'
- en: '| *test_main.py* | The pytest file for the FastAPI program |'
  id: totrans-68
  prefs: []
  type: TYPE_TB
  zh: '| *test_main.py* | FastAPI程序的pytest文件 |'
- en: Creating Pydantic Schemas
  id: totrans-69
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 创建Pydantic模式
- en: The Pydantic classes define the structure of the data that the consumer will
    receive in their API responses. This uses a software design pattern called *data
    transfer objects* (DTO), in which you define a format for transferring data between
    a producer and consumer, without the consumer needing to know the backend format.
    In your portfolio project, the backend and frontend classes won’t look significantly
    different, but using DTOs allows complete flexibility on this point.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: Pydantic类定义了消费者将在他们的API响应中接收的数据结构。这使用了一种名为*数据传输对象*（DTO）的软件设计模式，其中您定义了在生产者和消费者之间传输数据格式的格式，而无需消费者了解后端格式。在您的项目组合中，后端和前端类看起来不会有显著差异，但使用DTO允许在这方面有完全的灵活性。
- en: Although you define the classes using Python code and your code interacts with
    them as fully formed Python objects, the consumer will receive them in an HTTP
    request as a JSON object. FastAPI uses Pydantic to perform the *serialization*
    process, which is converting the Python objects into JSON for the API response.
    This means you do not need to manage serialization in your Python code, which
    simplifies your program. Pydantic 2 is written in Rust and performs this task
    much faster than Python could. In addition to performing this de-serialization
    task, Python also defines the response format in the *openapi.json* file. This
    is a standard contract that uses OpenAPI and JSON Schema. This will provide multiple
    benefits for the consumer, as you will see in subsequent chapters. Pydantic will
    take data from SQLAlchemy classes and provide it to the API users.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然您使用Python代码定义类，并且您的代码将它们作为完整的Python对象与之交互，但消费者将以JSON对象的形式在HTTP请求中接收它们。FastAPI使用Pydantic执行*序列化*过程，即将Python对象转换为API响应的JSON。这意味着您不需要在Python代码中管理序列化，这简化了您的程序。Pydantic
    2是用Rust编写的，并且比Python执行此任务要快得多。除了执行此反序列化任务外，Python还在*openapi.json*文件中定义了响应格式。这是一个使用OpenAPI和JSON
    Schema的标准合同。这将为您带来多方面的好处，您将在随后的章节中看到。Pydantic将从SQLAlchemy类中获取数据，并将其提供给API用户。
- en: Note
  id: totrans-72
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 注意
- en: Both SQLAlchemy and Pydantic documentation refer to their classes as models,
    which may be confusing at times. This is extra confusing for data science work,
    where models have additional meanings. For clarity, this book will refer to Pydantic
    schemas and SQLAlchemy models.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: SQLAlchemy和Pydantic文档有时将它们的类称为模型，这可能会令人困惑。对于数据科学工作来说，这一点尤其令人困惑，因为模型有额外的含义。为了清晰起见，本书将引用Pydantic模式和SQLAlchemy模型。
- en: 'Create a file with the following contents, and name it *schemas.py*:'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 创建一个包含以下内容的文件，并将其命名为 *schemas.py*：
- en: '[PRE4]'
  id: totrans-75
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: The schemas in this file will be used to form the responses to the API endpoints
    that you will define next. The primary schemas are directly returned to the endpoints
    and the secondary schemas are returned as an attribute of the primary schema.
    For example, the */v0/players/* endpoint URL returns a list of `Player` objects
    (primary), which has the attribute `Player.performances` (secondary). [Table 4-4](#schema_endpoint_mapping)
    shows the mapping between API endpoints and schemas.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 此文件中的模式将用于形成你将定义的 API 端点的响应。主要模式直接返回到端点，而二级模式作为主要模式的一个属性返回。例如，*/v0/players/*
    端点 URL 返回一个 `Player` 对象的列表（主要），该对象具有 `Player.performances` 属性（二级）。[表 4-4](#schema_endpoint_mapping)
    显示了 API 端点和模式之间的映射。
- en: Table 4-4\. Mapping of schemas to endpoints
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 表 4-4\. 模式到端点的映射
- en: '| Endpoint URL | Primary schema | Secondary schema |'
  id: totrans-78
  prefs: []
  type: TYPE_TB
  zh: '| 端点 URL | 主要模式 | 二级模式 |'
- en: '| --- | --- | --- |'
  id: totrans-79
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- | --- |'
- en: '| */* | None | None |'
  id: totrans-80
  prefs: []
  type: TYPE_TB
  zh: '| */* | 无 | 无 |'
- en: '| */v0/players/* | Player | Performance |'
  id: totrans-81
  prefs: []
  type: TYPE_TB
  zh: '| */v0/players/* | 球员 | Performance |'
- en: '| */v0/players/{player_id}/* | Player | Performance |'
  id: totrans-82
  prefs: []
  type: TYPE_TB
  zh: '| */v0/players/{player_id}/* | 球员 | Performance |'
- en: '| */v0/performances/* | Performance | None |'
  id: totrans-83
  prefs: []
  type: TYPE_TB
  zh: '| */v0/performances/* | Performance | 无 |'
- en: '| */v0/leagues/* | League | TeamBase |'
  id: totrans-84
  prefs: []
  type: TYPE_TB
  zh: '| */v0/leagues/* | 联赛 | TeamBase |'
- en: '| */v0/leagues/*{league_id} | League | TeamBase |'
  id: totrans-85
  prefs: []
  type: TYPE_TB
  zh: '| */v0/leagues/*{league_id} | 联赛 | TeamBase |'
- en: '| */v0/teams/* | Team | PlayerBase |'
  id: totrans-86
  prefs: []
  type: TYPE_TB
  zh: '| */v0/teams/* | 队伍 | PlayerBase |'
- en: '| */v0/counts/* | Counts | None |'
  id: totrans-87
  prefs: []
  type: TYPE_TB
  zh: '| */v0/counts/* | 计数 | 无 |'
- en: 'The `Performance` class is the first and simplest schema:'
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: '`Performance` 类是第一个也是最简单的模式：'
- en: '[PRE5]'
  id: totrans-89
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: This class represents the scoring data that the consumer will receive. From
    their perspective, a *performance* is what happens when a player plays in a single
    week. If you compare the elements of this class to the SQLAlchemy models, you
    will see that it contains all of the elements that the `Performance` model contains.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 此类表示消费者将接收的得分数据。从他们的角度来看，*表现* 是球员在单周比赛中发生的事情。如果你将此类的元素与 SQLAlchemy 模型进行比较，你会看到它包含
    `Performance` 模型中包含的所有元素。
- en: '`Performance` is a subclass of the Pydantic `BaseModel` class, which provides
    a lot of built-in capabilities, including validating the data types, converting
    the Python object to JSON (serializing), raising intelligent errors, and connecting
    automatically to the SQLAlchemy models.'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: '`Performance` 是 Pydantic 的 `BaseModel` 类的子类，它提供了许多内置功能，包括验证数据类型、将 Python 对象转换为
    JSON（序列化）、引发智能错误以及自动连接到 SQLAlchemy 模型。'
- en: Tip
  id: totrans-92
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 小贴士
- en: Notice that the Pydantic data types of individual class elements are assigned
    with a colon, and not an equals sign which is what SQLAlchemy uses. (This will
    trip you up if you’re not careful.)
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，单个类元素的 Pydantic 数据类型是用冒号而不是等号分配的，这是 SQLAlchemy 所使用的。（如果你不小心，这可能会让你陷入困境。）
- en: 'The player data is represented in two schemas: `PlayerBase` and `Player`. Breaking
    the data into two classes allows you to share a limited version of the data in
    some situations and a full version in others. Here are those two schemas:'
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 玩家数据以两个模式表示：`PlayerBase` 和 `Player`。将数据拆分为两个类允许你在某些情况下共享数据的有限版本，在其他情况下则共享完整版本。以下是这两个模式：
- en: '[PRE6]'
  id: totrans-95
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'The performance data had a single `Performance` schema, but the player data
    has two schemas. `PlayerBase` is a subclass of `BaseModel`, and it has all the
    player fields except one: the `Performance` list. [Table 4-4](#schema_endpoint_mapping)
    shows that `PlayerBase` will be used as a secondary schema for the */v0/teams/*
    endpoint. The reason is simple: to reduce the amount of data transmitted in the
    API call. When the API user retries a list of `Team` schemas, they want to see
    all the players on that team without also getting a list of all the scoring performances
    for all the players.'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 性能数据有一个单一的 `Performance` 模式，但玩家数据有两个模式。`PlayerBase` 是 `BaseModel` 的子类，并且包含所有玩家字段，除了一个：`Performance`
    列表。[表 4-4](#schema_endpoint_mapping) 显示 `PlayerBase` 将被用作 */v0/teams/* 端点的二级模式。原因很简单：为了减少
    API 调用中传输的数据量。当 API 用户重试 `Team` 模式的列表时，他们想看到该队伍上的所有球员，而不想同时获取所有球员的得分表现列表。
- en: The full `Player` schema is a subclass of `PlayerBase` and adds the list of
    `Performance` objects. This schema is used directly in the */v0/players/* and
    */v0/players/{player_id}/* endpoints. In those situations, the API user wants
    a list of scoring performances with the players.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 完整的 `Player` 模式是 `PlayerBase` 的子类，并添加了 `Performance` 对象的列表。此模式直接用于 */v0/players/*
    和 */v0/players/{player_id}/* 端点。在这些情况下，API 用户希望看到与球员相关的得分表现列表。
- en: 'To see the secondary use of `PlayerBase`, examine the next two schemas:'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 要查看`PlayerBase`的次要用途，请检查接下来的两个模式：
- en: '[PRE7]'
  id: totrans-99
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'The `Team` object contains the statement `players: List[PlayerBase] = []`.
    As mentioned previously, this means the items in `Team.players` are of the more
    limited `PlayerBase` schema. This is the secondary usage of `PlayerBase` shown
    in [Table 4-4](#schema_endpoint_mapping) in the */v0/teams/* endpoint.'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: '`Team`对象包含语句`players: List[PlayerBase] = []`。如前所述，这意味着`Team.players`中的项目属于更有限的`PlayerBase`模式。这是在`/v0/teams/*`端点中显示的`PlayerBase`的次要用途[表4-4](#schema_endpoint_mapping)。'
- en: 'The next class is the `League` schema:'
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 下一个类是`League`模式：
- en: '[PRE8]'
  id: totrans-102
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: By now you probably noticed that `League.teams` contains `TeamBase` objects.
    This is the secondary use of `TeamBase` used in the */v0/leagues/* endpoint.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 到现在为止，你可能已经注意到`League.teams`包含`TeamBase`对象。这是在`/v0/leagues/*`端点中使用的`TeamBase`的次要用途。
- en: 'Finally, you will create a special-purpose schema to support the analytics
    provided by the *v0/counts/* endpoint. This schema does not directly map to a
    database table, so it does not include the `model_config` element. The name of
    the schema is `Counts`, and it includes the number of league, team, and player
    records in the API:'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，你将创建一个特殊用途的模式来支持由`v0/counts/*`端点提供的分析。这个模式不直接映射到数据库表，因此它不包括`model_config`元素。该模式名为`Counts`，并包括API中的联赛、团队和玩家记录的数量：
- en: '[PRE9]'
  id: totrans-105
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'At this point, you have designed the DTOs that will be used to send data to
    the API consumer. You are ready for the final piece: the FastAPI controller class.'
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，你已经设计了将要用于向API消费者发送数据的DTOs。你现在可以准备最后一部分：FastAPI控制器类。
- en: Creating Your FastAPI Controller
  id: totrans-107
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 创建你的FastAPI控制器
- en: Now that all of the pieces are in place in the other Python files, you can tie
    them together with the FastAPI functionality in *main.py*. You can accomplish
    a lot with only a few lines of FastAPI code.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 现在所有其他Python文件中的组件都已就绪，你可以使用`main.py`中的FastAPI功能将它们组合在一起。你只需几行FastAPI代码就能完成很多事情。
- en: 'Create the file with the following contents, and name it *main.py*:'
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 创建以下内容的文件，并将其命名为`main.py`：
- en: '[PRE10]'
  id: totrans-110
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'Let’s walk through the code in your FastAPI file. We’ll begin with the imports:'
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们遍历你的FastAPI文件中的代码。我们将从导入开始：
- en: '[PRE11]'
  id: totrans-112
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: '[![1](assets/1.png)](#co_developing_the_fastapi_code_CO1-1)'
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: '![1](assets/1.png)[#co_developing_the_fastapi_code_CO1-1]'
- en: These are methods from the FastAPI library. You will use these to identify this
    program as a FastAPI application.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 这些是FastAPI库中的方法。你将使用这些方法来识别这个程序作为一个FastAPI应用程序。
- en: '[![2](assets/2.png)](#co_developing_the_fastapi_code_CO1-2)'
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: '![2](assets/2.png)'
- en: The SQLAlchemy `Session` will be used when this program calls *crud.py*.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 当这个程序调用`crud.py`时，将使用SQLAlchemy的`Session`。
- en: '[![3](assets/3.png)](#co_developing_the_fastapi_code_CO1-3)'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: '![3](assets/3.png)[#co_developing_the_fastapi_code_CO1-3]'
- en: You will use the `date` type to query by last changed date.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 你将使用`date`类型来按最后更改日期进行查询。
- en: '[![4](assets/4.png)](#co_developing_the_fastapi_code_CO1-4)'
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: '![4](assets/4.png)'
- en: These imports allow the FastAPI application to reference the SQLAlchemy and
    Pydantic classes.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 这些导入允许FastAPI应用程序引用SQLAlchemy和Pydantic类。
- en: '[![5](assets/5.png)](#co_developing_the_fastapi_code_CO1-5)'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: '![5](assets/5.png)[#co_developing_the_fastapi_code_CO1-5]'
- en: This retrieves the shared `SessionLocal` class that is used to connect to your
    SQLite database.
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 这检索了用于连接SQLite数据库的共享`SessionLocal`类。
- en: 'Continue reviewing the code:'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 继续审查代码：
- en: '[PRE12]'
  id: totrans-124
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: In FastAPI, the primary class you will work with is a `FastAPI` class. This
    class by default includes the functionality to handle much of the work that an
    API needs to perform, without requiring you to specify every detail. You create
    a `FastAPI` instance and name it `app`. This will be used in the rest of *main.py*.
    When you execute your API from the command line using Uvicorn, you will reference
    `main:app`, referring to the `app` object in *main.py*.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 在FastAPI中，你将主要与之合作的类是`FastAPI`类。这个类默认包含处理API需要执行的大部分工作的功能，而无需你指定每个细节。你创建一个`FastAPI`实例并将其命名为`app`。这将在`main.py`的其余部分中使用。当你使用Uvicorn从命令行执行你的API时，你将引用`main:app`，这指的是`main.py`中的`app`对象。
- en: 'You define the `get_db()` function to create a database session and close the
    session when you are done with it. This function is used as a dependency in the
    API routes within *main.py*:'
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 你定义`get_db()`函数来创建数据库会话，并在完成后关闭会话。这个函数在`main.py`中的API路由中用作依赖项：
- en: '[PRE13]'
  id: totrans-127
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: The next command is `@app.get("/")`, which is a *decorator*. A decorator is
    a statement that is added above a function definition, to give special attributes
    to it. In this case, the decorator defines that the `async def root()` function
    definition will be a FastAPI request handler.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 下一个命令是 `@app.get("/")`，这是一个 *装饰器*。装饰器是一个添加在函数定义之上的语句，用来给它添加特殊的属性。在这种情况下，装饰器定义了
    `async def root()` 函数定义将是一个 FastAPI 请求处理器。
- en: 'This function will be called when a consumer accesses the root URL of the API,
    which is equivalent to `/`. It will serve as a health check for the entire API
    by returning a simple message to the consumer. The next statement defines the
    first endpoint that we have created for your user stories:'
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 当消费者访问 API 的根 URL 时，这个函数将被调用，这相当于 `/`。它将通过向消费者返回一个简单的消息来作为整个 API 的健康检查。下一个语句定义了我们为你的用户故事创建的第一个端点：
- en: '[PRE14]'
  id: totrans-130
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Remember that [Table 4-1](#swc_endpoints_ch4) defined the endpoints that we
    planned to create as a combination of HTTP verb and URL. With FastAPI these endpoints
    (also called *routes*) are defined with the decorators above each function.
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 记住 [表 4-1](#swc_endpoints_ch4) 定义了我们计划创建的端点，这些端点是 HTTP 动词和 URL 的组合。在 FastAPI
    中，这些端点（也称为 *路由*）是通过每个函数上面的装饰器来定义的。
- en: 'The following explains how the HTTP verb and URL are specified in the decorator:'
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 下面的内容解释了如何在装饰器中指定 HTTP 动词和 URL：
- en: '*HTTP verb*: All of these endpoints use the `GET` verb, which is defined by
    the `@app.get()` decorator function.'
  id: totrans-133
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*HTTP 动词*：所有这些端点都使用 `GET` 动词，这是由 `@app.get()` 装饰器函数定义的。'
- en: '*URL*: The first parameter of the `get()` function is the relative URL. For
    this first endpoint, the URL is */v0/players/*.'
  id: totrans-134
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*URL*：`get()` 函数的第一个参数是相对 URL。对于这个第一个端点，URL 是 */v0/players/*。'
- en: The second parameter of the decorator is `response_model=list[schemas.Player])`.
    This informs FastAPI that the data returned from this endpoint will be a list
    of Pydantic `Player` objects, as defined in the *schemas.py* file. This information
    will be included in the OpenAPI specification that FastAPI automatically creates
    for this API. Consumers can count on the returned data being valid according to
    this definition.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 装饰器的第二个参数是 `response_model=list[schemas.Player]`。这告诉 FastAPI 从这个端点返回的数据将是一个
    Pydantic `Player` 对象的列表，如 *schemas.py* 文件中定义。这个信息将被包含在 FastAPI 自动为这个 API 创建的 OpenAPI
    规范中。消费者可以依赖返回的数据根据这个定义是有效的。
- en: 'Let’s look at the function signature that you decorated:'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们看看你装饰的函数签名：
- en: '[PRE15]'
  id: totrans-137
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: Several things are going on in this function. Starting at the end, the `db`
    object is a session that is created by the `get_db()` function defined at the
    top of this file. By wrapping the function in `Depends()`, FastAPI handles the
    call for and gives the `Session` to your function.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 这个函数中正在进行几件事情。从结尾开始，`db` 对象是由文件顶部定义的 `get_db()` 函数创建的会话。通过将函数包裹在 `Depends()`
    中，FastAPI 处理调用并将 `Session` 传递给你的函数。
- en: 'The next two parameters are optional integers with a default value: `skip:
    int = 0, limit: int = 100, last_name`. These are followed by two optional string
    parameters that default to `None`. These are all named parameters that have a
    defined data type and a default value. FastAPI will automatically include these
    parameters as query parameters in the API definition. Query parameters are included
    in the URL path with a question mark in front and an ampersand between.'
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: '接下来的两个参数是可选的整数，具有默认值：`skip: int = 0, limit: int = 100, last_name`。这些后面跟着两个可选的字符串参数，默认值为
    `None`。这些都是具有定义的数据类型和默认值的命名参数。FastAPI 将自动将这些参数作为查询参数包含在 API 定义中。查询参数包含在 URL 路径中，前面有一个问号，中间有一个和号。'
- en: 'For instance, to call this query method, the API consumer could use this request:'
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，要调用这个查询方法，API 消费者可以使用这个请求：
- en: '*HTTP verb*: GET'
  id: totrans-141
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*HTTP 动词*：GET'
- en: '*URL*: *{base URL}/v0/players/?first_name=Bryce&last_name=Young*'
  id: totrans-142
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*URL*：*{base URL}/v0/players/?first_name=Bryce&last_name=Young*'
- en: Within the body of the `read_players()` function, FastAPI is calling the `get_players()`
    function that you defined in *crud.py*. It is performing a database query. The
    `players` object receives the result of that function call. FastAPI validates
    that this object matches the definition `list[schemas.Player]`. If it does, FastAPI
    uses Pydantic to serialize the Python objects into a text JSON string and sends
    the response to the consumer.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 在 `read_players()` 函数体内部，FastAPI 调用了你在 *crud.py* 中定义的 `get_players()` 函数。它执行了一个数据库查询。`players`
    对象接收这个函数调用的结果。FastAPI 验证这个对象是否与定义 `list[schemas.Player]` 匹配。如果是，FastAPI 使用 Pydantic
    将 Python 对象序列化为文本 JSON 字符串，并将响应发送给消费者。
- en: 'The next endpoint adds two additional FastAPI features:'
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 下一个端点添加了两个额外的FastAPI功能：
- en: '[PRE16]'
  id: totrans-145
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'First, the URL path includes `{player_id}`. This is a *path parameter*, which
    is an API request parameter that is included in the URL path instead of being
    separated by question marks and ampersands, like the query parameters. Here is
    an example of how the API consumer might call this endpoint:'
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，URL路径包含`{player_id}`。这是一个*路径参数*，它是一个API请求参数，包含在URL路径中，而不是像查询参数那样通过问号和与号分隔。以下是一个API消费者可能调用此端点的示例：
- en: '*HTTP verb*: GET'
  id: totrans-147
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*HTTP动词*：GET'
- en: '*URL*: *{base URL}/v0/players/12345?skip=10&limit=50*'
  id: totrans-148
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*URL*：*{base URL}/v0/players/12345?skip=10&limit=50*'
- en: The function checks to see if any records were returned from the helper function,
    and if not, it raises an *HTTPException*. This is a standard method that web applications
    use to communicate status. It is good RESTful API design to use the standard [HTTP
    status codes](https://oreil.ly/cTnfI) to communicate with consumers. This makes
    the operation more predictable and reliable. This endpoint returns an HTTP status
    code of 404, which is the *not found* code. It adds the additional message that
    the item not found was the player being searched for.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 函数检查是否有记录从辅助函数返回，如果没有，则抛出一个*HTTPException*。这是一个网络应用程序用来通信状态的标准方法。使用标准的[HTTP状态码](https://oreil.ly/cTnfI)与消费者通信是良好的RESTful
    API设计。这使得操作更加可预测和可靠。此端点返回HTTP状态码404，即*未找到*代码。它还添加了额外的消息，指出未找到的项目是正在搜索的玩家。
- en: 'The next four endpoints do not use any new features. But together they complete
    all of the user stories that we have included for your first API:'
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来的四个端点不使用任何新功能。但它们共同完成了我们为您第一次API所包含的所有用户故事：
- en: '[PRE17]'
  id: totrans-151
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'The final endpoint provides counts of leagues, teams, and players:'
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 最后一个端点提供了联赛、团队和玩家的计数：
- en: '[PRE18]'
  id: totrans-153
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: It is worth noting that, in addition to the basic options of FastAPI and Pydantic
    that you are using, many other validations and features are available. As you
    can see, these libraries accomplish a lot with only a few lines of code from you.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 值得注意的是，除了您正在使用的FastAPI和Pydantic的基本选项之外，还有许多其他验证和功能可用。正如您所看到的，这些库仅用您的一行代码就能完成很多事情。
- en: Testing Your API
  id: totrans-155
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 测试您的API
- en: You will use pytest to test your *main.py* file. As with the *crud.py* file
    in the previous chapter, you will be testing that the correct number of records
    are returned by each API endpoint. The counts of records can be verified by the
    SQL queries in [“Loading Your Data”](ch03.html#load_your_data).
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 您将使用pytest来测试*main.py*文件。与上一章中的*crud.py*文件一样，您将测试每个API端点返回的正确记录数。记录数可以通过[“加载数据”](ch03.html#load_your_data)中的SQL查询进行验证。
- en: 'To implement the tests for your API, create a file with the following contents,
    and name it *test_main.py*:'
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 要实现您API的测试，创建一个包含以下内容的文件，并将其命名为*test_main.py*：
- en: '[PRE19]'
  id: totrans-158
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'The file begins with import statements and creation of the `TestClient` class:'
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 文件以导入语句和创建`TestClient`类开始：
- en: '[PRE20]'
  id: totrans-160
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: '[![1](assets/1.png)](#co_developing_the_fastapi_code_CO2-1)'
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: '[![1](assets/1.png)](#co_developing_the_fastapi_code_CO2-1)'
- en: '`TestClient` is a special class that allows the FastAPI program to be tested
    without running it on a web server.'
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: '`TestClient`是一个特殊类，它允许在不运行Web服务器的情况下测试FastAPI程序。'
- en: '[![2](assets/2.png)](#co_developing_the_fastapi_code_CO2-2)'
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: '[![2](assets/2.png)](#co_developing_the_fastapi_code_CO2-2)'
- en: This references the FastAPI object you created in *main.py*.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 这引用了您在*main.py*中创建的FastAPI对象。
- en: '[![3](assets/3.png)](#co_developing_the_fastapi_code_CO2-3)'
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: '[![3](assets/3.png)](#co_developing_the_fastapi_code_CO2-3)'
- en: This statement creates a `TestClient` that will test your application.
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 此语句创建了一个将测试您的应用程序的`TestClient`。
- en: 'Take a look at a few of the test functions:'
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 看一下几个测试函数：
- en: '[PRE21]'
  id: totrans-168
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: This function uses the `TestClient` to simulate an API call to the root path.
    Then, it checks the HTTP status code for a value of `200`, which means a successful
    request. Next, it looks at the JSON value returned by the API and checks that
    it matches the JSON value provided.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 此函数使用`TestClient`模拟对根路径的API调用。然后，它检查HTTP状态码是否为`200`，这意味着请求成功。接下来，它查看API返回的JSON值，并检查它是否与提供的JSON值匹配。
- en: 'The next test function adds more functionality:'
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 下一个测试函数添加了更多功能：
- en: '[PRE22]'
  id: totrans-171
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: Notice that the URL passed in the `get()` statement uses the `skip` and `limit`
    parameters. The second `assert` statement checks the length of the list of players
    returned by the API to make sure it is exactly 1018.
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，在`get()`语句中传递的URL使用了`skip`和`limit`参数。第二个`assert`语句检查API返回的玩家列表的长度，确保它正好是1018。
- en: Another test function tests the search of players by name. Although the database
    does not enforce uniqueness on player names, duplicate player names are rare,
    and names are commonly used to identify players.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 另一个测试函数测试按名称搜索玩家。尽管数据库不对玩家名称的唯一性进行强制，但重复的玩家名称很少见，名称通常用于识别玩家。
- en: 'This search without a key supports the design recommended in [Chapter 1](ch01.html#chapter_1)
    for AI:'
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 这种不带密钥的搜索支持 [第 1 章](ch01.html#chapter_1) 中推荐的 AI 设计：
- en: '[PRE23]'
  id: totrans-175
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: 'This adds two `assert` statements: one to make sure only one record was returned
    from this query (after all, there is only one Bryce Young) and another to make
    sure the `player_id` is correct.'
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 这添加了两个 `assert` 语句：一个确保从这个查询中只返回了一个记录（毕竟，只有一个 Bryce Young），另一个确保 `player_id`
    是正确的。
- en: 'The complete file contains 11 tests in all. To execute the tests, enter the
    following command:'
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 完整的文件包含总共 11 个测试。要执行测试，请输入以下命令：
- en: '[PRE24]'
  id: totrans-178
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: You have verified that your FastAPI program works with pytest. Now it’s time
    to try it with a web server.
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 你已经验证了你的 FastAPI 程序与 pytest 一起工作。现在是时候尝试使用 Web 服务器了。
- en: Launching Your API
  id: totrans-180
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 启动您的 API
- en: 'This is the moment you have been waiting for: it’s time to run your API. Enter
    the following command from the command line:'
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 这是你一直等待的时刻：现在是时候运行你的 API 了。从命令行输入以下命令：
- en: '[PRE25]'
  id: totrans-182
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: You will see the application startup occur as shown in [Figure 4-2](#fast_api_run_ch4).
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 你将看到应用程序启动的过程，如图 [图 4-2](#fast_api_run_ch4) 所示。
- en: '![FastAPI running from command line](assets/haad_0402.png)'
  id: totrans-184
  prefs: []
  type: TYPE_IMG
  zh: '![从命令行运行 FastAPI](assets/haad_0402.png)'
- en: Figure 4-2\. FastAPI running from the command line
  id: totrans-185
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 4-2\. 从命令行运行 FastAPI
- en: In Codespaces, you will also see a dialog stating “Your application running
    on port 8000 is available,” as shown in [Figure 4-3](#codespaces_api_open_browser4).
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Codespaces 中，你还会看到一个对话框显示“您的应用程序正在端口 8000 上运行”，如图 [图 4-3](#codespaces_api_open_browser4)
    所示。
- en: '![Codespaces browser window popup](assets/haad_0403.png)'
  id: totrans-187
  prefs: []
  type: TYPE_IMG
  zh: '![Codespaces 浏览器窗口弹出](assets/haad_0403.png)'
- en: Figure 4-3\. Codespaces browser window pop-up
  id: totrans-188
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 4-3\. Codespaces 浏览器窗口弹出
- en: 'Click “Open in Browser” to open a browser tab outside your Codespaces. This
    browser will show a base URL ending in *app.github.dev* that contains the response
    from your API running on Codespaces. You should see the following health check
    message in your web browser:'
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 点击“在浏览器中打开”以在 Codespaces 外部打开一个浏览器标签页。此浏览器将显示以 *app.github.dev* 结尾的基本 URL，其中包含在
    Codespaces 上运行的 API 的响应。你应该在你的网页浏览器中看到以下健康检查信息：
- en: '[PRE26]'
  id: totrans-190
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: This confirms your API is running, which is a great start.
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 这确认了你的 API 正在运行，这是一个很好的开始。
- en: 'The next test is to call an endpoint that retrieves data. Give that a try by
    copying and pasting the following onto the end of the base URL in your browser:
    ***/v0/performances/?skip=0&limit=1***. For example, the full URL might be *[*https://happy-pine-tree-1234-8000.app.github.dev/v0/performances/?skip=0&limit=1*](https://happy-pine-tree-1234-8000.app.github.dev/v0/performances/?skip=0&limit=1)*.'
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 下一个测试是调用一个检索数据的端点。通过将以下内容复制并粘贴到浏览器的基本 URL 的末尾来尝试：***/v0/performances/?skip=0&limit=1***。例如，完整的
    URL 可能是 *[*https://happy-pine-tree-1234-8000.app.github.dev/v0/performances/?skip=0&limit=1*](https://happy-pine-tree-1234-8000.app.github.dev/v0/performances/?skip=0&limit=1)*。
- en: 'If everything is working correctly, you should see the following data in your
    browser:'
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 如果一切正常，你应该在你的浏览器中看到以下数据：
- en: '[PRE27]'
  id: totrans-194
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: Tip
  id: totrans-195
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 小贴士
- en: 'This chapter covered a lot, so it’s possible that an error occurred or you
    are not getting a successful result. Don’t worry, this happens to all of us. Here
    are a few suggestions for how to troubleshoot any problems you are running into:'
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 本章涵盖了大量的内容，所以可能发生了错误，或者你没有得到成功的结果。别担心，这发生在我们所有人身上。以下是一些如何解决你遇到的问题的建议：
- en: Run the **`pip3 install -r requirements.txt`** command again to make sure you
    have all the updated software.
  id: totrans-197
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 再次运行 **`pip3 install -r requirements.txt`** 命令以确保你拥有所有更新的软件。
- en: Take a minute to verify the path in the URL bar of your browser. Minor things
    matter, such as slashes and question marks.
  id: totrans-198
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 花一分钟验证浏览器地址栏中的路径。小事情很重要，比如斜杠和问号。
- en: Look at the command line to see any errors that are being thrown by FastAPI.
  id: totrans-199
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 查看命令行以查看 FastAPI 抛出的任何错误。
- en: To verify your environment with FastAPI and Uvicorn, try creating a simple API,
    such as one from the [official FastAPI tutorial](https://oreil.ly/L7QWz).
  id: totrans-200
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 要使用 FastAPI 和 Uvicorn 验证你的环境，尝试创建一个简单的 API，例如来自 [官方 FastAPI 教程](https://oreil.ly/L7QWz)
    的一个。
- en: If a formatting error occurs due to text wrapping, check against the files in
    the GitHub repository.
  id: totrans-201
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果由于文本换行而发生格式错误，请与 GitHub 仓库中的文件进行核对。
- en: If this first API endpoint is working for you, try out some more of the URLs
    from [Table 4-1](#swc_endpoints_ch4) in your browser to verify that you have completed
    all of your user stories. Congratulations, you are an API developer!
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 如果这个第一个API端点对您有效，请在浏览器中尝试更多[表4-1](#swc_endpoints_ch4)中的URL，以验证您已完成所有用户故事。恭喜您，您已经成为了一名API开发者！
- en: Additional Resources
  id: totrans-203
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 其他资源
- en: To explore FastAPI beyond this book, the official [FastAPI tutorial](https://oreil.ly/SFN3w)
    and [FastAPI reference documentation](https://oreil.ly/MVgVk) are both very useful.
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 要探索FastAPI超出了本书的范围，官方的[FastAPI教程](https://oreil.ly/SFN3w)和[FastAPI参考文档](https://oreil.ly/MVgVk)都非常有用。
- en: 'To learn the ins and outs of building a project with FastAPI, I recommend *FastAPI:
    Modern Python Web Development* by Bill Lubanovic (O’Reilly, 2023).'
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: 要了解使用FastAPI构建项目的方方面面，我推荐Bill Lubanovic的《FastAPI：现代Python Web开发》（O’Reilly，2023）。
- en: For a growing list of practical tips from an official FastAPI Expert, check
    out [Marcelo Trylesinski’s FastAPI Tips](https://oreil.ly/kludex).
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 要获取来自官方FastAPI专家的更多实用技巧列表，请查看[Marcelo Trylesinski的FastAPI技巧](https://oreil.ly/kludex)。
- en: The official [Pydantic 2.4 documentation](https://oreil.ly/2OE-8) provides information
    for the specific version of Pydantic used in this chapter.
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
  zh: 官方的[Pydantic 2.4文档](https://oreil.ly/2OE-8)提供了关于本章中使用的Pydantic特定版本的信息。
- en: The official [Uvicorn documentation](https://oreil.ly/uvicorn) has much more
    information about the capabilities of this software.
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 官方的[Uvicorn文档](https://oreil.ly/uvicorn)提供了关于此软件功能的更多信息。
- en: Summary
  id: totrans-209
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: 'In this chapter, you completed the API functionality for the SWC Fantasy Football
    API. You accomplished the following:'
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，您完成了SWC梦幻足球API的API功能。您实现了以下内容：
- en: You installed FastAPI, SQLAlchemy, Pydantic, and Uvicorn, along with several
    supporting libraries.
  id: totrans-211
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您已安装了FastAPI、SQLAlchemy、Pydantic和Uvicorn，以及一些支持库。
- en: You defined Pydantic schemas to represent the data that your API consumers wanted
    to receive.
  id: totrans-212
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您定义了Pydantic模式来表示API消费者希望接收的数据。
- en: You created a FastAPI program to process consumer requests and return data responses,
    tying everything together.
  id: totrans-213
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您创建了一个FastAPI程序来处理消费者请求并返回数据响应，将所有内容串联起来。
- en: You tested the API with pytest and then ran it successfully on the web server.
  id: totrans-214
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您使用pytest测试了API，然后在网络服务器上成功运行。
- en: In [Chapter 5](ch05.html#chapter_5), you will document your API using FastAPI’s
    built-in capabilities.
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
  zh: 在[第5章](ch05.html#chapter_5)中，您将使用FastAPI的内置功能来记录您的API。

- en: 7 Microsoft’s GraphRAG implementation
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 7 微软的GraphRAG实现
- en: This chapter covers
  id: totrans-1
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 本章涵盖
- en: Introducing Microsoft's GraphRAG
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 介绍微软的GraphRAG
- en: Extracting and summarizing entities and relationships
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 提取和总结实体及其关系
- en: Calculating and summarizing communities of entities
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 计算和总结实体社区
- en: Implementing global and local search techniques
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 实施全局和局部搜索技术
- en: In chapter 6, you learned how to extract structured information from legal documents
    to build a knowledge graph. In this chapter, you will explore a slightly different
    extraction and processing pipeline using Microsoft’s GraphRAG (Edge et al., 2024)
    approach. This end-to-end example still constructs a knowledge graph but places
    greater emphasis on natural language summarization of entities and their relationships.
    The whole pipeline is visualized in figure 7.1.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 在第6章中，你学习了如何从法律文件中提取结构化信息来构建知识图谱。在本章中，你将探索使用微软的GraphRAG（Edge等人，2024）方法的一个略有不同的提取和处理管道。这个端到端示例仍然构建知识图谱，但更侧重于实体及其关系的自然语言摘要。整个管道在图7.1中进行了可视化。
- en: '![figure](../Images/7-1.png)'
  id: totrans-7
  prefs: []
  type: TYPE_IMG
  zh: '![图](../Images/7-1.png)'
- en: '**Figure 7.1 Microsoft’s GraphRAG pipeline. (Image from Edge et al., 2024,
    licensed under CC BY 4.0)**'
  id: totrans-8
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: '**图7.1 微软的GraphRAG管道。（图片来自Edge等人，2024年，CC BY 4.0许可）**'
- en: 'A key innovation of Microsoft’s GraphRAG (MS GraphRAG: [https://github.com/microsoft/graphrag](https://github.com/microsoft/graphrag))
    is its use of an LLM to build a knowledge graph through a two-stage process. In
    the first stage, entities and relationships are extracted and summarized from
    source documents to form the foundation of the knowledge graph, as illustrated
    in the steps up to the Knowledge Graph in figure 7.1\. What distinguishes MS GraphRAG
    is that, once the knowledge graph has been constructed, graph communities are
    detected, and domain-specific summaries are generated for groups of closely related
    entities. This layered approach transforms fragmented pieces of information from
    various text chunks into a cohesive and organized representation of information
    about specified entities, relationships, and communities.'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 微软的GraphRAG（MS GraphRAG：[https://github.com/microsoft/graphrag](https://github.com/microsoft/graphrag)）的一个关键创新是它使用一个LLM通过两阶段过程构建知识图谱。在第一阶段，从源文档中提取和总结实体及其关系，形成知识图谱的基础，如图7.1中的步骤所示。MS
    GraphRAG的独特之处在于，一旦知识图谱构建完成，就会检测图社区，并为紧密相关的实体组生成特定领域的总结。这种分层方法将来自各种文本片段的碎片化信息转化为关于指定实体、关系和社区的信息的连贯和组织化表示。
- en: These entity- and community-level summaries can then be used to provide relevant
    information in response to user queries in a RAG application. With such a structured
    knowledge graph, multiple retrieval approaches can be applied. In this chapter,
    you’ll explore both global and local search retrieval approaches described in
    the MS GraphRAG paper.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 这些实体和社区层面的总结可以用于在RAG应用中响应用户查询提供相关信息。拥有这样一个结构化的知识图谱，可以应用多种检索方法。在本章中，你将探索MS GraphRAG论文中描述的全局和局部搜索检索方法。
- en: 7.1 Dataset selection
  id: totrans-11
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 7.1 数据集选择
- en: MS GraphRAG is designed to process unstructured text documents by extracting
    key entities and generating summaries that connect information across multiple
    text chunks. To ensure meaningful insights, our dataset should not only be rich
    in entity information but also contain entity data spread across multiple chunks.
    Since entity types are a configurable aspect of MS GraphRAG, they must be defined
    in advance. Relevant entities typically include people, organizations, and locations
    but can also extend to domain-specific concepts such as genes and pathways in
    medicine or legal clauses in law.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: MS GraphRAG旨在通过提取关键实体并生成连接多个文本片段信息的摘要来处理非结构化文本文档。为了确保有意义的见解，我们的数据集不仅应该包含丰富的实体信息，还应该包含跨多个片段的实体数据。由于实体类型是MS
    GraphRAG的可配置方面之一，因此必须在事先定义。相关的实体通常包括人、组织和地点，但也可以扩展到医学中的基因和通路或法律中的法律条款等特定领域的概念。
- en: To make an informed decision about the entity types, it is important to explore
    the dataset and identify the types of questions you want to answer. The choice
    of entity types shapes the entire downstream process, influencing extraction,
    linking, and summarization quality.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 为了对实体类型做出明智的决策，探索数据集并确定你想要回答的问题类型非常重要。实体类型的选择决定了整个下游过程，影响提取、链接和总结的质量。
- en: For example, the MS GraphRAG paper utilized datasets from podcasts and news
    articles. In both cases, entities such as people, organizations, and locations
    are commonly mentioned. Additionally, depending on the subject, such as gaming
    or healthy lifestyle podcasts, you may want to include domain-specific entities,
    like game titles, health conditions, or nutritional concepts, to ensure comprehensive
    extraction and analysis.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，MS GraphRAG 论文使用了播客和新闻文章的数据集。在两种情况下，人们、组织、地点等实体都经常被提及。此外，根据主题，如游戏或健康生活方式播客，你可能还想包括特定领域的实体，如游戏标题、健康状况或营养概念，以确保全面提取和分析。
- en: Here we use *The Odyssey* to evaluate MS GraphRAG, as it features a rich narrative
    with people, gods, mystical weapons, and more. Moreover, key entities such as
    Ulysses appear across multiple text chunks, making it a suitable dataset for testing
    entity extraction and cross-chunk summarizations.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，我们使用 *《奥德赛》* 来评估 MS GraphRAG，因为它包含丰富的叙事，涉及人、神、神秘武器等等。此外，像尤利西斯这样的关键实体出现在多个文本块中，使其成为测试实体提取和跨块摘要的合适数据集。
- en: In the remainder of this chapter, you’ll implement the MS GraphRAG method. To
    follow along, you’ll need access to a running, blank Neo4j instance. This can
    be a local installation or a cloud-hosted instance; just make sure it’s empty.
    You can follow the implementation directly in the accompanying Jupyter notebook
    available at [https://github.com/tomasonjo/kg-rag/blob/main/notebooks/ch07.ipynb](https://github.com/tomasonjo/kg-rag/blob/main/notebooks/ch07.ipynb).
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章剩余部分，你将实现 MS GraphRAG 方法。为了跟上进度，你需要访问一个运行中的空白 Neo4j 实例。这可以是一个本地安装或云托管实例；只需确保它是空的。你可以在附带的
    Jupyter 笔记本中直接跟随实现，该笔记本位于 [https://github.com/tomasonjo/kg-rag/blob/main/notebooks/ch07.ipynb](https://github.com/tomasonjo/kg-rag/blob/main/notebooks/ch07.ipynb)。
- en: Let’s dive in.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们开始吧。
- en: 7.2 Graph indexing
  id: totrans-18
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 7.2 图索引
- en: Here you will construct the knowledge graph and generate entity and community
    summaries. Throughout this construction, you’ll explore key considerations at
    each step, including entity selection, graph connectivity, and how these choices
    influence the quality of summaries and queries.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，你将构建知识图谱并生成实体和社区摘要。在整个构建过程中，你将探索每个步骤的关键考虑因素，包括实体选择、图连通性以及这些选择如何影响摘要和查询的质量。
- en: Start by loading *The Odyssey* from the Gutenberg project ([https://www.gutenberg.org/ebooks/1727](https://www.gutenberg.org/ebooks/1727)).
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，从古腾堡项目加载 *《奥德赛》* ([https://www.gutenberg.org/ebooks/1727](https://www.gutenberg.org/ebooks/1727))。
- en: Listing 7.1 Loading The Odyssey
  id: totrans-21
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表 7.1 加载《奥德赛》
- en: '[PRE0]'
  id: totrans-22
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: With the text prepared, you can now walk through the MS GraphRAG pipeline.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 文本准备就绪后，你现在可以遍历 MS GraphRAG 管道。
- en: 7.2.1 Chunking
  id: totrans-24
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 7.2.1 块分割
- en: '*The Odyssey* consists of 24 books of varying lengths. Your first task is to
    remove prefaces and footnotes and then divide the text into individual books,
    as demonstrated in the following listing. This approach follows the narrative’s
    natural divisions, providing a semantically meaningful way to structure the text.'
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: '*《奥德赛》* 由 24 本不同长度的书籍组成。你的第一个任务是移除前言和脚注，然后将文本分割成单独的书籍，如下面的列表所示。这种方法遵循叙事的自然分割，为文本提供了一种语义上有意义的结构化方式。'
- en: Listing 7.2 Removing preface and footnotes and splitting into books
  id: totrans-26
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表 7.2 移除前言和脚注并将文本分割成书籍
- en: '[PRE1]'
  id: totrans-27
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Now you need to check the number of tokens in each book to determine whether
    further chunking is necessary. The code in the following listing provides basic
    statistics on the token counts of the books.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，你需要检查每本书中的标记数，以确定是否需要进一步的块分割。以下列表中的代码提供了书籍标记计数的基本统计信息。
- en: Listing 7.3 Counting the number of tokens in books
  id: totrans-29
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表 7.3 计算书籍中的标记数
- en: '[PRE2]'
  id: totrans-30
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: The token counts across the 24 books vary significantly, with an average of
    6,515 tokens, a minimum of 4,459, and a maximum of 10,760\. Given this range,
    further chunking is necessary to ensure that no individual section exceeds reasonable
    token limits.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 在 24 本书中的标记数差异很大，平均为 6,515 个标记，最小为 4,459，最大为 10,760。鉴于这个范围，进一步的块分割是必要的，以确保没有单个部分超过合理的标记限制。
- en: But what are reasonable chunk sizes? The researchers behind MS GraphRAG compared
    different chunk sizes and analyzed their effect on the overall number of extracted
    entities. The results of this comparison are shown in figure 7.2.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 但合理的块大小是多少呢？MS GraphRAG 背后的研究人员比较了不同的块大小，并分析了它们对提取实体总数的影响。这种比较的结果如图 7.2 所示。
- en: '![figure](../Images/7-2.png)'
  id: totrans-33
  prefs: []
  type: TYPE_IMG
  zh: '![figure](../Images/7-2.png)'
- en: Figure 7.2 Impact of chunk size and self-reflection iterations on entity extraction.
    (Image from Edge et al., 2024, licensed under CC BY 4.0)
  id: totrans-34
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 图7.2分块大小和自我反思迭代对实体提取的影响。（图片来自Edge等人，2024年，根据CC BY 4.0许可）
- en: The results in figure 7.2 show that smaller chunk sizes tend to extract more
    entity references overall. The line representing a 600-token chunk size is consistently
    the highest, while the 2,400-token chunk size is the lowest. This suggests that
    breaking text into smaller chunks allows the LLM to detect more entities compared
    to using larger chunks. Additionally, figure 7.2 shows that increasing the number
    of self-reflection iterations, meaning additional extraction passes on the same
    document, leads to more entity references being detected across all chunk sizes.
    This pattern indicates that repeated passes enable the LLM to extract more entities
    that may have been missed in earlier iterations.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 图7.2中的结果显示，较小的分块大小通常提取更多的实体引用。表示600个标记分块大小的线条始终是最高的，而2,400个标记分块大小是最低的。这表明将文本分成更小的块可以让LLM检测到比使用更大的块更多的实体。此外，图7.2还显示，增加自我反思迭代的次数，即在同一文档上的额外提取遍历，会导致所有分块大小下检测到的实体引用更多。这种模式表明重复遍历使LLM能够提取在早期迭代中可能被遗漏的更多实体。
- en: Say you have decided to chunk the books using a 1,000-word limit (based on whitespace
    splitting) with an overlap of 40 words, as shown in the following listing.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 假设你已经决定使用1,000字限制（基于空格分割）并重叠40个单词来分块书籍，如下所示。
- en: Listing 7.4 Chunking the books
  id: totrans-37
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表7.4分块书籍
- en: '[PRE3]'
  id: totrans-38
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: The books are chunked, and you can move on to the next step.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 书籍已经分块，你可以进行下一步。
- en: 7.2.2 Entity and relationship extraction
  id: totrans-40
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 7.2.2实体和关系提取
- en: The first step is to extract entities and relationships. We can borrow the MS
    GraphRAG prompts from the appendix of their paper. The instruction section of
    the prompt for entity and relationship extraction is shown in “Instructions for
    entity and relationship extraction.”
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 第一步是提取实体和关系。我们可以从他们论文的附录中借用MS GraphRAG提示。实体和关系提取提示的指令部分在“实体和关系提取指令”中显示。
- en: '**Instructions for entity and relationship extraction**'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: '**实体和关系提取指令**'
- en: -Goal-
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: -目标-
- en: Given a text document that is potentially relevant to this activity and a list
    of entity types, identify all entities of those types from the text and all relationships
    among the identified entities.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 给定一个可能与此活动相关的文本文档和实体类型列表，从文本中识别出那些类型的所有实体以及识别出的实体之间的关系。
- en: -Steps-
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: -步骤-
- en: 'Identify all entities. For each identified entity, extract the following information:'
  id: totrans-46
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 识别所有实体。对于每个识别的实体，提取以下信息：
- en: 'entity_name: Name of the entity, capitalized'
  id: totrans-47
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 'entity_name: 实体的名称，首字母大写'
- en: 'entity_type: One of the following types: [{entity_types}]'
  id: totrans-48
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 'entity_type: 以下类型之一：[{entity_types}]'
- en: 'entity_description: Comprehensive description of the entity’s attributes and
    activities'
  id: totrans-49
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 'entity_description: 实体属性和活动的全面描述'
- en: Format each entity as ("entity"{tuple_delimiter}<entity_name>{tuple_delimiter}
    <entity_type>{tuple_delimiter}<entity_description>)
  id: totrans-50
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将每个实体格式化为（"entity"{tuple_delimiter}<entity_name>{tuple_delimiter} <entity_type>{tuple_delimiter}<entity_description>）
- en: '2\. From the entities identified in step 1, identify all pairs of (source_entity,
    target_ entity) that are **clearly related** to each other. For each pair of related
    entities, extract the following information:'
  id: totrans-51
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 2. 从步骤1中识别的实体中，识别所有（源实体，目标实体）对，它们彼此**明显相关**。对于每一对相关实体，提取以下信息：
- en: 'source_entity: name of the source entity, as identified in step 1'
  id: totrans-52
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 'source_entity: 源实体的名称，如步骤1中识别的那样'
- en: 'target_entity: name of the target entity, as identified in step 1'
  id: totrans-53
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 'target_entity: 目标实体的名称，如步骤1中识别的那样'
- en: 'relationship_description: explanation as to why you think the source entity
    and the target entity are related to each other'
  id: totrans-54
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 'relationship_description: 解释为什么你认为源实体和目标实体彼此相关'
- en: 'relationship_strength: a numeric score indicating strength of the relationship
    between the source entity and target entity'
  id: totrans-55
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 'relationship_strength: 表示源实体和目标实体之间关系强度的数值分数'
- en: Format each relationship as ("relationship"{tuple_delimiter}<source_entity>
    {tuple_delimiter}<target_entity>{tuple_delimiter}<relationship_description> {tuple_delimiter}<relationship_strength>)
  id: totrans-56
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将每个关系格式化为（"relationship"{tuple_delimiter}<source_entity> {tuple_delimiter}<target_entity>{tuple_delimiter}<relationship_description>
    {tuple_delimiter}<relationship_strength>）
- en: 3\. Return output in English as a single list of all the entities and relationships
    identified in steps 1 and 2\. Use **{record_delimiter}** as the list delimiter.
  id: totrans-57
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 3. 以英文形式返回输出，作为步骤1和2中识别的所有实体和关系的单个列表。使用**{record_delimiter}**作为列表分隔符。
- en: 4\. When finished, output {completion_delimiter}
  id: totrans-58
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 4. 完成后，输出{completion_delimiter}
- en: Instructions for entity and relationship extraction focuses on extracting structured
    knowledge from a text document by identifying entities of specified types and
    their relationships. The list of entity types is passed in as a variable `entity_types`.
    The prompt instructs the LLM to extract entities, classify them by type, and provide
    detailed descriptions. Then it identifies clearly related entity pairs, explains
    their connection, and assigns a relationship strength score. Finally, it returns
    all extracted entities and relationships in a structured, delimited format. This
    is only part of the full prompt, which also includes few-shot examples and output
    examples, but those are too extensive to include in the book.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 实体和关系提取的说明侧重于通过识别指定类型的实体及其关系，从文本文档中提取结构化知识。实体类型的列表作为变量`entity_types`传入。提示指示LLM提取实体，按类型分类，并提供详细描述。然后，它识别明显相关的实体对，解释它们之间的关系，并分配关系强度分数。最后，它以结构化、分隔的格式返回所有提取的实体和关系。这只是完整提示的一部分，它还包括少量示例和输出示例，但那些内容过于广泛，无法包含在本书中。
- en: Exercise 7.1
  id: totrans-60
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 练习7.1
- en: Before running the extraction, take a moment to consider which entity types
    would be most useful for *The Odyssey*. Since the list of entity types must be
    predefined, think about the key elements of the narrative such as characters,
    places, objects, and events that you want to extract. Try to define a set of entity
    types that would capture the most meaningful relationships in the text.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 在运行提取之前，花点时间考虑对《奥德赛》来说哪些实体类型最有用。由于实体类型的列表必须预先定义，请考虑叙事的关键元素，如您想要提取的角色、地点、物体和事件。尝试定义一组实体类型，以捕捉文本中最有意义的关系。
- en: 'For extracting meaningful entities from *The Odyssey*, say you have decided
    to use the following entity types:'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 要从《奥德赛》中提取有意义的实体，假设您已决定使用以下实体类型：
- en: '`PERSON`'
  id: totrans-63
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`PERSON`'
- en: '`ORGANIZATION`'
  id: totrans-64
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`ORGANIZATION`'
- en: '`LOCATION`'
  id: totrans-65
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`LOCATION`'
- en: '`GOD`'
  id: totrans-66
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`GOD`'
- en: '`EVENT`'
  id: totrans-67
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`EVENT`'
- en: '`CREATURE`'
  id: totrans-68
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`CREATURE`'
- en: '`WEAPON_OR_TOOL`'
  id: totrans-69
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`WEAPON_OR_TOOL`'
- en: Some entity types, like `PERSON` and `GOD`, are relatively unambiguous since
    they refer to well-defined categories of humans and deities. However, others,
    like `EVENT` and `LOCATION`, are more ambiguous. An `EVENT` can refer to anything
    from a single action to an entire war, making it difficult to establish a strict
    boundary for classification. Similarly, `LOCATION` can refer to a broad category
    like a country, a specific city, or even a named place within a city. This variability
    makes consistent classification more challenging but also leaves more flexibility
    for the LLM.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 一些实体类型，如`PERSON`和`GOD`，相对明确，因为它们指的是人类和神祇的明确类别。然而，其他类型，如`EVENT`和`LOCATION`，则更为模糊。一个`EVENT`可以指从单一动作到整个战争，这使得建立严格的分类边界变得困难。同样，`LOCATION`可以指一个广泛的类别，如一个国家、一个特定的城市，甚至是一个城市内的特定地点。这种可变性使得一致的分类更具挑战性，但也为LLM提供了更多的灵活性。
- en: With these predefined entity types, you will now implement the extraction function.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 使用这些预定义的实体类型，您现在将实现提取函数。
- en: Listing 7.5 Entity and relationship extraction
  id: totrans-72
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表7.5 实体和关系提取
- en: '[PRE4]'
  id: totrans-73
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: '#1 Selects entity types'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: '#1 选择实体类型'
- en: '#2 Passes extraction prompt as user message'
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: '#2 将提取提示作为用户消息传递'
- en: '#3 LLM API call'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: '#3 LLM API调用'
- en: '#4 Parses output as a dictionary'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: '#4 将输出解析为字典'
- en: The code in listing 7.5 extracts entities and relationships by first defining
    the entity types to be identified. It then generates an extraction prompt using
    these types and the input text, sends the prompt to the LLM, and processes the
    response into a structured dictionary format.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 列表7.5中的代码通过首先定义要识别的实体类型来提取实体和关系。然后，它使用这些类型和输入文本生成一个提取提示，将提示发送到LLM，并将响应处理成结构化的字典格式。
- en: Using the function in listing 7.5, you will extract entities and relationships
    for only the first book of *The Odyssey*. If desired, you can increase the number
    of books to analyze a larger portion of the text. The code for this extraction
    is shown in the following listing.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 使用7.5列表中的函数，您将只为《奥德赛》的第一本书提取实体和关系。如果需要，您可以增加要分析的书籍数量以分析文本的更大部分。此提取的代码如下所示。
- en: Listing 7.6 Extracting entities and relationships
  id: totrans-80
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表7.6 提取实体和关系
- en: '[PRE5]'
  id: totrans-81
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: '#1 Defines the number of books to be processed'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: '#1 定义要处理的书籍数量'
- en: '#2 Extracts entities and relationships'
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: '#2 提取实体和关系'
- en: '#3 Imports entities'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: '#3 导入实体'
- en: '#4 Imports relationships'
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: '#4 导入关系'
- en: The function in listing 7.6 processes a set number of books, extracting entities
    and relationships from each chunk. It then imports the entities into Neo4j, followed
    by their relationships, building a structured graph representation of the text.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 列表7.6中的函数处理一组书籍，从每个片段中提取实体和关系。然后它将实体导入Neo4j，接着是它们的关系，构建文本的结构化图表示。
- en: Begin by reviewing the extracted entities and relationships. You can count the
    total number of entities and relationships using the code in the following listing.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 首先回顾提取的实体和关系。您可以使用以下列表中的代码计算实体和关系的总数。
- en: Listing 7.7 Counting the number of extracted nodes and relationships
  id: totrans-88
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表7.7 计算提取的节点和关系数量
- en: '[PRE6]'
  id: totrans-89
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: The graph contains 66 entities and 182 relationships, though these numbers may
    vary between executions. MS GraphRAG focuses on extracting detailed descriptions
    of both entities and their relationships. For example, let’s examine the extracted
    descriptions for the character `ORESTES`.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 图中包含66个实体和182个关系，尽管这些数字可能在执行之间有所不同。MS GraphRAG专注于提取实体及其关系的详细描述。例如，让我们检查对角色`ORESTES`提取的描述。
- en: Listing 7.8 Examining generated descriptions of `ORESTES`
  id: totrans-91
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表7.8 检查生成的`ORESTES`描述
- en: '[PRE7]'
  id: totrans-92
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'When examining the extracted descriptions for the character `ORESTES`, as shown
    in listing 7.8, the results might look like this:'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 当检查角色`ORESTES`的提取描述时，如列表7.8所示，结果可能如下所示：
- en: Orestes is Agamemnon’s son who killed Aegisthus.
  id: totrans-94
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 奥雷斯特斯是阿伽门农的儿子，他杀死了埃癸斯托斯。
- en: Orestes is a person who was expected to take revenge on Aegisthus.
  id: totrans-95
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 奥雷斯特斯是一个被期望向埃癸斯托斯复仇的人。
- en: Orestes is praised for avenging his father’s murder by killing Aegisthus.
  id: totrans-96
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 奥雷斯特斯因杀死埃癸斯托斯为父亲复仇而受到赞扬。
- en: Orestes is the son of Agamemnon who killed Aegisthus.
  id: totrans-97
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 奥雷斯特斯是阿伽门农的儿子，他杀死了埃癸斯托斯。
- en: Orestes is a person who was expected to take revenge on Aegisthus.
  id: totrans-98
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 奥雷斯特斯是一个被期望向埃癸斯托斯复仇的人。
- en: Orestes is praised for avenging his father’s murder by killing Aegisthus.
  id: totrans-99
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 奥雷斯特斯因杀死埃癸斯托斯为父亲复仇而受到赞扬。
- en: While some descriptions repeat the same facts, they collectively contain all
    the key details and ensure no important information is lost across different text
    chunks for a specific entity.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然一些描述重复了相同的事实，但它们共同包含了所有关键细节，并确保在特定实体的不同文本片段中不会丢失重要信息。
- en: Similarly, a single pair of entities can have multiple relationships. You can
    explore the entity pair with the highest number of relationships using the code
    in the following listing.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 类似地，一对实体可以有多种关系。您可以使用以下列表中的代码探索具有最多关系的实体对。
- en: Listing 7.9 Examining generated relationship descriptions
  id: totrans-102
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表7.9 检查生成的关系描述
- en: '[PRE8]'
  id: totrans-103
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: The entity pair with the most relationships is Telemachus and Minerva, with
    a total of 14 relationships. Their interactions span various moments in the narrative,
    highlighting Minerva’s role as a divine guide and mentor to Telemachus.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 具有最多关系的实体对是忒勒玛科斯和雅典娜，总共有14个关系。他们的互动贯穿了叙事的各个时刻，突出了雅典娜作为忒勒玛科斯的神圣向导和导师的角色。
- en: 'The following are five of the extracted relationship descriptions:'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是从中提取的五条关系描述：
- en: Telemachus spoke quietly to Minerva during the banquet.
  id: totrans-106
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 忒勒玛科斯在宴会上悄悄地对雅典娜说话。
- en: Minerva, in disguise, advises and encourages Telemachus, giving him courage
    and making him think of his father.
  id: totrans-107
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 雅典娜化身为他人，向忒勒玛科斯提供建议和鼓励，给他勇气，并让他想起他的父亲。
- en: Minerva brings sleep to Telemachus’s mother, showing her divine influence.
  id: totrans-108
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 雅典娜让忒勒玛科斯的母亲入睡，显示了她的神圣影响力。
- en: Minerva is speaking to Telemachus, offering him guidance and reassurance.
  id: totrans-109
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 雅典娜正在对忒勒玛科斯说话，为他提供指导和安慰。
- en: Minerva, disguised as Mentes, is greeted by Telemachus at the gate.
  id: totrans-110
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 雅典娜化身为门特斯，在门口受到忒勒玛科斯的欢迎。
- en: While some descriptions contain overlapping details, they reinforce Minerva’s
    role as a mentor and divine protector, gradually shaping Telemachus’ journey.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然一些描述包含重叠的细节，但它们加强了雅典娜作为导师和神圣保护者的角色，逐渐塑造了忒勒玛科斯的旅程。
- en: 7.2.3 Entity and relationship summarization
  id: totrans-112
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 7.2.3 实体和关系摘要
- en: To avoid inconsistencies, redundancies, and fragmentation in the extracted knowledge,
    MS GraphRAG merges multiple descriptions of the same entity or relationship using
    LLMs to generate concise summaries. Instead of treating each description separately,
    the model synthesizes information from all descriptions, ensuring that key contextual
    details are preserved in a single, enriched representation. This approach enhances
    clarity, reduces duplication, and provides a more complete understanding of entities
    and their relationships.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 为了避免提取知识中的不一致性、冗余和碎片化，MS GraphRAG使用LLM合并同一实体或关系的多个描述以生成简洁的摘要。该模型不是单独处理每个描述，而是综合所有描述的信息，确保关键上下文细节在一个单一、丰富的表示中得以保留。这种方法提高了清晰度，减少了重复，并提供了对实体及其关系的更全面的理解。
- en: Once again, you can reuse the summarization prompt from the paper, as shown
    in “Instructions for entity and relationship summarization.”
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 再次强调，您可以像“实体和关系摘要说明”中所示的那样重用论文中的摘要提示。
- en: '**Instructions for entity and relationship summarization**'
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: '**实体和关系摘要说明**'
- en: You are a helpful assistant responsible for generating a comprehensive summary
    of the data provided below. Given one or two entities, and a list of descriptions,
    all related to the same entity or group of entities. Please concatenate all of
    these into a single, comprehensive description. Make sure to include information
    collected from all the descriptions. If the provided descriptions are contradictory,
    please resolve the contradictions and provide a single, coherent summary. Make
    sure it is written in third person, and include the entity names so we have the
    full context.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 你是一个负责生成以下提供的数据的全面摘要的有用助手。给定一个或两个实体，以及一系列描述，所有这些都与同一个实体或实体组相关。请将这些描述合并成一个单一、全面的描述。确保包含从所有描述中收集的信息。如果提供的描述存在矛盾，请解决这些矛盾并提供一个单一、连贯的摘要。确保以第三人称撰写，并包含实体名称，以便我们有完整的背景信息。
- en: '#######'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: '#######'
- en: -Data-
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: -数据-
- en: 'Entities: {entity_name}'
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 实体：{entity_name}
- en: 'Description List: {description_list}'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 描述列表：{description_list}
- en: '#######'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: '#######'
- en: 'Output:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 输出：
- en: The prompt in “Instructions for entity and relationship summarization” guides
    the LLM to generate a single, coherent summary by merging multiple descriptions
    of an entity or a pair of entities. It ensures that all relevant details are included
    while resolving contradictions and removing redundancies. The output is written
    in third person and explicitly names the entities to maintain clarity and context.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: “实体和关系摘要说明”中的提示指导LLM通过合并一个实体或一对实体的多个描述来生成一个单一、连贯的摘要。它确保包含所有相关细节，同时解决矛盾和消除冗余。输出以第三人称撰写，并明确命名实体以保持清晰和上下文。
- en: Using the prompt in “Instructions for entity and relationship summarization,”
    you can generate summaries for all entities that have more than a single description.
    The code to summarize entity descriptions can be found in the following listing.
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 使用“实体和关系摘要说明”中的提示，您可以生成具有多个描述的所有实体的摘要。摘要实体描述的代码可以在以下列表中找到。
- en: Listing 7.10 Entity summarization
  id: totrans-125
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表7.10 实体摘要
- en: '[PRE9]'
  id: totrans-126
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: '#1 Gets all entities that have more than a single description'
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: '#1 获取具有多个描述的实体'
- en: '#2 Constructs prompt'
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: '#2 构建提示'
- en: '#3 Generates entity summary'
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: '#3 生成实体摘要'
- en: The code in listing 7.10 queries the Neo4j database to find entities with multiple
    descriptions and then uses an LLM to generate a unified summary. You can review
    the summarized description of `ORESTES` by running the code in the following listing.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 列表7.10中的代码查询Neo4j数据库以找到具有多个描述的实体，然后使用LLM生成统一的摘要。您可以通过运行以下列表中的代码来查看`ORESTES`的摘要描述。
- en: Listing 7.11 Inspecting the generated summary for `ORESTOS`
  id: totrans-131
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表7.11 检查`ORESTOS`生成的摘要
- en: '[PRE10]'
  id: totrans-132
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: The results are shown in “Generated summary for ORESTES.”
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 结果显示在“ORESTES生成的摘要”中。
- en: '**Generated summary for ORESTES**'
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: '**ORESTES生成的摘要**'
- en: Orestes is the son of Agamemnon, known for avenging his father’s death by killing
    Aegisthus. He was expected to take revenge on Aegisthus, who was responsible for
    Agamemnon’s murder. Orestes is praised for fulfilling this expectation and successfully
    killing Aegisthus, his father’s murderer.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 奥雷斯特斯是阿伽门农的儿子，以杀死埃癸斯托斯来为父亲的死亡报仇而闻名。他本应向埃癸斯托斯报仇，因为埃癸斯托斯是阿伽门农谋杀的凶手。奥雷斯特斯因履行这一期望并成功杀死埃癸斯托斯，他的父亲凶手，而受到赞扬。
- en: The summarization process has successfully generated a cohesive and enriched
    description of an entity, as demonstrated by “Generated summary for ORESTES.”
    By merging multiple descriptions, we ensure that key details are preserved while
    reducing redundancy.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 摘要过程已成功生成一个连贯且丰富的实体描述，正如“ORESTES的生成摘要”所示。通过合并多个描述，我们确保了关键细节得到保留，同时减少了冗余。
- en: Next, we will apply the same summarization approach to relationships, consolidating
    multiple relationship descriptions into a single, comprehensive summary. The results
    are shown in the following listing.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们将应用相同的摘要方法到关系上，将多个关系描述合并成一个单一、全面的摘要。结果如下所示。
- en: Listing 7.12 Relationship summarization
  id: totrans-138
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表7.12 关系摘要
- en: '[PRE11]'
  id: totrans-139
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: '#1 Retrieves pairs of nodes with more than a single relationship'
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: '#1 检索具有多个关系的节点对'
- en: '#2 Constructs prompt'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: '#2 构建提示'
- en: '#3 Generates the relationship summary using an LLM'
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: '#3 使用LLM生成关系摘要'
- en: '#4 Stores results to Neo4j'
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: '#4 将结果存储到Neo4j'
- en: The code in listing 7.12 identifies pairs of entities in the database that share
    multiple relationships and consolidates their descriptions into a single summary
    using an LLM. By merging relationship descriptions, the process ensures that key
    interactions between entities are captured comprehensively while eliminating redundancy.
    Once generated, the summarized relationships are stored back into the database.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 列表7.12中的代码识别数据库中共享多个关系的实体对，并使用LLM将它们的描述合并成一个摘要。通过合并关系描述，该过程确保了实体之间关键交互的全面捕捉，同时消除了冗余。一旦生成，摘要关系将存储回数据库。
- en: You can evaluate the generated relationship between `TELEMACHUS` and `MINERVA`,
    as shown in the following listing.
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以评估生成的`TELEMACHUS`和`MINERVA`之间的关系，如下所示。
- en: '**Listing 7.13 Evaluating the summarized relationship between `TELEMACHUS`
    and `MINERVA`**'
  id: totrans-146
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: '**列表7.13 评估`TELEMACHUS`和`MINERVA`之间摘要的关系**'
- en: '[PRE12]'
  id: totrans-147
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: The results of code in listing 7.13 can be found in “Generated summary for relationship
    between TELEMACHUS and MINERVA.”
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 列表7.13中的代码结果可以在“TELEMACHUS和MINERVA之间关系的生成摘要”中找到。
- en: '**Generated summary for the relationship between TELEMACHUS and MINERVA**'
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: '**TELEMACHUS和MINERVA之间关系的生成摘要**'
- en: Minerva plays a crucial role in the life of Telemachus, offering guidance and
    support as he embarks on his quest to find his father, Ulysses. During a banquet,
    Telemachus speaks quietly to Minerva, indicating a close and trusting relationship.
    Minerva, often in disguise, such as when she appears as Mentes, advises and encourages
    Telemachus, instilling in him the courage and determination to seek information
    about his father. She provides counsel regarding his intended voyage, demonstrating
    her commitment to his cause. Additionally, Minerva’s divine influence is evident
    when she brings sleep to Telemachus’s mother, further showcasing her protective
    and supportive role in Telemachus’s life.
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: Minerva在Telemachus的生活中扮演着至关重要的角色，在他踏上寻找父亲Ulysses的旅程时提供指导和支持。在一次宴会上，Telemachus安静地对Minerva说话，表明他们之间有着亲密和信任的关系。Minerva经常以Mentes等伪装身份出现，向Telemachus提供建议和鼓励，在他心中灌输寻求父亲信息的勇气和决心。她就他打算的航行提供建议，展示了她对这一事业的承诺。此外，当Minerva让Telemachus的母亲入睡时，她的神圣影响显而易见，进一步展示了她在Telemachus生活中的保护和支持角色。
- en: With the consolidated summaries for both entities and relationships, you have
    successfully completed the first stage of MS GraphRAG indexing. By merging information
    across text chunks, you have created a more coherent and enriched representation
    of the extracted knowledge.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 通过对实体和关系的综合摘要，你已经成功完成了MS GraphRAG索引的第一阶段。通过跨文本块合并信息，你创建了一个更连贯和丰富的提取知识表示。
- en: Considerations for entity and relationship summarization
  id: totrans-152
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 实体和关系摘要的考虑因素
- en: When working with larger datasets, you may encounter so-called super nodes.
    Super nodes are entities that appear in numerous chunks and have an overwhelming
    number of relationships. For example, if you were to process all of Ancient Greek
    history, a node like `Athens` would accumulate a vast number of relationships
    and descriptions. Without a ranking mechanism, summarizing such nodes could lead
    to excessively long outputs, or worse, some descriptions might not even fit within
    the prompt. To handle this, you would need to implement a filtering or ranking
    strategy to prioritize the most relevant descriptions, ensuring that the summary
    remains concise and informative.
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 当处理大型数据集时，你可能会遇到所谓的超级节点。超级节点是在多个数据块中出现的实体，并且拥有大量的关系。例如，如果你要处理全部的古希腊历史，像“雅典”这样的节点就会积累大量的关系和描述。如果没有排名机制，总结这样的节点可能会导致输出过长，或者更糟糕的是，一些描述甚至可能无法完全包含在提示中。为了处理这种情况，你需要实现一个过滤或排名策略，以优先考虑最相关的描述，确保总结既简洁又具有信息性。
- en: Now you are ready to move on to the next stage.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你可以继续进行下一阶段。
- en: 7.2.4 Community detection and summarization
  id: totrans-155
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 7.2.4 社区检测和总结
- en: The second stage of the graph-indexing process focuses on community detection
    and summarization. A community is a group of entities that are more densely connected
    to each other than to the rest of the graph. Community detection results are illustrated
    in figure 7.3\.
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 图索引过程的第二阶段专注于社区检测和总结。社区是一组实体，它们彼此之间比与其他图中的实体连接得更紧密。社区检测的结果如图7.3所示。
- en: '![figure](../Images/7-3.png)'
  id: totrans-157
  prefs: []
  type: TYPE_IMG
  zh: '![figure](../Images/7-3.png)'
- en: Figure 7.3 Example of community detection results
  id: totrans-158
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 图7.3 社区检测结果的示例
- en: Figure 7.3 illustrates a graph where nodes are grouped into distinct communities,
    each representing a set of densely connected entities with stronger internal relationships.
    Some communities are well integrated into the overall graph, while others appear
    more isolated, forming disconnected subgraphs. Identifying these clusters helps
    reveal underlying structures, themes, or key groups within the dataset. For example,
    in a narrative like *The Odyssey*, a community might form around characters involved
    in a particular event or location. By detecting and summarizing these communities,
    we can capture higher-level relationships and insights that go beyond individual
    entity connections.
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 图7.3展示了节点被分组到不同的社区中，每个社区代表了一组紧密连接的实体，它们内部关系更强。一些社区很好地融入了整个图，而其他社区则显得更加孤立，形成了不连接的子图。识别这些集群有助于揭示数据集中的潜在结构、主题或关键群体。例如，在像《奥德赛》这样的叙事中，一个社区可能会围绕参与特定事件或地点的角色形成。通过检测和总结这些社区，我们可以捕捉到超越单个实体连接的高级关系和洞察。
- en: The code in listing 7.14 applies the Louvain method, a community detection algorithm,
    to identify groups of densely connected entities within the graph. (Leiden was
    used in the original paper implementation and is also available in the GDS library)
    The detected communities are then stored as a node property for downstream processing.
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 列表7.14中的代码应用了Louvain方法，这是一种社区检测算法，用于在图中识别紧密连接的实体组。（原始论文实现中使用了Leiden，并在GDS库中也可用）然后，检测到的社区被存储为节点属性，以便进行下游处理。
- en: Listing 7.14 Calculating communities using the Louvain algorithm
  id: totrans-161
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表7.14 使用Louvain算法计算社区
- en: '[PRE13]'
  id: totrans-162
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: The Louvain method was used to detect 9 communities in the graph, with sizes
    ranging from 2 to 13 nodes. The number and size of detected communities from listing
    7.14 can change depending on the graph structure, such as the number of extracted
    entities and relationships. Additionally, Louvain is not deterministic, meaning
    that even with the same input, the detected communities may vary slightly between
    runs due to the algorithm’s optimization process.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 在图中使用了Louvain方法检测到9个社区，社区的大小从2到13个节点不等。从列表7.14中检测到的社区的数量和大小可能会根据图结构的变化而变化，例如提取的实体和关系的数量。此外，Louvain方法不是确定性的，这意味着即使输入相同，由于算法的优化过程，检测到的社区在运行之间可能会有轻微的变化。
- en: Hierarchical community structure
  id: totrans-164
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 层次社区结构
- en: The MS GraphRAG paper uses the hierarchical nature of the Louvain algorithm
    to capture community structures at multiple levels of granularity. This allows
    for analyzing both broad and fine-grained communities within large graphs. However,
    since we are working with a smaller graph, we will focus on a single level of
    community detection and skip the hierarchical aspect.
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: MS GraphRAG论文利用Louvain算法的层次性质，在多个粒度级别上捕捉社区结构。这允许在大型图中分析广泛的和细粒度的社区。然而，由于我们正在处理一个较小的图，我们将专注于单一级别的社区检测，并跳过层次方面。
- en: Now you can apply the summarization prompt to generate concise overviews of
    each detected community. The instruction part of the prompt is available in “Instructions
    for community summarization.”
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 现在您可以将总结提示应用于生成每个检测到的社区的简洁概述。提示的说明部分可在“社区总结说明”中找到。
- en: '**Instructions for community summarization**'
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: '**社区总结说明**'
- en: You are an AI assistant that helps a human analyst to perform general information
    discovery. Information discovery is the process of identifying and assessing relevant
    information associated with certain entities (e.g., organizations and individuals)
    within a network.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 您是一个AI助手，帮助人类分析师执行一般信息发现。信息发现是识别和评估与网络中某些实体（例如组织和个人）相关联的相关信息的过程。
- en: Goal Write a comprehensive report of a community, given a list of entities that
    belong to the community as well as their relationships and optional associated
    claims. The report will be used to inform decision-makers about information associated
    with the community and their potential impact. The content of this report includes
    an overview of the community’s key entities, their legal compliance, technical
    capabilities, reputation, and noteworthy claims.
  id: totrans-169
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 目标：根据属于社区的实体列表以及它们之间的关系和可选的关联声明，编写一个社区的全面报告。该报告将用于向决策者通报与社区及其潜在影响相关的信息。报告内容包括社区关键实体的概述，它们的法律合规性、技术能力、声誉和值得注意的声明。
- en: Report Structure
  id: totrans-170
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 报告结构
- en: 'The report should include the following sections:'
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 报告应包括以下部分：
- en: 'TITLE: community’s name that represents its key entities - title should be
    short but specific. When possible, include representative named entities in the
    title.'
  id: totrans-172
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 标题：代表社区关键实体的社区名称 - 标题应简短但具体。在可能的情况下，将代表性的命名实体包含在标题中。
- en: 'SUMMARY: An executive summary of the community’s overall structure, how its
    entities are related to each other, and significant information associated with
    its entities.'
  id: totrans-173
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 摘要：社区整体结构的执行摘要，其实体之间的关系，以及与其实体相关的显著信息。
- en: 'IMPACT SEVERITY RATING: a float score between 0-10 that represents the severity
    of IMPACT posed by entities within the community. IMPACT is the scored importance
    of a community.'
  id: totrans-174
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 影响严重性评级：表示社区内实体造成的影响严重性的0-10之间的浮点分数。影响是社区评分的重要性。
- en: 'RATING EXPLANATION: Give a single sentence explanation of the IMPACT severity
    rating.'
  id: totrans-175
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 评级说明：给出一个单句解释IMPACT严重性评级的含义。
- en: 'DETAILED FINDINGS: A list of 5-10 key insights about the community. Each insight
    should have a short summary followed by multiple paragraphs of explanatory text
    grounded according to the grounding rules below. Be comprehensive.'
  id: totrans-176
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 详细发现：关于社区的5-10个关键见解的列表。每个见解应有一个简短的摘要，后跟根据以下扎根规则解释的多个段落。
- en: The prompt in “Instructions for community summarization” guides the AI assistant
    in generating structured summaries of detected communities, ensuring they capture
    key entities, relationships, and notable insights. The goal is to produce high-quality
    summaries that can be effectively used downstream for RAG.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: “社区总结说明”中的提示指导AI助手生成检测到的社区的有序总结，确保它们捕捉到关键实体、关系和显著的见解。目标是生成高质量的总结，这些总结可以有效地用于下游的RAG。
- en: The full prompt for community summarization includes output instructions and
    a few-shot example to maintain consistency and relevance in the generated summaries.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 社区总结的完整提示包括输出说明和几个示例，以保持生成的总结的一致性和相关性。
- en: With the communities identified and a structured summarization prompt in place,
    we can now generate comprehensive summaries for each detected community. These
    community summaries consolidate key entities, relationships, and significant insights.
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 在确定了社区并建立了结构化总结提示后，我们现在可以为每个检测到的社区生成全面的总结。这些社区总结综合了关键实体、关系和重要的见解。
- en: The code in the following listing processes the detected communities and applies
    the summarization prompt to generate meaningful descriptions.
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 下面的列表中的代码处理检测到的社区，并将摘要提示应用于生成有意义的描述。
- en: Listing 7.15 Generating community summaries
  id: totrans-181
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表7.15 生成社区摘要
- en: '[PRE14]'
  id: totrans-182
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: '#1 Retrieves community information from database'
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: '#1 从数据库检索社区信息'
- en: '#2 Constructs prompt'
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: '#2 构建提示'
- en: '#3 LLM call'
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: '#3 LLM调用'
- en: '#4 Parses output into dictionary'
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: '#4 将输出解析为字典'
- en: '#5 Stores results to the database'
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: '#5 将结果存储到数据库'
- en: You can now examine an example of a generated community summary using the code
    shown in listing 7.16\. This will provide a concrete example of how the summarization
    process captures key entities, relationships, and insights within a community.
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 您现在可以使用列表7.16中显示的代码检查生成的社区摘要示例。这将提供一个具体的例子，说明摘要过程如何捕捉社区中的关键实体、关系和洞察。
- en: Listing 7.16 Retrieving an example community summary
  id: totrans-189
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表7.16 检索示例社区摘要
- en: '[PRE15]'
  id: totrans-190
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: The results can be found in the “Generated summary” for relationship between
    `TELEMACHUS` and `MINERVA`.
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 结果可以在“生成的摘要”中找到，涉及`TELEMACHUS`和`MINERVA`之间的关系。
- en: '**Generated community summary**'
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: '**生成的社区摘要**'
- en: Minerva, Telemachus, and the Ithacan Household The community centers around
    Minerva, Telemachus, and the household of Ulysses, with significant interactions
    involving divine guidance, familial loyalty, and the challenges posed by suitors.
    Minerva plays a pivotal role in advising Telemachus, who is determined to find
    his father and restore order to his home. The relationships among these entities
    highlight themes of wisdom, courage, and resilience.
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 米涅瓦、忒勒玛科斯和伊萨卡家庭 该社区以米涅瓦、忒勒玛科斯和尤利西斯的家庭为中心，涉及重要的互动，包括神圣的指导、家庭忠诚和求婚者的挑战。米涅瓦在向忒勒玛科斯提供建议方面扮演着关键角色，他决心找到他的父亲并恢复家园的秩序。这些实体之间的关系突出了智慧、勇气和坚韧的主题。
- en: Handling large communities in bigger graphs
  id: totrans-194
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 在更大的图中处理大型社区
- en: When dealing with larger graphs, communities can become too large to process
    efficiently. If a community contains too many entities and relationships, including
    all of them in the summarization prompt may exceed token limits or produce excessively
    long summaries. To address this, a ranking mechanism should be implemented to
    select only the most relevant entities and relationships. This ensures that the
    summary remains concise, informative, and useful for downstream RAG applications.
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 当处理更大的图时，社区可能会变得太大而无法有效处理。如果一个社区包含太多实体和关系，包括所有这些在摘要提示中可能会超过令牌限制或产生过长的摘要。为了解决这个问题，应实施一个排名机制，以仅选择最相关的实体和关系。这确保了摘要保持简洁、信息丰富，并且对下游RAG应用有用。
- en: Congratulations! You have successfully completed the graph-indexing step.
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 恭喜！您已成功完成图索引步骤。
- en: 7.3 Graph retrievers
  id: totrans-197
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 7.3 图检索器
- en: 'With the graph-indexing process complete, we now move on to the graph retriever
    stage. This stage focuses on retrieving relevant information from the structured
    graph to answer queries effectively. While there are many possible retrieval strategies,
    we will focus on two primary approaches: local search and global search. Local
    search retrieves information from entities closely connected within a detected
    community, whereas global search considers the entire graph structure to find
    the most relevant information.'
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 图索引过程完成后，我们现在进入图检索阶段。此阶段专注于从结构化图中检索相关信息以有效回答查询。虽然有许多可能的检索策略，但我们将关注两种主要方法：局部搜索和全局搜索。局部搜索从检测到的社区中紧密相连的实体检索信息，而全局搜索则考虑整个图结构以找到最相关的信息。
- en: 7.3.1 Global search
  id: totrans-199
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 7.3.1 全局搜索
- en: Global search in GraphRAG uses community summaries as intermediate responses
    to efficiently answer queries that require aggregating information across the
    entire dataset. Instead of retrieving individual chunks of text based on vector
    similarity, this method utilizes precomputed community-level summaries to generate
    a structured response. A global search search diagram is visualized in figure
    7.4\.
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 在GraphRAG中，全局搜索使用社区摘要作为中间响应，以有效地回答需要在整个数据集上聚合信息的查询。这种方法不是基于向量相似性检索单个文本块，而是利用预先计算的社区级摘要来生成结构化响应。全局搜索的流程图在图7.4中可视化。
- en: '![figure](../Images/7-4.png)'
  id: totrans-201
  prefs: []
  type: TYPE_IMG
  zh: '![图](../Images/7-4.png)'
- en: Figure 7.4 Global search
  id: totrans-202
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 图7.4 全局搜索
- en: 'The process in figure 7.4 follows a map-reduce approach:'
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: 图7.4中的过程遵循map-reduce方法：
- en: '*Map step*—Given a user query and, optionally, the conversation history, GraphRAG
    retrieves LLM-generated community reports from a specified level in the graph’s
    community hierarchy. In your implementation, the graph is structured with a single
    level of communities, meaning all detected groups exist at the same hierarchical
    depth. These reports are segmented into manageable text chunks, and each chunk
    is processed by the LLM to produce an intermediate response. Each response consists
    of a list of key points, each accompanied by a numerical importance rating.'
  id: totrans-204
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*地图步骤*—给定用户查询和可选的对话历史，GraphRAG从图社区层次结构中的指定级别检索由LLM生成的社区报告。在您的实现中，图结构只有一个社区级别，这意味着所有检测到的组都存在于相同的层次深度。这些报告被分割成可管理的文本块，每个块都由LLM处理以生成中间响应。每个响应都包含一个要点列表，每个要点都附有数值重要性评分。'
- en: '*Reduce step*—The most important points across all intermediate responses are
    filtered and aggregated. These refined insights then serve as the final context
    for the LLM, which synthesizes a cohesive answer to the user query. By structuring
    the dataset into semantically meaningful clusters, GraphRAG enables efficient
    and cohesive retrieval, even for broad, thematic queries.'
  id: totrans-205
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*减少步骤*—过滤和汇总所有中间响应中最重要的一点。然后，这些精炼的见解作为LLM的最终上下文，综合回答用户查询。通过将数据集结构化为语义上有意义的集群，GraphRAG能够实现高效且连贯的检索，即使对于广泛的主题查询也是如此。'
- en: Community hierarchy structure
  id: totrans-206
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 社区层次结构结构
- en: The quality of the response depends on the level of the community hierarchy
    chosen for sourcing community reports. Lower-level communities provide detailed
    reports, leading to more thorough responses, but they also increase the number
    of LLM calls and processing time. Higher-level communities, with more abstracted
    summaries, may be more efficient but risk losing granularity. Balancing detail
    and efficiency is key to optimizing global search performance.
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
  zh: 响应的质量取决于用于获取社区报告的社区层次结构的级别。低级别社区提供详细报告，导致更全面的响应，但它们也增加了LLM调用次数和处理时间。高级别社区，具有更抽象的总结，可能更有效率，但风险丢失细节。平衡细节和效率是优化全局搜索性能的关键。
- en: The map step uses the following system prompt, as shown in “The system prompt
    for the map part of the retriever.”
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 地图步骤使用以下系统提示，如“检索器地图部分的系统提示”所示。
- en: '**The system prompt for the map part of the retriever**'
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: '**检索器地图部分的系统提示**'
- en: —Role—
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: —角色—
- en: You are a helpful assistant responding to questions about data in the tables
    provided.
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 您是一个有用的助手，回答有关提供的数据表中的问题的提问。
- en: —Goal—
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: —目标—
- en: Generate a response consisting of a list of key points that responds to the
    user’s question, summarizing all relevant information in the input data tables.
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 生成一个由要点列表组成的响应，以响应用户的问题，总结输入数据表中的所有相关信息。
- en: You should use the data provided in the data tables below as the primary context
    for generating the response. If you don’t know the answer or if the input data
    tables do not contain sufficient information to provide an answer, just say so.
    Do not make anything up.
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: 您应将下表中提供的数据作为生成响应的主要上下文。如果您不知道答案，或者输入的数据表不包含足够的信息来提供答案，只需说明即可。不要编造任何内容。
- en: 'Each key point in the response should have the following element:'
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
  zh: 响应中的每个要点应包含以下元素：
- en: 'Description: A comprehensive description of the point.'
  id: totrans-216
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 描述：对该点的全面描述。
- en: 'Importance Score: An integer score between 0-100 that indicates how important
    the point is in answering the user’s question. An ''I don’t know'' type of response
    should have a score of 0\.'
  id: totrans-217
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 重要性评分：一个介于0-100之间的整数评分，表示该要点在回答用户问题中的重要性。一种“我不知道”类型的响应应得0分。
- en: 'The response should be JSON formatted as follows: {{ "points": [ {{"description":
    "Description of point 1 [Data: Reports (report ids)]", "score": score_value}},
    {{"description": "Description of point 2 [Data: Reports (report ids)]", "score":
    score_value}} ] }}'
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: '响应应按以下格式JSON格式化：{{ "points": [ {{"description": "点1的描述 [数据：报告（报告ID）]", "score":
    score_value}}, {{"description": "点2的描述 [数据：报告（报告ID）]", "score": score_value}}
    ] }}'
- en: The response shall preserve the original meaning and use of modal verbs such
    as “shall”, “may” or “will”.
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: 响应应保留原意和使用诸如“应当”、“可以”或“将会”之类的情态动词。
- en: 'Points supported by data should list the relevant reports as references as
    follows: “This is an example sentence supported by data references [Data: Reports
    (report ids)]”'
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: 支持数据的要点应列出相关报告作为参考，如下所示：“这是一个由数据参考支持的示例句子 [数据：报告（报告ID）]”
- en: '**Do not list more than 5 record ids in a single reference**. Instead, list
    the top 5 most relevant record ids and add “+more” to indicate that there are
    more.'
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: '**不要在单个引用中列出超过5个记录ID**。相反，列出前5个最相关的记录ID，并添加“+更多”以表明还有更多。'
- en: 'For example: “Person X is the owner of Company Y and subject to many allegations
    of wrongdoing [Data: Reports (2, 7, 64, 46, 34, +more)]. He is also CEO of company
    X [Data: Reports (1, 3)]”'
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: 例如：“X先生是Y公司的所有者，并受到许多不当行为的指控[数据：报告（2，7，64，46，34，+更多）]。他也是X公司的CEO[数据：报告（1，3）]”
- en: where 1, 2, 3, 7, 34, 46, and 64 represent the id (not the index) of the relevant
    data report in the provided tables.
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 其中1，2，3，7，34，46和64代表在提供的表中相关数据报告的ID。
- en: Do not include information where the supporting evidence for it is not provided.
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: 不要包含没有提供支持证据的信息。
- en: —Data tables—
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: —数据表—
- en: '{context_data}'
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: '{context_data}'
- en: The map system prompt instructs the LLM to extract key points from the provided
    context in response to a user query. Each key point includes a description and
    an importance score (0–100) reflecting its relevance to the query. The response
    is formatted as JSON, with references to supporting data report IDs. If insufficient
    information is available, the response must indicate so without speculation.
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: 地图系统提示指导LLM根据用户查询从提供的上下文中提取关键点。每个关键点包括一个描述和一个重要性分数（0-100），反映其与查询的相关性。响应格式为JSON，并引用支持数据报告ID。如果信息不足，响应必须表明这一点，而不进行推测。
- en: Now you will examine the reduce step of the retriever, as shown in “The system
    prompt for the reduce part of the retriever.”
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你将检查检索器的减少步骤，如“检索器减少部分的系统提示”所示。
- en: '**The system prompt for the reduce part of the retriever**'
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
  zh: '**检索器减少部分的系统提示**'
- en: —Role—
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: —角色—
- en: You are a helpful assistant responding to questions about a dataset by synthesizing
    perspectives from multiple analysts.
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: 你是一个有用的助手，通过综合多位分析师的观点来回答关于数据集的问题。
- en: —Goal—
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: —目标—
- en: Generate a response of the target length and format that responds to the user’s
    question, summarize all the reports from multiple analysts who focused on different
    parts of the dataset.
  id: totrans-233
  prefs: []
  type: TYPE_NORMAL
  zh: 生成目标长度和格式的响应，以回答用户的问题，总结多位分析师从数据集的不同部分关注的报告。
- en: Note that the analysts' reports provided below are ranked in the **descending
    order of importance**.
  id: totrans-234
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，以下提供的分析师报告按**重要性递减顺序**排列。
- en: If you don’t know the answer or if the provided reports do not contain sufficient
    information to provide an answer, just say so. Do not make anything up.
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你不知道答案，或者提供的报告没有足够的信息来提供答案，只需说明即可。不要编造任何内容。
- en: The final response should remove all irrelevant information from the analysts'
    reports and merge the cleaned information into a comprehensive answer that provides
    explanations of all the key points and implications appropriate for the response
    length and format.
  id: totrans-236
  prefs: []
  type: TYPE_NORMAL
  zh: 最终响应应从分析师报告中删除所有无关信息，并将清洗后的信息合并成一个综合答案，提供所有关键点和适当于响应长度和格式的含义解释。
- en: Add sections and commentary to the response as appropriate for the length and
    format. Style the response in markdown.
  id: totrans-237
  prefs: []
  type: TYPE_NORMAL
  zh: 根据长度和格式适当添加章节和评论到响应中。以Markdown格式编排响应。
- en: The response shall preserve the original meaning and use of modal verbs such
    as “shall”, “may” or “will”.
  id: totrans-238
  prefs: []
  type: TYPE_NORMAL
  zh: 响应应保留原句中“应当”、“可以”或“将会”等情态动词的原意和用法。
- en: The response should also preserve all the data references previously included
    in the analysts' reports, but do not mention the roles of multiple analysts in
    the analysis process.
  id: totrans-239
  prefs: []
  type: TYPE_NORMAL
  zh: 响应还应保留分析师报告中先前包含的所有数据引用，但不要提及分析过程中的多位分析师的角色。
- en: '**Do not list more than 5 record ids in a single reference**. Instead, list
    the top 5 most relevant record ids and add “+more” to indicate that there are
    more.'
  id: totrans-240
  prefs: []
  type: TYPE_NORMAL
  zh: '**不要在单个引用中列出超过5个记录ID**。相反，列出前5个最相关的记录ID，并添加“+更多”以表明还有更多。'
- en: 'For example:'
  id: totrans-241
  prefs: []
  type: TYPE_NORMAL
  zh: 例如：
- en: '“Person X is the owner of Company Y and subject to many allegations of wrongdoing
    [Data: Reports (2, 7, 34, 46, 64, +more)]. He is also CEO of company X [Data:
    Reports (1, 3)]”'
  id: totrans-242
  prefs: []
  type: TYPE_NORMAL
  zh: “X先生是Y公司的所有者，并受到许多不当行为的指控[数据：报告（2，7，34，46，64，+更多）]。他也是X公司的CEO[数据：报告（1，3）]”
- en: where 1, 2, 3, 7, 34, 46, and 64 represent the id (not the index) of the relevant
    data record.
  id: totrans-243
  prefs: []
  type: TYPE_NORMAL
  zh: 其中1，2，3，7，34，46和64代表相关数据记录的ID（不是索引）。
- en: Do not include information where the supporting evidence for it is not provided.
  id: totrans-244
  prefs: []
  type: TYPE_NORMAL
  zh: 不要包含没有提供支持证据的信息。
- en: —Target response length and format—
  id: totrans-245
  prefs: []
  type: TYPE_NORMAL
  zh: —目标响应长度和格式—
- en: '{response_type}'
  id: totrans-246
  prefs: []
  type: TYPE_NORMAL
  zh: '{response_type}'
- en: The reduce system prompt directs the LLM to synthesize key points from multiple
    analyst reports, which are ranked by importance. The response must be formatted
    in Markdown, be structured appropriately for the target length and format, and
    exclude irrelevant details. It preserves all referenced data while avoiding speculative
    answers. The final output integrates and refines insights from the reports into
    a coherent, comprehensive response.
  id: totrans-247
  prefs: []
  type: TYPE_NORMAL
  zh: 减少系统提示指导LLM综合多个分析师报告的关键要点，这些报告按重要性排序。回应必须以Markdown格式呈现，适当结构化以适应目标长度和格式，并排除无关细节。它保留所有引用的数据，同时避免推测性答案。最终输出将报告中的见解整合和提炼成一个连贯、全面的回应。
- en: Now we can combine the map and reduce prompts into a global search function.
  id: totrans-248
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们可以将地图和减少提示合并成一个全局搜索函数。
- en: Listing 7.17 Global search
  id: totrans-249
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表7.17 全局搜索
- en: '[PRE16]'
  id: totrans-250
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: '#1 Gets all communities above the rating threshold'
  id: totrans-251
  prefs: []
  type: TYPE_NORMAL
  zh: '#1 获取所有评分高于阈值的社区'
- en: '#2 For each community, gets an intermediate response'
  id: totrans-252
  prefs: []
  type: TYPE_NORMAL
  zh: '#2 对于每个社区，获取一个中间回应'
- en: '#3 Generates a final answer using all the intermediate responses as context'
  id: totrans-253
  prefs: []
  type: TYPE_NORMAL
  zh: '#3 使用所有中间回应作为上下文生成最终答案'
- en: 'The `global_retriever` function in listing 7.17 implements the global search
    method by using community summaries to generate a structured response. It follows
    a three-step process:'
  id: totrans-254
  prefs: []
  type: TYPE_NORMAL
  zh: 列表7.17中的`global_retriever`函数通过使用社区摘要来生成结构化回应，实现了全局搜索方法。它遵循以下三个步骤：
- en: '*Retrieve relevant communities *—The function queries a Neo4j database to retrieve
    community summaries where the rating meets or exceeds the specified threshold.
    This ensures that only the most relevant communities contribute to the final answer.'
  id: totrans-255
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '*检索相关社区*——该函数查询Neo4j数据库，检索评分达到或超过指定阈值的社区摘要。这确保只有最相关的社区对最终答案做出贡献。'
- en: '*Generate intermediate responses *—For each community, an intermediate response
    is generated using the map system prompt. The model processes the community summary
    alongside the user’s query to extract key points.'
  id: totrans-256
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '*生成中间回应*——对于每个社区，使用地图系统提示生成一个中间回应。模型在处理社区摘要的同时，与用户的查询一起提取关键点。'
- en: '*Aggregate and generate final answer *—The reduce system prompt is then applied
    to synthesize all intermediate responses into a coherent final answer, ensuring
    that the most important points are retained and properly structured.'
  id: totrans-257
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '*聚合并生成最终答案*——然后应用减少系统提示来综合所有中间回应，形成一个连贯的最终答案，确保保留最重要的要点并正确地组织结构。'
- en: Now we can test this function with an example.
  id: totrans-258
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们可以用一个例子来测试这个函数。
- en: Listing 7.18 Global search example
  id: totrans-259
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表7.18 全局搜索示例
- en: '[PRE17]'
  id: totrans-260
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: The results of the listing 7.18 can be found in “Response for ‘What is this
    story about?’ using global search.”
  id: totrans-261
  prefs: []
  type: TYPE_NORMAL
  zh: 列表7.18的结果可以在“使用全局搜索对‘这个故事是关于什么的？’的回应”中找到。
- en: '**Response for ''What is this story about?'' using global search**'
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
  zh: '**使用全局搜索对‘这个故事是关于什么的？’的回应**'
- en: The story revolves around the intricate dynamics of a community involving key
    figures such as Minerva, Telemachus, and the household of Ulysses. Central themes
    include divine guidance, familial loyalty, and the challenges posed by suitors.
    Minerva plays a crucial role in advising Telemachus, who is determined to find
    his father, Ulysses, and restore order to his home. The relationships among the
    characters emphasize themes of wisdom, courage, and resilience.
  id: totrans-263
  prefs: []
  type: TYPE_NORMAL
  zh: 这个故事围绕着涉及米涅瓦、忒勒玛科斯和尤利西斯家庭的复杂社区动态展开。主要主题包括神灵的指引、家族忠诚和求婚者的挑战。米涅瓦在向忒勒玛科斯提供建议方面扮演着关键角色，忒勒玛科斯决心找到他的父亲尤利西斯，并恢复家园的秩序。人物之间的关系强调了智慧、勇气和坚韧的主题。
- en: 'Additionally, the narrative highlights the role of Mentes, the chief of the
    Taphians, who is recognized as the son of Anchialus. Mentes is involved in a voyage
    to Temesa, known for its iron cargo, and claims kingship over the Taphians [Data:
    Reports (1)]. The story also centers around Odysseus, a key figure in Greek mythology,
    and his connections with other significant entities such as the Achaeans, Laertes,
    and the gods. The relationships in the story underscore the impact of divine intervention
    on human affairs, showcasing how the gods influence the lives of Greek heroes
    [Data: Reports (1, 2, 3, 4, 5)].'
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，叙事还突出了门特斯的作用，他是塔菲亚人的首领，被认为是安基阿卢斯的儿子。门特斯参与了一次前往铁矿石闻名的特梅萨的航行，并声称对塔菲亚人拥有王权[数据：报告（1）]。故事还围绕着希腊神话中的关键人物奥德修斯，以及他与其他重要实体（如阿开亚人、莱尔提斯和神灵）的联系。故事中的人物关系突出了神灵对人类事务的影响，展示了神灵如何影响希腊英雄的生活[数据：报告（1，2，3，4，5）]。
- en: 'Furthermore, the narrative explores the mythological elements involving Olympian
    Jove, Aegisthus, Agamemnon, Orestes, and Mercury. It highlights themes of divine
    intervention, betrayal, and vengeance. Olympian Jove discusses the actions of
    Aegisthus, notorious for his betrayal and murder of Agamemnon, while Orestes avenges
    his father’s death by killing Aegisthus, despite warnings from Mercury [Data:
    Reports (1, 2, 3, 4, 5)]. These interconnected stories weave a rich tapestry of
    mythological and heroic elements, emphasizing the enduring legacy and challenges
    faced by these legendary figures.'
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，叙述探索了涉及奥林匹斯神宙斯、埃癸斯托斯、阿伽门农、奥雷斯特斯和墨丘利的神话元素。它突出了神干预、背叛和复仇的主题。奥林匹斯神宙斯讨论了埃癸斯托斯的行为，他因背叛和谋杀阿伽门农而臭名昭著，而奥雷斯特斯在墨丘利的警告下，通过杀死埃癸斯托斯为父亲的死报仇
    [数据：报告（1，2，3，4，5）]。这些相互关联的故事编织了一幅丰富的神话和英雄元素图案，强调了这些传奇人物持久的历史遗产和面临的挑战。
- en: The response in “Response for ‘What is this story about?’ using global search”
    generated by the global search method provides a structured summary of the story
    by synthesizing key themes and relationships from multiple chunks. It highlights
    the central figures Minerva, Telemachus, and Ulysses—along with their roles in
    the narrative, emphasizing divine guidance, familial loyalty, and challenges faced
    by the household of Ulysses.
  id: totrans-266
  prefs: []
  type: TYPE_NORMAL
  zh: 由全局搜索方法生成的“使用全局搜索对‘这个故事是关于什么的？’的响应”提供了故事的有序总结，通过综合多个片段中的关键主题和关系。它突出了主要人物密涅瓦、忒勒玛科斯和尤利西斯——以及他们在叙事中的角色，强调了神的指引、家族忠诚和尤利西斯家庭的挑战。
- en: Exercise 7.2
  id: totrans-267
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 练习 7.2
- en: Try running different types of queries using the global search function. Ask
    broad questions that require synthesizing information across multiple community
    summaries, such as “What are the central conflicts in this story?”
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
  zh: 尝试使用全局搜索功能运行不同类型的查询。提出需要综合多个社区摘要信息的问题，例如：“这个故事中的主要冲突是什么？”
- en: 7.3.2 Local search
  id: totrans-269
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 7.3.2 本地搜索
- en: The local search method enhances LLM responses by combining structured knowledge
    graph data with unstructured text from source documents. This approach is particularly
    effective for entity-focused queries, such as “What are the healing properties
    of chamomile?” where a deep understanding of a specific entity and its relationships
    is required. The local search approach can be found in figure 7.5\.
  id: totrans-270
  prefs: []
  type: TYPE_NORMAL
  zh: 本地搜索方法通过将结构化知识图谱数据与源文档中的非结构化文本相结合，增强了 LLM 的响应。这种方法对于以实体为中心的查询特别有效，例如“矢车菊有什么治疗特性？”在这种情况下，需要深入了解特定实体及其关系。本地搜索方法可以在图
    7.5 中找到。
- en: '![figure](../Images/7-5.png)'
  id: totrans-271
  prefs: []
  type: TYPE_IMG
  zh: '![图](../Images/7-5.png)'
- en: Figure 7.5 Local search
  id: totrans-272
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 图 7.5 本地搜索
- en: When a user submits a query, the system visualized in figure 7.5 first identifies
    semantically related entities within the knowledge graph using vector search.
    These entities act as entry points for retrieving relevant information, including
    directly connected entities, relationships, and summaries from community reports.
    Additionally, text chunks from the input documents associated with these entities
    are also extracted. The retrieved data is ranked and filtered to fit within a
    constrained context window, ensuring that only the most relevant information is
    included in the final response.
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
  zh: 当用户提交查询时，图 7.5 中可视化的系统首先使用向量搜索在知识图谱中识别语义相关的实体。这些实体作为检索相关信息（包括直接连接的实体、关系和社区报告的摘要）的入口点。此外，还提取了与这些实体相关的输入文档中的文本块。检索到的数据被排序和过滤，以确保最终响应中只包含最相关的信息。
- en: To implement local search, we first need to calculate text embeddings for entities
    and create a vector index. This allows us to efficiently retrieve the most relevant
    entities based on the user’s query. By embedding entity descriptions and relationships
    into a vector space, we can use similarity search to identify which entities are
    most closely related to the input. Once these relevant entities are found, they
    serve as entry points for retrieving additional structured and unstructured data.
    The code for computing these embeddings and constructing the vector index is shown
    in the following listing.
  id: totrans-274
  prefs: []
  type: TYPE_NORMAL
  zh: 要实现本地搜索，我们首先需要计算实体的文本嵌入并创建一个向量索引。这使我们能够根据用户的查询高效地检索最相关的实体。通过将实体描述和关系嵌入到向量空间中，我们可以使用相似性搜索来识别哪些实体与输入最密切相关。一旦找到这些相关实体，它们就作为检索更多结构和非结构化数据的入口点。计算这些嵌入和构建向量索引的代码如下所示。
- en: Listing 7.19 Generate text embeddings for all entities in the database
  id: totrans-275
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表 7.19 为数据库中所有实体生成文本嵌入
- en: '[PRE18]'
  id: totrans-276
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: '#1 Retrieves entities and their summaries'
  id: totrans-277
  prefs: []
  type: TYPE_NORMAL
  zh: '#1 获取实体及其摘要'
- en: '#2 Calculates embeddings based on entity summaries'
  id: totrans-278
  prefs: []
  type: TYPE_NORMAL
  zh: '#2 基于实体摘要计算嵌入'
- en: '#3 Stores embeddings to the database'
  id: totrans-279
  prefs: []
  type: TYPE_NORMAL
  zh: '#3 将嵌入存储到数据库中'
- en: '#4 Creates vector index entities'
  id: totrans-280
  prefs: []
  type: TYPE_NORMAL
  zh: '#4 创建向量索引实体'
- en: The code in listing 7.19 retrieves all entities from the database along with
    their summaries, computes text embeddings for each entity based on its summary,
    and stores the embeddings back into the database. Finally, it creates a vector
    index to enable efficient similarity search on entity embeddings.
  id: totrans-281
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 7.19 中的代码从数据库中检索所有实体及其摘要，根据每个实体的摘要计算文本嵌入，并将嵌入存储回数据库。最后，它创建一个向量索引以实现实体嵌入上的高效相似性搜索。
- en: The local search is finally implemented as a Cypher statement that expands the
    initial set of relevant nodes, identified through vector search, to include their
    connected entities, text chunks, summaries, and relationships. This Cypher statement
    is shown in the following listing.
  id: totrans-282
  prefs: []
  type: TYPE_NORMAL
  zh: 本地搜索最终实现为一个 Cypher 语句，该语句通过向量搜索扩展了初始的相关节点集，包括它们的连接实体、文本片段、摘要和关系。此 Cypher 语句在以下列表中显示。
- en: Listing 7.20 Cypher statement for local search
  id: totrans-283
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表 7.20 本地搜索的 Cypher 语句
- en: '[PRE19]'
  id: totrans-284
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: '#1 Fetches related text chunks'
  id: totrans-285
  prefs: []
  type: TYPE_NORMAL
  zh: '#1 获取相关文本片段'
- en: '#2 Fetches related community descriptions'
  id: totrans-286
  prefs: []
  type: TYPE_NORMAL
  zh: '#2 获取相关社区描述'
- en: '#3 Fetches related relationships'
  id: totrans-287
  prefs: []
  type: TYPE_NORMAL
  zh: '#3 获取相关关系'
- en: '#4 Fetches entity summaries'
  id: totrans-288
  prefs: []
  type: TYPE_NORMAL
  zh: '#4 获取实体摘要'
- en: All retrieved objects in listing 7.20, such as text chunks, community descriptions,
    relationships, and entity summaries, are ranked and limited to ensure the prompt
    remains manageable. Text chunks are ranked by how frequently they are associated
    with relevant entities and limited to the top `topChunks`. Community descriptions
    are ordered by rank and weight, selecting only the `topCommunities`. Relationships
    are ranked by their importance and limited to `topInsideRels`. Finally, entity
    summaries are retrieved without additional ranking constraints. This ensures only
    the most relevant information is included in the response.
  id: totrans-289
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 7.20 中检索到的所有对象，如文本片段、社区描述、关系和实体摘要，都进行了排序并限制数量，以确保提示信息保持可管理。文本片段根据与相关实体的关联频率进行排序，并限制在
    `topChunks` 的顶部。社区描述按排名和权重排序，仅选择 `topCommunities`。关系按其重要性进行排序，并限制在 `topInsideRels`
    内。最后，实体摘要没有额外的排名约束被检索。这确保了只包含最相关的信息在响应中。
- en: Lastly, you need to define the summarizing prompt, which is again borrowed from
    the paper and shown in “The system prompt for the local search.”
  id: totrans-290
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，你需要定义总结提示，这再次借鉴自论文，并在“本地搜索的系统提示”中展示。
- en: '**The system prompt for the local search**'
  id: totrans-291
  prefs: []
  type: TYPE_NORMAL
  zh: '**本地搜索的系统提示**'
- en: —Role—
  id: totrans-292
  prefs: []
  type: TYPE_NORMAL
  zh: —角色—
- en: You are a helpful assistant responding to questions about data in the tables
    provided.
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
  zh: 你是一个响应关于提供的表格中数据的询问的有帮助的助手。
- en: —Goal—
  id: totrans-294
  prefs: []
  type: TYPE_NORMAL
  zh: —目标—
- en: Generate a response of the target length and format that responds to the user’s
    question, summarizing all information in the input data tables appropriate for
    the response length and format, and incorporating any relevant general knowledge.
  id: totrans-295
  prefs: []
  type: TYPE_NORMAL
  zh: 生成一个目标长度和格式的响应，该响应针对用户的问题，总结输入数据表中适当长度和格式的所有信息，并融入任何相关的通用知识。
- en: If you don’t know the answer, just say so. Do not make anything up.
  id: totrans-296
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你不知道答案，只需说“不知道”。不要编造任何内容。
- en: 'Points supported by data should list their data references as follows:'
  id: totrans-297
  prefs: []
  type: TYPE_NORMAL
  zh: 由数据支持的项目应按以下方式列出其数据引用：
- en: '“This is an example sentence supported by multiple data references [Data: <dataset
    name> (record ids); <dataset name> (record ids)].”'
  id: totrans-298
  prefs: []
  type: TYPE_NORMAL
  zh: “这是一个由多个数据引用支持的示例句子 [数据：<数据集名称> (记录ID); <数据集名称> (记录ID)]。”
- en: Do not list more than 5 record ids in a single reference. Instead, list the
    top 5 most relevant record ids and add “+more” to indicate that there are more.
  id: totrans-299
  prefs: []
  type: TYPE_NORMAL
  zh: 不要在单个引用中列出超过 5 个记录ID。相反，列出前 5 个最相关的记录ID，并添加“+更多”以表明还有更多。
- en: 'For example:'
  id: totrans-300
  prefs: []
  type: TYPE_NORMAL
  zh: 例如：
- en: '“Person X is the owner of Company Y and subject to many allegations of wrongdoing
    [Data: Sources (15, 16), Reports (1), Entities (5, 7); Relationships (23); Claims
    (2, 7, 34, 46, 64, +more)].”'
  id: totrans-301
  prefs: []
  type: TYPE_NORMAL
  zh: “X 人是 Y 公司的所有者，并受到许多不当行为的指控 [数据：来源 (15, 16), 报告 (1), 实体 (5, 7); 关系 (23); 陈述
    (2, 7, 34, 46, 64, +更多)]。”
- en: where 15, 16, 1, 5, 7, 23, 2, 7, 34, 46, and 64 represent the id (not the index)
    of the relevant data record.
  id: totrans-302
  prefs: []
  type: TYPE_NORMAL
  zh: 其中 15、16、1、5、7、23、2、7、34、46 和 64 代表相关数据记录的ID（不是索引）。
- en: Do not include information where the supporting evidence for it is not provided.
  id: totrans-303
  prefs: []
  type: TYPE_NORMAL
  zh: 不要包含没有提供支持证据的信息。
- en: —Target response length and format—
  id: totrans-304
  prefs: []
  type: TYPE_NORMAL
  zh: —目标响应长度和格式—
- en: '{response_type}'
  id: totrans-305
  prefs: []
  type: TYPE_NORMAL
  zh: '{response_type}'
- en: —Data tables—
  id: totrans-306
  prefs: []
  type: TYPE_NORMAL
  zh: —数据表—
- en: '{context_data}'
  id: totrans-307
  prefs: []
  type: TYPE_NORMAL
  zh: '{context_data}'
- en: This system prompt in “The system prompt for the local search” is designed to
    generate responses based on structured data tables while maintaining accuracy
    and transparency. It instructs the assistant to synthesize information relevant
    to the user’s query, ensuring that claims are supported by explicit data references.
    The format for citing data sources enforces a structured approach, limiting the
    number of record IDs per reference while indicating additional supporting records
    when applicable. The prompt also emphasizes that if an answer is not found in
    the provided data, the assistant should explicitly state so rather than fabricate
    information.
  id: totrans-308
  prefs: []
  type: TYPE_NORMAL
  zh: “本地搜索的系统提示”中的这个系统提示旨在根据结构化数据表生成响应，同时保持准确性和透明度。它指示助手综合与用户查询相关的信息，确保主张有明确的数据参考支持。引用数据源格式的格式强制执行结构化方法，限制每个参考的记录ID数量，并在适用时指出额外的支持记录。提示还强调，如果答案在提供的数据中找不到，助手应明确指出，而不是编造信息。
- en: With this in place, you can now implement local search.
  id: totrans-309
  prefs: []
  type: TYPE_NORMAL
  zh: 在此基础上，你现在可以实施本地搜索。
- en: Listing 7.21 Local search implementation
  id: totrans-310
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表 7.21 本地搜索实现
- en: '[PRE20]'
  id: totrans-311
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: '#1 Fetches context using the local search Cypher statement'
  id: totrans-312
  prefs: []
  type: TYPE_NORMAL
  zh: '#1 使用本地搜索Cypher语句获取上下文'
- en: '#2 Stringifies context'
  id: totrans-313
  prefs: []
  type: TYPE_NORMAL
  zh: '#2 将上下文字符串化'
- en: '#3 Constructs prompt'
  id: totrans-314
  prefs: []
  type: TYPE_NORMAL
  zh: '#3 构建提示'
- en: '#4 Generates final answer'
  id: totrans-315
  prefs: []
  type: TYPE_NORMAL
  zh: '#4 生成最终答案'
- en: Listing 7.21 implements local search by first retrieving relevant context from
    the knowledge graph using vector search and the Cypher query. The extracted context
    is then converted into a string and incorporated into a structured prompt designed
    to guide the LLM in generating an informed response. Finally, the prompt is sent
    to the model to produce the final answer.
  id: totrans-316
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 7.21 通过首先使用向量搜索和Cypher查询从知识图谱中检索相关上下文来实现本地搜索。然后，提取的上下文被转换为字符串，并纳入一个旨在指导LLM生成有见地响应的结构化提示中。最后，将提示发送到模型以生成最终答案。
- en: You can now test this implementation with an example.
  id: totrans-317
  prefs: []
  type: TYPE_NORMAL
  zh: 你现在可以使用这个实现进行测试。
- en: Listing 7.22 Local search implementation
  id: totrans-318
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 列表 7.22 本地搜索实现
- en: '[PRE21]'
  id: totrans-319
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: The results of the listing 7.22 can be found in “Response for ‘Who is Ulysses?’
    using local search.”
  id: totrans-320
  prefs: []
  type: TYPE_NORMAL
  zh: 列表 7.22 的结果可以在“使用本地搜索对‘尤利西斯是谁？’的响应”中找到。
- en: '**Response for “Who is Ulysses?” using local search**'
  id: totrans-321
  prefs: []
  type: TYPE_NORMAL
  zh: '**使用本地搜索对“尤利西斯是谁？”的响应**'
- en: The story revolves around the intricate dynamics of a community involving key
    figures such as Minerva, Telemachus, and the household of Ulysses. Central themes
    include divine guidance, familial loyalty, and the challenges posed by suitors.
    Minerva plays a crucial role in advising Telemachus, who is determined to find
    his father, Ulysses, and restore order to his home. The relationships among the
    characters emphasize themes of wisdom, courage, and resilience.
  id: totrans-322
  prefs: []
  type: TYPE_NORMAL
  zh: 这个故事围绕着以米涅瓦、忒勒玛科斯和尤利西斯的家族为核心人物的社区错综复杂的动态。主要主题包括神灵的指引、家族的忠诚以及求婚者带来的挑战。米涅瓦在向忒勒玛科斯提供建议方面扮演着至关重要的角色，忒勒玛科斯决心找到他的父亲尤利西斯，并恢复家园的秩序。人物之间的关系强调了智慧、勇气和坚韧的主题。
- en: 'Additionally, the narrative highlights the role of Mentes, the chief of the
    Taphians, who is recognized as the son of Anchialus. Mentes is involved in a voyage
    to Temesa, known for its iron cargo, and claims kingship over the Taphians [Data:
    Reports (1)]. The story also centers around Odysseus, a key figure in Greek mythology,
    and his connections with other significant entities such as the Achaeans, Laertes,
    and the gods. The relationships in the story underscore the impact of divine intervention
    on human affairs, showcasing how the gods influence the lives of Greek heroes
    [Data: Reports (1, 2, 3, 4, 5)].'
  id: totrans-323
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，叙事还突出了门特斯的作用，他是泰菲亚人的首领，被认为是安基阿卢斯的儿子。门特斯参与了一次前往以铁矿石货物闻名的特梅萨的航行，并声称对泰菲亚人拥有王权[数据：报告（1）]。故事还围绕着希腊神话中的关键人物奥德修斯，以及他与其他重要实体（如阿开亚人、莱耳忒斯和神祇）的联系。故事中的人物关系突出了神灵干预对人类事务的影响，展示了神祇如何影响希腊英雄的生活[数据：报告（1，2，3，4，5）]。
- en: 'Furthermore, the narrative explores the mythological elements involving Olympian
    Jove, Aegisthus, Agamemnon, Orestes, and Mercury. It highlights themes of divine
    intervention, betrayal, and vengeance. Olympian Jove discusses the actions of
    Aegisthus, notorious for his betrayal and murder of Agamemnon, while Orestes avenges
    his father’s death by killing Aegisthus, despite warnings from Mercury [Data:
    Reports (1, 2, 3, 4, 5)]. These interconnected stories weave a rich tapestry of
    mythological and heroic elements, emphasizing the enduring legacy and challenges
    faced by these legendary figures.'
  id: totrans-324
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，叙事探讨了涉及奥林匹斯神宙斯、埃癸斯托斯、阿伽门农、奥雷斯特斯和墨丘利的神话元素。它突出了神干预、背叛和复仇的主题。奥林匹斯神宙斯讨论了埃癸斯托斯的行为，他因背叛和谋杀阿伽门农而臭名昭著，而奥雷斯特斯在墨丘利的警告下，通过杀死埃癸斯托斯为父亲的死报仇[数据：报告（1，2，3，4，5）]。这些相互关联的故事编织了一幅丰富的神话和英雄元素画卷，强调了这些传奇人物持久的历史遗产和面临的挑战。
- en: The response in “Response for 'Who is Ulysses?' using local search” demonstrates
    how local search retrieves and synthesizes relevant information from the knowledge
    graph to provide a detailed, well-supported answer. By incorporating connected
    entities, relationships, and community summaries, the system ensures that responses
    capture both narrative context and factual depth.
  id: totrans-325
  prefs: []
  type: TYPE_NORMAL
  zh: 在“使用本地搜索对‘尤利西斯是谁？’进行响应”的示例中，展示了本地搜索如何从知识图谱中检索和综合相关信息，以提供详细、有充分支持的答案。通过整合连接的实体、关系和社区摘要，系统确保响应既包含叙事背景，又包含事实深度。
- en: Exercise 7.3
  id: totrans-326
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 练习7.3
- en: Try running different types of queries using the local search function.
  id: totrans-327
  prefs: []
  type: TYPE_NORMAL
  zh: 尝试使用本地搜索功能运行不同类型的查询。
- en: With such a graph index, different retriever strategies can be implemented.
    For example, community summaries could be embedded separately and used as a standalone
    vector retriever, allowing for more targeted retrieval depending on the query’s
    focus.
  id: totrans-328
  prefs: []
  type: TYPE_NORMAL
  zh: 在这样的图索引中，可以实现不同的检索策略。例如，社区摘要可以单独嵌入并用作独立的向量检索器，根据查询的焦点进行更有针对性的检索。
- en: Congratulations! You have successfully implemented complete MS GraphRAG.
  id: totrans-329
  prefs: []
  type: TYPE_NORMAL
  zh: 恭喜！您已成功实现完整的MS GraphRAG。
- en: Summary
  id: totrans-330
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 摘要
- en: MS GraphRAG uses a two-stage process where entities and relationships are first
    extracted and summarized from source documents, followed by community detection
    and summarization to create a cohesive knowledge representation.
  id: totrans-331
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: MS GraphRAG使用两阶段过程，首先从源文档中提取和总结实体和关系，然后进行社区检测和总结，以创建一致的知识表示。
- en: The extraction process uses LLMs to identify entities, classify them by predefined
    types (e.g., `PERSON`, `GOD`, `LOCATION`), and generate detailed descriptions
    of both entities and their relationships, including relationship strength scores.
  id: totrans-332
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 提取过程使用LLM来识别实体，根据预定义的类型（例如，`PERSON`，`GOD`，`LOCATION`）对它们进行分类，并生成实体及其关系的详细描述，包括关系强度分数。
- en: Entity and relationship descriptions from multiple text chunks are consolidated
    through LLM-based summarization to create unified, nonredundant representations
    that preserve key information.
  id: totrans-333
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过基于LLM的摘要，将来自多个文本块中的实体和关系描述合并，以创建统一、非冗余的表示，同时保留关键信息。
- en: The system detects communities of densely connected entities using algorithms
    like the Louvain method and then generates community-level summaries to capture
    higher-level themes and relationships.
  id: totrans-334
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 该系统使用类似Louvain方法的算法检测紧密连接的实体社区，然后生成社区级别的摘要以捕捉更高层次的主题和关系。
- en: Global search uses community summaries to answer broad, thematic queries through
    a map-reduce approach.
  id: totrans-335
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 全局搜索使用社区摘要通过映射-归约方法来回答广泛的、主题性的查询。
- en: Local search combines vector similarity search with graph traversal to answer
    entity-focused queries.
  id: totrans-336
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 本地搜索结合向量相似性搜索和图遍历来回答以实体为中心的查询。
- en: The effectiveness of retrieval depends on factors like chunk size, entity type
    selection, and community detection parameters, with smaller chunks generally leading
    to more comprehensive entity extraction.
  id: totrans-337
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 检索的有效性取决于因素，如块大小、实体类型选择和社区检测参数，较小的块通常会导致更全面的实体提取。
- en: The system handles potential scaling challenges through ranking mechanisms for
    managing large numbers of entities, relationships, and communities while maintaining
    context relevance.
  id: totrans-338
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 系统通过排名机制处理潜在的扩展挑战，在保持上下文相关性的同时管理大量实体、关系和社区。

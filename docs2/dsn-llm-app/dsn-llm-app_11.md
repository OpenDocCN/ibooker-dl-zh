# 第九章\. 推理优化

在过去的几章中，我们学习了多种适应和利用 LLM 来解决特定任务的技术。在本章中，我们将学习如何高效地对它们进行推理，以用于实际应用。LLM 的大规模使得部署和推理特别具有挑战性，因为它们对计算、内存和能源需求施加了巨大的压力。这在移动手机等边缘设备上尤其具有挑战性。

在本章的剩余部分，我们将专注于推理优化的领域，讨论影响大型语言模型（LLM）推理时间的因素。然后，我们将展示包括缓存、知识蒸馏、早期退出、量化、并行和推测解码等多种优化技术。

# LLM 推理挑战

影响 LLM 推理的瓶颈有哪些？众所周知，它们庞大的体积需要大量的计算和内存资源。除此之外，还有两个额外的因素加剧了这种情况：

+   如第四章所示，当代的 LLM 主要基于仅解码器模型，它们以自回归的方式运行。这意味着每个标记都是依次生成的，从而施加了顺序限制。在本章的后面部分，我们将讨论旨在加快解码过程的并行和推测解码技术。

+   随着输入序列长度的增加，所需的计算量呈平方增长。在本章的后面部分，我们将讨论旨在缓解这一瓶颈的技术，如 K-V 缓存。

让我们深入了解用于优化推理的技术。

# 推理优化技术

由于这是一个严重影响 LLM 在实际用例中部署的问题，因此在主要的工业和学术实验室中，对推理优化研究给予了极大的关注。近年来，已经开发出数十种优化技术，没有这些技术，LLM 的当前普及就不会实现。要了解用于优化推理的各种类型技术的近全面调查，请参阅[周等人综述论文](https://oreil.ly/MtzNn)。

现在，我们将关注在 LLM 部署中使用的一些最有希望和最有效的推理优化技术。虽然你们中的大多数人可能不会亲自实施这些技术，而是依赖第三方工具，但了解优化技术和涉及的权衡可以为你们在选择各种解决方案时提供宝贵的见解。

高效推理的技术旨在实现以下三个目标：

减少计算

像缓存、知识蒸馏和早期退出这样的技术，每个都采用不同的策略来减少计算。

加速解码

并行和推测解码的技术旨在提高模型的吞吐量：每秒生成的标记数。

减少存储需求

量化技术旨在通过减少存储权重和激活所需的存储空间来减少模型，通过将存储数字的空间从 32 位减少到 16 位、8 位甚至 4 位。

# 减少计算的技巧

我们可以通过以下方式减少推理过程中所需的计算：

+   通过使用缓存等方法以计算换取额外的存储。

+   在推理过程中省略某些操作，使用如*早期退出*等方法。

+   通过使用知识蒸馏等技术，从较大的模型中衍生出较小的模型，同时尽可能保留较大的模型的特征和能力。

下一个章节将详细探讨这些方法中的每一个。

## K-V 缓存

如第一章中所示，LLM 没有会话记忆；在 LLM 对话的每个回合，之前的对话历史都会添加到输入中。这意味着每个对 LLM 的请求都可能包含大量重复的内容在提示中。对于提示的重复部分，在推理步骤中会反复执行相同的计算。此外，在自回归解码中，每个标记都是作为整个输入和之前生成的标记的函数生成的。因此，存在大量的重复计算。

缓解这种重复计算的一种方法是在需要时缓存数据并重用它们。更具体地说，我们缓存了 Transformer 架构中自注意力块的键（K）和值（V），这被称为 K-V 缓存。回想一下我们在第四章中关于 Transformer 自注意力块中键和值的讨论。

让我们看看一些例子。考虑分析电影评论情感的任务。您可能有一个提供详细说明的冗长提示，说明分析情感所涉及的细微差别。这些说明包含在 LLM 接收到的每个输入评论的提示中。

而不是通过重复处理指令标记来产生不必要的开销，缓存被用来检索这些标记的 K-V 值。

类似地，考虑一个提供客户支持的问答助手，该助手通过回答产品手册中的问题来提供客户支持。在这种情况下，代表产品手册标记的 K-V 值可以缓存，然后用于任何需要产品手册作为提示部分的请求。

###### 提示

缓存还可以使在提示中添加大量少样本示例成为可能。这有时可以作为一种轻量级的替代方案来微调。

主要的 LLM 提供商，如谷歌的 Gemini 和 Anthropic 的 Claude，通过它们的 API 为它们的模型提供缓存支持，称之为上下文缓存。这也大大降低了最终用户的成本，因为缓存的标记只计费一次。

###### 警告

注意，在缓存策略中，我们是以计算换取额外的存储。K-V 缓存可能会变得非常大，尤其是在较长的序列长度下。

为了控制成本，LLM 提供商通常将缓存的年龄限制在一个较短的时间段，或者通过缓存持续时间向用户收费。

例如，让我们看看一个请求 Anthropic 的 Claude 模型套件，该套件利用上下文缓存：

```py
{
    "model": "claude-3-5-sonnet",
    "max_tokens": 1024,
    "system": [
      {
        "type": "text",
        "text": "<System Prompt>"
      },
      {
        "type": "text",
        "text": "<Product Manual>",
        "cache_control": {"type": "ephemeral"}
      }
    ],
    "messages": [
      {
        "role": "user",
        "content": "Which battery should I use for the G-8 Ultra?"
      }
    ]
  }'
```

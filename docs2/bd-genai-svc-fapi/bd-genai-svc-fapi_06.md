# 第四章. 从类型安全角度实现安全的 AI 服务

这项工作是用 AI 翻译的。我们很高兴收到你的反馈和评论：translation-feedback@oreilly.com

当你与复杂且不断由多个协作者修改的代码库以及与外部服务（如 API 或数据库）交互时，你将希望遵循最佳实践，例如在创建你的应用程序时确保类型安全。

本章侧重于在创建后端服务和 API 时类型安全的重要性。你将学习如何使用 Python 中的内置数据类和 Pydantic 数据模型来实现类型安全，并了解它们的相似之处和不同之处。此外，你将探索如何使用 Pydantic 数据模型与自定义验证器一起使用，以保护自己免受用户错误输入或数据不正确的影响，并学习如何使用 Python 设置进行环境变量的加载和验证。最后，你将了解处理外部系统模式更改的策略以及管理不断发展的代码库中的复杂性的策略，以避免错误。

在本章结束时，你将拥有一个完全类型化的 GenAI 服务，它在修改、用户输入错误或模型不一致的响应方面更不容易出现错误。

为了跟随我们，你可以通过访问[ramo`ch04-start`](https://github.com/Ali-Parandeh/building-generative-ai-services/tree/ch04-start)来找到本章的初始代码。

# 类型安全简介

*类型*在编程中指定可以分配给变量的值以及可以在这些变量上执行的操作。

在 Python 中，最常见的类型如下：

整数

表示整数

浮点数

表示有分数部分的数字

字符串

表示字符序列

布尔值

表示 `True` 或 `False` 的值

###### 建议

你可以使用 `typing` 包来导入特殊类型，就像你在第三章中的其他代码示例中看到的那样。

*类型安全*是一种编程实践，它确保变量只被分配与其定义的类型兼容的值。在 Python 中，你可以使用类型来控制代码库中变量的使用，特别是当代码库在复杂性和尺寸上增长时。类型控制工具（例如，`mypy`）可以使用这些类型来识别变量上的错误分配或操作。

你可以通过声明完全类型化的变量和函数来施加约束，如下面的 Esempio 4-1 所示。

##### 示例 4-1. 在 Python 中使用类型

```py
from datetime import datetime

def timestamp_to_isostring(date: int) -> str:
    return datetime.fromtimestamp(date).isoformat()

print(timestamp_to_isostring(1736680773))
# 2025-01-12T11:19:52.876758

print(timestamp_to_isostring("27 Jan 2025 14:48:00"))
# error: Argument 1 to "timestamp_to_isostring" has incompatible type "str";
# expected "int" [arg-type]
```

代码编辑器和 IDE（例如 VS Code 或 JetBrains PyCharm）也可以使用类型检查扩展，如图 4-1 所示，在编写代码时报告类型违规。

![bgai 0401](img/bgai_0401.png)

###### 图 4-1\. VS Code `mypy`扩展中的类型错误捕获

在一个复杂的代码库中，很容易失去对变量、它们的状态和不断演变的模式的视线。例如，你可能会忘记`timestamp_to_isostring`函数接受数字作为输入，并错误地将时间戳作为字符串传递，如图 4-1 所示。

当软件包维护者或外部 API 提供商更新他们的代码时，类型也非常有用。类型检查器可以立即发出警告，帮助你处理开发中的此类更改。这样，你将立即被引导到潜在错误源，而无需执行你的代码和测试每个端点。因此，类型安全实践可以让你通过早期检测节省时间，并防止你遇到更难以追踪的运行时错误。

最后，你可以进一步设置在您的发布管道中自动的类型检查，以避免在生产环境中推送破坏性的更改。

类型安全一开始可能感觉像是一个负担：你必须明确地输入你写的每个函数，这可能会很麻烦并减慢开发的早期阶段。

有些人为了快速原型设计和编写更少的样板代码而跳过代码的输入。这种方法更灵活，更容易使用，Python 也足够强大，可以推断简单的类型。此外，一些代码模式（如多类型参数的函数）可能非常动态，因此在实验阶段更容易避免实施严格的安全类型。然而，这会为你节省开发时间，因为你的服务不可避免地会变得复杂并不断变化。

好消息是，一些类型可以使用像 Prisma 这样的工具自动生成，当你与数据库一起工作时，或者当你在处理外部 API 时使用客户端生成器。对于外部 API，通常可以找到包含具有类型建议（即完全类型化客户端）的官方 SDK，这些客户端指定了 API 使用的预期输入和输出类型。否则，你可以检查 API 以创建你自己的完全类型化客户端。本书后面将更详细地介绍 Prisma 和 API 客户端生成器。

当你不使用类型提示时，你会暴露于各种可能的错误和问题，因为其他开发者可能意外地更新了与你的服务交互的数据库表或 API 模式。在其他情况下，你可能更新了一个数据库表——例如，删除了一个列——并忘记更新与该表交互的代码。

没有类型提示，你可能永远不会注意到由于更新引起的修改。这可能很难调试，因为未处理的后续错误可能无法识别损坏的组件或与未由你的开发团队处理的情况相关的通用问题。因此，本可能只需一分钟就能解决的问题可能需要半天甚至更长时间。

你总是可以通过深入测试来避免生产中的某些灾难，但如果你从一开始就使用类型提示，那么避免集成和可靠性问题会容易得多。

# 培养良好的编程习惯

如果过去你没有编写过代码，现在开始养成编写所有变量、函数参数和返回类型的习惯永远不晚。

使用类型提示会使你的代码更易于阅读，帮助你及时发现错误，并在需要重新审视复杂的代码库以快速理解数据流时节省大量时间。

# 实现类型安全

从 Python 3.5 开始，你可以显式声明变量、函数参数和返回值的类型。允许你声明这些类型的语法是 *类型注解*。

## 类型注解

类型注解不会影响应用程序的运行时行为，但有助于识别类型错误，尤其是在复杂的大型应用程序中，多人共同工作的情况下。`mypy`、`pyright`或`pyre`等静态类型检查工具，以及代码编辑器，可以验证函数存储和返回的数据类型是否与预期相符。

在 Python 应用程序中，类型注解用于：

+   *支持代码编辑器的自动完成*

+   *类型静态检查* 使用工具如 `mypy`

FastAPI 还利用类型提示进行：

+   *定义管理器的需求*，包括路径和查询参数、正文、头部、依赖项等。

+   *在需要时转换数据*

+   *验证来自传入请求、数据库和外部服务的数据*。

+   *自动更新驱动 OpenAPI 的文档页面*

你可以使用 `pip` 安装 `loguru`：

```py
$ pip install loguru
```

# 第一章\. 创建数据科学家喜爱的 API

应用程序编程接口（API）对数据科学家来说非常重要。但 API 设计者和开发者多久会考虑数据科学家？数据科学家经常将 API 用作他们工作的数据源。他们有一些与软件开发者或其他消费者不同的需求。如果 API 生产者想要让数据科学家满意，他们最好满足这些需求。

# 数据科学家如何使用 API？

[Anaconda 数据科学报告状态](https://oreil.ly/anaconda)发现，数据科学家大部分时间用于执行三项主要活动：准备或清洗数据（38%）；创建报告、演示或数据可视化（29%）；以及选择、训练和部署模型（27%）。本书展示了数据科学家如何使用 API 来完成这些任务。

*准备或清洗数据*通常发生在数据科学家通过分析其内容、格式和模式对新数据集进行*探索性数据分析（EDA）*时。有时，这项工作也是*数据管道*的一部分，这是一个从多个数据源提取数据并重新格式化或删除错误以便在下游用于可视化、报告或模型的软件任务序列。"数据工程师"是另一个专门从事这些任务的职位名称。第九章将演示如何使用 API 进行探索性数据分析。第十章将演示如何使用 API 进行数据管道。

*创建报告和可视化*是展示从数据中获得的见解并以一种使组织能够监控其运营或做出更好决策的方式呈现数据的重要活动。这些也被称为*分析*。数据科学家调用 API 以提供各种分析产品的数据。"数据分析师"是另一个专门从事这些任务的职位名称。第九章将展示数据科学家如何在 Jupyter Notebooks 中使用 Python 创建可视化，第十一章将展示如何使用 Python 和 Streamlit 在应用程序中部署交互式可视化。

*训练和部署数据科学模型*是使用机器学习或其他数学技术进行预测、将数据聚类成组、执行自然语言处理以及完成各种其他任务的活动。"机器学习工程师"是另一个专门从事模型部署的职位名称。第十三章将演示如何使用 FastAPI 和 Python 部署机器学习模型。

###### 注意

应用程序编程接口（API）在计算机编程中有多种含义。本书将专注于 Web API，这是您使用 HTTP 来检索数据或执行命令的软件程序。API 生产者开发和托管 API，供其网络内的内部消费者或互联网上的外部消费者使用。API 消费者向 API 发送请求。API 接收此请求并发送响应。这是 API 通信。

# 数据科学家使用哪些工具？

数据科学家使用各种商业和开源软件工具来执行他们的工作，以及商业云平台。根据《数据科学状态报告》，数据科学家最常用的编程语言是 Python（58%总是或经常使用它）和 SQL（42%总是或经常使用它）。R 语言在这项调查中排名不高，但根据我的经验，许多数据科学家都在使用它。R 语言在足球分析中很受欢迎，归功于[nflverse](https://github.com/nflverse)数据集和 R 包集合。本书中的程序代码将使用 Python 和 SQL。

对于开发环境，数据科学家通常对使用命令行工具（如 Linux 的 Bash shell 或 Windows 的 PowerShell）感到舒适。他们使用 IDE，如 Visual Studio Code（VS Code）、PyCharm 或 RStudio。数据科学家还使用笔记本环境，这些是独特的交互式编程环境，允许 Markdown 描述与程序代码和命令输出交织在一起。

数据科学家使用各种工具来维护独立的开发环境，例如 venv 和 conda 库。Docker 是一个重要的工具，用于打包环境和部署应用程序。"Dev containers"基于 Docker 提供具有嵌入式 IDE 的全功能虚拟环境——GitHub Codespaces 是本书中将使用的例子。

# 为数据科学家设计 API

现在您已经了解了一些数据科学家执行的任务和他们喜欢使用的工具，以下是一些设计他们喜欢的 API 的建议。本节将专注于 Python，但许多建议也适用于 R 语言：

您的 API 应始终以 JSON 格式返回数据。

您的 API 端点应返回 JSON 格式的数据，而不是 XML。Python 生态系统对 JSON 有强大的支持，它是一种轻量级的数据格式，支持层次结构且易于阅读。JSON 可以转换为列表和字典，这些是 Python 的基本数据结构。大多数 Web API 已经以 JSON 作为标准返回，因此这并不是一个很大的挑战。

您应提供 SDK 以消费 API。

虽然 Python 可以直接在代码中调用 API，但数据科学家习惯于使用`pip`和`conda`等命令安装 Python 库。发布 Python 库将使数据科学家的工作更轻松，并允许你通过 API 调用的方式强制执行良好的编码实践。

你应在你的数据中提供标准的外部标识符。

数据科学家通常在他们的可视化和数据管道中结合来自多个来源的数据。如果你提供行业标准标识符，这将使数据科学家更容易连接数据源。

你的数据应遵守数据类型定义。

数据科学家使用 API 数据进行计算和创建模型，因此数据类型的有效性很重要。在一个 API 中，无效字符可能在网页上显示正常，但在数值字段中的无效数字可能会使记录对数据科学任务不可用。因此，从 API 返回的数据必须符合其定义，例如 OpenAPI 规范（OAS）文件。

你应提供一个批量下载的方法。

当数据科学家分析新的数据集或训练机器学习模型时，他们通常会检查全部内容。因为完整的数据集可能相当大，进行 API 调用可能会对 API 以及数据科学家的本地环境资源造成压力。超时和内存溢出可能导致挫败感和延迟。如果 API 提供商提供了批量下载功能，这将简化这一分析。批量下载在数据科学家执行新数据管道的初始全量加载时也非常有用。对数据科学家有用的数据格式包括*逗号分隔值*（CSV）和[Apache Parquet](https://oreil.ly/UYELV)。

你的 API 应支持按最后更改日期查询。

数据科学家完成数据管道的初始全量加载后，他们希望处理常规更新。典型的数据管道计划是每天运行一个重复性作业来处理*增量*，即已更改的记录。如果 API 提供了最后更改日期查询参数，这将允许数据管道检索任何新记录或更新记录。

# 介绍你的第一部分投资组合项目

在构建你的第一部分投资组合项目时，你将解决所有这些设计建议，该项目展示了你开发 API 和 SDK 的能力。其中许多由你选择的工具自动解决，而一些则需要你自己编写代码。

下面是你接下来要做的概述：

+   第一章：了解你的用户并选择合适的 API

+   第二章：选择你的 API 架构并设置你的开发环境

+   第三章：创建你的数据库

+   第四章：开发 FastAPI 代码

+   第五章：记录你的 API

+   第六章：将你的 API 部署到云端

+   第七章：为您的 API 创建 SDK

你将在每一章中跟随一个现实场景，每个步骤都是在前一个步骤的基础上建立的。现在是时候深入这个场景了，这个场景与我心中的行业密切相关：幻想体育。

# 每个 API 都有一个故事

每个 API 都有一个故事，以及它被构建的原因。一些 API 的故事就像电影《梦想之地》一样直接：“如果你建造它，他们就会来。”一家公司在没有对潜在用户进行任何研究的情况下构建 API——有时顾客会来，有时 API 就会闲置，无人问津。相比之下，成功的 API 满足真实消费者的需求。这本书中你要构建的 API 就是这种情况。

## 认识您的公司：SportsWorldCentral

你是一名为名为 SportsWorldCentral 的网站工作的软件开发者，简称 SWC。SWC 提供体育新闻，并举办如幻想足球和幻想足球等幻想游戏。SWC 的客户是加入联赛并与朋友一起组队的体育迷，他们将现实世界的球员选入自己的队伍。他们观看现实世界的比赛或比赛，当他们的队伍中的球员表现良好时，他们会为他们的幻想队伍得分。SWC 帮助所有这些所有者跟踪他们的队伍，并在幻想经理赢或输时每周提供实时得分更新。

SWC 的幻想足球网站包含有关整个幻想足球联赛的信息，如图 1-1 所示。

![SWC 联赛主页](img/haad_0101.png)

###### 图 1-1\. SWC 联赛主页

网站还提供了大量关于个人幻想团队的详细信息，如图 1-2 所示。

![SWC 我的团队页面](img/haad_0102.png)

###### 图 1-2\. SWC 我的团队页面

SWC 是一家虚构的公司，但幻想体育是一个非常真实且繁荣的娱乐产业。根据幻想产业估计，大约有 4000 万个幻想足球经理，使幻想足球成为美国最大的幻想运动。幻想足球在全球都很受欢迎。例如，超过 1000 万个活跃经理在 [幻想英超联赛网站](https://fantasy.premierleague.com) 上竞争，该网站仅遵循一个主要国际足球联赛。现实世界的幻想联赛主办方网站包括 Yahoo.com、Sleeper、MyFantasyLea⁠gue.com 以及许多其他网站。

除了幻想联赛网站托管商之外，幻想经理还会为像 [The Fantasy Footballers](https://oreil.ly/Hu6Pn)、[PFF](https://oreil.ly/qEVlz) 和 [FantasyPros](https://oreil.ly/-9x4F) 这样的幻想建议网站订阅。这些网站提供高度定制的分析产品，如仪表板、图表、预测模型和推荐引擎，以帮助幻想经理管理他们的队伍。为了将此内容定制到幻想经理的队伍中，幻想联赛主办方需要提供一个幻想建议网站可以消费的 API。

## SWC 需要一个 API

管理 SWC 网站的网页团队注意到，来自网络爬虫的流量在幻想足球网页上不断增加，这些网络爬虫是读取网站并从中提取数据的计算机程序。而不是将其视为问题，精明的 SWC 产品负责人意识到这是一个潜在市场的指标：人们希望使用 SWC 幻想足球数据。

产品负责人在公司内部寻求识别任何其他关于数据访问或数据共享的请求。客服台发现数十张客户支持工单询问为什么许多建议网站无法从 SWC 导入联赛数据——这表明需要与这些网站共享数据。另外的客户工单来自数据科学家和其他数据熟练的用户，他们请求直接访问网站上的足球数据，以便他们可以创建自定义仪表板和指标。独立的移动应用开发者也提出，如果提供 API，他们将开发移动应用，在移动应用商店为 SWC 用户提供服务。产品负责人决定 API 显示出增加公司覆盖范围和扩大业务的潜力。问题是：SWC 应该创建哪种类型的 API？

# 选择首批 API 产品

SportsWorldCentral 产品团队通过联系已提交帮助台工单和请求功能的个人，进行了额外的用户研究。他们还向他们的幻想客户发送调查问卷，并联系前五家幻想建议网站。他们审查在线论坛和社交媒体，寻找与他们的网站相关的投诉或评论。然后他们对其他幻想联赛主办方进行了竞争分析，以了解他们提供的 API。

## 确定潜在用户

根据您的研究，您将焦点缩小到几个用户。您的幻想经理客户没有要求 API，但他们想要 API 能带来的东西。他们希望将他们的队伍导入幻想建议网站，以便他们可以获取关于管理队伍的建议。建议网站提供商希望将 SWC 联赛导入他们的网站，以便 SWC 经理订阅他们的服务。数据科学用户希望使用网站数据以及其他公共来源创建分析仪表板、图表和模型。移动应用开发者希望创建在移动应用商店的应用程序，帮助 SWC 经理管理他们的队伍。生成式 AI 开发者也希望创建可以读取当前 SWC 数据并向经理提供建议的聊天机器人和其他应用程序。

表 1-1 总结了这些用户及其试图执行的任务和痛点，即他们在尝试执行该任务时遇到的问题。

表 1-1\. 您 API 的潜在消费者

| 用户类型 | 主要任务 | 痛点 |
| --- | --- | --- |
| 当前 SWC 团队经理 | 在幻想建议网站上查看团队和联赛 | SWC 联赛主办方不受建议网站支持，且没有可用的移动应用。 |
| 建议网站提供商 | 提供建议并创建支持尽可能多的联赛主办方的分析产品。API 是首选方法。 | SWC 数据无法通过 API 或其他任何方法访问。 |
| 数据科学用户 | 创建分析产品 | 他们无法可靠地访问 SWC 数据。 |
| 移动应用开发者 | 使用 SWC 数据创建第三方应用 | SWC 不可用于移动应用。 |
| 生成式 AI 开发者 | 使用 SWC 数据创建聊天代理和 LLM 应用 | 无法轻松访问当前 SWC 数据。 |

虽然看到这么多潜在的 API 用户令人兴奋，但 SWC 产品经理需要选择首先创建的 API。您与产品经理合作，确定满足这些用户的 API，支持它们所需的数据，以及需要对现有网站进行的任何更改。有了这些信息，产品经理应用设计思维的方法，即使用以下三个标准评估潜在产品：

+   *用户需求*：您的用户想要这个产品。

+   *技术可行性*：您的技术环境和团队可以创建它。

+   *经济可行性*：您期望它值得投资。

## 创建用户故事

在应用这些标准后，他们确定了可以通过现有数据满足的用户需求，而无需对网站进行任何重大更改。为了确保他们理解他们将要构建的内容，他们创建了 *用户故事*，这是从最终用户的角度编写的关于功能或产品的非正式描述。用户故事的常见模板如下：

+   作为一名 (*用户类型*)

+   我想要（目标或意图）

+   因此（动机或好处）

SWC 产品经理创建了以下用户故事来记录他们了解到的用户需求：

1.  作为一名 *SWC 团队经理*，我希望 *在建议网站上查看我的幻想联赛和团队*，以便 *我可以赢得联赛并打败我的朋友*。

1.  作为一名 *建议网站提供商*，我希望 *使用当前赛季的 SWC 数据创建分析产品，如阵容建议、联赛分析和季后赛预测*，以便 *我可以增加使用我网站的客户数量，并增加广告或订阅收入*。

1.  作为一名 *数据科学用户*，我希望 *使用 SWC 数据创建分析产品，如仪表板、图表、模型和指标*，以便 *我可以展示和提升我的数据科学技能，探索关于幻想数据的假设和直觉，并在两个领域建立我的声誉*。

1.  作为一名 *生成式 AI 开发者*，我希望 *使用生成式 AI 和 LLMs 创建 AI 应用，如聊天机器人*，以便 *我可以为 SWC 幻想经理提供幻想管理建议*。

恭喜！你所进行的研究已经证明非常有价值。你识别出了一些需要你数据的用户，并确定了为他们提供服务的方式，这应该会为你的公司带来新的业务。你所捕捉到的用户故事是 API 开发的绝佳起点，这将从第二章开始。

# 其他资源

要了解更多关于 API 产品管理的信息，我推荐 Daniel Jacobson、Greg Brail 和 Dan Woods 合著的《*APIs: A Strategy Guide*》（O’Reilly，2011 年）以及 Mehdi Medjaoui、Erik Wilde、Ronnie Mitra 和 Mike Amundsen 合著的《*Continuous API Management, 2nd Edition*》（O’Reilly，2021 年）。

要了解更多关于设计思维和以人为中心的设计的信息，请阅读[IDEO Field Guide to Human-Centered Design](https://oreil.ly/GZW5E)。

# 摘要

在第一章中，你已经取得了很大的成就，而乐趣才刚刚开始。让我们回顾一下你到目前为止学到了什么：

+   你学习了数据科学家执行的任务和他们使用的工具。

+   你学习了如何设计数据科学家会喜欢的 API。

+   你已经识别出几个潜在消费者，并找到了两个你现在可以帮助的：数据科学用户和咨询网站。

+   你专注于用户需求、技术可行性和经济可行性，以选择三个用户故事来开始你的 API 开发。

在第二章中，你将开始创建一个 API 来满足本章中确定的需求。当然，这将是一个数据科学家和人工智能都会喜欢的 API。

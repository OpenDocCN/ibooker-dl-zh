# 第十六章：优化能量使用

嵌入式设备相对于台式机或移动系统最重要的优势是它们消耗的能量非常少。服务器 CPU 可能消耗几十甚至几百瓦，需要冷却系统和主电源供应才能运行。即使手机也可能消耗几瓦，并需要每天充电。微控制器可以以不到一毫瓦的功率运行，比手机 CPU 少一千倍以上，因此可以在硬币电池或能量收集上运行数周、数月或数年。

如果您正在开发 TinyML 产品，最具挑战性的限制可能是电池寿命。需要人为干预更换或充电电池通常是不可行的，因此您设备的有用寿命（它将继续工作多长时间）将由其使用的能量量和存储量来定义。电池容量通常受产品的物理尺寸限制（例如，一个剥离式传感器不太可能能够容纳超过一个硬币电池），即使您能够使用能量收集，对其供应的功率也有严格限制。这意味着您可以控制的主要领域是影响设备寿命的能量系统使用量。在本章中，我们将讨论如何调查您的功耗以及如何改进它。

# 培养直觉

大多数台式工程师对不同类型操作所需时间有一个大致的了解，他们知道网络请求可能比从 RAM 读取数据慢，通常更快地从固态硬盘（SSD）访问文件比从旋转磁盘驱动器访问文件快。但是很少有人需要考虑不同功能需要多少能量，但为了建立心理模型并计划功率效率，您需要一些经验法则来了解您的操作需要多少能量。

###### 注意

在本章中，我们在能量和功率测量之间来回切换。功率是能量随时间的变化，因此例如，每秒使用 1 焦耳（J）能量的 CPU 将使用 1 瓦特的功率。由于我们最关心的是设备的寿命，因此通常最有帮助的是专注于平均功率使用量作为度量标准，因为这与设备在电池中存储的固定能量量上运行的时间长度成正比。这意味着我们可以轻松预测，一个平均功率使用量为 1 毫瓦的系统将持续时间是一个使用 2 毫瓦的系统的两倍。我们有时仍会提到一次性操作的能量使用，这些操作不会持续很长时间。

## 典型组件功率使用

如果您想深入了解系统组件使用多少能量，[*Sasu Tarkoma 等人的《智能手机能量消耗》（剑桥大学出版社）*](https://oreil.ly/Z3_TQ)是一个很好的开始。以下是我们从他们的计算中得出的一些数字：

+   Arm Cortex-A9 CPU 的功耗在 500 到 2000 毫瓦之间。

+   显示器可能使用 400 毫瓦。

+   活动蜂窝无线电可能使用 800 毫瓦。

+   蓝牙可能使用 100 毫瓦。

超越智能手机，以下是我们观察到的嵌入式组件的最佳测量值：

+   一个麦克风传感器可能使用 300 微瓦（µW）。

+   蓝牙低功耗可能使用 40 毫瓦。

+   一个 320×320 像素的单色图像传感器（如 Himax HM01B0）可能在 30 FPS 时使用 1 毫瓦。

+   Ambiq Cortex-M4F 微控制器可能在 48 MHz 时钟频率下使用 1 毫瓦。

+   一个加速度计可能使用 1 毫瓦。

这些数字将根据您使用的确切组件而有很大变化，但它们对于您至少了解不同操作的大致比例是有用的。一个顶层摘要是，无线电使用的功率比您在嵌入式产品中可能需要的其他功能要多得多。此外，传感器和处理器的能量需求下降速度比通信功率快得多，因此未来这种差距可能会进一步增加。

一旦您了解了系统中活动组件可能使用的能量，您需要考虑您可以存储或收集多少能量来为它们供电。以下是一些大致数字（感谢[James Meyers](https://oreil.ly/DLf4t)提供的能量收集估算）：

+   一个 CR2032 纽扣电池可能容纳 2,500 焦耳。这意味着如果您的系统平均使用 1 毫瓦的功率，您可以希望获得大约一个月的使用时间。

+   一个 AA 电池可能有 15,000 焦耳，为 1 毫瓦系统提供六个月的使用寿命。

+   从工业机器中收集温差可能会产生每平方厘米 1 至 10 毫瓦的能量。

+   室内光源可能每平方厘米提供 10 微瓦的能量。

+   室外光照可能使您能够每平方厘米收集 10 毫瓦的能量。

正如您所看到的，目前只有工业温差或室外光照对于自供电设备是实际可行的，但随着处理器和传感器的能量需求降低，我们希望使用其他方法将开始变得可能。您可以关注商业供应商如[Matrix](https://www.matrixindustries.com/en/energy-harvesting)或[e-peas](https://e-peas.com)以了解一些最新的能量收集设备。

希望这些大致数字能帮助您勾勒出对于您的寿命、成本和尺寸要求组合可能实用的系统类型。它们应该足够至少进行初步可行性检查，如果您能将它们内化为直觉，您将能够快速思考许多不同的潜在权衡。

## 硬件选择

当您大致了解您的产品可能使用的组件类型时，您需要查看您可以购买的实际零件。如果您正在寻找一些对爱好者来说文档完备且易于获取的东西，最好从浏览像[SparkFun](https://www.sparkfun.com)、[Arduino](https://www.arduino.cc)或[AdaFruit](https://www.adafruit.com)这样的网站开始。这些网站提供的组件配有教程、驱动程序和有关连接到其他部件的建议。它们也是开始原型设计的最佳地点，因为您很可能能够获得已经配置好您所需的一切的完整系统。最大的缺点是您的选择会更有限，集成系统可能不会针对整体功耗进行优化，而且您将为额外资源支付溢价。

为了更多选择和更低价格，但没有宝贵的支持，您可以尝试像[Digi-Key](https://www.digikey.com)、[Mouser Electronics](https://www.mouser.com)或甚至[Alibaba](https://oreil.ly/Td-0l)这样的电子供应商。所有这些网站的共同之处是它们应该为其所有产品提供数据表。这些数据表包含有关每个部件的丰富细节：从如何提供时钟信号到有关芯片大小及其引脚的机械数据。然而，您可能最想了解的第一件事是功耗，而这可能会令人惊讶地难以找到。例如，看看[STMicroelectronics Cortex-M0 MCU 的数据表](https://oreil.ly/fOuLf)。这本书有近百页，从目录中一眼看去并不明显如何找到功耗。我们发现的一个有用技巧是在这些文档中搜索“毫安”或“ma”（带有空格），因为这些通常是用来表示功耗的单位。在这份数据表中，这种搜索导致了第 47 页上的一个表，如图 16-1 所示，提供了电流消耗的值。

![VDD 供电时的典型和最大电流消耗](img/timl_1601.png)

###### 图 16-1. STMicroelectronics 的电流消耗表

这仍然可能很难解释，但我们通常感兴趣的是这个芯片可能使用多少瓦特（或毫瓦）。为了得到这个值，我们需要将表中显示的安培数乘以电压，这里列出的电压为 3.6 伏特（我们已经在表的顶部突出显示了这一点）。如果我们这样做，我们可以看到典型功耗范围从接近 100 毫瓦到只有在睡眠模式下的 10 毫瓦。这让我们知道这个微控制器在功耗方面相对较高，尽管其价格为 55 美分，可能会在您的权衡中得到补偿。您应该能够对您有兴趣使用的所有组件的数据表执行类似的侦探工作，并根据所有这些部分的总和来组装一个关于可能整体功耗的图像。

# 测量实际功耗

一旦您有了一组组件，您将需要将它们组装成一个完整的系统。这个过程超出了本书的范围，但我们建议您尽早完成一些工作，以便在实际世界中尝试产品并了解更多关于其需求的信息。即使您没有使用您想要的组件或者没有准备好所有软件，获得早期反馈也是非常宝贵的。

拥有一个完整的系统的另一个好处是您可以测试实际的功耗。数据表和估算对于规划是有帮助的，但总有一些东西无法适应简单模型，集成测试通常会显示比您预期的更高的功耗。

有很多工具可以用来测量系统的功耗，了解如何使用万用表（一种用于测量各种电气特性的设备）可能非常有帮助，但最可靠的方法是在设备中放置一个已知容量的电池，然后看它能持续多久。毕竟，这才是您真正关心的，尽管您可能希望它的寿命为几个月或几年，但最有可能的是，您的第一次尝试只能运行几个小时或几天。这种实验方法的优势在于它捕捉了您关心的所有效果，包括当电压下降太低时可能出现的故障，这可能不会在简单的建模计算中显示出来。这种方法也非常简单，即使是软件工程师也可以做到！

# 为模型估算功耗

估计模型在特定设备上使用多少功率的最简单方法是测量运行一个推理所需的延迟，然后将系统的平均功耗乘以该时间段的能量使用量。在项目开始阶段，你可能不太可能有延迟和功耗的确切数字，但你可以得出大致的数字。如果你知道一个模型需要多少算术运算，以及处理器每秒大约可以执行多少运算，你可以大致估计该模型执行所需的时间。数据表通常会给出设备在特定频率和电压下的功耗数据，尽管要注意的是它们可能不包括整个系统的常见部分，比如内存或外设。值得对这些早期估计持怀疑态度，并将它们用作你可能实现的上限，但至少你可以对你的方法的可行性有一些想法。

举个例子，如果你有一个像人体检测器一样需要执行 6000 万次操作的模型，而你有一个像 Arm Cortex-M4 这样以 48 MHz 运行的芯片，并且你相信它可以使用其 DSP 扩展每个周期执行两次 8 位乘加运算，你可能会猜测最大延迟为 48,000,000/60,000,000 = 800 毫秒。如果你的芯片使用 2 毫瓦，那么每次推理的能量消耗将为 1.6（毫焦）。

# 改进功耗

现在你知道了系统的大致寿命，你可能会寻找改进的方法。你可能会找到一些硬件修改的方法，比如关闭你不需要的模块或更换组件，但这些超出了本书的范围。幸运的是，有一些常见的技术不需要电气工程知识，但可以帮助很多。因为这些方法是以软件为重点的，它们假设微控制器本身占据了大部分功耗。如果你的设备中的传感器或其他组件是耗电量大的，你将需要进行硬件调查。

## 占空比

几乎所有嵌入式处理器都有能力将自己置于睡眠模式中，在这种模式下它们不执行任何计算，功耗很低，但能够在一段时间后或外部信号进入时唤醒。这意味着减少功耗的最简单方法之一是在推理调用之间插入睡眠，以便处理器在低功耗模式下花费更多时间。这在嵌入式世界中通常被称为*占空比*。你可能会担心这会排除连续传感器数据采集，但许多现代微控制器具有直接内存访问（DMA）功能，能够连续采样模拟数字转换器（ADC）并将结果存储在内存中，而无需主处理器的参与。

类似地，你可能能够降低处理器执行指令的频率，使其实际上运行得更慢，从而大幅减少其功耗。之前展示的数据表示例演示了随着时钟频率降低所需能量的减少。

占空比和频率降低提供的是通过计算来交换功耗的能力。这在实践中意味着，如果你能减少软件的延迟，你可以用更低的功耗预算来交换。即使你能够在规定的时间内运行，也要寻找优化延迟的方法，如果你想要减少功耗。

## 级联设计

机器学习相对于传统的过程式编程的一个重要优势是，它可以轻松地扩展或缩减所需的计算和存储资源量，而准确性通常会逐渐降低。手动编码的算法很难实现这一点，因为通常没有明显的参数可以调整以影响这些属性。这意味着您可以创建所谓的*模型级联*。传感器数据可以输入到一个计算要求很小的模型中，即使它不是特别准确，也可以调整它，使其在特定条件存在时有很高的触发概率（即使它也会产生很多误报）。如果结果表明刚刚发生了有趣的事情，相同的输入可以被输入到一个更复杂的模型中，以产生更准确的结果。这个过程可以在几个更多的阶段中重复。

这种方法的好处在于，虽然不准确但微小的模型可以适应非常节能的嵌入式设备，并且持续运行它不会消耗太多能量。当发现潜在事件时，可以唤醒一个更强大的系统并运行一个更大的模型，依此类推。因为更强大的系统仅在很短的时间内运行，它们的功耗不会超出预算。这就是手机上始终开启的语音接口是如何工作的。DSP 不断监视麦克风，一个模型在监听“Alexa”、“Siri”、“Hey Google”或类似的唤醒词。主 CPU 可以保持在睡眠模式，但当 DSP 认为可能听到正确的短语时，它会发出信号唤醒它。然后 CPU 可以运行一个更大更准确的模型来确认是否确实是正确的短语，并且如果是的话，可能将随后的语音发送到云中更强大的处理器。

这意味着嵌入式产品即使不能承载一个足够准确以便自行采取行动的模型，也可能实现其目标。如果您能够训练一个能够发现大多数真正阳性的网络，并且假阳性发生的频率足够低，您可能可以将剩余的工作转移到云端。无线电非常耗电，但如果您能够将其使用限制在罕见的情况和短时间内，它可能符合您的能源预算。

# 总结

对于我们许多人（包括您的作者在内），优化能源消耗是一个陌生的过程。幸运的是，我们在优化延迟方面涵盖的许多技能在这里也适用，只是要监控不同的指标。通常最好先专注于延迟优化，因为您通常需要验证您的产品是否能够提供您想要的短期用户体验，即使其寿命不足以在现实世界中有用。同样，通常在延迟和能源之后处理第十七章的主题，空间优化，是有意义的。在实践中，您可能会在所有不同的权衡之间来回迭代，以满足您的约束条件，但在其他方面相对稳定之后，尺寸通常是最容易处理的。
